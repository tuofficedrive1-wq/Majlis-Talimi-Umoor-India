<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Academic Inspector</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
body{font-family:Poppins;background:#f1f5f9}
.card{background:white;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.tab-btn{padding:8px 16px;border-radius:8px;font-weight:600}
.tab-active{background:#4f46e5;color:white}
</style>
</head>
<body>

<div class="bg-white shadow p-4 flex justify-between">
<div class="font-bold text-xl text-gray-800">Academic Inspector</div>
<button onclick="window.handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
</div>

<main class="max-w-7xl mx-auto p-6">

<!-- SUMMARY -->
<div id="summary-section">

<div class="card p-6 mb-6 flex flex-col lg:flex-row lg:justify-between gap-6">

<div class="flex gap-5 items-center">

<div class="relative">
<img id="profile-photo" src="https://placehold.co/150x150"
class="w-28 h-28 rounded-xl object-cover shadow border">

<button onclick="window.openPhotoModal()"
class="absolute -bottom-2 -right-2 bg-indigo-600 text-white p-2 rounded-full">
<i class="fas fa-camera text-xs"></i>
</button>
</div>

<div>
<div id="inspector-display-name"
class="text-xl font-semibold text-indigo-600">Inspector</div>

<div class="text-gray-500 text-sm">Academic Inspector</div>

<div class="flex gap-3 mt-2">
<div class="bg-indigo-50 border px-3 py-1 rounded-full text-sm">
Institutes: <span id="total-institutes">0</span>
</div>
<div class="bg-green-50 border px-3 py-1 rounded-full text-sm">
Teachers: <span id="total-teachers">0</span>
</div>
</div>
</div>

</div>

<div class="bg-indigo-50 p-4 rounded-xl border text-center">
<label class="text-xs font-bold text-indigo-700 block mb-1">
Reporting Month
</label>

<input type="month" id="report-month"
class="bg-white border rounded px-3 py-1 font-bold text-indigo-800">

<button onclick="window.openReports()"
class="mt-3 bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold">
Fill Reports →
</button>
</div>

</div>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
<div class="card p-5"><p class="text-xs">Jaiza</p><p id="jaiza-percent" class="text-xl font-bold">0%</p></div>
<div class="card p-5"><p class="text-xs">Tadris</p><p id="tadris-percent" class="text-xl font-bold">0%</p></div>
<div class="card p-5"><p class="text-xs">Test</p><p id="test-percent" class="text-xl font-bold">0%</p></div>
<div class="card p-5"><p class="text-xs">Karkardagi</p><p id="kkd-percent" class="text-xl font-bold">0%</p></div>
</div>

</div>

<!-- REPORTS -->
<div id="reports-section" class="hidden">

<button onclick="window.backToSummary()" class="mb-6 text-indigo-600">
← Back
</button>

<div class="flex gap-3 mb-6">
<button class="tab-btn tab-active" onclick="window.switchTab('jaiza')">Jaiza</button>
<button class="tab-btn" onclick="window.switchTab('test')">Test</button>
<button class="tab-btn" onclick="window.switchTab('tadris')">Tadris</button>
<button class="tab-btn" onclick="window.switchTab('kkd')">Karkardagi</button>
</div>

<div id="tab-jaiza"></div>
<div id="tab-test" class="hidden">Test Module</div>
<div id="tab-tadris" class="hidden">Tadris Module</div>
<div id="tab-kkd" class="hidden">KKD Module</div>

</div>

</main>

<!-- PHOTO MODAL -->
<div id="photo-modal"
class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
<div class="bg-white p-6 rounded-xl w-80">
<h3 class="font-bold mb-3">Update Profile Photo</h3>

<input type="url" id="photo-url-input"
placeholder="Paste image URL"
class="w-full border rounded p-2 mb-4">

<div class="flex justify-end gap-2">
<button onclick="window.closePhotoModal()" class="px-4 py-2 bg-gray-200 rounded">
Cancel
</button>
<button onclick="window.savePhoto()" class="px-4 py-2 bg-indigo-600 text-white rounded">
Save
</button>
</div>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {getAuth,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import {getFirestore,doc,getDoc,collection,query,where,getDocs,updateDoc} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
authDomain:"data-f15ab.firebaseapp.com",
projectId:"data-f15ab"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentUser=null;
let assignedJamiaat=[];
let completedReports=[];

// ===== AUTH =====
onAuthStateChanged(auth,async user=>{
if(!user){location.href="index.html";return;}
currentUser=user;
await loadData();
});

// ===== LOAD DATA =====
async function loadData(){

const userDoc=await getDoc(doc(db,"users",currentUser.uid));
if(userDoc.exists()){
const data=userDoc.data();
assignedJamiaat=data.assignedJamiaat||[];
document.getElementById("inspector-display-name").textContent=data.name||"Inspector";
document.getElementById("total-teachers").textContent=data.teachersCount||0;
if(data.photo) document.getElementById("profile-photo").src=data.photo;
}

document.getElementById("total-institutes").textContent=assignedJamiaat.length;

const month=document.getElementById("report-month").value;
const q=query(collection(db,"jaiza_forms"),
where("month","==",month),
where("createdBy","==",currentUser.uid));

const snap=await getDocs(q);
completedReports=snap.docs.map(d=>d.data().jamiaName);

renderSummary();
renderJamiaList();
}

// ===== RENDER =====
function renderSummary(){
const total=assignedJamiaat.length;
const done=completedReports.length;
const percent=total?Math.round(done/total*100):0;

["jaiza","test","tadris","kkd"].forEach(id=>{
document.getElementById(id+"-percent").textContent=percent+"%";
});
}

function renderJamiaList(){
let html="";
assignedJamiaat.forEach(j=>{
const done=completedReports.includes(j);
html+=`
<div class="card p-4 mb-3 flex justify-between">
<div>
<div class="font-bold">${j}</div>
<div class="${done?'text-green-600':'text-orange-500'}">
${done?'Completed':'Pending'}
</div>
</div>
<button class="px-3 py-1 rounded ${
done?'bg-gray-200':'bg-indigo-600 text-white'
}">
${done?'Done':'Start'}
</button>
</div>`;
});
document.getElementById("tab-jaiza").innerHTML=html;
}

// ===== GLOBAL UI =====
window.openReports=()=>{
document.getElementById("summary-section").classList.add("hidden");
document.getElementById("reports-section").classList.remove("hidden");
};

window.backToSummary=()=>{
document.getElementById("reports-section").classList.add("hidden");
document.getElementById("summary-section").classList.remove("hidden");
};

window.openPhotoModal=()=>{
document.getElementById("photo-modal").classList.remove("hidden");
document.getElementById("photo-modal").classList.add("flex");
};

window.closePhotoModal=()=>{
document.getElementById("photo-modal").classList.add("hidden");
};

window.savePhoto=async()=>{
const url=document.getElementById("photo-url-input").value;
if(!url) return;
await updateDoc(doc(db,"users",currentUser.uid),{photo:url});
document.getElementById("profile-photo").src=url;
window.closePhotoModal();
};

window.switchTab=(name)=>{
["jaiza","test","tadris","kkd"].forEach(t=>{
document.getElementById("tab-"+t).classList.add("hidden");
});
document.getElementById("tab-"+name).classList.remove("hidden");
};

window.handleLogout=()=>signOut(auth);

// ===== CURRENT MONTH =====
const now=new Date();
document.getElementById("report-month").value=
now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");

document.getElementById("report-month").onchange=loadData;

</script>
</body>
</html>
