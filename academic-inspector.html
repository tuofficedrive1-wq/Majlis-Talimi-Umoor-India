<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Academic Inspector</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
body{font-family:Poppins;background:#f1f5f9}
.card{background:white;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.tab-btn{padding:8px 16px;border-radius:8px;font-weight:600}
.tab-active{background:#4f46e5;color:white}
</style>
</head>
<body>

<div class="bg-white shadow p-4 flex justify-between">
<div class="font-bold text-xl text-gray-800">Academic Inspector</div>
<button onclick="window.handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
</div>

<main class="max-w-7xl mx-auto p-6">

<!-- SUMMARY -->
<div id="summary-section">

<div class="card p-6 mb-6 flex flex-col lg:flex-row lg:justify-between gap-6">

<div class="flex gap-5 items-center">

<div class="relative">
<img id="profile-photo" src="https://placehold.co/150x150"
class="w-28 h-28 rounded-xl object-cover shadow border">

<button onclick="window.openPhotoModal()"
class="absolute -bottom-2 -right-2 bg-indigo-600 text-white p-2 rounded-full">
<i class="fas fa-camera text-xs"></i>
</button>
</div>

<div>
<div id="inspector-display-name"
class="text-xl font-semibold text-indigo-600">Inspector</div>

<div class="text-gray-500 text-sm">Academic Inspector</div>

<div class="flex gap-3 mt-2">
<div class="bg-indigo-50 border px-3 py-1 rounded-full text-sm">
Institutes: <span id="total-institutes">0</span>
</div>
<div class="bg-green-50 border px-3 py-1 rounded-full text-sm">
Teachers: <span id="total-teachers">0</span>
</div>
</div>
</div>

</div>

<div class="bg-indigo-50 p-4 rounded-xl border text-center">
<label class="text-xs font-bold text-indigo-700 block mb-1">
Reporting Month
</label>

<input type="month" id="report-month"
class="bg-white border rounded px-3 py-1 font-bold text-indigo-800">

<button onclick="window.openReports()"
class="mt-3 bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold">
Fill Reports →
</button>
</div>

</div>

<!-- SUMMARY CARDS -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">

<!-- INSPECTION -->
<div class="relative p-5 rounded-2xl bg-teal-50 border border-teal-100 shadow-sm">
<div class="flex justify-between items-start">
<div>
<p class="text-xs font-bold text-teal-700 uppercase">Inspection</p>
<p id="inspection-percent" class="text-3xl font-bold text-teal-800">0%</p>
<p id="inspection-count" class="text-sm text-teal-700">0/0 Institutes</p>
</div>
<div class="bg-white/70 p-2 rounded-lg">
<i class="fas fa-check text-teal-600"></i>
</div>
</div>

<div class="mt-4 h-2 bg-teal-100 rounded-full">
<div id="inspection-bar" class="h-2 bg-teal-500 rounded-full" style="width:0%"></div>
</div>
</div>

<!-- TEACHING -->
<div class="relative p-5 rounded-2xl bg-blue-50 border border-blue-100 shadow-sm">
<div class="flex justify-between">
<div>
<p class="text-xs font-bold text-blue-700 uppercase">Teaching</p>
<p id="teaching-percent" class="text-3xl font-bold text-blue-800">0%</p>
<p id="teaching-count" class="text-sm text-blue-700">0/0 Institutes</p>
</div>
<div class="bg-white/70 p-2 rounded-lg">
<i class="fas fa-microphone text-blue-600"></i>
</div>
</div>
<div class="mt-4 h-2 bg-blue-100 rounded-full">
<div id="teaching-bar" class="h-2 bg-blue-500 rounded-full" style="width:0%"></div>
</div>
</div>

<!-- TEST -->
<div class="relative p-5 rounded-2xl bg-indigo-50 border border-indigo-100 shadow-sm">
<div class="flex justify-between">
<div>
<p class="text-xs font-bold text-indigo-700 uppercase">Test</p>
<p id="test-percent" class="text-3xl font-bold text-indigo-800">0%</p>
<p id="test-count" class="text-sm text-indigo-700">0/0 Institutes</p>
</div>
<div class="bg-white/70 p-2 rounded-lg">
<i class="fas fa-file-alt text-indigo-600"></i>
</div>
</div>
<div class="mt-4 h-2 bg-indigo-100 rounded-full">
<div id="test-bar" class="h-2 bg-indigo-500 rounded-full" style="width:0%"></div>
</div>
</div>

<!-- PERFORMANCE -->
<div class="relative p-5 rounded-2xl bg-purple-50 border border-purple-100 shadow-sm">
<div class="flex justify-between">
<div>
<p class="text-xs font-bold text-purple-700 uppercase">Performance</p>
<p id="performance-percent" class="text-3xl font-bold text-purple-800">0%</p>
<p id="performance-count" class="text-sm text-purple-700">0/0 Institutes</p>
</div>
<div class="bg-white/70 p-2 rounded-lg">
<i class="fas fa-graduation-cap text-purple-600"></i>
</div>
</div>
<div class="mt-4 h-2 bg-purple-100 rounded-full">
<div id="performance-bar" class="h-2 bg-purple-500 rounded-full" style="width:0%"></div>
</div>
</div>

  <!-- PERFORMANCE CHARTS -->
<div class="grid grid-cols-1 gap-6">

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div class="flex justify-between items-center mb-4">
            <h4 class="font-bold text-gray-700">Inspection Performance</h4>
            <button class="text-gray-400 hover:text-teal-600">
                <i class="fas fa-download"></i>
            </button>
        </div>

        <div style="height:300px;">
            <canvas id="inspectionChart"></canvas>
        </div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div class="flex justify-between items-center mb-4">
            <h4 class="font-bold text-gray-700">Test Performance</h4>
            <button class="text-gray-400 hover:text-indigo-600">
                <i class="fas fa-download"></i>
            </button>
        </div>

        <div style="height:300px;">
            <canvas id="testChart"></canvas>
        </div>
    </div>
</div>
</div>

</div>

<!-- REPORTS -->
<div id="reports-section" class="hidden">

<button onclick="window.backToSummary()" class="mb-6 text-indigo-600">
← Back
</button>

<div class="flex gap-3 mb-6">
<button class="tab-btn tab-active" onclick="window.switchTab('jaiza')">Jaiza</button>
<button class="tab-btn" onclick="window.switchTab('test')">Test</button>
<button class="tab-btn" onclick="window.switchTab('tadris')">Tadris</button>
<button class="tab-btn" onclick="window.switchTab('kkd')">Karkardagi</button>
</div>

<div id="tab-jaiza"></div>
<div id="tab-test" class="hidden">Test Module</div>
<div id="tab-tadris" class="hidden">Tadris Module</div>
<div id="tab-kkd" class="hidden">KKD Module</div>

</div>

</main>

<!-- PHOTO MODAL -->
<div id="photo-modal"
class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
<div class="bg-white p-6 rounded-xl w-80">
<h3 class="font-bold mb-3">Update Profile Photo</h3>

<input type="file"
id="photo-file-input"
accept="image/*"
class="w-full border rounded p-2 mb-4">

<div class="flex justify-end gap-2">
<button onclick="window.closePhotoModal()" class="px-4 py-2 bg-gray-200 rounded">
Cancel
</button>
<button onclick="window.savePhoto()" class="px-4 py-2 bg-indigo-600 text-white rounded">
Save
</button>
</div>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {getAuth,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import {getFirestore,doc,getDoc,collection,query,where,getDocs,updateDoc} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import {getStorage,ref,uploadBytes,getDownloadURL}
from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

const firebaseConfig={
apiKey:"AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
authDomain:"data-f15ab.firebaseapp.com",
projectId:"data-f15ab"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage = getStorage(app);

let currentUser=null;
let assignedJamiaat=[];
let completedReports=[];

// ===== AUTH =====
onAuthStateChanged(auth,async user=>{
if(!user){location.href="index.html";return;}
currentUser=user;
await loadData();
});

// ===== LOAD DATA =====
async function loadData(){

const userDoc=await getDoc(doc(db,"users",currentUser.uid));
if(userDoc.exists()){
const data=userDoc.data();
assignedJamiaat=data.assignedJamiaat||[];
document.getElementById("inspector-display-name").textContent=data.name||"Inspector";
document.getElementById("total-teachers").textContent=data.teachersCount||0;
if(data.photo) document.getElementById("profile-photo").src=data.photo;
}

document.getElementById("total-institutes").textContent=assignedJamiaat.length;

const month=document.getElementById("report-month").value;
const q=query(collection(db,"jaiza_forms"),
where("month","==",month),
where("createdBy","==",currentUser.uid));

const snap=await getDocs(q);
completedReports=snap.docs.map(d=>d.data().jamiaName);

renderSummary();
renderJamiaList();
  renderCharts();
}

// ===== RENDER =====
function renderSummary(){

const total = assignedJamiaat.length;
const done = completedReports.length;
const percent = total ? Math.round(done/total*100) : 0;

// Inspection
document.getElementById("inspection-percent").textContent = percent+"%";
document.getElementById("inspection-count").textContent = `${done}/${total} Institutes`;
document.getElementById("inspection-bar").style.width = percent+"%";

// Teaching
document.getElementById("teaching-percent").textContent = percent+"%";
document.getElementById("teaching-count").textContent = `${done}/${total} Institutes`;
document.getElementById("teaching-bar").style.width = percent+"%";

// Test
document.getElementById("test-percent").textContent = percent+"%";
document.getElementById("test-count").textContent = `${done}/${total} Institutes`;
document.getElementById("test-bar").style.width = percent+"%";

// Performance
document.getElementById("performance-percent").textContent = percent+"%";
document.getElementById("performance-count").textContent = `${done}/${total} Institutes`;
document.getElementById("performance-bar").style.width = percent+"%";

}

function renderJamiaList(){
let html="";
assignedJamiaat.forEach(j=>{
const done=completedReports.includes(j);
html+=`
<div class="card p-4 mb-3 flex justify-between">
<div>
<div class="font-bold">${j}</div>
<div class="${done?'text-green-600':'text-orange-500'}">
${done?'Completed':'Pending'}
</div>
</div>
<button class="px-3 py-1 rounded ${
done?'bg-gray-200':'bg-indigo-600 text-white'
}">
${done?'Done':'Start'}
</button>
</div>`;
});
document.getElementById("tab-jaiza").innerHTML=html;
}

// ===== GLOBAL UI =====
window.openReports=()=>{
document.getElementById("summary-section").classList.add("hidden");
document.getElementById("reports-section").classList.remove("hidden");
};

window.backToSummary=()=>{
document.getElementById("reports-section").classList.add("hidden");
document.getElementById("summary-section").classList.remove("hidden");
};

window.openPhotoModal=()=>{
document.getElementById("photo-modal").classList.remove("hidden");
document.getElementById("photo-modal").classList.add("flex");
};

window.closePhotoModal=()=>{
document.getElementById("photo-modal").classList.add("hidden");
};

window.savePhoto = async function(){

const fileInput = document.getElementById("photo-file-input");
if(!fileInput.files.length) return;

const file = fileInput.files[0];

// path: users/{uid}/profile.jpg
const storageRef = ref(storage, `users/${currentUser.uid}/profile.jpg`);

await uploadBytes(storageRef, file);

const downloadURL = await getDownloadURL(storageRef);

// save in firestore
await updateDoc(doc(db,"users",currentUser.uid),{
photo:downloadURL
});

// update UI
document.getElementById("profile-photo").src = downloadURL;

window.closePhotoModal();
}

window.switchTab=(name)=>{
["jaiza","test","tadris","kkd"].forEach(t=>{
document.getElementById("tab-"+t).classList.add("hidden");
});
document.getElementById("tab-"+name).classList.remove("hidden");
};

window.handleLogout=()=>signOut(auth);

// ===== CURRENT MONTH =====
const now=new Date();
document.getElementById("report-month").value=
now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");

document.getElementById("report-month").onchange=loadData;

  function renderCharts(){

const labels = assignedJamiaat;
const values = assignedJamiaat.map(j =>
completedReports.includes(j) ? 100 : 0
);

// destroy old charts if exist
if(window.inspectionChartObj) window.inspectionChartObj.destroy();
if(window.testChartObj) window.testChartObj.destroy();

window.inspectionChartObj = new Chart(
document.getElementById("inspectionChart"),
{
type:"bar",
data:{
labels:labels,
datasets:[{
data:values,
borderRadius:6
}]
},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{display:false}},
scales:{
y:{beginAtZero:true,max:100,ticks:{stepSize:20}},
x:{ticks:{autoSkip:false}}
}
}
});

window.testChartObj = new Chart(
document.getElementById("testChart"),
{
type:"bar",
data:{
labels:labels,
datasets:[{
data:values,
borderRadius:6
}]
},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{display:false}},
scales:{
y:{beginAtZero:true,max:100}
}
}
});

}

</script>
</body>
</html>









