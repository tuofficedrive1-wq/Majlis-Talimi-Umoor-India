<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Test Result Sheet Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // const firebaseConfig = { ... }; // Your actual config
        // firebase.initializeApp(firebaseConfig);
        // const db = firebase.firestore();
        
        // --- DUMMY FIREBASE INITIALIZATION for structure (Replace with your actual code) ---
        const db = {
            collection: (name) => ({
                doc: (id) => ({
                    get: () => Promise.resolve({ exists: true, data: () => ({ /* result data or student list */ }) }),
                    set: (data) => { 
                        console.log("Data Saved:", data); 
                        alert("Result Sheet successfully save ho gaya!");
                        return Promise.resolve();
                    }
                })
            })
        };
        // ---------------------------------------------------------------------------------
    </script>

    <style>
        .urdu-font {
            font-family: 'Noto Nastaliq Urdu', serif; /* Use your preferred Urdu font */
        }
        .mark-input {
            width: 80px;
            text-align: center;
            border: 1px solid #ccc;
            padding: 4px;
            border-radius: 4px;
        }
        .result-table th, .result-table td {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold mb-4 text-teal-700 urdu-font" id="form-title">Monthly Test Result Sheet</h1>
        <p class="text-gray-600 mb-6 urdu-font">Jamia: <span id="jamia-name" class="font-semibold"></span> | Mahina: <span id="month-name" class="font-semibold"></span></p>

        <div id="config-section" class="mb-8 p-4 border rounded-lg bg-yellow-50">
            <h2 class="text-xl font-semibold mb-3 urdu-font">1. Class aur Subjects Select Karein</h2>
            <div class="flex space-x-4 mb-4">
                
                <div>
                    <label for="class-select" class="block text-sm font-medium text-gray-700 urdu-font">Class Name</label>
                    <select id="class-select" onchange="loadSubjectsAndStudents()" class="mt-1 block w-48 py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm urdu-font">
                        <option value="">-- Class Select Karein --</option>
                        </select>
                </div>

                <div>
                    <label for="total-marks" class="block text-sm font-medium text-gray-700 urdu-font">Total Marks Per Subject</label>
                    <input type="number" id="total-marks" value="100" min="10" class="mt-1 block w-48 py-2 px-3 border border-gray-300 rounded-md shadow-sm sm:text-sm text-center" onchange="updateTotalMarks()">
                </div>
            </div>

            <div id="subject-list" class="mt-3 urdu-font">
                <p class="text-red-500">Pehle Class Select Karein taake subjects load ho sakein.</p>
            </div>
        </div>

        <div id="result-sheet-container" class="overflow-x-auto">
            <table class="w-full result-table bg-white">
                <thead id="table-head" class="bg-teal-600 text-white sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left urdu-font" style="min-width: 150px;">Student Name</th>
                        <th class="px-6 py-3 urdu-font">Total (0)</th>
                        <th class="px-6 py-3 urdu-font">%</th>
                        <th class="px-6 py-3 urdu-font">Grade</th>
                        <th class="px-6 py-3 urdu-font">Action</th>
                    </tr>
                </thead>
                <tbody id="students-body">
                    </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-between items-center">
            <button onclick="addStudentRow()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded urdu-font">
                <i class="fas fa-user-plus"></i> Naya Student Jodein
            </button>
            <button onclick="saveData()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg urdu-font text-xl">
                <i class="fas fa-save"></i> Result Sheet Save Karein
            </button>
        </div>
    </div>

    <script>
        let currentJamia, currentMonth, selectedClass;
        let subjects = [];
        let totalMarksPerSubject = 100;

        // --- Utility Functions ---

        function getParams() {
            const urlParams = new URLSearchParams(window.location.search);
            currentJamia = urlParams.get('jamia');
            currentMonth = urlParams.get('month');

            if (!currentJamia || !currentMonth) {
                alert("URL me Jamia ya Mahina missing hai. Wapas jayein.");
                return false;
            }
            
            document.getElementById('jamia-name').textContent = currentJamia;
            document.getElementById('month-name').textContent = currentMonth;
            return true;
        }

        // Grade Calculation based on your needs (Example Grades)
        function calculateGrade(percentage) {
            if (percentage >= 80) return 'Mumtaz (بہت اچھے)';
            if (percentage >= 60) return 'Jayyid Jiddan (اچھے)';
            if (percentage >= 40) return 'Jayyid (عام)';
            return 'Rasib (کمزور)';
        }

        function calculateRow(inputElement) {
            const row = inputElement.closest('tr');
            let totalMarks = 0;
            let marksAttempted = 0;

            row.querySelectorAll('.mark-input').forEach(input => {
                const mark = parseInt(input.value) || 0;
                totalMarks += mark;
                if(input.value !== '') { marksAttempted++; }
            });

            // Total Possible Marks (Based on subjects loaded)
            const maxTotalMarks = subjects.length * totalMarksPerSubject;
            
            const percentage = (maxTotalMarks > 0) ? (totalMarks / maxTotalMarks * 100).toFixed(1) : 0;
            const grade = calculateGrade(parseFloat(percentage));

            row.querySelector('.total-cell').textContent = totalMarks;
            row.querySelector('.percent-cell').textContent = `${percentage}%`;
            row.querySelector('.grade-cell').textContent = grade;
            
            // Highlight Grade for better visibility
            row.querySelector('.grade-cell').className = 'grade-cell urdu-font' + (parseFloat(percentage) < 40 ? ' text-red-600 font-bold' : ' text-green-600 font-bold');
        }
        
        function updateTotalMarks() {
            totalMarksPerSubject = parseInt(document.getElementById('total-marks').value) || 100;
            // Re-render the header to show new max marks
            renderTableHeader();
            // Recalculate all rows
            document.querySelectorAll('#students-body tr').forEach(row => {
                calculateRow(row.querySelector('.mark-input') || {}); // Pass any input for calculation trigger
            });
        }

        // --- Data Loading Functions (Simulated) ---

        async function fetchClasses() {
            // FIREBASE: Get list of classes from Karkardgi Setup Structure
            // Example: db.collection('karkardgi_setup').doc(currentJamia).get()
            // DUMMY Data:
            const classesList = ['Awwal', 'Saani', 'Saalis', 'Rabeh'];
            const select = document.getElementById('class-select');
            classesList.forEach(cls => {
                select.innerHTML += `<option value="${cls}">${cls}</option>`;
            });
        }

        async function fetchStudents(className) {
            // FIREBASE: Get previously saved student list for this Jamia and Class
            // Example: db.collection('student_roster').doc(currentJamia + '_' + className).get()
            // DUMMY Data:
            if (className === 'Awwal') {
                return ['Ahmed Raza', 'Ali Hassan', 'Muhammad Zain'];
            }
            return [];
        }

        async function fetchSubjects(className) {
             // FIREBASE: Get subjects linked to this class from Karkardgi Setup Structure
             // Example: db.collection('karkardgi_setup').doc('subjects').get()
             // DUMMY Data:
             if (className === 'Awwal') {
                 return ['Quran', 'Fiqh', 'Nahw', 'Urdu', 'Deeniyat'];
             }
             return ['Fiqh', 'Hadees', 'Tafseer', 'Farsi'];
        }

        // --- Table Rendering ---

        function renderTableHeader() {
            const head = document.getElementById('table-head');
            let subjectHeaders = subjects.map(sub => 
                `<th class="px-6 py-3 urdu-font text-center" style="min-width: 100px;">${sub} (${totalMarksPerSubject})</th>`
            ).join('');
            
            head.innerHTML = `
                <tr>
                    <th class="px-6 py-3 text-left urdu-font sticky left-0 bg-teal-600 z-10" style="min-width: 150px;">Student Name</th>
                    ${subjectHeaders}
                    <th class="px-6 py-3 urdu-font sticky right-0 bg-teal-600 z-10" style="min-width: 80px;">Total</th>
                    <th class="px-6 py-3 urdu-font" style="min-width: 60px;">%</th>
                    <th class="px-6 py-3 urdu-font" style="min-width: 100px;">Grade</th>
                    <th class="px-6 py-3 urdu-font" style="min-width: 60px;">Action</th>
                </tr>
            `;
            document.getElementById('subject-list').innerHTML = `<p class="text-green-600">Subjects Load ho chuke hain: ${subjects.join(', ')}</p>`;
        }

        function addStudentRow(studentName = '', marks = {}) {
            const body = document.getElementById('students-body');
            const newRow = document.createElement('tr');
            newRow.className = 'text-sm hover:bg-gray-50';

            let marksInputs = subjects.map(sub => `
                <td class="text-center">
                    <input type="number" data-subject="${sub}" class="mark-input" min="0" max="${totalMarksPerSubject}" value="${marks[sub] || ''}" oninput="calculateRow(this)">
                </td>
            `).join('');

            newRow.innerHTML = `
                <td class="px-3 py-2 sticky left-0 bg-white z-10">
                    <input type="text" class="w-full urdu-font border-b border-gray-300 focus:outline-none" value="${studentName}" placeholder="Student Ka Naam">
                </td>
                ${marksInputs}
                <td class="total-cell text-center font-semibold sticky right-0 bg-gray-50 z-10">0</td>
                <td class="percent-cell text-center">0%</td>
                <td class="grade-cell urdu-font text-center">-</td>
                <td class="text-center">
                    <button onclick="removeStudentRow(this)" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            body.appendChild(newRow);
            if (studentName) {
                // Initial calculation for loaded data
                calculateRow(newRow.querySelector('.mark-input') || {});
            }
        }

        function removeStudentRow(button) {
            button.closest('tr').remove();
        }

        async function loadSubjectsAndStudents() {
            selectedClass = document.getElementById('class-select').value;
            if (!selectedClass) {
                subjects = [];
                document.getElementById('students-body').innerHTML = '';
                document.getElementById('subject-list').innerHTML = `<p class="text-red-500">Pehle Class Select Karein taake subjects load ho sakein.</p>`;
                return;
            }

            // 1. Load Subjects
            subjects = await fetchSubjects(selectedClass);
            renderTableHeader();

            // 2. Load Existing Result Data (If available)
            const existingResult = await fetchExistingResult(currentJamia, currentMonth, selectedClass);
            document.getElementById('students-body').innerHTML = '';
            
            if (existingResult && existingResult.students && existingResult.students.length > 0) {
                alert("Pichle bhare hue results load ho rahe hain!");
                existingResult.students.forEach(student => {
                    addStudentRow(student.name, student.marks);
                });
            } else {
                // 3. Load Student Roster (If no result, load previous students)
                const studentRoster = await fetchStudents(selectedClass);
                if (studentRoster.length > 0) {
                     if (confirm(`Class "${selectedClass}" ke pichle ${studentRoster.length} students load karein?`)) {
                        studentRoster.forEach(name => addStudentRow(name));
                     }
                }
                // Agar koi student nahi mila to ek empty row de dein
                if (document.getElementById('students-body').children.length === 0) {
                    addStudentRow(); 
                }
            }
        }
        
        async function fetchExistingResult(jamia, month, className) {
            // FIREBASE: Check if a result sheet exists for this Jamia, Month, and Class
            // Example: db.collection('monthly_test_sheets').doc(jamia + '_' + month + '_' + className).get()
            // DUMMY Data:
            return null; // Assume no existing data for now
        }

        // --- Data Saving ---

        function collectData() {
            const studentsData = [];
            const rows = document.querySelectorAll('#students-body tr');

            rows.forEach(row => {
                const nameInput = row.querySelector('td:first-child input');
                const name = nameInput ? nameInput.value.trim() : '';

                if (name === '') return; // Skip empty rows

                let studentTotal = 0;
                const studentMarks = {};
                let markCount = 0;

                row.querySelectorAll('.mark-input').forEach(input => {
                    const subject = input.getAttribute('data-subject');
                    const mark = parseInt(input.value) || 0;
                    studentMarks[subject] = mark;
                    studentTotal += mark;
                    if(input.value !== '') { markCount++; }
                });

                const maxTotalMarks = subjects.length * totalMarksPerSubject;
                const percentage = (maxTotalMarks > 0) ? (studentTotal / maxTotalMarks * 100).toFixed(1) : 0;
                const grade = calculateGrade(parseFloat(percentage));

                studentsData.push({
                    name: name,
                    marks: studentMarks,
                    total: studentTotal,
                    percentage: parseFloat(percentage),
                    grade: grade
                });
            });

            return {
                jamiaName: currentJamia,
                month: currentMonth,
                className: selectedClass,
                subjects: subjects,
                totalMarksPerSubject: totalMarksPerSubject,
                students: studentsData,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        async function saveData() {
            if (!selectedClass) {
                alert("Pehle Class Select Karein!");
                return;
            }
            if (subjects.length === 0) {
                 alert("Subjects load nahi hue hain.");
                return;
            }

            const finalData = collectData();
            
            if (finalData.students.length === 0) {
                alert("Koi student data fill nahi hua hai!");
                return;
            }

            const docId = `${currentJamia}_${currentMonth}_${selectedClass}`;
            
            try {
                // Save to Monthly Result Sheet Collection
                await db.collection('monthly_test_sheets').doc(docId).set(finalData);
                
                // Also update the student roster for next month's memory feature
                const studentNames = finalData.students.map(s => s.name);
                await db.collection('student_roster').doc(`${currentJamia}_${selectedClass}`).set({ students: studentNames });

                alert("Result Sheet successfully save ho gaya!");
                // Yahan aap user ko dashboard par redirect kar sakte hain ya PDF button show kar sakte hain
                // window.close();
            } catch (error) {
                console.error("Saving me error aayi: ", error);
                alert("Data save nahi ho paya. Console check karein.");
            }
        }

        // --- Initialization ---
        function initForm() {
            if (getParams()) {
                fetchClasses();
                // Optionally load total marks from a setup document
                // totalMarksPerSubject = loadTotalMarksSetup() || 100;
                document.getElementById('total-marks').value = totalMarksPerSubject;
            }
        }

        initForm();
    </script>
</body>
</html>