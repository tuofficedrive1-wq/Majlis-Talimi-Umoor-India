<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تعلیمی جائزہ فارم (کلاس وار)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @font-face {
      font-family: 'Jameel Noori Nastaleeq';
      src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
      font-display: swap;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #e5edf5;
      font-size: 14px; /* overall text bigger */
    }
    .urdu {
      font-family: 'Jameel Noori Nastaleeq', system-ui, sans-serif;
    }
    input, select, textarea, button {
      font-size: 13px !important;  /* form text bigger on mobile + desktop */
    }
    ::placeholder {
      font-size: 12px;
    }
  </style>
</head>
<body class="min-h-screen p-3 md:p-6">

<!-- Loader -->
<div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center hidden z-50">
  <div class="w-10 h-10 border-4 border-gray-200 border-t-teal-500 rounded-full animate-spin"></div>
</div>

<div class="max-w-6xl mx-auto space-y-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold urdu">تعلیمی جائزہ فارم</h1>
      <p id="subtitle" class="text-sm md:text-base text-gray-600 mt-1"></p>
    </div>
    <a href="index.html"
       class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm md:text-base bg-white shadow border border-gray-200 hover:bg-gray-50">
      ← ڈیش بورڈ
    </a>
  </div>

  <!-- Alerts -->
  <div id="error-box" class="hidden p-3 rounded-lg bg-red-100 text-red-700 text-sm urdu"></div>
  <div id="success-box" class="hidden p-3 rounded-lg bg-emerald-100 text-emerald-700 text-sm urdu"></div>

  <!-- Jamia overall summary -->
  <div class="bg-sky-900 text-white rounded-xl shadow px-4 py-3 flex flex-wrap items-center gap-4 text-sm urdu">
    <span class="font-semibold">جامعہ کا مجموعی فیصد:</span>
    <span id="jamia-percent" class="font-bold text-2xl md:text-3xl bg-yellow-400 text-black px-3 py-1 rounded-lg">0</span>

    <span class="font-semibold ml-4">درجہ کیفیت:</span>
    <span id="jamia-grade" class="font-bold text-xl md:text-2xl px-3 py-1 rounded-lg bg-emerald-500">-</span>

    <!-- ✅ naya hissa: class aur kitab count -->
    <span class="font-semibold ml-4">کل کلاسوں کا جائزہ:</span>
    <span id="jamia-class-count" class="font-bold text-xl bg-indigo-500 px-3 py-1 rounded-lg">0</span>

    <span class="font-semibold ml-4">کل کتابوں کا جائزہ:</span>
    <span id="jamia-book-count" class="font-bold text-xl bg-fuchsia-500 px-3 py-1 rounded-lg">0</span>
  </div>

  <!-- Info -->
  <div class="bg-white rounded-xl shadow p-3 md:p-4 text-sm text-gray-700 urdu leading-relaxed">
    <p class="mb-1">
      ہر کلاس کے لیے جتنی ضرورت ہو اتنی کتابیں شامل کریں، ہر کتاب میں زیادہ سے زیادہ
      <span class="font-semibold">۵ سوالات</span> درج کریں (کم ہوں تو باقی خانے خالی چھوڑ دیں)۔
    </p>
    <p>
      ہر کتاب کا فیصد: ہر سوال میں درست جواب دینے والے طلبہ کی اوسط مقدار / <span class="font-semibold">حاضر طلبہ</span> × 100  
      پھر تمام کتابوں کے فیصد کا اوسط لے کر اس کلاس کا مجموعی فیصد، اور تمام کلاسوں کا اوسط جامعہ کا فیصد بنے گا۔
    </p>
  </div>

  <!-- Form -->
  <form id="jaiza-form" class="space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-base md:text-lg font-semibold urdu">کلاس وار جائزہ</h2>

      <div class="flex items-center gap-2">
        <!-- ✅ Update mode button (sirf jab purana data ho) -->
        <button type="button" id="enable-edit-btn"
                class="px-3 py-1.5 rounded-lg bg-orange-500 hover:bg-orange-600 text-white text-sm urdu hidden">
          جائزہ اپ ڈیٹ کریں
        </button>

        <button type="button" id="add-class-btn"
                class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm urdu">
          + نئی کلاس شامل کریں
        </button>
      </div>
    </div>

    <div id="classes-container" class="space-y-4"></div>

    <div class="bg-white rounded-xl shadow px-3 md:px-4 py-3 flex justify-end">
      <button type="submit"
              class="px-4 md:px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm urdu font-semibold">
        جائزہ محفوظ کریں
      </button>
    </div>
  </form>
</div>

<script type="module">
/*************** Firebase setup ***************/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  addDoc,
  deleteDoc,
  getDoc,
  doc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
  authDomain: "data-f15ab.firebaseapp.com",
  projectId: "data-f15ab",
  storageBucket: "data-f15ab.appspot.com",
  messagingSenderId: "449137002393",
  appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
  measurementId: "G-1PHNJQWNPZ",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/*************** DOM refs ***************/
const loader             = document.getElementById("loader");
const subtitle           = document.getElementById("subtitle");
const errorBox           = document.getElementById("error-box");
const successBox         = document.getElementById("success-box");
const jamiaPercEl        = document.getElementById("jamia-percent");
const jamiaGradeEl       = document.getElementById("jamia-grade");
const jamiaClassCountEl  = document.getElementById("jamia-class-count");
const jamiaBookCountEl   = document.getElementById("jamia-book-count");
const classesContainer   = document.getElementById("classes-container");
const addClassBtn        = document.getElementById("add-class-btn");
const formEl             = document.getElementById("jaiza-form");
const enableEditBtn      = document.getElementById("enable-edit-btn");

const showLoader = (v) => loader.classList.toggle("hidden", !v);
const showError  = (msg) => { errorBox.textContent = msg; errorBox.classList.remove("hidden"); };
const clearError = () => errorBox.classList.add("hidden");
const showSuccess= (msg) => { successBox.textContent = msg; successBox.classList.remove("hidden"); };
const clearSuccess = () => successBox.classList.add("hidden");

/*************** URL params ***************/
const params   = new URLSearchParams(window.location.search);
const jamiaId  = params.get("jamia");
const monthKey = params.get("month");

if (!jamiaId || !monthKey) {
  showError("URL میں جامعہ اور مہینہ دونوں کا ہونا ضروری ہے، مثلاً ?jamia=Latoor&month=2025-11");
} else {
  subtitle.textContent = `جامعہ: ${decodeURIComponent(jamiaId)} • مہینہ: ${monthKey}`;
}

let currentUser = null;
let classCount  = 0;

// className -> [{teacherName, bookName}, ...]
let teachingMap = {};
let classList   = [];
let isEditMode  = true; // default: pehli dafa editable

/*************** Form ko editable / read-only banane ka helper ***************/
const setFormEditable = (isEditable) => {
  const controls = formEl.querySelectorAll("input, select, textarea, button");

  controls.forEach(el => {
    // Update button ko kabhi disable na karein
    if (el.id === "enable-edit-btn") return;

    if (
      el.tagName === "INPUT" ||
      el.tagName === "SELECT" ||
      el.tagName === "TEXTAREA" ||
      el.type === "button" ||
      el.type === "submit"
    ) {
      el.disabled = !isEditable;
    }
  });

  if (!isEditable) {
    formEl.classList.add("opacity-60");
  } else {
    formEl.classList.remove("opacity-60");
  }
};

/*************** Helpers ***************/
const getGrade = (p) => {
  if (p >= 80) return "ممتاز";
  if (p >= 60) return "بہتر";
  if (p >= 40) return "مناسب";
  if (p > 0)   return "کمزور";
  return "-";
};

const getMonthInfoFromKey = (key) => {
  if (!key) return null;
  const [yStr, mStr] = key.split("-");
  const yearNum  = parseInt(yStr);
  const monthNum = parseInt(mStr) - 1;
  if (isNaN(yearNum) || isNaN(monthNum)) return null;

  const academicYear = monthNum >= 3 ? `${yearNum}-${yearNum+1}` : `${yearNum-1}-${yearNum}`;
  return { yearNum, monthNum, academicYear };
};

/*************** Load teaching structure ***************/
const loadTeachingStructure = async (user) => {
  teachingMap = {};
  classList   = [];

  const info = getMonthInfoFromKey(monthKey);
  if (!info) {
    showError("مہینے کا فارمیٹ درست نہیں (YYYY-MM).");
    return;
  }
  const { academicYear } = info;

  try {
    // users collection se academicYears + karkardagiStructure lena
    const userDocRef  = doc(db, "users", user.uid);
    const userDocSnap = await getDoc(userDocRef);

    if (!userDocSnap.exists()) {
      showError("یوزر پروفائل نہیں ملا، پہلے کارکردگی والا سیٹ اپ مکمل کریں۔");
      return;
    }

    const userData     = userDocSnap.data() || {};
    const years        = userData.academicYears || {};
    const yearData     = years[academicYear];

    if (!yearData || !Array.isArray(yearData.karkardagiStructure)) {
      showError("اس تعلیمی سال کے لیے کارکردگی کا سیٹ اپ نہیں ملا، پہلے Karkardagi Setup مکمل کریں۔");
      return;
    }

    const jamiaName = decodeURIComponent(jamiaId || "");

    // Sirf current jamia ka structure use karna
    const jamiaStruct = yearData.karkardagiStructure.find(j => j.jamiaName === jamiaName);

    if (!jamiaStruct || !Array.isArray(jamiaStruct.teachers)) {
      showError("اس جامعہ کے لیے کارکردگی سیٹ اپ خالی ہے، اس لیے کلاس/استاذ/کتاب نہیں مل رہیں۔");
      return;
    }

    // teacher + unke periods (class + book) ko map me daalna
    (jamiaStruct.teachers || []).forEach(t => {
      const teacherName = t.name || t.teacherName || t.ustad || "";
      (t.periods || []).forEach(p => {
        const className = p.className || p.class || p.darja || "";
        const bookName  = p.bookName  || p.book  || p.kitab || p.subject || "";
        if (!className || !teacherName || !bookName) return;

        if (!teachingMap[className]) teachingMap[className] = [];
        teachingMap[className].push({ teacherName, bookName });
      });
    });

    classList = Object.keys(teachingMap).sort();

    if (!classList.length) {
      showError("اس جامعہ کے لیے کسی بھی کلاس / کتاب کا پیریڈ سیٹ نہیں کیا گیا، اس لیے dropdown خالی ہیں۔");
    }

  } catch (err) {
    console.error(err);
    showError("کارکردگی سیٹ اپ لوڈ کرتے وقت مسئلہ آیا، بعد میں دوبارہ کوشش کریں۔");
  }
};

/*************** Book % from its 5 questions (uses حاضر طلبہ) ***************/
const recalcSingleBookPercent = (bookCard, card) => {
  const presentStudents = Number(card.querySelector(".present-students")?.value || 0);
  const qRows = bookCard.querySelectorAll(".question-row");
  let sum = 0, count = 0;
  qRows.forEach(row => {
    const corr = Number(row.querySelector(".q-correct")?.value || 0);
    if (corr > 0) {
      sum += corr;
      count++;
    }
  });

  const percEl = bookCard.querySelector(".book-percent");
  if (!presentStudents || !count) {
    percEl.value = "";
    return null;
  }
  const avgCorrect = sum / count;
  const percentage = (avgCorrect / presentStudents) * 100;
  const rounded    = Math.round(percentage * 10) / 10;
  percEl.value     = rounded.toFixed(1) + "%";
  return rounded;
};

/*************** Class % from all book % ***************/
const recalcClassPercent = (card) => {
  const books = card.querySelectorAll(".book-card");
  const percs = [];
  books.forEach(b => {
    const pStr = b.querySelector(".book-percent")?.value;
    if (!pStr) return;
    const num = Number(pStr.replace("%","").trim());
    if (!isNaN(num)) percs.push(num);
  });

  const classPercInput  = card.querySelector(".class-percent");
  const classGradeInput = card.querySelector(".class-grade");

  if (!percs.length) {
    classPercInput.value  = "";
    classGradeInput.value = "-";
    return;
  }

  const sum = percs.reduce((a,b)=>a+b,0);
  const avg = Math.round((sum/percs.length)*10)/10;
  classPercInput.value  = avg.toFixed(1) + "%";
  classGradeInput.value = getGrade(avg);
};

/*************** Jamia overall % + counts ***************/
const recalcJamia = () => {
  const cards = classesContainer.querySelectorAll(".class-card");
  const percs = [];

  let classCnt = cards.length;
  let bookCnt  = 0;

  cards.forEach(card => {
    const bCards = card.querySelectorAll(".book-card");
    bookCnt += bCards.length;

    const pStr = card.querySelector(".class-percent")?.value;
    if (!pStr) return;
    const num = Number(pStr.replace("%","").trim());
    if (!isNaN(num)) percs.push(num);
  });

  if (jamiaClassCountEl) jamiaClassCountEl.textContent = String(classCnt);
  if (jamiaBookCountEl)  jamiaBookCountEl.textContent  = String(bookCnt);

  if (!percs.length) {
    jamiaPercEl.textContent  = "0";
    jamiaGradeEl.textContent = "-";
    return;
  }

  const sum = percs.reduce((a,b)=>a+b,0);
  const avg = Math.round((sum/percs.length)*100)/100;
  jamiaPercEl.textContent  = avg.toFixed(2);
  jamiaGradeEl.textContent = getGrade(avg);
};

/*************** ONE book card ***************/
const createBookCard = (card) => {
  const classSelect         = card.querySelector(".class-select");
  const totalStudentsInput  = card.querySelector(".total-students");
  const presentStudentsInput= card.querySelector(".present-students");

  const bookCard = document.createElement("div");
  bookCard.className = "book-card border rounded-lg p-2 md:p-3 bg-slate-50 space-y-2";

  bookCard.innerHTML = `
    <div class="flex flex-wrap items-center gap-2 md:gap-3">
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">استاذ</label>
        <select class="w-full border rounded px-2 py-1.5 urdu text-xs md:text-sm book-teacher">
          <option value="">استاذ منتخب کریں</option>
        </select>
      </div>
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کتاب / پیریڈ</label>
        <select class="w-full border rounded px-2 py-1.5 urdu text-xs md:text-sm book-name">
          <option value="">کتاب منتخب کریں</option>
        </select>
      </div>
      <button type="button"
        class="px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs md:text-sm urdu remove-book-btn">
        × کتاب ہٹائیں
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-xs md:text-sm text-right mt-2">
        <thead class="bg-emerald-100">
          <tr>
            <th class="px-2 py-1 urdu">#</th>
            <th class="px-2 py-1 urdu">سوال</th>
            <th class="px-2 py-1 urdu">درست جواب دینے والے طلبہ</th>
          </tr>
        </thead>
        <tbody>
          ${[1,2,3,4,5].map(i=>`
            <tr class="question-row">
              <td class="px-2 py-1 text-center">${i}</td>
              <td class="px-2 py-1">
                <input type="text"
                       class="w-40 md:w-64 border rounded px-1.5 py-1 urdu text-xs md:text-sm q-text"
                       placeholder="سوال ${i}">
              </td>
              <td class="px-2 py-1">
                <input type="number" min="0"
                       class="w-20 border rounded px-1.5 py-1 text-center text-xs md:text-sm q-correct">
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2 text-xs md:text-sm urdu">
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-sabaq-sunana">
        <span>سبق سنانا</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-sabaq-parhana">
        <span>سبق پڑھانا</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-waqt-istemal">
        <span>وقت پورا کا استعمال</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-tiyari">
        <span>سبق کی تیاری کرنے والے</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-takrar">
        <span>سبق دہرانے والے</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-nizam">
        <span>درجہ کا نظم و ضبط</span>
      </label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2 items-start">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">% (اس کتاب کا)</label>
        <input type="text" readonly
               class="w-full border rounded px-2 py-1.5 text-center text-sm md:text-base bg-yellow-50 book-percent">
      </div>
      <div class="md:col-span-2">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کمزوریاں / نوٹس</label>
        <textarea rows="2"
                  class="w-full border rounded px-2 py-1.5 text-xs md:text-sm urdu weakness"></textarea>
      </div>
    </div>
  `;

  const teacherSelect = bookCard.querySelector(".book-teacher");
  const bookSelect    = bookCard.querySelector(".book-name");

  const fillTeachersForClass = () => {
    const cls = classSelect.value;
    teacherSelect.innerHTML = '<option value="">استاذ منتخب کریں</option>';
    bookSelect.innerHTML    = '<option value="">کتاب منتخب کریں</option>';
    if (!cls || !teachingMap[cls]) return;
    const teacherSet = new Set(teachingMap[cls].map(r=>r.teacherName));
    teacherSet.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      teacherSelect.appendChild(opt);
    });
  };

  const fillBooksForTeacher = () => {
    const cls   = classSelect.value;
    const tName = teacherSelect.value;
    bookSelect.innerHTML = '<option value="">کتاب منتخب کریں</option>';
    if (!cls || !teachingMap[cls] || !tName) return;
    const recs    = teachingMap[cls].filter(r=>r.teacherName===tName);
    const bookSet = new Set(recs.map(r=>r.bookName));
    bookSet.forEach(b => {
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      bookSelect.appendChild(opt);
    });
  };

  teacherSelect.addEventListener("change", fillBooksForTeacher);
  classSelect.addEventListener("change", fillTeachersForClass);

  const triggerBookCalc = () => {
    recalcSingleBookPercent(bookCard, card);
    recalcClassPercent(card);
    recalcJamia();
  };

  const qInputs = bookCard.querySelectorAll(".q-correct");
  qInputs.forEach(inp => {
    inp.addEventListener("input", triggerBookCalc);
  });

  if (presentStudentsInput) {
    presentStudentsInput.addEventListener("input", () => {
      const books = card.querySelectorAll(".book-card");
      books.forEach(b => recalcSingleBookPercent(b, card));
      recalcClassPercent(card);
      recalcJamia();
    });
  }

  if (totalStudentsInput) {
    totalStudentsInput.addEventListener("input", () => {
      const books = card.querySelectorAll(".book-card");
      books.forEach(b => recalcSingleBookPercent(b, card));
      recalcClassPercent(card);
      recalcJamia();
    });
  }

  bookCard.querySelector(".remove-book-btn").addEventListener("click", () => {
    bookCard.remove();
    recalcClassPercent(card);
    recalcJamia();
  });

  fillTeachersForClass();
  return bookCard;
};

/*************** Class card create ***************/
const createClassCard = () => {
  classCount += 1;
  const card = document.createElement("div");
  card.className = "bg-white rounded-xl shadow p-3 md:p-4 space-y-3 class-card";
  card.dataset.index = classCount;

  card.innerHTML = `
    <div class="flex flex-wrap items-center gap-2 md:gap-3 border-b pb-2">
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کلاس</label>
        <select class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu class-select">
          <option value="">کلاس منتخب کریں</option>
        </select>
      </div>
      <button type="button"
        class="px-3 py-1.5 rounded-lg bg-red-500 hover:bg-red-600 text-white text-xs md:text-sm urdu remove-class-btn">
        × کلاس ہٹا دیں
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-3 mt-2">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کل طلبہ</label>
        <input type="number" min="1"
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base total-students"
               placeholder="مثال: 30">
      </div>
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">حاضر طلبہ</label>
        <input type="number" min="0"
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base present-students"
               placeholder="مثال: 25">
      </div>
      <div class="flex items-end justify-end">
        <button type="button"
                class="add-book-btn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs md:text-sm urdu">
          + نئی کتاب شامل کریں
        </button>
      </div>
    </div>

    <div class="book-list space-y-3 mt-2"></div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-3 pt-2 border-t mt-1">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">
          اس کلاس کا مجموعی فیصد
        </label>
        <input type="text" readonly
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base bg-yellow-50 class-percent">
      </div>
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">درجہ کیفیت</label>
        <input type="text" readonly
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base bg-emerald-50 class-grade urdu">
      </div>
      <div class="space-y-1">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کمزوریاں اور مسائل</label>
        <textarea rows="2"
                  class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu issues"></textarea>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1 mt-1">حل اور تجاویز</label>
        <textarea rows="2"
                  class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu suggestions"></textarea>
      </div>
    </div>
  `;

  const classSelect         = card.querySelector(".class-select");
  const removeBtn           = card.querySelector(".remove-class-btn");
  const addBookBtn          = card.querySelector(".add-book-btn");
  const bookList            = card.querySelector(".book-list");

  // fill class dropdown
  classSelect.innerHTML = '<option value="">کلاس منتخب کریں</option>';
  classList.forEach(cls => {
    const opt = document.createElement("option");
    opt.value = cls;
    opt.textContent = cls;
    classSelect.appendChild(opt);
  });

  removeBtn.addEventListener("click", () => {
    card.remove();
    recalcJamia();
  });

  const addBook = () => {
    const bCard = createBookCard(card);
    bookList.appendChild(bCard);
    recalcJamia();
  };
  addBookBtn.addEventListener("click", addBook);

  // default: 1 kitab
  addBook();

  return card;
};

const addNewClassCard = () => {
  const card = createClassCard();
  classesContainer.appendChild(card);
  recalcJamia();
};

/*************** Existing Jaiza load (prefill) ***************/
const loadExistingJaiza = async () => {
  // agar user ya URL params missing hon to skip
  if (!currentUser || !jamiaId || !monthKey) {
    addNewClassCard();
    return;
  }

  try {
    const qRef = query(
      collection(db,"jaiza_forms"),
      where("jamiaId","==",jamiaId),
      where("monthKey","==",monthKey),
      where("createdBy","==",currentUser.uid)
    );
    const snap = await getDocs(qRef);

    if (snap.empty) {
      // koi purana data nahi -> naya khali form
      addNewClassCard();
      return;
    }

    const records = [];
    snap.forEach(d => records.push(d.data()));

    // className ke hisaab se thoda sort
    records.sort((a,b) => (a.className || "").localeCompare(b.className || "", undefined, {numeric:true}));

    classesContainer.innerHTML = "";
    classCount = 0;

    for (const rec of records) {
      const card = createClassCard();

      const classSelect       = card.querySelector(".class-select");
      const totalStudentsIn   = card.querySelector(".total-students");
      const presentStudentsIn = card.querySelector(".present-students");
      const issuesIn          = card.querySelector(".issues");
      const suggestionsIn     = card.querySelector(".suggestions");
      const bookList          = card.querySelector(".book-list");

      // pehle default book card hata do
      bookList.innerHTML = "";

      // class select
      if (rec.className) {
        classSelect.value = rec.className;
        // class change event se teacher list refresh ho jaye
        classSelect.dispatchEvent(new Event("change"));
      }

      totalStudentsIn.value   = rec.totalStudents   ?? "";
      presentStudentsIn.value = rec.presentStudents ?? "";
      issuesIn.value          = rec.issues      || "";
      suggestionsIn.value     = rec.suggestions || "";

      // books
      (rec.books || []).forEach(book => {
        const bCard = createBookCard(card);
        bookList.appendChild(bCard);

        const teacherSelect   = bCard.querySelector(".book-teacher");
        const bookSelect      = bCard.querySelector(".book-name");
        const weaknessInput   = bCard.querySelector(".weakness");
        const percInput       = bCard.querySelector(".book-percent");
        const questionRows    = bCard.querySelectorAll(".question-row");

        // teacher ko set karein
        if (book.teacherName) {
          teacherSelect.value = book.teacherName;
          teacherSelect.dispatchEvent(new Event("change"));
        }

        if (book.bookName) {
          bookSelect.value = book.bookName;
        }

        if (weaknessInput) {
          weaknessInput.value = book.weakness || "";
        }

        if (typeof book.percentage === "number") {
          percInput.value = book.percentage.toFixed(1) + "%";
        }

        const qs = book.questions || [];
        questionRows.forEach((row, idx) => {
          const qData = qs[idx];
          if (!qData) return;
          row.querySelector(".q-text").value     = qData.text || "";
          row.querySelector(".q-correct").value  = qData.correctStudents ?? "";
        });

        // ensure percentage recalc just in case
        recalcSingleBookPercent(bCard, card);
      });

      recalcClassPercent(card);
    }

    recalcJamia();

    // ✅ existing data mila: form ko read-only rakho, Update button show karo
    isEditMode = false;
    setFormEditable(false);
    if (enableEditBtn) {
      enableEditBtn.classList.remove("hidden");
    }

  } catch (err) {
    console.error(err);
    // agar koi problem aa jaye to kam se kam khali form de dein
    if (!classesContainer.querySelector(".class-card")) {
      addNewClassCard();
    }
  }
};


/*************** Auth & initial load ***************/
const initForUser = async (user) => {
  showLoader(true);
  try {
    await loadTeachingStructure(user); // karkardagi setup se classes/teachers/books
    await loadExistingJaiza();         // agar pehle se jaiza filled hai to prefill
  } catch (err) {
    console.error(err);
    // fallback: kam se kam ek khali class card
    if (!classesContainer.querySelector(".class-card")) {
      addNewClassCard();
    }
  } finally {
    showLoader(false);
  }
};

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    showError("لاگ اِن ضروری ہے، پہلے ڈیش بورڈ سے لاگ اِن کریں۔");
    return;
  }
  currentUser = user;
  await initForUser(user);
});

addClassBtn.addEventListener("click", () => addNewClassCard());

/*************** Update button: editable mode on ***************/
if (enableEditBtn) {
  enableEditBtn.addEventListener("click", () => {
    isEditMode = true;
    setFormEditable(true);
    enableEditBtn.classList.add("hidden");
  });
}

/*************** Submit → save in Firestore ***************/
formEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  clearError();
  clearSuccess();

  if (!currentUser) {
    showError("لاگ اِن نہیں ملا، براہ کرم دوبارہ ڈیش بورڈ سے آئیں۔");
    return;
  }
  if (!jamiaId || !monthKey) {
    showError("جامعہ یا مہینہ URL میں موجود نہیں، لنک چیک کریں۔");
    return;
  }

  const cards = Array.from(classesContainer.querySelectorAll(".class-card"));
  if (!cards.length) {
    showError("کم از کم ایک کلاس شامل کریں۔");
    return;
  }

  const payloads = [];

  cards.forEach(card => {
    const className       = card.querySelector(".class-select").value.trim();
    const totalStudents   = Number(card.querySelector(".total-students")?.value || 0);
    const presentStudents = Number(card.querySelector(".present-students")?.value || 0);

    const classPercentStr = card.querySelector(".class-percent")?.value || "";
    let classPercentage = null;
    if (classPercentStr) {
      const v = Number(classPercentStr.replace("%","").trim());
      if (!isNaN(v)) classPercentage = v;
    }

    const issues      = card.querySelector(".issues").value.trim();
    const suggestions = card.querySelector(".suggestions").value.trim();

    const books = [];
    const bookCards = card.querySelectorAll(".book-card");
    bookCards.forEach(bCard => {
      const teacherName = bCard.querySelector(".book-teacher").value.trim();
      const bookName    = bCard.querySelector(".book-name").value.trim();
      const weakness    = bCard.querySelector(".weakness").value.trim();
      const percStr     = bCard.querySelector(".book-percent").value;

      const qRows = bCard.querySelectorAll(".question-row");
      const questions = [];
      qRows.forEach((row, idx) => {
        const text = row.querySelector(".q-text").value.trim();
        const corr = Number(row.querySelector(".q-correct").value || 0);
        if (!text && !corr) return;
        questions.push({
          index: idx+1,
          text,
          correctStudents: corr
        });
      });

      const checks = {
        sabaqSunana:  bCard.querySelector(".chk-sabaq-sunana")?.checked || false,
        sabaqParhana: bCard.querySelector(".chk-sabaq-parhana")?.checked || false,
        waqtIstemal:  bCard.querySelector(".chk-waqt-istemal")?.checked || false,
        tiyari:       bCard.querySelector(".chk-tiyari")?.checked || false,
        takrar:       bCard.querySelector(".chk-takrar")?.checked || false,
        nizam:        bCard.querySelector(".chk-nizam")?.checked || false,
      };

      let percentage = null;
      if (percStr) {
        const v = Number(percStr.replace("%","").trim());
        if (!isNaN(v)) percentage = v;
      }

      const allEmptyBook =
        !teacherName && !bookName && !questions.length &&
        !weakness && !percentage &&
        !checks.sabaqSunana && !checks.sabaqParhana && !checks.waqtIstemal &&
        !checks.tiyari && !checks.takrar && !checks.nizam;

      if (allEmptyBook) return;

      books.push({
        teacherName,
        bookName,
        questions,
        percentage,
        weakness,
        checks
      });
    });

    const allEmptyClass =
      !className && !totalStudents && !presentStudents && !books.length && !issues && !suggestions;

    if (allEmptyClass) return;

    payloads.push({
      jamiaId,
      monthKey,
      className,
      totalStudents,
      presentStudents,
      classPercentage,
      grade: classPercentage != null ? getGrade(classPercentage) : "-",
      books,
      issues,
      suggestions,
      createdBy: currentUser.uid,
      createdAt: serverTimestamp()
    });
  });

  if (!payloads.length) {
    showError("کم از کم ایک کلاس میں کچھ ڈیٹا ضرور بھریں۔");
    return;
  }

  showLoader(true);
  try {
    const qRef = query(
      collection(db,"jaiza_forms"),
      where("jamiaId","==",jamiaId),
      where("monthKey","==",monthKey),
      where("createdBy","==",currentUser.uid)
    );
    const oldSnap = await getDocs(qRef);
    const delPromises = [];
    oldSnap.forEach(d => delPromises.push(deleteDoc(d.ref)));
    await Promise.all(delPromises);

    const addPromises = payloads.map(p => addDoc(collection(db,"jaiza_forms"), p));
    await Promise.all(addPromises);

    showSuccess("تعلیمی جائزہ کامیابی کے ساتھ محفوظ ہو گیا۔");

    // ✅ save ke baad phir se view-only mode
    isEditMode = false;
    setFormEditable(false);
    if (enableEditBtn) {
      enableEditBtn.classList.remove("hidden");
    }

  } catch(err) {
    console.error(err);
    showError("ڈیٹا محفوظ کرتے وقت مسئلہ آیا، بعد میں دوبارہ کوشش کریں۔");
  } finally {
    showLoader(false);
  }
});
</script>

</body>
</html>
