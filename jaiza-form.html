<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jaiza Form (Darja Wise)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @font-face {
      font-family: 'Jameel Noori Nastaleeq';
      src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
      font-display: swap;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f1f5f9;
    }
    .urdu-font {
      font-family: 'Jameel Noori Nastaleeq', system-ui, sans-serif;
    }
  </style>
</head>
<body class="min-h-screen p-3 md:p-6">

<!-- Loader -->
<div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center hidden z-50">
  <div class="w-10 h-10 border-4 border-gray-200 border-t-teal-500 rounded-full animate-spin"></div>
</div>

<div class="max-w-6xl mx-auto space-y-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold">Darja Jaiza Form</h1>
      <p id="subtitle" class="text-sm text-gray-500 mt-1"></p>
    </div>
    <a href="index.html"
       class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm bg-white shadow border border-gray-200 hover:bg-gray-50">
      ← Dashboard
    </a>
  </div>

  <!-- Alerts -->
  <div id="error-box" class="hidden p-3 rounded-lg bg-red-100 text-red-700 text-sm"></div>
  <div id="success-box" class="hidden p-3 rounded-lg bg-emerald-100 text-emerald-700 text-sm"></div>
  <div id="info-box" class="hidden p-3 rounded-lg bg-sky-100 text-sky-700 text-sm"></div>

  <!-- Small info -->
  <div class="bg-white rounded-xl shadow p-3 md:p-4 text-xs md:text-sm text-gray-600">
    <p class="mb-1">
      Har <span class="font-semibold">teacher / book / darja</span> ke liye alag row bharain. 
      Columns ko aap apne Excel ke headings ke mutabiq change kar sakte hain.
    </p>
    <p>
      Pehle se filled data ho to next version me load bhi karwa sakte hain. Filhaal ye sirf <span class="font-semibold">save</span> karega.
    </p>
  </div>

  <!-- Table form -->
  <form id="jaiza-form" class="bg-white rounded-xl shadow overflow-hidden">
    <div class="flex justify-between items-center px-3 md:px-4 py-2 border-b">
      <h2 class="text-sm md:text-base font-semibold">Darja Wise Jaiza Details</h2>
      <button type="button" id="add-row-btn"
              class="text-xs md:text-sm px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white">
        + Add Row
      </button>
    </div>

    <div class="max-h-[70vh] overflow-auto">
      <table class="min-w-full text-[11px] md:text-sm">
        <thead class="bg-slate-100 sticky top-0 z-10">
          <tr>
            <th class="px-2 md:px-3 py-2 text-left font-semibold text-gray-600">#</th>
            <th class="px-2 md:px-3 py-2 text-left font-semibold text-gray-600">Teacher</th>
            <th class="px-2 md:px-3 py-2 text-left font-semibold text-gray-600">Book</th>
            <th class="px-2 md:px-3 py-2 text-left font-semibold text-gray-600">Darja / Class</th>
            <th class="px-2 md:px-3 py-2 text-right font-semibold text-gray-600">Total Students</th>
            <th class="px-2 md:px-3 py-2 text-right font-semibold text-gray-600">Appeared</th>
            <th class="px-2 md:px-3 py-2 text-right font-semibold text-gray-600">Pass</th>
            <th class="px-2 md:px-3 py-2 text-right font-semibold text-gray-600">Fail</th>
            <th class="px-2 md:px-3 py-2 text-right font-semibold text-gray-600">% (auto)</th>
            <th class="px-2 md:px-3 py-2 text-left font-semibold text-gray-600">Kamzori ka Khulasa</th>
            <th class="px-2 md:px-3 py-2 text-center font-semibold text-gray-600">Del</th>
          </tr>
        </thead>
        <tbody id="rows-body" class="divide-y divide-gray-100">
          <!-- JS se default 3 rows add kar dete hain -->
        </tbody>
      </table>
    </div>

    <div class="px-3 md:px-4 py-3 border-t flex justify-end">
      <button type="submit"
              class="px-4 md:px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm md:text-base font-semibold">
        Save Jaiza Data
      </button>
    </div>
  </form>

</div>

<script type="module">
  // ==== Firebase imports ====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    addDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
    authDomain: "data-f15ab.firebaseapp.com",
    projectId: "data-f15ab",
    storageBucket: "data-f15ab.appspot.com",
    messagingSenderId: "449137002393",
    appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
    measurementId: "G-1PHNJQWNPZ",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ==== DOM refs ====
  const loader       = document.getElementById('loader');
  const subtitle     = document.getElementById('subtitle');
  const errorBox     = document.getElementById('error-box');
  const successBox   = document.getElementById('success-box');
  const infoBox      = document.getElementById('info-box');
  const rowsBody     = document.getElementById('rows-body');
  const addRowBtn    = document.getElementById('add-row-btn');
  const formEl       = document.getElementById('jaiza-form');

  const showLoader = (v) => loader.classList.toggle('hidden', !v);
  const showError  = (msg) => { errorBox.textContent = msg; errorBox.classList.remove('hidden'); };
  const clearError = () => errorBox.classList.add('hidden');
  const showSuccess= (msg) => { successBox.textContent = msg; successBox.classList.remove('hidden'); };
  const clearSuccess = () => successBox.classList.add('hidden');
  const showInfo   = (msg) => { infoBox.textContent = msg; infoBox.classList.remove('hidden'); };
  const clearInfo  = () => infoBox.classList.add('hidden');

  // ==== URL Params ====
  const params   = new URLSearchParams(window.location.search);
  const jamiaId  = params.get('jamia');   // id ya naam jo bhi aap bhejein
  const monthKey = params.get('month');   // YYYY-MM

  if (!jamiaId || !monthKey) {
    showError("URL me jamia aur month dono zaroori hain (e.g. ?jamia=Latoor&month=2025-11)");
  } else {
    subtitle.textContent = `Jamia: ${decodeURIComponent(jamiaId)} • Month: ${monthKey}`;
  }

  let currentUser = null;

  // ==== Row helper ====
  let rowCount = 0;

  const createRowElement = () => {
    rowCount += 1;
    const tr = document.createElement('tr');
    tr.className = "align-top";

    tr.innerHTML = `
      <td class="px-2 md:px-3 py-2 text-gray-500">${rowCount}</td>

      <td class="px-2 md:px-3 py-1.5">
        <input type="text" class="w-full border rounded px-1.5 py-1 text-[11px] md:text-xs"
               placeholder="Teacher ka naam" data-field="teacherName">
      </td>

      <td class="px-2 md:px-3 py-1.5">
        <input type="text" class="w-full border rounded px-1.5 py-1 text-[11px] md:text-xs"
               placeholder="Book / Sabaq" data-field="bookName">
      </td>

      <td class="px-2 md:px-3 py-1.5">
        <input type="text" class="w-full border rounded px-1.5 py-1 text-[11px] md:text-xs"
               placeholder="Darja / Class" data-field="className">
      </td>

      <td class="px-2 md:px-3 py-1.5">
        <input type="number" min="0" class="w-full border rounded px-1.5 py-1 text-right text-[11px] md:text-xs"
               placeholder="0" data-field="totalStudents">
      </td>

      <td class="px-2 md:px-3 py-1.5">
        <input type="number" min="0" class="w-full border rounded px-1.5 py-1 text-right text-[11px] md:text-xs marks-input"
               placeholder="0" data-field="appeared">
      </td>

      <td class="px-2 md:px-3 py-1.5">
        <input type="number" min="0" class="w-full border rounded px-1.5 py-1 text-right text-[11px] md:text-xs marks-input"
               placeholder="0" data-field="passed">
      </td>

      <td class="px-2 md:px-3 py-1.5">
        <input type="number" min="0" class="w-full border rounded px-1.5 py-1 text-right text-[11px] md:text-xs"
               placeholder="0" data-field="failed">
      </td>

      <td class="px-2 md:px-3 py-1.5">
        <input type="text" readonly class="w-full border rounded px-1.5 py-1 text-right bg-gray-100 text-[11px] md:text-xs"
               placeholder="0%" data-field="percentage">
      </td>

      <td class="px-2 md:px-3 py-1.5">
        <textarea rows="2" class="w-40 md:w-64 border rounded px-1.5 py-1 text-[11px] md:text-xs urdu-font"
                  placeholder="Kamzori / Nuqta e nazar" data-field="weakPoints"></textarea>
      </td>

      <td class="px-2 md:px-3 py-1.5 text-center">
        <button type="button" class="text-red-500 text-xs del-row-btn">×</button>
      </td>
    `;

    // % auto calculate
    const inputs = tr.querySelectorAll('.marks-input');
    inputs.forEach(inp => {
      inp.addEventListener('input', () => {
        const appeared = Number(tr.querySelector('[data-field="appeared"]').value || 0);
        const passed   = Number(tr.querySelector('[data-field="passed"]').value || 0);
        const percEl   = tr.querySelector('[data-field="percentage"]');

        if (appeared > 0 && passed >= 0) {
          const p = Math.round((passed / appeared) * 1000) / 10; // 1 decimal
          percEl.value = p + "%";
        } else {
          percEl.value = "";
        }
      });
    });

    const delBtn = tr.querySelector('.del-row-btn');
    delBtn.addEventListener('click', () => {
      tr.remove();
      // rowCount ko re-index nahi kar rahe; simple rakhein
    });

    return tr;
  };

  const addRow = () => {
    const tr = createRowElement();
    rowsBody.appendChild(tr);
  };

  // Default 3 rows
  for (let i = 0; i < 3; i++) addRow();

  addRowBtn.addEventListener('click', () => {
    addRow();
  });

  // ==== Auth check ====
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      showError("Login zaroori hai. Pehle dashboard se login karein.");
      return;
    }
    currentUser = user;
  });

  // ==== Form submit ====
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();
    clearSuccess();
    clearInfo();

    if (!currentUser) {
      showError("Login nahi mila. Dubara dashboard se aaiye.");
      return;
    }
    if (!jamiaId || !monthKey) {
      showError("Jamia ya month URL me missing hai.");
      return;
    }

    // rows se data nikalna
    const rowEls = Array.from(rowsBody.querySelectorAll('tr'));
    const payloads = [];

    rowEls.forEach(tr => {
      const getVal = (sel) => tr.querySelector(sel)?.value?.trim() || "";

      const teacherName   = getVal('[data-field="teacherName"]');
      const bookName      = getVal('[data-field="bookName"]');
      const className     = getVal('[data-field="className"]');
      const totalStudents = Number(getVal('[data-field="totalStudents"]') || 0);
      const appeared      = Number(getVal('[data-field="appeared"]') || 0);
      const passed        = Number(getVal('[data-field="passed"]') || 0);
      const failed        = Number(getVal('[data-field="failed"]') || 0);
      const percentageStr = getVal('[data-field="percentage"]');
      const weakPoints    = getVal('[data-field="weakPoints"]');

      // Agar puri row khaali hai to skip
      const allEmpty =
        !teacherName && !bookName && !className &&
        !totalStudents && !appeared && !passed && !failed && !weakPoints;

      if (allEmpty) return;

      let percentage = null;
      if (percentageStr) {
        const pNum = Number(percentageStr.replace('%','').trim());
        if (!isNaN(pNum)) percentage = pNum;
      }

      payloads.push({
        jamiaId,
        monthKey,
        teacherName,
        bookName,
        className,
        totalStudents,
        appeared,
        passed,
        failed,
        percentage,
        weakPoints,
        createdBy: currentUser.uid,
        createdAt: serverTimestamp(),
      });
    });

    if (!payloads.length) {
      showError("Kam se kam ek row me data bharen.");
      return;
    }

    showLoader(true);

    try {
      // Purana data delete kar den (is Jamia + is month ka)
      const qRef = query(
        collection(db, 'jaiza_forms'),
        where('jamiaId', '==', jamiaId),
        where('monthKey', '==', monthKey)
      );
      const oldSnap = await getDocs(qRef);
      const deletePromises = [];
      oldSnap.forEach(docSnap => {
        deletePromises.push(deleteDoc(docSnap.ref));
      });
      await Promise.all(deletePromises);

      // Naya data add karein
      const addPromises = payloads.map(row =>
        addDoc(collection(db, 'jaiza_forms'), row)
      );
      await Promise.all(addPromises);

      showSuccess("Jaiza data kamyabi se save ho gaya.");
      showInfo("Ab isi data se Jaiza Summary page banaya ja sakta hai (Jamia + Month wise).");
    } catch (err) {
      console.error(err);
      showError("Jaiza data save karte waqt error aya.");
    } finally {
      showLoader(false);
    }
  });
</script>

</body>
</html>
