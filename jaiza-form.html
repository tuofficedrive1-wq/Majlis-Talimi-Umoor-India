<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تعلیمی جائزہ فارم (کلاس وار)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @font-face {
      font-family: 'Jameel Noori Nastaleeq';
      src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
      font-display: swap;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #e5edf5;
      font-size: 14px; /* overall text bigger */
    }
    .urdu {
      font-family: 'Jameel Noori Nastaleeq', system-ui, sans-serif;
    }
    input, select, textarea, button {
      font-size: 13px !important;  /* form text bigger on mobile + desktop */
    }
    ::placeholder {
      font-size: 12px;
    }
  </style>
</head>
<body class="min-h-screen p-3 md:p-6">

<!-- Loader -->
<div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center hidden z-50">
  <div class="w-10 h-10 border-4 border-gray-200 border-t-teal-500 rounded-full animate-spin"></div>
</div>

<div class="max-w-6xl mx-auto space-y-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold urdu">تعلیمی جائزہ فارم</h1>
      <p id="subtitle" class="text-sm md:text-base text-gray-600 mt-1"></p>
    </div>
    <a href="index.html"
       class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm md:text-base bg-white shadow border border-gray-200 hover:bg-gray-50">
      ← ڈیش بورڈ
    </a>
  </div>

  <!-- Alerts -->
  <div id="error-box" class="hidden p-3 rounded-lg bg-red-100 text-red-700 text-sm urdu"></div>
  <div id="success-box" class="hidden p-3 rounded-lg bg-emerald-100 text-emerald-700 text-sm urdu"></div>

  <!-- Jamia overall summary -->
  <div class="bg-sky-900 text-white rounded-xl shadow px-4 py-3 flex flex-wrap items-center gap-4 text-sm urdu">
    <span class="font-semibold">جامعہ کا مجموعی فیصد:</span>
    <span id="jamia-percent" class="font-bold text-2xl md:text-3xl bg-yellow-400 text-black px-3 py-1 rounded-lg">0</span>
    <span class="font-semibold ml-4">جامعہ کا مجموعی کیفیت:</span>
    <span id="jamia-grade" class="font-bold text-xl md:text-2xl px-3 py-1 rounded-lg bg-emerald-500">-</span>

    <!-- NEW: total classes & books -->
    <span class="font-semibold ml-4">کل کلاسیں:</span>
    <span id="total-classes" class="font-bold text-lg bg-white/10 px-2 py-0.5 rounded">0</span>
    <span class="font-semibold ml-2">کل کتابیں:</span>
    <span id="total-books" class="font-bold text-lg bg-white/10 px-2 py-0.5 rounded">0</span>
  </div>

  <!-- Info -->
  <div class="bg-white rounded-xl shadow p-3 md:p-4 text-sm text-gray-700 urdu leading-relaxed">
    <p class="mb-1">
      ہر کلاس کے لیے جتنی ضرورت ہو اتنی کتابیں شامل کریں، ہر کتاب میں زیادہ سے زیادہ
      <span class="font-semibold">۵ سوالات</span> درج کریں (کم ہوں تو باقی خانے خالی چھوڑ دیں)۔
    </p>
    <p>
      ہر کتاب کا فیصد: ہر سوال میں درست جواب دینے والے طلبہ کی اوسط مقدار / <span class="font-semibold">حاضر طلبہ</span> × 100  
      پھر تمام کتابوں کے فیصد کا اوسط لے کر اس کلاس کا مجموعی فیصد، اور تمام کلاسوں کا اوسط جامعہ کا فیصد بنے گا۔
    </p>
  </div>

  <!-- Form -->
  <form id="jaiza-form" class="space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-base md:text-lg font-semibold urdu">کلاس وار جائزہ</h2>
      <button type="button" id="add-class-btn"
              class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm urdu">
        + نئی کلاس شامل کریں
      </button>
    </div>

    <div id="classes-container" class="space-y-4"></div>

    <div class="bg-white rounded-xl shadow px-3 md:px-4 py-3 flex justify-end gap-2">
      <!-- NEW: Update / Edit button -->
      <button type="button"
              id="enable-edit-btn"
              class="px-4 md:px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm urdu font-semibold">
        اپ ڈیٹ / تدوین
      </button>

      <button type="submit"
              class="px-4 md:px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm urdu font-semibold">
        جائزہ محفوظ کریں
      </button>
    </div>
  </form>
</div>

<script type="module">
/*************** Firebase setup ***************/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  addDoc,
  deleteDoc,
  getDoc,
  doc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
  authDomain: "data-f15ab.firebaseapp.com",
  projectId: "data-f15ab",
  storageBucket: "data-f15ab.appspot.com",
  messagingSenderId: "449137002393",
  appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
  measurementId: "G-1PHNJQWNPZ",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/*************** DOM refs ***************/
const loader           = document.getElementById("loader");
const subtitle         = document.getElementById("subtitle");
const errorBox         = document.getElementById("error-box");
const successBox       = document.getElementById("success-box");
const jamiaPercEl      = document.getElementById("jamia-percent");
const jamiaGradeEl     = document.getElementById("jamia-grade");
const totalClassesEl   = document.getElementById("total-classes");
const totalBooksEl     = document.getElementById("total-books");
const classesContainer = document.getElementById("classes-container");
const addClassBtn      = document.getElementById("add-class-btn");
const formEl           = document.getElementById("jaiza-form");
const enableEditBtn    = document.getElementById("enable-edit-btn");

const showLoader = (v) => loader.classList.toggle("hidden", !v);
const showError  = (msg) => { errorBox.textContent = msg; errorBox.classList.remove("hidden"); };
const clearError = () => errorBox.classList.add("hidden");
const showSuccess= (msg) => { successBox.textContent = msg; successBox.classList.remove("hidden"); };
const clearSuccess = () => successBox.classList.add("hidden");

/*************** URL params ***************/
const params   = new URLSearchParams(window.location.search);
const jamiaId  = params.get("jamia");
const monthKey = params.get("month");

if (!jamiaId || !monthKey) {
  showError("URL میں جامعہ اور مہینہ دونوں کا ہونا ضروری ہے، مثلاً ?jamia=Latoor&month=2025-11");
} else {
  subtitle.textContent = `جامعہ: ${decodeURIComponent(jamiaId)} • مہینہ: ${monthKey}`;
}

let currentUser = null;
let classCount  = 0;

// className -> [{teacherName, bookName}, ...]
let teachingMap = {};
let classList   = [];

// NEW: edit mode state (default editable; existing data pe read-only)
let isEditMode = true;

/*************** Edit mode toggle helper ***************/
const toggleEditMode = (editable) => {
  isEditMode = editable;

  // saare input/select/textarea disable/enable
  const fields = classesContainer.querySelectorAll("input, select, textarea");
  fields.forEach(el => {
    el.disabled = !editable;
  });

  // book/class add/remove buttons
  const actionBtns = classesContainer.querySelectorAll(".add-book-btn, .remove-book-btn, .remove-class-btn");
  actionBtns.forEach(btn => {
    btn.disabled = !editable;
  });

  if (addClassBtn) addClassBtn.disabled = !editable;

  const submitBtn = formEl.querySelector('button[type="submit"]');
  if (submitBtn) submitBtn.disabled = !editable;
};

/*************** Helpers ***************/
const getGrade = (p) => {
  if (p >= 80) return "ممتاز";
  if (p >= 60) return "بہتر";
  if (p >= 40) return "مناسب";
  if (p > 0)   return "کمزور";
  return "-";
};

const getMonthInfoFromKey = (key) => {
  if (!key) return null;
  const [yStr, mStr] = key.split("-");
  const yearNum  = parseInt(yStr);
  const monthNum = parseInt(mStr) - 1;
  if (isNaN(yearNum) || isNaN(monthNum)) return null;

  const academicYear = monthNum >= 3 ? `${yearNum}-${yearNum+1}` : `${yearNum-1}-${yearNum}`;
  return { yearNum, monthNum, academicYear };
};

/*************** Load teaching structure ***************/
const loadTeachingStructure = async (user) => {
  teachingMap = {};
  classList   = [];

  const info = getMonthInfoFromKey(monthKey);
  if (!info) {
    showError("مہینے کا فارمیٹ درست نہیں (YYYY-MM).");
    return;
  }
  const { academicYear } = info;

  try {
    // users collection se academicYears + karkardagiStructure lena
    const userDocRef  = doc(db, "users", user.uid);
    const userDocSnap = await getDoc(userDocRef);

    if (!userDocSnap.exists()) {
      showError("یوزر پروفائل نہیں ملا، پہلے کارکردگی والا سیٹ اپ مکمل کریں۔");
      return;
    }

    const userData     = userDocSnap.data() || {};
    const years        = userData.academicYears || {};
    const yearData     = years[academicYear];

    if (!yearData || !Array.isArray(yearData.karkardagiStructure)) {
      showError("اس تعلیمی سال کے لیے کارکردگی کا سیٹ اپ نہیں ملا، پہلے Karkardagi Setup مکمل کریں۔");
      return;
    }

    const jamiaName = decodeURIComponent(jamiaId || "");

    // Sirf current jamia ka structure use karna
    const jamiaStruct = yearData.karkardagiStructure.find(j => j.jamiaName === jamiaName);

    if (!jamiaStruct || !Array.isArray(jamiaStruct.teachers)) {
      showError("اس جامعہ کے لیے کارکردگی سیٹ اپ خالی ہے، اس لیے کلاس/استاذ/کتاب نہیں مل رہیں۔");
      return;
    }

    // teacher + unke periods (class + book) ko map me daalna
    (jamiaStruct.teachers || []).forEach(t => {
      const teacherName = t.name || t.teacherName || t.ustad || "";
      (t.periods || []).forEach(p => {
        const className = p.className || p.class || p.darja || "";
        const bookName  = p.bookName  || p.book  || p.kitab || p.subject || "";
        if (!className || !teacherName || !bookName) return;

        if (!teachingMap[className]) teachingMap[className] = [];
        teachingMap[className].push({ teacherName, bookName });
      });
    });

    classList = Object.keys(teachingMap).sort();

    if (!classList.length) {
      showError("اس جامعہ کے لیے کسی بھی کلاس / کتاب کا پیریڈ سیٹ نہیں کیا گیا، اس لیے dropdown خالی ہیں۔");
    }

  } catch (err) {
    console.error(err);
    showError("کارکردگی سیٹ اپ لوڈ کرتے وقت مسئلہ آیا، بعد میں دوبارہ کوشش کریں۔");
  }
};

/*************** Book % from its 5 questions (uses حاضر طلبہ) ***************/
const recalcSingleBookPercent = (bookCard, card) => {
  const presentStudents = Number(card.querySelector(".present-students")?.value || 0);
  const qRows = bookCard.querySelectorAll(".question-row");
  let sum = 0, count = 0;
  qRows.forEach(row => {
    const corr = Number(row.querySelector(".q-correct")?.value || 0);
    if (corr > 0) {
      sum += corr;
      count++;
    }
  });

  const percEl = bookCard.querySelector(".book-percent");
  if (!presentStudents || !count) {
    percEl.value = "";
    return null;
  }
  const avgCorrect = sum / count;
  const percentage = (avgCorrect / presentStudents) * 100;
  const rounded    = Math.round(percentage * 10) / 10;
  percEl.value     = rounded.toFixed(1) + "%";
  return rounded;
};

/*************** Class % from all book % ***************/
const recalcClassPercent = (card) => {
  const books = card.querySelectorAll(".book-card");
  const percs = [];
  books.forEach(b => {
    const pStr = b.querySelector(".book-percent")?.value;
    if (!pStr) return;
    const num = Number(pStr.replace("%","").trim());
    if (!isNaN(num)) percs.push(num);
  });

  const classPercInput  = card.querySelector(".class-percent");
  const classGradeInput = card.querySelector(".class-grade");

  if (!percs.length) {
    classPercInput.value  = "";
    classGradeInput.value = "-";
    return;
  }

  const sum = percs.reduce((a,b)=>a+b,0);
  const avg = Math.round((sum/percs.length)*10)/10;
  classPercInput.value  = avg.toFixed(1) + "%";
  classGradeInput.value = getGrade(avg);
};

/*************** Jamia overall % + total classes/books ***************/
const recalcJamia = () => {
  const cards = classesContainer.querySelectorAll(".class-card");
  const percs = [];
  let totalClasses = 0;
  let totalBooks   = 0;

  cards.forEach(card => {
    const bookCards = card.querySelectorAll(".book-card");
    let anyBookHasData = false;

    bookCards.forEach(b => {
      const teacherVal = (b.querySelector(".book-teacher")?.value || "").trim();
      const bookVal    = (b.querySelector(".book-name")?.value || "").trim();
      const percVal    = (b.querySelector(".book-percent")?.value || "").trim();
      if (teacherVal || bookVal || percVal) {
        anyBookHasData = true;
        totalBooks++;
      }
    });

    if (anyBookHasData) {
      totalClasses++;
      const pStr = card.querySelector(".class-percent")?.value;
      if (pStr) {
        const num = Number(pStr.replace("%","").trim());
        if (!isNaN(num)) percs.push(num);
      }
    }
  });

  if (totalClassesEl) totalClassesEl.textContent = String(totalClasses);
  if (totalBooksEl)   totalBooksEl.textContent   = String(totalBooks);

  if (!percs.length) {
    jamiaPercEl.textContent  = "0";
    jamiaGradeEl.textContent = "-";
    return;
  }

  const sum = percs.reduce((a,b)=>a+b,0);
  const avg = Math.round((sum/percs.length)*100)/100;
  jamiaPercEl.textContent  = avg.toFixed(2);
  jamiaGradeEl.textContent = getGrade(avg);
};

/*************** ONE book card ***************/
const createBookCard = (card) => {
  const classSelect         = card.querySelector(".class-select");
  const totalStudentsInput  = card.querySelector(".total-students");
  const presentStudentsInput= card.querySelector(".present-students");

  const bookCard = document.createElement("div");
  bookCard.className = "book-card border rounded-lg p-2 md:p-3 bg-slate-50 space-y-2";

  bookCard.innerHTML = `
    <div class="flex flex-wrap items-center gap-2 md:gap-3">
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">استاذ</label>
        <select class="w-full border rounded px-2 py-1.5 urdu text-xs md:text-sm book-teacher">
          <option value="">استاذ منتخب کریں</option>
        </select>
      </div>
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کتاب / پیریڈ</label>
        <select class="w-full border rounded px-2 py-1.5 urdu text-xs md:text-sm book-name">
          <option value="">کتاب منتخب کریں</option>
        </select>
      </div>
      <button type="button"
        class="px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs md:text-sm urdu remove-book-btn">
        × کتاب ہٹائیں
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-xs md:text-sm text-right mt-2">
        <thead class="bg-emerald-100">
          <tr>
            <th class="px-2 py-1 urdu">#</th>
            <th class="px-2 py-1 urdu">سوال</th>
            <th class="px-2 py-1 urdu">درست جواب دینے والے طلبہ</th>
          </tr>
        </thead>
        <tbody>
          ${[1,2,3,4,5].map(i=>`
            <tr class="question-row">
              <td class="px-2 py-1 text-center">${i}</td>
              <td class="px-2 py-1">
                <input type="text"
                       class="w-40 md:w-64 border rounded px-1.5 py-1 urdu text-xs md:text-sm q-text"
                       placeholder="سوال ${i}">
              </td>
              <td class="px-2 py-1">
                <input type="number" min="0"
                       class="w-20 border rounded px-1.5 py-1 text-center text-xs md:text-sm q-correct">
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2 text-xs md:text-sm urdu">
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-sabaq-sunana">
        <span>سبق سننا</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-sabaq-parhana">
        <span>سبق پڑھانا</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-waqt-istemal">
        <span>وائٹ بورڈ کا استعمال</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-tiyari">
        <span>پیشگی تیاری کرنے والے</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-takrar">
        <span>تکرار کرانے والے</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-nizam">
        <span>درجہ کا نظم و نسق</span>
      </label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2 items-start">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">% (اس کتاب کا)</label>
        <input type="text" readonly
               class="w-full border rounded px-2 py-1.5 text-center text-sm md:text-base bg-yellow-50 book-percent">
      </div>
      <div class="md:col-span-2">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کمزوریاں / نوٹس</label>
        <textarea rows="2"
                  class="w-full border rounded px-2 py-1.5 text-xs md:text-sm urdu weakness"></textarea>
      </div>
    </div>
  `;

  const teacherSelect = bookCard.querySelector(".book-teacher");
  const bookSelect    = bookCard.querySelector(".book-name");

  const fillTeachersForClass = () => {
    const cls = classSelect.value;
    teacherSelect.innerHTML = '<option value="">استاذ منتخب کریں</option>';
    bookSelect.innerHTML    = '<option value="">کتاب منتخب کریں</option>';
    if (!cls || !teachingMap[cls]) return;
    const teacherSet = new Set(teachingMap[cls].map(r=>r.teacherName));
    teacherSet.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      teacherSelect.appendChild(opt);
    });
  };

  const fillBooksForTeacher = () => {
    const cls   = classSelect.value;
    const tName = teacherSelect.value;
    bookSelect.innerHTML = '<option value="">کتاب منتخب کریں</option>';
    if (!cls || !teachingMap[cls] || !tName) return;
    const recs    = teachingMap[cls].filter(r=>r.teacherName===tName);
    const bookSet = new Set(recs.map(r=>r.bookName));
    bookSet.forEach(b => {
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      bookSelect.appendChild(opt);
    });
  };

  teacherSelect.addEventListener("change", fillBooksForTeacher);
  classSelect.addEventListener("change", fillTeachersForClass);

  const triggerBookCalc = () => {
    recalcSingleBookPercent(bookCard, card);
    recalcClassPercent(card);
    recalcJamia();
  };

  const qInputs = bookCard.querySelectorAll(".q-correct");
  qInputs.forEach(inp => {
    inp.addEventListener("input", triggerBookCalc);
  });

  if (presentStudentsInput) {
    presentStudentsInput.addEventListener("input", () => {
      const books = card.querySelectorAll(".book-card");
      books.forEach(b => recalcSingleBookPercent(b, card));
      recalcClassPercent(card);
      recalcJamia();
    });
  }

  if (totalStudentsInput) {
    totalStudentsInput.addEventListener("input", () => {
      const books = card.querySelectorAll(".book-card");
      books.forEach(b => recalcSingleBookPercent(b, card));
      recalcClassPercent(card);
      recalcJamia();
    });
  }

  bookCard.querySelector(".remove-book-btn").addEventListener("click", () => {
    bookCard.remove();
    recalcClassPercent(card);
    recalcJamia();
  });

  // pehle se class select ki value ho to uske hisaab se teachers fill karein
  fillTeachersForClass();
  return bookCard;
};

/*************** Class card create ***************/
const createClassCard = () => {
  classCount += 1;
  const card = document.createElement("div");
  card.className = "bg-white rounded-xl shadow p-3 md:p-4 space-y-3 class-card";
  card.dataset.index = classCount;

  card.innerHTML = `
    <div class="flex flex-wrap items-center gap-2 md:gap-3 border-b pb-2">
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کلاس</label>
        <select class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu class-select">
          <option value="">کلاس منتخب کریں</option>
        </select>
      </div>
      <button type="button"
        class="px-3 py-1.5 rounded-lg bg-red-500 hover:bg-red-600 text-white text-xs md:text-sm urdu remove-class-btn">
        × کلاس ہٹا دیں
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-3 mt-2">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کل طلبہ</label>
        <input type="number" min="1"
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base total-students"
               placeholder="مثال: 30">
      </div>
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">حاضر طلبہ</label>
        <input type="number" min="0"
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base present-students"
               placeholder="مثال: 25">
      </div>
      <div class="flex items-end justify-end">
        <button type="button"
                class="add-book-btn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs md:text-sm urdu">
          + نئی کتاب شامل کریں
        </button>
      </div>
    </div>

    <div class="book-list space-y-3 mt-2"></div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-3 pt-2 border-t mt-1">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">
          اس کلاس کا مجموعی فیصد
        </label>
        <input type="text" readonly
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base bg-yellow-50 class-percent">
      </div>
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">درجہ کیفیت</label>
        <input type="text" readonly
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base bg-emerald-50 class-grade urdu">
      </div>
      <div class="space-y-1">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">کمزوریاں اور مسائل</label>
        <textarea rows="2"
                  class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu issues"></textarea>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1 mt-1">حل اور تجاویز</label>
        <textarea rows="2"
                  class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu suggestions"></textarea>
      </div>
    </div>
  `;

  const classSelect         = card.querySelector(".class-select");
  const removeBtn           = card.querySelector(".remove-class-btn");
  const addBookBtn          = card.querySelector(".add-book-btn");
  const bookList            = card.querySelector(".book-list");

  // fill class dropdown
  classSelect.innerHTML = '<option value="">کلاس منتخب کریں</option>';
  classList.forEach(cls => {
    const opt = document.createElement("option");
    opt.value = cls;
    opt.textContent = cls;
    classSelect.appendChild(opt);
  });

  removeBtn.addEventListener("click", () => {
    card.remove();
    recalcJamia();
  });

  const addBook = () => {
    const bCard = createBookCard(card);
    bookList.appendChild(bCard);
  };
  addBookBtn.addEventListener("click", addBook);

  // default: 1 kitab
  addBook();

  return card;
};

const addNewClassCard = () => {
  const card = createClassCard();
  classesContainer.appendChild(card);
};

/*************** NAYA: pehle se saved Jaiza ko load karke pre-fill kare ***************/
const loadExistingJaizaForms = async (user) => {
  if (!jamiaId || !monthKey) return;

  const qRef = query(
    collection(db,"jaiza_forms"),
    where("jamiaId","==",jamiaId),
    where("monthKey","==",monthKey),
    where("createdBy","==",user.uid)
  );
  const snap = await getDocs(qRef);

  // Agar koi data nahi mila to blank form (editable)
  if (snap.empty) {
    classesContainer.innerHTML = "";
    classCount = 0;
    addNewClassCard();
    recalcJamia();
    // naya form already editable, isliye update button ki zarurat nahi
    if (enableEditBtn) enableEditBtn.disabled = true;
    return;
  }

  // Pura container clear, phir docs ke hisaab se cards create
  classesContainer.innerHTML = "";
  classCount = 0;

  const docs = [];
  snap.forEach(d => docs.push({ id: d.id, ...d.data() }));

  docs.forEach(d => {
    const card = createClassCard();
    classesContainer.appendChild(card);

    const classSelect         = card.querySelector(".class-select");
    const totalStudentsInput  = card.querySelector(".total-students");
    const presentStudentsInput= card.querySelector(".present-students");
    const issuesInput         = card.querySelector(".issues");
    const suggestionsInput    = card.querySelector(".suggestions");
    const classPercentInput   = card.querySelector(".class-percent");
    const classGradeInput     = card.querySelector(".class-grade");
    const bookListDiv         = card.querySelector(".book-list");

    // ensure class option exists
    const cName = d.className || "";
    if (cName) {
      let exists = false;
      Array.from(classSelect.options).forEach(o => {
        if (o.value === cName) exists = true;
      });
      if (!exists) {
        const opt = document.createElement("option");
        opt.value = cName;
        opt.textContent = cName;
        classSelect.appendChild(opt);
      }
      classSelect.value = cName;
      classSelect.dispatchEvent(new Event("change"));
    }

    totalStudentsInput.value   = d.totalStudents ?? "";
    presentStudentsInput.value = d.presentStudents ?? "";
    issuesInput.value          = d.issues || "";
    suggestionsInput.value     = d.suggestions || "";

    // purani default book card hatao, phir saved books ke hisaab se banao
    bookListDiv.innerHTML = "";

    const books = Array.isArray(d.books) ? d.books : [];
    books.forEach(b => {
      const bookCard = createBookCard(card);
      bookListDiv.appendChild(bookCard);

      const teacherSelect = bookCard.querySelector(".book-teacher");
      const bookSelect    = bookCard.querySelector(".book-name");
      const weaknessTa    = bookCard.querySelector(".weakness");
      const bookPercInput = bookCard.querySelector(".book-percent");

      // teacherOptions ensure
      if (cName) {
        const teacherSet = teachingMap[cName] ? new Set(teachingMap[cName].map(r=>r.teacherName)) : new Set();
        if (b.teacherName && !teacherSet.has(b.teacherName)) {
          const opt = document.createElement("option");
          opt.value = b.teacherName;
          opt.textContent = b.teacherName;
          teacherSelect.appendChild(opt);
        }
      }

      teacherSelect.value = b.teacherName || "";
      teacherSelect.dispatchEvent(new Event("change"));

      if (b.bookName) {
        let existsBook = false;
        Array.from(bookSelect.options).forEach(o => {
          if (o.value === b.bookName) existsBook = true;
        });
        if (!existsBook) {
          const opt = document.createElement("option");
          opt.value = b.bookName;
          opt.textContent = b.bookName;
          bookSelect.appendChild(opt);
        }
        bookSelect.value = b.bookName;
      }

      weaknessTa.value = b.weakness || "";

      // questions fill
      const qRows = bookCard.querySelectorAll(".question-row");
      const questions = Array.isArray(b.questions) ? b.questions : [];
      questions.forEach(q => {
        const idx = (q.index || 1) - 1;
        if (!qRows[idx]) return;
        const row = qRows[idx];
        row.querySelector(".q-text").value    = q.text || "";
        row.querySelector(".q-correct").value = q.correctStudents ?? "";
      });

      // checks
      const checks = b.checks || {};
      bookCard.querySelector(".chk-sabaq-sunana").checked  = !!checks.sabaqSunana;
      bookCard.querySelector(".chk-sabaq-parhana").checked = !!checks.sabaqParhana;
      bookCard.querySelector(".chk-waqt-istemal").checked  = !!checks.waqtIstemal;
      bookCard.querySelector(".chk-tiyari").checked        = !!checks.tiyari;
      bookCard.querySelector(".chk-takrar").checked        = !!checks.takrar;
      bookCard.querySelector(".chk-nizam").checked         = !!checks.nizam;

      // stored percentage (agar hai) else recalc
      if (typeof b.percentage === "number") {
        bookPercInput.value = b.percentage.toFixed(1) + "%";
      } else {
        recalcSingleBookPercent(bookCard, card);
      }
    });

    // class % / grade
    if (typeof d.classPercentage === "number") {
      classPercentInput.value = d.classPercentage.toFixed(1) + "%";
      classGradeInput.value   = d.grade || getGrade(d.classPercentage);
    } else {
      recalcClassPercent(card);
    }
  });

  // jamia ka overall
  recalcJamia();

  // existing data: start in read-only mode, update button enabled
  if (docs.length && enableEditBtn) {
    toggleEditMode(false);
    enableEditBtn.disabled = false;
  }
};

/*************** Auth & initial load ***************/
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    showError("لاگ اِن ضروری ہے، پہلے ڈیش بورڈ سے لاگ اِن کریں۔");
    return;
  }
  currentUser = user;

  showLoader(true);
  try {
    // pehle teaching structure, phir saved jaiza
    await loadTeachingStructure(user);
    await loadExistingJaizaForms(user);
  } catch(err) {
    console.error(err);
    // fallback: at least ek blank class
    classesContainer.innerHTML = "";
    classCount = 0;
    addNewClassCard();
  } finally {
    showLoader(false);
  }
});

addClassBtn.addEventListener("click", () => addNewClassCard());

/*************** Update button → enable editing ***************/
if (enableEditBtn) {
  enableEditBtn.addEventListener("click", () => {
    toggleEditMode(true);
    // ek baar edit on karne ke baad is button ko disable kar dete hain
    enableEditBtn.disabled = true;
  });
}

/*************** Submit → save in Firestore ***************/
formEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  clearError();
  clearSuccess();

  if (!currentUser) {
    showError("لاگ اِن نہیں ملا، براہ کرم دوبارہ ڈیش بورڈ سے آئیں۔");
    return;
  }
  if (!jamiaId || !monthKey) {
    showError("جامعہ یا مہینہ URL میں موجود نہیں، لنک چیک کریں۔");
    return;
  }

  const cards = Array.from(classesContainer.querySelectorAll(".class-card"));
  if (!cards.length) {
    showError("کم از کم ایک کلاس شامل کریں۔");
    return;
  }

  const payloads = [];

  cards.forEach(card => {
    const className       = card.querySelector(".class-select").value.trim();
    const totalStudents   = Number(card.querySelector(".total-students")?.value || 0);
    const presentStudents = Number(card.querySelector(".present-students")?.value || 0);

    const classPercentStr = card.querySelector(".class-percent")?.value || "";
    let classPercentage = null;
    if (classPercentStr) {
      const v = Number(classPercentStr.replace("%","").trim());
      if (!isNaN(v)) classPercentage = v;
    }

    const issues      = card.querySelector(".issues").value.trim();
    const suggestions = card.querySelector(".suggestions").value.trim();

    const books = [];
    const bookCards = card.querySelectorAll(".book-card");
    bookCards.forEach(bCard => {
      const teacherName = bCard.querySelector(".book-teacher").value.trim();
      const bookName    = bCard.querySelector(".book-name").value.trim();
      const weakness    = bCard.querySelector(".weakness").value.trim();
      const percStr     = bCard.querySelector(".book-percent").value;

      const qRows = bCard.querySelectorAll(".question-row");
      const questions = [];
      qRows.forEach((row, idx) => {
        const text = row.querySelector(".q-text").value.trim();
        const corr = Number(row.querySelector(".q-correct").value || 0);
        if (!text && !corr) return;
        questions.push({
          index: idx+1,
          text,
          correctStudents: corr
        });
      });

      const checks = {
        sabaqSunana:  bCard.querySelector(".chk-sabaq-sunana")?.checked || false,
        sabaqParhana: bCard.querySelector(".chk-sabaq-parhana")?.checked || false,
        waqtIstemal:  bCard.querySelector(".chk-waqt-istemal")?.checked || false,
        tiyari:       bCard.querySelector(".chk-tiyari")?.checked || false,
        takrar:       bCard.querySelector(".chk-takrar")?.checked || false,
        nizam:        bCard.querySelector(".chk-nizam")?.checked || false,
      };

      let percentage = null;
      if (percStr) {
        const v = Number(percStr.replace("%","").trim());
        if (!isNaN(v)) percentage = v;
      }

      const allEmptyBook =
        !teacherName && !bookName && !questions.length &&
        !weakness && !percentage &&
        !checks.sabaqSunana && !checks.sabaqParhana && !checks.waqtIstemal &&
        !checks.tiyari && !checks.takrar && !checks.nizam;

      if (allEmptyBook) return;

      books.push({
        teacherName,
        bookName,
        questions,
        percentage,
        weakness,
        checks
      });
    });

    const allEmptyClass =
      !className && !totalStudents && !presentStudents && !books.length && !issues && !suggestions;

    if (allEmptyClass) return;

    payloads.push({
      jamiaId,
      monthKey,
      className,
      totalStudents,
      presentStudents,
      classPercentage,
      grade: classPercentage != null ? getGrade(classPercentage) : "-",
      books,
      issues,
      suggestions,
      createdBy: currentUser.uid,
      createdAt: serverTimestamp()
    });
  });

  if (!payloads.length) {
    showError("کم از کم ایک کلاس میں کچھ ڈیٹا ضرور بھریں۔");
    return;
  }

  showLoader(true);
  try {
    // pehle purane is mahine ke jaiza forms delete
    const qRef = query(
      collection(db,"jaiza_forms"),
      where("jamiaId","==",jamiaId),
      where("monthKey","==",monthKey),
      where("createdBy","==",currentUser.uid)
    );
    const oldSnap = await getDocs(qRef);
    const delPromises = [];
    oldSnap.forEach(d => delPromises.push(deleteDoc(d.ref)));
    await Promise.all(delPromises);

    // phir naya data add
    const addPromises = payloads.map(p => addDoc(collection(db,"jaiza_forms"), p));
    await Promise.all(addPromises);

    showSuccess("تعلیمی جائزہ کامیابی کے ساتھ محفوظ ہو گیا۔");
  } catch(err) {
    console.error(err);
    showError("ڈیٹا محفوظ کرتے وقت مسئلہ آیا، بعد میں دوبارہ کوشش کریں۔");
  } finally {
    showLoader(false);
  }
});
</script>

</body>
</html>
