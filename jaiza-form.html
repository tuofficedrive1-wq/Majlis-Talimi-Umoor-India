<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ¹Ù„ÛŒÙ…ÛŒ Ø¬Ø§Ø¦Ø²Û ÙØ§Ø±Ù… (Ú©Ù„Ø§Ø³ ÙˆØ§Ø±)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @font-face {
      font-family: 'Jameel Noori Nastaleeq';
      src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
      font-display: swap;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #e5edf5;
      font-size: 14px; /* overall text bigger */
    }
    .urdu {
      font-family: 'Jameel Noori Nastaleeq', system-ui, sans-serif;
    }
    input, select, textarea, button {
      font-size: 13px !important;  /* form text bigger on mobile + desktop */
    }
    ::placeholder {
      font-size: 12px;
    }
  </style>
</head>
<body class="min-h-screen p-3 md:p-6">

<!-- Loader -->
<div id="loader" class="fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center hidden z-50">
  <div class="w-10 h-10 border-4 border-gray-200 border-t-teal-500 rounded-full animate-spin"></div>
</div>

<div class="max-w-6xl mx-auto space-y-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold urdu">ØªØ¹Ù„ÛŒÙ…ÛŒ Ø¬Ø§Ø¦Ø²Û ÙØ§Ø±Ù…</h1>
      <p id="subtitle" class="text-sm md:text-base text-gray-600 mt-1"></p>
    </div>
    <a href="index.html"
       id="dashboard-back-btn"
       class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm md:text-base bg-white shadow border border-gray-200 hover:bg-gray-50">
      â† ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ
</a>
  </div>
 
  <!-- Alerts -->
  <div id="error-box" class="hidden p-3 rounded-lg bg-red-100 text-red-700 text-sm urdu"></div>
  <div id="success-box" class="hidden p-3 rounded-lg bg-emerald-100 text-emerald-700 text-sm urdu"></div>

  <!-- Jamia overall summary -->
  <div class="bg-sky-900 text-white rounded-xl shadow px-4 py-3 flex flex-wrap items-center gap-4 text-sm urdu">
    <span class="font-semibold">Ø¬Ø§Ù…Ø¹Û Ú©Ø§ Ù…Ø¬Ù…ÙˆØ¹ÛŒ ÙÛŒØµØ¯:</span>
    <span id="jamia-percent" class="font-bold text-2xl md:text-3xl bg-yellow-400 text-black px-3 py-1 rounded-lg">0</span>
    <span class="font-semibold ml-4">Ø¬Ø§Ù…Ø¹Û Ú©Ø§ Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ú©ÛŒÙÛŒØª:</span>
    <span id="jamia-grade" class="font-bold text-xl md:text-2xl px-3 py-1 rounded-lg bg-emerald-500">-</span>

    <!-- NEW: total classes & books -->
    <span class="font-semibold ml-4">Ú©Ù„ Ú©Ù„Ø§Ø³ÛŒÚº:</span>
    <span id="total-classes" class="font-bold text-lg bg-white/10 px-2 py-0.5 rounded">0</span>
    <span class="font-semibold ml-2">Ú©Ù„ Ú©ØªØ§Ø¨ÛŒÚº:</span>
    <span id="total-books" class="font-bold text-lg bg-white/10 px-2 py-0.5 rounded">0</span>
  </div>

  <!-- Info -->
  <div class="bg-white rounded-xl shadow p-3 md:p-4 text-sm text-gray-700 urdu leading-relaxed">
    <p class="mb-1">
      ÛØ± Ú©Ù„Ø§Ø³ Ú©Û’ Ù„ÛŒÛ’ Ø¬ØªÙ†ÛŒ Ø¶Ø±ÙˆØ±Øª ÛÙˆ Ø§ØªÙ†ÛŒ Ú©ØªØ§Ø¨ÛŒÚº Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚºØŒ ÛØ± Ú©ØªØ§Ø¨ Ù…ÛŒÚº Ø²ÛŒØ§Ø¯Û Ø³Û’ Ø²ÛŒØ§Ø¯Û
      <span class="font-semibold">Ûµ Ø³ÙˆØ§Ù„Ø§Øª</span> Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº (Ú©Ù… ÛÙˆÚº ØªÙˆ Ø¨Ø§Ù‚ÛŒ Ø®Ø§Ù†Û’ Ø®Ø§Ù„ÛŒ Ú†Ú¾ÙˆÚ‘ Ø¯ÛŒÚº)Û”
    </p>
    <p>
      ÛØ± Ú©ØªØ§Ø¨ Ú©Ø§ ÙÛŒØµØ¯: ÛØ± Ø³ÙˆØ§Ù„ Ù…ÛŒÚº Ø¯Ø±Ø³Øª Ø¬ÙˆØ§Ø¨ Ø¯ÛŒÙ†Û’ ÙˆØ§Ù„Û’ Ø·Ù„Ø¨Û Ú©ÛŒ Ø§ÙˆØ³Ø· Ù…Ù‚Ø¯Ø§Ø± / <span class="font-semibold">Ø­Ø§Ø¶Ø± Ø·Ù„Ø¨Û</span> Ã— 100  
      Ù¾Ú¾Ø± ØªÙ…Ø§Ù… Ú©ØªØ§Ø¨ÙˆÚº Ú©Û’ ÙÛŒØµØ¯ Ú©Ø§ Ø§ÙˆØ³Ø· Ù„Û’ Ú©Ø± Ø§Ø³ Ú©Ù„Ø§Ø³ Ú©Ø§ Ù…Ø¬Ù…ÙˆØ¹ÛŒ ÙÛŒØµØ¯ØŒ Ø§ÙˆØ± ØªÙ…Ø§Ù… Ú©Ù„Ø§Ø³ÙˆÚº Ú©Ø§ Ø§ÙˆØ³Ø· Ø¬Ø§Ù…Ø¹Û Ú©Ø§ ÙÛŒØµØ¯ Ø¨Ù†Û’ Ú¯Ø§Û”
    </p>
  </div>

  <!-- Form -->
  <form id="jaiza-form" class="space-y-4" novalidate>
    <div class="flex justify-between items-center">
      <h2 class="text-base md:text-lg font-semibold urdu">Ú©Ù„Ø§Ø³ ÙˆØ§Ø± Ø¬Ø§Ø¦Ø²Û</h2>
      <button type="button" id="add-class-btn"
              class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm urdu">
        + Ù†Ø¦ÛŒ Ú©Ù„Ø§Ø³ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº
      </button>
    </div>

    <div id="classes-container" class="space-y-4"></div>

    <div class="bg-white rounded-xl shadow px-3 md:px-4 py-3 flex justify-end gap-2">
      <!-- NEW: Update / Edit button -->
      <button type="button"
              id="enable-edit-btn"
              class="px-4 md:px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm urdu font-semibold">
        Ø§Ù¾ ÚˆÛŒÙ¹ / ØªØ¯ÙˆÛŒÙ†
      </button>

      <button type="submit"
              class="px-4 md:px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm urdu font-semibold">
        Ø¬Ø§Ø¦Ø²Û Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº
      </button>
    </div>
  </form>
</div>

<script type="module">
/*************** Firebase setup ***************/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
  getFirestore, collection, query, where, getDocs, addDoc, deleteDoc, 
  getDoc, doc, updateDoc, serverTimestamp // updateDoc yahan add kiya hai
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
  authDomain: "data-f15ab.firebaseapp.com",
  projectId: "data-f15ab",
  storageBucket: "data-f15ab.appspot.com",
  messagingSenderId: "449137002393",
  appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
  measurementId: "G-1PHNJQWNPZ",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/*************** DOM refs ***************/
const loader           = document.getElementById("loader");
const subtitle         = document.getElementById("subtitle");
const errorBox         = document.getElementById("error-box");
const successBox       = document.getElementById("success-box");
const jamiaPercEl      = document.getElementById("jamia-percent");
const jamiaGradeEl     = document.getElementById("jamia-grade");
const totalClassesEl   = document.getElementById("total-classes");
const totalBooksEl     = document.getElementById("total-books");
const classesContainer = document.getElementById("classes-container");
const addClassBtn      = document.getElementById("add-class-btn");
const formEl           = document.getElementById("jaiza-form");
const enableEditBtn    = document.getElementById("enable-edit-btn");

const showLoader = (v) => loader.classList.toggle("hidden", !v);
const showError  = (msg) => { errorBox.textContent = msg; errorBox.classList.remove("hidden"); };
const clearError = () => errorBox.classList.add("hidden");
const showSuccess= (msg) => { successBox.textContent = msg; successBox.classList.remove("hidden"); };
const clearSuccess = () => successBox.classList.add("hidden");

/*************** URL params ***************/
const params   = new URLSearchParams(window.location.search);
const jamiaId  = params.get("jamia");
const monthKey = params.get("month");

if (!jamiaId || !monthKey) {
  showError("URL Ù…ÛŒÚº Ø¬Ø§Ù…Ø¹Û Ø§ÙˆØ± Ù…ÛÛŒÙ†Û Ø¯ÙˆÙ†ÙˆÚº Ú©Ø§ ÛÙˆÙ†Ø§ Ø¶Ø±ÙˆØ±ÛŒ ÛÛ’ØŒ Ù…Ø«Ù„Ø§Ù‹ ?jamia=Latoor&month=2025-11");
} else {
  subtitle.textContent = `Ø¬Ø§Ù…Ø¹Û: ${decodeURIComponent(jamiaId)} â€¢ Ù…ÛÛŒÙ†Û: ${monthKey}`;
}

let currentUser = null;
let classCount  = 0;
let isFormDirty = false; // Ye track karega ki user ne kuch likha hai ya nahi

// className -> [{teacherName, bookName}, ...]
let teachingMap = {};
let classList   = [];

// NEW: edit mode state (default editable; existing data pe read-only)
let isEditMode = true;

/*************** Edit mode toggle helper ***************/
const toggleEditMode = (editable) => {
  isEditMode = editable;

  // saare input/select/textarea disable/enable
  const fields = classesContainer.querySelectorAll("input, select, textarea");
  fields.forEach(el => {
    el.disabled = !editable;
  });

  // book/class add/remove buttons
  const actionBtns = classesContainer.querySelectorAll(".add-book-btn, .remove-book-btn, .remove-class-btn");
  actionBtns.forEach(btn => {
    btn.disabled = !editable;
  });

  if (addClassBtn) addClassBtn.disabled = !editable;

  const submitBtn = formEl.querySelector('button[type="submit"]');
  if (submitBtn) submitBtn.disabled = !editable;
};

/*************** Helpers ***************/
const getGrade = (p) => {
  if (p >= 80) return "Ù…Ù…ØªØ§Ø²";
  if (p >= 60) return "Ø¨ÛØªØ±";
  if (p >= 40) return "Ù…Ù†Ø§Ø³Ø¨";
  if (p > 0)   return "Ú©Ù…Ø²ÙˆØ±";
  return "-";
};

const getMonthInfoFromKey = (key) => {
  if (!key) return null;
  const [yStr, mStr] = key.split("-");
  const yearNum  = parseInt(yStr);
  const monthNum = parseInt(mStr) - 1;
  if (isNaN(yearNum) || isNaN(monthNum)) return null;

  const academicYear = monthNum >= 3 ? `${yearNum}-${yearNum+1}` : `${yearNum-1}-${yearNum}`;
  return { yearNum, monthNum, academicYear };
};

/*************** Load teaching structure ***************/
const loadTeachingStructure = async (user) => {
  teachingMap = {};
  classList   = [];

  const info = getMonthInfoFromKey(monthKey);
  if (!info) {
    showError("Ù…ÛÛŒÙ†Û’ Ú©Ø§ ÙØ§Ø±Ù…ÛŒÙ¹ Ø¯Ø±Ø³Øª Ù†ÛÛŒÚº (YYYY-MM).");
    return;
  }
  const { academicYear } = info;

  try {
    // users collection se academicYears + karkardagiStructure lena
    const userDocRef  = doc(db, "users", user.uid);
    const userDocSnap = await getDoc(userDocRef);

    if (!userDocSnap.exists()) {
      showError("ÛŒÙˆØ²Ø± Ù¾Ø±ÙˆÙØ§Ø¦Ù„ Ù†ÛÛŒÚº Ù…Ù„Ø§ØŒ Ù¾ÛÙ„Û’ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ ÙˆØ§Ù„Ø§ Ø³ÛŒÙ¹ Ø§Ù¾ Ù…Ú©Ù…Ù„ Ú©Ø±ÛŒÚºÛ”");
      return;
    }

    const userData     = userDocSnap.data() || {};
    const years        = userData.academicYears || {};
    const yearData     = years[academicYear];

    if (!yearData || !Array.isArray(yearData.karkardagiStructure)) {
      showError("Ø§Ø³ ØªØ¹Ù„ÛŒÙ…ÛŒ Ø³Ø§Ù„ Ú©Û’ Ù„ÛŒÛ’ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ú©Ø§ Ø³ÛŒÙ¹ Ø§Ù¾ Ù†ÛÛŒÚº Ù…Ù„Ø§ØŒ Ù¾ÛÙ„Û’ Karkardagi Setup Ù…Ú©Ù…Ù„ Ú©Ø±ÛŒÚºÛ”");
      return;
    }

    const jamiaName = decodeURIComponent(jamiaId || "");

    // Sirf current jamia ka structure use karna
    const jamiaStruct = yearData.karkardagiStructure.find(j => j.jamiaName === jamiaName);

    if (!jamiaStruct || !Array.isArray(jamiaStruct.teachers)) {
      showError("Ø§Ø³ Ø¬Ø§Ù…Ø¹Û Ú©Û’ Ù„ÛŒÛ’ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ø³ÛŒÙ¹ Ø§Ù¾ Ø®Ø§Ù„ÛŒ ÛÛ’ØŒ Ø§Ø³ Ù„ÛŒÛ’ Ú©Ù„Ø§Ø³/Ø§Ø³ØªØ§Ø°/Ú©ØªØ§Ø¨ Ù†ÛÛŒÚº Ù…Ù„ Ø±ÛÛŒÚºÛ”");
      return;
    }

    // teacher + unke periods (class + book) ko map me daalna
    (jamiaStruct.teachers || []).forEach(t => {
      const teacherName = t.name || t.teacherName || t.ustad || "";
      (t.periods || []).forEach(p => {
        const className = p.className || p.class || p.darja || "";
        const bookName  = p.bookName  || p.book  || p.kitab || p.subject || "";
        if (!className || !teacherName || !bookName) return;

        if (!teachingMap[className]) teachingMap[className] = [];
        teachingMap[className].push({ teacherName, bookName });
      });
    });

    classList = Object.keys(teachingMap).sort();

    if (!classList.length) {
      showError("Ø§Ø³ Ø¬Ø§Ù…Ø¹Û Ú©Û’ Ù„ÛŒÛ’ Ú©Ø³ÛŒ Ø¨Ú¾ÛŒ Ú©Ù„Ø§Ø³ / Ú©ØªØ§Ø¨ Ú©Ø§ Ù¾ÛŒØ±ÛŒÚˆ Ø³ÛŒÙ¹ Ù†ÛÛŒÚº Ú©ÛŒØ§ Ú¯ÛŒØ§ØŒ Ø§Ø³ Ù„ÛŒÛ’ dropdown Ø®Ø§Ù„ÛŒ ÛÛŒÚºÛ”");
    }

  } catch (err) {
    console.error(err);
    showError("Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ø³ÛŒÙ¹ Ø§Ù¾ Ù„ÙˆÚˆ Ú©Ø±ØªÛ’ ÙˆÙ‚Øª Ù…Ø³Ø¦Ù„Û Ø¢ÛŒØ§ØŒ Ø¨Ø¹Ø¯ Ù…ÛŒÚº Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”");
  }
};

/*************** Book % from its 5 questions (uses Ø­Ø§Ø¶Ø± Ø·Ù„Ø¨Û) ***************/
const recalcSingleBookPercent = (bookCard, card) => {
  const presentStudents = Number(card.querySelector(".present-students")?.value || 0);
  const qRows = bookCard.querySelectorAll(".question-row");
  let sum = 0;
  let count = 0;

  qRows.forEach(row => {
    const qText = row.querySelector(".q-text")?.value.trim() || "";
    const corr  = Number(row.querySelector(".q-correct")?.value || 0);

    // âœ… sirf woh sawal count karein jo waqai poocha gaya ho
    // (text likha ho), chahe correct 0 ho
    if (qText) {
      sum += corr;   // 0 bhi include hoga
      count++;
    }
  });

  const percEl = bookCard.querySelector(".book-percent");

  // agar koi sawal hi nahi poocha gaya ya presentStudents 0 hai
  if (!presentStudents || !count) {
    percEl.value = "";
    return null;
  }

  const avgCorrect = sum / count;                  // jitne sawal pooche gaye unka avg
  const percentage = (avgCorrect / presentStudents) * 100;
  const rounded    = Math.round(percentage * 10) / 10;
  percEl.value     = rounded.toFixed(1) + "%";
  return rounded;
};

/*************** Class % from all book % ***************/
const recalcClassPercent = (card) => {
  const books = card.querySelectorAll(".book-card");
  const percs = [];
  books.forEach(b => {
    const pStr = b.querySelector(".book-percent")?.value;
    if (!pStr) return;
    const num = Number(pStr.replace("%","").trim());
    if (!isNaN(num)) percs.push(num);
  });

  const classPercInput  = card.querySelector(".class-percent");
  const classGradeInput = card.querySelector(".class-grade");

  if (!percs.length) {
    classPercInput.value  = "";
    classGradeInput.value = "-";
    return;
  }

  const sum = percs.reduce((a,b)=>a+b,0);
  const avg = Math.round((sum/percs.length)*10)/10;
  classPercInput.value  = avg.toFixed(1) + "%";
  classGradeInput.value = getGrade(avg);
};

/*************** Jamia overall % + total classes/books ***************/
const recalcJamia = () => {
  const cards = classesContainer.querySelectorAll(".class-card");
  const percs = [];
  let totalClasses = 0;
  let totalBooks   = 0;

  cards.forEach(card => {
    const bookCards = card.querySelectorAll(".book-card");
    let anyBookHasData = false;

    bookCards.forEach(b => {
      const teacherVal = (b.querySelector(".book-teacher")?.value || "").trim();
      const bookVal    = (b.querySelector(".book-name")?.value || "").trim();
      const percVal    = (b.querySelector(".book-percent")?.value || "").trim();
      if (teacherVal || bookVal || percVal) {
        anyBookHasData = true;
        totalBooks++;
      }
    });

    if (anyBookHasData) {
      totalClasses++;
      const pStr = card.querySelector(".class-percent")?.value;
      if (pStr) {
        const num = Number(pStr.replace("%","").trim());
        if (!isNaN(num)) percs.push(num);
      }
    }
  });

  if (totalClassesEl) totalClassesEl.textContent = String(totalClasses);
  if (totalBooksEl)   totalBooksEl.textContent   = String(totalBooks);

  if (!percs.length) {
    jamiaPercEl.textContent  = "0";
    jamiaGradeEl.textContent = "-";
    return;
  }

  const sum = percs.reduce((a,b)=>a+b,0);
  const avg = Math.round((sum/percs.length)*100)/100;
  jamiaPercEl.textContent  = avg.toFixed(2);
  jamiaGradeEl.textContent = getGrade(avg);
};

/*************** ONE book card ***************/
const createBookCard = (card) => {
  const classSelect         = card.querySelector(".class-select");
  const totalStudentsInput  = card.querySelector(".total-students");
  const presentStudentsInput= card.querySelector(".present-students");

  const bookCard = document.createElement("div");
  bookCard.className = "book-card border rounded-lg p-2 md:p-3 bg-slate-50 space-y-2";

  bookCard.innerHTML = `
    <div class="flex flex-wrap items-center gap-2 md:gap-3">
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">Ø§Ø³ØªØ§Ø°</label>
        <select class="w-full border rounded px-2 py-1.5 urdu text-xs md:text-sm book-teacher">
          <option value="">Ø§Ø³ØªØ§Ø° Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>
        </select>
      </div>
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">Ú©ØªØ§Ø¨ / Ù¾ÛŒØ±ÛŒÚˆ</label>
        <select class="w-full border rounded px-2 py-1.5 urdu text-xs md:text-sm book-name">
          <option value="">Ú©ØªØ§Ø¨ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>
        </select>
      </div>
      <button type="button"
        class="px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs md:text-sm urdu remove-book-btn">
        Ã— Ú©ØªØ§Ø¨ ÛÙ¹Ø§Ø¦ÛŒÚº
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-xs md:text-sm text-right mt-2">
        <thead class="bg-emerald-100">
          <tr>
            <th class="px-2 py-1 urdu">#</th>
            <th class="px-2 py-1 urdu">Ø³ÙˆØ§Ù„</th>
            <th class="px-2 py-1 urdu">Ø¯Ø±Ø³Øª Ø¬ÙˆØ§Ø¨ Ø¯ÛŒÙ†Û’ ÙˆØ§Ù„Û’ Ø·Ù„Ø¨Û</th>
          </tr>
        </thead>
        <tbody>
          ${[1,2,3,4,5].map(i=>`
            <tr class="question-row">
              <td class="px-2 py-1 text-center">${i}</td>
              <td class="px-2 py-1">
                <input type="text"
                       class="w-40 md:w-64 border rounded px-1.5 py-1 urdu text-xs md:text-sm q-text"
                       placeholder="Ø³ÙˆØ§Ù„ ${i}">
              </td>
              <td class="px-2 py-1">
                <input type="number" min="0"
                       class="w-20 border rounded px-1.5 py-1 text-center text-xs md:text-sm q-correct">
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2 text-xs md:text-sm urdu">
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-sabaq-sunana">
        <span>Ø³Ø¨Ù‚ Ø³Ù†Ù†Ø§</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-sabaq-parhana">
        <span>Ø³Ø¨Ù‚ Ù¾Ú‘Ú¾Ø§Ù†Ø§</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-waqt-istemal">
        <span>ÙˆØ§Ø¦Ù¹ Ø¨ÙˆØ±Úˆ Ú©Ø§ Ø§Ø³ØªØ¹Ù…Ø§Ù„</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-tiyari">
        <span>Ù¾ÛŒØ´Ú¯ÛŒ ØªÛŒØ§Ø±ÛŒ Ú©Ø±Ù†Û’ ÙˆØ§Ù„Û’</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-takrar">
        <span>ØªÚ©Ø±Ø§Ø± Ú©Ø±Ø§Ù†Û’ ÙˆØ§Ù„Û’</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="point-checkbox chk-nizam">
        <span>Ø¯Ø±Ø¬Û Ú©Ø§ Ù†Ø¸Ù… Ùˆ Ù†Ø³Ù‚</span>
      </label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2 items-start">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">% (Ø§Ø³ Ú©ØªØ§Ø¨ Ú©Ø§)</label>
        <input type="text" readonly
               class="w-full border rounded px-2 py-1.5 text-center text-sm md:text-base bg-yellow-50 book-percent">
      </div>
      <div class="md:col-span-2">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">Ú©Ù…Ø²ÙˆØ±ÛŒØ§Úº / Ù†ÙˆÙ¹Ø³</label>
        <textarea rows="2"
                  class="w-full border rounded px-2 py-1.5 text-xs md:text-sm urdu weakness"></textarea>
      </div>
    </div>
  `;

  const teacherSelect = bookCard.querySelector(".book-teacher");
  const bookSelect    = bookCard.querySelector(".book-name");

  const fillTeachersForClass = () => {
    const cls = classSelect.value;
    teacherSelect.innerHTML = '<option value="">Ø§Ø³ØªØ§Ø° Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>';
    bookSelect.innerHTML    = '<option value="">Ú©ØªØ§Ø¨ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>';
    if (!cls || !teachingMap[cls]) return;
    const teacherSet = new Set(teachingMap[cls].map(r=>r.teacherName));
    teacherSet.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      teacherSelect.appendChild(opt);
    });
  };

  const fillBooksForTeacher = () => {
    const cls   = classSelect.value;
    const tName = teacherSelect.value;
    bookSelect.innerHTML = '<option value="">Ú©ØªØ§Ø¨ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>';
    if (!cls || !teachingMap[cls] || !tName) return;
    const recs    = teachingMap[cls].filter(r=>r.teacherName===tName);
    const bookSet = new Set(recs.map(r=>r.bookName));
    bookSet.forEach(b => {
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      bookSelect.appendChild(opt);
    });
  };

  teacherSelect.addEventListener("change", fillBooksForTeacher);
  classSelect.addEventListener("change", fillTeachersForClass);

  const triggerBookCalc = () => {
    recalcSingleBookPercent(bookCard, card);
    recalcClassPercent(card);
    recalcJamia();
  };

  const qInputs = bookCard.querySelectorAll(".q-correct");
  qInputs.forEach(inp => {
    inp.addEventListener("input", triggerBookCalc);
  });

  if (presentStudentsInput) {
    presentStudentsInput.addEventListener("input", () => {
      const books = card.querySelectorAll(".book-card");
      books.forEach(b => recalcSingleBookPercent(b, card));
      recalcClassPercent(card);
      recalcJamia();
    });
  }

  if (totalStudentsInput) {
    totalStudentsInput.addEventListener("input", () => {
      const books = card.querySelectorAll(".book-card");
      books.forEach(b => recalcSingleBookPercent(b, card));
      recalcClassPercent(card);
      recalcJamia();
    });
  }

  bookCard.querySelector(".remove-book-btn").addEventListener("click", () => {
    bookCard.remove();
    recalcClassPercent(card);
    recalcJamia();
  });

  // pehle se class select ki value ho to uske hisaab se teachers fill karein
  fillTeachersForClass();
  return bookCard;
};

/*************** Class card create ***************/
const createClassCard = () => {
  classCount += 1;
  const card = document.createElement("div");
  card.className = "bg-white rounded-xl shadow p-3 md:p-4 space-y-3 class-card";
  card.dataset.index = classCount;

  card.innerHTML = `
    <div class="flex flex-wrap items-center gap-2 md:gap-3 border-b pb-2">
      <div class="flex-1 min-w-[120px]">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">Ú©Ù„Ø§Ø³</label>
        <select class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu class-select">
          <option value="">Ú©Ù„Ø§Ø³ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>
        </select>
      </div>
      <button type="button"
        class="px-3 py-1.5 rounded-lg bg-red-500 hover:bg-red-600 text-white text-xs md:text-sm urdu remove-class-btn">
        Ã— Ú©Ù„Ø§Ø³ ÛÙ¹Ø§ Ø¯ÛŒÚº
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-3 mt-2">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">Ú©Ù„ Ø·Ù„Ø¨Û</label>
        <input type="number" min="1"
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base total-students"
               placeholder="Ù…Ø«Ø§Ù„: 30">
      </div>
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">Ø­Ø§Ø¶Ø± Ø·Ù„Ø¨Û</label>
        <input type="number" min="0"
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base present-students"
               placeholder="Ù…Ø«Ø§Ù„: 25">
      </div>
      <div class="flex items-end justify-end">
        <button type="button"
                class="add-book-btn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs md:text-sm urdu">
          + Ù†Ø¦ÛŒ Ú©ØªØ§Ø¨ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº
        </button>
      </div>
    </div>

    <div class="book-list space-y-3 mt-2"></div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-3 pt-2 border-t mt-1">
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">
          Ø§Ø³ Ú©Ù„Ø§Ø³ Ú©Ø§ Ù…Ø¬Ù…ÙˆØ¹ÛŒ ÙÛŒØµØ¯
        </label>
        <input type="text" readonly
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base bg-yellow-50 class-percent">
      </div>
      <div>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">Ø¯Ø±Ø¬Û Ú©ÛŒÙÛŒØª</label>
        <input type="text" readonly
               class="w-full border rounded-lg px-2 py-1.5 text-center text-sm md:text-base bg-emerald-50 class-grade urdu">
      </div>
      <div class="space-y-1">
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1">Ú©Ù…Ø²ÙˆØ±ÛŒØ§Úº Ø§ÙˆØ± Ù…Ø³Ø§Ø¦Ù„</label>
        <textarea rows="2"
                  class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu issues"></textarea>
        <label class="block text-xs md:text-sm text-gray-600 urdu mb-1 mt-1">Ø­Ù„ Ø§ÙˆØ± ØªØ¬Ø§ÙˆÛŒØ²</label>
        <textarea rows="2"
                  class="w-full border rounded-lg px-2 py-1.5 text-xs md:text-sm urdu suggestions"></textarea>
      </div>
    </div>
  `;

  const classSelect         = card.querySelector(".class-select");
  const removeBtn           = card.querySelector(".remove-class-btn");
  const addBookBtn          = card.querySelector(".add-book-btn");
  const bookList            = card.querySelector(".book-list");

  // âœ… Class body ko collapsible banane ke liye wrapper bana rahe hain
  const headerRow = card.querySelector(".border-b");  // upar wala row (jisme class dropdown + remove button hai)

  // naya wrapper jisme sari detail jayegi
  const bodyWrapper = document.createElement("div");
  bodyWrapper.className = "class-body space-y-3 mt-2";

  // header ke baad jitne elements hain (totals, book-list, class % + remarks)
  // un sab ko is bodyWrapper ke andar move kar dete hain
  let sibling = headerRow.nextElementSibling;
  while (sibling) {
    const next = sibling.nextElementSibling;
    bodyWrapper.appendChild(sibling);
    sibling = next;
  }
  card.appendChild(bodyWrapper);

  // âœ… Header me ek toggle button add karein
  const toggleBtn = document.createElement("button");
  toggleBtn.type = "button";
  toggleBtn.className = "toggle-body-btn px-2 py-1 rounded-lg bg-slate-100 text-xs md:text-sm urdu";
  toggleBtn.textContent = "ØªÙØµÛŒÙ„ Ø¯Ú©Ú¾Ø§Ø¦ÛŒÚº";

  // flex header me remove button se thoda pehle insert kar dete hain
  headerRow.insertBefore(toggleBtn, removeBtn);

  // default: sab classes band (sirf header dikhai dega)
  bodyWrapper.classList.add("hidden");

  // âœ… Toggle ka kaam: detail kholna / band karna
  toggleBtn.addEventListener("click", () => {
    const hidden = bodyWrapper.classList.toggle("hidden");
    toggleBtn.textContent = hidden ? "ØªÙØµÛŒÙ„ Ø¯Ú©Ú¾Ø§Ø¦ÛŒÚº" : "ØªÙØµÛŒÙ„ Ú†Ú¾Ù¾Ø§Ø¦ÛŒÚº";

    if (!hidden) {
      // jab ye class khuli ho to baqi sari classes band kar do
      const allCards = classesContainer.querySelectorAll(".class-card");
      allCards.forEach(c => {
        if (c === card) return;
        const b = c.querySelector(".class-body");
        const t = c.querySelector(".toggle-body-btn");
        if (b && !b.classList.contains("hidden")) {
          b.classList.add("hidden");
          if (t) t.textContent = "ØªÙØµÛŒÙ„ Ø¯Ú©Ú¾Ø§Ø¦ÛŒÚº";
        }
      });
    }
  });

  // fill class dropdown
  classSelect.innerHTML = '<option value="">Ú©Ù„Ø§Ø³ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>';
  classList.forEach(cls => {
    const opt = document.createElement("option");
    opt.value = cls;
    opt.textContent = cls;
    classSelect.appendChild(opt);
  });

  removeBtn.addEventListener("click", () => {
    card.remove();
    recalcJamia();
  });

  const addBook = () => {
    const bCard = createBookCard(card);
    bookList.appendChild(bCard);
  };
  addBookBtn.addEventListener("click", addBook);

  // default: 1 kitab
  addBook();

  return card;
};

const addNewClassCard = () => {
  const card = createClassCard();
  classesContainer.appendChild(card);
};

/*************** NAYA: pehle se saved Jaiza ko load karke pre-fill kare ***************/
const loadExistingJaizaForms = async (user) => {
  if (!jamiaId || !monthKey) return;

  const qRef = query(
    collection(db,"jaiza_forms"),
    where("jamiaId","==",jamiaId),
    where("monthKey","==",monthKey),
    where("createdBy","==",user.uid)
  );
  const snap = await getDocs(qRef);

  // Agar koi data nahi mila to blank form (editable)
  if (snap.empty) {
    classesContainer.innerHTML = "";
    classCount = 0;
    addNewClassCard();
    recalcJamia();
    // naya form already editable, isliye update button ki zarurat nahi
    if (enableEditBtn) enableEditBtn.disabled = true;
    return;
  }

  // Pura container clear, phir docs ke hisaab se cards create
  classesContainer.innerHTML = "";
  classCount = 0;

  const docs = [];
  snap.forEach(d => docs.push({ id: d.id, ...d.data() }));

  docs.forEach(d => {
    const card = createClassCard();
    classesContainer.appendChild(card);

    const classSelect         = card.querySelector(".class-select");
    const totalStudentsInput  = card.querySelector(".total-students");
    const presentStudentsInput= card.querySelector(".present-students");
    const issuesInput         = card.querySelector(".issues");
    const suggestionsInput    = card.querySelector(".suggestions");
    const classPercentInput   = card.querySelector(".class-percent");
    const classGradeInput     = card.querySelector(".class-grade");
    const bookListDiv         = card.querySelector(".book-list");

    // ensure class option exists
    const cName = d.className || "";
    if (cName) {
      let exists = false;
      Array.from(classSelect.options).forEach(o => {
        if (o.value === cName) exists = true;
      });
      if (!exists) {
        const opt = document.createElement("option");
        opt.value = cName;
        opt.textContent = cName;
        classSelect.appendChild(opt);
      }
      classSelect.value = cName;
      classSelect.dispatchEvent(new Event("change"));
    }

    totalStudentsInput.value   = d.totalStudents ?? "";
    presentStudentsInput.value = d.presentStudents ?? "";
    issuesInput.value          = d.issues || "";
    suggestionsInput.value     = d.suggestions || "";

    // purani default book card hatao, phir saved books ke hisaab se banao
    bookListDiv.innerHTML = "";

    const books = Array.isArray(d.books) ? d.books : [];
    books.forEach(b => {
      const bookCard = createBookCard(card);
      bookListDiv.appendChild(bookCard);

      const teacherSelect = bookCard.querySelector(".book-teacher");
      const bookSelect    = bookCard.querySelector(".book-name");
      const weaknessTa    = bookCard.querySelector(".weakness");
      const bookPercInput = bookCard.querySelector(".book-percent");

      // teacherOptions ensure
      if (cName) {
        const teacherSet = teachingMap[cName] ? new Set(teachingMap[cName].map(r=>r.teacherName)) : new Set();
        if (b.teacherName && !teacherSet.has(b.teacherName)) {
          const opt = document.createElement("option");
          opt.value = b.teacherName;
          opt.textContent = b.teacherName;
          teacherSelect.appendChild(opt);
        }
      }

      teacherSelect.value = b.teacherName || "";
      teacherSelect.dispatchEvent(new Event("change"));

      if (b.bookName) {
        let existsBook = false;
        Array.from(bookSelect.options).forEach(o => {
          if (o.value === b.bookName) existsBook = true;
        });
        if (!existsBook) {
          const opt = document.createElement("option");
          opt.value = b.bookName;
          opt.textContent = b.bookName;
          bookSelect.appendChild(opt);
        }
        bookSelect.value = b.bookName;
      }

      weaknessTa.value = b.weakness || "";

      // questions fill
      const qRows = bookCard.querySelectorAll(".question-row");
      const questions = Array.isArray(b.questions) ? b.questions : [];
      questions.forEach(q => {
        const idx = (q.index || 1) - 1;
        if (!qRows[idx]) return;
        const row = qRows[idx];
        row.querySelector(".q-text").value    = q.text || "";
        row.querySelector(".q-correct").value = q.correctStudents ?? "";
      });

      // checks
      const checks = b.checks || {};
      bookCard.querySelector(".chk-sabaq-sunana").checked  = !!checks.sabaqSunana;
      bookCard.querySelector(".chk-sabaq-parhana").checked = !!checks.sabaqParhana;
      bookCard.querySelector(".chk-waqt-istemal").checked  = !!checks.waqtIstemal;
      bookCard.querySelector(".chk-tiyari").checked        = !!checks.tiyari;
      bookCard.querySelector(".chk-takrar").checked        = !!checks.takrar;
      bookCard.querySelector(".chk-nizam").checked         = !!checks.nizam;

      // stored percentage (agar hai) else recalc
      if (typeof b.percentage === "number") {
        bookPercInput.value = b.percentage.toFixed(1) + "%";
      } else {
        recalcSingleBookPercent(bookCard, card);
      }
    });

    // class % / grade
    if (typeof d.classPercentage === "number") {
      classPercentInput.value = d.classPercentage.toFixed(1) + "%";
      classGradeInput.value   = d.grade || getGrade(d.classPercentage);
    } else {
      recalcClassPercent(card);
    }
  });

  // jamia ka overall
  recalcJamia();

  // existing data: start in read-only mode, update button enabled
  if (docs.length && enableEditBtn) {
    toggleEditMode(false);
    enableEditBtn.disabled = false;
  }
};

/*************** Auth & initial load ***************/
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    showError("Ù„Ø§Ú¯ Ø§ÙÙ† Ø¶Ø±ÙˆØ±ÛŒ ÛÛ’ØŒ Ù¾ÛÙ„Û’ ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ Ø³Û’ Ù„Ø§Ú¯ Ø§ÙÙ† Ú©Ø±ÛŒÚºÛ”");
    return;
  }
  currentUser = user;

  showLoader(true);
  try {
    // pehle teaching structure, phir saved jaiza
    await loadTeachingStructure(user);
    await loadExistingJaizaForms(user);
  } catch(err) {
    console.error(err);
    // fallback: at least ek blank class
    classesContainer.innerHTML = "";
    classCount = 0;
    addNewClassCard();
  } finally {
    showLoader(false);
  }
});

addClassBtn.addEventListener("click", () => addNewClassCard());

/*************** Update button â†’ enable editing ***************/
if (enableEditBtn) {
  enableEditBtn.addEventListener("click", () => {
    toggleEditMode(true);
    // ek baar edit on karne ke baad is button ko disable kar dete hain
    enableEditBtn.disabled = true;
  });
}

/*************** Submit â†’ save in Firestore ***************/
formEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  clearError();
  clearSuccess();

  if (!currentUser) {
    showError("Ù„Ø§Ú¯ Ø§ÙÙ† Ù†ÛÛŒÚº Ù…Ù„Ø§ØŒ Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¯ÙˆØ¨Ø§Ø±Û ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ Ø³Û’ Ø¢Ø¦ÛŒÚºÛ”");
    return;
  }
  if (!jamiaId || !monthKey) {
    showError("Ø¬Ø§Ù…Ø¹Û ÛŒØ§ Ù…ÛÛŒÙ†Û URL Ù…ÛŒÚº Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚºØŒ Ù„Ù†Ú© Ú†ÛŒÚ© Ú©Ø±ÛŒÚºÛ”");
    return;
  }

  const cards = Array.from(classesContainer.querySelectorAll(".class-card"));
  if (!cards.length) {
    showError("Ú©Ù… Ø§Ø² Ú©Ù… Ø§ÛŒÚ© Ú©Ù„Ø§Ø³ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚºÛ”");
    return;
  }

  const payloads = [];

  cards.forEach(card => {
    const className       = card.querySelector(".class-select").value.trim();
    const totalStudents   = Number(card.querySelector(".total-students")?.value || 0);
    const presentStudents = Number(card.querySelector(".present-students")?.value || 0);

    const classPercentStr = card.querySelector(".class-percent")?.value || "";
    let classPercentage = null;
    if (classPercentStr) {
      const v = Number(classPercentStr.replace("%","").trim());
      if (!isNaN(v)) classPercentage = v;
    }

    const issues      = card.querySelector(".issues").value.trim();
    const suggestions = card.querySelector(".suggestions").value.trim();

    const books = [];
    const bookCards = card.querySelectorAll(".book-card");
    bookCards.forEach(bCard => {
      const teacherName = bCard.querySelector(".book-teacher").value.trim();
      const bookName    = bCard.querySelector(".book-name").value.trim();
      const weakness    = bCard.querySelector(".weakness").value.trim();
      const percStr     = bCard.querySelector(".book-percent").value;

      const qRows = bCard.querySelectorAll(".question-row");
      const questions = [];
      qRows.forEach((row, idx) => {
        const text = row.querySelector(".q-text").value.trim();
        const corr = Number(row.querySelector(".q-correct").value || 0);
        if (!text && !corr) return;
        questions.push({
          index: idx+1,
          text,
          correctStudents: corr
        });
      });

      const checks = {
        sabaqSunana:  bCard.querySelector(".chk-sabaq-sunana")?.checked || false,
        sabaqParhana: bCard.querySelector(".chk-sabaq-parhana")?.checked || false,
        waqtIstemal:  bCard.querySelector(".chk-waqt-istemal")?.checked || false,
        tiyari:       bCard.querySelector(".chk-tiyari")?.checked || false,
        takrar:       bCard.querySelector(".chk-takrar")?.checked || false,
        nizam:        bCard.querySelector(".chk-nizam")?.checked || false,
      };

      let percentage = null;
      if (percStr) {
        const v = Number(percStr.replace("%","").trim());
        if (!isNaN(v)) percentage = v;
      }

      const allEmptyBook =
        !teacherName && !bookName && !questions.length &&
        !weakness && !percentage &&
        !checks.sabaqSunana && !checks.sabaqParhana && !checks.waqtIstemal &&
        !checks.tiyari && !checks.takrar && !checks.nizam;

      if (allEmptyBook) return;

      books.push({
        teacherName,
        bookName,
        questions,
        percentage,
        weakness,
        checks
      });
    });

    const allEmptyClass =
      !className && !totalStudents && !presentStudents && !books.length && !issues && !suggestions;

    if (allEmptyClass) return;

    payloads.push({
      jamiaId,
      monthKey,
      className,
      totalStudents,
      presentStudents,
      classPercentage,
      grade: classPercentage != null ? getGrade(classPercentage) : "-",
      books,
      issues,
      suggestions,
      totalClasses: Number(totalClassesEl?.textContent || 0),
      totalBooks: Number(totalBooksEl?.textContent || 0),
      createdBy: currentUser.uid,
      createdAt: serverTimestamp()
    });
  });

  if (!payloads.length) {
    showError("Ú©Ù… Ø§Ø² Ú©Ù… Ø§ÛŒÚ© Ú©Ù„Ø§Ø³ Ù…ÛŒÚº Ú©Ú†Ú¾ ÚˆÛŒÙ¹Ø§ Ø¶Ø±ÙˆØ± Ø¨Ú¾Ø±ÛŒÚºÛ”");
    return;
  }

  showLoader(true);
  try {
    // pehle purane is mahine ke jaiza forms delete
    const qRef = query(
      collection(db,"jaiza_forms"),
      where("jamiaId","==",jamiaId),
      where("monthKey","==",monthKey),
      where("createdBy","==",currentUser.uid)
    );
    const oldSnap = await getDocs(qRef);
    const delPromises = [];
    oldSnap.forEach(d => delPromises.push(deleteDoc(d.ref)));
    await Promise.all(delPromises);

    // phir naya data add
    const addPromises = payloads.map(p => addDoc(collection(db,"jaiza_forms"), p));
    await Promise.all(addPromises);

    showSuccess("ØªØ¹Ù„ÛŒÙ…ÛŒ Ø¬Ø§Ø¦Ø²Û Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ú©Û’ Ø³Ø§ØªÚ¾ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯ÛŒØ§Û”");
    isFormDirty = false; //
  } catch(err) {
    console.error(err);
    showError("ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ØªÛ’ ÙˆÙ‚Øª Ù…Ø³Ø¦Ù„Û Ø¢ÛŒØ§ØŒ Ø¨Ø¹Ø¯ Ù…ÛŒÚº Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”");
  } finally {
    showLoader(false);
  }
});
  
  /* === Dashboard Back Confirmation === */
document.addEventListener("DOMContentLoaded", () => {
  const backBtn = document.getElementById("dashboard-back-btn");

  if (backBtn) {
    backBtn.addEventListener("click", function (event) {
      // Agar form dirty hai (changes huye hain) to confirm karein
      if (isFormDirty) {
        event.preventDefault(); // Stop navigation
        const ask = confirm("Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÙˆØ§Ù¾Ø³ Ø¬Ø§Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ\nØ¬Ùˆ ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ù†ÛÛŒÚº Ú©ÛŒØ§ Ú¯ÛŒØ§ØŒ ÙˆÛ Ø¶Ø§Ø¦Ø¹ ÛÙˆ Ø¬Ø§Ø¦Û’ Ú¯Ø§Û”");
        if (ask) {
          isFormDirty = false; // User ne confirm kar diya, ab rokne ki zaroorat nahi
          window.location.href = backBtn.href;
        }
      }
      // Agar form dirty nahi hai, to direct jane dega (kuch karne ki zaroorat nahi)
    });
  }
});
  // Agar user form mein kuch bhi change kare (likhe ya select kare)
formEl.addEventListener("input", () => {
  isFormDirty = true;
});
formEl.addEventListener("change", () => {
  isFormDirty = true;
});

// Browser close/refresh/back button par rokne ke liye
window.addEventListener("beforeunload", function (e) {
  if (isFormDirty) {
    e.preventDefault();
    // Modern browsers custom message show nahi karte, wo generic warning dete hain.
    // Lekin ye line zaroori hai popup trigger karne ke liye.
    e.returnValue = ""; 
  }
});
  // --- Yahan se Naya Code Copy karein ---

// Helper Function: Dashboard Update karne ke liye
const updateDashboardReport = async (finalPercent, finalGrade) => {
  if (!currentUser || !jamiaId || !monthKey) return;

  // 1. Report ID generate karein (Dashboard logic ke mutabiq)
  const [yStr, mStr] = monthKey.split("-");
  const yearNum = parseInt(yStr);
  const monthNum = parseInt(mStr) - 1; // 0-11
  const academicYear = (monthNum >= 3) ? `${yearNum}-${yearNum + 1}` : `${yearNum - 1}-${yearNum}`;
  
  // ID format wahi hona chahiye jo index.html me hai
  const reportId = `${currentUser.uid}_${academicYear}_${yearNum}_${monthNum}`;
  const reportRef = doc(db, "monthly_reports", reportId);

  try {
    const reportSnap = await getDoc(reportRef);
    if (reportSnap.exists()) {
      const reportData = reportSnap.data();
      let jaizaData = reportData.jaizaReport?.data || [];
      const jamiaNameDecoded = decodeURIComponent(jamiaId);

      // Check karein agar ye Jamia pehle se list me hai
      const index = jaizaData.findIndex(j => j.name === jamiaNameDecoded);

      const newEntry = {
        name: jamiaNameDecoded,
        date: new Date().toISOString().split('T')[0], // Aaj ki date
        type: "Jaiza",
        percentage: finalPercent, // Updated Percentage (e.g. 69.30)
      };

      if (index !== -1) {
        // Agar pehle se hai to update karein (Merge logic)
        jaizaData[index] = { ...jaizaData[index], ...newEntry };
      } else {
        // Agar nahi hai to naya add karein
        jaizaData.push(newEntry);
      }

      // Firestore Update
      await updateDoc(reportRef, {
        "jaizaReport.data": jaizaData,
        "jaizaReport.status": "Done"
      });
      console.log("Dashboard successfully updated with new %:", finalPercent);
    }
  } catch (err) {
    console.error("Dashboard update failed:", err);
    // Error ignore kar rahe hain taake user ko pareshani na ho, 
    // kyunki main data jaiza_forms me save ho chuka hoga.
  }
};

// --- Submit Handler (Updated) ---
formEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  clearError();
  clearSuccess();

  if (!currentUser) {
    showError("Ù„Ø§Ú¯ Ø§ÙÙ† Ù†ÛÛŒÚº Ù…Ù„Ø§ØŒ Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¯ÙˆØ¨Ø§Ø±Û ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ Ø³Û’ Ø¢Ø¦ÛŒÚºÛ”");
    return;
  }
  if (!jamiaId || !monthKey) {
    showError("Ø¬Ø§Ù…Ø¹Û ÛŒØ§ Ù…ÛÛŒÙ†Û URL Ù…ÛŒÚº Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚºØŒ Ù„Ù†Ú© Ú†ÛŒÚ© Ú©Ø±ÛŒÚºÛ”");
    return;
  }

  const cards = Array.from(classesContainer.querySelectorAll(".class-card"));
  if (!cards.length) {
    showError("Ú©Ù… Ø§Ø² Ú©Ù… Ø§ÛŒÚ© Ú©Ù„Ø§Ø³ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚºÛ”");
    return;
  }

  const payloads = [];

  cards.forEach(card => {
    const className       = card.querySelector(".class-select").value.trim();
    const totalStudents   = Number(card.querySelector(".total-students")?.value || 0);
    const presentStudents = Number(card.querySelector(".present-students")?.value || 0);

    const classPercentStr = card.querySelector(".class-percent")?.value || "";
    let classPercentage = null;
    if (classPercentStr) {
      const v = Number(classPercentStr.replace("%","").trim());
      if (!isNaN(v)) classPercentage = v;
    }

    const issues      = card.querySelector(".issues").value.trim();
    const suggestions = card.querySelector(".suggestions").value.trim();

    const books = [];
    const bookCards = card.querySelectorAll(".book-card");
    bookCards.forEach(bCard => {
      const teacherName = bCard.querySelector(".book-teacher").value.trim();
      const bookName    = bCard.querySelector(".book-name").value.trim();
      const weakness    = bCard.querySelector(".weakness").value.trim();
      const percStr     = bCard.querySelector(".book-percent").value;
      
      // ... (Baki purana books/questions logic same rahega) ...
      // Short karne ke liye yahan omit kiya hai, aap apna purana logic use karein
      // Lekin 'checks' aur 'questions' wala part zaroor rakhein.
      
      const qRows = bCard.querySelectorAll(".question-row");
      const questions = [];
      qRows.forEach((row, idx) => {
        const text = row.querySelector(".q-text").value.trim();
        const corr = Number(row.querySelector(".q-correct").value || 0);
        if (!text && !corr) return;
        questions.push({ index: idx+1, text, correctStudents: corr });
      });

      const checks = {
        sabaqSunana:  bCard.querySelector(".chk-sabaq-sunana")?.checked || false,
        sabaqParhana: bCard.querySelector(".chk-sabaq-parhana")?.checked || false,
        waqtIstemal:  bCard.querySelector(".chk-waqt-istemal")?.checked || false,
        tiyari:       bCard.querySelector(".chk-tiyari")?.checked || false,
        takrar:       bCard.querySelector(".chk-takrar")?.checked || false,
        nizam:        bCard.querySelector(".chk-nizam")?.checked || false,
      };

      let percentage = null;
      if (percStr) {
        const v = Number(percStr.replace("%","").trim());
        if (!isNaN(v)) percentage = v;
      }

      // Check if book is empty
      const allEmptyBook = !teacherName && !bookName && !questions.length && !weakness && !percentage;
      if (allEmptyBook) return;

      books.push({ teacherName, bookName, questions, percentage, weakness, checks });
    });

    // Check if class is empty
    const allEmptyClass = !className && !totalStudents && !presentStudents && !books.length && !issues && !suggestions;
    if (allEmptyClass) return;

    payloads.push({
      jamiaId,
      monthKey,
      className,
      totalStudents,
      presentStudents,
      classPercentage,
      grade: classPercentage != null ? getGrade(classPercentage) : "-",
      books,
      issues,
      suggestions,
      totalClasses: Number(totalClassesEl?.textContent || 0),
      totalBooks: Number(totalBooksEl?.textContent || 0),
      createdBy: currentUser.uid,
      createdAt: serverTimestamp()
    });
  });

  if (!payloads.length) {
    showError("Ú©Ù… Ø§Ø² Ú©Ù… Ø§ÛŒÚ© Ú©Ù„Ø§Ø³ Ù…ÛŒÚº Ú©Ú†Ú¾ ÚˆÛŒÙ¹Ø§ Ø¶Ø±ÙˆØ± Ø¨Ú¾Ø±ÛŒÚºÛ”");
    return;
  }

  showLoader(true);
  try {
    // 1. Delete Old Details
    const qRef = query(
      collection(db,"jaiza_forms"),
      where("jamiaId","==",jamiaId),
      where("monthKey","==",monthKey),
      where("createdBy","==",currentUser.uid)
    );
    const oldSnap = await getDocs(qRef);
    const delPromises = [];
    oldSnap.forEach(d => delPromises.push(deleteDoc(d.ref)));
    await Promise.all(delPromises);

    // 2. Add New Details
    const addPromises = payloads.map(p => addDoc(collection(db,"jaiza_forms"), p));
    await Promise.all(addPromises);

    // 3. ğŸ”¥ UPDATE DASHBOARD REPORT (Naya Step) ğŸ”¥
    // Header se values uthayen
    const currentJamiaPercent = jamiaPercEl.textContent || "0"; 
    const currentJamiaGrade = jamiaGradeEl.textContent || "-";
    
    // Dashboard update function call karein
    await updateDashboardReport(currentJamiaPercent, currentJamiaGrade);

    showSuccess("ØªØ¹Ù„ÛŒÙ…ÛŒ Ø¬Ø§Ø¦Ø²Û Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯ÛŒØ§ Ø§ÙˆØ± ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ Ø§Ù¾ ÚˆÛŒÙ¹ Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§Û”");
    isFormDirty = false; 
  } catch(err) {
    console.error(err);
    showError("ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ØªÛ’ ÙˆÙ‚Øª Ù…Ø³Ø¦Ù„Û Ø¢ÛŒØ§Û”");
  } finally {
    showLoader(false);
  }
});
</script>

</body>
</html>
