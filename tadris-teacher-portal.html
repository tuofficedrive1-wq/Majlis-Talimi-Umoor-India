<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadris Recording Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <link href="https://fonts.cdnfonts.com/css/jameel-noori-nastaleeq" rel="stylesheet"/>

    <style>
        body { font-family: 'Jameel Noori Nastaleeq', serif; background-color: #f3f4f6; }
        h1, h2, h3, h4, p, label, button, input, select, textarea { font-family: 'Jameel Noori Nastaleeq', serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #059669; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Fix direction for URL inputs/English text */
        .dir-ltr { direction: ltr; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="loading-screen" class="text-center">
        <div class="loader mx-auto mb-3"></div>
        <p class="text-emerald-800 text-lg">ڈیٹا لوڈ ہو رہا ہے...</p>
    </div>

    <div id="login-section" class="hidden bg-white w-full max-w-md p-6 rounded-2xl shadow-xl text-center">
        <div class="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-microphone-alt text-3xl text-emerald-600"></i>
        </div>
        
        <h1 class="text-2xl font-bold text-gray-800 mb-1">تدریس ریکارڈنگ پورٹل</h1>

<p id="admin-name-display" class="text-gray-500 text-sm font-semibold mb-1">...</p> 

<p id="jamia-display-login" class="text-emerald-600 font-semibold mb-6 text-sm">جامعہ: لوڈنگ...</p>

        <div class="space-y-4">
            <div class="text-right">
                <label class="block text-gray-700 font-bold mb-1 mr-1">اپنا اجیر کوڈ درج کریں:</label>
                <input type="text" id="teacher-code-input" placeholder="مثلاً: 12345" 
                    class="w-full p-3 border border-gray-300 rounded-xl text-center text-xl tracking-widest focus:ring-2 focus:ring-emerald-500 outline-none dir-ltr">
            </div>

            <button onclick="verifyTeacherCode()" id="verify-btn" 
                class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow-lg flex justify-center items-center gap-2">
                <span>لاگ ان کریں</span>
                <i class="fas fa-sign-in-alt"></i>
            </button>

            <p id="login-error" class="hidden text-red-600 bg-red-50 p-2 rounded border border-red-100 text-sm mt-2"></p>
        </div>
    </div>

    <div id="dashboard-section" class="hidden w-full max-w-lg">
        
        <div class="bg-emerald-800 text-white p-5 rounded-t-2xl shadow-lg relative overflow-hidden">
            <div class="flex justify-between items-start z-10 relative">
                <div class="text-right">
                    <h2 id="disp-teacher-name" class="text-xl font-bold">استاد کا نام</h2>
                    <p id="disp-jamia-name" class="text-sm text-emerald-200 opacity-90 mt-1">جامعہ کا نام</p>
                </div>
                <button onclick="location.reload()" class="bg-emerald-900/50 hover:bg-red-500/80 text-white px-3 py-1 rounded text-xs border border-emerald-600 transition">
                    خروج
                </button>
            </div>
            <i class="fas fa-microphone-lines absolute -bottom-4 -left-4 text-emerald-700/50 text-8xl z-0"></i>
        </div>

        <div class="bg-white p-6 rounded-b-2xl shadow-xl space-y-5">

            <div>
                <label class="block text-gray-600 font-bold mb-2 mr-1">کلاس اور کتاب منتخب کریں:</label>
                <div class="relative">
                    <select id="class-select" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-emerald-500 outline-none appearance-none">
                        <option value="">-- منتخب کریں --</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center px-3 text-gray-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-gray-600 font-bold mb-2 mr-1">تاریخ:</label>
                <input type="date" id="rec-date" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 text-right focus:ring-2 focus:ring-emerald-500 outline-none">
            </div>

            <div class="bg-gradient-to-br from-red-50 to-white border border-red-100 rounded-xl p-5 text-center shadow-inner">
                <p class="text-red-800 font-bold mb-3 flex items-center justify-center gap-2">
                    <i class="fas fa-circle text-red-600 text-xs animate-pulse"></i> لائیو ریکارڈنگ
                </p>
                
                <div id="record-controls" class="space-y-3">
                    <button onclick="startRecording()" id="btn-start" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-red-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-microphone"></i> ریکارڈنگ شروع کریں
                    </button>
                    
                    <button onclick="stopRecording()" id="btn-stop" class="hidden w-full bg-gray-800 text-white py-3 rounded-xl font-bold shadow-md hover:bg-black transition flex items-center justify-center gap-2 animate-pulse">
                        <i class="fas fa-stop"></i> روک دیں (<span id="timer" class="dir-ltr">00:00</span>)
                    </button>
                </div>

                <div id="preview-area" class="hidden mt-4 bg-white p-3 rounded-lg border border-gray-200">
                    <p class="text-gray-400 text-xs text-right mb-2">جائزہ لیں:</p>
                    <audio id="audio-preview" controls class="w-full h-10 mb-2"></audio>
                    <button onclick="resetRecording()" class="text-red-500 text-sm hover:underline flex items-center justify-center gap-1 mx-auto">
                        <i class="fas fa-trash-alt"></i> ڈیلیٹ کریں اور دوبارہ ریکارڈ کریں
                    </button>
                </div>
            </div>

            <div class="relative flex items-center py-2">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">یا (OR)</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <div class="bg-blue-50 border border-blue-100 rounded-xl p-4">
                 <label class="block text-blue-800 font-bold mb-2 text-sm mr-1">
                    <i class="fas fa-file-audio ml-1"></i> فائل اپلوڈ کریں (اگر ریکارڈنگ موجود ہے)
                 </label>
                 <input type="file" id="file-upload-input" accept="audio/*" class="w-full text-sm text-gray-500 file:mr-0 file:ml-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"/>
            </div>

            <button onclick="uploadAndSave()" id="btn-save" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-emerald-700 shadow-xl transition flex items-center justify-center gap-2 mt-4">
                <span>محفوظ کریں (Save)</span>
                <i class="fas fa-cloud-upload-alt"></i>
            </button>
            <p id="status-msg" class="text-center text-sm font-semibold min-h-[20px]"></p>

        </div>
        
        <div class="text-center mt-6 text-gray-400 text-xs dir-ltr">
            Majlis Talimi Umoor India
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.firebasestorage.app",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // --- GLOBAL STATE ---
       // --- GLOBAL STATE ---
        let globalUserId = null; // <--- YEH ADD KAREIN
        let jamiaData = null;
        let selectedTeacher = null;
        let reportYear = null;
        let monthIndex = null;
        let activeYearGlobal = null;
        
        // Recording Vars
        let mediaRecorder = null;
        let audioChunks = [];
        let recordedBlob = null;
        let timerInterval = null;

        // --- 1. INITIALIZE (Load URL Params) ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Login anonymously to access Firestore
            await auth.signInAnonymously().catch(e => console.error("Auth Error:", e));

            const urlParams = new URLSearchParams(window.location.search);
            const jamiaId = urlParams.get('jamiaId'); // Encoded Jamia Name
            const userId = urlParams.get('userId');
            const activeYear = urlParams.get('activeYear');

            globalUserId = userId;

            if (!jamiaId || !userId || !activeYear) {
                showError("لنک درست نہیں ہے۔ (جامعہ یا سال کی معلومات غائب ہیں)");
                return;
            }

            activeYearGlobal = activeYear;

            // Month/Year Calculation (Defaults to current if not provided)
            const today = new Date();
            reportYear = today.getFullYear();
            monthIndex = today.getMonth(); // 0 = Jan

            document.getElementById('rec-date').valueAsDate = today;

            // Display Info
            const jamiaNameDecoded = decodeURIComponent(jamiaId);
            document.getElementById('jamia-display-login').innerText = jamiaNameDecoded;
            
            // Load Data from Firestore
            loadJamiaData(userId, activeYear, jamiaNameDecoded);
        });

        // --- 2. LOAD DATA FROM FIRESTORE ---
async function loadJamiaData(userId, year, jamiaName) {
    try {
        const userRef = db.collection('users').doc(userId);
        const userSnap = await userRef.get();

        if (!userSnap.exists) throw new Error("ایڈمن یوزر نہیں ملا۔");

        const userData = userSnap.data();
        
        // --- YAHAN NAYA CODE ADD HUA HAI ---
        // Admin ka naam set karein (Misaal: "Zere Nigrani: Faizan Attari")
        const adminName = userData.name || "Unknown User";
        document.getElementById('admin-name-display').innerText = `زیر نگرانی: ${adminName}`;
        // -----------------------------------

        const yearData = userData.academicYears?.[year];

        if (!yearData || !yearData.karkardagiStructure) {
            throw new Error("اس سال کا تعلیمی ڈیٹا موجود نہیں ہے۔");
        }

        const structure = yearData.karkardagiStructure;
        const foundJamia = structure.find(j => j.jamiaName === jamiaName);

        if (!foundJamia) throw new Error("اس جامعہ کا ریکارڈ نہیں ملا۔");

        jamiaData = foundJamia; 
        
        // Show Login Screen
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');

    } catch (err) {
        showError(err.message);
    }
}

        // --- 3. VERIFY TEACHER CODE ---
        function verifyTeacherCode() {
            const codeInput = document.getElementById('teacher-code-input');
            const code = codeInput.value.trim();
            const errorMsg = document.getElementById('login-error');
            const btn = document.getElementById('verify-btn');

            errorMsg.classList.add('hidden');

            if (!jamiaData || !jamiaData.teachers) {
                errorMsg.innerText = "ڈیٹا لوڈ نہیں ہوا، پیج ریفریش کریں۔";
                errorMsg.classList.remove('hidden');
                return;
            }

            // Find Teacher
            const teacher = jamiaData.teachers.find(t => String(t.loginCode) === code);

            if (teacher) {
                selectedTeacher = teacher;
                
                // Success: Show Dashboard
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> تصدیق ہو رہی ہے...';
                
                setTimeout(() => {
                    loadDashboard();
                }, 800);

            } else {
                errorMsg.innerText = "کوڈ غلط ہے! براہ کرم درست اجیر کوڈ درج کریں۔";
                errorMsg.classList.remove('hidden');
                codeInput.classList.add('border-red-500');
            }
        }

        // --- 4. LOAD DASHBOARD ---
        function loadDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');

            // Set Header Info
            document.getElementById('disp-teacher-name').innerText = selectedTeacher.name;
            document.getElementById('disp-jamia-name').innerText = jamiaData.jamiaName;

            // Populate Class Dropdown from Teacher's Periods
            const select = document.getElementById('class-select');
            select.innerHTML = '<option value="">-- منتخب کریں --</option>';

            if (selectedTeacher.periods && selectedTeacher.periods.length > 0) {
                selectedTeacher.periods.forEach(p => {
                    const opt = document.createElement('option');
                    // Value format: ClassName|BookName
                    opt.value = `${p.className}|${p.bookName}`;
                    opt.innerText = `${p.className} - ${p.bookName}`;
                    select.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.innerText = "کوئی کلاس تفویض نہیں";
                select.appendChild(opt);
            }
        }

        // --- 5. RECORDING LOGIC ---
        async function startRecording() {
            // Reset File Input if any
            document.getElementById('file-upload-input').value = "";

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const url = URL.createObjectURL(recordedBlob);
                    const audio = document.getElementById('audio-preview');
                    audio.src = url;
                    
                    document.getElementById('preview-area').classList.remove('hidden');
                    document.getElementById('record-controls').classList.add('hidden');
                    
                    stream.getTracks().forEach(t => t.stop());
                };

                mediaRecorder.start();
                
                document.getElementById('btn-start').classList.add('hidden');
                document.getElementById('btn-stop').classList.remove('hidden');

                let sec = 0;
                const timerEl = document.getElementById('timer');
                timerEl.innerText = "00:00";
                
                timerInterval = setInterval(() => {
                    sec++;
                    const m = Math.floor(sec / 60).toString().padStart(2,'0');
                    const s = (sec % 60).toString().padStart(2,'0');
                    timerEl.innerText = `${m}:${s}`;
                }, 1000);

            } catch (err) {
                alert("مائکروفون کی اجازت نہیں ملی۔ براؤزر سیٹنگ چیک کریں۔\n" + err.message);
            }
        }

        function stopRecording() {
            if(mediaRecorder) mediaRecorder.stop();
            clearInterval(timerInterval);
        }

        function resetRecording() {
            recordedBlob = null;
            document.getElementById('preview-area').classList.add('hidden');
            document.getElementById('record-controls').classList.remove('hidden');
            document.getElementById('btn-start').classList.remove('hidden');
            document.getElementById('btn-stop').classList.add('hidden');
        }

        // File Input Change Listener (Clears recording if file selected)
        document.getElementById('file-upload-input').addEventListener('change', function() {
            if (this.files.length > 0 && recordedBlob) {
                if(confirm("آپ نے فائل منتخب کی ہے۔ کیا آپ ریکارڈنگ ڈیلیٹ کرنا چاہتے ہیں؟")) {
                    resetRecording();
                } else {
                    this.value = ""; // Clear file input
                }
            }
        });

        // --- 6. UPLOAD & SAVE (UPDATED) ---
        async function uploadAndSave() {
            const btn = document.getElementById('btn-save');
            const status = document.getElementById('status-msg');
            
            // Inputs
            const dateVal = document.getElementById('rec-date').value;
            const classSelectVal = document.getElementById('class-select').value;
            const fileInput = document.getElementById('file-upload-input');
            const uploadedFile = fileInput.files[0];

            // Validation
            if (!classSelectVal) return alert("براہ کرم کلاس اور کتاب منتخب کریں۔");
            if (!dateVal) return alert("تاریخ منتخب کریں۔");
            if (!recordedBlob && !uploadedFile) return alert("ریکارڈنگ کریں یا فائل اپلوڈ کریں۔");

            // Prepare Data
            const [className, bookName] = classSelectVal.split('|');
            let finalFile = null;
            let fileName = "";

            if (uploadedFile) {
                finalFile = uploadedFile;
                fileName = `File_${Date.now()}_${uploadedFile.name}`;
            } else {
                finalFile = recordedBlob;
                fileName = `Rec_${Date.now()}.webm`;
            }

            // Start Upload Process
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> اپلوڈ ہو رہا ہے...';
            status.innerText = "فائل سرور پر بھیجی جا رہی ہے، براہ کرم انتظار کریں...";
            status.className = "text-center text-sm mt-3 font-medium text-blue-600";

            try {
                // 1. Upload to Firebase Storage
                const storageRef = storage.ref().child(`recordings/teachers/${fileName}`);
                const snapshot = await storageRef.put(finalFile);
                const downloadURL = await snapshot.ref.getDownloadURL();

                // 2. Generate Correct Document ID (Same as Admin Panel)
                const d = new Date(dateVal);
                const mNum = d.getMonth(); // 0-11
                const yNum = d.getFullYear();
                
                // Admin Panel Logic ke hisab se ID: UserID_Year_Month
                // Note: monthKey format YYYY-MM rakhenge display ke liye
                const monthKey = `${yNum}-${String(mNum+1).padStart(2,'0')}`;
                
                // ID Format: "UID_YEAR_MONTHNUM" (Admin panel yahi read karta hai)
                const reportDocId = `${globalUserId}_${yNum}_${mNum}`;

                // 3. Prepare Entry Object
                const newEntry = {
                    id: Date.now().toString(),
                    jamiaName: jamiaData.jamiaName,
                    teacherName: selectedTeacher.name,
                    className: className,
                    kitabName: bookName,
                    date: dateVal,
                    url: downloadURL,
                    fileName: fileName,
                    tasurat: "",       // Admin bharega
                    adminTasurat: "",  // Zimmedar bharega
                    uploadedBy: "TeacherPortal",
                    createdAt: new Date().toISOString()
                };

                const reportRef = db.collection('monthly_reports').doc(reportDocId);

                // 4. Save to Firestore (Check if doc exists first)
                const docSnap = await reportRef.get();

                if (docSnap.exists) {
                    // Agar Doc hai, to array me naya item JOD dein (ArrayUnion)
                    await reportRef.update({
                        "tadrisRecording.data": firebase.firestore.FieldValue.arrayUnion(newEntry)
                    });
                } else {
                    // Agar Doc nahi hai, to naya banayein (Sahi UserID ke saath)
                    await reportRef.set({
                        userId: globalUserId, // Admin ka ID
                        month: d.toLocaleString('default', { month: 'long' }),
                        monthNum: mNum,
                        year: yNum,
                        monthKey: monthKey,
                        academicYear: activeYearGlobal,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        tadrisRecording: {
                            status: "Pending",
                            data: [newEntry]
                        }
                    });
                }

                // Success
                status.innerText = "✅ ریکارڈنگ کامیابی سے محفوظ ہو گئی!";
                status.className = "text-center text-sm mt-3 font-bold text-green-600";
                btn.innerHTML = '<i class="fas fa-check"></i> محفوظ ہو گیا';

                setTimeout(() => {
                    resetRecording();
                    fileInput.value = "";
                    btn.innerHTML = '<span>محفوظ کریں (Save)</span> <i class="fas fa-cloud-upload-alt"></i>';
                    btn.disabled = false;
                    status.innerText = "";
                }, 3000);

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                btn.disabled = false;
                btn.innerHTML = 'محفوظ کریں (Save)';
                status.innerText = "❌ محفوظ کرنے میں خرابی پیش آئی۔";
                status.className = "text-center text-sm mt-3 font-bold text-red-600";
            }
        }

        function showError(msg) {
            document.getElementById('loading-screen').innerHTML = 
                `<p class="text-red-600 font-bold bg-red-50 p-4 rounded-lg border border-red-200">${msg}</p>`;
        }

    </script>
</body>

</html>


