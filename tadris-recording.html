<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tadris Recording – Majlis Talimi Umoor India (Patched)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @font-face {
      font-family: "Jameel Noori Nastaleeq";
      src: url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2")
          format("woff2"),
        url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff")
          format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF,
        U+FE70-FEFF;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: #f0f2f5;
    }
    .urdu-font {
      font-family: "Jameel Noori Nastaleeq", "Poppins", sans-serif;
      font-size: 1.05rem;
      line-height: 1.7;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #14b8a6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out,
        border-width 0.3s ease-out;
      padding-top: 0;
      padding-bottom: 0;
      border-top-width: 0;
    }
    .accordion-content.open {
      max-height: 1500px;
      transition: max-height 0.5s ease-in, padding 0.3s ease-in,
        border-width 0.3s ease-in;
      padding-top: 1rem;
      padding-bottom: 1rem;
      border-top-width: 1px;
    }
    .accordion-button svg {
      transition: transform 0.3s ease-out;
    }
    .accordion-button { cursor: pointer; }
    
    .accordion-button.open svg {
      transform: rotate(180deg);
    }
    .comment-display {
      background-color: #f9fafb;
      border-left: 3px solid #14b8a6;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 4px;
    }

    /* hide saved-recordings inside add tab */
    .hide-saved .saved-recordings-list,
    .hide-saved .download-tadris-pdf-btn,
    .hide-saved .save-user-admin-tasurat-btn,
    .hide-saved .comment-display {
      display: none !important;
    }
    .hide-saved .space-y-2.saved-recordings-list {
      margin: 0;
      padding: 0;
    }

    /* hide top controls and info cards when in saved tab */
    .hide-top-controls #top-controls,
    .hide-top-controls #info-cards {
      display: none !important;
    }

    /* small responsive */
    @media (max-width:640px){
      .urdu-font { font-size: 0.95rem; }
    }

  </style>
</head>
<body class="antialiased text-gray-800">
  <div
    id="notification"
    class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform translate-x-full hidden"
  ></div>

  <div
    id="loader"
    class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-40 flex justify-center items-center z-[70] hidden"
  >
    <div class="loader"></div>
  </div>

  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header
      class="bg-white rounded-2xl shadow-md px-4 py-3 md:px-6 md:py-4 mb-6 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <button
          id="back-btn"
          class="inline-flex items-center gap-2 text-sm md:text-base text-teal-700 hover:text-teal-900 font-medium"
        >
          <i class="fas fa-arrow-left text-xs"></i>
          <span>Back to Dashboard</span>
        </button>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-500 mb-1">Majlis Talimi Umoor India</p>
        <h1 class="text-lg md:text-2xl font-bold text-gray-800 urdu-font">
          Tadris Recording Panel
        </h1>
      </div>
    </header>

    <div class="flex gap-3 mb-5">
      <button id="tab-add" class="px-4 py-2 rounded-lg">Add Recording</button>
      <button id="tab-saved" class="px-4 py-2 rounded-lg">Saved Recordings</button>
    </div>

    <section id="top-controls" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-6 flex flex-col md:flex-row md:items-end gap-4">
      <div class="flex-1">
        <label class="block text-xs font-semibold text-gray-600 mb-1" for="month-input">Report Month Select Karein</label>
        <input type="month" id="month-input" class="w-full md:w-60 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500" />
        <p id="current-month-label" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <div class="flex-1 md:text-right">
        <p class="text-xs text-gray-500 mb-1">User</p>
        <p id="user-name-display" class="font-semibold text-gray-800 urdu-font text-base">Loading...</p>
        <p id="user-zimmedari-display" class="text-xs text-gray-500 urdu-font">...</p>
      </div>
    </section>

    <section id="info-cards" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-emerald-800 mb-2">Kaam ka Tarz</h2>
        <ul class="text-xs text-emerald-800 space-y-1 urdu-font">
          <li>• Har Jamia ke liye accordion open karein.</li>
          <li>• Teacher select karein, phir Class, phir Kitab select karein.</li>
          <li>• “Recording par Tasurat” me apna brief comment likhein.</li>
          <li>• “Add Recording” dabayen, entry save ho jayegi.</li>
        </ul>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-blue-800 mb-2">Saved Recordings</h2>
        <p class="text-xs text-blue-800 urdu-font">Neeche har Jamia ke neeche “Saved Recordings” list me purani recordings nazar aayengi. Wahan se:</p>
        <ul class="text-xs text-blue-800 space-y-1 urdu-font mt-1">
          <li>• Talimi Zimmedar ke tasurat update kar sakte hain.</li>
          <li>• Har entry ka PDF report download kar sakte hain.</li>
        </ul>
      </div>
      <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-amber-800 mb-2">Note</h2>
        <ul class="text-xs text-amber-800 space-y-1 urdu-font">
          <li>• Yeh page sirf Tadris Recording ke liye hai.</li>
          <li>• Data wahi <b>monthly_reports</b> me save hota hai.</li>
          <li>• Month badlenge to us month ki Tadris list show hogi.</li>
        </ul>
      </div>
    </section>

    <section id="tadris-main-section" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-gray-800 urdu-font">Jamia Wise Tadris Recording</h2>
        <span id="tadris-status-chip" class="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700">
          <span class="w-2 h-2 rounded-full bg-gray-400"></span>
          <span id="tadris-status-text">Loading...</span>
        </span>
      </div>

      <p id="tadris-loading-msg" class="text-center text-gray-500 text-sm mb-4">Loading Jamiaat...</p>
      <p id="tadris-no-data-msg" class="text-center text-red-500 text-sm mb-4 hidden">Academic Structure nahi mila. Pehle main app se setup karein.</p>

      <div id="tadris-accordion-container" class="space-y-4"></div>
    </section>

    <section id="saved-section" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10 hidden">
      <h2 class="text-lg font-semibold urdu-font mb-4">Saari Jamiaat ki Saved Recordings</h2>

      <div id="saved-filters" class="mb-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs text-gray-600 mb-1 urdu-font">Jamia</label>
          <select id="filter-jamia" class="w-full p-2 border rounded-lg text-sm urdu-font">
            <option value="">-- Sab Jamiaat --</option>
          </select>
        </div>

        <div>
          <label class="block text-xs text-gray-600 mb-1 urdu-font">Teacher</label>
          <input id="filter-teacher" type="text" placeholder="Teacher ka naam..." class="w-full p-2 border rounded-lg text-sm urdu-font" />
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-xs text-gray-600 mb-1 urdu-font">Date (From)</label>
            <input id="filter-date-from" type="date" class="w-full p-2 border rounded-lg text-sm" />
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1 urdu-font">Date (To)</label>
            <input id="filter-date-to" type="date" class="w-full p-2 border rounded-lg text-sm" />
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border">
         <thead class="bg-gray-100">
  <tr>
    <th class="border px-2 py-1">Jamia</th>
    <th class="border px-2 py-1">Class</th>
    <th class="border px-2 py-1">Kitab</th>
    <th class="border px-2 py-1">Teacher</th>
    <th class="border px-2 py-1">Date</th>
    <th class="border px-2 py-1">Mufattish ke Tasuraat</th>
    <th class="border px-2 py-1">Zimmedar Comment</th>
    <th class="border px-2 py-1">Status</th>
    <th class="border px-2 py-1">PDF</th>
  </tr>
</thead>
          <tbody id="saved-table-body"></tbody>
        </table>
      </div>
    </section>

  </div>

<!-- Zimmedar Comment Modal -->
<div id="zimmedarCommentModal" class="fixed inset-0 z-50 hidden items-center justify-center">
  <div class="absolute inset-0 bg-black opacity-50" id="zimmedarModalBackdrop"></div>
  <div class="relative bg-white rounded-lg shadow-lg max-w-lg w-11/12 p-4">
    <h3 class="text-lg font-semibold urdu-font mb-2">Zimmedar Comment</h3>
    <textarea id="zimmedarModalTextarea" rows="6" class="w-full p-2 border rounded urdu-font text-sm"></textarea>
    <div class="mt-3 flex justify-end gap-2">
      <button id="zimmedarModalCancel" class="px-3 py-1 rounded border text-sm">Cancel</button>
      <button id="zimmedarModalSave" class="px-3 py-1 rounded bg-teal-600 text-white text-sm">Save</button>
    </div>
  </div>
</div>
  
  <script type="module">
    // ============================
    // Firebase Imports
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ============================
    // Firebase Config (same as original)
    // ============================
    const firebaseConfig = {
      apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
      authDomain: "data-f15ab.firebaseapp.com",
      projectId: "data-f15ab",
      storageBucket: "data-f15ab.appspot.com",
      messagingSenderId: "449137002393",
      appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
      measurementId: "G-1PHNJQWNPZ",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ============================
    // DOM Helpers & Globals
    // ============================
    const loader = document.getElementById("loader");
    const notification = document.getElementById("notification");
    const monthInput = document.getElementById("month-input");
    const currentMonthLabel = document.getElementById("current-month-label");
    const userNameDisplay = document.getElementById("user-name-display");
    const userZimmedariDisplay = document.getElementById("user-zimmedari-display");
    const backBtn = document.getElementById("back-btn");
    const tadrisAccordionContainer = document.getElementById("tadris-accordion-container");
    const tadrisLoadingMsg = document.getElementById("tadris-loading-msg");
    const tadrisNoDataMsg = document.getElementById("tadris-no-data-msg");
    const tadrisStatusChip = document.getElementById("tadris-status-chip");
    const tadrisStatusText = document.getElementById("tadris-status-text");

    const tabAdd = document.getElementById("tab-add");
    const tabSaved = document.getElementById("tab-saved");
    const savedSection = document.getElementById("saved-section");
    const topControls = document.getElementById("top-controls");
    const infoCards = document.getElementById("info-cards");
    const mainSection = document.getElementById("tadris-accordion-container").closest("section");

    const showLoader = (show) => {
      if (!loader) return;
      loader.classList.toggle("hidden", !show);
    };

    const showNotification = (message, isError = false) => {
      if (!notification) return;
      notification.textContent = message;
      notification.className =
        "fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform " +
        (isError ? "bg-red-500" : "bg-emerald-600");
      notification.classList.remove("hidden", "translate-x-full");
      void notification.offsetWidth;
      setTimeout(() => {
        notification.classList.remove("translate-x-full");
      }, 10);
      setTimeout(() => {
        notification.classList.add("translate-x-full");
        setTimeout(() => notification.classList.add("hidden"), 300);
      }, 2500);
    };

    const getReportingInfoFromMonthInput = (inputValue) => {
      if (!inputValue) {
        const now = new Date();
        const m = now.getMonth();
        const y = now.getFullYear();
        const monthInputFormat =
          y + "-" + String(m + 1).padStart(2, "0");
        const monthName = now.toLocaleString("default", { month: "long" });
        return {
          monthNum: m,
          yearNum: y,
          monthName,
          monthInputFormat,
        };
      }
      const [yearStr, monthStr] = inputValue.split("-");
      const yearNum = parseInt(yearStr);
      const monthNum = parseInt(monthStr) - 1;
      const date = new Date(yearNum, monthNum, 1);
      const monthName = date.toLocaleString("default", { month: "long" });
      return {
        monthNum,
        yearNum,
        monthName,
        monthInputFormat: inputValue,
      };
    };

    // ============================
    // PDF logic (kept as before)
    // ============================
    window.handleDownloadTadrisPDF = async function(e) {
      const btn = e && e.currentTarget ? e.currentTarget : (e && e.target ? e.target : null);
      if (!btn) return;
      
      const jamiaName = btn.dataset.jamiaName || "N/A";
      const teacherName = btn.dataset.teacherName || btn.dataset.teacher || "N/A";
      const className = btn.dataset.className || btn.dataset.class || "";
      const kitabName = btn.dataset.kitabName || btn.dataset.kitab || "";
      const date = btn.dataset.date || "";
      const tasuratAdmin = decodeURIComponent(btn.dataset.tasurat || "") || "Koi comment nahi diya gaya.";
      
      // Try to find the user comment textarea if available in the same container
      let tasuratZimmedar = "";
      const container = btn.closest('div.p-3') || btn.closest('tr') || btn.closest('.saved-recordings-list');
      if (container) {
          const textArea = container.querySelector('.user-admin-tasurat-input');
          if (textArea) {
              tasuratZimmedar = textArea.value;
          }
      }
      if(!tasuratZimmedar) tasuratZimmedar = "Koi comment darj nahi kiya gaya.";

      showLoader(true);

      try {
        const pdfContentHTML = `
          <div style="padding:20px;font-family:Poppins,sans-serif;direction:rtl;text-align:right;border:1px solid #ccc;max-width:700px;margin:0 auto;line-height:1.5;color:#333;">
            <h2 style="text-align:center;color:#14b8a6;border-bottom:2px solid #14b8a6;padding-bottom:10px;margin-bottom:20px;font-size:1.5rem;font-weight:700;">
              Majlis Talimi Umoor India - Tadris Recording Report
            </h2>
            <div style="margin-top:15px;font-size:1rem;text-align:center;">
              <p style="margin-bottom:5px;">
                <strong>Jamia:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${jamiaName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Teacher ka Naam:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${teacherName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Class/Kitab:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${className} - ${kitabName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Date:</strong>
                <span>${date}</span>
              </p>
            </div>

            <div style="margin-top:20px;padding:15px;border:1px dashed #14b8a6;background-color:#f0fdfa;">
              <p style="font-weight:600;color:#0f766e;margin-bottom:5px;">Recording par Tasurat (Admin ka diya hua):</p>
              <p style="font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:1.1rem;margin:0;">${tasuratAdmin}</p>
            </div>

            <div style="margin-top:20px;padding:15px;border:1px dashed #60a5fa;background-color:#eff6ff;">
              <p style="font-weight:600;color:#2563eb;margin-bottom:5px;">Talimi Zimmedar Ke Tasurat (Aapka Comment):</p>
              <p style="font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:1.1rem;margin:0;">${tasuratZimmedar}</p>
            </div>

            <div style="margin-top:30px;padding-top:15px;border-top:1px solid #ccc;">
              <p style="font-weight:600;color:#4b5563;margin-bottom:10px;">Teacher Ke Comments (Print ke baad likhne ke liye):</p>
              <div style="height:120px;border:1px solid #9ca3af;background-color:#fff;padding:5px;"></div>
            </div>

            <div style="display:flex;justify-content:space-around;margin-top:40px;text-align:center;">
              <div style="width:40%;border-top:1px solid #000;padding-top:5px;">
                <p style="font-weight:600;">Talimi Zimmedar ke Dastakhat (Signature)</p>
              </div>
              <div style="width:40%;border-top:1px solid #000;padding-top:5px;">
                <p style="font-weight:600;">Teacher ke Dastakhat (Signature)</p>
              </div>
            </div>
            <p style="text-align:center;margin-top:20px;font-size:0.8rem;color:#6b7280;">
              *** Report generated on: ${new Date().toLocaleDateString()} ***
            </p>
          </div>
        `;

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = pdfContentHTML;
        tempDiv.style.position = "absolute";
        tempDiv.style.left = "-9999px";
        document.body.appendChild(tempDiv);

        const canvas = await window.html2canvas(tempDiv, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
        });
        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: "a4",
        });

        const imgProps = docPdf.getImageProperties(imgData);
        const pdfWidth = docPdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        docPdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        docPdf.save(
          `Tadris_Report_${teacherName.replace(/\s/g, "_")}_${date}.pdf`
        );

        document.body.removeChild(tempDiv);
        showNotification("PDF successfully downloaded!");
      } catch (err) {
        console.error("Error generating Tadris PDF:", err);
        showNotification("PDF generate karne me error.", true);
      } finally {
        showLoader(false);
      }
    };

    // ============================
    // Teaching Structure Loader
    // ============================
    window.JAMIA_TEACHER_MAP = {};
    window.JAMIA_CLASS_MAP = {};
    window.KARKARDAGI_STRUCTURE = [];

    async function loadTeachingStructureFromUserDoc(user) {
      try {
        window.JAMIA_TEACHER_MAP = window.JAMIA_TEACHER_MAP || {};
        window.JAMIA_CLASS_MAP = window.JAMIA_CLASS_MAP || {};
        Object.keys(window.JAMIA_TEACHER_MAP).forEach(k => delete window.JAMIA_TEACHER_MAP[k]);
        Object.keys(window.JAMIA_CLASS_MAP).forEach(k => delete window.JAMIA_CLASS_MAP[k]);

        const uid = (user && user.uid) ? user.uid : (typeof auth !== 'undefined' && auth.currentUser ? auth.currentUser.uid : null);
        let karkardagi = [];

        if (uid) {
          try {
            const userDocRef = doc(db, "users", uid);
            const userSnap = await getDoc(userDocRef);
            if (userSnap.exists()) {
              const userData = userSnap.data() || {};
              const info = (typeof getReportingInfoFromMonthInput === 'function') ? getReportingInfoFromMonthInput(monthInput.value) : null;
              const academicYear = info ? (info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum+1}` : `${info.yearNum-1}-${info.yearNum}`) : null;

              if (academicYear && userData.academicYears && userData.academicYears[academicYear] && Array.isArray(userData.academicYears[academicYear].karkardagiStructure)) {
                karkardagi = userData.academicYears[academicYear].karkardagiStructure;
              } else if (Array.isArray(userData.karkardagiStructure) && userData.karkardagiStructure.length) {
                karkardagi = userData.karkardagiStructure;
              } else if (Array.isArray(userData.academicStructure) && userData.academicStructure.length) {
                karkardagi = userData.academicStructure;
              }
            }
          } catch (e) {
            console.warn("Error loading per-user karkardagi:", e);
          }
        }

        if (!Array.isArray(karkardagi) || karkardagi.length === 0) {
          try {
            const info2 = (typeof getReportingInfoFromMonthInput === 'function') ? getReportingInfoFromMonthInput(monthInput.value) : null;
            const academicYear2 = info2 ? (info2.monthNum >= 3 ? `${info2.yearNum}-${info2.yearNum+1}` : `${info2.yearNum-1}-${info2.yearNum}`) : "2025-2026";
            const kRef = doc(db, "karkardagiStructure", academicYear2);
            const kSnap = await getDoc(kRef);
            if (kSnap.exists()) {
              const data = kSnap.data() || {};
              karkardagi = Array.isArray(data.structure) ? data.structure : (Array.isArray(data.karkardagiStructure) ? data.karkardagiStructure : []);
            }
          } catch (e) {
            console.warn("Error loading global karkardagiStructure:", e);
          }
        }

        window.KARKARDAGI_STRUCTURE = karkardagi || [];

        (karkardagi || []).forEach(jamiaObj => {
          const jamiaName = (jamiaObj.jamiaName || jamiaObj.name || jamiaObj.jamia || "").toString();
          if (!jamiaName) return;

          window.JAMIA_TEACHER_MAP[jamiaName] = window.JAMIA_TEACHER_MAP[jamiaName] || {};
          window.JAMIA_CLASS_MAP[jamiaName] = window.JAMIA_CLASS_MAP[jamiaName] || {};

          let teachers = Array.isArray(jamiaObj.teachers) ? jamiaObj.teachers : (Array.isArray(jamiaObj.ustads) ? jamiaObj.ustads : []);
          if (teachers && typeof teachers === 'object' && !Array.isArray(teachers)) {
            const temp = [];
            Object.keys(teachers).forEach(k => temp.push(teachers[k]));
            teachers = temp;
          }

          (teachers || []).forEach(t => {
            if (!t) return;
            const teacherName = (t.name || t.teacherName || t.ustad || t.fullName || "").toString();
            const periods = Array.isArray(t.periods) ? t.periods : (Array.isArray(t.classes) ? t.classes : []);
            if (!teacherName) return;

            window.JAMIA_TEACHER_MAP[jamiaName][teacherName] = window.JAMIA_TEACHER_MAP[jamiaName][teacherName] || [];

            (periods || []).forEach(p => {
              const className = p.className || p.class || p.darja || "";
              const bookName = p.bookName || p.book || p.kitab || p.subject || "";
              if (!className || !bookName) return;

              window.JAMIA_TEACHER_MAP[jamiaName][teacherName].push({ className, bookName });
              window.JAMIA_CLASS_MAP[jamiaName][className] = window.JAMIA_CLASS_MAP[jamiaName][className] || [];
              window.JAMIA_CLASS_MAP[jamiaName][className].push({ teacherName, bookName });
            });
          });
        });
        return;
      } catch (err) {
        console.error("loadTeachingStructureFromUserDoc error:", err);
      }
    }

    // ============================
    // Global State
    // ============================
    let currentUser = null;
    let userProfileData = {};
    let allReports = [];
    let currentReport = {};
    let reportRef = null;

    tadrisAccordionContainer.classList.add("hide-saved");

    // back button
    backBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });

    // init app on auth
    onAuthStateChanged(auth, async (user) => {
      showLoader(true);
      if (!user) {
        showLoader(false);
        showNotification("Please login first (main page).", true);
        window.location.href = "index.html";
        return;
      }
      currentUser = user;

      try {
        const userDocRef = doc(db, "users", user.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          userProfileData = snap.data();
          userNameDisplay.textContent = userProfileData.name || "N/A";
          userZimmedariDisplay.textContent = userProfileData.zimmedari || userProfileData.role || "N/A";
        } else {
          showNotification("User profile nahi mila.", true);
        }

        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        const prevMonthInput = lastMonth.getFullYear() + "-" + String(lastMonth.getMonth() + 1).padStart(2, "0");
        monthInput.value = prevMonthInput;
        updateMonthLabel();

        const reportsRef = collection(db, "monthly_reports");
        const qReports = query(reportsRef, where("userId", "==", user.uid));

        onSnapshot(qReports, (snapshot) => {
            allReports = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
            renderForCurrentMonth();
          },
          (err) => {
            console.error("Error loading reports:", err);
            showNotification("Reports load nahi ho paaye.", true);
          }
        );
      } catch (err) {
        console.error(err);
        showNotification("Error loading user data.", true);
      } finally {
        showLoader(false);
      }
    });

    monthInput.addEventListener("change", async () => {
      updateMonthLabel();
      if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);
      renderForCurrentMonth();
    });

    function updateMonthLabel() {
      const info = getReportingInfoFromMonthInput(monthInput.value);
      currentMonthLabel.textContent = `Report for: ${info.monthName} ${info.yearNum}`;
    }

    // ============================
    // Helpers: escapeHtml
    // ============================
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return "";
      return String(unsafe)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ============================
    // Replace your existing saveNewRecordingToReport with this version
async function saveNewRecordingToReport(payload) {
  if (!reportRef) {
    throw new Error("Report reference not ready.");
  }

  // read existing document
  const docSnap = await getDoc(reportRef);
  const existing = docSnap.exists() ? docSnap.data() : {};
  const arr = Array.isArray(existing.tadrisRecording?.data) ? existing.tadrisRecording.data.slice() : [];

  // Use client-side ISO timestamp (safe inside arrays)
  const clientTsISO = new Date().toISOString();

  const toSave = Object.assign({
    id: `local-${Date.now()}`,
    jamiaName: payload.jamiaName || payload.jamia || "",
    teacherName: payload.teacherName || payload.teacher || "",
    className: payload.className || payload.class || "",
    kitabName: payload.kitabName || payload.kitab || "",
    date: payload.date || clientTsISO.slice(0,10),
    tasurat: payload.tasurat || "",
    adminTasurat: payload.adminTasurat || "",
    createdAt: clientTsISO
  }, payload);

  arr.push(toSave);

  const status = existing.tadrisRecording?.status || "Pending";

  // Save back (merge ensures no accidental overwrite of other top-level fields)
  await setDoc(reportRef, { tadrisRecording: { data: arr, status } }, { merge: true });

  return toSave;
}

    // ============================
    // Render Tadris layout for month (main)
    // ============================
    let renderForCurrentMonth = async function() {
      if (!tadrisAccordionContainer) return;
      showLoader(true);
      tadrisAccordionContainer.innerHTML = "";
      tadrisLoadingMsg.classList.remove("hidden");
      tadrisNoDataMsg.classList.add("hidden");

      try {
        if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);

        const { report, ref, meta } = getCurrentReportForSelectedMonth();
        reportRef = ref;
        currentReport = report;

        const academicData = (Array.isArray(window.KARKARDAGI_STRUCTURE) && window.KARKARDAGI_STRUCTURE.length)
          ? window.KARKARDAGI_STRUCTURE
          : (Array.isArray(userProfileData.academicStructure) ? userProfileData.academicStructure : []);

        if (!academicData.length) {
          tadrisLoadingMsg.classList.add("hidden");
          tadrisNoDataMsg.classList.remove("hidden");
          tadrisStatusText.textContent = "No Academic Structure";
          tadrisStatusChip.className = "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-red-50 text-red-700";
          showLoader(false);
          return;
        }

        await ensureReportBaseFields(reportRef, meta);

        const existingSnap = await getDoc(reportRef);
        const existingData = existingSnap.exists() ? existingSnap.data() : {};
        const tadrisData = existingData.tadrisRecording?.data || [];
        const tadrisStatus = existingData.tadrisRecording?.status || "Pending";

        if (tadrisStatus === "Done" && tadrisData.length > 0) {
          tadrisStatusText.textContent = "Done";
          tadrisStatusChip.className = "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-emerald-50 text-emerald-700";
        } else if (tadrisData.length > 0) {
          tadrisStatusText.textContent = "Partially Filled";
          tadrisStatusChip.className = "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-sky-50 text-sky-700";
        } else {
          tadrisStatusText.textContent = "Pending";
          tadrisStatusChip.className = "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700";
        }

        tadrisLoadingMsg.classList.add("hidden");
        tadrisAccordionContainer.innerHTML = "";

        academicData.forEach((jamia, index) => {
          try {
            const jamiaName = jamia.jamiaName || jamia.name || `Jamia #${index + 1}`;
            const jamiaSaved = tadrisData.filter((r) => r.jamiaName === jamiaName);

            const accordionItem = document.createElement("div");
            accordionItem.className = "border border-gray-200 rounded-xl overflow-hidden bg-gray-50 jamia-card";

            const header = document.createElement("button");
            header.type = "button";
            header.className = "accordion-button w-full flex items-center justify-between px-4 md:px-5 py-3 bg-white hover:bg-slate-50";
            header.innerHTML = `
              <div class="flex items-center gap-3">
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-teal-100 text-teal-700 text-sm font-semibold">
                  ${index + 1}
                </span>
                <div class="text-left">
                  <p class="font-semibold text-gray-800 urdu-font jamia-title">${escapeHtml(jamiaName)}</p>
                  <p class="text-[11px] text-gray-500">Classes: ${jamia.classes ? Object.keys(jamia.classes).length : 0} | Saved Recordings: ${jamiaSaved.length}</p>
                </div>
              </div>
              <div class="flex items-center gap-2 text-xs text-gray-500">
                <span class="hidden sm:inline">Details dekhein</span>
                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
                </svg>
              </div>
            `;

            const content = document.createElement("div");
            content.className = "accordion-content border-t border-gray-200 bg-gray-50";

            const savedHTML = jamiaSaved.length
              ? jamiaSaved.map((rec, i) => {
                  const adminComment = rec.tasurat || "-";
                  const userComment = rec.adminTasurat || "";
                  const recId = `tadris-rec-${index}-${i}`;
                  return `
                    <div
                      class="p-3 bg-white rounded-lg border border-gray-200 text-xs md:text-sm space-y-2"
                      id="${recId}"
                      data-jamia-name="${escapeHtml(rec.jamiaName || '')}"
                      data-date="${escapeHtml(rec.date || '')}"
                      data-teacher-name="${escapeHtml(rec.teacherName || '')}"
                      data-class-name="${escapeHtml(rec.className || '')}"
                      data-kitab-name="${escapeHtml(rec.kitabName || '')}"
                      data-tasurat="${encodeURIComponent(adminComment)}"
                    >
                      <p class="urdu-font font-semibold">
                        ${escapeHtml(rec.className || '')} – ${escapeHtml(rec.kitabName || '')}
                        <span class="text-[11px] text-gray-500">(${escapeHtml(rec.teacherName || '')}, ${escapeHtml(rec.date || '')})</span>
                      </p>

                      <div>
                        <p class="text-[11px] font-semibold text-gray-600 urdu-font">Recording par Tasurat (Admin ka diya hua):</p>
                        <p class="urdu-font">${escapeHtml(adminComment)}</p>
                      </div>

                      <div class="comment-display">
                        <label class="block text-[11px] font-medium text-gray-600 urdu-font">
                          Talimi Zimmedar Ke Tasurat (Aapka Comment):
                        </label>
                        <textarea
                          rows="2"
                          class="user-admin-tasurat-input w-full mt-1 p-2 border rounded-lg urdu-font text-xs"
                          data-jamia="${encodeURIComponent(rec.jamiaName||'')}"
                          data-date="${rec.date || ''}"
                          data-teacher="${encodeURIComponent(rec.teacherName||'')}"
                        >${escapeHtml(userComment)}</textarea>
                        <button
                          type="button"
                          class="save-user-admin-tasurat-btn mt-2 w-full sm:w-auto px-3 py-1 rounded-lg text-xs font-semibold bg-teal-600 hover:bg-teal-700 text-white"
                        >
                          Save Comment
                        </button>
                      </div>

                      <button
                        type="button"
                        class="download-tadris-pdf-btn mt-2 w-full sm:w-auto px-3 py-1 rounded-lg text-xs font-semibold bg-red-600 hover:bg-red-700 text-white"
                        data-record-id="${recId}"
                        data-jamia-name="${escapeHtml(rec.jamiaName || '')}"
                        data-date="${escapeHtml(rec.date || '')}"
                        data-teacher-name="${escapeHtml(rec.teacherName || '')}"
                        data-class-name="${escapeHtml(rec.className || '')}"
                        data-kitab-name="${escapeHtml(rec.kitabName || '')}"
                        data-tasurat="${encodeURIComponent(adminComment)}"
                      >
                        <i class="fas fa-file-pdf mr-1"></i>
                        Report PDF Download Karein
                      </button>
                    </div>
                  `;
                }).join("")
              : `<p class="text-xs text-gray-500">Is Jamia ke liye abhi koi recording save nahi hui hai.</p>`;

            content.innerHTML = `
              <div class="p-4 md:p-5 space-y-4">
                <div class="space-y-3 bg-white rounded-xl shadow-sm p-3 md:p-4 border border-gray-200">
                  <h3 class="text-sm md:text-base font-semibold text-gray-800 urdu-font mb-1">
                    Nayi Recording Add Karein
                  </h3>
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div>
                      <label class="block text-[11px] font-medium text-gray-600 mb-1">Teacher ka Naam</label>
                      <select class="tadris-teacher-select w-full p-2 border rounded-lg bg-white text-xs urdu-font" data-jamia-name="${escapeHtml(jamiaName)}">
                        <option value="">Select Teacher</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-[11px] font-medium text-gray-600 mb-1">Class</label>
                      <select class="tadris-class-select w-full p-2 border rounded-lg bg-white text-xs urdu-font" disabled>
                        <option value="">Select Teacher First</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-[11px] font-medium text-gray-600 mb-1">Kitab</label>
                      <select class="tadris-kitab-select w-full p-2 border rounded-lg bg-white text-xs urdu-font" disabled>
                        <option value="">Select Class First</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-[11px] font-medium text-gray-600 mb-1">Date</label>
                      <input type="date" class="tadris-date w-full p-2 border rounded-lg text-xs" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1 urdu-font">
                      Recording par Tasurat (Admin ka comment)
                    </label>
                    <textarea
                      rows="3"
                      class="tadris-tasurat w-full p-2 border rounded-lg text-xs urdu-font"
                      placeholder="Yahan recording par apna comment likhein..."
                    ></textarea>
                  </div>
                  <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
                    <button
                      type="button"
                      class="add-tadris-entry-btn px-4 py-2 rounded-lg text-xs font-semibold bg-emerald-600 hover:bg-emerald-700 text-white"
                      data-jamia-name="${escapeHtml(jamiaName)}"
                      data-action="add-recording"
                    >
                      <i class="fas fa-plus mr-1"></i>
                      Add Recording
                    </button>
                  </div>
                </div>

                <div>
                  <h4 class="text-sm font-semibold text-gray-700 mb-2 urdu-font">Saved Recordings</h4>
                  <div class="space-y-2 saved-recordings-list">
                    ${savedHTML}
                  </div>
                </div>
              </div>
            `;

            accordionItem.appendChild(header);
            accordionItem.appendChild(content);
            tadrisAccordionContainer.appendChild(accordionItem);

            // populate teacher -> class -> kitab selects for this card
            const teacherSelect = content.querySelector(".tadris-teacher-select");
            const classSelect = content.querySelector(".tadris-class-select");
            const kitabSelect = content.querySelector(".tadris-kitab-select");
            
            const jamiaTeachers = (window.JAMIA_TEACHER_MAP && window.JAMIA_TEACHER_MAP[jamiaName]) ? window.JAMIA_TEACHER_MAP[jamiaName] : {};
            const teacherList = Object.keys(jamiaTeachers || {});
            
            if (teacherSelect) {
              teacherList.forEach(t => {
                const opt = document.createElement("option");
                opt.value = t;
                opt.textContent = t;
                teacherSelect.appendChild(opt);
              });

              teacherSelect.onchange = function () {
                const selectedT = this.value;
                if (!classSelect) return;
                classSelect.innerHTML = `<option value="">Select Class</option>`;
                kitabSelect.innerHTML = `<option value="">Select Kitab</option>`;
                kitabSelect.disabled = true;

                if (!selectedT || !jamiaTeachers[selectedT]) {
                  classSelect.disabled = true;
                  return;
                }

                const classes = (jamiaTeachers[selectedT] || []).map(p => p.className).filter(Boolean);
                const uniqueClasses = Array.from(new Set(classes));
                uniqueClasses.forEach(cls => {
                  const o = document.createElement("option");
                  o.value = cls;
                  o.textContent = cls;
                  classSelect.appendChild(o);
                });
                classSelect.disabled = false;
              };
            }

            if (classSelect) {
              classSelect.onchange = function () {
                const selectedT = teacherSelect ? teacherSelect.value : "";
                const selectedC = this.value;
                if (!kitabSelect) return;
                kitabSelect.innerHTML = `<option value="">Select Kitab</option>`;
                if (!selectedT || !selectedC || !jamiaTeachers[selectedT]) {
                  kitabSelect.disabled = true;
                  return;
                }
                const books = (jamiaTeachers[selectedT] || []).filter(p => p.className === selectedC).map(p => p.bookName).filter(Boolean);
                const uniqueBooks = Array.from(new Set(books));
                uniqueBooks.forEach(b => {
                  const o = document.createElement("option");
                  o.value = b;
                  o.textContent = b;
                  kitabSelect.appendChild(o);
                });
                kitabSelect.disabled = uniqueBooks.length === 0;
              };
            }

            // attach PDF buttons already present in savedHTML
            content.querySelectorAll(".download-tadris-pdf-btn").forEach((btn) => {
              btn.addEventListener('click', window.handleDownloadTadrisPDF);
            });

          } catch (err) {
            console.error("render jamia error:", err);
          }
        }); 

        populateJamiaFilterOptions();
      } catch (err) {
        console.error("renderForCurrentMonth error:", err);
      } finally {
        showLoader(false);
      }
    };

    // ============================
    // Ensure report base
    // ============================
    function getCurrentReportForSelectedMonth() {
      if (!currentUser) return { report: {}, ref: null };

      const { monthNum, yearNum, monthName, monthInputFormat } = getReportingInfoFromMonthInput(monthInput.value);
      const academicYear = monthNum >= 3 ? `${yearNum}-${yearNum + 1}` : `${yearNum - 1}-${yearNum}`;
      const simpleId = `${currentUser.uid}_${yearNum}_${monthNum}`;
      const withYearId = `${currentUser.uid}_${academicYear}_${yearNum}_${monthNum}`;

      let found = allReports.find((r) => r.id === withYearId) || allReports.find((r) => r.id === simpleId);

      if (found) {
        return {
          report: found,
          ref: doc(db, "monthly_reports", found.id),
          meta: { monthNum, yearNum, academicYear, monthName, monthInputFormat },
        };
      }

      const newRef = doc(db, "monthly_reports", withYearId);
      return {
        report: {},
        ref: newRef,
        meta: { monthNum, yearNum, academicYear, monthName, monthInputFormat },
      };
    }

    async function ensureReportBaseFields(ref, meta) {
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
            userId: currentUser.uid,
            month: meta.monthName,
            year: meta.yearNum,
            academicYear: meta.academicYear,
            monthNum: meta.monthNum,
            monthKey: meta.monthInputFormat,
            createdAt: serverTimestamp(),
          }, { merge: true });
      } else {
        const data = snap.data() || {};
        if (!data.monthKey) {
          await updateDoc(ref, { monthKey: meta.monthInputFormat });
        }
      }
    }

    // ============================
    // Saved table functions
    // ============================
    function fillSavedTable() {
      const table = document.getElementById("saved-table-body");
      table.innerHTML = "";

      const { report } = getCurrentReportForSelectedMonth();
      const data = Array.isArray(report?.tadrisRecording?.data) ? [...report.tadrisRecording.data] : [];

      if (!data.length) {
        table.innerHTML = `
          <tr>
            <td colspan="8" class="text-center p-3 text-gray-500">
              Is month ki koi recording save nahi hai.
            </td>
          </tr>`;
        return;
      }

      data.sort((a, b) => {
        const da = new Date(a.date).getTime() || 0;
        const db = new Date(b.date).getTime() || 0;
        if (db !== da) return db - da;
        return 0;
      });

      data.forEach((rec, idx) => {
        const rowId = `saved-row-${idx}`;
        const adminComment = rec.tasurat || "-";
        const zimmedarComment = rec.adminTasurat || "";

        // helper: map status keys to readable Urdu labels
function statusLabelMap(key) {
  if (!key) return null;
  if (key === 'OfficePahunchGayi') return 'Recording Office Ko Pahunch Gayi Hai';
  if (key === 'MufattishPahunchGayi') return 'Recording Mufattish ke paas Pahunch Gayi hai';
  return key;
}

// helper: format possible timestamp (Firestore {seconds}) or ISO string
function formatPossibleTimestamp(ts) {
  if (!ts) return null;
  try {
    if (typeof ts === 'string') {
      const d = new Date(ts);
      if (!isNaN(d.getTime())) return d.toLocaleString();
      return ts;
    }
    if (typeof ts === 'object' && ts.seconds) {
      return new Date(ts.seconds * 1000).toLocaleString();
    }
    if (ts.toDate && typeof ts.toDate === 'function') {
      return ts.toDate().toLocaleString();
    }
    const d = new Date(ts);
    if (!isNaN(d.getTime())) return d.toLocaleString();
  } catch (e) {}
  return String(ts);
}

// inside data.forEach((rec, idx) => {
const statusHtml = (() => {

  // 1) Agar admin ne Mufattish Comment fill kiya → DATE show karein
  if (rec.tasuratDate) {
    return `<span class="text-sm text-gray-700">Comment: ${formatPossibleTimestamp(rec.tasuratDate)}</span>`;
  }

  // 2) Agar adminStatus diya hai → Status show karein
  if (rec.adminStatus) {
    return `<span class="text-sm font-semibold text-emerald-700">
        ${escapeHtml(statusLabelMap(rec.adminStatus))}
    </span>`;
  }

  // 3) Agar koi status/comment nahi → Pending show karein
  return `<span class="text-sm text-gray-500">Pending</span>`;
})();


        table.insertAdjacentHTML("beforeend", `
  <tr id="${rowId}" class="saved-data-row">
    <td class="border px-2 py-1 urdu-font">${escapeHtml(rec.jamiaName || "")}</td>
    <td class="border px-2 py-1 urdu-font">${escapeHtml(rec.className || "")}</td>
    <td class="border px-2 py-1 urdu-font">${escapeHtml(rec.kitabName || "")}</td>
    <td class="border px-2 py-1 urdu-font">${escapeHtml(rec.teacherName || "")}</td>
    <td class="border px-2 py-1">${escapeHtml(rec.date || "")}</td>

    <td class="border px-2 py-1 urdu-font">${escapeHtml(rec.tasurat || "-")}</td>

    <td class="border px-2 py-1 urdu-font">
      <div class="zimmedar-comment-cell cursor-pointer p-1 text-xs"
           data-idx="${idx}"
           data-jamia="${encodeURIComponent(rec.jamiaName||'')}"
           data-teacher="${encodeURIComponent(rec.teacherName||'')}"
           data-date="${rec.date || ''}"
           data-class="${encodeURIComponent(rec.className||'')}"
           data-kitab="${encodeURIComponent(rec.kitabName||'')}"
           title="Click karke comment edit karein"
      >${zimmedarComment ? escapeHtml(zimmedarComment) : '<span class="text-gray-500">[Add comment]</span>'}</div>
    </td>

    <td class="border px-2 py-1">
      ${statusHtml}
    </td>

    <td class="border px-2 py-1 text-center">
      <button class="saved-download-btn text-red-600 underline text-xs"
        data-row-id="${rowId}"
        data-jamia-name="${encodeURIComponent(rec.jamiaName || '')}"
        data-teacher-name="${encodeURIComponent(rec.teacherName || '')}"
        data-date="${rec.date || ''}"
        data-class-name="${encodeURIComponent(rec.className || '')}"
        data-kitab-name="${encodeURIComponent(rec.kitabName || '')}"
        data-tasurat="${encodeURIComponent(rec.tasurat || '')}"
      >PDF</button>
    </td>
  </tr>
`);
      });

      attachSavedDownloadHandlers();
      attachSavedFiltersListeners();
      attachSavedCommentClickHandlers();
    }

    // saved table helpers
    function attachSavedCommentClickHandlers() {
      document.querySelectorAll(".zimmedar-comment-cell").forEach(cell => {
        if (cell._zimmedarAttached) return;
        cell._zimmedarAttached = true;

        cell.addEventListener("click", (e) => {
          const el = e.currentTarget;
          const idx = parseInt(el.dataset.idx, 10);
          const jamia = decodeURIComponent(el.dataset.jamia || "");
          const teacher = decodeURIComponent(el.dataset.teacher || "");
          const dt = el.dataset.date || "";
          const cls = decodeURIComponent(el.dataset.class || "");
          const kitab = decodeURIComponent(el.dataset.kitab || "");
          const currentText = (el.textContent || "").trim();
          openCommentModal({
            idx,
            jamia,
            teacher,
            date: dt,
            className: cls,
            kitab,
            currentText: currentText === "[Add comment]" ? "" : currentText,
            cellElement: el
          });
        });
      });
    }

    function attachSavedDownloadHandlers() {
      document.querySelectorAll(".saved-download-btn").forEach(btn => {
        if (btn._savedDownloadAttached) return;
        btn._savedDownloadAttached = true;

        btn.addEventListener("click", (e) => {
          try {
            window.handleDownloadTadrisPDF({ currentTarget: btn });
          } catch (err) {
            console.error("Saved download handler error:", err);
          }
        });
      });
    }

    function attachSavedFiltersListeners() {
      if (attachSavedFiltersListeners._attached) return;
      attachSavedFiltersListeners._attached = true;

      const jamiaSel = document.getElementById("filter-jamia");
      const teacherInput = document.getElementById("filter-teacher");
      const dateFrom = document.getElementById("filter-date-from");
      const dateTo = document.getElementById("filter-date-to");

      const applyFilters = () => {
        fillSavedTable();
      };

      jamiaSel?.addEventListener("change", applyFilters);
      teacherInput?.addEventListener("input", applyFilters);
      dateFrom?.addEventListener("change", applyFilters);
      dateTo?.addEventListener("change", applyFilters);
    }

    // ============================
    // Save admin comment implementation (used by modal)
    // ============================
    async function saveAdminComment(itemIndex, commentValue, textareaEl = null, modalContext = null) {
      if (!reportRef) throw new Error("Report reference missing.");
      const snap = await getDoc(reportRef);
      if (!snap.exists()) throw new Error("Report doc not found.");

      const data = snap.data() || {};
      const arr = Array.isArray(data.tadrisRecording?.data) ? data.tadrisRecording.data : [];

      if (typeof itemIndex === "number" && itemIndex >= 0 && itemIndex < arr.length) {
        arr[itemIndex].adminTasurat = commentValue;
      } else {
        let jamia="", teacher="", dt="", cls="", kitab="";
        if (textareaEl) {
          jamia = decodeURIComponent(textareaEl.dataset.jamia || "");
          teacher = decodeURIComponent(textareaEl.dataset.teacher || "");
          dt = textareaEl.dataset.date || "";
          cls = decodeURIComponent(textareaEl.dataset.class || "");
          kitab = decodeURIComponent(textareaEl.dataset.kitab || "");
        } else if (modalContext) {
          jamia = modalContext.jamia || "";
          teacher = modalContext.teacher || "";
          dt = modalContext.date || "";
          cls = modalContext.className || "";
          kitab = modalContext.kitab || "";
        }

        const foundIdx = arr.findIndex(r =>
          (r.jamiaName||"") === jamia &&
          (r.teacherName||"") === teacher &&
          (r.date||"") === dt &&
          (r.className||"") === cls &&
          (r.kitabName||"") === kitab
        );
        if (foundIdx >= 0) {
    arr[foundIdx].tasurat = commentValue;

    if (commentValue) {
        arr[foundIdx].tasuratDate = serverTimestamp();   // ← date save
    } else {
        delete arr[foundIdx].tasuratDate;                // ← delete if blank
    }
}

if (typeof itemIndex === "number" && itemIndex >= 0 && itemIndex < arr.length) {
  arr[itemIndex].adminTasurat = commentValue;
  if (commentValue) arr[itemIndex].tasuratDate = serverTimestamp();
  else delete arr[itemIndex].tasuratDate;
}

      const existingStatus = data.tadrisRecording?.status || "Pending";
      await setDoc(reportRef, { tadrisRecording: { data: arr, status: existingStatus } }, { merge: true });
    }

    // ============================
    // Modal handling
    // ============================
    const modalEl = document.getElementById("zimmedarCommentModal");
    const modalTextarea = document.getElementById("zimmedarModalTextarea");
    const modalSaveBtn = document.getElementById("zimmedarModalSave");
    const modalCancelBtn = document.getElementById("zimmedarModalCancel");
    const modalBackdrop = document.getElementById("zimmedarModalBackdrop");
    let _currentModalContext = null;

    function openCommentModal(ctx) {
      _currentModalContext = ctx;
      modalTextarea.value = ctx.currentText || "";
      modalEl.classList.remove("hidden");
      modalEl.style.display = "flex";
      modalTextarea.focus();
    }

    function closeCommentModal() {
      _currentModalContext = null;
      modalEl.classList.add("hidden");
      modalEl.style.display = "none";
      modalTextarea.value = "";
    }

    modalBackdrop?.addEventListener?.("click", closeCommentModal);
    modalCancelBtn?.addEventListener?.("click", closeCommentModal);

    modalSaveBtn?.addEventListener?.("click", async () => {
      if (!_currentModalContext) return;
      const newVal = modalTextarea.value.trim();
      modalSaveBtn.disabled = true;
      modalSaveBtn.textContent = "Saving...";
      try {
        await saveAdminComment(_currentModalContext.idx, newVal, null, _currentModalContext);
        const cell = _currentModalContext.cellElement;
        if (cell) {
          cell.innerHTML = newVal ? escapeHtml(newVal) : '<span class="text-gray-500">[Add comment]</span>';
        }
        showNotification("Zimmedar comment successfully saved.");
        closeCommentModal();
      } catch (err) {
        console.error("Modal save error:", err);
        showNotification("Comment save failed.", true);
      } finally {
        modalSaveBtn.disabled = false;
        modalSaveBtn.textContent = "Save";
      }
    });

    // ============================
    // Tabs + accordion (allows multiple open)
    // ============================
    function setActiveTab(isAdd) {
      if (isAdd) {
        mainSection.classList.remove("hidden");
        savedSection.classList.add("hidden");
        tadrisAccordionContainer.classList.add("hide-saved");
        document.body.classList.remove("hide-top-controls");
        tabAdd.classList.add("bg-teal-600", "text-white");
        tabSaved.classList.remove("bg-teal-600", "text-white");
      } else {
        mainSection.classList.add("hidden");
        savedSection.classList.remove("hidden");
        tadrisAccordionContainer.classList.remove("hide-saved");
        document.body.classList.add("hide-top-controls");
        tabSaved.classList.add("bg-teal-600", "text-white");
        tabAdd.classList.remove("bg-teal-600", "text-white");
        fillSavedTable();
      }
    }

    tabAdd.addEventListener("click", () => setActiveTab(true));
    tabSaved.addEventListener("click", () => setActiveTab(false));

    tadrisAccordionContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('.accordion-button');
      if (!btn) return;
      const content = btn.nextElementSibling;
      const isOpen = btn.classList.toggle('open');
      if (content) {
        if (isOpen) {
          content.classList.add('open');
          content.style.maxHeight = content.scrollHeight + 30 + 'px';
        } else {
          content.classList.remove('open');
          content.style.maxHeight = null;
        }
      }
    });

    setActiveTab(true);

    // ============================
    // Delegated Add Recording handler (per-card)
    // ============================
    (function installDelegatedAddRecordingHandler() {
      if (window._delegatedAddRecordingInstalled) return;
      window._delegatedAddRecordingInstalled = true;

      document.body.addEventListener('click', async function (ev) {
        const btn = ev.target.closest('button.add-tadris-entry-btn, button[data-action="add-recording"]');
        if (!btn) return;
        ev.preventDefault?.();

        // find nearest card container
        const card = btn.closest('.jamia-card') || btn.closest('.accordion-content') || document;

        const jamiaName = btn.dataset.jamiaName || btn.getAttribute('data-jamia-name') || card.querySelector('.jamia-title')?.textContent?.trim() || "";
        const teacherEl = card.querySelector('select.tadris-teacher-select');
        const classEl = card.querySelector('select.tadris-class-select');
        const kitabEl = card.querySelector('select.tadris-kitab-select');
        const dateEl = card.querySelector('input.tadris-date');
        const tasuratEl = card.querySelector('textarea.tadris-tasurat');

        const teacher = teacherEl?.value || "";
        const className = classEl?.value || "";
        const kitab = kitabEl?.value || "";
        const date = dateEl?.value || "";
        const tasurat = tasuratEl?.value || "";

        console.log('AddRecording click — found values:', { jamiaName, teacher, className, kitab, date, tasurat });

        if (!jamiaName || !teacher) {
          alert('Jamia aur Teacher select karen. (Please select Jamia & Teacher)');
          return;
        }

        const payload = {
          jamiaName: jamiaName,
          teacherName: teacher,
          className: className,
          kitabName: kitab,
          date: date,
          tasurat: tasurat,
          createdBy: currentUser?.uid || null
        };

        showLoader(true);
        try {
          // Attempt save to Firestore (reportRef)
          try {
            const saved = await saveNewRecordingToReport(payload);
            showNotification('Recording server par save ho gayi.');
            // re-render to show new saved entry
            // trigger re-render by refetching current doc via onSnapshot already set
            // but we can also call renderForCurrentMonth to reflect instantly
            setTimeout(() => renderForCurrentMonth(), 800);
          } catch (err) {
            console.warn('Firestore save failed, falling back to localStorage:', err);
            // fallback localStorage
            const key = 'saved_recordings_demo';
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            existing.push(Object.assign({ id: Date.now() }, payload));
            localStorage.setItem(key, JSON.stringify(existing));
            showNotification('Server save available nahi — entry browser me local saved hui.', true);
          }
        } catch (err) {
          console.error('Add recording handler error:', err);
          showNotification('Recording save karne me error. Console check karein.', true);
        } finally {
          showLoader(false);
        }

      }, { capture: false });
    })();

    // ============================
    // populateJamiaFilterOptions fallback
    // ============================
    if (typeof populateJamiaFilterOptions !== 'function') {
      window.populateJamiaFilterOptions = function populateJamiaFilterOptions() {
        try {
          const sourceList = window.KARKARDAGI_STRUCTURE || null;
          const selectEl = document.getElementById('filter-jamia') || null;
          if (!selectEl) {
            console.warn('Jamia filter select not found (#filter-jamia).');
            return;
          }
          const firstOption = selectEl.querySelector('option:first-child');
          selectEl.innerHTML = '';
          if (firstOption) selectEl.appendChild(firstOption);

          if (Array.isArray(sourceList) && sourceList.length) {
            sourceList.forEach(j => {
              const name = j.jamiaName || j.name || j.title || String(j);
              const opt = document.createElement('option');
              opt.value = name;
              opt.textContent = name;
              selectEl.appendChild(opt);
            });
            return;
          }

          const jamiaNodes = document.querySelectorAll('.jamia-title');
          const seen = new Set();
          jamiaNodes.forEach(node => {
            const text = node.textContent.trim();
            if (!text) return;
            if (seen.has(text)) return;
            seen.add(text);
            const opt = document.createElement('option');
            opt.value = text;
            opt.textContent = text;
            selectEl.appendChild(opt);
          });

        } catch (err) {
          console.error('populateJamiaFilterOptions error:', err);
        }
      };
    }

    // ============================
    // Safe initial render call
    // ============================
    // renderForCurrentMonth will be called by onSnapshot when reports load; but if needed call once
    (async () => {
      try {
        if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);
        // safe call (it will re-run after auth & snapshot)
        // renderForCurrentMonth();
      } catch(e) {}
    })();


  </script>
</body>
</html>




