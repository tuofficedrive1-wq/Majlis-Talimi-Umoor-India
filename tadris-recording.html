<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tadris Recording – Majlis Talimi Umoor India</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- jsPDF + html2canvas (PDF ke liye) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @font-face {
      font-family: "Jameel Noori Nastaleeq";
      src: url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2")
          format("woff2"),
        url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff")
          format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF,
        U+FE70-FEFF;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: #f0f2f5;
    }
    .urdu-font {
      font-family: "Jameel Noori Nastaleeq", "Poppins", sans-serif;
      font-size: 1.05rem;
      line-height: 1.7;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #14b8a6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out,
        border-width 0.3s ease-out;
      padding-top: 0;
      padding-bottom: 0;
      border-top-width: 0;
    }
    .accordion-content.open {
      max-height: 1500px;
      transition: max-height 0.5s ease-in, padding 0.3s ease-in,
        border-width 0.3s ease-in;
      padding-top: 1rem;
      padding-bottom: 1rem;
      border-top-width: 1px;
    }
    .accordion-button svg {
      transition: transform 0.3s ease-out;
    }
    .accordion-button { cursor: pointer; }
    
    .accordion-button.open svg {
      transform: rotate(180deg);
    }
    .comment-display {
      background-color: #f9fafb;
      border-left: 3px solid #14b8a6;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 4px;
    }

    /* hide saved-recordings inside add tab */
    .hide-saved .saved-recordings-list,
    .hide-saved .download-tadris-pdf-btn,
    .hide-saved .save-user-admin-tasurat-btn,
    .hide-saved .comment-display {
      display: none !important;
    }
    .hide-saved .space-y-2.saved-recordings-list {
      margin: 0;
      padding: 0;
    }

    /* hide top controls and info cards when in saved tab */
    .hide-top-controls #top-controls,
    .hide-top-controls #info-cards {
      display: none !important;
    }

    /* small responsive */
    @media (max-width:640px){
      .urdu-font { font-size: 0.95rem; }
    }

  </style>
</head>
<body class="antialiased text-gray-800">
  <!-- Notification -->
  <div
    id="notification"
    class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform translate-x-full hidden"
  ></div>

  <!-- Loader -->
  <div
    id="loader"
    class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-40 flex justify-center items-center z-[70] hidden"
  >
    <div class="loader"></div>
  </div>

  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header
      class="bg-white rounded-2xl shadow-md px-4 py-3 md:px-6 md:py-4 mb-6 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <button
          id="back-btn"
          class="inline-flex items-center gap-2 text-sm md:text-base text-teal-700 hover:text-teal-900 font-medium"
        >
          <i class="fas fa-arrow-left text-xs"></i>
          <span>Back to Dashboard</span>
        </button>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-500 mb-1">Majlis Talimi Umoor India</p>
        <h1 class="text-lg md:text-2xl font-bold text-gray-800 urdu-font">
          Tadris Recording Panel
        </h1>
      </div>
    </header>

    <!-- TAB Buttons -->
    <div class="flex gap-3 mb-5">
      <button id="tab-add" class="px-4 py-2 rounded-lg">Add Recording</button>
      <button id="tab-saved" class="px-4 py-2 rounded-lg">Saved Recordings</button>
    </div>

    <!-- Top Controls (month, user) -->
    <section id="top-controls" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-6 flex flex-col md:flex-row md:items-end gap-4">
      <div class="flex-1">
        <label class="block text-xs font-semibold text-gray-600 mb-1" for="month-input">Report Month Select Karein</label>
        <input type="month" id="month-input" class="w-full md:w-60 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500" />
        <p id="current-month-label" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <div class="flex-1 md:text-right">
        <p class="text-xs text-gray-500 mb-1">User</p>
        <p id="user-name-display" class="font-semibold text-gray-800 urdu-font text-base">Loading...</p>
        <p id="user-zimmedari-display" class="text-xs text-gray-500 urdu-font">...</p>
      </div>
    </section>

    <!-- Info / Help (three cards) -->
    <section id="info-cards" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-emerald-800 mb-2">Kaam ka Tarz</h2>
        <ul class="text-xs text-emerald-800 space-y-1 urdu-font">
          <li>• Har Jamia ke liye accordion open karein.</li>
          <li>• Teacher select karein, phir Class, phir Kitab select karein.</li>
          <li>• “Recording par Tasurat” me apna brief comment likhein.</li>
          <li>• “Add Recording” dabayen, entry save ho jayegi.</li>
        </ul>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-blue-800 mb-2">Saved Recordings</h2>
        <p class="text-xs text-blue-800 urdu-font">Neeche har Jamia ke neeche “Saved Recordings” list me purani recordings nazar aayengi. Wahan se:</p>
        <ul class="text-xs text-blue-800 space-y-1 urdu-font mt-1">
          <li>• Talimi Zimmedar ke tasurat update kar sakte hain.</li>
          <li>• Har entry ka PDF report download kar sakte hain.</li>
        </ul>
      </div>
      <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-amber-800 mb-2">Note</h2>
        <ul class="text-xs text-amber-800 space-y-1 urdu-font">
          <li>• Yeh page sirf Tadris Recording ke liye hai.</li>
          <li>• Data wahi <b>monthly_reports</b> me save hota hai.</li>
          <li>• Month badlenge to us month ki Tadris list show hogi.</li>
        </ul>
      </div>
    </section>

    <!-- Main Tadris Accordion -->
    <section id="tadris-main-section" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-gray-800 urdu-font">Jamia Wise Tadris Recording</h2>
        <span id="tadris-status-chip" class="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700">
          <span class="w-2 h-2 rounded-full bg-gray-400"></span>
          <span id="tadris-status-text">Loading...</span>
        </span>
      </div>

      <p id="tadris-loading-msg" class="text-center text-gray-500 text-sm mb-4">Loading Jamiaat...</p>
      <p id="tadris-no-data-msg" class="text-center text-red-500 text-sm mb-4 hidden">Academic Structure nahi mila. Pehle main app se setup karein.</p>

      <div id="tadris-accordion-container" class="space-y-4"></div>
    </section>

    <!-- Saved Section (hidden by default) -->
    <section id="saved-section" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10 hidden">
      <h2 class="text-lg font-semibold urdu-font mb-4">Saari Jamiaat ki Saved Recordings</h2>

      <!-- Filters -->
      <div id="saved-filters" class="mb-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs text-gray-600 mb-1 urdu-font">Jamia</label>
          <select id="filter-jamia" class="w-full p-2 border rounded-lg text-sm urdu-font">
            <option value="">-- Sab Jamiaat --</option>
          </select>
        </div>

        <div>
          <label class="block text-xs text-gray-600 mb-1 urdu-font">Teacher</label>
          <input id="filter-teacher" type="text" placeholder="Teacher ka naam..." class="w-full p-2 border rounded-lg text-sm urdu-font" />
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-xs text-gray-600 mb-1 urdu-font">Date (From)</label>
            <input id="filter-date-from" type="date" class="w-full p-2 border rounded-lg text-sm" />
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1 urdu-font">Date (To)</label>
            <input id="filter-date-to" type="date" class="w-full p-2 border rounded-lg text-sm" />
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">Jamia</th>
              <th class="border px-2 py-1">Class</th>
              <th class="border px-2 py-1">Kitab</th>
              <th class="border px-2 py-1">Teacher</th>
              <th class="border px-2 py-1">Date</th>
              <th class="border px-2 py-1">Admin Comment</th>
              <th class="border px-2 py-1">Zimmedar Comment</th>
              <th class="border px-2 py-1">PDF</th>
            </tr>
          </thead>
          <tbody id="saved-table-body"></tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    // ============================
    // Firebase Imports
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, query, where, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ============================
    // Firebase Config
    // ============================
    const firebaseConfig = {
      apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
      authDomain: "data-f15ab.firebaseapp.com",
      projectId: "data-f15ab",
      storageBucket: "data-f15ab.appspot.com",
      messagingSenderId: "449137002393",
      appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
      measurementId: "G-1PHNJQWNPZ",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ============================
    // DOM Helpers
    // ============================
    const loader = document.getElementById("loader");
    const notification = document.getElementById("notification");
    const monthInput = document.getElementById("month-input");
    const currentMonthLabel = document.getElementById("current-month-label");
    const userNameDisplay = document.getElementById("user-name-display");
    const userZimmedariDisplay = document.getElementById("user-zimmedari-display");
    const backBtn = document.getElementById("back-btn");
    const tadrisAccordionContainer = document.getElementById("tadris-accordion-container");
    const tadrisLoadingMsg = document.getElementById("tadris-loading-msg");
    const tadrisNoDataMsg = document.getElementById("tadris-no-data-msg");
    const tadrisStatusChip = document.getElementById("tadris-status-chip");
    const tadrisStatusText = document.getElementById("tadris-status-text");

    const tabAdd = document.getElementById("tab-add");
    const tabSaved = document.getElementById("tab-saved");
    const savedSection = document.getElementById("saved-section");
    const topControls = document.getElementById("top-controls");
    const infoCards = document.getElementById("info-cards");
    const mainSection = document.getElementById("tadris-accordion-container").closest("section");

    const showLoader = (show) => {
      if (!loader) return;
      loader.classList.toggle("hidden", !show);
    };

    const showNotification = (message, isError = false) => {
      if (!notification) return;
      notification.textContent = message;
      notification.className =
        "fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform " +
        (isError ? "bg-red-500" : "bg-emerald-600");
      notification.classList.remove("hidden", "translate-x-full");
      void notification.offsetWidth;
      setTimeout(() => {
        notification.classList.remove("translate-x-full");
      }, 10);
      setTimeout(() => {
        notification.classList.add("translate-x-full");
        setTimeout(() => notification.classList.add("hidden"), 300);
      }, 2500);
    };

    const getReportingInfoFromMonthInput = (inputValue) => {
      if (!inputValue) {
        const now = new Date();
        const m = now.getMonth();
        const y = now.getFullYear();
        const monthInputFormat =
          y + "-" + String(m + 1).padStart(2, "0");
        const monthName = now.toLocaleString("default", { month: "long" });
        return {
          monthNum: m,
          yearNum: y,
          monthName,
          monthInputFormat,
        };
      }
      const [yearStr, monthStr] = inputValue.split("-");
      const yearNum = parseInt(yearStr);
      const monthNum = parseInt(monthStr) - 1;
      const date = new Date(yearNum, monthNum, 1);
      const monthName = date.toLocaleString("default", { month: "long" });
      return {
        monthNum,
        yearNum,
        monthName,
        monthInputFormat: inputValue,
      };
    };


    // ======= SAFETY FALLBACK: handleDownloadTadrisPDF =======
    // Prevent ReferenceError when download handler is missing.
    if (typeof window.handleDownloadTadrisPDF !== 'function') {
      window.handleDownloadTadrisPDF = async function(e) {
        console.warn("Fallback handleDownloadTadrisPDF called");
        try {
          const btn = e && e.currentTarget ? e.currentTarget : (e && e.target ? e.target : null);
          // If button provides HTML content via data attribute, open it
          if (btn && btn.dataset && btn.dataset.tadrisHtml) {
            const w = window.open('', '_blank');
            w.document.write(btn.dataset.tadrisHtml);
            w.document.close();
            return;
          }
          // Fallback: open active accordion content
          const active = document.querySelector('.accordion-content.open') || document.querySelector('.accordion-content') || document.querySelector('#tadris-accordion-container');
          if (active) {
            const w = window.open('', '_blank');
            w.document.write('<html><head><title>Tadris Report</title></head><body>' + active.outerHTML + '</body></html>');
            w.document.close();
            return;
          }
          alert('Download temporarily unavailable.');
        } catch (err) {
          console.error('Fallback handleDownloadTadrisPDF error:', err);
        }
      };
    }
    // ============================
    // New: Load teaching structure same as jaiza-form's source
    // We'll build two maps per jamia:
    //  - JAMIA_CLASS_MAP[jamiaName] = { className: [{teacherName, bookName}, ...], ... }
    //  - JAMIA_TEACHER_MAP[jamiaName] = { teacherName: [{className, bookName}, ...], ... }
    // ============================
    const JAMIA_CLASS_MAP = {};
    const JAMIA_TEACHER_MAP = {};

    async function loadTeachingStructureFromUserDoc(user) {
  try {
    // reset maps
    window.JAMIA_TEACHER_MAP = window.JAMIA_TEACHER_MAP || {};
    window.JAMIA_CLASS_MAP = window.JAMIA_CLASS_MAP || {};
    Object.keys(window.JAMIA_TEACHER_MAP).forEach(k => delete window.JAMIA_TEACHER_MAP[k]);
    Object.keys(window.JAMIA_CLASS_MAP).forEach(k => delete window.JAMIA_CLASS_MAP[k]);

    // decide uid (prefer passed user, else auth.currentUser)
    const uid = (user && user.uid) ? user.uid : (typeof auth !== 'undefined' && auth.currentUser ? auth.currentUser.uid : null);
    let karkardagi = [];

    // 1) Try per-user locations first
    if (uid) {
      try {
        const userDocRef = doc(db, "users", uid);
        const userSnap = await getDoc(userDocRef);
        if (userSnap.exists()) {
          const userData = userSnap.data() || {};
          // prefer academicYears -> karkardagiStructure if available for selected year
          const info = (typeof getReportingInfoFromMonthInput === 'function') ? getReportingInfoFromMonthInput(monthInput.value) : null;
          const academicYear = info ? (info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum+1}` : `${info.yearNum-1}-${info.yearNum}`) : null;

          if (academicYear && userData.academicYears && userData.academicYears[academicYear] && Array.isArray(userData.academicYears[academicYear].karkardagiStructure)) {
            karkardagi = userData.academicYears[academicYear].karkardagiStructure;
            console.log("Loaded per-user karkardagi from users/{uid}.academicYears", uid, academicYear);
          } else if (Array.isArray(userData.karkardagiStructure) && userData.karkardagiStructure.length) {
            karkardagi = userData.karkardagiStructure;
            console.log("Loaded per-user karkardagi from users/{uid}.karkardagiStructure", uid);
          } else if (Array.isArray(userData.academicStructure) && userData.academicStructure.length) {
            karkardagi = userData.academicStructure;
            console.log("Loaded per-user karkardagi from users/{uid}.academicStructure", uid);
          } else {
            console.log("No per-user karkardagi found for uid:", uid);
          }
        } else {
          console.log("User doc missing for uid:", uid);
        }
      } catch (e) {
        console.warn("Error loading per-user karkardagi:", e);
      }
    } else {
      console.log("No uid available; skipping per-user load.");
    }

    // 2) Fallback: global collection karkardagiStructure/<year>
    if (!Array.isArray(karkardagi) || karkardagi.length === 0) {
      try {
        const info2 = (typeof getReportingInfoFromMonthInput === 'function') ? getReportingInfoFromMonthInput(monthInput.value) : null;
        const academicYear2 = info2 ? (info2.monthNum >= 3 ? `${info2.yearNum}-${info2.yearNum+1}` : `${info2.yearNum-1}-${info2.yearNum}`) : "2025-2026";
        const kRef = doc(db, "karkardagiStructure", academicYear2);
        const kSnap = await getDoc(kRef);
        if (kSnap.exists()) {
          const data = kSnap.data() || {};
          karkardagi = Array.isArray(data.structure) ? data.structure : (Array.isArray(data.karkardagiStructure) ? data.karkardagiStructure : []);
          console.log("Loaded global karkardagiStructure from collection:", academicYear2, "count:", (karkardagi||[]).length);
        } else {
          console.log("Global karkardagiStructure doc not found:", academicYear2);
        }
      } catch (e) {
        console.warn("Error loading global karkardagiStructure:", e);
      }
    }

    // keep for render function
    window.KARKARDAGI_STRUCTURE = karkardagi || [];

    // Build JAMIA_TEACHER_MAP & JAMIA_CLASS_MAP from karkardagi array
    (karkardagi || []).forEach(jamiaObj => {
      const jamiaName = (jamiaObj.jamiaName || jamiaObj.name || jamiaObj.jamia || "").toString();
      if (!jamiaName) return;

      window.JAMIA_TEACHER_MAP[jamiaName] = window.JAMIA_TEACHER_MAP[jamiaName] || {};
      window.JAMIA_CLASS_MAP[jamiaName] = window.JAMIA_CLASS_MAP[jamiaName] || {};

      // teachers array (or ustads)
      let teachers = Array.isArray(jamiaObj.teachers) ? jamiaObj.teachers : (Array.isArray(jamiaObj.ustads) ? jamiaObj.ustads : []);
      if (teachers && typeof teachers === 'object' && !Array.isArray(teachers)) {
        // convert keyed object to array (if somebody stored as object)
        const temp = [];
        Object.keys(teachers).forEach(k => temp.push(teachers[k]));
        teachers = temp;
      }

      (teachers || []).forEach(t => {
        if (!t) return;
        const teacherName = (t.name || t.teacherName || t.ustad || t.fullName || "").toString();
        const periods = Array.isArray(t.periods) ? t.periods : (Array.isArray(t.classes) ? t.classes : []);
        if (!teacherName) return;

        window.JAMIA_TEACHER_MAP[jamiaName][teacherName] = window.JAMIA_TEACHER_MAP[jamiaName][teacherName] || [];

        (periods || []).forEach(p => {
          const className = p.className || p.class || p.darja || "";
          const bookName = p.bookName || p.book || p.kitab || p.subject || "";
          if (!className || !bookName) return;

          window.JAMIA_TEACHER_MAP[jamiaName][teacherName].push({ className, bookName });
          window.JAMIA_CLASS_MAP[jamiaName][className] = window.JAMIA_CLASS_MAP[jamiaName][className] || [];
          window.JAMIA_CLASS_MAP[jamiaName][className].push({ teacherName, bookName });
        });
      });

      // also check periods/classes directly under jamiaObj
      const periodsRoot = Array.isArray(jamiaObj.periods) ? jamiaObj.periods : (Array.isArray(jamiaObj.classes) ? jamiaObj.classes : []);
      (periodsRoot || []).forEach(p => {
        const className = p.className || p.class || p.darja || "";
        const bookName = p.bookName || p.book || p.kitab || p.subject || "";
        const teacherName = (p.teacherName || p.teacher || p.ustad || "").toString() || "";
        if (!className || !bookName) return;
        if (teacherName) {
          window.JAMIA_TEACHER_MAP[jamiaName][teacherName] = window.JAMIA_TEACHER_MAP[jamiaName][teacherName] || [];
          window.JAMIA_TEACHER_MAP[jamiaName][teacherName].push({ className, bookName });
        } else {
          const fakeKey = `ClassOnly::${className}`;
          window.JAMIA_TEACHER_MAP[jamiaName][fakeKey] = window.JAMIA_TEACHER_MAP[jamiaName][fakeKey] || [];
          window.JAMIA_TEACHER_MAP[jamiaName][fakeKey].push({ className, bookName });
        }
        window.JAMIA_CLASS_MAP[jamiaName][className] = window.JAMIA_CLASS_MAP[jamiaName][className] || [];
        window.JAMIA_CLASS_MAP[jamiaName][className].push({ teacherName, bookName });
      });

    });

    console.log("JAMIA_TEACHER_MAP loaded keys:", Object.keys(window.JAMIA_TEACHER_MAP || {}));
    return;
  } catch (err) {
    console.error("loadTeachingStructureFromUserDoc error:", err);
  }
}

    // ============================
    // Global State
    // ============================
    let currentUser = null;
    let userProfileData = {};
    let allReports = [];
    let currentReport = {};
    let reportRef = null;

    // default: hide saved inside accordion
    tadrisAccordionContainer.classList.add("hide-saved");

    // ============================
    // Back to Dashboard
    // ============================
    backBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });

    // ============================
    // Init App (Auth + Data)
    // ============================
    onAuthStateChanged(auth, async (user) => {
      showLoader(true);
      if (!user) {
        showLoader(false);
        showNotification("Please login first (main page).", true);
        window.location.href = "index.html";
        return;
      }
      currentUser = user;

      try {
        // --- User Profile ---
        const userDocRef = doc(db, "users", user.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          userProfileData = snap.data();

          userNameDisplay.textContent = userProfileData.name || "N/A";
          userZimmedariDisplay.textContent =
            userProfileData.zimmedari ||
            userProfileData.role ||
            "N/A";
        } else {
          showNotification("User profile nahi mila.", true);
        }

        // Month default: previous month
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        const prevMonthInput =
          lastMonth.getFullYear() +
          "-" +
          String(lastMonth.getMonth() + 1).padStart(2, "0");
        monthInput.value = prevMonthInput;
        updateMonthLabel();

        // Reports listener
        const reportsRef = collection(db, "monthly_reports");
        const qReports = query(
          reportsRef,
          where("userId", "==", user.uid)
        );

        onSnapshot(
          qReports,
          (snapshot) => {
            allReports = snapshot.docs.map((d) => ({
              id: d.id,
              ...d.data(),
            }));
            renderForCurrentMonth();
          },
          (err) => {
            console.error("Error loading reports for Tadris page:", err);
            showNotification("Reports load nahi ho paaye.", true);
          }
        );
      } catch (err) {
        console.error(err);
        showNotification("Error loading user data.", true);
      } finally {
        showLoader(false);
      }
    });

    monthInput.addEventListener("change", async () => {
      updateMonthLabel();
      // reload teaching structure for new month
      if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);
      renderForCurrentMonth();
    });

    function updateMonthLabel() {
      const info = getReportingInfoFromMonthInput(monthInput.value);
      currentMonthLabel.textContent = `Report for: ${info.monthName} ${info.yearNum}`;
    }

    // ============================
    // Pick Current Report Doc for Month
    // ============================
    function getCurrentReportForSelectedMonth() {
      if (!currentUser) return { report: {}, ref: null };

      const { monthNum, yearNum, monthName, monthInputFormat } =
        getReportingInfoFromMonthInput(monthInput.value);

      const academicYear =
        monthNum >= 3
          ? `${yearNum}-${yearNum + 1}`
          : `${yearNum - 1}-${yearNum}`;

      const simpleId = `${currentUser.uid}_${yearNum}_${monthNum}`;
      const withYearId = `${currentUser.uid}_${academicYear}_${yearNum}_${monthNum}`;

      let found =
        allReports.find((r) => r.id === withYearId) ||
        allReports.find((r) => r.id === simpleId);

      if (found) {
        return {
          report: found,
          ref: doc(db, "monthly_reports", found.id),
          meta: { monthNum, yearNum, academicYear, monthName, monthInputFormat },
        };
      }

      const newRef = doc(db, "monthly_reports", withYearId);
      return {
        report: {},
        ref: newRef,
        meta: { monthNum, yearNum, academicYear, monthName, monthInputFormat },
      };
    }

    async function ensureReportBaseFields(ref, meta) {
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(
          ref,
          {
            userId: currentUser.uid,
            month: meta.monthName,
            year: meta.yearNum,
            academicYear: meta.academicYear,
            monthNum: meta.monthNum,
            monthKey: meta.monthInputFormat,
            createdAt: serverTimestamp(),
          },
          { merge: true }
        );
      } else {
        const data = snap.data() || {};
        if (!data.monthKey) {
          await updateDoc(ref, {
            monthKey: meta.monthInputFormat,
          });
        }
      }
    }

    // ============================
    // Render Tadris layout for month
    // ============================
    async function renderForCurrentMonth() {
      if (!tadrisAccordionContainer) return;
      showLoader(true);
      tadrisAccordionContainer.innerHTML = "";
      tadrisLoadingMsg.classList.remove("hidden");
      tadrisNoDataMsg.classList.add("hidden");

      try {
        // load teaching structure from user doc (same source as jaiza-form)
        if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);

        const { report, ref, meta } = getCurrentReportForSelectedMonth();
        reportRef = ref;
        currentReport = report;

        const academicData = (Array.isArray(window.KARKARDAGI_STRUCTURE) && window.KARKARDAGI_STRUCTURE.length)
  ? window.KARKARDAGI_STRUCTURE
  : (Array.isArray(userProfileData.academicStructure) ? userProfileData.academicStructure : []);

        if (!academicData.length) {
          tadrisLoadingMsg.classList.add("hidden");
          tadrisNoDataMsg.classList.remove("hidden");
          tadrisStatusText.textContent = "No Academic Structure";
          tadrisStatusChip.className =
            "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-red-50 text-red-700";
          return;
        }

        await ensureReportBaseFields(reportRef, meta);

        const existingSnap = await getDoc(reportRef);
        const existingData = existingSnap.exists()
          ? existingSnap.data()
          : {};
        const tadrisData = existingData.tadrisRecording?.data || [];
        const tadrisStatus =
          existingData.tadrisRecording?.status || "Pending";

        if (tadrisStatus === "Done" && tadrisData.length > 0) {
          tadrisStatusText.textContent = "Done";
          tadrisStatusChip.className =
            "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-emerald-50 text-emerald-700";
        } else if (tadrisData.length > 0) {
          tadrisStatusText.textContent = "Partially Filled";
          tadrisStatusChip.className =
            "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-sky-50 text-sky-700";
        } else {
          tadrisStatusText.textContent = "Pending";
          tadrisStatusChip.className =
            "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700";
        }

        tadrisLoadingMsg.classList.add("hidden");
        tadrisAccordionContainer.innerHTML = "";

        academicData.forEach((jamia, index) => {
      try {
          const jamiaName = jamia.jamiaName || `Jamia #${index + 1}`;
          const jamiaSaved = tadrisData.filter(
            (r) => r.jamiaName === jamiaName
          );

          const accordionItem = document.createElement("div");
          accordionItem.className =
            "border border-gray-200 rounded-xl overflow-hidden bg-gray-50";

          const header = document.createElement("button");
          header.type = "button";
          header.className =
            "accordion-button w-full flex items-center justify-between px-4 md:px-5 py-3 bg-white hover:bg-slate-50";
          header.innerHTML = `
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-teal-100 text-teal-700 text-sm font-semibold">
                ${index + 1}
              </span>
              <div class="text-left">
                <p class="font-semibold text-gray-800 urdu-font">${jamiaName}</p>
                <p class="text-[11px] text-gray-500">Classes: ${
                  jamia.classes ? Object.keys(jamia.classes).length : 0
                } | Saved Recordings: ${jamiaSaved.length}</p>
              </div>
            </div>
            <div class="flex items-center gap-2 text-xs text-gray-500">
              <span class="hidden sm:inline">Details dekhein</span>
              <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          `;

          const content = document.createElement("div");
          content.className =
            "accordion-content border-t border-gray-200 bg-gray-50";

          const savedHTML = jamiaSaved.length
            ? jamiaSaved
                .map((rec, i) => {
                  const adminComment = rec.tasurat || "-";
                  const userComment = rec.adminTasurat || "";
                  const recId = `tadris-rec-${index}-${i}`;

                  return `
                  <div
                    class="p-3 bg-white rounded-lg border border-gray-200 text-xs md:text-sm space-y-2"
                    id="${recId}"
                    data-jamia-name="${rec.jamiaName}"
                    data-date="${rec.date}"
                    data-teacher-name="${rec.teacherName}"
                    data-class-name="${rec.className}"
                    data-kitab-name="${rec.kitabName}"
                    data-tasurat="${encodeURIComponent(adminComment)}"
                  >
                    <p class="urdu-font font-semibold">
                      ${rec.className} – ${rec.kitabName}
                      <span class="text-[11px] text-gray-500">(${rec.teacherName}, ${rec.date})</span>
                    </p>

                    <div>
                      <p class="text-[11px] font-semibold text-gray-600 urdu-font">Recording par Tasurat (Admin ka diya hua):</p>
                      <p class="urdu-font">${adminComment}</p>
                    </div>

                    <div class="comment-display">
                      <label class="block text-[11px] font-medium text-gray-600 urdu-font">
                        Talimi Zimmedar Ke Tasurat (Aapka Comment):
                      </label>
                      <textarea
                        rows="2"
                        class="user-admin-tasurat-input w-full mt-1 p-2 border rounded-lg urdu-font text-xs"
                        data-jamia-name="${rec.jamiaName}"
                        data-date="${rec.date}"
                        data-teacher-name="${rec.teacherName}"
                      >${userComment}</textarea>
                      <button
                        type="button"
                        class="save-user-admin-tasurat-btn mt-2 w-full sm:w-auto px-3 py-1 rounded-lg text-xs font-semibold bg-teal-600 hover:bg-teal-700 text-white"
                      >
                        Save Comment
                      </button>
                    </div>

                    <button
                      type="button"
                      class="download-tadris-pdf-btn mt-2 w-full sm:w-auto px-3 py-1 rounded-lg text-xs font-semibold bg-red-600 hover:bg-red-700 text-white"
                      data-record-id="${recId}"
                    >
                      <i class="fas fa-file-pdf mr-1"></i>
                      Report PDF Download Karein
                    </button>
                  </div>
                `;
                })
                .join("")
            : `<p class="text-xs text-gray-500">Is Jamia ke liye abhi koi recording save nahi hui hai.</p>`;

          content.innerHTML = `
            <div class="p-4 md:p-5 space-y-4">
              <div class="space-y-3 bg-white rounded-xl shadow-sm p-3 md:p-4 border border-gray-200">
                <h3 class="text-sm md:text-base font-semibold text-gray-800 urdu-font mb-1">
                  Nayi Recording Add Karein
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1">Teacher ka Naam</label>
                    <select
                      class="tadris-teacher-select w-full p-2 border rounded-lg bg-white text-xs urdu-font"
                      data-jamia-name="${jamiaName}"
                    >
                      <option value="">Select Teacher</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1">Class</label>
                    <select
                      class="tadris-class-select w-full p-2 border rounded-lg bg-white text-xs urdu-font"
                      disabled
                    >
                      <option value="">Select Teacher First</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1">Kitab</label>
                    <select
                      class="tadris-kitab-select w-full p-2 border rounded-lg bg-white text-xs urdu-font"
                      disabled
                    >
                      <option value="">Select Class First</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1">Date</label>
                    <input
                      type="date"
                      class="tadris-date w-full p-2 border rounded-lg text-xs"
                    />
                  </div>
                </div>
                <div>
                  <label class="block text-[11px] font-medium text-gray-600 mb-1 urdu-font">
                    Recording par Tasurat (Admin ka comment)
                  </label>
                  <textarea
                    rows="3"
                    class="tadris-tasurat w-full p-2 border rounded-lg text-xs urdu-font"
                    placeholder="Yahan recording par apna comment likhein..."
                  ></textarea>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
                  <button
                    type="button"
                    class="add-tadris-entry-btn px-4 py-2 rounded-lg text-xs font-semibold bg-emerald-600 hover:bg-emerald-700 text-white"
                    data-jamia-name="${jamiaName}"
                  >
                    <i class="fas fa-plus mr-1"></i>
                    Add Recording
                  </button>
                </div>
              </div>

              <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2 urdu-font">Saved Recordings</h4>
                <div class="space-y-2 saved-recordings-list">
                  ${savedHTML}
                </div>
              </div>
            </div>
          `;

          accordionItem.appendChild(header);
          accordionItem.appendChild(content);
          tadrisAccordionContainer.appendChild(accordionItem);

          // ---------- robust teacher population & handlers (replace existing block) ----------

// ---------- teacher/class/kitab population (robust) ----------
const teacherSelect = content.querySelector(".tadris-teacher-select");
const classSelect = content.querySelector(".tadris-class-select");
const kitabSelect = content.querySelector(".tadris-kitab-select");

// reset
if (teacherSelect) {
  teacherSelect.innerHTML = `<option value="">Select Teacher</option>`;
}
if (classSelect) {
  classSelect.innerHTML = `<option value="">Select Teacher First</option>`;
  classSelect.disabled = true;
}
if (kitabSelect) {
  kitabSelect.innerHTML = `<option value="">Select Class First</option>`;
  kitabSelect.disabled = true;
}

const jamiaTeachers = (window.JAMIA_TEACHER_MAP && window.JAMIA_TEACHER_MAP[jamiaName]) ? window.JAMIA_TEACHER_MAP[jamiaName] : {};

console.log("teachersList for jamia:", jamiaName);
console.log("teacherList keys:", teacherList);

if (teacherSelect) {
  teacherList.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    teacherSelect.appendChild(opt);
  });

  // attach handlers idempotently
  teacherSelect.onchange = function () {
    const selectedT = this.value;
    if (!classSelect) return;
    classSelect.innerHTML = `<option value="">Select Class</option>`;
    kitabSelect.innerHTML = `<option value="">Select Kitab</option>`;
    kitabSelect.disabled = true;

    if (!selectedT || !jamiaTeachers[selectedT]) {
      classSelect.disabled = true;
      return;
    }

    const classes = (jamiaTeachers[selectedT] || []).map(p => p.className).filter(Boolean);
    const uniqueClasses = Array.from(new Set(classes));
    uniqueClasses.forEach(cls => {
      const o = document.createElement("option");
      o.value = cls;
      o.textContent = cls;
      classSelect.appendChild(o);
    });
    classSelect.disabled = false;
  };
}

if (classSelect) {
  classSelect.onchange = function () {
    const selectedT = teacherSelect ? teacherSelect.value : "";
    const selectedC = this.value;
    if (!kitabSelect) return;
    kitabSelect.innerHTML = `<option value="">Select Kitab</option>`;
    if (!selectedT || !selectedC || !jamiaTeachers[selectedT]) {
      kitabSelect.disabled = true;
      return;
    }
    const books = (jamiaTeachers[selectedT] || []).filter(p => p.className === selectedC).map(p => p.bookName).filter(Boolean);
    const uniqueBooks = Array.from(new Set(books));
    uniqueBooks.forEach(b => {
      const o = document.createElement("option");
      o.value = b;
      o.textContent = b;
      kitabSelect.appendChild(o);
    });
    kitabSelect.disabled = uniqueBooks.length === 0;
  };
}
          ccontent
  .querySelectorAll(".download-tadris-pdf-btn")
  .forEach((btn) => {
    const fn = (typeof window.handleDownloadTadrisPDF === 'function') 
      ? window.handleDownloadTadrisPDF 
      : function(e){ console.warn('Download handler missing'); };
    btn.addEventListener('click', fn);
  });
      } catch (err) {
        console.error("renderForCurrentMonth Tadris error:", err);
        showNotification("Tadris data load karne me error.", true);
      } finally {
        showLoader(false);
      }

    // ============================
    // Add Entry (teacher -> class -> kitab flow)
    // ============================
    async function handleAddTadrisEntry(e) {
      e.preventDefault();
      if (!reportRef) {
        showNotification("Report reference missing.", true);
        return;
      }
      const button = e.currentTarget;
      const container = button.closest(".p-4");
      if (!container) return;

      
// ---------- teacher/class/kitab population (robust) ----------
const teacherSelect = content.querySelector(".tadris-teacher-select");
const classSelect = content.querySelector(".tadris-class-select");
const kitabSelect = content.querySelector(".tadris-kitab-select");

// reset
if (teacherSelect) {
  teacherSelect.innerHTML = `<option value="">Select Teacher</option>`;
}
if (classSelect) {
  classSelect.innerHTML = `<option value="">Select Teacher First</option>`;
  classSelect.disabled = true;
}
if (kitabSelect) {
  kitabSelect.innerHTML = `<option value="">Select Class First</option>`;
  kitabSelect.disabled = true;
}

const jamiaTeachers = (window.JAMIA_TEACHER_MAP && window.JAMIA_TEACHER_MAP[jamiaName]) ? window.JAMIA_TEACHER_MAP[jamiaName] : {};
const teacherList = Object.keys(jamiaTeachers || {});

console.log("teachersList for jamia:", jamiaName);
console.log("teacherList keys:", teacherList);

if (teacherSelect) {
  teacherList.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    teacherSelect.appendChild(opt);
  });

  // attach handlers idempotently
  teacherSelect.onchange = function () {
    const selectedT = this.value;
    if (!classSelect) return;
    classSelect.innerHTML = `<option value="">Select Class</option>`;
    kitabSelect.innerHTML = `<option value="">Select Kitab</option>`;
    kitabSelect.disabled = true;

    if (!selectedT || !jamiaTeachers[selectedT]) {
      classSelect.disabled = true;
      return;
    }

    const classes = (jamiaTeachers[selectedT] || []).map(p => p.className).filter(Boolean);
    const uniqueClasses = Array.from(new Set(classes));
    uniqueClasses.forEach(cls => {
      const o = document.createElement("option");
      o.value = cls;
      o.textContent = cls;
      classSelect.appendChild(o);
    });
    classSelect.disabled = false;
  };
}

if (classSelect) {
  classSelect.onchange = function () {
    const selectedT = teacherSelect ? teacherSelect.value : "";
    const selectedC = this.value;
    if (!kitabSelect) return;
    kitabSelect.innerHTML = `<option value="">Select Kitab</option>`;
    if (!selectedT || !selectedC || !jamiaTeachers[selectedT]) {
      kitabSelect.disabled = true;
      return;
    }
    const books = (jamiaTeachers[selectedT] || []).filter(p => p.className === selectedC).map(p => p.bookName).filter(Boolean);
    const uniqueBooks = Array.from(new Set(books));
    uniqueBooks.forEach(b => {
      const o = document.createElement("option");
      o.value = b;
      o.textContent = b;
      kitabSelect.appendChild(o);
    });
    kitabSelect.disabled = uniqueBooks.length === 0;
  };
}
dDiv.querySelector(".user-admin-tasurat-input").value.trim() || "Koi comment darj nahi kiya gaya.";

      showLoader(true);

      try {
        const pdfContentHTML = `
          <div style="padding:20px;font-family:Poppins,sans-serif;direction:rtl;text-align:right;border:1px solid #ccc;max-width:700px;margin:0 auto;line-height:1.5;color:#333;">
            <h2 style="text-align:center;color:#14b8a6;border-bottom:2px solid #14b8a6;padding-bottom:10px;margin-bottom:20px;font-size:1.5rem;font-weight:700;">
              Majlis Talimi Umoor India - Tadris Recording Report
            </h2>
            <div style="margin-top:15px;font-size:1rem;text-align:center;">
              <p style="margin-bottom:5px;">
                <strong>Jamia:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${jamiaName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Teacher ka Naam:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${teacherName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Class/Kitab:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${className} - ${kitabName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Date:</strong>
                <span>${date}</span>
              </p>
            </div>

            <div style="margin-top:20px;padding:15px;border:1px dashed #14b8a6;background-color:#f0fdfa;">
              <p style="font-weight:600;color:#0f766e;margin-bottom:5px;">Recording par Tasurat (Admin ka diya hua):</p>
              <p style="font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:1.1rem;margin:0;">${tasuratAdmin}</p>
            </div>

            <div style="margin-top:20px;padding:15px;border:1px dashed #60a5fa;background-color:#eff6ff;">
              <p style="font-weight:600;color:#2563eb;margin-bottom:5px;">Talimi Zimmedar Ke Tasurat (Aapka Comment):</p>
              <p style="font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:1.1rem;margin:0;">${tasuratZimmedar}</p>
            </div>

            <div style="margin-top:30px;padding-top:15px;border-top:1px solid #ccc;">
              <p style="font-weight:600;color:#4b5563;margin-bottom:10px;">Teacher Ke Comments (Print ke baad likhne ke liye):</p>
              <div style="height:120px;border:1px solid #9ca3af;background-color:#fff;padding:5px;"></div>
            </div>

            <div style="display:flex;justify-content:space-around;margin-top:40px;text-align:center;">
              <div style="width:40%;border-top:1px solid #000;padding-top:5px;">
                <p style="font-weight:600;">Talimi Zimmedar ke Dastakhat (Signature)</p>
              </div>
              <div style="width:40%;border-top:1px solid #000;padding-top:5px;">
                <p style="font-weight:600;">Teacher ke Dastakhat (Signature)</p>
              </div>
            </div>
            <p style="text-align:center;margin-top:20px;font-size:0.8rem;color:#6b7280;">
              *** Report generated on: ${new Date().toLocaleDateString()} ***
            </p>
          </div>
        `;

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = pdfContentHTML;
        tempDiv.style.position = "absolute";
        tempDiv.style.left = "-9999px";
        document.body.appendChild(tempDiv);

        const canvas = await window.html2canvas(tempDiv, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
        });
        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: "a4",
        });

        const imgProps = docPdf.getImageProperties(imgData);
        const pdfWidth = docPdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        docPdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        docPdf.save(
          `Tadris_Report_${teacherName.replace(/\s/g, "_")}_${date}.pdf`
        );

        document.body.removeChild(tempDiv);
        showNotification("PDF successfully downloaded!");
      } catch (err) {
        console.error("Error generating Tadris PDF:", err);
        showNotification("PDF generate karne me error.", true);
      } finally {
        showLoader(false);
      }
    }

    // ============================
    // Saved Table + Filters Logic (unchanged)
    // ============================
    let __savedCurrentData = [];

    function fillSavedTable() {
      const table = document.getElementById("saved-table-body");
      table.innerHTML = "";

      const { report } = getCurrentReportForSelectedMonth();
      const data = Array.isArray(report?.tadrisRecording?.data) ? [...report.tadrisRecording.data] : [];

      __savedCurrentData = data;

      if (!data.length) {
        table.innerHTML = `
          <tr>
            <td colspan="8" class="text-center p-3 text-gray-500">
              Is month ki koi recording save nahi hai.
            </td>
          </tr>`;
        return;
      }

      // Sort: date (newest first) then jamiaName (A→Z) for ties
      data.sort((a, b) => {
        const da = new Date(a.date).getTime() || 0;
        const db = new Date(b.date).getTime() || 0;
        if (db !== da) return db - da;
        const ja = (a.jamiaName || "").toLowerCase();
        const jb = (b.jamiaName || "").toLowerCase();
        if (ja < jb) return -1;
        if (ja > jb) return 1;
        return 0;
      });

      data.forEach((rec, idx) => {
        const rowId = `saved-row-${idx}`;
        table.insertAdjacentHTML("beforeend", `
          <tr id="${rowId}" class="saved-data-row">
            <td class="border px-2 py-1 urdu-font">${rec.jamiaName || ""}</td>
            <td class="border px-2 py-1 urdu-font">${rec.className || ""}</td>
            <td class="border px-2 py-1 urdu-font">${rec.kitabName || ""}</td>
            <td class="border px-2 py-1 urdu-font">${rec.teacherName || ""}</td>
            <td class="border px-2 py-1">${rec.date || ""}</td>
            <td class="border px-2 py-1 urdu-font">${rec.tasurat || "-"}</td>
            <td class="border px-2 py-1 urdu-font">${rec.adminTasurat || "-"}</td>
            <td class="border px-2 py-1">
              <button class="saved-download-btn text-red-600 underline text-xs"
                data-row-id="${rowId}"
                data-jamia-name="${encodeURIComponent(rec.jamiaName || '')}"
                data-teacher-name="${encodeURIComponent(rec.teacherName || '')}"
                data-date="${rec.date || ''}"
                data-class-name="${encodeURIComponent(rec.className || '')}"
                data-kitab-name="${encodeURIComponent(rec.kitabName || '')}"
                data-tasurat="${encodeURIComponent(rec.tasurat || '')}"
              >PDF</button>
            </td>
          </tr>
        `);
      });

      attachSavedDownloadHandlers();
      attachSavedFiltersListeners();
    }

    function applySavedFilters() {
      const jamiaQ = (document.getElementById("filter-jamia")?.value || "").trim().toLowerCase();
      const teacherQ = (document.getElementById("filter-teacher")?.value || "").trim().toLowerCase();
      const dateFrom = document.getElementById("filter-date-from")?.value || "";
      const dateTo = document.getElementById("filter-date-to")?.value || "";

      document.querySelectorAll("#saved-table-body tr.saved-data-row").forEach((tr) => {
        const jamia = (tr.children[0]?.textContent || "").trim().toLowerCase();
        const teacher = (tr.children[3]?.textContent || "").trim().toLowerCase();
        const dateStr = (tr.children[4]?.textContent || "").trim();

        let visible = true;

        if (jamiaQ) visible = visible && jamia.includes(jamiaQ);
        if (teacherQ) visible = visible && teacher.includes(teacherQ);
        if (dateFrom) {
          const d = new Date(dateStr);
          const from = new Date(dateFrom);
          if (isNaN(d.getTime())) visible = false;
          else visible = visible && (d >= from);
        }
        if (dateTo) {
          const d = new Date(dateStr);
          const to = new Date(dateTo);
          to.setHours(23,59,59,999);
          if (isNaN(d.getTime())) visible = false;
          else visible = visible && (d <= to);
        }

        tr.style.display = visible ? "" : "none";
      });
    }

    function attachSavedFiltersListeners() {
      const j = document.getElementById("filter-jamia");
      const t = document.getElementById("filter-teacher");
      const f = document.getElementById("filter-date-from");
      const to = document.getElementById("filter-date-to");

      if (j && !j._savedFilterAttached) {
        j.addEventListener("input", applySavedFilters);
        j._savedFilterAttached = true;
      }
      if (t && !t._savedFilterAttached) {
        t.addEventListener("input", applySavedFilters);
        t._savedFilterAttached = true;
      }
      if (f && !f._savedFilterAttached) {
        f.addEventListener("change", applySavedFilters);
        f._savedFilterAttached = true;
      }
      if (to && !to._savedFilterAttached) {
        to.addEventListener("change", applySavedFilters);
        to._savedFilterAttached = true;
      }
    }

    function attachSavedDownloadHandlers() {
      document.querySelectorAll(".saved-download-btn").forEach(btn => {
        if (btn._savedDownloadAttached) return;
        btn._savedDownloadAttached = true;

        btn.addEventListener("click", (ev) => {
          const b = ev.currentTarget;
          const temp = document.createElement("div");
          const recId = b.dataset.rowId || `tmp-${Date.now()}`;
          temp.id = recId;
          temp.dataset.jamiaName = decodeURIComponent(b.dataset.jamiaName || "");
          temp.dataset.teacherName = decodeURIComponent(b.dataset.teacherName || "");
          temp.dataset.date = b.dataset.date || "";
          temp.dataset.className = decodeURIComponent(b.dataset.className || "");
          temp.dataset.kitabName = decodeURIComponent(b.dataset.kitabName || "");
          temp.dataset.tasurat = decodeURIComponent(b.dataset.tasurat || "");
          const ta = document.createElement("textarea");
          ta.className = "user-admin-tasurat-input";
          ta.value = "";
          temp.appendChild(ta);
          temp.style.display = "none";
          document.body.appendChild(temp);

          (async function genPDF() {
            try {
              const jamiaName = temp.dataset.jamiaName || "";
              const teacherName = temp.dataset.teacherName || "";
              const date = temp.dataset.date || "";
              const className = temp.dataset.className || "";
              const kitabName = temp.dataset.kitabName || "";
              const tasuratAdmin = temp.dataset.tasurat || "Koi comment nahi diya gaya.";
              const tasuratZimmedar = ta.value.trim() || "Koi comment darj nahi kiya gaya.";

              const pdfContentHTML = `
                <div style="padding:20px;font-family:Poppins,sans-serif;direction:rtl;text-align:right;border:1px solid #ccc;max-width:700px;margin:0 auto;line-height:1.5;color:#333;">
                  <h2 style="text-align:center;color:#14b8a6;border-bottom:2px solid #14b8a6;padding-bottom:10px;margin-bottom:20px;font-size:1.5rem;font-weight:700;">
                    Majlis Talimi Umoor India - Tadris Recording Report
                  </h2>
                  <div style="margin-top:15px;font-size:1rem;text-align:center;">
                    <p style="margin-bottom:5px;"><strong>Jamia:</strong> <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${jamiaName}</span></p>
                    <p style="margin-bottom:5px;"><strong>Teacher ka Naam:</strong> <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${teacherName}</span></p>
                    <p style="margin-bottom:5px;"><strong>Class/Kitab:</strong> <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${className} - ${kitabName}</span></p>
                    <p style="margin-bottom:5px;"><strong>Date:</strong> <span>${date}</span></p>
                  </div>
                  <div style="margin-top:20px;padding:15px;border:1px dashed #14b8a6;background-color:#f0fdfa;">
                    <p style="font-weight:600;color:#0f766e;margin-bottom:5px;">Recording par Tasurat (Admin ka diya hua):</p>
                    <p style="font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:1.1rem;margin:0;">${tasuratAdmin}</p>
                  </div>
                  <div style="margin-top:20px;padding:15px;border:1px dashed #60a5fa;background-color:#eff6ff;">
                    <p style="font-weight:600;color:#2563eb;margin-bottom:5px;">Talimi Zimmedar Ke Tasurat (Aapka Comment):</p>
                    <p style="font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:1.1rem;margin:0;">${tasuratZimmedar}</p>
                  </div>
                  <p style="text-align:center;margin-top:20px;font-size:0.8rem;color:#6b7280;">*** Report generated on: ${new Date().toLocaleDateString()} ***</p>
                </div>
              `;

              const tempDiv = document.createElement("div");
              tempDiv.innerHTML = pdfContentHTML;
              tempDiv.style.position = "absolute";
              tempDiv.style.left = "-9999px";
              document.body.appendChild(tempDiv);

              const canvas = await window.html2canvas(tempDiv, { scale: 2, useCORS: true, allowTaint: true });
              const imgData = canvas.toDataURL("image/png");
              const { jsPDF } = window.jspdf;
              const docPdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
              const imgProps = docPdf.getImageProperties(imgData);
              const pdfWidth = docPdf.internal.pageSize.getWidth();
              const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
              docPdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
              docPdf.save(`Tadris_Report_${teacherName.replace(/\s/g, "_")}_${date}.pdf`);
              document.body.removeChild(tempDiv);
            } catch (err) {
              console.error("Saved table PDF error:", err);
              showNotification("PDF generate karne me error.", true);
            } finally {
              if (temp && temp.parentNode) document.body.removeChild(temp);
            }
          })();
        });
      });
    }


    // Delegation for Add Recording buttons (works for dynamically created items)
    document.addEventListener("click", function(e) {
      const btn = e.target.closest && e.target.closest('.add-tadris-entry-btn');
      if (!btn) return;
      e.preventDefault();
      // find container (closest .space-y-3 or the p-4 wrapper)
      const card = btn.closest('.space-y-3') || btn.closest('.p-4') || btn.closest('div');
      if (!card) return;
      // collect values
      const jamiaName = btn.dataset.jamiaName || (card.querySelector('.tadris-teacher-select')?.dataset?.jamiaName) || '';
      const teacherName = (card.querySelector('.tadris-teacher-select')?.value || '').trim();
      const className = (card.querySelector('.tadris-class-select')?.value || '').trim();
      const kitabName = (card.querySelector('.tadris-kitab-select')?.value || '').trim();
      const date = (card.querySelector('.tadris-date')?.value || '');
      const tasurat = (card.querySelector('.tadris-tasurat')?.value || '').trim();

      // minimal validation
      if (!jamiaName || !teacherName || !className || !kitabName || !date) {
        showNotification('Please select Jamia, Teacher, Class, Kitab and Date before adding.', true);
        return;
      }

      // prepare record object
      const newRec = {
        jamiaName,
        teacherName,
        className,
        kitabName,
        date,
        tasurat: tasurat || '',
        adminTasurat: '',
      };

      // push to monthly_reports doc (reportRef)
      (async function(){
        try {
          if (!reportRef) {
            showNotification('Report reference missing.', true);
            return;
          }
          // get existing
          const snap = await getDoc(reportRef);
          const data = snap.exists() ? (snap.data() || {}) : {};
          const arr = Array.isArray(data.tadrisRecording?.data) ? data.tadrisRecording.data : [];
          arr.push(newRec);
          await setDoc(reportRef, { tadrisRecording: { data: arr, status: 'Pending' } }, { merge: true });
          showNotification('Recording saved successfully.');
          // re-render
          await renderForCurrentMonth();
        } catch(err) {
          console.error('Error saving tadris entry:', err);
          showNotification('Record save failed.', true);
        }
      })();
    }, false);
    // ============================
    // Tabs behavior
    // ============================
    function setActiveTab(isAdd) {
      if (isAdd) {
        mainSection.classList.remove("hidden");
        savedSection.classList.add("hidden");
        tadrisAccordionContainer.classList.add("hide-saved");
        document.body.classList.remove("hide-top-controls");
        tabAdd.classList.add("bg-teal-600", "text-white");
        tabSaved.classList.remove("bg-teal-600", "text-white");
      } else {
        mainSection.classList.add("hidden");
        savedSection.classList.remove("hidden");
        tadrisAccordionContainer.classList.remove("hide-saved");
        document.body.classList.add("hide-top-controls");
        tabSaved.classList.add("bg-teal-600", "text-white");
        tabAdd.classList.remove("bg-teal-600", "text-white");
        fillSavedTable();
      }
    }

    tabAdd.addEventListener("click", () => setActiveTab(true));
    tabSaved.addEventListener("click", () => setActiveTab(false));
    
    // Accordion: delegation handler to toggle panels (works even if items re-render)
    tadrisAccordionContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('.accordion-button');
      if (!btn) return;
      const content = btn.nextElementSibling;
      const isOpen = btn.classList.toggle('open');
      if (content) {
        if (isOpen) {
          content.classList.add('open');
          // ensure max-height fits content
          content.style.maxHeight = content.scrollHeight + 30 + 'px';
        } else {
          content.classList.remove('open');
          content.style.maxHeight = null;
        }
      }
    });
    
    setActiveTab(true);


    // Populate Jamia dropdown in Saved Filters (called after render)
    function populateJamiaFilterOptions() {
      const sel = document.getElementById("filter-jamia");
      if (!sel) return;
      // clear but keep first default option
      sel.innerHTML = '<option value="">-- Sab Jamiaat --</option>';
      const academicData = (Array.isArray(window.KARKARDAGI_STRUCTURE) && window.KARKARDAGI_STRUCTURE.length) ? window.KARKARDAGI_STRUCTURE : (Array.isArray(userProfileData.academicStructure) ? userProfileData.academicStructure : []);
      academicData.forEach(j => {
        const name = j.jamiaName || "";
        if (name) sel.innerHTML += `<option value="${name}">${name}</option>`;
      });
    }

    // call populateJamiaFilterOptions after renderForCurrentMonth completes
    const originalRender = renderForCurrentMonth;
    renderForCurrentMonth = async function() {
      await originalRender();
      populateJamiaFilterOptions();
    };

    // adjust applySavedFilters to support select value (jamia)
    const oldApply = applySavedFilters;
    applySavedFilters = function() {
      // if jamia select exists its value used, otherwise fallback to input search
      const jamiaSel = document.getElementById("filter-jamia");
      const jamiaQ = jamiaSel ? (jamiaSel.value || "").trim().toLowerCase() : "";
      const teacherQ = (document.getElementById("filter-teacher")?.value || "").trim().toLowerCase();
      const dateFrom = document.getElementById("filter-date-from")?.value || "";
      const dateTo = document.getElementById("filter-date-to")?.value || "";

      document.querySelectorAll("#saved-table-body tr.saved-data-row").forEach((tr) => {
        const jamia = (tr.children[0]?.textContent || "").trim().toLowerCase();
        const teacher = (tr.children[3]?.textContent || "").trim().toLowerCase();
        const dateStr = (tr.children[4]?.textContent || "").trim();

        let visible = true;

        if (jamiaQ) visible = visible && jamia === jamiaQ; // exact match for select
        if (teacherQ) visible = visible && teacher.includes(teacherQ);
        if (dateFrom) {
          const d = new Date(dateStr);
          const from = new Date(dateFrom);
          if (isNaN(d.getTime())) visible = false;
          else visible = visible && (d >= from);
        }
        if (dateTo) {
          const d = new Date(dateStr);
          const to = new Date(dateTo);
          to.setHours(23,59,59,999);
          if (isNaN(d.getTime())) visible = false;
          else visible = visible && (d <= to);
        }

        tr.style.display = visible ? "" : "none";
      });
    };

    // attach change listener to new select
    document.addEventListener("DOMContentLoaded", () => {
      const sel = document.getElementById("filter-jamia");
      if (sel && !sel._attached) {
        sel.addEventListener("change", applySavedFilters);
        sel._attached = true;
      }
    });


    // expose render for debugging
    window.renderForCurrentMonth = renderForCurrentMonth;

  </script>
</body>
</html>














