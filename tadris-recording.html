<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tadris Recording – Majlis Talimi Umoor India</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- jsPDF + html2canvas (PDF ke liye) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @font-face {
      font-family: "Jameel Noori Nastaleeq";
      src: url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2")
          format("woff2"),
        url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff")
          format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF,
        U+FE70-FEFF;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: #f0f2f5;
    }
    .urdu-font {
      font-family: "Jameel Noori Nastaleeq", "Poppins", sans-serif;
      font-size: 1.05rem;
      line-height: 1.7;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #14b8a6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out,
        border-width 0.3s ease-out;
      padding-top: 0;
      padding-bottom: 0;
      border-top-width: 0;
    }
    .accordion-content.open {
      max-height: 1500px;
      transition: max-height 0.5s ease-in, padding 0.3s ease-in,
        border-width 0.3s ease-in;
      padding-top: 1rem;
      padding-bottom: 1rem;
      border-top-width: 1px;
    }
    .accordion-button svg {
      transition: transform 0.3s ease-out;
    }
    .accordion-button.open svg {
      transform: rotate(180deg);
    }
    .comment-display {
      background-color: #f9fafb;
      border-left: 3px solid #14b8a6;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body class="antialiased text-gray-800">
  <!-- Notification -->
  <div
    id="notification"
    class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform translate-x-full hidden"
  ></div>

  <!-- Loader -->
  <div
    id="loader"
    class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-40 flex justify-center items-center z-[70] hidden"
  >
    <div class="loader"></div>
  </div>

  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header
      class="bg-white rounded-2xl shadow-md px-4 py-3 md:px-6 md:py-4 mb-6 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <button
          id="back-btn"
          class="inline-flex items-center gap-2 text-sm md:text-base text-teal-700 hover:text-teal-900 font-medium"
        >
          <i class="fas fa-arrow-left text-xs"></i>
          <span>Back to Dashboard</span>
        </button>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-500 mb-1">Majlis Talimi Umoor India</p>
        <h1 class="text-lg md:text-2xl font-bold text-gray-800 urdu-font">
          Tadris Recording Panel
        </h1>
      </div>
    </header>

    <!-- Top Controls -->
    <section
      class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-6 flex flex-col md:flex-row md:items-end gap-4"
    >
      <div class="flex-1">
        <label
          class="block text-xs font-semibold text-gray-600 mb-1"
          for="month-input"
        >
          Report Month Select Karein
        </label>
        <input
          type="month"
          id="month-input"
          class="w-full md:w-60 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
        />
        <p
          id="current-month-label"
          class="text-xs text-gray-500 mt-1"
        ></p>
      </div>

      <div class="flex-1 md:text-right">
        <p class="text-xs text-gray-500 mb-1">User</p>
        <p
          id="user-name-display"
          class="font-semibold text-gray-800 urdu-font text-base"
        >
          Loading...
        </p>
        <p
          id="user-zimmedari-display"
          class="text-xs text-gray-500 urdu-font"
        >
          ...
        </p>
      </div>
    </section>

    <!-- Info / Help -->
    <section class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-emerald-800 mb-2">
          Kaam ka Tarz
        </h2>
        <ul class="text-xs text-emerald-800 space-y-1 urdu-font">
          <li>• Har Jamia ke liye accordion open karein.</li>
          <li>• Class select karein, phir Kitab, phir Teacher ka naam & Date.</li>
          <li>• “Recording par Tasurat” me apna brief comment likhein.</li>
          <li>• “Add Recording” dabayen, entry save ho jayegi.</li>
        </ul>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-blue-800 mb-2">
          Saved Recordings
        </h2>
        <p class="text-xs text-blue-800 urdu-font">
          Neeche har Jamia ke neeche “Saved Recordings” list me purani
          recordings nazar aayengi. Wahan se:
        </p>
        <ul class="text-xs text-blue-800 space-y-1 urdu-font mt-1">
          <li>• Talimi Zimmedar ke tasurat update kar sakte hain.</li>
          <li>• Har entry ka PDF report download kar sakte hain.</li>
        </ul>
      </div>
      <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-amber-800 mb-2">
          Note
        </h2>
        <ul class="text-xs text-amber-800 space-y-1 urdu-font">
          <li>• Yeh page sirf Tadris Recording ke liye hai.</li>
          <li>• Data wahi <b>monthly_reports</b> me save hota hai.</li>
          <li>• Month badlenge to us month ki Tadris list show hogi.</li>
        </ul>
      </div>
    </section>

    <!-- Main Tadris Accordion -->
    <section
      class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-gray-800 urdu-font">
          Jamia Wise Tadris Recording
        </h2>
        <span
          id="tadris-status-chip"
          class="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700"
        >
          <span class="w-2 h-2 rounded-full bg-gray-400"></span>
          <span id="tadris-status-text">Loading...</span>
        </span>
      </div>

      <p
        id="tadris-loading-msg"
        class="text-center text-gray-500 text-sm mb-4"
      >
        Loading Jamiaat...
      </p>
      <p
        id="tadris-no-data-msg"
        class="text-center text-red-500 text-sm mb-4 hidden"
      >
        Academic Structure nahi mila. Pehle main app se setup karein.
      </p>

      <div
        id="tadris-accordion-container"
        class="space-y-4"
      ></div>
    </section>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    // ============================
    /*************** Firebase setup (merged) ***************/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  addDoc,
  deleteDoc,
  getDoc,
  doc,
  serverTimestamp,
  updateDoc,
  setDoc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
  authDomain: "data-f15ab.firebaseapp.com",
  projectId: "data-f15ab",
  storageBucket: "data-f15ab.appspot.com",
  messagingSenderId: "449137002393",
  appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
  measurementId: "G-1PHNJQWNPZ",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

    // ============================
    // DOM Helpers
    // ============================
    const loader = document.getElementById("loader");
    const notification = document.getElementById("notification");
    const monthInput = document.getElementById("month-input");
    const currentMonthLabel = document.getElementById("current-month-label");
    const userNameDisplay = document.getElementById("user-name-display");
    const userZimmedariDisplay = document.getElementById(
      "user-zimmedari-display"
    );
    const backBtn = document.getElementById("back-btn");
    const tadrisAccordionContainer = document.getElementById(
      "tadris-accordion-container"
    );
    const tadrisLoadingMsg = document.getElementById("tadris-loading-msg");
    const tadrisNoDataMsg = document.getElementById("tadris-no-data-msg");
    const tadrisStatusChip = document.getElementById("tadris-status-chip");
    const tadrisStatusText = document.getElementById("tadris-status-text");

    const showLoader = (show) => {
      if (!loader) return;
      loader.classList.toggle("hidden", !show);
    };

    const showNotification = (message, isError = false) => {
      if (!notification) return;
      notification.textContent = message;
      notification.className =
        "fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform " +
        (isError ? "bg-red-500" : "bg-emerald-600");
      notification.classList.remove("hidden", "translate-x-full");
      void notification.offsetWidth;
      setTimeout(() => {
        notification.classList.remove("translate-x-full");
      }, 10);
      setTimeout(() => {
        notification.classList.add("translate-x-full");
        setTimeout(() => notification.classList.add("hidden"), 300);
      }, 2500);
    };

    const getReportingInfoFromMonthInput = (inputValue) => {
      if (!inputValue) {
        const now = new Date();
        const m = now.getMonth();
        const y = now.getFullYear();
        const monthInputFormat =
          y + "-" + String(m + 1).padStart(2, "0");
        const monthName = now.toLocaleString("default", { month: "long" });
        return {
          monthNum: m,
          yearNum: y,
          monthName,
          monthInputFormat,
        };
      }
      const [yearStr, monthStr] = inputValue.split("-");
      const yearNum = parseInt(yearStr);
      const monthNum = parseInt(monthStr) - 1;
      const date = new Date(yearNum, monthNum, 1);
      const monthName = date.toLocaleString("default", { month: "long" });
      return {
        monthNum,
        yearNum,
        monthName,
        monthInputFormat: inputValue,
      };
    };

    const convertGoogleDriveURL = (url) => {
      if (
        !url ||
        typeof url !== "string" ||
        (!url.startsWith("http") && !url.startsWith("/"))
      ) {
        return "https://placehold.co/150x150/e2e8f0/94a3b8?text=Photo";
      }
      if (!url.includes("drive.google.com")) return url;
      const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
      return match && match[1]
        ? `https://drive.google.com/uc?export=view&id=${match[1]}`
        : url;
    };

    // ============================
    // Global State
    // ============================
    let currentUser = null;
    let userProfileData = {};
    let allReports = [];
    let currentReport = {};
    let reportRef = null;

    // ============================
    // Back to Dashboard
    // ============================
    backBtn.addEventListener("click", () => {
      // same project me agar index.html hai:
      window.location.href = "index.html";
    });

    // ============================
    // Init App (Auth + Data)
    // ============================
    onAuthStateChanged(auth, async (user) => {
      showLoader(true);
      if (!user) {
        showLoader(false);
        showNotification("Please login first (main page).", true);
        // optional: redirect
        window.location.href = "index.html";
        return;
      }
      currentUser = user;

      try {
        // --- User Profile ---
        const userDocRef = doc(db, "users", user.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          userProfileData = snap.data();

          userNameDisplay.textContent = userProfileData.name || "N/A";
          userZimmedariDisplay.textContent =
            userProfileData.zimmedari ||
            userProfileData.role ||
            "N/A";
        } else {
          showNotification("User profile nahi mila.", true);
        }

        // Month default: previous month (same as main app style)
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        const dInfo = getReportingInfoFromMonthInput(null);
        const prevMonthInput =
          lastMonth.getFullYear() +
          "-" +
          String(lastMonth.getMonth() + 1).padStart(2, "0");
        monthInput.value = prevMonthInput;
        updateMonthLabel();

        // Reports listener
        const reportsRef = collection(db, "monthly_reports");
        const qReports = query(
          reportsRef,
          where("userId", "==", user.uid)
        );

        onSnapshot(
          qReports,
          (snapshot) => {
            allReports = snapshot.docs.map((d) => ({
              id: d.id,
              ...d.data(),
            }));
            renderForCurrentMonth();
          },
          (err) => {
            console.error("Error loading reports for Tadris page:", err);
            showNotification("Reports load nahi ho paaye.", true);
          }
        );
      } catch (err) {
        console.error(err);
        showNotification("Error loading user data.", true);
      } finally {
        showLoader(false);
      }
    });

    monthInput.addEventListener("change", () => {
      updateMonthLabel();
      renderForCurrentMonth();
    });

    function updateMonthLabel() {
      const info = getReportingInfoFromMonthInput(monthInput.value);
      currentMonthLabel.textContent = `Report for: ${info.monthName} ${info.yearNum}`;
    }

    // ============================
    // Pick Current Report Doc for Month
    // (same ID style jaisa main app me hai)
    // ============================
    function getCurrentReportForSelectedMonth() {
      if (!currentUser) return { report: {}, ref: null };

      const { monthNum, yearNum, monthName, monthInputFormat } =
        getReportingInfoFromMonthInput(monthInput.value);

      // academic year logic (Apr = 3 index)
      const academicYear =
        monthNum >= 3
          ? `${yearNum}-${yearNum + 1}`
          : `${yearNum - 1}-${yearNum}`;

      const simpleId = `${currentUser.uid}_${yearNum}_${monthNum}`;
      const withYearId = `${currentUser.uid}_${academicYear}_${yearNum}_${monthNum}`;

      let found =
        allReports.find((r) => r.id === withYearId) ||
        allReports.find((r) => r.id === simpleId);

      if (found) {
        return {
          report: found,
          ref: doc(db, "monthly_reports", found.id),
          meta: { monthNum, yearNum, academicYear, monthName, monthInputFormat },
        };
      }

      // Agar doc nahi mila to naya create karne ke liye withYearId use karenge
      const newRef = doc(db, "monthly_reports", withYearId);
      return {
        report: {},
        ref: newRef,
        meta: { monthNum, yearNum, academicYear, monthName, monthInputFormat },
      };
    }

    async function ensureReportBaseFields(ref, meta) {
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(
          ref,
          {
            userId: currentUser.uid,
            month: meta.monthName,
            year: meta.yearNum,
            academicYear: meta.academicYear,
            monthNum: meta.monthNum,
            monthKey: meta.monthInputFormat,
            createdAt: serverTimestamp(),
          },
          { merge: true }
        );
      } else {
        // ensure monthKey at least
        const data = snap.data() || {};
        if (!data.monthKey) {
          await updateDoc(ref, {
            monthKey: meta.monthInputFormat,
          });
        }
      }
    }
// -----------------------------
// New: fetchAcademicStructure()
// -----------------------------
async function fetchAcademicStructure() {
  try {
    // 1) try karkardgi/<uid>
    if (currentUser) {
      const karkardgiUserRef = doc(db, "karkardgi", currentUser.uid);
      const kSnap = await getDoc(karkardgiUserRef);
      if (kSnap.exists()) {
        const data = kSnap.data();
        if (Array.isArray(data.academicStructure) && data.academicStructure.length) {
          console.log("Academic structure loaded from karkardgi/<uid>");
          return data.academicStructure;
        }
        if (Array.isArray(data.setupStructure) && data.setupStructure.length) {
          console.log("Academic structure loaded from karkardgi/<uid>.setupStructure");
          return data.setupStructure;
        }
      }
    }

    // 2) try karkardgi/setup (global admin setup)
    const karkardgiGlobalRef = doc(db, "karkardgi", "setup");
    const gSnap = await getDoc(karkardgiGlobalRef);
    if (gSnap.exists()) {
      const gData = gSnap.data();
      if (Array.isArray(gData.academicStructure) && gData.academicStructure.length) {
        console.log("Academic structure loaded from karkardgi/setup (global)");
        return gData.academicStructure;
      }
      if (Array.isArray(gData.setupStructure) && gData.setupStructure.length) {
        console.log("Academic structure loaded from karkardgi/setup.setupStructure (global)");
        return gData.setupStructure;
      }
    }

    // 3) fallback to users/<uid>/academicStructure (original)
    if (currentUser) {
      const userDocRef = doc(db, "users", currentUser.uid);
      const uSnap = await getDoc(userDocRef);
      if (uSnap.exists()) {
        const uData = uSnap.data();
        if (Array.isArray(uData.academicStructure) && uData.academicStructure.length) {
          console.log("Academic structure loaded from users/<uid>/academicStructure (fallback)");
          return uData.academicStructure;
        }
      }
    }

    // nothing found -> return empty array
    console.warn("Academic structure not found in karkardgi or user profile.");
    return [];
  } catch (err) {
    console.error("fetchAcademicStructure error:", err);
    return [];
  }
}

    // ============================
    // Render Tadris layout for month
    // ============================
    async function renderForCurrentMonth() {
      if (!tadrisAccordionContainer) return;
      showLoader(true);
      tadrisAccordionContainer.innerHTML = "";
      tadrisLoadingMsg.classList.remove("hidden");
      tadrisNoDataMsg.classList.add("hidden");

      try {
        const { report, ref, meta } = getCurrentReportForSelectedMonth();
        reportRef = ref;
        currentReport = report;

        const academicData = await fetchAcademicStructure();

        if (!academicData.length) {
          tadrisLoadingMsg.classList.add("hidden");
          tadrisNoDataMsg.classList.remove("hidden");
          tadrisStatusText.textContent = "No Academic Structure";
          tadrisStatusChip.className =
            "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-red-50 text-red-700";
          return;
        }

        await ensureReportBaseFields(reportRef, meta);

        const existingSnap = await getDoc(reportRef);
        const existingData = existingSnap.exists()
          ? existingSnap.data()
          : {};
        const tadrisData = existingData.tadrisRecording?.data || [];
        const tadrisStatus =
          existingData.tadrisRecording?.status || "Pending";

        if (tadrisStatus === "Done" && tadrisData.length > 0) {
          tadrisStatusText.textContent = "Done";
          tadrisStatusChip.className =
            "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-emerald-50 text-emerald-700";
        } else if (tadrisData.length > 0) {
          tadrisStatusText.textContent = "Partially Filled";
          tadrisStatusChip.className =
            "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-sky-50 text-sky-700";
        } else {
          tadrisStatusText.textContent = "Pending";
          tadrisStatusChip.className =
            "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700";
        }

        tadrisLoadingMsg.classList.add("hidden");
        tadrisAccordionContainer.innerHTML = "";

        academicData.forEach((jamia, index) => {
          const jamiaName = jamia.jamiaName || `Jamia #${index + 1}`;
          const jamiaSaved = tadrisData.filter(
            (r) => r.jamiaName === jamiaName
          );

          const accordionItem = document.createElement("div");
          accordionItem.className =
            "border border-gray-200 rounded-xl overflow-hidden bg-gray-50";

          const header = document.createElement("button");
          header.type = "button";
          header.className =
            "accordion-button w-full flex items-center justify-between px-4 md:px-5 py-3 bg-white hover:bg-slate-50";
          header.innerHTML = `
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-teal-100 text-teal-700 text-sm font-semibold">
                ${index + 1}
              </span>
              <div class="text-left">
                <p class="font-semibold text-gray-800 urdu-font">${jamiaName}</p>
                <p class="text-[11px] text-gray-500">Classes: ${
                  jamia.classes ? Object.keys(jamia.classes).length : 0
                } | Saved Recordings: ${jamiaSaved.length}</p>
              </div>
            </div>
            <div class="flex items-center gap-2 text-xs text-gray-500">
              <span class="hidden sm:inline">Details dekhein</span>
              <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          `;

          const content = document.createElement("div");
          content.className =
            "accordion-content border-t border-gray-200 bg-gray-50";

          const savedHTML = jamiaSaved.length
            ? jamiaSaved
                .map((rec, i) => {
                  const adminComment = rec.tasurat || "-";
                  const userComment = rec.adminTasurat || "";
                  const recId = `tadris-rec-${index}-${i}`;

                  return `
                  <div
                    class="p-3 bg-white rounded-lg border border-gray-200 text-xs md:text-sm space-y-2"
                    id="${recId}"
                    data-jamia-name="${rec.jamiaName}"
                    data-date="${rec.date}"
                    data-teacher-name="${rec.teacherName}"
                    data-class-name="${rec.className}"
                    data-kitab-name="${rec.kitabName}"
                    data-tasurat="${encodeURIComponent(adminComment)}"
                  >
                    <p class="urdu-font font-semibold">
                      ${rec.className} – ${rec.kitabName}
                      <span class="text-[11px] text-gray-500">(${rec.teacherName}, ${rec.date})</span>
                    </p>

                    <div>
                      <p class="text-[11px] font-semibold text-gray-600 urdu-font">Recording par Tasurat (Admin ka diya hua):</p>
                      <p class="urdu-font">${adminComment}</p>
                    </div>

                    <div class="comment-display">
                      <label class="block text-[11px] font-medium text-gray-600 urdu-font">
                        Talimi Zimmedar Ke Tasurat (Aapka Comment):
                      </label>
                      <textarea
                        rows="2"
                        class="user-admin-tasurat-input w-full mt-1 p-2 border rounded-lg urdu-font text-xs"
                        data-jamia-name="${rec.jamiaName}"
                        data-date="${rec.date}"
                        data-teacher-name="${rec.teacherName}"
                      >${userComment}</textarea>
                      <button
                        type="button"
                        class="save-user-admin-tasurat-btn mt-2 w-full sm:w-auto px-3 py-1 rounded-lg text-xs font-semibold bg-teal-600 hover:bg-teal-700 text-white"
                      >
                        Save Comment
                      </button>
                    </div>

                    <button
                      type="button"
                      class="download-tadris-pdf-btn mt-2 w-full sm:w-auto px-3 py-1 rounded-lg text-xs font-semibold bg-red-600 hover:bg-red-700 text-white"
                      data-record-id="${recId}"
                    >
                      <i class="fas fa-file-pdf mr-1"></i>
                      Report PDF Download Karein
                    </button>
                  </div>
                `;
                })
                .join("")
            : `<p class="text-xs text-gray-500">Is Jamia ke liye abhi koi recording save nahi hui hai.</p>`;

          content.innerHTML = `
            <div class="p-4 md:p-5 space-y-4">
              <div class="space-y-3 bg-white rounded-xl shadow-sm p-3 md:p-4 border border-gray-200">
                <h3 class="text-sm md:text-base font-semibold text-gray-800 urdu-font mb-1">
                  Nayi Recording Add Karein
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1">Class</label>
                    <select
                      class="tadris-class-select w-full p-2 border rounded-lg bg-white text-xs urdu-font"
                    >
                      <option value="">Select Class</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1">Kitab</label>
                    <select
                      class="tadris-kitab-select w-full p-2 border rounded-lg bg-white text-xs urdu-font"
                      disabled
                    >
                      <option value="">Select Class First</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1">Teacher ka Naam</label>
                    <input
                      type="text"
                      class="tadris-teacher-name w-full p-2 border rounded-lg text-xs urdu-font"
                      placeholder="Teacher ka naam"
                    />
                  </div>
                  <div>
                    <label class="block text-[11px] font-medium text-gray-600 mb-1">Date</label>
                    <input
                      type="date"
                      class="tadris-date w-full p-2 border rounded-lg text-xs"
                    />
                  </div>
                </div>
                <div>
                  <label class="block text-[11px] font-medium text-gray-600 mb-1 urdu-font">
                    Recording par Tasurat (Admin ka comment)
                  </label>
                  <textarea
                    rows="3"
                    class="tadris-tasurat w-full p-2 border rounded-lg text-xs urdu-font"
                    placeholder="Yahan recording par apna comment likhein..."
                  ></textarea>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
                  <button
                    type="button"
                    class="add-tadris-entry-btn px-4 py-2 rounded-lg text-xs font-semibold bg-emerald-600 hover:bg-emerald-700 text-white"
                    data-jamia-name="${jamiaName}"
                  >
                    <i class="fas fa-plus mr-1"></i>
                    Add Recording
                  </button>
                </div>
              </div>

              <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2 urdu-font">
                  Saved Recordings
                </h4>
                <div class="space-y-2 saved-recordings-list">
                  ${savedHTML}
                </div>
              </div>
            </div>
          `;

          accordionItem.appendChild(header);
          accordionItem.appendChild(content);
          tadrisAccordionContainer.appendChild(accordionItem);

          // fill class select
          const classSelect = content.querySelector(".tadris-class-select");
          const kitabSelect = content.querySelector(".tadris-kitab-select");

          if (jamia.classes && typeof jamia.classes === "object") {
            Object.keys(jamia.classes).forEach((className) => {
              classSelect.innerHTML += `<option value="${className}">${className}</option>`;
            });
          }

          header.addEventListener("click", () => {
            header.classList.toggle("open");
            content.classList.toggle("open");
          });

          classSelect.addEventListener("change", (e) => {
            const selectedClass = e.target.value;
            kitabSelect.innerHTML =
              '<option value="">Select Kitab</option>';
            kitabSelect.disabled = true;
            if (
              selectedClass &&
              jamia.classes &&
              jamia.classes[selectedClass]
            ) {
              const kitabs =
                jamia.classes[selectedClass].kitabs || [];
              if (Array.isArray(kitabs)) {
                kitabs.forEach((kName) => {
                  kitabSelect.innerHTML += `<option value="${kName}">${kName}</option>`;
                });
                kitabSelect.disabled = false;
              }
            }
          });

          const addBtn = content.querySelector(".add-tadris-entry-btn");
          addBtn.addEventListener("click", handleAddTadrisEntry);

          content
            .querySelectorAll(".save-user-admin-tasurat-btn")
            .forEach((btn) =>
              btn.addEventListener(
                "click",
                handleUserEditAdminTasurat
              )
            );
          content
            .querySelectorAll(".download-tadris-pdf-btn")
            .forEach((btn) =>
              btn.addEventListener(
                "click",
                handleDownloadTadrisPDF
              )
            );
        });
      } catch (err) {
        console.error("renderForCurrentMonth Tadris error:", err);
        showNotification("Tadris data load karne me error.", true);
      } finally {
        showLoader(false);
      }
    }

    // ============================
    // Add Entry
    // ============================
    async function handleAddTadrisEntry(e) {
      e.preventDefault();
      if (!reportRef) {
        showNotification("Report reference missing.", true);
        return;
      }
      const button = e.currentTarget;
      const container = button.closest(".p-4");
      if (!container) return;

      const classSelect = container.querySelector(".tadris-class-select");
      const kitabSelect = container.querySelector(".tadris-kitab-select");
      const teacherNameInput = container.querySelector(".tadris-teacher-name");
      const dateInput = container.querySelector(".tadris-date");
      const tasuratInput = container.querySelector(".tadris-tasurat");

      const jamiaName = button.dataset.jamiaName || "";
      const className = classSelect.value;
      const kitabName = kitabSelect.value;
      const teacherName = (teacherNameInput.value || "").trim();
      const date = dateInput.value;
      const tasurat = (tasuratInput.value || "").trim();

      if (!jamiaName || !className || !kitabName || !teacherName || !date) {
        showNotification(
          "Jamia, Class, Kitab, Teacher ka naam aur Date bharna zaroori hai.",
          true
        );
        return;
      }

      const newEntry = {
        jamiaName,
        className,
        kitabName,
        teacherName,
        date,
        tasurat,
        adminTasurat: "",
      };

      showLoader(true);
      try {
        const snap = await getDoc(reportRef);
        const existing = snap.exists()
          ? snap.data().tadrisRecording?.data || []
          : [];
        const merged = [...existing, newEntry];

        await updateDoc(reportRef, {
          tadrisRecording: { status: "Done", data: merged },
          updatedAt: serverTimestamp(),
        });

        showNotification("Tadris entry saved!");
        // Clear fields
        classSelect.value = "";
        kitabSelect.innerHTML =
          '<option value="">Select Class First</option>';
        kitabSelect.disabled = true;
        teacherNameInput.value = "";
        dateInput.value = "";
        tasuratInput.value = "";

        // UI ko refresh karein
        renderForCurrentMonth();
      } catch (err) {
        console.error("Error adding tadris entry:", err);
        showNotification("Error adding Tadris entry.", true);
      } finally {
        showLoader(false);
      }
    }

    // ============================
    // Save Talimi Zimmedar Comment
    // ============================
    async function handleUserEditAdminTasurat(e) {
      if (!reportRef) {
        showNotification("Report reference missing.", true);
        return;
      }
      const btn = e.currentTarget;
      const parentDiv = btn.closest(".comment-display");
      if (!parentDiv) return;

      const textarea = parentDiv.querySelector(".user-admin-tasurat-input");
      const newComment = (textarea.value || "").trim();

      const jamiaName = textarea.dataset.jamiaName;
      const date = textarea.dataset.date;
      const teacherName = textarea.dataset.teacherName;

      if (!jamiaName || !date || !teacherName) {
        showNotification("Entry ki details missing hain.", true);
        return;
      }

      showLoader(true);
      try {
        const snap = await getDoc(reportRef);
        const existing = snap.exists()
          ? snap.data().tadrisRecording?.data || []
          : [];
        let found = false;
        const updatedData = existing.map((item) => {
          if (
            item.jamiaName === jamiaName &&
            item.date === date &&
            item.teacherName === teacherName
          ) {
            found = true;
            return { ...item, adminTasurat: newComment };
          }
          return item;
        });

        if (!found) {
          showNotification("Woh entry report me nahi mili.", true);
          return;
        }

        await updateDoc(reportRef, {
          tadrisRecording: { status: "Done", data: updatedData },
          updatedAt: serverTimestamp(),
        });

        showNotification("Aapka comment save ho gaya!");
      } catch (err) {
        console.error("Error saving zimmedar comment:", err);
        showNotification("Comment save karne me error.", true);
      } finally {
        showLoader(false);
      }
    }

    // ============================
    // PDF Download
    // ============================
    async function handleDownloadTadrisPDF(e) {
      const btn = e.currentTarget.closest(".download-tadris-pdf-btn");
      if (!btn) return;
      const recordDiv = document.getElementById(btn.dataset.recordId);
      if (!recordDiv) {
        showNotification("Report data nahi mila.", true);
        return;
      }

      const jamiaName = recordDiv.dataset.jamiaName;
      const teacherName = recordDiv.dataset.teacherName;
      const date = recordDiv.dataset.date;
      const className = recordDiv.dataset.className;
      const kitabName = recordDiv.dataset.kitabName;

      const tasuratAdmin = decodeURIComponent(
        recordDiv.dataset.tasurat || "Koi comment nahi diya gaya."
      );
      const tasuratZimmedar =
        recordDiv.querySelector(".user-admin-tasurat-input").value.trim() ||
        "Koi comment darj nahi kiya gaya.";

      showLoader(true);

      try {
        const pdfContentHTML = `
          <div style="padding:20px;font-family:Poppins,sans-serif;direction:rtl;text-align:right;border:1px solid #ccc;max-width:700px;margin:0 auto;line-height:1.5;color:#333;">
            <h2 style="text-align:center;color:#14b8a6;border-bottom:2px solid #14b8a6;padding-bottom:10px;margin-bottom:20px;font-size:1.5rem;font-weight:700;">
              Majlis Talimi Umoor India - Tadris Recording Report
            </h2>

            <div style="margin-top:15px;font-size:1rem;text-align:center;">
              <p style="margin-bottom:5px;">
                <strong>Jamia:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${jamiaName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Teacher ka Naam:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${teacherName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Class/Kitab:</strong>
                <span style="font-family:'Jameel Noori Nastaleeq',sans-serif;">${className} - ${kitabName}</span>
              </p>
              <p style="margin-bottom:5px;">
                <strong>Date:</strong>
                <span>${date}</span>
              </p>
            </div>

            <div style="margin-top:20px;padding:15px;border:1px dashed #14b8a6;background-color:#f0fdfa;">
              <p style="font-weight:600;color:#0f766e;margin-bottom:5px;">Recording par Tasurat (Admin ka diya hua):</p>
              <p style="font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:1.1rem;margin:0;">${tasuratAdmin}</p>
            </div>

            <div style="margin-top:20px;padding:15px;border:1px dashed #60a5fa;background-color:#eff6ff;">
              <p style="font-weight:600;color:#2563eb;margin-bottom:5px;">Talimi Zimmedar Ke Tasurat (Aapka Comment):</p>
              <p style="font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:1.1rem;margin:0;">${tasuratZimmedar}</p>
            </div>

            <div style="margin-top:30px;padding-top:15px;border-top:1px solid #ccc;">
              <p style="font-weight:600;color:#4b5563;margin-bottom:10px;">Teacher Ke Comments (Print ke baad likhne ke liye):</p>
              <div style="height:120px;border:1px solid #9ca3af;background-color:#fff;padding:5px;"></div>
            </div>

            <div style="display:flex;justify-content:space-around;margin-top:40px;text-align:center;">
              <div style="width:40%;border-top:1px solid #000;padding-top:5px;">
                <p style="font-weight:600;">Talimi Zimmedar ke Dastakhat (Signature)</p>
              </div>
              <div style="width:40%;border-top:1px solid #000;padding-top:5px;">
                <p style="font-weight:600;">Teacher ke Dastakhat (Signature)</p>
              </div>
            </div>
            <p style="text-align:center;margin-top:20px;font-size:0.8rem;color:#6b7280;">
              *** Report generated on: ${new Date().toLocaleDateString()} ***
            </p>
          </div>
        `;

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = pdfContentHTML;
        tempDiv.style.position = "absolute";
        tempDiv.style.left = "-9999px";
        document.body.appendChild(tempDiv);

        const canvas = await window.html2canvas(tempDiv, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
        });
        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: "a4",
        });

        const imgProps = docPdf.getImageProperties(imgData);
        const pdfWidth = docPdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        docPdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        docPdf.save(
          `Tadris_Report_${teacherName.replace(/\s/g, "_")}_${date}.pdf`
        );

        document.body.removeChild(tempDiv);
        showNotification("PDF successfully downloaded!");
      } catch (err) {
        console.error("Error generating Tadris PDF:", err);
        showNotification("PDF generate karne me error.", true);
      } finally {
        showLoader(false);
      }
    }
  </script>
</body>
</html>

