<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tadris Recording Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @font-face {
      font-family: "Jameel Noori Nastaleeq";
      src: url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2")
          format("woff2"),
        url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff")
          format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF,
        U+FE70-FEFF;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: #f0f2f5;
    }
    .urdu-font {
      font-family: "Jameel Noori Nastaleeq", "Poppins", sans-serif;
      font-size: 1.05rem;
      line-height: 1.7;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #14b8a6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out,
        border-width 0.3s ease-out;
      padding-top: 0;
      padding-bottom: 0;
      border-top-width: 0;
    }
    .accordion-content.open {
      max-height: 2000px;
      transition: max-height 0.5s ease-in, padding 0.3s ease-in,
        border-width 0.3s ease-in;
      padding-top: 1rem;
      padding-bottom: 1rem;
      border-top-width: 1px;
    }
    .accordion-button svg {
      transition: transform 0.3s ease-out;
    }
    .accordion-button { cursor: pointer; }
    
    .accordion-button.open svg {
      transform: rotate(180deg);
    }
    .comment-display {
      background-color: #f9fafb;
      border-left: 3px solid #14b8a6;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 4px;
    }

    /* hide saved-recordings inside add tab */
    .hide-saved .saved-recordings-list,
    .hide-saved .download-tadris-pdf-btn,
    .hide-saved .save-user-admin-tasurat-btn,
    .hide-saved .comment-display {
      display: none !important;
    }
    .hide-saved .space-y-2.saved-recordings-list {
      margin: 0;
      padding: 0;
    }

    /* hide top controls and info cards when in saved tab */
    .hide-top-controls #top-controls,
    .hide-top-controls #info-cards {
      display: none !important;
    }

    /* small responsive */
    @media (max-width:640px){
      .urdu-font { font-size: 0.95rem; }
    }
    
    /* Header Copy Button Hover Effect */
    .header-copy-btn:hover {
        transform: scale(1.1);
    }
    

  </style>
</head>
<body class="antialiased text-gray-800">
  <div
    id="notification"
    class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform translate-x-full hidden"
  ></div>

  <div
    id="loader"
    class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-40 flex justify-center items-center z-[70] hidden"
  >
    <div class="loader"></div>
  </div>

  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header
      class="bg-white rounded-2xl shadow-md px-4 py-3 md:px-6 md:py-4 mb-6 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <button
          id="back-btn"
          type="button"
          onclick="window.location.href='index.html'"
          class="inline-flex items-center gap-2 text-sm md:text-base text-teal-700 hover:text-teal-900 font-medium"
        >
          <i class="fas fa-arrow-left text-xs"></i>
          <span>Back to Dashboard</span>
        </button>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-500 mb-1">Majlis Talimi Umoor India</p>
        <h1 class="text-lg md:text-2xl font-bold text-gray-800 urdu-font">
          Tadris Recording Panel
        </h1>
      </div>
    </header>

    <div class="flex gap-3 mb-5">
      <button id="tab-add" class="px-4 py-2 rounded-lg transition-colors">Add Recording</button>
      <button id="tab-saved" class="px-4 py-2 rounded-lg transition-colors">Saved Recordings</button>
    </div>

    <section id="top-controls" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-6 flex flex-col md:flex-row md:items-end gap-4">
      <div class="flex-1">
        <label class="block text-xs font-semibold text-gray-600 mb-1" for="month-input">Report Month Select Karein</label>
        <input type="month" id="month-input" class="w-full md:w-60 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500" />
        <p id="current-month-label" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <div class="flex-1 md:text-right">
        <p class="text-xs text-gray-500 mb-1">User</p>
        <p id="user-name-display" class="font-semibold text-gray-800 urdu-font text-base">Loading...</p>
        <p id="user-zimmedari-display" class="text-xs text-gray-500 urdu-font">...</p>
      </div>
    </section>

    <section id="info-cards" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-emerald-800 mb-2">Kaam ka Tarz</h2>
        <ul class="text-xs text-emerald-800 space-y-1 urdu-font">
          <li>‚Ä¢ <b>Portal Link</b>: Har Jamia ke card par üîó button se link copy karein.</li>
          <li>‚Ä¢ Yeh link Teacher ko bhejein, wo khud upload kar sakenge.</li>
        </ul>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-blue-800 mb-2">Saved Recordings</h2>
        <ul class="text-xs text-blue-800 space-y-1 urdu-font mt-1">
          <li>‚Ä¢ Talimi Zimmedar ke tasurat update kar sakte hain.</li>
          <li>‚Ä¢ Har entry ka PDF report download kar sakte hain.</li>
        </ul>
      </div>
      <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-amber-800 mb-2">Note</h2>
        <ul class="text-xs text-amber-800 space-y-1 urdu-font">
          <li>‚Ä¢ Month badlenge to us month ki Tadris list show hogi.</li>
          <li>‚Ä¢ Teacher Portal wala data bhi yahi show hoga.</li>
        </ul>
      </div>
    </section>

    <section id="tadris-main-section" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-gray-800 urdu-font">Jamia Wise Tadris Recording</h2>
        <span id="tadris-status-chip" class="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700">
          <span class="w-2 h-2 rounded-full bg-gray-400"></span>
          <span id="tadris-status-text">Loading...</span>
        </span>
      </div>

      <p id="tadris-loading-msg" class="text-center text-gray-500 text-sm mb-4">Loading Jamiaat...</p>
      <p id="tadris-no-data-msg" class="text-center text-red-500 text-sm mb-4 hidden">Academic Structure nahi mila. Pehle main app se setup karein.</p>

      <div id="tadris-accordion-container" class="space-y-4"></div>
    </section>

    <section id="saved-section" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10 hidden">
      <h2 class="text-lg font-semibold urdu-font mb-4">Saari Jamiaat ki Saved Recordings</h2>

      <div id="saved-filters" class="mb-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs text-gray-600 mb-1 urdu-font">Jamia</label>
          <select id="filter-jamia" class="w-full p-2 border rounded-lg text-sm urdu-font">
            <option value="">-- Sab Jamiaat --</option>
          </select>
        </div>

        <div>
          <label class="block text-xs text-gray-600 mb-1 urdu-font">Teacher</label>
          <input id="filter-teacher" type="text" placeholder="Teacher ka naam..." class="w-full p-2 border rounded-lg text-sm urdu-font" />
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
  <label class="block text-xs text-gray-600 mb-1 urdu-font">Date Range</label>
  <input id="filter-date-range" type="text" placeholder="Select Date Range..." class="w-full p-2 border rounded-lg text-sm bg-white" readonly />
</div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border">
         <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1 text-center w-12">Sr. No.</th>
            <th class="border px-2 py-1">Jamia</th>
    <th class="border px-2 py-1">Class</th>
    <th class="border px-2 py-1">Kitab</th>
    <th class="border px-2 py-1">Teacher</th>
    <th class="border px-2 py-1">Date</th>
    <th class="border px-2 py-1">Mufattish ke Tasuraat</th>
    <th class="border px-2 py-1">Zimmedar Comment</th>
    <th class="border px-2 py-1">Status</th>
    <th class="border px-2 py-1">PDF</th>
          </tr>
        </thead>
          <tbody id="saved-table-body"></tbody>
        </table>
      </div>
    </section>

  </div>
  <div id="comment-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
          <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                <h3 class="text-base font-semibold leading-6 text-gray-900 urdu-font" id="modal-title">Zimmedar Comment Edit Karein</h3>
                <div class="mt-2">
                  <p id="modal-recording-info" class="text-xs text-gray-500 mb-2 urdu-font">...</p>
                  <textarea id="modal-comment-input" rows="4" class="w-full p-2 border border-gray-300 rounded-md text-sm urdu-font focus:ring-teal-500 focus:border-teal-500" placeholder="Apna tabsera yahan likhein..."></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
            <button type="button" id="modal-save-btn" class="inline-flex w-full justify-center rounded-md bg-teal-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-teal-500 sm:ml-3 sm:w-auto">Save Comment</button>
            <button type="button" onclick="closeCommentModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
<div id="audio-modal" class="fixed inset-0 z-[110] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-80 transition-opacity backdrop-blur-sm" onclick="closeAudioPlayer()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4">
        
        <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all w-full max-w-md border border-gray-200">
          
          <div class="bg-gradient-to-r from-teal-600 to-emerald-600 p-4 text-white flex justify-between items-start">
             <div>
                <h3 id="audio-player-title" class="text-lg font-bold urdu-font">Teacher Name</h3>
                <p id="audio-player-subtitle" class="text-xs text-emerald-100 opacity-90 urdu-font mt-1">Class - Kitab</p>
             </div>
             <button onclick="closeAudioPlayer()" class="text-white hover:text-red-200 transition">
                <i class="fas fa-times text-xl"></i>
             </button>
          </div>

          <div class="p-6 bg-gray-50">
             
             <audio id="custom-audio-element"></audio>

             <div class="mb-4">
               <input type="range" id="audio-progress" value="0" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-teal-600" oninput="seekAudio()">
               <div class="flex justify-between text-xs text-gray-500 font-mono mt-1">
                  <span id="audio-current-time">00:00</span>
                  <span id="audio-duration">00:00</span>
               </div>
             </div>

             <div class="flex justify-center items-center gap-6">
                <button onclick="skipAudio(-10)" class="text-gray-400 hover:text-teal-600 transition"><i class="fas fa-backward"></i> 10s</button>
                
                <button id="play-pause-btn" onclick="toggleAudioPlay()" class="w-14 h-14 rounded-full bg-teal-600 text-white shadow-lg hover:bg-teal-700 hover:scale-105 transition flex items-center justify-center">
                    <i class="fas fa-play text-xl ml-1"></i>
                </button>
                
                <button onclick="skipAudio(10)" class="text-gray-400 hover:text-teal-600 transition">10s <i class="fas fa-forward"></i></button>
             </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  <script type="module">
    // ============================
    // 1. IMPORTS & CONFIG
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
      authDomain: "data-f15ab.firebaseapp.com",
      projectId: "data-f15ab",
      storageBucket: "data-f15ab.firebasestorage.app",
      messagingSenderId: "449137002393",
      appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
      measurementId: "G-1PHNJQWNPZ",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ============================
    // 2. HELPER FUNCTIONS
    // ============================
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return "";
      return String(unsafe)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function getReportingInfoFromMonthInput(inputValue) {
      if (!inputValue) {
        const now = new Date();
        const m = now.getMonth();
        const y = now.getFullYear();
        const monthInputFormat = y + "-" + String(m + 1).padStart(2, "0");
        const monthName = now.toLocaleString("default", { month: "long" });
        return { monthNum: m, yearNum: y, monthName, monthInputFormat };
      }
      const [yearStr, monthStr] = inputValue.split("-");
      const yearNum = parseInt(yearStr);
      const monthNum = parseInt(monthStr) - 1;
      const date = new Date(yearNum, monthNum, 1);
      const monthName = date.toLocaleString("default", { month: "long" });
      return { monthNum, yearNum, monthName, monthInputFormat: inputValue };
    }

    const showLoader = (show) => {
      const loader = document.getElementById("loader");
      if (loader) loader.classList.toggle("hidden", !show);
    };

    const showNotification = (message, isError = false) => {
      const notification = document.getElementById("notification");
      if (!notification) return;
      notification.textContent = message;
      notification.className = "fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform " + (isError ? "bg-red-500" : "bg-emerald-600");
      notification.classList.remove("hidden", "translate-x-full");
      setTimeout(() => { notification.classList.add("translate-x-full"); setTimeout(() => notification.classList.add("hidden"), 300); }, 2500);
    };

    // ============================
    // 3. GLOBAL VARIABLES
    // ============================
    let currentUser = null;
    let userProfileData = {};
    let allReports = [];
    let currentReport = {};
    let reportRef = null;
    
    // Globals for DOM Elements
    const tadrisAccordionContainer = document.getElementById("tadris-accordion-container");
    const monthInput = document.getElementById("month-input");
    const tadrisLoadingMsg = document.getElementById("tadris-loading-msg");
    const tadrisNoDataMsg = document.getElementById("tadris-no-data-msg");
    const tadrisStatusText = document.getElementById("tadris-status-text");
    const tadrisStatusChip = document.getElementById("tadris-status-chip");

    // Teaching Structure globals
    window.JAMIA_TEACHER_MAP = {};
    window.JAMIA_CLASS_MAP = {};
    window.KARKARDAGI_STRUCTURE = [];

    // ============================
    // 4. AUTH & INITIALIZATION
    // ============================
    onAuthStateChanged(auth, async (user) => {
      showLoader(true);
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      try {
        const userDocRef = doc(db, "users", user.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          userProfileData = snap.data();
          document.getElementById("user-name-display").textContent = userProfileData.name || "N/A";
          document.getElementById("user-zimmedari-display").textContent = userProfileData.zimmedari || "N/A";
        }
        
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        monthInput.value = lastMonth.getFullYear() + "-" + String(lastMonth.getMonth() + 1).padStart(2, "0");
        updateMonthLabel();

        const reportsRef = collection(db, "monthly_reports");
        const qReports = query(reportsRef, where("userId", "==", user.uid));
        onSnapshot(qReports, (snapshot) => {
            allReports = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
            renderForCurrentMonth();
          });
      } catch (err) {
        console.error(err);
      } finally {
        showLoader(false);
      }
    });

    monthInput.addEventListener("change", async () => {
      updateMonthLabel();
      if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);
      renderForCurrentMonth();
    });

    function updateMonthLabel() {
      const info = getReportingInfoFromMonthInput(monthInput.value);
      document.getElementById("current-month-label").textContent = `Report for: ${info.monthName} ${info.yearNum}`;
    }

    // ============================
    // 5. DATA LOADING LOGIC
    // ============================
    async function loadTeachingStructureFromUserDoc(user) {
      try {
        window.JAMIA_TEACHER_MAP = {};
        window.JAMIA_CLASS_MAP = {};
        const uid = user ? user.uid : null;
        let karkardagi = [];

        if (uid) {
          try {
            const userDocRef = doc(db, "users", uid);
            const userSnap = await getDoc(userDocRef);
            if (userSnap.exists()) {
              const userData = userSnap.data() || {};
              const info = getReportingInfoFromMonthInput(monthInput.value);
              const academicYear = info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum+1}` : `${info.yearNum-1}-${info.yearNum}`;
              if (userData.academicYears && userData.academicYears[academicYear] && Array.isArray(userData.academicYears[academicYear].karkardagiStructure)) {
                karkardagi = userData.academicYears[academicYear].karkardagiStructure;
              } else if (Array.isArray(userData.karkardagiStructure) && userData.karkardagiStructure.length) {
                karkardagi = userData.karkardagiStructure;
              }
            }
          } catch (e) { console.warn("User struct error:", e); }
        }
        
        if (!karkardagi.length) {
           const info = getReportingInfoFromMonthInput(monthInput.value);
           const academicYear = info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum+1}` : `${info.yearNum-1}-${info.yearNum}`;
           try {
             const kRef = doc(db, "karkardagiStructure", academicYear);
             const kSnap = await getDoc(kRef);
             if (kSnap.exists()) {
               const data = kSnap.data();
               karkardagi = Array.isArray(data.structure) ? data.structure : (Array.isArray(data.karkardagiStructure) ? data.karkardagiStructure : []);
             }
           } catch(e) {}
        }
        
        window.KARKARDAGI_STRUCTURE = karkardagi || [];

        (karkardagi || []).forEach(jamiaObj => {
          const jamiaName = (jamiaObj.jamiaName || jamiaObj.name || "").toString();
          if (!jamiaName) return;
          window.JAMIA_TEACHER_MAP[jamiaName] = {};
          
          let teachers = Array.isArray(jamiaObj.teachers) ? jamiaObj.teachers : [];
          teachers.forEach(t => {
            const teacherName = (t.name || t.teacherName || "").toString();
            if (!teacherName) return;
            window.JAMIA_TEACHER_MAP[jamiaName][teacherName] = [];
            (t.periods || []).forEach(p => {
               window.JAMIA_TEACHER_MAP[jamiaName][teacherName].push({
                 className: p.className || p.class || "",
                 bookName: p.bookName || p.kitab || ""
               });
            });
          });
        });

      } catch (err) { console.error(err); }
    }

    function getCurrentReportForSelectedMonth() {
      if (!currentUser) return { report: {}, ref: null };
      const info = getReportingInfoFromMonthInput(monthInput.value);
      const academicYear = info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum + 1}` : `${info.yearNum - 1}-${info.yearNum}`;
      const simpleId = `${currentUser.uid}_${info.yearNum}_${info.monthNum}`;
      const withYearId = `${currentUser.uid}_${academicYear}_${info.yearNum}_${info.monthNum}`;
      const found = allReports.find(r => r.id === withYearId) || allReports.find(r => r.id === simpleId);
      const newRef = doc(db, "monthly_reports", found ? found.id : withYearId);
      return { report: found || {}, ref: newRef, meta: { ...info, academicYear } };
    }

    async function ensureReportBaseFields(ref, meta) {
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { userId: currentUser.uid, month: meta.monthName, year: meta.yearNum, academicYear: meta.academicYear, monthNum: meta.monthNum, monthKey: meta.monthInputFormat, createdAt: serverTimestamp() }, { merge: true });
      }
    }

    // ============================
    // 6. MAIN RENDER FUNCTION
    // ============================
    let renderForCurrentMonth = async function() {
      if (!tadrisAccordionContainer) return;
      showLoader(true);
      tadrisAccordionContainer.innerHTML = "";
      tadrisLoadingMsg.classList.remove("hidden");
      tadrisNoDataMsg.classList.add("hidden");

      try {
        if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);
        const { report, ref, meta } = getCurrentReportForSelectedMonth();
        reportRef = ref;
        currentReport = report;

        const academicData = (Array.isArray(window.KARKARDAGI_STRUCTURE) && window.KARKARDAGI_STRUCTURE.length)
          ? window.KARKARDAGI_STRUCTURE
          : [];

        if (!academicData.length) {
          tadrisLoadingMsg.classList.add("hidden");
          tadrisNoDataMsg.classList.remove("hidden");
          tadrisStatusText.textContent = "No Structure";
          tadrisStatusChip.className = "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-red-50 text-red-700";
          showLoader(false);
          return;
        }

        await ensureReportBaseFields(reportRef, meta);
        const existingSnap = await getDoc(reportRef);
        const existingData = existingSnap.exists() ? existingSnap.data() : {};
        const tadrisData = existingData.tadrisRecording?.data || [];
        
        tadrisStatusText.textContent = tadrisData.length > 0 ? "Active" : "Pending";
        tadrisStatusChip.className = "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700";
        tadrisLoadingMsg.classList.add("hidden");

        academicData.forEach((jamia, index) => {
          const jamiaName = jamia.jamiaName || jamia.name || `Jamia #${index+1}`;
          const jamiaSaved = tadrisData.filter((r) => r.jamiaName === jamiaName);

          const accordionItem = document.createElement("div");
          accordionItem.className = "border border-gray-200 rounded-xl overflow-hidden bg-gray-50 jamia-card";

          // HEADER WITH COPY BUTTON (No Inner Link Section)
          const header = document.createElement("button");
          header.className = "accordion-button w-full flex items-center justify-between px-4 md:px-5 py-3 bg-white hover:bg-slate-50";
          header.innerHTML = `
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-teal-100 text-teal-700 text-sm font-semibold">${index + 1}</span>
              <div class="text-left">
                <p class="font-semibold text-gray-800 urdu-font jamia-title">${escapeHtml(jamiaName)}</p>
                <p class="text-[11px] text-gray-500">Saved: ${jamiaSaved.length}</p>
              </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button 
                  type="button"
                  class="header-copy-btn text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 p-2 rounded-full transition shadow-sm border border-indigo-100"
                  data-jamia-name="${escapeHtml(jamiaName)}"
                  title="Copy Portal Link"
                >
                  <i class="fas fa-link text-sm"></i>
                </button>
                
                <div class="flex items-center gap-2 text-xs text-gray-500">
                   <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
                </div>
            </div>
          `;

          const content = document.createElement("div");
          content.className = "accordion-content border-t border-gray-200 bg-gray-50";

                    // Yahan se copy karein
          content.innerHTML = `
            <div class="p-4 md:p-5 space-y-4">
              <div class="space-y-3 bg-white rounded-xl shadow-sm p-3 md:p-4 border border-gray-200">
                <h3 class="text-sm font-semibold text-gray-800 urdu-font mb-1">Nayi Recording Add Karein</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Teacher</label><select class="tadris-teacher-select w-full p-2 border rounded-lg bg-white text-xs"><option value="">Select</option></select></div>
                    <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Class</label><select class="tadris-class-select w-full p-2 border rounded-lg bg-white text-xs" disabled><option value="">Select</option></select></div>
                    <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Kitab</label><select class="tadris-kitab-select w-full p-2 border rounded-lg bg-white text-xs" disabled><option value="">Select</option></select></div>
                    <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Date</label><input type="date" class="tadris-date w-full p-2 border rounded-lg text-xs" /></div>
                </div>
                <div class="mt-2"><label class="block text-[11px] font-medium text-gray-600 mb-1">File (MP3)</label><input type="file" accept="audio/*" class="tadris-audio-file w-full text-xs" /></div>
                <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Tasurat (Admin)</label><textarea rows="2" class="tadris-tasurat w-full p-2 border rounded-lg text-xs"></textarea></div>
                <div class="flex justify-end"><button type="button" class="add-tadris-entry-btn px-4 py-2 rounded-lg text-xs font-semibold bg-emerald-600 text-white" data-jamia-name="${escapeHtml(jamiaName)}">Upload & Save</button></div>
              </div>
            </div>`;

          accordionItem.appendChild(header);
          accordionItem.appendChild(content);
          tadrisAccordionContainer.appendChild(accordionItem);
          
          // Populate Dropdowns
          const jamiaTeachers = window.JAMIA_TEACHER_MAP[jamiaName] || {};
          const tSel = content.querySelector('.tadris-teacher-select');
          const cSel = content.querySelector('.tadris-class-select');
          const kSel = content.querySelector('.tadris-kitab-select');
          
          Object.keys(jamiaTeachers).forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; tSel.appendChild(o); });
          
          tSel.onchange = function() {
             cSel.innerHTML='<option>Select</option>'; kSel.innerHTML='<option>Select</option>';
             const cls = [...new Set((jamiaTeachers[this.value]||[]).map(x=>x.className))];
             cls.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cSel.appendChild(o); });
             cSel.disabled=false;
          };
          
          cSel.onchange = function() {
             kSel.innerHTML='<option>Select</option>';
             const bks = [...new Set((jamiaTeachers[tSel.value]||[]).filter(x=>x.className===this.value).map(x=>x.bookName))];
             bks.forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; kSel.appendChild(o); });
             kSel.disabled=false;
          };

          // --- EVENT LISTENER FOR COPY LINK BUTTON (Stop Propagation) ---
          const copyBtn = header.querySelector('.header-copy-btn');
          if(copyBtn) {
              copyBtn.addEventListener('click', (e) => {
                  e.stopPropagation(); // DROP DOWN NAHI KHOLEGA
                  const jName = e.currentTarget.dataset.jamiaName;
                  const info = getReportingInfoFromMonthInput(monthInput.value);
                  const activeYear = info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum+1}` : `${info.yearNum-1}-${info.yearNum}`;
                  
                  const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/tadris-teacher-portal.html';
                  const link = `${baseUrl}?jamiaId=${encodeURIComponent(jName)}&userId=${currentUser.uid}&activeYear=${encodeURIComponent(activeYear)}`;
                  
                  navigator.clipboard.writeText(link).then(() => showNotification("Link Copy ho gaya!"));
              });
          }

                  });
        renderSavedTable();
      } catch (err) { console.error("Error Rendering Jamia:", err); } finally { showLoader(false); }
    };

    // ============================
    // 7. SAVE RECORDING FUNCTION
    // ============================
    async function saveNewRecordingToReport(payload) {
      if (!reportRef) throw new Error("Report reference not ready.");
      const docSnap = await getDoc(reportRef);
      const existing = docSnap.exists() ? docSnap.data() : {};
      const arr = Array.isArray(existing.tadrisRecording?.data) ? existing.tadrisRecording.data.slice() : [];
      const clientTsISO = new Date().toISOString();
      
      const toSave = Object.assign({
        id: `local-${Date.now()}`,
        jamiaName: payload.jamiaName || "",
        teacherName: payload.teacherName || "",
        className: payload.className || "",
        kitabName: payload.kitabName || "",
        date: payload.date || clientTsISO.slice(0,10),
        tasurat: payload.tasurat || "",
        adminTasurat: payload.adminTasurat || "",
        createdAt: clientTsISO
      }, payload);
      
      arr.push(toSave);
      await setDoc(reportRef, { tadrisRecording: { data: arr, status: existing.tadrisRecording?.status || "Pending" } }, { merge: true });
    }

    // ============================
    // UPDATED FUNCTION: Render Saved Table
    // ============================
    function renderSavedTable() {
      const tbody = document.getElementById("saved-table-body");
      const jamiaFilterSelect = document.getElementById("filter-jamia");
      
      if (!tbody) return;
      tbody.innerHTML = "";

      // --- DATA COLLECTION STRATEGY ---
      // 1. Koshish karein allReports (Query) se data lene ki
      let sourceData = [];
      if (allReports && allReports.length > 0) {
          sourceData = allReports;
      } 
      // 2. Agar allReports khali hai (Index issue), to Current Report use karein (jo Accordion me dikh raha hai)
      else if (currentReport && currentReport.tadrisRecording) {
          console.log("Using currentReport for table fallback");
          sourceData = [currentReport];
      }

      // 3. Flatten data (Reports -> Recordings list)
      let allRecordings = [];
      sourceData.forEach(report => {
        if (report.tadrisRecording && Array.isArray(report.tadrisRecording.data)) {
          const entries = report.tadrisRecording.data.map(item => ({
              ...item, 
              reportMonth: report.month || "Unknown"
          }));
          allRecordings = allRecordings.concat(entries);
        }
      });

      console.log("Total Recordings Found for Table:", allRecordings.length);

      // --- FILTER VALUES ---
      const filterJamia = jamiaFilterSelect ? jamiaFilterSelect.value : "";
      const filterTeacherEl = document.getElementById("filter-teacher");
      const filterTeacher = filterTeacherEl ? filterTeacherEl.value.toLowerCase() : "";
      
      // NAYA DATE LOGIC STARTS HERE
      const dateRangeInput = document.getElementById("filter-date-range");
      let filterDateFrom = "";
      let filterDateTo = "";
      
      if (dateRangeInput && dateRangeInput.value) {
          // Flatpickr format: "2025-01-01 to 2025-01-15"
          const parts = dateRangeInput.value.split(" to ");
          filterDateFrom = parts[0]; 
          filterDateTo = parts[1] || parts[0]; // Agar single date select ki to wahi end date hogi
      }
      // NAYA DATE LOGIC ENDS HERE

      const filtered = allRecordings.filter(rec => {
        const jMatch = !filterJamia || rec.jamiaName === filterJamia;
        const tMatch = !filterTeacher || (rec.teacherName || "").toLowerCase().includes(filterTeacher);
        
        let dMatch = true;
        if (filterDateFrom) dMatch = dMatch && (rec.date >= filterDateFrom);
        if (filterDateTo) dMatch = dMatch && (rec.date <= filterDateTo); // <= logic check
        
        return jMatch && tMatch && dMatch;
      });

      // --- JAMIA DROPDOWN POPULATE ---
      if(jamiaFilterSelect && jamiaFilterSelect.options.length <= 1) {
          const uniqueJamias = [...new Set(allRecordings.map(r => r.jamiaName))].sort();
          uniqueJamias.forEach(j => {
              if(j) {
                  const opt = document.createElement("option");
                  opt.value = j;
                  opt.textContent = j;
                  jamiaFilterSelect.appendChild(opt);
              }
          });
      }

      // --- RENDER ROWS ---
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500 text-sm">No recordings found.</td></tr>`;
        return;
      }

      filtered.forEach((rec, index) => { // <--- Note: added 'index' here
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 transition-colors";
        
        const jamia = escapeHtml(rec.jamiaName);
        const teacher = escapeHtml(rec.teacherName);
        const cls = escapeHtml(rec.className);
        const kitab = escapeHtml(rec.kitabName);
        const date = escapeHtml(rec.date);
        const adminComment = escapeHtml(rec.tasurat || "-");
        const zimmedarComment = escapeHtml(rec.adminTasurat || "-");
        const audioLink = rec.url 
            ? `<button type="button" 
                  class="bg-teal-50 text-teal-700 hover:bg-teal-600 hover:text-white px-3 py-1 rounded-full text-xs font-semibold transition border border-teal-200 flex items-center gap-1 mx-auto"
                  onclick="openAudioPlayer('${rec.url}', '${encodeURIComponent(rec.teacherName)}', '${encodeURIComponent(rec.className + ' - ' + rec.kitabName)}')"
               >
                  <i class="fas fa-play"></i> Play
               </button>`
            : `<span class="text-gray-400 text-xs italic">No Audio</span>`;
        
              
        tr.innerHTML = `
            <td class="border px-2 py-2 text-center text-gray-500 font-bold">${index + 1}</td>
            <td class="border px-2 py-2 urdu-font">${jamia}</td>
            <td class="border px-2 py-2 urdu-font">${cls}</td>
            <td class="border px-2 py-2 urdu-font">${kitab}</td>
            <td class="border px-2 py-2 urdu-font">${teacher}</td>
            <td class="border px-2 py-2 text-xs">${date}</td>
            <td class="border px-2 py-2 text-xs truncate max-w-[120px]" title="${adminComment}">${adminComment}</td>
            
            <td class="border px-2 py-2 text-center">
                <div class="flex items-center justify-between gap-1 max-w-[150px] mx-auto">
                    <span class="text-xs truncate text-gray-700 urdu-font block w-full text-left" title="${zimmedarComment}">
                        ${zimmedarComment !== '-' ? zimmedarComment : '<span class="text-gray-400 italic">No comment</span>'}
                    </span>
                    <button type="button" class="text-teal-600 hover:text-teal-800 p-1 rounded hover:bg-teal-50 transition"
                        onclick="openCommentModal('${rec.id}', '${encodeURIComponent(rec.jamiaName)}', '${encodeURIComponent(rec.teacherName)}', '${encodeURIComponent(rec.className)}', '${encodeURIComponent(rec.kitabName)}', '${encodeURIComponent(zimmedarComment)}')"
                        title="Edit Comment">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>

            <td class="border px-2 py-2 text-xs text-center">${audioLink}</td>
            <td class="border px-2 py-2 text-center">
                 <button type="button" class="download-tadris-pdf-btn bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 px-2 py-1 rounded text-xs transition"
                    data-jamia-name="${encodeURIComponent(rec.jamiaName)}" 
                    data-teacher-name="${encodeURIComponent(rec.teacherName)}" 
                    data-class-name="${encodeURIComponent(rec.className)}" 
                    data-kitab-name="${encodeURIComponent(rec.kitabName)}" 
                    data-date="${rec.date}" 
                    data-tasurat="${encodeURIComponent(rec.tasurat || '')}"
                    data-zimmedar-tasurat="${encodeURIComponent(rec.adminTasurat || '')}"> <i class="fas fa-file-pdf"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
      });

      // Re-attach PDF listeners
      tbody.querySelectorAll('.download-tadris-pdf-btn').forEach(b => b.addEventListener('click', window.handleDownloadTadrisPDF));
    }

    // ============================
    // 8. DELEGATED ADD RECORDING HANDLER
    // ============================
    (function installDelegatedAddRecordingHandler() {
      if (window._delegatedAddRecordingInstalled) return;
      window._delegatedAddRecordingInstalled = true;

      document.body.addEventListener('click', async function (ev) {
        const btn = ev.target.closest('button.add-tadris-entry-btn');
        if (!btn) return;
        ev.preventDefault?.();

        const card = btn.closest('.jamia-card') || btn.closest('.accordion-content');
        if (!card) return;

        // Elements
        const jamiaName = btn.dataset.jamiaName || "";
        const teacherEl = card.querySelector('select.tadris-teacher-select');
        const classEl = card.querySelector('select.tadris-class-select');
        const kitabEl = card.querySelector('select.tadris-kitab-select');
        const dateEl = card.querySelector('input.tadris-date');
        const tasuratEl = card.querySelector('textarea.tadris-tasurat');
        const fileEl = card.querySelector('input.tadris-audio-file');

        const teacher = teacherEl?.value || "";
        const className = classEl?.value || "";
        const kitab = kitabEl?.value || "";
        const date = dateEl?.value || "";
        const tasurat = tasuratEl?.value || "";
        const file = fileEl?.files[0];

        // Validation
        if (!jamiaName || !teacher || !className || !kitab || !date) {
            alert('Meherbani karke Teacher, Class, Kitab aur Date select karein.');
            return;
        }
        if (!file) {
            if(!confirm("Aapne koi recording file select nahi ki. Save karna chahte hain?")) return;
        }

        // UI Loading
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        showLoader(true);

        try {
            let downloadUrl = "";
            if (file) {
                const storagePath = `recordings/${currentUser.uid}/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, storagePath);
                const snapshot = await uploadBytes(storageRef, file);
                downloadUrl = await getDownloadURL(snapshot.ref);
            }

            const payload = {
                jamiaName, teacherName: teacher, className, kitabName: kitab,
                date, tasurat, createdBy: currentUser?.uid,
                url: downloadUrl, fileName: file ? file.name : ""
            };

            await saveNewRecordingToReport(payload);
            
            showNotification('Recording Saved!');
            if(tasuratEl) tasuratEl.value = "";
            if(fileEl) fileEl.value = "";
            
            setTimeout(() => renderForCurrentMonth(), 800);

        } catch (err) {
            console.error('Save Error:', err);
            showNotification('Error: ' + err.message, true);
        } finally {
            showLoader(false);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
      }, { capture: false });
    })();

    // ============================
    // FIXED PDF GENERATOR (Mobile Responsive)
    // ============================
    window.handleDownloadTadrisPDF = async function(e) {
      const btn = e.currentTarget;

      // Data Attributes se values lein
      const jamiaName = decodeURIComponent(btn.dataset.jamiaName || "N/A");
      const teacherName = decodeURIComponent(btn.dataset.teacherName || "N/A");
      const className = decodeURIComponent(btn.dataset.className || "");
      const kitabName = decodeURIComponent(btn.dataset.kitabName || "");
      const date = btn.dataset.date || "";
      
      const tasuratAdmin = decodeURIComponent(btn.dataset.tasurat || "") || "⁄©Ÿàÿ¶€å ÿ™ÿ®ÿµÿ±€Å ÿØÿ±ÿ¨ ŸÜ€Å€å⁄∫€î";
      let tasuratZimmedar = decodeURIComponent(btn.dataset.zimmedarTasurat || "");
      
      if (!tasuratZimmedar || tasuratZimmedar === "undefined" || tasuratZimmedar === "null") {
          tasuratZimmedar = "⁄©Ÿàÿ¶€å ÿ™ÿ®ÿµÿ±€Å ÿØÿ±ÿ¨ ŸÜ€Å€å⁄∫€î";
      }

      showLoader(true);
      
      try {
        // --- HTML CONTENT ---
        const pdfContentHTML = `
          <div style="direction:rtl; font-family:'Jameel Noori Nastaleeq', 'Arial', sans-serif; background-color:#fff; color:#111; position:relative;">
            
            <div style="padding:40px; width:794px; min-height:1120px; border:8px double #0d9488; background-color:#fdfdfd; box-sizing: border-box; margin:0 auto;">
              
              <div style="text-align:center; border-bottom:3px solid #0f766e; padding-bottom:15px; margin-bottom:25px;">
                <h1 style="font-size:36px; font-weight:900; color:#0f766e; margin:0; line-height:1.2;">ŸÖÿ¨ŸÑÿ≥ ÿ™ÿπŸÑ€åŸÖ€å ÿßŸÖŸàÿ± ÿßŸÜ⁄à€åÿß</h1>
                <h2 style="font-size:24px; font-weight:700; color:#333; margin:5px 0 0 0;">ÿ™ÿØÿ±€åÿ≥ ÿ±€å⁄©ÿßÿ±⁄àŸÜ⁄Ø ÿ±ŸæŸàÿ±Ÿπ</h2>
              </div>

              <table style="width:100%; border-collapse:collapse; margin-bottom:30px; border:2px solid #ccc; font-size:18px;">
                <tr style="background-color:#f0fdfa;">
                   <td style="padding:12px; border:1px solid #ccc; font-weight:bold; color:#0f766e; width:15%;">ÿ¨ÿßŸÖÿπ€Å:</td>
                   <td style="padding:12px; border:1px solid #ccc; width:35%;">${escapeHtml(jamiaName)}</td>
                   <td style="padding:12px; border:1px solid #ccc; font-weight:bold; color:#0f766e; width:15%;">ÿ™ÿßÿ±€åÿÆ:</td>
                   <td style="padding:12px; border:1px solid #ccc; width:35%; font-family:sans-serif; direction:ltr; text-align:right;">${escapeHtml(date)}</td>
                </tr>
                <tr>
                   <td style="padding:12px; border:1px solid #ccc; font-weight:bold; color:#0f766e;">ÿßÿ≥ÿ™ÿßÿØ:</td>
                   <td style="padding:12px; border:1px solid #ccc;">${escapeHtml(teacherName)}</td>
                   <td style="padding:12px; border:1px solid #ccc; font-weight:bold; color:#0f766e;">ÿØÿ±ÿ¨€Å / ⁄©ÿ™ÿßÿ®:</td>
                   <td style="padding:12px; border:1px solid #ccc;">${escapeHtml(className)} - ${escapeHtml(kitabName)}</td>
                </tr>
              </table>

              <div style="margin-bottom:25px; border:2px solid #10b981; border-radius:12px; overflow:hidden; background-color:#fff;">
                 <div style="background-color:#ecfdf5; padding:10px 15px; border-bottom:1px solid #10b981;">
                    <span style="font-size:20px; font-weight:bold; color:#047857;">ÿ±€å⁄©ÿßÿ±⁄àŸÜ⁄Ø Ÿæÿ± ŸÖŸÅÿ™ÿ¥ ⁄©€í ÿ™ÿßÿ´ÿ±ÿßÿ™</span>
                 </div>
                 <div style="padding:20px; font-size:18px; line-height:1.8; color:#333; min-height:120px; text-align:justify;">
                    ${escapeHtml(tasuratAdmin)}
                 </div>
              </div>

              <div style="margin-bottom:40px; border:2px solid #3b82f6; border-radius:12px; overflow:hidden; background-color:#fff;">
                 <div style="background-color:#eff6ff; padding:10px 15px; border-bottom:1px solid #3b82f6;">
                    <span style="font-size:20px; font-weight:bold; color:#1d4ed8;">ÿ™ÿπŸÑ€åŸÖ€å ÿ∞ŸÖ€Å ÿØÿßÿ± ⁄©€í ÿ™ÿßÿ´ÿ±ÿßÿ™</span>
                 </div>
                 <div style="padding:20px; font-size:18px; line-height:1.8; color:#333; min-height:120px; text-align:justify;">
                    ${escapeHtml(tasuratZimmedar)}
                 </div>
              </div>

              <div style="text-align:center; margin-top:50px; padding-top:20px; border-top:1px dashed #ccc; color:#666; font-size:12px; font-family:sans-serif;">
                This report is computer generated by Majlis Talimi Umoor Portal.
              </div>

            </div>
          </div>
        `;

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = pdfContentHTML;
        
        // --- MOBILE FIX: Explicitly set Width ---
        tempDiv.style.width = "794px"; 
        tempDiv.style.position = "fixed"; // Fixed prevents scrolling issues
        tempDiv.style.left = "-9999px";
        tempDiv.style.top = "0";
        document.body.appendChild(tempDiv);

        // Wait for fonts/styles
        await new Promise(resolve => setTimeout(resolve, 500));

        // --- MOBILE FIX: WindowWidth Option ---
        const canvas = await window.html2canvas(tempDiv, { 
            scale: 2, 
            useCORS: true, 
            allowTaint: true,
            windowWidth: 794, // Force desktop width simulation
            width: 794,       // Force canvas width
            scrollY: 0
        });
        
        const imgData = canvas.toDataURL("image/jpeg", 0.9);

        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
        
        const pdfWidth = docPdf.internal.pageSize.getWidth(); // 210mm
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        docPdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);

        const safeName = `${teacherName.replace(/\s+/g,'_')}_${date}`;
        docPdf.save(`Tadris_Report_${safeName}.pdf`);
        
        document.body.removeChild(tempDiv);
        showNotification("PDF download ho gaya!");

      } catch (err) {
        console.error("PDF Error:", err);
        showNotification("PDF banane me masla aya.", true);
      } finally {
        showLoader(false);
      }
    };

    // Tabs Logic
    const tabAdd = document.getElementById("tab-add");
    const tabSaved = document.getElementById("tab-saved");
    const mainSection = document.getElementById("tadris-main-section");
    const savedSection = document.getElementById("saved-section");
    const infoCards = document.getElementById("info-cards");
    const topControls = document.getElementById("top-controls"); // <--- Yeh Naya Reference Hai

    function setActiveTab(isAdd) {
      if (isAdd) {
        // === ADD RECORDING TAB ===
        mainSection.classList.remove("hidden");
        savedSection.classList.add("hidden");
        
        // Sab kuch dikhao (Cards aur Month Selector)
        if(topControls) topControls.classList.remove("hidden"); 
        if(infoCards) infoCards.classList.remove("hidden");
        
        // Button Styles
        tabAdd.classList.add("bg-teal-600", "text-white");
        tabSaved.classList.remove("bg-teal-600", "text-white");
      } else {
        // === SAVED RECORDINGS TAB ===
        mainSection.classList.add("hidden");
        savedSection.classList.remove("hidden");
        
        // Sab kuch chhupao (Cards aur Month Selector)
        if(topControls) topControls.classList.add("hidden"); // <--- Ab ye bhi chhupega
        if(infoCards) infoCards.classList.add("hidden");
        
        // Button Styles
        tabSaved.classList.add("bg-teal-600", "text-white");
        tabAdd.classList.remove("bg-teal-600", "text-white");
      }
    }
    tabAdd.addEventListener("click", () => setActiveTab(true));
    tabSaved.addEventListener("click", () => {
        setActiveTab(false);
        renderSavedTable(); // <--- YEH LINE ADD KARNI HAI
    });
    setActiveTab(true);

    // Accordion Toggle
    tadrisAccordionContainer.addEventListener('click', (e) => {
       const btn = e.target.closest('.accordion-button');
       if(!btn) return;
       // (NOTE: copy-link-btn click event is STOPPED, so it wont reach here)
       const content = btn.nextElementSibling;
       const isOpen = btn.classList.toggle('open');
       content.classList.toggle('open', isOpen);
       content.style.maxHeight = isOpen ? content.scrollHeight + 500 + "px" : null;
    });
    // ============================
    // FILTERS ACTIVATION CODE
    // ============================
    // Isse filters type karte hi chalne lagenge
    const filterIds = ['filter-jamia', 'filter-teacher', 'filter-date-from', 'filter-date-to'];
    filterIds.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.addEventListener('input', () => {
                console.log("Filter changed:", id); // Checking
                renderSavedTable();
            });
            el.addEventListener('change', () => {
                 renderSavedTable();
            });
        }
    });
    // ============================
    // INITIALIZE DATE RANGE PICKER
    // ============================
    flatpickr("#filter-date-range", {
        mode: "range",          // Range select karne ke liye
        dateFormat: "Y-m-d",    // Date format match karne ke liye
        onClose: function(selectedDates, dateStr, instance) {
            renderSavedTable(); // Calendar band hote hi table update hogi
        }
    });

    // Baaki filters ke listeners
    ['filter-jamia', 'filter-teacher'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', renderSavedTable);
    });
// ============================
    // MODAL LOGIC FOR COMMENTS
    // ============================
    let currentEditingId = null; // Track karne ke liye ki konsi recording edit ho rahi hai

    window.openCommentModal = function(recId, jamia, teacher, cls, kitab, currentComment) {
        currentEditingId = recId;
        
        // UI Update
        document.getElementById('modal-recording-info').innerHTML = `
            <strong>${decodeURIComponent(jamia)}</strong> | ${decodeURIComponent(teacher)} <br>
            ${decodeURIComponent(cls)} - ${decodeURIComponent(kitab)}
        `;
        
        const decodedComment = decodeURIComponent(currentComment);
        document.getElementById('modal-comment-input').value = decodedComment === '-' ? '' : decodedComment;
        
        // Show Modal
        document.getElementById('comment-modal').classList.remove('hidden');
    };

    window.closeCommentModal = function() {
        document.getElementById('comment-modal').classList.add('hidden');
        currentEditingId = null;
    };

    // Save Button Logic
    document.getElementById('modal-save-btn').addEventListener('click', async function() {
        const newComment = document.getElementById('modal-comment-input').value.trim();
        const saveBtn = this;
        
        if(!currentEditingId) return;

        // UI Loading State
        const originalText = saveBtn.innerText;
        saveBtn.innerText = "Saving...";
        saveBtn.disabled = true;

        try {
            // Find the report containing this recording
            let targetReport = null;
            let targetIndex = -1;

            // Search in allReports (Local Data)
            for (let report of allReports) {
                if (report.tadrisRecording && report.tadrisRecording.data) {
                    const idx = report.tadrisRecording.data.findIndex(r => r.id === currentEditingId);
                    if (idx !== -1) {
                        targetReport = report;
                        targetIndex = idx;
                        break;
                    }
                }
            }

            if (targetReport && targetIndex !== -1) {
                // Update Local Data
                targetReport.tadrisRecording.data[targetIndex].adminTasurat = newComment; // Zimmedar Comment field update

                // Update Firebase
                const reportRef = doc(db, "monthly_reports", targetReport.id);
                await updateDoc(reportRef, {
                    "tadrisRecording.data": targetReport.tadrisRecording.data
                });

                showNotification("Comment update ho gaya!");
                closeCommentModal();
                renderSavedTable(); // Table refresh
            } else {
                showNotification("Recording nahi mili.", true);
            }

        } catch (error) {
            console.error("Error saving comment:", error);
            showNotification("Error: " + error.message, true);
        } finally {
            saveBtn.innerText = originalText;
            saveBtn.disabled = false;
        }
    });
    // ============================
    // CUSTOM AUDIO PLAYER LOGIC
    // ============================
    const audioEl = document.getElementById('custom-audio-element');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const progressBar = document.getElementById('audio-progress');
    const currentTimeEl = document.getElementById('audio-current-time');
    const durationEl = document.getElementById('audio-duration');

    window.openAudioPlayer = function(url, teacherName, kitabInfo) {
        if(!url) return;

        // UI Update
        document.getElementById('audio-player-title').textContent = decodeURIComponent(teacherName);
        document.getElementById('audio-player-subtitle').textContent = decodeURIComponent(kitabInfo);
        
        // Audio Source Set
        audioEl.src = url;
        audioEl.load();
        
        // Reset Controls
        playPauseBtn.innerHTML = '<i class="fas fa-play text-xl ml-1"></i>';
        progressBar.value = 0;
        currentTimeEl.textContent = "00:00";
        durationEl.textContent = "Loading...";

        // Show Modal
        document.getElementById('audio-modal').classList.remove('hidden');
        
        // Auto Play (Optional - hata sakte hain agar auto play na chahiye)
        toggleAudioPlay();
    };

    window.closeAudioPlayer = function() {
        audioEl.pause();
        audioEl.currentTime = 0;
        document.getElementById('audio-modal').classList.add('hidden');
    };

    window.toggleAudioPlay = function() {
        if (audioEl.paused) {
            audioEl.play();
            playPauseBtn.innerHTML = '<i class="fas fa-pause text-xl"></i>';
        } else {
            audioEl.pause();
            playPauseBtn.innerHTML = '<i class="fas fa-play text-xl ml-1"></i>';
        }
    };

    window.seekAudio = function() {
        const seekTime = (audioEl.duration / 100) * progressBar.value;
        audioEl.currentTime = seekTime;
    };
    
    window.skipAudio = function(seconds) {
        audioEl.currentTime += seconds;
    };

    // Event Listeners for Audio
    if(audioEl) {
        // Update Progress Bar automatically
        audioEl.addEventListener('timeupdate', () => {
            if(isNaN(audioEl.duration)) return;
            const progressPercent = (audioEl.currentTime / audioEl.duration) * 100;
            progressBar.value = progressPercent;
            
            // Update Time Text
            const curMins = Math.floor(audioEl.currentTime / 60);
            const curSecs = Math.floor(audioEl.currentTime % 60);
            const durMins = Math.floor(audioEl.duration / 60);
            const durSecs = Math.floor(audioEl.duration % 60);
            
            currentTimeEl.textContent = `${curMins}:${curSecs.toString().padStart(2, '0')}`;
            durationEl.textContent = `${durMins}:${durSecs.toString().padStart(2, '0')}`;
        });

        // Reset button when audio ends
        audioEl.addEventListener('ended', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-play text-xl ml-1"></i>';
            progressBar.value = 0;
        });
        
        // Duration loaded
        audioEl.addEventListener('loadedmetadata', () => {
             const durMins = Math.floor(audioEl.duration / 60);
             const durSecs = Math.floor(audioEl.duration % 60);
             durationEl.textContent = `${durMins}:${durSecs.toString().padStart(2, '0')}`;
        });
    }
  </script>
</body>
</html>














