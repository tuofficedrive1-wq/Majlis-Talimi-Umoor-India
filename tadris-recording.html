<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tadris Recording – Majlis Talimi Umoor India (Patched)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @font-face {
      font-family: "Jameel Noori Nastaleeq";
      src: url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2")
          format("woff2"),
        url("https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff")
          format("woff");
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF,
        U+FE70-FEFF;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: #f0f2f5;
    }
    .urdu-font {
      font-family: "Jameel Noori Nastaleeq", "Poppins", sans-serif;
      font-size: 1.05rem;
      line-height: 1.7;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #14b8a6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out,
        border-width 0.3s ease-out;
      padding-top: 0;
      padding-bottom: 0;
      border-top-width: 0;
    }
    .accordion-content.open {
      max-height: 2000px; /* Increased height for content */
      transition: max-height 0.5s ease-in, padding 0.3s ease-in,
        border-width 0.3s ease-in;
      padding-top: 1rem;
      padding-bottom: 1rem;
      border-top-width: 1px;
    }
    .accordion-button svg {
      transition: transform 0.3s ease-out;
    }
    .accordion-button { cursor: pointer; }
    
    .accordion-button.open svg {
      transform: rotate(180deg);
    }
    .comment-display {
      background-color: #f9fafb;
      border-left: 3px solid #14b8a6;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 4px;
    }

    /* hide saved-recordings inside add tab */
    .hide-saved .saved-recordings-list,
    .hide-saved .download-tadris-pdf-btn,
    .hide-saved .save-user-admin-tasurat-btn,
    .hide-saved .comment-display {
      display: none !important;
    }
    .hide-saved .space-y-2.saved-recordings-list {
      margin: 0;
      padding: 0;
    }

    /* hide top controls and info cards when in saved tab */
    .hide-top-controls #top-controls,
    .hide-top-controls #info-cards {
      display: none !important;
    }

    /* small responsive */
    @media (max-width:640px){
      .urdu-font { font-size: 0.95rem; }
    }

  </style>
</head>
<body class="antialiased text-gray-800">
  <div
    id="notification"
    class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform translate-x-full hidden"
  ></div>

  <div
    id="loader"
    class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-40 flex justify-center items-center z-[70] hidden"
  >
    <div class="loader"></div>
  </div>

  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header
      class="bg-white rounded-2xl shadow-md px-4 py-3 md:px-6 md:py-4 mb-6 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <button
          id="back-btn"
          class="inline-flex items-center gap-2 text-sm md:text-base text-teal-700 hover:text-teal-900 font-medium"
        >
          <i class="fas fa-arrow-left text-xs"></i>
          <span>Back to Dashboard</span>
        </button>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-500 mb-1">Majlis Talimi Umoor India</p>
        <h1 class="text-lg md:text-2xl font-bold text-gray-800 urdu-font">
          Tadris Recording Panel
        </h1>
      </div>
    </header>

    <div class="flex gap-3 mb-5">
      <button id="tab-add" class="px-4 py-2 rounded-lg transition-colors">Add Recording</button>
      <button id="tab-saved" class="px-4 py-2 rounded-lg transition-colors">Saved Recordings</button>
    </div>

    <section id="top-controls" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-6 flex flex-col md:flex-row md:items-end gap-4">
      <div class="flex-1">
        <label class="block text-xs font-semibold text-gray-600 mb-1" for="month-input">Report Month Select Karein</label>
        <input type="month" id="month-input" class="w-full md:w-60 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500" />
        <p id="current-month-label" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <div class="flex-1 md:text-right">
        <p class="text-xs text-gray-500 mb-1">User</p>
        <p id="user-name-display" class="font-semibold text-gray-800 urdu-font text-base">Loading...</p>
        <p id="user-zimmedari-display" class="text-xs text-gray-500 urdu-font">...</p>
      </div>
    </section>

    <section id="info-cards" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-emerald-800 mb-2">Kaam ka Tarz</h2>
        <ul class="text-xs text-emerald-800 space-y-1 urdu-font">
          <li>• <b>Portal Link</b>: Har Jamia ka link teacher ko bhejein taake wo khud upload karein.</li>
          <li>• Ya khud "Add Recording" se upload karein.</li>
        </ul>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-blue-800 mb-2">Saved Recordings</h2>
        <ul class="text-xs text-blue-800 space-y-1 urdu-font mt-1">
          <li>• Talimi Zimmedar ke tasurat update kar sakte hain.</li>
          <li>• Har entry ka PDF report download kar sakte hain.</li>
        </ul>
      </div>
      <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
        <h2 class="text-sm font-semibold text-amber-800 mb-2">Note</h2>
        <ul class="text-xs text-amber-800 space-y-1 urdu-font">
          <li>• Month badlenge to us month ki Tadris list show hogi.</li>
          <li>• Teacher Portal wala data bhi yahi show hoga.</li>
        </ul>
      </div>
    </section>

    <section id="tadris-main-section" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-gray-800 urdu-font">Jamia Wise Tadris Recording</h2>
        <span id="tadris-status-chip" class="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700">
          <span class="w-2 h-2 rounded-full bg-gray-400"></span>
          <span id="tadris-status-text">Loading...</span>
        </span>
      </div>

      <p id="tadris-loading-msg" class="text-center text-gray-500 text-sm mb-4">Loading Jamiaat...</p>
      <p id="tadris-no-data-msg" class="text-center text-red-500 text-sm mb-4 hidden">Academic Structure nahi mila. Pehle main app se setup karein.</p>

      <div id="tadris-accordion-container" class="space-y-4"></div>
    </section>

    <section id="saved-section" class="bg-white rounded-2xl shadow-md p-4 md:p-6 mb-10 hidden">
      <h2 class="text-lg font-semibold urdu-font mb-4">Saari Jamiaat ki Saved Recordings</h2>

      <div id="saved-filters" class="mb-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs text-gray-600 mb-1 urdu-font">Jamia</label>
          <select id="filter-jamia" class="w-full p-2 border rounded-lg text-sm urdu-font">
            <option value="">-- Sab Jamiaat --</option>
          </select>
        </div>

        <div>
          <label class="block text-xs text-gray-600 mb-1 urdu-font">Teacher</label>
          <input id="filter-teacher" type="text" placeholder="Teacher ka naam..." class="w-full p-2 border rounded-lg text-sm urdu-font" />
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-xs text-gray-600 mb-1 urdu-font">Date (From)</label>
            <input id="filter-date-from" type="date" class="w-full p-2 border rounded-lg text-sm" />
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1 urdu-font">Date (To)</label>
            <input id="filter-date-to" type="date" class="w-full p-2 border rounded-lg text-sm" />
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border">
         <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">Jamia</th>
            <th class="border px-2 py-1">Class</th>
            <th class="border px-2 py-1">Kitab</th>
            <th class="border px-2 py-1">Teacher</th>
            <th class="border px-2 py-1">Date</th>
            <th class="border px-2 py-1">Mufattish ke Tasuraat</th>
            <th class="border px-2 py-1">Zimmedar Comment</th>
            <th class="border px-2 py-1">Status</th>
            <th class="border px-2 py-1">PDF</th>
          </tr>
        </thead>
          <tbody id="saved-table-body"></tbody>
        </table>
      </div>
    </section>

  </div>

  <script type="module">
    // ============================
    // Firebase Imports
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // ============================
    // Firebase Config
    // ============================
    const firebaseConfig = {
      apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
      authDomain: "data-f15ab.firebaseapp.com",
      projectId: "data-f15ab",
      storageBucket: "data-f15ab.firebasestorage.app",
      messagingSenderId: "449137002393",
      appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
      measurementId: "G-1PHNJQWNPZ",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ============================
    // DOM Helpers & Globals
    // ============================
    const loader = document.getElementById("loader");
    const notification = document.getElementById("notification");
    const monthInput = document.getElementById("month-input");
    const currentMonthLabel = document.getElementById("current-month-label");
    const userNameDisplay = document.getElementById("user-name-display");
    const userZimmedariDisplay = document.getElementById("user-zimmedari-display");
    const backBtn = document.getElementById("back-btn");
    const tadrisAccordionContainer = document.getElementById("tadris-accordion-container");
    const tadrisLoadingMsg = document.getElementById("tadris-loading-msg");
    const tadrisNoDataMsg = document.getElementById("tadris-no-data-msg");
    const tadrisStatusChip = document.getElementById("tadris-status-chip");
    const tadrisStatusText = document.getElementById("tadris-status-text");

    const tabAdd = document.getElementById("tab-add");
    const tabSaved = document.getElementById("tab-saved");
    const savedSection = document.getElementById("saved-section");
    const topControls = document.getElementById("top-controls");
    const mainSection = document.getElementById("tadris-accordion-container").closest("section");

    const showLoader = (show) => {
      if (!loader) return;
      loader.classList.toggle("hidden", !show);
    };

    const showNotification = (message, isError = false) => {
      if (!notification) return;
      notification.textContent = message;
      notification.className =
        "fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform " +
        (isError ? "bg-red-500" : "bg-emerald-600");
      notification.classList.remove("hidden", "translate-x-full");
      void notification.offsetWidth;
      setTimeout(() => {
        notification.classList.remove("translate-x-full");
      }, 10);
      setTimeout(() => {
        notification.classList.add("translate-x-full");
        setTimeout(() => notification.classList.add("hidden"), 300);
      }, 2500);
    };

    const getReportingInfoFromMonthInput = (inputValue) => {
      if (!inputValue) {
        const now = new Date();
        const m = now.getMonth();
        const y = now.getFullYear();
        const monthInputFormat = y + "-" + String(m + 1).padStart(2, "0");
        const monthName = now.toLocaleString("default", { month: "long" });
        return {
          monthNum: m,
          yearNum: y,
          monthName,
          monthInputFormat,
        };
      }
      const [yearStr, monthStr] = inputValue.split("-");
      const yearNum = parseInt(yearStr);
      const monthNum = parseInt(monthStr) - 1;
      const date = new Date(yearNum, monthNum, 1);
      const monthName = date.toLocaleString("default", { month: "long" });
      return {
        monthNum,
        yearNum,
        monthName,
        monthInputFormat: inputValue,
      };
    };

    // ============================
    // PDF DOWNLOAD HANDLER
    // ============================
    window.handleDownloadTadrisPDF = async function(e) {
      const btn = e && e.currentTarget ? e.currentTarget : (e && e.target ? e.target : null);
      if (!btn) return;
      const jamiaName = decodeURIComponent(btn.dataset.jamiaName || "N/A");
      const teacherName = decodeURIComponent(btn.dataset.teacherName || "N/A");
      const className = decodeURIComponent(btn.dataset.className || "");
      const kitabName = decodeURIComponent(btn.dataset.kitabName || "");
      const date = btn.dataset.date || "";
      const tasuratAdmin = decodeURIComponent(btn.dataset.tasurat || "") || "کوئی تبصرہ درج نہیں۔";

      let tasuratZimmedar = "";
      const container = btn.closest('div.p-3') || btn.closest('tr') || btn.closest('.saved-recordings-list');
      if (container) {
        const textArea = container.querySelector('.user-admin-tasurat-input');
        if (textArea) tasuratZimmedar = textArea.value.trim();
      }
      if (!tasuratZimmedar) tasuratZimmedar = "کوئی تبصرہ درج نہیں۔";

      showLoader(true);
      try {
        const pdfContentHTML = `
          <div style="direction:rtl;font-family:'Jameel Noori Nastaleeq', Poppins, sans-serif;max-width:820px;margin:0 auto;padding:18px;color:#0b1220;">
            <div style="border-radius:14px;border:4px dotted rgba(37,99,235,0.9);padding:16px;">
              <div style="text-align:center;padding:10px 6px;border-radius:10px;background:linear-gradient(90deg,#0ea5a1,#2563eb);color:#fff;margin-bottom:12px;">
                <div style="font-size:26px;font-weight:900;line-height:1;">تدریس ریکارڈنگ رپورٹ</div>
                <div style="font-size:14px;font-weight:700;opacity:0.95;margin-top:4px;">مجلس تعلیمی امور انڈیا</div>
              </div>
              <div style="height:2px;background:#111;margin:8px 0 12px;"></div>
              <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;">
                <div style="flex:1;min-width:200px;">
                  <div style="font-size:13px;font-weight:700;color:#065f46;">جامعہ:</div>
                  <div style="margin-top:6px;font-size:15px;color:#0b1220;">${escapeHtml(jamiaName)}</div>
                </div>
                <div style="flex:1;min-width:200px;text-align:center;">
                  <div style="font-size:13px;font-weight:700;color:#0b1220;">استاد:</div>
                  <div style="margin-top:6px;font-size:15px;color:#0b1220;">${escapeHtml(teacherName)}</div>
                  <div style="margin-top:8px;font-size:12px;color:#334155;">تاریخ: <strong>${escapeHtml(date)}</strong></div>
                </div>
                <div style="flex:1;min-width:200px;text-align:left;">
                  <div style="font-size:13px;font-weight:700;color:#0b1220;">درجہ:</div>
                  <div style="margin-top:6px;font-size:15px;color:#0b1220;">${escapeHtml(className)}</div>
                  <div style="height:8px;"></div>
                  <div style="font-size:13px;font-weight:700;color:#0b1220;">کتاب:</div>
                  <div style="margin-top:6px;font-size:15px;color:#0b1220;">${escapeHtml(kitabName)}</div>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:16px;margin-top:16px;">
                <div style="position:relative;border-radius:10px;border:2px dashed rgba(16,185,129,0.9);background:linear-gradient(180deg, rgba(240,253,244,0.9), rgba(237,253,245,0.6));padding:14px;min-height:110px;">
                  <div style="position:absolute;right:14px;top:10px;font-weight:800;color:#065f46;border-bottom:2px solid rgba(6,95,70,0.12);padding-bottom:3px;">ریکارڈنگ پر مفتش کے تاثرات:</div>
                  <div style="margin-top:34px;font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:15px;color:#064e3b;min-height:72px;">${tasuratAdmin ? escapeHtml(tasuratAdmin) : 'کوئی تبصرہ درج نہیں۔'}</div>
                </div>
                <div style="position:relative;border-radius:10px;border:2px dashed rgba(37,99,235,0.9);background:linear-gradient(180deg, rgba(240,249,255,0.95), rgba(235,243,255,0.8));padding:14px;min-height:110px;">
                  <div style="position:absolute;right:14px;top:10px;font-weight:800;color:#1e3a8a;border-bottom:2px solid rgba(30,58,138,0.12);padding-bottom:3px;">تعلیمی ذمہ دار کے تاثرات:</div>
                  <div style="margin-top:34px;font-family:'Jameel Noori Nastaleeq',sans-serif;font-size:15px;color:#0b1220;min-height:72px;">${tasuratZimmedar ? escapeHtml(tasuratZimmedar) : 'کوئی تبصرہ درج نہیں۔'}</div>
                </div>
              </div>
              <div style="text-align:center;margin-top:24px;color:#6b7280;font-size:12px;">Generated: ${new Date().toLocaleString()}</div>
            </div>
          </div>
        `;

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = pdfContentHTML;
        tempDiv.style.position = "absolute";
        tempDiv.style.left = "-9999px";
        document.body.appendChild(tempDiv);

        const canvas = await window.html2canvas(tempDiv, { scale: 2, useCORS: true, allowTaint: true });
        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
        const imgProps = docPdf.getImageProperties(imgData);
        const pdfWidth = docPdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        docPdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);

        const safeName = `${teacherName.replace(/\s+/g,'_').replace(/[^\w\-]/g,'') || 'teacher'}_${date || new Date().toISOString().slice(0,10)}`;
        docPdf.save(`Tadris_Report_${safeName}.pdf`);
        document.body.removeChild(tempDiv);
        showNotification("PDF download ho gaya!");
      } catch (err) {
        console.error("PDF Error:", err);
        showNotification("PDF banane me masla aya.", true);
      } finally {
        showLoader(false);
      }
    };

    // ============================
    // Teaching Structure
    // ============================
    window.JAMIA_TEACHER_MAP = {};
    window.JAMIA_CLASS_MAP = {};
    window.KARKARDAGI_STRUCTURE = [];

    async function loadTeachingStructureFromUserDoc(user) {
      try {
        window.JAMIA_TEACHER_MAP = {};
        window.JAMIA_CLASS_MAP = {};
        const uid = user ? user.uid : null;
        let karkardagi = [];

        if (uid) {
          try {
            const userDocRef = doc(db, "users", uid);
            const userSnap = await getDoc(userDocRef);
            if (userSnap.exists()) {
              const userData = userSnap.data() || {};
              const info = getReportingInfoFromMonthInput(monthInput.value);
              const academicYear = info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum+1}` : `${info.yearNum-1}-${info.yearNum}`;
              if (userData.academicYears && userData.academicYears[academicYear] && Array.isArray(userData.academicYears[academicYear].karkardagiStructure)) {
                karkardagi = userData.academicYears[academicYear].karkardagiStructure;
              } else if (Array.isArray(userData.karkardagiStructure) && userData.karkardagiStructure.length) {
                karkardagi = userData.karkardagiStructure;
              }
            }
          } catch (e) { console.warn("User struct error:", e); }
        }
        
        // Fallback global
        if (!karkardagi.length) {
           const info = getReportingInfoFromMonthInput(monthInput.value);
           const academicYear = info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum+1}` : `${info.yearNum-1}-${info.yearNum}`;
           try {
             const kRef = doc(db, "karkardagiStructure", academicYear);
             const kSnap = await getDoc(kRef);
             if (kSnap.exists()) {
               const data = kSnap.data();
               karkardagi = Array.isArray(data.structure) ? data.structure : (Array.isArray(data.karkardagiStructure) ? data.karkardagiStructure : []);
             }
           } catch(e) {}
        }
        
        window.KARKARDAGI_STRUCTURE = karkardagi || [];

        (karkardagi || []).forEach(jamiaObj => {
          const jamiaName = (jamiaObj.jamiaName || jamiaObj.name || "").toString();
          if (!jamiaName) return;
          window.JAMIA_TEACHER_MAP[jamiaName] = {};
          
          let teachers = Array.isArray(jamiaObj.teachers) ? jamiaObj.teachers : [];
          teachers.forEach(t => {
            const teacherName = (t.name || t.teacherName || "").toString();
            if (!teacherName) return;
            window.JAMIA_TEACHER_MAP[jamiaName][teacherName] = [];
            (t.periods || []).forEach(p => {
               window.JAMIA_TEACHER_MAP[jamiaName][teacherName].push({
                 className: p.className || p.class || "",
                 bookName: p.bookName || p.kitab || ""
               });
            });
          });
        });

      } catch (err) { console.error(err); }
    }

    // ============================
    // Global State & Auth
    // ============================
    let currentUser = null;
    let userProfileData = {};
    let allReports = [];
    let currentReport = {};
    let reportRef = null;

    tadrisAccordionContainer.classList.add("hide-saved");

    backBtn.addEventListener("click", () => window.location.href = "index.html");

    onAuthStateChanged(auth, async (user) => {
      showLoader(true);
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      try {
        const userDocRef = doc(db, "users", user.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          userProfileData = snap.data();
          userNameDisplay.textContent = userProfileData.name || "N/A";
          userZimmedariDisplay.textContent = userProfileData.zimmedari || "N/A";
        }
        
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        monthInput.value = lastMonth.getFullYear() + "-" + String(lastMonth.getMonth() + 1).padStart(2, "0");
        updateMonthLabel();

        const reportsRef = collection(db, "monthly_reports");
        const qReports = query(reportsRef, where("userId", "==", user.uid));
        onSnapshot(qReports, (snapshot) => {
            allReports = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
            renderForCurrentMonth();
          });
      } catch (err) {
        console.error(err);
      } finally {
        showLoader(false);
      }
    });

    monthInput.addEventListener("change", async () => {
      updateMonthLabel();
      if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);
      renderForCurrentMonth();
    });

    function updateMonthLabel() {
      const info = getReportingInfoFromMonthInput(monthInput.value);
      currentMonthLabel.textContent = `Report for: ${info.monthName} ${info.yearNum}`;
    }

    // ============================
    // Save New Recording
    // ============================
    async function saveNewRecordingToReport(payload) {
      if (!reportRef) throw new Error("Report reference not ready.");
      const docSnap = await getDoc(reportRef);
      const existing = docSnap.exists() ? docSnap.data() : {};
      const arr = Array.isArray(existing.tadrisRecording?.data) ? existing.tadrisRecording.data.slice() : [];
      const clientTsISO = new Date().toISOString();
      const toSave = Object.assign({
        id: `local-${Date.now()}`,
        jamiaName: payload.jamiaName || "",
        teacherName: payload.teacherName || "",
        className: payload.className || "",
        kitabName: payload.kitabName || "",
        date: payload.date || clientTsISO.slice(0,10),
        tasurat: payload.tasurat || "",
        adminTasurat: payload.adminTasurat || "",
        createdAt: clientTsISO
      }, payload);
      arr.push(toSave);
      await setDoc(reportRef, { tadrisRecording: { data: arr, status: existing.tadrisRecording?.status || "Pending" } }, { merge: true });
    }

    // ============================
    // RENDER MAIN MONTHLY
    // ============================
    let renderForCurrentMonth = async function() {
      if (!tadrisAccordionContainer) return;
      showLoader(true);
      tadrisAccordionContainer.innerHTML = "";
      tadrisLoadingMsg.classList.remove("hidden");
      tadrisNoDataMsg.classList.add("hidden");

      try {
        if (currentUser) await loadTeachingStructureFromUserDoc(currentUser);
        const { report, ref, meta } = getCurrentReportForSelectedMonth();
        reportRef = ref;
        currentReport = report;

        const academicData = (Array.isArray(window.KARKARDAGI_STRUCTURE) && window.KARKARDAGI_STRUCTURE.length)
          ? window.KARKARDAGI_STRUCTURE
          : [];

        if (!academicData.length) {
          tadrisLoadingMsg.classList.add("hidden");
          tadrisNoDataMsg.classList.remove("hidden");
          tadrisStatusText.textContent = "No Structure";
          tadrisStatusChip.className = "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-red-50 text-red-700";
          showLoader(false);
          return;
        }

        await ensureReportBaseFields(reportRef, meta);
        const existingSnap = await getDoc(reportRef);
        const existingData = existingSnap.exists() ? existingSnap.data() : {};
        const tadrisData = existingData.tadrisRecording?.data || [];
        
        tadrisStatusText.textContent = tadrisData.length > 0 ? "Active" : "Pending";
        tadrisStatusChip.className = "inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700";
        tadrisLoadingMsg.classList.add("hidden");

        academicData.forEach((jamia, index) => {
          const jamiaName = jamia.jamiaName || jamia.name || `Jamia #${index+1}`;
          const jamiaSaved = tadrisData.filter((r) => r.jamiaName === jamiaName);

          const accordionItem = document.createElement("div");
          accordionItem.className = "border border-gray-200 rounded-xl overflow-hidden bg-gray-50 jamia-card";

          const header = document.createElement("button");
          header.className = "accordion-button w-full flex items-center justify-between px-4 md:px-5 py-3 bg-white hover:bg-slate-50";
          header.innerHTML = `
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-teal-100 text-teal-700 text-sm font-semibold">${index + 1}</span>
              <div class="text-left">
                <p class="font-semibold text-gray-800 urdu-font jamia-title">${escapeHtml(jamiaName)}</p>
                <p class="text-[11px] text-gray-500">Saved: ${jamiaSaved.length}</p>
              </div>
            </div>
            <div class="flex items-center gap-2 text-xs text-gray-500">
               <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
            </div>
          `;

          const content = document.createElement("div");
          content.className = "accordion-content border-t border-gray-200 bg-gray-50";

          // Saved items HTML
          const savedHTML = jamiaSaved.length
            ? jamiaSaved.map((rec, i) => {
                const adminComment = rec.tasurat || "-";
                const userComment = rec.adminTasurat || "";
                const recId = `rec-${index}-${i}`;
                return `
                  <div class="p-3 bg-white rounded-lg border border-gray-200 text-xs md:text-sm space-y-2">
                    <p class="urdu-font font-semibold">${escapeHtml(rec.className)} – ${escapeHtml(rec.kitabName)} <span class="text-gray-500">(${escapeHtml(rec.teacherName)})</span></p>
                    <div><p class="text-[10px] font-bold text-gray-500">Admin Comment:</p><p>${escapeHtml(adminComment)}</p></div>
                    <div class="comment-display">
                      <label class="block text-[10px] font-bold text-gray-600">Zimmedar Comment:</label>
                      <textarea class="user-admin-tasurat-input w-full p-1 border rounded text-xs" data-jamia="${encodeURIComponent(rec.jamiaName)}" data-teacher="${encodeURIComponent(rec.teacherName)}" data-date="${rec.date}" data-class="${encodeURIComponent(rec.className)}" data-kitab="${encodeURIComponent(rec.kitabName)}">${escapeHtml(userComment)}</textarea>
                      <button type="button" class="save-user-admin-tasurat-btn mt-1 bg-teal-600 text-white px-2 py-1 rounded text-xs">Save</button>
                    </div>
                    <button type="button" class="download-tadris-pdf-btn bg-red-600 text-white px-2 py-1 rounded text-xs" data-jamia-name="${encodeURIComponent(rec.jamiaName)}" data-teacher-name="${encodeURIComponent(rec.teacherName)}" data-class-name="${encodeURIComponent(rec.className)}" data-kitab-name="${encodeURIComponent(rec.kitabName)}" data-date="${rec.date}" data-tasurat="${encodeURIComponent(adminComment)}">Download PDF</button>
                  </div>`;
              }).join("")
            : `<p class="text-xs text-gray-500">No recordings saved.</p>`;

          // --- LINK GENERATION SECTION ---
          const portalLinkSection = `
            <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3 mb-4 flex items-center justify-between">
               <div class="flex items-center gap-2 text-indigo-800">
                   <div class="bg-indigo-200 p-2 rounded-full flex items-center justify-center w-8 h-8"><i class="fas fa-share-alt"></i></div>
                   <div class="text-xs">
                       <p class="font-bold">Teacher Portal Link</p>
                       <p class="opacity-80">Is Jamia ke liye link copy karein</p>
                   </div>
               </div>
               <button
                   type="button"
                   class="copy-link-btn bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-3 py-2 rounded-lg shadow transition flex items-center gap-1"
                   data-jamia-name="${escapeHtml(jamiaName)}"
               >
                   <i class="fas fa-copy"></i> Copy Link
               </button>
            </div>
          `;

          content.innerHTML = `
            <div class="p-4 md:p-5 space-y-4">
              ${portalLinkSection}

              <div class="space-y-3 bg-white rounded-xl shadow-sm p-3 md:p-4 border border-gray-200">
                <h3 class="text-sm font-semibold text-gray-800 urdu-font mb-1">Nayi Recording Add Karein</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Teacher</label><select class="tadris-teacher-select w-full p-2 border rounded-lg bg-white text-xs"><option value="">Select</option></select></div>
                    <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Class</label><select class="tadris-class-select w-full p-2 border rounded-lg bg-white text-xs" disabled><option value="">Select</option></select></div>
                    <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Kitab</label><select class="tadris-kitab-select w-full p-2 border rounded-lg bg-white text-xs" disabled><option value="">Select</option></select></div>
                    <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Date</label><input type="date" class="tadris-date w-full p-2 border rounded-lg text-xs" /></div>
                </div>
                <div class="mt-2"><label class="block text-[11px] font-medium text-gray-600 mb-1">File (MP3)</label><input type="file" accept="audio/*" class="tadris-audio-file w-full text-xs" /></div>
                <div><label class="block text-[11px] font-medium text-gray-600 mb-1">Tasurat (Admin)</label><textarea rows="2" class="tadris-tasurat w-full p-2 border rounded-lg text-xs"></textarea></div>
                <div class="flex justify-end"><button type="button" class="add-tadris-entry-btn px-4 py-2 rounded-lg text-xs font-semibold bg-emerald-600 text-white" data-jamia-name="${escapeHtml(jamiaName)}">Upload & Save</button></div>
              </div>
              
              <div><h4 class="text-sm font-semibold text-gray-700 mb-2">Saved Recordings</h4><div class="space-y-2 saved-recordings-list">${savedHTML}</div></div>
            </div>`;

          accordionItem.appendChild(header);
          accordionItem.appendChild(content);
          tadrisAccordionContainer.appendChild(accordionItem);
          
          // Populate selects logic (same as before)
          const jamiaTeachers = window.JAMIA_TEACHER_MAP[jamiaName] || {};
          const tSel = content.querySelector('.tadris-teacher-select');
          const cSel = content.querySelector('.tadris-class-select');
          const kSel = content.querySelector('.tadris-kitab-select');
          Object.keys(jamiaTeachers).forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; tSel.appendChild(o); });
          tSel.onchange = function() {
             cSel.innerHTML='<option>Select</option>'; kSel.innerHTML='<option>Select</option>';
             const cls = [...new Set((jamiaTeachers[this.value]||[]).map(x=>x.className))];
             cls.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cSel.appendChild(o); });
             cSel.disabled=false;
          };
          cSel.onchange = function() {
             kSel.innerHTML='<option>Select</option>';
             const bks = [...new Set((jamiaTeachers[tSel.value]||[]).filter(x=>x.className===this.value).map(x=>x.bookName))];
             bks.forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; kSel.appendChild(o); });
             kSel.disabled=false;
          };

          // Attach PDF listeners
          content.querySelectorAll('.download-tadris-pdf-btn').forEach(b => b.addEventListener('click', window.handleDownloadTadrisPDF));

          // Attach Copy Link Listener
          content.querySelector('.copy-link-btn').addEventListener('click', (e) => {
              const jName = e.currentTarget.dataset.jamiaName;
              const meta = currentReport?.meta || getReportingInfoFromMonthInput(monthInput.value);
              const activeYear = meta.academicYear || "2025-2026";
              
              // Construct Link (Assumes tadris-teacher-portal.html is in same dir)
              const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/tadris-teacher-portal.html';
              const link = `${baseUrl}?jamiaId=${encodeURIComponent(jName)}&userId=${currentUser.uid}&activeYear=${encodeURIComponent(activeYear)}`;
              
              navigator.clipboard.writeText(link).then(() => showNotification("Link Copy ho gaya!"));
          });
        });
      } catch (err) { console.error(err); } finally { showLoader(false); }
    };

    function getCurrentReportForSelectedMonth() {
      if (!currentUser) return { report: {}, ref: null };
      const info = getReportingInfoFromMonthInput(monthInput.value);
      const academicYear = info.monthNum >= 3 ? `${info.yearNum}-${info.yearNum + 1}` : `${info.yearNum - 1}-${info.yearNum}`;
      const simpleId = `${currentUser.uid}_${info.yearNum}_${info.monthNum}`;
      const withYearId = `${currentUser.uid}_${academicYear}_${info.yearNum}_${info.monthNum}`;
      const found = allReports.find(r => r.id === withYearId) || allReports.find(r => r.id === simpleId);
      const newRef = doc(db, "monthly_reports", found ? found.id : withYearId);
      return { report: found || {}, ref: newRef, meta: { ...info, academicYear } };
    }

    async function ensureReportBaseFields(ref, meta) {
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { userId: currentUser.uid, month: meta.monthName, year: meta.yearNum, academicYear: meta.academicYear, monthNum: meta.monthNum, monthKey: meta.monthInputFormat, createdAt: serverTimestamp() }, { merge: true });
      }
    }
    
    // Fill saved table logic
    function fillSavedTable() {
       const table = document.getElementById("saved-table-body");
       table.innerHTML = "";
       const { report } = getCurrentReportForSelectedMonth();
       let data = report?.tadrisRecording?.data || [];
       if(!data.length) { table.innerHTML = `<tr><td colspan="9" class="p-3 text-center text-gray-500">No data</td></tr>`; return; }
       
       // Simple render logic for saved tab
       data.forEach((rec, idx) => {
          table.innerHTML += `<tr><td class="border px-2">${escapeHtml(rec.jamiaName)}</td><td class="border px-2">${escapeHtml(rec.className)}</td><td class="border px-2">${escapeHtml(rec.kitabName)}</td><td class="border px-2">${escapeHtml(rec.teacherName)}</td><td class="border px-2">${rec.date}</td><td class="border px-2">${escapeHtml(rec.tasurat)}</td><td class="border px-2">${escapeHtml(rec.adminTasurat)}</td><td class="border px-2">${rec.tasuratDate?'Checked':'Pending'}</td><td class="border px-2"><button class="text-red-600 underline text-xs download-pdf-saved" data-jamia="${encodeURIComponent(rec.jamiaName)}" data-teacher="${encodeURIComponent(rec.teacherName)}" data-class="${encodeURIComponent(rec.className)}" data-kitab="${encodeURIComponent(rec.kitabName)}" data-date="${rec.date}" data-tasurat="${encodeURIComponent(rec.tasurat)}">PDF</button></td></tr>`;
       });
       table.querySelectorAll('.download-pdf-saved').forEach(b => {
           b.dataset.jamiaName = decodeURIComponent(b.dataset.jamia);
           b.dataset.teacherName = decodeURIComponent(b.dataset.teacher);
           b.dataset.className = decodeURIComponent(b.dataset.class);
           b.dataset.kitabName = decodeURIComponent(b.dataset.kitab);
           b.addEventListener('click', window.handleDownloadTadrisPDF);
       });
    }

    function setActiveTab(isAdd) {
      if (isAdd) {
        mainSection.classList.remove("hidden");
        savedSection.classList.add("hidden");
        tadrisAccordionContainer.classList.add("hide-saved");
        document.body.classList.remove("hide-top-controls");
        tabAdd.classList.add("bg-teal-600", "text-white");
        tabSaved.classList.remove("bg-teal-600", "text-white");
      } else {
        mainSection.classList.add("hidden");
        savedSection.classList.remove("hidden");
        tadrisAccordionContainer.classList.remove("hide-saved");
        document.body.classList.add("hide-top-controls");
        tabSaved.classList.add("bg-teal-600", "text-white");
        tabAdd.classList.remove("bg-teal-600", "text-white");
        fillSavedTable();
      }
    }
    tabAdd.addEventListener("click", () => setActiveTab(true));
    tabSaved.addEventListener("click", () => setActiveTab(false));
    setActiveTab(true);

    tadrisAccordionContainer.addEventListener('click', (e) => {
       const btn = e.target.closest('.accordion-button');
       if(!btn) return;
       const content = btn.nextElementSibling;
       const isOpen = btn.classList.toggle('open');
       content.classList.toggle('open', isOpen);
       content.style.maxHeight = isOpen ? content.scrollHeight + 150 + "px" : null;
    });

  </script>
</body>
</html>
