<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§ÛØ§Ù†Û ØªØ¹Ù„ÛŒÙ…ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Jameel Noori Nastaleeq font -->
    <link href="https://fonts.cdnfonts.com/css/jameel-noori-nastaleeq" rel="stylesheet"/>

    <style>
        body {
            font-family: 'Jameel Noori Nastaleeq', serif !important;
        }

        h1, h2, h3, p, label, select, input, th, td, button {
            font-family: 'Jameel Noori Nastaleeq', serif !important;
        }
    </style>

    <script>
  const firebaseConfig = {
    apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
    authDomain: "data-f15ab.firebaseapp.com",
    projectId: "data-f15ab",
    storageBucket: "data-f15ab.firebasestorage.app",
    messagingSenderId: "449137002393",
    appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
    measurementId: "G-1PHNJQWNPZ"
  };

  firebase.initializeApp(firebaseConfig);
  const db   = firebase.firestore();
  const auth = firebase.auth();

  // ğŸ”‘ Anonymous sign-in (yahi login Firestore rules ko auth deta hai)
  auth.signInAnonymously().catch(err => {
    console.error("Anonymous auth error:", err);
  });
</script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 text-base sm:text-lg">

<div id="loading-spinner" class="text-center">
    <i class="fas fa-spinner fa-spin text-emerald-600 text-3xl"></i>
    <p class="mt-2 text-gray-700">ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’â€¦</p>
</div>

<div id="report-form-container"
     class="bg-white p-4 sm:p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-3xl hidden">

    <!-- Heading / Subheading -->
    <h1 class="text-2xl sm:text-3xl font-bold text-center text-emerald-700 mb-1">
        Ù…Ø§ÛØ§Ù†Û ØªØ¹Ù„ÛŒÙ…ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ
    </h1>
    <p class="text-center text-gray-600 mb-5 sm:mb-6">
        Ù…Ø¬Ù„Ø³ ØªØ¹Ù„ÛŒÙ…ÛŒ Ø§Ù…ÙˆØ± ÛÙ†Ø¯
    </p>

    <div class="mb-4 sm:mb-6 p-3 bg-emerald-50 border-r-4 border-emerald-500 text-emerald-800 text-right rounded-lg">
        <p id="jamia-display" class="font-semibold">Ø¬Ø§Ù…Ø¹Û: Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’â€¦</p>
        <p id="report-month-display" class="text-xs sm:text-sm mt-1">Ø±Ù¾ÙˆØ±Ù¹ Ø¨Ø±Ø§Ø¦Û’: Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’â€¦</p>
    </div>

    <form id="teacher-report-form" class="text-right">
        <!-- TEACHER LOGIN BY UNIQUE CODE -->
<div class="mb-4 sm:mb-6 space-y-2">
    <label for="teacher-code-input"
           class="block text-gray-700 font-semibold mb-1 text-sm sm:text-base">
        Û” Ø§Ù¾Ù†Ø§ Ø§Ø¬ÛŒØ± Ú©ÙˆÚˆ Ø¯Ø±Ø¬ ÙØ±Ù…Ø§Ø¦ÛŒÚº:
    </label>

    <div class="flex gap-2">
        <input id="teacher-code-input"
               type="text"
               class="flex-1 p-2.5 sm:p-3 border border-gray-300 rounded-lg
                      focus:ring-emerald-500 focus:border-emerald-500 bg-white text-right text-sm sm:text-base"
               placeholder="Ù…Ø«Ù„Ø§Ù‹: 12345">
        <button type="button"
                id="verify-code-btn"
                class="whitespace-nowrap bg-emerald-600 hover:bg-emerald-700 text-white font-bold
                       px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base">
            ØªØµØ¯ÛŒÙ‚
        </button>
    </div>

    <p id="teacher-code-error"
       class="hidden text-red-600 text-xs sm:text-sm mt-1"></p>

    <!-- Sirf display ke liye, teacher apna naam change nahi kar sakta -->
    <div id="teacher-name-display-wrapper" class="hidden mt-3">
        <span class="block text-gray-700 font-semibold text-sm sm:text-base mb-1">
            Ø¢Ù¾ Ú©Ø§ Ù†Ø§Ù…:
        </span>
        <div id="teacher-name-display"
             class="inline-block bg-gray-100 border border-gray-300 rounded-lg
                    px-3 py-1 text-sm sm:text-base urdu-font">
        </div>
    </div>

    <!-- hidden select â€“ sirf internal use ke liye -->
    <select id="teacher-select" class="hidden"></select>
</div>

        <!-- PERIODS SECTION (NO HORIZONTAL SCROLL) -->
        <div id="periods-section" class="mb-6 sm:mb-8 hidden">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">
                Û” Ù¾Ú‘Ú¾Ø§Ø¦Û’ Ú¯Ø¦Û’ ØµÙØ­Ø§Øª (ÛØ± Ú©Ù„Ø§Ø³ / Ú©ØªØ§Ø¨ Ú©Û’ Ù„ÛŒÛ’)
            </h2>
            <div id="periods-list" class="space-y-4"></div>
        </div>

        <!-- SUBMIT BUTTON -->
        <div id="submit-button-area" class="text-center hidden">
            <button type="submit" id="submit-btn"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold
                           py-2.5 sm:py-3 px-8 rounded-lg transition duration-150 shadow-md text-base sm:text-lg">
                <i class="fas fa-upload ml-2"></i> Ù…Ø§ÛØ§Ù†Û ØªØ¹Ù„ÛŒÙ…ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ø¬Ù…Ø¹ Ú©Ø±ÛŒÚº
            </button>
        </div>

        <div id="form-message"
             class="mt-4 p-3 rounded-lg text-center hidden text-sm sm:text-base"></div>
    </form>
</div>

<script>
    // ------- GLOBAL STATE -------
    let selectedTeacherData = null;
    let currentJamiaName    = null;
    let currentMonthIndex   = null;
    let currentReportYear   = null;
    let currentJamiaData    = null;
    let formLocked          = false;

    document.addEventListener('DOMContentLoaded', () => {
        const loadingSpinner = document.getElementById('loading-spinner');

        const urlParams   = new URLSearchParams(window.location.search);
        const jamiaId     = urlParams.get('jamiaId');   // encoded
        const userId      = urlParams.get('userId');    // dashboard user UID
        const activeYear  = urlParams.get('activeYear');
        const monthIndexQ = urlParams.get('monthIndex');
        const reportYearQ = urlParams.get('reportYear');

        if (!jamiaId || !userId || !activeYear) {
            loadingSpinner.innerHTML =
                '<p class="text-red-600 font-bold">Error: Ø±Ù¾ÙˆØ±Ù¹Ù†Ú¯ Ù„Ù†Ú© Ø¯Ø±Ø³Øª Ù†ÛÛŒÚº ÛÛ’ (Ø¬Ø§Ù…Ø¹ÛØŒ ÛŒÙˆØ²Ø± ÛŒØ§ Ø³Ø§Ù„ missing ÛÛ’)</p>';
            return;
        }

        // Month/year decide
        let monthIndex, reportYear;
        if (monthIndexQ !== null && reportYearQ !== null) {
            monthIndex = parseInt(monthIndexQ, 10);
            reportYear = parseInt(reportYearQ, 10);
        } else {
            const today = new Date();
            monthIndex = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
            reportYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
        }

        const monthName = new Date(reportYear, monthIndex)
            .toLocaleString('en-US', { month: 'long' });

        document.getElementById('jamia-display').textContent =
            `Ø¬Ø§Ù…Ø¹Û: ${decodeURIComponent(jamiaId)}`;
        document.getElementById('report-month-display').textContent =
            `Ø±Ù¾ÙˆØ±Ù¹ Ø¨Ø±Ø§Ø¦Û’: ${monthName} ${reportYear}`;

        // Data load (Jamia + teachers/periods)
        loadJamiaData(jamiaId, userId, activeYear, monthIndex, reportYear);

        // Submit handler
        document.getElementById('teacher-report-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitReport(jamiaId, activeYear, monthIndex, reportYear);
        });

        // Teacher code verify controls
        const codeInput                 = document.getElementById('teacher-code-input');
        const verifyBtn                 = document.getElementById('verify-code-btn');
        const codeError                 = document.getElementById('teacher-code-error');
        const teacherNameDisplayWrapper = document.getElementById('teacher-name-display-wrapper');
        const teacherNameDisplay        = document.getElementById('teacher-name-display');

        function verifyTeacherByCode() {
            if (!currentJamiaData || !Array.isArray(currentJamiaData.teachers)) {
                alert('Ø¬Ø§Ù…Ø¹Û Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ø§Ø¨Ú¾ÛŒ Ù„ÙˆÚˆ Ù†ÛÛŒÚº ÛÙˆØ§ØŒ ØªÚ¾ÙˆÚ‘ÛŒ Ø¯ÛŒØ± Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”');
                return;
            }

            codeError.classList.add('hidden');
            codeError.textContent = '';

            const code = (codeInput.value || '').trim();

            if (!code) {
                codeError.textContent = 'Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ù¾Ù†Ø§ Ø§Ø¬ÛŒØ± Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”';
                codeError.classList.remove('hidden');
                return;
            }

            if (code.length !== 5) {
                codeError.textContent = 'Ø¨Ø±Ø§Û Ú©Ø±Ù… Ûµ Ø§Ø¹Ø¯Ø§Ø¯ Ù¾Ø± Ù…Ø´ØªÙ…Ù„ Ø¯Ø±Ø³Øª Ø§Ø¬ÛŒØ± Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”';
                codeError.classList.remove('hidden');
                return;
            }

            const teachers = currentJamiaData.teachers || [];

            // loginCode se match
            const teacher = teachers.find(t => String(t.loginCode) === code);

            if (!teacher) {
                codeError.textContent = 'Ø§Ø¬ÛŒØ± Ú©ÙˆÚˆ Ø¯Ø±Ø³Øª Ù†ÛÛŒÚº ÛÛ’ØŒ Ø¯ÙˆØ¨Ø§Ø±Û Ú†ÛŒÚ© Ú©Ø±ÛŒÚºÛ”';
                codeError.classList.remove('hidden');
                return;
            }

            // âœ… Teacher mil gaya
            selectedTeacherData = teacher;

            const teacherSelect = document.getElementById('teacher-select');
            if (teacherSelect) {
                teacherSelect.value = teacher.id;
                teacherSelect.disabled = true;
            }

            codeInput.disabled = true;
            verifyBtn.disabled = true;

            teacherNameDisplay.textContent = teacher.name || '';
            teacherNameDisplayWrapper.classList.remove('hidden');

            // FORM LOAD â€” THIS WAS MISSING
loadTeacherPeriods(
    teacher.id,
    currentJamiaData.teachers,
    currentJamiaName,
    currentMonthIndex,
    currentReportYear
);

// USER UPDATE OVERLAY
loadTeacherUserUpdates(
    currentJamiaName,
    teacher.id,
    currentMonthIndex,
    currentReportYear
);


            // Sirf isi teacher ke periods + purana data
            // Call this after loadTeacherPeriods(...) finishes populating inputs
async function loadTeacherUserUpdates(jamiaId, teacherId, monthIndex, year) {
    try {
        const submissionsRef = db.collection('teacher_submissions');
        const q = submissionsRef
            .where('jamiaId', '==', jamiaId)
            .where('teacherId', '==', teacherId)
            .where('submissionMonth', '==', monthIndex)
            .where('submissionYear', '==', year)
            .where('role', '==', 'user_update')
            .orderBy('updatedAt', 'desc');

        const snap = await q.get();
        if (snap.empty) return;

        // take latest user_update (first doc)
        const docSnap = snap.docs[0];
        const ud = docSnap.data();

        // apply changedValues array
        if (Array.isArray(ud.changedValues)) {
            ud.changedValues.forEach(cv => {
                const inp = document.querySelector(`.pages-taught-input[data-period-id="${cv.periodId}"]`);
                const lastInp = document.querySelector(`.last-lesson-input[data-period-id="${cv.periodId}"]`);
                const pnoInp = document.querySelector(`.page-number-input[data-period-id="${cv.periodId}"]`);

                if (inp) {
                    inp.value = (cv.pagesTaught !== undefined ? cv.pagesTaught : inp.value);
                    // mark highlight
                    const card = inp.closest('.period-card') || inp.closest('.reporting-row');
                    if (card) card.classList.add('updated-highlight');
                    // add badge if not present
                    if (card && !card.querySelector('.user-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'user-badge';
                        badge.textContent = 'Updated by User';
                        const header = card.querySelector('.card-header') || card;
                        header.insertBefore(badge, header.firstChild);
                    }
                }
                if (lastInp) lastInp.value = cv.lastIbarat || lastInp.value;
                if (pnoInp) pnoInp.value = (cv.lastPageNo !== undefined ? cv.lastPageNo : pnoInp.value);
            });
        }

        // Keep form locked for teacher (readonly)
        document.querySelectorAll('.pages-taught-input, .last-lesson-input, .page-number-input').forEach(el => el.readOnly = true);

        // show message
        const formMessage = document.getElementById('form-message');
        if (formMessage) {
            formMessage.className = 'mt-4 p-3 rounded-lg text-center bg-yellow-100 text-yellow-800 text-sm sm:text-base';
            const when = ud.updatedAt && ud.updatedAt.toDate ? ud.updatedAt.toDate().toLocaleString() : '';
            formMessage.innerHTML = `Aapki report me user ne kuch changes kiye hain (${ud.updatedByUserName || 'User'}) ${when ? 'on ' + when : ''}. Yeh changes highlighted hain.`;
            formMessage.style.display = 'block';
        }
    } catch (err) {
        console.error('Error loading user updates for teacher:', err);
    }
}
        }

        if (verifyBtn) {
            verifyBtn.addEventListener('click', verifyTeacherByCode);
        }

        if (codeInput) {
            codeInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    verifyTeacherByCode();
                }
            });
        }
    });

    // ===== DATA FETCHING =====
    async function loadJamiaData(jamia, userId, year, monthIndex, currentYear) {
        const loadingSpinner = document.getElementById('loading-spinner');
        const formContainer  = document.getElementById('report-form-container');
        const teacherSelect  = document.getElementById('teacher-select');

        try {
            const userRef  = db.collection('users').doc(userId);
            const userSnap = await userRef.get();

            if (!userSnap.exists) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">User Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ù†ÛÛŒÚº Ù…Ù„Ø§ (users collection).</p>';
                return;
            }

            const userData      = userSnap.data();
            const academicYears = userData.academicYears || {};
            const yearData      = academicYears[year];

            if (!yearData || !Array.isArray(yearData.karkardagiStructure)) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">Ø§Ø³ Ø³Ø§Ù„ Ú©Û’ Ù„ÛŒÛ’ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ú©Ø§ Ø§Ø³Ù¹Ø±Ú©Ú†Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº ÛÛ’Û”</p>';
                return;
            }

            const structure        = yearData.karkardagiStructure;
            const jamiaNameDecoded = decodeURIComponent(jamia);

            const jamiaData = structure.find(j => j.jamiaName === jamiaNameDecoded);

            if (!jamiaData || !Array.isArray(jamiaData.teachers) || jamiaData.teachers.length === 0) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">Ø§Ø³ Ø¬Ø§Ù…Ø¹Û Ú©Û’ Ø§Ø³Ø§ØªØ°Û Ú©Ø§ Ø§Ø³Ù¹Ø±Ú©Ú†Ø± Ø³ÛŒÙ¹ Ù†ÛÛŒÚº ÛÛ’Û”</p>';
                return;
            }

            // Teachers dropdown (hidden, sirf internal use)
            teacherSelect.innerHTML = '';
            const teachers = Array.isArray(jamiaData.teachers) ? jamiaData.teachers : [];
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                teacherSelect.appendChild(option);
            });

            // Global state â€“ baad me code verify ke liye
            currentJamiaName  = jamiaNameDecoded;
            currentMonthIndex = monthIndex;
            currentReportYear = currentYear;
            currentJamiaData  = { ...jamiaData, teachers };

            loadingSpinner.classList.add('hidden');
            formContainer.classList.remove('hidden');

        } catch (error) {
            console.error("Error loading Jamia data:", error);
            loadingSpinner.innerHTML =
                `<p class="text-red-600 font-bold">ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ Ú©Ø±ØªÛ’ ÙˆÙ‚Øª Ø®Ø±Ø§Ø¨ÛŒ: ${error.message}</p>`;
        }
    }

    // ===== PERIODS (cards) + existing submission check =====
    function loadTeacherPeriods(teacherId, allTeachers, jamiaName, monthIndex, year) {
        const periodsList      = document.getElementById('periods-list');
        const periodsSection   = document.getElementById('periods-section');
        const submitButtonArea = document.getElementById('submit-button-area');
        const formMessage      = document.getElementById('form-message');

        // Reset
        formLocked = false;
        if (formMessage) {
            formMessage.classList.add('hidden');
            formMessage.textContent = '';
        }

        periodsList.innerHTML = '';

        const teacher = allTeachers.find(t => t.id === teacherId);

        if (!teacher || !Array.isArray(teacher.periods) || teacher.periods.length === 0) {
            periodsList.innerHTML =
                '<p class="text-center py-4 text-gray-500 text-sm sm:text-base">Ø§Ø³ Ø§Ø³ØªØ§Ø¯ Ú©Û’ Ù„ÛŒÛ’ Ú©ÙˆØ¦ÛŒ Ù¾ÛŒØ±ÛŒÚˆ Ø³ÛŒÙ¹ Ù†ÛÛŒÚº ÛÛ’Û”</p>';
            periodsSection.classList.remove('hidden');
            submitButtonArea.classList.add('hidden');
            return;
        }

        selectedTeacherData = teacher;

        teacher.periods.forEach(period => {
            const className = period.className || 'Ú©Ù„Ø§Ø³';
            const bookName  = period.bookName  || 'Ú©ØªØ§Ø¨';

            const card = document.createElement('div');
            card.className = 'bg-gray-50 border border-gray-200 rounded-xl p-3 sm:p-4 shadow-sm';

            card.innerHTML = `
                <div class="mb-2 text-sm sm:text-base font-semibold text-emerald-700">
                    Ú©Ù„Ø§Ø³ / Ú©ØªØ§Ø¨: ${className} (${bookName})
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">Ù¾Ú‘Ú¾Ø§Ø¦Û’ Ú¯Ø¦Û’ ØµÙØ­Ø§Øª</label>
                        <input type="number"
                               data-row-id="${period.id}"
                               data-period-id="${period.id}"
                               data-class-name="${className}"
                               data-book-name="${bookName}"
                               class="pages-taught-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-center focus:border-emerald-500"
                               min="0"
                               placeholder="ØµÙØ­Ø§Øª Ú©ÛŒ ØªØ¹Ø¯Ø§Ø¯"
                               required>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">Ø³Ø¨Ù‚ Ú©ÛŒ Ø¢Ø®Ø±ÛŒ Ø¹Ø¨Ø§Ø±Øª</label>
                        <input type="text"
                               data-row-id="${period.id}"
                               class="last-lesson-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm focus:border-emerald-500"
                               placeholder="Ø¢Ø®Ø±ÛŒ Ø¹Ø¨Ø§Ø±Øª"
                               required>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">Ø³Ø¨Ù‚ Ú©Ø§ ØµÙØ­Û Ù†Ù…Ø¨Ø±</label>
                        <input type="number"
                               data-row-id="${period.id}"
                               class="page-number-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-center focus:border-emerald-500"
                               min="0"
                               placeholder="ØµÙØ­Û Ù†Ù…Ø¨Ø±"
                               required>
                    </div>
                </div>
            `;

            periodsList.appendChild(card);
        });

        periodsSection.classList.remove('hidden');
        submitButtonArea.classList.remove('hidden');

        // ğŸ”’ Existing submission check
        checkExistingSubmissionForTeacher(jamiaName, teacherId, monthIndex, year);
    }

    // ğŸ”’ Existing submission check (GLOBAL)
    async function checkExistingSubmissionForTeacher(jamiaName, teacherId, monthIndex, year) {
        const formMessage = document.getElementById('form-message');
        const submitBtn   = document.getElementById('submit-btn');

        try {
            const submissionsRef = db.collection('teacher_submissions');
            const q = submissionsRef
                .where('jamiaId', '==', jamiaName)
                .where('teacherId', '==', teacherId)
                .where('submissionMonth', '==', monthIndex)
                .where('submissionYear', '==', year);

            const snap = await q.get();

            if (snap.empty) {
                formLocked = false;
                if (submitBtn) submitBtn.disabled = false;
                return;
            }

            // Pehle se report hai â†’ lock
            formLocked = true;
            if (submitBtn) submitBtn.disabled = true;

            const dataByPeriod = {};

            snap.forEach(doc => {
                const d = doc.data();
                const pId = d.periodId;
                if (!pId) return;

                if (!dataByPeriod[pId]) {
                    dataByPeriod[pId] = {
                        pagesTaught: 0,
                        lastIbarat: '',
                        lastPageNo: ''
                    };
                }

                dataByPeriod[pId].pagesTaught += parseInt(d.pagesTaught || 0, 10);

                if (d.lastIbarat) {
                    dataByPeriod[pId].lastIbarat = d.lastIbarat;
                }
                if (d.lastPageNo !== undefined && d.lastPageNo !== null && d.lastPageNo !== '') {
                    dataByPeriod[pId].lastPageNo = d.lastPageNo;
                }
            });

            // Inputs me value daal + read-only + popup
            const pagesInputs = document.querySelectorAll('.pages-taught-input');
            pagesInputs.forEach(input => {
                const periodId = input.dataset.periodId;
                const info = dataByPeriod[periodId];
                if (!info) return;

                input.value = info.pagesTaught;
                input.readOnly = true;
                input.addEventListener('focus', showLockedPopup);
            });

            const lastInputs = document.querySelectorAll('.last-lesson-input');
            lastInputs.forEach(input => {
                const rowId = input.dataset.rowId;
                const info = dataByPeriod[rowId];
                if (!info) return;

                input.value = info.lastIbarat || '';
                input.readOnly = true;
                input.addEventListener('focus', showLockedPopup);
            });

            const pageNoInputs = document.querySelectorAll('.page-number-input');
            pageNoInputs.forEach(input => {
                const rowId = input.dataset.rowId;
                const info = dataByPeriod[rowId];
                if (!info) return;

                input.value = info.lastPageNo || '';
                input.readOnly = true;
                input.addEventListener('focus', showLockedPopup);
            });

            if (formMessage) {
                formMessage.textContent =
                    'Ø¢Ù¾ Ú©ÛŒ Ø§Ø³ Ù…ÛÛŒÙ†Û’ Ú©ÛŒ Ø±Ù¾ÙˆØ±Ù¹ Ù¾ÛÙ„Û’ ÛÛŒ Ø¬Ù…Ø¹ ÛÙˆ Ú†Ú©ÛŒ ÛÛ’Û” Ø§Ú¯Ø± Ú©Ø³ÛŒ Ù‚Ø³Ù… Ú©ÛŒ ØªØ±Ù…ÛŒÙ… Ø¯Ø±Ú©Ø§Ø± ÛÙˆ ØªÙˆ Ø§Ù¾Ù†Û’ ØªØ¹Ù„ÛŒÙ…ÛŒ Ø°Ù…Û Ø¯Ø§Ø± Ø³Û’ Ø±Ø§Ø¨Ø·Û ÙØ±Ù…Ø§Ø¦ÛŒÚºÛ”';
                formMessage.className =
                    'mt-4 p-3 rounded-lg text-center bg-yellow-100 text-yellow-800 text-sm sm:text-base';
                formMessage.classList.remove('hidden');
            }
        } catch (err) {
            console.error('Error checking existing submission:', err);
            formLocked = false;
            if (submitBtn) submitBtn.disabled = false;
        }
    }

    function showLockedPopup() {
        alert('Ø¢Ù¾ Ú©ÛŒ Ø§Ø³ Ù…ÛÛŒÙ†Û’ Ú©ÛŒ Ø±Ù¾ÙˆØ±Ù¹ Ù¾ÛÙ„Û’ ÛÛŒ Ø¬Ù…Ø¹ ÛÙˆ Ú†Ú©ÛŒ ÛÛ’Û” Ú©ÙˆØ¦ÛŒ ØªØ¨Ø¯ÛŒÙ„ÛŒ Ø¯Ø±Ú©Ø§Ø± ÛÙˆ ØªÙˆ Ø§Ù¾Ù†Û’ ØªØ¹Ù„ÛŒÙ…ÛŒ Ø°Ù…Û Ø¯Ø§Ø± Ø³Û’ Ø±Ø§Ø¨Ø·Û ÙØ±Ù…Ø§Ø¦ÛŒÚºÛ”');
    }

    // ===== SUBMISSION =====
    async function submitReport(jamiaId, activeYear, monthIndex, year) {
        const periodsList = document.getElementById('periods-list');
        const submitBtn   = document.getElementById('submit-btn');
        const formMessage = document.getElementById('form-message');

        if (formLocked) {
            alert('ÛŒÛ Ø±Ù¾ÙˆØ±Ù¹ Ù¾ÛÙ„Û’ ÛÛŒ Ø¬Ù…Ø¹ ÛÙˆ Ú†Ú©ÛŒ ÛÛ’ØŒ ØªØ±Ù…ÛŒÙ… Ú©Û’ Ù„ÛŒÛ’ ØªØ¹Ù„ÛŒÙ…ÛŒ Ø°Ù…Û Ø¯Ø§Ø± Ø³Û’ Ø±Ø§Ø¨Ø·Û ÙØ±Ù…Ø§Ø¦ÛŒÚºÛ”');
            return;
        }

        if (!selectedTeacherData) {
            alert('Ù¾ÛÙ„Û’ Ø§Ù¾Ù†Ø§ ØµØ­ÛŒØ­ Ù¹ÛŒÚ†Ø± Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø± Ú©Û’ ØªØµØ¯ÛŒÙ‚ Ú©Ø±ÛŒÚºÛ”');
            return;
        }

        const inputs = periodsList.querySelectorAll('.pages-taught-input');
        if (inputs.length === 0) {
            alert('Ú©ÙˆØ¦ÛŒ Ù¾ÛŒØ±ÛŒÚˆ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚºØŒ Ø±Ù¾ÙˆØ±Ù¹ Ø¬Ù…Ø¹ Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ØªÛŒÛ”');
            return;
        }

        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø³Ø¨Ù…Ù¹ ÛÙˆ Ø±ÛÛŒ ÛÛ’â€¦';

            const submissionBatch = [];

            inputs.forEach(input => {
                const rowId       = input.dataset.rowId;
                const pagesTaught = parseInt(input.value || '0', 10);
                const lastText    = periodsList.querySelector(`.last-lesson-input[data-row-id="${rowId}"]`)?.value.trim();
                const lastPageNo  = parseInt(
                    periodsList.querySelector(`.page-number-input[data-row-id="${rowId}"]`)?.value || '0',
                    10
                );

                if (isNaN(pagesTaught) || pagesTaught < 0) {
                    throw new Error("ÛØ± Ú©Ø§Ø±Úˆ Ù…ÛŒÚº Ø¯Ø±Ø³Øª 'ØµÙØ­Û Ù¾Ú‘Ú¾Ø§ÛŒØ§' Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”");
                }
                if (!lastText) {
                    throw new Error("ÛØ± Ú©Ø§Ø±Úˆ Ù…ÛŒÚº 'Ø³Ø¨Ù‚ Ú©ÛŒ Ø¢Ø®Ø±ÛŒ Ø¹Ø¨Ø§Ø±Øª' Ù„Ø§Ø²Ù…Ø§Ù‹ Ù„Ú©Ú¾ÛŒÚºÛ”");
                }
                if (isNaN(lastPageNo) || lastPageNo < 0) {
                    throw new Error("ÛØ± Ú©Ø§Ø±Úˆ Ù…ÛŒÚº Ø¯Ø±Ø³Øª 'ØµÙØ­Û Ù†Ù…Ø¨Ø±' Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”");
                }

                submissionBatch.push({
                    jamiaId: decodeURIComponent(jamiaId),
                    teacherId: selectedTeacherData.id,
                    teacherName: selectedTeacherData.name,
                    periodId: input.dataset.periodId,
                    className: input.dataset.className,
                    bookName: input.dataset.bookName,
                    pagesTaught: pagesTaught,
                    lastIbarat: lastText,
                    lastPageNo: lastPageNo,
                    submissionMonth: monthIndex,
                    submissionYear: year,
                    activeYear: activeYear,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            if (submissionBatch.length === 0) {
                throw new Error("Ú©ÙˆØ¦ÛŒ ÚˆÛŒÙ¹Ø§ Ø³Ø¨Ù…Ù¹ Ù†ÛÛŒÚº ÛÙˆ Ø±ÛØ§Û”");
            }

            const batch = db.batch();
            const submissionsRef = db.collection('teacher_submissions');

            submissionBatch.forEach(data => {
                const docRef = submissionsRef.doc();
                batch.set(docRef, data);
            });

            await batch.commit();

            formMessage.textContent =
                'âœ… Ø±Ù¾ÙˆØ±Ù¹ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ú©Û’ Ø³Ø§ØªÚ¾ Ø¬Ù…Ø¹ ÛÙˆ Ú¯Ø¦ÛŒØŒ Ø¬Ø²Ø§Ú©Ù… Ø§Ù„Ù„Û Ø®ÛŒØ±Ø§Ù‹!';
            formMessage.className =
                'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700 text-sm sm:text-base';
            formMessage.classList.remove('hidden');

            document.getElementById('periods-section').classList.add('hidden');
            document.getElementById('submit-button-area').classList.add('hidden');
            document.getElementById('teacher-select').disabled = true;

        } catch (error) {
            console.error("Submission Error:", error);
            formMessage.textContent =
                `âŒ Ø±Ù¾ÙˆØ±Ù¹ Ø¬Ù…Ø¹ Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ÛŒ: ${error.message}`;
            formMessage.className =
                'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700 text-sm sm:text-base';
            formMessage.classList.remove('hidden');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML =
                '<i class="fas fa-upload ml-2"></i> Ù…Ø§ÛØ§Ù†Û ØªØ¹Ù„ÛŒÙ…ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ø¬Ù…Ø¹ Ú©Ø±ÛŒÚº';
        }
    }
</script>
</body>
</html>







