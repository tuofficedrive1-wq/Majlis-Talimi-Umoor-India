<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ماہانہ تعلیمی کارکردگی</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <link href="https://fonts.cdnfonts.com/css/jameel-noori-nastaleeq" rel="stylesheet"/>

    <style>
        :root {
            --primary-color: #059669; /* Emerald 600 */
            --bg-color: #f3f4f6;
        }
        body {
            font-family: 'Jameel Noori Nastaleeq', serif !important;
            background-color: var(--bg-color);
            -webkit-tap-highlight-color: transparent;
        }
        /* Mobile Inputs Polish */
        input, select, button {
            font-family: 'Jameel Noori Nastaleeq', serif !important;
            outline: none;
        }
        .app-card {
            background: white;
            border-radius: 1rem; /* 16px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            margin-bottom: 1rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .input-group {
            position: relative;
            margin-bottom: 1rem;
        }
        .input-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        .app-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            background-color: #f9fafb;
            transition: all 0.2s;
        }
        .app-input:focus {
            border-color: var(--primary-color);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .sticky-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
            z-index: 50;
        }
        /* Hide Scrollbar for clean look */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
        authDomain: "data-f15ab.firebaseapp.com",
        projectId: "data-f15ab",
        storageBucket: "data-f15ab.firebasestorage.app",
        messagingSenderId: "449137002393",
        appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
        measurementId: "G-1PHNJQWNPZ"
      };
      firebase.initializeApp(firebaseConfig);
      const db   = firebase.firestore();
      const auth = firebase.auth();
      auth.signInAnonymously().catch(err => console.error(err));
    </script>
</head>
<body class="pb-24"> <div class="bg-emerald-600 text-white p-4 sticky top-0 z-40 shadow-md rounded-b-2xl">
    <div class="flex justify-between items-center">
        <div class="text-right">
            <h1 class="text-xl font-bold">ماہانہ تعلیمی کارکردگی</h1>
            <p class="text-emerald-100 text-sm">مجلس تعلیمی امور ہند</p>
        </div>
        <div class="bg-white/20 p-2 rounded-full">
            <i class="fas fa-book-reader text-xl"></i>
        </div>
    </div>
</div>

<div id="loading-spinner" class="flex flex-col items-center justify-center h-screen -mt-20">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div>
    <p class="mt-4 text-gray-600 font-bold">ڈیٹا لوڈ ہو رہا ہے...</p>
</div>

<div id="report-form-container" class="max-w-md mx-auto p-4 hidden">
    
    <div class="app-card p-4 bg-emerald-50 border-emerald-100">
        <div class="flex justify-between items-center mb-1">
            <span class="text-gray-500 text-xs">جامعہ</span>
            <span class="text-gray-500 text-xs">رپورٹ برائے</span>
        </div>
        <div class="flex justify-between items-center font-bold text-emerald-800">
            <span id="jamia-display">...</span>
            <span id="report-month-display">...</span>
        </div>
    </div>

    <form id="teacher-report-form">
        
        <div class="mb-6">
            <label class="block text-gray-700 font-bold mb-2 mr-1">اپنا اجیر کوڈ درج کریں:</label>
            <div class="flex gap-2">
                <div class="relative flex-1">
                    <i class="fas fa-key absolute right-3 top-3.5 text-gray-400"></i>
                    <input id="teacher-code-input" type="tel" class="app-input text-center font-mono text-lg tracking-widest" placeholder="12345">
                </div>
                <button type="button" id="verify-code-btn" class="bg-emerald-600 text-white px-5 rounded-xl shadow-md active:scale-95 transition-transform">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
            <p id="teacher-code-error" class="hidden text-red-500 text-sm mt-2 mr-1 font-bold"></p>
            
            <div id="teacher-name-display-wrapper" class="hidden mt-4 animate-fade-in-down">
                <div class="bg-blue-50 text-blue-800 p-3 rounded-xl border border-blue-100 text-center">
                    <p class="text-sm text-blue-600">خوش آمدید</p>
                    <p id="teacher-name-display" class="font-bold text-lg"></p>
                </div>
            </div>
            <select id="teacher-select" class="hidden"></select>
        </div>

        <div id="periods-section" class="hidden space-y-4">
            <h2 class="text-gray-500 text-sm font-bold mr-1 mb-2">آپ کے اسباق (Periods)</h2>
            <div id="periods-list"></div>
        </div>

        <div id="submit-button-area" class="sticky-bottom hidden">
            <button type="submit" id="submit-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg flex justify-center items-center text-lg active:scale-95 transition-transform">
                <span>رپورٹ جمع کریں</span>
                <i class="fas fa-paper-plane mr-2"></i>
            </button>
            <div id="form-message" class="hidden mt-2 text-sm text-center font-bold"></div>
        </div>

    </form>

    <div id="teacher-profile-view" class="hidden mt-8 pb-20">
        <h2 class="text-center text-xl font-bold text-emerald-800 mb-4 bg-emerald-50 py-2 rounded-lg">سمسٹر کارکردگی</h2>
        <div id="profile-grid" class="grid grid-cols-1 gap-4">
            </div>
    </div>
</div>

<script>
    // ------- GLOBAL STATE -------
    let selectedTeacherData = null;
    let currentJamiaName    = null;
    let currentMonthIndex   = null;
    let currentReportYear   = null;
    let currentJamiaData    = null;
    let currentYearData     = null;

    document.addEventListener('DOMContentLoaded', () => {
        const loadingSpinner = document.getElementById('loading-spinner');
        const urlParams   = new URLSearchParams(window.location.search);
        const jamiaId     = urlParams.get('jamiaId');
        const userId      = urlParams.get('userId');
        const activeYear  = urlParams.get('activeYear');
        const monthIndexQ = urlParams.get('monthIndex');
        const reportYearQ = urlParams.get('reportYear');

        if (!jamiaId || !userId || !activeYear) {
            loadingSpinner.innerHTML = '<p class="text-red-600 font-bold text-center mt-10">لنک غلط ہے!</p>';
            return;
        }

        let monthIndex, reportYear;
        if (monthIndexQ !== null && reportYearQ !== null) {
            monthIndex = parseInt(monthIndexQ, 10);
            reportYear = parseInt(reportYearQ, 10);
        } else {
            const today = new Date();
            monthIndex = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
            reportYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
        }

        const monthName = new Date(reportYear, monthIndex).toLocaleString('en-US', { month: 'long' }); // Urdu map below
        const urduMonth = getMonthNameUrdu(monthIndex);

        document.getElementById('jamia-display').textContent = decodeURIComponent(jamiaId);
        document.getElementById('report-month-display').textContent = `${urduMonth} ${reportYear}`;

        loadJamiaData(jamiaId, userId, activeYear, monthIndex, reportYear);

        document.getElementById('teacher-report-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitReport(jamiaId, activeYear, monthIndex, reportYear);
        });

        // Verification Logic
        const codeInput = document.getElementById('teacher-code-input');
        const verifyBtn = document.getElementById('verify-code-btn');
        
        const verifyAction = () => {
            if (!currentJamiaData) { alert('ڈیٹا لوڈ ہو رہا ہے...'); return; }
            const code = codeInput.value.trim();
            const teacher = currentJamiaData.teachers.find(t => String(t.loginCode) === code);
            
            if (teacher) {
                selectedTeacherData = teacher;
                document.getElementById('teacher-code-error').classList.add('hidden');
                document.getElementById('teacher-name-display').textContent = teacher.name;
                document.getElementById('teacher-name-display-wrapper').classList.remove('hidden');
                
                // Disable inputs
                codeInput.disabled = true;
                verifyBtn.classList.add('hidden');
                codeInput.parentElement.parentElement.innerHTML = `<div class="w-full bg-emerald-100 text-emerald-800 p-3 rounded-xl text-center font-bold">کوڈ تصدیق شدہ <i class="fas fa-check-circle"></i></div>`;

                loadTeacherPeriods(teacher.id, currentJamiaData.teachers, currentJamiaName, currentMonthIndex, currentReportYear);
                loadTeacherUserUpdates(currentJamiaName, teacher.id, currentMonthIndex, currentReportYear);
            } else {
                document.getElementById('teacher-code-error').textContent = 'غلط کوڈ! دوبارہ کوشش کریں۔';
                document.getElementById('teacher-code-error').classList.remove('hidden');
            }
        };

        verifyBtn.addEventListener('click', verifyAction);
    });

    // ===== 1. DATA FETCHING =====
    async function loadJamiaData(jamia, userId, year, monthIndex, currentYear) {
        try {
            const userRef = db.collection('users').doc(userId);
            const userSnap = await userRef.get();
            if (!userSnap.exists) throw new Error("User not found");

            const userData = userSnap.data();
            const yearData = userData.academicYears?.[year];
            if (!yearData) throw new Error("Year data missing");

            const jamiaNameDecoded = decodeURIComponent(jamia);
            const jamiaData = yearData.karkardagiStructure.find(j => j.jamiaName === jamiaNameDecoded);

            currentJamiaName  = jamiaNameDecoded;
            currentMonthIndex = monthIndex;
            currentReportYear = currentYear;
            currentJamiaData  = { ...jamiaData, teachers: jamiaData.teachers || [] };
            currentYearData   = yearData;

            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('report-form-container').classList.remove('hidden');

        } catch (error) {
            console.error(error);
            document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500 text-center font-bold px-4">${error.message}</p>`;
        }
    }

    // ===== 2. RENDER CARDS (APP STYLE) =====
    function loadTeacherPeriods(teacherId, allTeachers, jamiaName, monthIndex, year) {
        const list = document.getElementById('periods-list');
        list.innerHTML = '';
        const teacher = allTeachers.find(t => t.id === teacherId);
        
        if (!teacher || !teacher.periods) return;

        teacher.periods.forEach(period => {
            const div = document.createElement('div');
            div.className = 'app-card p-4 relative'; // Card Container
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-4 border-b pb-2 border-gray-100">
                    <div>
                        <h3 class="font-bold text-lg text-emerald-800">${period.bookName}</h3>
                        <p class="text-sm text-gray-500">${period.className}</p>
                    </div>
                    <div class="bg-emerald-100 text-emerald-700 w-10 h-10 rounded-full flex items-center justify-center">
                        <i class="fas fa-book"></i>
                    </div>
                </div>

                <div id="prev-record-${period.id}" class="hidden mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100 text-sm">
                    <p class="text-blue-800 font-bold mb-1"><i class="fas fa-history ml-1"></i>گزشتہ ماہ:</p>
                    <div class="content space-y-1 text-gray-700">Loading...</div>
                </div>

                <div class="space-y-4">
                    <div class="input-group">
                        <label class="block text-sm font-bold text-gray-700 mb-1">اس ماہ کتنے صفحات پڑھائے؟</label>
                        <i class="fas fa-sort-numeric-up input-icon"></i>
                        <input type="number" inputmode="numeric" 
                               class="app-input pages-taught-input"
                               placeholder="تعداد (مثلاً: 20)"
                               data-row-id="${period.id}"
                               data-period-id="${period.id}"
                               data-class-name="${period.className}"
                               data-book-name="${period.bookName}">
                    </div>

                    <div class="input-group">
                        <label class="block text-sm font-bold text-gray-700 mb-1">سبق کی آخری عبارت</label>
                        <i class="fas fa-quote-right input-icon"></i>
                        <input type="text" class="app-input last-lesson-input"
                               placeholder="شروع کے چند الفاظ..."
                               data-row-id="${period.id}">
                    </div>

                    <div class="input-group">
                        <label class="block text-sm font-bold text-gray-700 mb-1">سبق کا صفحہ نمبر</label>
                        <i class="fas fa-bookmark input-icon"></i>
                        <input type="text" class="app-input page-number-input"
                               placeholder="نمبر (مثلاً: 45)"
                               data-row-id="${period.id}">
                    </div>
                </div>
            `;
            list.appendChild(div);
        });

        document.getElementById('periods-section').classList.remove('hidden');
        document.getElementById('submit-button-area').classList.remove('hidden');

        // Logic Calls
        loadAndShowPreviousRecord(jamiaName, teacherId, monthIndex, year);
        checkExistingSubmissionForTeacher(jamiaName, teacherId, monthIndex, year);
    }

    // ===== 3. LOGIC: PREVIOUS RECORD (FIXED + ADMIN PRIORITY) =====
    async function loadAndShowPreviousRecord(jamiaName, teacherId, currentMonth, currentYear) {
        let pm = currentMonth - 1;
        let py = currentYear;
        if (pm < 0) { pm = 11; py -= 1; }

        const q = db.collection('teacher_submissions')
            .where('jamiaId', '==', jamiaName)
            .where('teacherId', '==', teacherId)
            .where('submissionMonth', '==', pm)
            .where('submissionYear', '==', py);

        const snap = await q.get();
        if (snap.empty) return;

        // Grouping
        const periodDataMap = {}; 
        snap.forEach(doc => {
            const d = doc.data();
            if (d.role === 'user_update' && Array.isArray(d.changedValues)) {
                d.changedValues.forEach(change => {
                    const pId = change.periodId;
                    if (pId) {
                        if (!periodDataMap[pId]) periodDataMap[pId] = { teacherDocs: [], adminDocs: [] };
                        periodDataMap[pId].adminDocs.push({ ...d, specificChange: change }); 
                    }
                });
            } else if (d.periodId) {
                const pId = d.periodId;
                if (!periodDataMap[pId]) periodDataMap[pId] = { teacherDocs: [], adminDocs: [] };
                periodDataMap[pId].teacherDocs.push(d);
            }
        });

        // Calculate & Render
        Object.keys(periodDataMap).forEach(pid => {
            const { teacherDocs, adminDocs } = periodDataMap[pid];
            let finalPages = 0, finalPageNo = '-', finalIbarat = '-', foundAdminPages = false;

            if (adminDocs.length > 0) {
                adminDocs.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
                const latestAdmin = adminDocs[0];
                const change = latestAdmin.specificChange;

                if (change.pagesTaught !== undefined && change.pagesTaught !== null) {
                    finalPages = parseInt(change.pagesTaught, 10);
                    foundAdminPages = true;
                }
                if (change.lastPageNo) finalPageNo = change.lastPageNo;
                else if (latestAdmin.lastPageNo) finalPageNo = latestAdmin.lastPageNo;

                if (change.lastIbarat) finalIbarat = change.lastIbarat;
                else if (latestAdmin.lastIbarat) finalIbarat = latestAdmin.lastIbarat;
            }

            if (!foundAdminPages) {
                teacherDocs.forEach(tDoc => finalPages += parseInt(tDoc.pagesTaught || 0, 10));
            }

            if (finalPageNo === '-' || finalIbarat === '-') {
                let latestTs = 0, bestTDoc = null;
                teacherDocs.forEach(tDoc => {
                    const t = tDoc.submittedAt?.toMillis() || 0;
                    if (t > latestTs) { latestTs = t; bestTDoc = tDoc; }
                });
                if (bestTDoc) {
                    if (finalPageNo === '-') finalPageNo = bestTDoc.lastPageNo;
                    if (finalIbarat === '-') finalIbarat = bestTDoc.lastIbarat;
                }
            }

            const container = document.getElementById(`prev-record-${pid}`);
            if (container) {
                container.querySelector('.content').innerHTML = `
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-white p-2 rounded border">
                            <span class="text-gray-500 block">صفحات:</span>
                            <span class="font-bold text-lg text-emerald-600">${finalPages}</span>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <span class="text-gray-500 block">صفحہ نمبر:</span>
                            <span class="font-bold text-gray-800">${finalPageNo}</span>
                        </div>
                        <div class="col-span-2 bg-white p-2 rounded border">
                            <span class="text-gray-500 block">عبارت:</span>
                            <span class="text-gray-800">${escapeHtml(finalIbarat)}</span>
                        </div>
                    </div>
                `;
                container.classList.remove('hidden');
            }
        });
    }

    // ===== 4. LOGIC: EXISTING SUBMISSION + UPDATES =====
    async function checkExistingSubmissionForTeacher(jamiaName, teacherId, monthIndex, year) {
        const q = db.collection('teacher_submissions')
            .where('jamiaId', '==', jamiaName)
            .where('teacherId', '==', teacherId)
            .where('submissionMonth', '==', monthIndex)
            .where('submissionYear', '==', year);

        const snap = await q.get();
        const dataByPeriod = {};

        snap.forEach(doc => {
            const d = doc.data();
            if (d.role === 'user_update' && parseInt(d.pagesTaught) === 0 && !d.lastIbarat) return;
            if (d.periodId) dataByPeriod[d.periodId] = d; 
        });

        const inputs = document.querySelectorAll('.pages-taught-input');
        let lockedCount = 0;

        inputs.forEach(input => {
            const pid = input.dataset.periodId;
            const rowId = input.dataset.rowId;
            const info = dataByPeriod[pid];

            if (info) {
                lockedCount++;
                const card = input.closest('.app-card');
                
                // Lock UI
                input.value = info.pagesTaught;
                input.disabled = true;
                
                const lastInp = document.querySelector(`.last-lesson-input[data-row-id="${rowId}"]`);
                if(lastInp) { lastInp.value = info.lastIbarat || ''; lastInp.disabled = true; }
                
                const pNoInp = document.querySelector(`.page-number-input[data-row-id="${rowId}"]`);
                if(pNoInp) { pNoInp.value = info.lastPageNo || ''; pNoInp.disabled = true; }

                card.classList.add('bg-gray-50', 'opacity-90');
                if(!card.querySelector('.submitted-badge')) {
                    card.querySelector('h3').innerHTML += `<span class="mr-2 bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full submitted-badge"><i class="fas fa-check"></i> جمع شدہ</span>`;
                }
            }
        });

        if (inputs.length > 0 && lockedCount === inputs.length) {
            document.getElementById('submit-button-area').classList.add('hidden');
            renderTeacherSemesterProfile(jamiaName, teacherId, year); // Show Profile
        } else {
             loadTeacherUserUpdates(jamiaName, teacherId, monthIndex, year); // Check updates only if form active
        }
    }

    // ===== 5. LOGIC: SHOW UPDATES (MODERN TOAST) =====
    async function loadTeacherUserUpdates(jamiaId, teacherId, monthIndex, year) {
        const q = db.collection('teacher_submissions')
            .where('jamiaId', '==', jamiaId)
            .where('teacherId', '==', teacherId)
            .where('submissionMonth', '==', monthIndex)
            .where('submissionYear', '==', year)
            .where('role', '==', 'user_update');

        const snap = await q.get();
        if (snap.empty) return;

        let latestDoc = null;
        snap.forEach(d => {
            const data = d.data();
            const ts = data.updatedAt ? data.updatedAt.toMillis() : 0;
            if(!latestDoc || ts > latestDoc.ts) latestDoc = { data, ts };
        });
        if(!latestDoc) return;
        const ud = latestDoc.data;

        const changes = [];
        if(Array.isArray(ud.changedValues)) {
            ud.changedValues.forEach(cv => {
                const pid = cv.periodId;
                const pagesInp = document.querySelector(`.pages-taught-input[data-period-id="${pid}"]`);
                if(!pagesInp) return;
                
                const oldVal = pagesInp.value || '0';
                const newVal = (cv.pagesTaught !== undefined) ? String(cv.pagesTaught) : oldVal;

                // Apply to Input
                pagesInp.value = newVal;
                if(cv.lastIbarat) document.querySelector(`.last-lesson-input[data-row-id="${pid}"]`).value = cv.lastIbarat;
                if(cv.lastPageNo) document.querySelector(`.page-number-input[data-row-id="${pid}"]`).value = cv.lastPageNo;

                // Visual Highlight
                const card = pagesInp.closest('.app-card');
                card.style.border = "2px solid #f59e0b"; // Orange Border
                
                if(oldVal !== newVal) {
                    const label = card.querySelector('h3').innerText.replace('جمع شدہ', '').trim();
                    changes.push({ label, old: oldVal, new: newVal });
                }
            });
        }

        if(changes.length > 0) {
            const msgDiv = document.getElementById('form-message');
            msgDiv.innerHTML = `
                <div class="bg-orange-50 border border-orange-200 p-3 rounded-lg text-right">
                    <p class="text-orange-800 text-xs mb-2 font-bold"><i class="fas fa-exclamation-triangle"></i> تعلیمی ذمہ دار نے ترمیم کی:</p>
                    <ul class="space-y-1">
                        ${changes.map(c => `
                            <li class="flex justify-between text-xs bg-white p-1 rounded">
                                <span>${c.label}</span>
                                <span><s class="text-gray-400">${c.old}</s> <i class="fas fa-arrow-left text-orange-500 mx-1"></i> <b>${c.new}</b></span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            msgDiv.classList.remove('hidden');
        }
    }

    // ===== 6. SUBMIT LOGIC =====
    async function submitReport(jamiaId, activeYear, monthIndex, year) {
        const inputs = Array.from(document.querySelectorAll('.pages-taught-input')).filter(i => !i.disabled);
        if (inputs.length === 0) return alert('کوئی نیا ڈیٹا نہیں!');
        
        const btn = document.getElementById('submit-btn');
        const origContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

        try {
            const batch = db.batch();
            inputs.forEach(input => {
                const rowId = input.dataset.rowId;
                const pages = parseInt(input.value || '', 10);
                const lastTxt = document.querySelector(`.last-lesson-input[data-row-id="${rowId}"]`)?.value.trim();
                const lastPg  = document.querySelector(`.page-number-input[data-row-id="${rowId}"]`)?.value.trim();

                if (isNaN(pages) || pages < 0 || !lastTxt || !lastPg) throw new Error("تمام خانے پُر کریں!");

                const docRef = db.collection('teacher_submissions').doc();
                batch.set(docRef, {
                    jamiaId: decodeURIComponent(jamiaId),
                    teacherId: selectedTeacherData.id,
                    teacherName: selectedTeacherData.name,
                    periodId: input.dataset.periodId,
                    className: input.dataset.className,
                    bookName: input.dataset.bookName,
                    pagesTaught: pages,
                    lastIbarat: lastTxt,
                    lastPageNo: lastPg, // String allowed
                    submissionMonth: monthIndex,
                    submissionYear: year,
                    activeYear: activeYear,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            await batch.commit();
            alert('رپورٹ جمع ہو گئی!');
            location.reload(); // Reload to lock
        } catch (e) {
            alert(e.message);
            btn.innerHTML = origContent;
            btn.disabled = false;
        }
    }

    // ===== 7. PROFILE (GRID CARD VIEW - MOBILE FRIENDLY) =====
    async function renderTeacherSemesterProfile(jamiaName, teacherId, currentYear) {
        const grid = document.getElementById('profile-grid');
        const view = document.getElementById('teacher-profile-view');
        
        // Semester Logic
        const mIndex = currentMonthIndex;
        let semMonths = (mIndex >= 3 && mIndex <= 7) ? [3, 4, 5, 6, 7] : [8, 9, 10, 11, 0];
        const cutoff = semMonths.indexOf(mIndex);
        if(cutoff !== -1) semMonths = semMonths.slice(0, cutoff + 1);

        // Fetch Data (Smart Map Logic from previous conversation)
        const q = db.collection('teacher_submissions').where('jamiaId', '==', jamiaName).where('teacherId', '==', teacherId);
        const snap = await q.get();
        const smartMap = {}; 
        
        snap.forEach(doc => {
            const d = doc.data();
            const pid = d.periodId; const mid = d.submissionMonth;
            
            // ADMIN LOGIC
            if(d.role === 'user_update' && Array.isArray(d.changedValues)) {
                d.changedValues.forEach(cv => {
                    if(cv.periodId && cv.pagesTaught !== undefined) {
                        if(!smartMap[cv.periodId]) smartMap[cv.periodId] = {};
                        smartMap[cv.periodId][mid] = { pages: parseInt(cv.pagesTaught), isAdmin: true };
                    }
                });
            } else if(d.periodId) {
                // TEACHER LOGIC
                if(!smartMap[pid]) smartMap[pid] = {};
                if(!smartMap[pid][mid] || !smartMap[pid][mid].isAdmin) {
                    const ex = smartMap[pid][mid] ? smartMap[pid][mid].pages : 0;
                    smartMap[pid][mid] = { pages: ex + parseInt(d.pagesTaught||0), isAdmin: false };
                }
            }
        });

        // Render Cards
        const teacher = currentJamiaData.teachers.find(t => t.id === teacherId);
        if(!teacher) return;
        
        grid.innerHTML = '';
        
        teacher.periods.forEach(p => {
            // Display all relevant periods (Simplified semester check for demo)
            const total = parseInt(p.totalPages || 0);
            let taught = 0;
            
            semMonths.forEach(m => {
                if(smartMap[p.id] && smartMap[p.id][m]) taught += smartMap[p.id][m].pages;
            });

            const remaining = total - taught;
            const percent = total > 0 ? Math.round((taught / total) * 100) : 0;
            
            const cardHtml = `
                <div class="app-card p-4 border-r-4 border-emerald-500">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-lg text-emerald-900">${p.bookName}</h4>
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${p.className}</span>
                        </div>
                        <div class="text-center">
                            <span class="block text-2xl font-bold text-emerald-600">${percent}%</span>
                            <span class="text-xs text-gray-400">مکمل</span>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                        <div class="bg-emerald-600 h-2.5 rounded-full" style="width: ${percent}%"></div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div class="bg-blue-50 p-2 rounded">
                            <span class="block text-gray-500 text-xs">کل صفحات</span>
                            <span class="font-bold text-blue-800">${total}</span>
                        </div>
                        <div class="bg-green-50 p-2 rounded">
                            <span class="block text-gray-500 text-xs">پڑھائے</span>
                            <span class="font-bold text-green-800">${taught}</span>
                        </div>
                        <div class="bg-red-50 p-2 rounded">
                            <span class="block text-gray-500 text-xs">بقیہ</span>
                            <span class="font-bold text-red-800">${remaining}</span>
                        </div>
                    </div>
                </div>
            `;
            grid.innerHTML += cardHtml;
        });

        view.classList.remove('hidden');
    }

    function getMonthNameUrdu(index) {
        return ["جنوری", "فروری", "مارچ", "اپریل", "مئی", "جون","جولائی", "اگست", "ستمبر", "اکتوبر", "نومبر", "دسمبر"][index] || "";
    }
    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
</script>
</body>
</html>
