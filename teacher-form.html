<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Report Submission</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Jameel Noori Nastaleeq font */
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
            unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF, U+FE70-FEFF;
        }
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; font-size: 1.1rem; line-height: 1.6; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #14b8a6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="notification" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform translate-x-full hidden"></div>

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-2xl">

        <header class="bg-white shadow-md rounded-lg p-4 mb-8 text-center">
            <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">Talimi Karkardagi Report Form</h1>
            <p id="jamia-display" class="text-lg font-medium text-emerald-600 mt-2 urdu-font"></p>
        </header>

        <div id="loader" class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-50 flex justify-center items-center z-[70] hidden">
            <div class="loader"></div>
        </div>

        <main id="form-view" class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
             <div id="error-message" class="hidden p-4 mb-4 bg-red-100 text-red-700 border-l-4 border-red-500 rounded font-medium"></div>

            <form id="submission-form" class="space-y-6">
                
                <div class="space-y-2">
                    <label for="teacher-select" class="block text-sm font-medium text-gray-700">Teacher ka Naam <span class="text-red-500">*</span></label>
                    <select id="teacher-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white urdu-font" required disabled>
                        <option value="">-- Select Teacher --</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label for="period-select" class="block text-sm font-medium text-gray-700">Book/Period Select Karein <span class="text-red-500">*</span></label>
                    <select id="period-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white urdu-font" required disabled>
                        <option value="">-- Select Class/Book --</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                     <div class="space-y-2">
                        <label for="pages-taught-input" class="block text-sm font-medium text-gray-700">Pages Taught (Is Mahine) <span class="text-red-500">*</span></label>
                        <input type="number" id="pages-taught-input" min="0" placeholder="0" class="w-full p-3 border border-gray-300 rounded-lg" required disabled>
                    </div>
                    <div class="space-y-2">
                         <label class="block text-sm font-medium text-gray-700">Monthly Target (Pages)</label>
                         <p id="monthly-target-display" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg font-medium text-center text-gray-600">--</p>
                     </div>
                </div>

                <div id="period-details" class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm urdu-font hidden">
                     <p>Class: <span id="detail-class" class="font-medium"></span></p>
                     <p>Book: <span id="detail-book" class="font-medium"></span></p>
                     <p>Semester: <span id="detail-sem" class="font-medium"></span></p>
                     <p>Total Pages (Sem): <span id="detail-total-pages" class="font-medium"></span></p>
                 </div>

                <button type="submit" id="submit-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300" disabled>Submit Report</button>
            </form>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    
    <script>
        // ******************************************************************
        // YAHAN APNA ASLI FIREBASE CONFIG DAALEIN (Step 1 ke mutabiq)
        // ******************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", 
            authDomain: "data-f15ab.firebaseapp.com",     
            projectId: "data-f15ab",                      
            storageBucket: "data-f15ab.appspot.com", 
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
            measurementId: "G-1PHNJQWNPZ"
        };
        
        // Initialize Firebase (old syntax)
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        // ******************************************************************

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const jamiaDisplay = document.getElementById('jamia-display');
        const errorMessage = document.getElementById('error-message');
        const teacherSelect = document.getElementById('teacher-select');
        const periodSelect = document.getElementById('period-select');
        const pagesTaughtInput = document.getElementById('pages-taught-input');
        const monthlyTargetDisplay = document.getElementById('monthly-target-display');
        const submitBtn = document.getElementById('submit-btn');
        const submissionForm = document.getElementById('submission-form');
        const periodDetailsDiv = document.getElementById('period-details');

        // --- Global State ---
        let jamiaId = null;
        let activeYear = null;
        let academicYearData = null; // Full year data including academicMonths
        let karkardagiStructure = []; // Only the structure
        let currentPeriodData = null;
        
        const showLoader = (show) => loader.classList.toggle('hidden', !show);
        
        const showNotification = (message, isError = false) => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform ${isError ? 'bg-red-500' : 'bg-emerald-600'}`;
            notification.classList.remove('hidden', 'translate-x-full'); 
            void notification.offsetWidth; 
            setTimeout(() => notification.classList.remove('translate-x-full'), 10); 
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 5000); 
        };

        const showError = (message) => {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            teacherSelect.disabled = true;
            periodSelect.disabled = true;
            pagesTaughtInput.disabled = true;
            submitBtn.disabled = true;
        };

        const getReportingPeriod = () => {
             const now = new Date();
             const currentDay = now.getDate();
             let targetDate = now;

             // Grace period (report for last month)
             if (currentDay >= 1 && currentDay <= 5) {
                 targetDate = new Date(now.getFullYear(), now.getMonth(), 0); 
             }

             const monthNum = targetDate.getMonth(); // 0-11
             const yearNum = targetDate.getFullYear();
             const month = targetDate.toLocaleString('default', { month: 'long' });
             
             const isSemester1 = monthNum >= 3 && monthNum <= 7;
             const semester = isSemester1 ? "1" : "2";

             return { month, year: yearNum, monthNum, yearNum, semester };
         };

        // --- Main Logic ---

        const initForm = async () => {
            showLoader(true);
            
            // 1. URL Parameters se Jamia ID aur Active Year nikalna
            const urlParams = new URLSearchParams(window.location.search);
            jamiaId = urlParams.get('jamiaId');
            activeYear = urlParams.get('activeYear');

            if (!jamiaId || !activeYear) {
                showError("Error: Jamia ID ya Academic Year URL mein maujood nahi hai. Link check karein.");
                showLoader(false);
                return;
            }

            jamiaDisplay.textContent = `Jamia: ${decodeURIComponent(jamiaId)}`;
            
            const { month, yearNum, monthNum, semester } = getReportingPeriod();
            document.title = `Report for ${month} ${yearNum}`;

            try {
                // 2. Karkardagi Structure Load Karna
                const structureDocRef = db.collection('karkardagiStructure').doc(activeYear);
                const structureDoc = await structureDocRef.get();

                if (!structureDoc.exists) {
                    showError(`Error: Academic Year ${activeYear} ka structure database me nahi mila.`);
                    showLoader(false);
                    return;
                }
                
                const data = structureDoc.data();
                academicYearData = data; // Pure data ko store karein
                karkardagiStructure = data.structure || []; // Sirf structure array nikalen

                // 3. Current Jamia ka data filter karna
                const currentJamiaData = karkardagiStructure.find(j => j.jamiaName === decodeURIComponent(jamiaId));
                
                if (!currentJamiaData || !currentJamiaData.teachers || currentJamiaData.teachers.length === 0) {
                     showError(`Error: Jamia ${decodeURIComponent(jamiaId)} ke liye koi teacher/period set nahi hai.`);
                     showLoader(false);
                     return;
                }
                
                // 4. Teacher Select dropdown populate karna
                populateTeacherSelect(currentJamiaData.teachers);
                teacherSelect.disabled = false;
                
                // 5. Event Listeners attach karna
                teacherSelect.addEventListener('change', () => populatePeriodSelect(currentJamiaData.teachers, monthNum, semester));
                periodSelect.addEventListener('change', updatePeriodDetails);
                submissionForm.addEventListener('submit', handleSubmit);
                
                showLoader(false);

            } catch (error) {
                console.error("Error loading form data:", error);
                showError(`Data load karne mein error. (${error.message})`);
                showLoader(false);
            }
        };

        const populateTeacherSelect = (teachers) => {
            teacherSelect.innerHTML = '<option value="">-- Select Teacher --</option>';
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                teacherSelect.appendChild(option);
            });
        };

        const populatePeriodSelect = (teachers, monthNum, semester) => {
            periodSelect.innerHTML = '<option value="">-- Select Class/Book --</option>';
            periodSelect.disabled = true;
            pagesTaughtInput.disabled = true;
            submitBtn.disabled = true;
            
            const selectedTeacherId = teacherSelect.value;
            if (!selectedTeacherId) return;

            const selectedTeacher = teachers.find(t => t.id === selectedTeacherId);
            if (!selectedTeacher || !selectedTeacher.periods) return;

            // Only show periods for the current semester
            const filteredPeriods = selectedTeacher.periods.filter(p => p.semester === semester);
            
            if (filteredPeriods.length === 0) {
                const semText = semester === '1' ? 'Semester 1 (Apr-Aug)' : 'Semester 2 (Sep-Jan)';
                 showNotification(`Is mahine (${getReportingPeriod().month}) ke liye is teacher ke paas ${semText} ka koi period set nahi hai.`, true);
                 return;
            }

            filteredPeriods.forEach(period => {
                const option = document.createElement('option');
                option.value = period.id;
                option.textContent = `${period.className} / ${period.bookName} (Sem ${period.semester})`;
                // Store all period data as JSON string
                option.dataset.period = JSON.stringify(period); 
                periodSelect.appendChild(option);
            });
            
            periodSelect.disabled = false;
        };

        const updatePeriodDetails = () => {
            const selectedOption = periodSelect.options[periodSelect.selectedIndex];
            monthlyTargetDisplay.textContent = '--';
            periodDetailsDiv.classList.add('hidden');
            pagesTaughtInput.disabled = true;
            submitBtn.disabled = true;
            currentPeriodData = null;

            if (!selectedOption || !selectedOption.value) return;

            try {
                const period = JSON.parse(selectedOption.dataset.period);
                currentPeriodData = period;
                const { monthNum, semester } = getReportingPeriod();
                
                // Monthly Target Calculate Karna (Karkardagi.html ki tarah)
                const academicMonths = academicYearData.academicMonths || {};
                const sem1TotalDays = academicYearData.sem1TotalDays || 0;
                const sem2TotalDays = academicYearData.sem2TotalDays || 0;
                
                const semesterTotalDays = semester === '1' ? sem1TotalDays : sem2TotalDays;
                const daysThisMonth = academicMonths[monthNum] || 0; 
                
                let monthlyTarget = 0;
                if (semesterTotalDays > 0 && daysThisMonth > 0 && period.totalPages > 0) {
                    const perDayTarget = period.totalPages / semesterTotalDays;
                    monthlyTarget = Math.round(perDayTarget * daysThisMonth);
                }

                // Display Details
                document.getElementById('detail-class').textContent = period.className;
                document.getElementById('detail-book').textContent = period.bookName;
                document.getElementById('detail-sem').textContent = period.semester === '1' ? '1 (Apr-Aug)' : '2 (Sep-Jan)';
                document.getElementById('detail-total-pages').textContent = period.totalPages;
                periodDetailsDiv.classList.remove('hidden');

                monthlyTargetDisplay.textContent = monthlyTarget > 0 ? monthlyTarget : "Target Not Set";
                
                if (monthlyTarget > 0) {
                     pagesTaughtInput.disabled = false;
                     submitBtn.disabled = false;
                } else {
                     showNotification("Is mahine ke liye target pages calculate nahi ho paye. Admin ko setup check karne ke liye kahein.", true);
                }

            } catch (e) {
                console.error("Error parsing period data:", e);
                showNotification("Book ka data load karne me error.", true);
            }
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!currentPeriodData) return;
            
            showLoader(true);
            submitBtn.disabled = true;

            const teacherName = teacherSelect.options[teacherSelect.selectedIndex].textContent;
            const jamiaName = decodeURIComponent(jamiaId);
            const pagesTaught = parseInt(pagesTaughtInput.value, 10) || 0;
            const { month, yearNum, monthNum } = getReportingPeriod();

            const submissionData = {
                // IDs
                periodId: currentPeriodData.id,
                teacherId: teacherSelect.value,
                jamiaId: jamiaName, // Use jamiaName as it's the structure's identifier
                academicYear: activeYear,

                // Content
                teacherName: teacherName,
                className: currentPeriodData.className,
                bookName: currentPeriodData.bookName,
                semester: currentPeriodData.semester,
                pagesTaught: pagesTaught,

                // Date/Time
                submissionYear: yearNum,
                submissionMonth: monthNum,
                submissionMonthName: month,
                submittedAt: firebase.firestore.FieldValue.serverTimestamp() // Server time for freshness
            };

            try {
                // Submitting data to 'teacher_submissions' collection
                await db.collection('teacher_submissions').add(submissionData);
                
                showNotification(`Report submitted successfully for ${teacherName}!`);
                
                // Form ko reset karna
                submissionForm.reset();
                teacherSelect.disabled = false; 
                periodSelect.innerHTML = '<option value="">-- Select Class/Book --</option>';
                periodSelect.disabled = true;
                pagesTaughtInput.disabled = true;
                submitBtn.disabled = true;
                monthlyTargetDisplay.textContent = '--';
                periodDetailsDiv.classList.add('hidden');


            } catch (error) {
                console.error("Submission failed:", error);
                showNotification(`Report submit nahi ho payi: ${error.message}`, true);
                submitBtn.disabled = false;
            } finally {
                showLoader(false);
            }
        };


        initForm();
    </script>
</body>
</html>
