<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§ÛØ§Ù†Û ØªØ¹Ù„ÛŒÙ…ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Jameel Noori Nastaleeq font -->
    <link href="https://fonts.cdnfonts.com/css/jameel-noori-nastaleeq" rel="stylesheet"/>

    <style>
        body {
            font-family: 'Jameel Noori Nastaleeq', serif !important;
        }

        h1, h2, h3, p, label, select, input, th, td, button {
            font-family: 'Jameel Noori Nastaleeq', serif !important;
        }

        .updated-highlight {
  border: 2px solid #f59e0b;
  background: rgba(245,158,11,0.04);
  position: relative;
}
.user-badge {
  display:inline-block;
  background:#f59e0b;
  color:#fff;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  margin-right:8px;
}

    </style>

    <script>
  const firebaseConfig = {
    apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
    authDomain: "data-f15ab.firebaseapp.com",
    projectId: "data-f15ab",
    storageBucket: "data-f15ab.firebasestorage.app",
    messagingSenderId: "449137002393",
    appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
    measurementId: "G-1PHNJQWNPZ"
  };

  firebase.initializeApp(firebaseConfig);
  const db   = firebase.firestore();
  const auth = firebase.auth();

  // ğŸ”‘ Anonymous sign-in (yahi login Firestore rules ko auth deta hai)
  auth.signInAnonymously().catch(err => {
    console.error("Anonymous auth error:", err);
  });
</script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 text-base sm:text-lg">

<div id="loading-spinner" class="text-center">
    <i class="fas fa-spinner fa-spin text-emerald-600 text-3xl"></i>
    <p class="mt-2 text-gray-700">ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’â€¦</p>
</div>

<div id="report-form-container"
     class="bg-white p-4 sm:p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-3xl hidden">

    <!-- Heading / Subheading -->
    <h1 class="text-2xl sm:text-3xl font-bold text-center text-emerald-700 mb-1">
        Ù…Ø§ÛØ§Ù†Û ØªØ¹Ù„ÛŒÙ…ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ
    </h1>
    <p class="text-center text-gray-600 mb-5 sm:mb-6">
        Ù…Ø¬Ù„Ø³ ØªØ¹Ù„ÛŒÙ…ÛŒ Ø§Ù…ÙˆØ± ÛÙ†Ø¯
    </p>

    <div class="mb-4 sm:mb-6 p-3 bg-emerald-50 border-r-4 border-emerald-500 text-emerald-800 text-right rounded-lg">
        <p id="jamia-display" class="font-semibold">Ø¬Ø§Ù…Ø¹Û: Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’â€¦</p>
        <p id="report-month-display" class="text-xs sm:text-sm mt-1">Ø±Ù¾ÙˆØ±Ù¹ Ø¨Ø±Ø§Ø¦Û’: Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’â€¦</p>
    </div>

    <form id="teacher-report-form" class="text-right">
        <!-- TEACHER LOGIN BY UNIQUE CODE -->
<div class="mb-4 sm:mb-6 space-y-2">
    <label for="teacher-code-input"
           class="block text-gray-700 font-semibold mb-1 text-sm sm:text-base">
        Û” Ø§Ù¾Ù†Ø§ Ø§Ø¬ÛŒØ± Ú©ÙˆÚˆ Ø¯Ø±Ø¬ ÙØ±Ù…Ø§Ø¦ÛŒÚº:
    </label>

    <div class="flex gap-2">
        <input id="teacher-code-input"
               type="text"
               class="flex-1 p-2.5 sm:p-3 border border-gray-300 rounded-lg
                      focus:ring-emerald-500 focus:border-emerald-500 bg-white text-right text-sm sm:text-base"
               placeholder="Ù…Ø«Ù„Ø§Ù‹: 12345">
        <button type="button"
                id="verify-code-btn"
                class="whitespace-nowrap bg-emerald-600 hover:bg-emerald-700 text-white font-bold
                       px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base">
            ØªØµØ¯ÛŒÙ‚
        </button>
    </div>

    <p id="teacher-code-error"
       class="hidden text-red-600 text-xs sm:text-sm mt-1"></p>

    <!-- Sirf display ke liye, teacher apna naam change nahi kar sakta -->
    <div id="teacher-name-display-wrapper" class="hidden mt-3">
        <span class="block text-gray-700 font-semibold text-sm sm:text-base mb-1">
            Ø¢Ù¾ Ú©Ø§ Ù†Ø§Ù…:
        </span>
        <div id="teacher-name-display"
             class="inline-block bg-gray-100 border border-gray-300 rounded-lg
                    px-3 py-1 text-sm sm:text-base urdu-font">
        </div>
    </div>

    <!-- hidden select â€“ sirf internal use ke liye -->
    <select id="teacher-select" class="hidden"></select>
</div>

        <!-- PERIODS SECTION (NO HORIZONTAL SCROLL) -->
        <div id="periods-section" class="mb-6 sm:mb-8 hidden">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">
                Û” Ù¾Ú‘Ú¾Ø§Ø¦Û’ Ú¯Ø¦Û’ ØµÙØ­Ø§Øª (ÛØ± Ú©Ù„Ø§Ø³ / Ú©ØªØ§Ø¨ Ú©Û’ Ù„ÛŒÛ’)
            </h2>
            <div id="periods-list" class="space-y-4"></div>
        </div>

        <!-- SUBMIT BUTTON -->
        <div id="submit-button-area" class="text-center hidden">
            <button type="submit" id="submit-btn"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold
                           py-2.5 sm:py-3 px-8 rounded-lg transition duration-150 shadow-md text-base sm:text-lg">
                <i class="fas fa-upload ml-2"></i> Ù…Ø§ÛØ§Ù†Û ØªØ¹Ù„ÛŒÙ…ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ø¬Ù…Ø¹ Ú©Ø±ÛŒÚº
            </button>
        </div>

        <div id="form-message"
             class="mt-4 p-3 rounded-lg text-center hidden text-sm sm:text-base"></div>
    </form>

    <div id="teacher-profile-view" class="hidden mt-8 border-t pt-6">
        <h2 class="text-xl font-bold text-center text-emerald-800 mb-4">Ø¢Ù¾ Ú©ÛŒ Ø³Ù…Ø³Ù¹Ø± Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ù¾Ø±ÙˆÙØ§Ø¦Ù„</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm sm:text-base border border-gray-300 text-center">
                <thead class="bg-emerald-100 text-emerald-800">
                    <tr>
                        <th class="p-2 border">Ú©ØªØ§Ø¨ / Ú©Ù„Ø§Ø³</th>
                        <th class="p-2 border">Ú©Ù„ ØµÙØ­Ø§Øª (Ø³Ù…Ø³Ù¹Ø±)</th>
                        <th class="p-2 border">Ú©Ù„ Ù¾Ú‘Ú¾Ø§Ø¦Û’ Ú¯Ø¦Û’ (Ù…Ø¬Ù…ÙˆØ¹ÛŒ)</th>
                        <th class="p-2 border">Ø¨Ù‚ÛŒÛ</th>
                    </tr>
                </thead>
                <tbody id="profile-table-body" class="bg-white">
                    </tbody>
            </table>
        </div>
        <div class="mt-4 text-center">
            <p class="text-sm text-gray-500">Ø¬Ø²Ø§Ú© Ø§Ù„Ù„Û Ø®ÛŒØ±Ø§Ù‹! Ø¢Ù¾ Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ù…Ú©Ù…Ù„ ÛÙˆ Ú†Ú©Ø§ ÛÛ’Û”</p>
        </div>
    </div>

</div>

<script>
    // ------- GLOBAL STATE -------
    let selectedTeacherData = null;
    let currentJamiaName    = null;
    let currentMonthIndex   = null;
    let currentReportYear   = null;
    let currentJamiaData    = null;
    let currentYearData     = null; // <--- YE ADD KAREIN
    let formLocked          = false;

    document.addEventListener('DOMContentLoaded', () => {
        const loadingSpinner = document.getElementById('loading-spinner');

        const urlParams   = new URLSearchParams(window.location.search);
        const jamiaId     = urlParams.get('jamiaId');   // encoded
        const userId      = urlParams.get('userId');    // dashboard user UID
        const activeYear  = urlParams.get('activeYear');
        const monthIndexQ = urlParams.get('monthIndex');
        const reportYearQ = urlParams.get('reportYear');

        if (!jamiaId || !userId || !activeYear) {
            loadingSpinner.innerHTML =
                '<p class="text-red-600 font-bold">Error: Ø±Ù¾ÙˆØ±Ù¹Ù†Ú¯ Ù„Ù†Ú© Ø¯Ø±Ø³Øª Ù†ÛÛŒÚº ÛÛ’ (Ø¬Ø§Ù…Ø¹ÛØŒ ÛŒÙˆØ²Ø± ÛŒØ§ Ø³Ø§Ù„ missing ÛÛ’)</p>';
            return;
        }

        // Month/year decide
        let monthIndex, reportYear;
        if (monthIndexQ !== null && reportYearQ !== null) {
            monthIndex = parseInt(monthIndexQ, 10);
            reportYear = parseInt(reportYearQ, 10);
        } else {
            const today = new Date();
            monthIndex = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
            reportYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
        }

        const monthName = new Date(reportYear, monthIndex)
            .toLocaleString('en-US', { month: 'long' });

        document.getElementById('jamia-display').textContent =
            `Ø¬Ø§Ù…Ø¹Û: ${decodeURIComponent(jamiaId)}`;
        document.getElementById('report-month-display').textContent =
            `Ø±Ù¾ÙˆØ±Ù¹ Ø¨Ø±Ø§Ø¦Û’: ${monthName} ${reportYear}`;

        // Data load (Jamia + teachers/periods)
        loadJamiaData(jamiaId, userId, activeYear, monthIndex, reportYear);

        // Submit handler
        document.getElementById('teacher-report-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitReport(jamiaId, activeYear, monthIndex, reportYear);
        });

        // Teacher code verify controls
        const codeInput                 = document.getElementById('teacher-code-input');
        const verifyBtn                 = document.getElementById('verify-code-btn');
        const codeError                 = document.getElementById('teacher-code-error');
        const teacherNameDisplayWrapper = document.getElementById('teacher-name-display-wrapper');
        const teacherNameDisplay        = document.getElementById('teacher-name-display');

        function verifyTeacherByCode() {
            if (!currentJamiaData || !Array.isArray(currentJamiaData.teachers)) {
                alert('Ø¬Ø§Ù…Ø¹Û Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ø§Ø¨Ú¾ÛŒ Ù„ÙˆÚˆ Ù†ÛÛŒÚº ÛÙˆØ§ØŒ ØªÚ¾ÙˆÚ‘ÛŒ Ø¯ÛŒØ± Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”');
                return;
            }

            codeError.classList.add('hidden');
            codeError.textContent = '';

            const code = (codeInput.value || '').trim();

            if (!code) {
                codeError.textContent = 'Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ù¾Ù†Ø§ Ø§Ø¬ÛŒØ± Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”';
                codeError.classList.remove('hidden');
                return;
            }

            if (code.length !== 5) {
                codeError.textContent = 'Ø¨Ø±Ø§Û Ú©Ø±Ù… Ûµ Ø§Ø¹Ø¯Ø§Ø¯ Ù¾Ø± Ù…Ø´ØªÙ…Ù„ Ø¯Ø±Ø³Øª Ø§Ø¬ÛŒØ± Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”';
                codeError.classList.remove('hidden');
                return;
            }

            const teachers = currentJamiaData.teachers || [];

            // loginCode se match
            const teacher = teachers.find(t => String(t.loginCode) === code);

            if (!teacher) {
                codeError.textContent = 'Ø§Ø¬ÛŒØ± Ú©ÙˆÚˆ Ø¯Ø±Ø³Øª Ù†ÛÛŒÚº ÛÛ’ØŒ Ø¯ÙˆØ¨Ø§Ø±Û Ú†ÛŒÚ© Ú©Ø±ÛŒÚºÛ”';
                codeError.classList.remove('hidden');
                return;
            }

            // âœ… Teacher mil gaya
            selectedTeacherData = teacher;

            const teacherSelect = document.getElementById('teacher-select');
            if (teacherSelect) {
                teacherSelect.value = teacher.id;
                teacherSelect.disabled = true;
            }

            codeInput.disabled = true;
            verifyBtn.disabled = true;

            teacherNameDisplay.textContent = teacher.name || '';
            teacherNameDisplayWrapper.classList.remove('hidden');

            // FORM LOAD â€” THIS WAS MISSING
loadTeacherPeriods(
    teacher.id,
    currentJamiaData.teachers,
    currentJamiaName,
    currentMonthIndex,
    currentReportYear
);

// USER UPDATE OVERLAY
loadTeacherUserUpdates(
    currentJamiaName,
    teacher.id,
    currentMonthIndex,
    currentReportYear
);

        }

        if (verifyBtn) {
            verifyBtn.addEventListener('click', verifyTeacherByCode);
        }

        if (codeInput) {
            codeInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    verifyTeacherByCode();
                }
            });
        }
    });

    // ===== DATA FETCHING =====
    async function loadJamiaData(jamia, userId, year, monthIndex, currentYear) {
        const loadingSpinner = document.getElementById('loading-spinner');
        const formContainer  = document.getElementById('report-form-container');
        const teacherSelect  = document.getElementById('teacher-select');

        try {
            const userRef  = db.collection('users').doc(userId);
            const userSnap = await userRef.get();

            if (!userSnap.exists) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">User Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ù†ÛÛŒÚº Ù…Ù„Ø§ (users collection).</p>';
                return;
            }

            const userData      = userSnap.data();
            const academicYears = userData.academicYears || {};
            const yearData      = academicYears[year];

            if (!yearData || !Array.isArray(yearData.karkardagiStructure)) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">Ø§Ø³ Ø³Ø§Ù„ Ú©Û’ Ù„ÛŒÛ’ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ú©Ø§ Ø§Ø³Ù¹Ø±Ú©Ú†Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº ÛÛ’Û”</p>';
                return;
            }

            const structure        = yearData.karkardagiStructure;
            const jamiaNameDecoded = decodeURIComponent(jamia);

            const jamiaData = structure.find(j => j.jamiaName === jamiaNameDecoded);

            if (!jamiaData || !Array.isArray(jamiaData.teachers) || jamiaData.teachers.length === 0) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">Ø§Ø³ Ø¬Ø§Ù…Ø¹Û Ú©Û’ Ø§Ø³Ø§ØªØ°Û Ú©Ø§ Ø§Ø³Ù¹Ø±Ú©Ú†Ø± Ø³ÛŒÙ¹ Ù†ÛÛŒÚº ÛÛ’Û”</p>';
                return;
            }

            // Teachers dropdown (hidden, sirf internal use)
            teacherSelect.innerHTML = '';
            const teachers = Array.isArray(jamiaData.teachers) ? jamiaData.teachers : [];
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                teacherSelect.appendChild(option);
            });

            // Global state â€“ baad me code verify ke liye
            currentJamiaName  = jamiaNameDecoded;
            currentMonthIndex = monthIndex;
            currentReportYear = currentYear;
            currentJamiaData  = { ...jamiaData, teachers };
            currentYearData   = yearData; // <--- YE LINE ZAROORI HAI TARGET CALCULATION KE LIYE

            loadingSpinner.classList.add('hidden');
            formContainer.classList.remove('hidden');

        } catch (error) {
            console.error("Error loading Jamia data:", error);
            loadingSpinner.innerHTML =
                `<p class="text-red-600 font-bold">ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ Ú©Ø±ØªÛ’ ÙˆÙ‚Øª Ø®Ø±Ø§Ø¨ÛŒ: ${error.message}</p>`;
        }
    }

    // ===== PERIODS (cards) + existing submission check =====
    function loadTeacherPeriods(teacherId, allTeachers, jamiaName, monthIndex, year) {
        const periodsList      = document.getElementById('periods-list');
        const periodsSection   = document.getElementById('periods-section');
        const submitButtonArea = document.getElementById('submit-button-area');
        const formMessage      = document.getElementById('form-message');

        // Reset
        formLocked = false;
        if (formMessage) {
            formMessage.classList.add('hidden');
            formMessage.textContent = '';
        }

        periodsList.innerHTML = '';

        const teacher = allTeachers.find(t => t.id === teacherId);

        if (!teacher || !Array.isArray(teacher.periods) || teacher.periods.length === 0) {
            periodsList.innerHTML =
                '<p class="text-center py-4 text-gray-500 text-sm sm:text-base">Ø§Ø³ Ø§Ø³ØªØ§Ø¯ Ú©Û’ Ù„ÛŒÛ’ Ú©ÙˆØ¦ÛŒ Ù¾ÛŒØ±ÛŒÚˆ Ø³ÛŒÙ¹ Ù†ÛÛŒÚº ÛÛ’Û”</p>';
            periodsSection.classList.remove('hidden');
            submitButtonArea.classList.add('hidden');
            return;
        }

        selectedTeacherData = teacher;

        teacher.periods.forEach(period => {
            const className = period.className || 'Ú©Ù„Ø§Ø³';
            const bookName  = period.bookName  || 'Ú©ØªØ§Ø¨';

            const card = document.createElement('div');
            card.className = 'bg-gray-50 border border-gray-200 rounded-xl p-3 sm:p-4 shadow-sm';

            card.innerHTML = `
                <div class="mb-2 text-sm sm:text-base font-semibold text-emerald-700">
                    Ú©Ù„Ø§Ø³ / Ú©ØªØ§Ø¨: ${className} (${bookName})
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">Ù¾Ú‘Ú¾Ø§Ø¦Û’ Ú¯Ø¦Û’ ØµÙØ­Ø§Øª</label>
                        <input type="number"
                               data-row-id="${period.id}"
                               data-period-id="${period.id}"
                               data-class-name="${className}"
                               data-book-name="${bookName}"
                               class="pages-taught-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-center focus:border-emerald-500"
                               min="0"
                               placeholder="ØµÙØ­Ø§Øª Ú©ÛŒ ØªØ¹Ø¯Ø§Ø¯"
                               required>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">Ø³Ø¨Ù‚ Ú©ÛŒ Ø¢Ø®Ø±ÛŒ Ø¹Ø¨Ø§Ø±Øª</label>
                        <input type="text"
                               data-row-id="${period.id}"
                               class="last-lesson-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm focus:border-emerald-500"
                               placeholder="Ø¢Ø®Ø±ÛŒ Ø¹Ø¨Ø§Ø±Øª"
                               required>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">Ø³Ø¨Ù‚ Ú©Ø§ ØµÙØ­Û Ù†Ù…Ø¨Ø±</label>
                        <input type="text"
                               data-row-id="${period.id}"
                               class="page-number-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-center focus:border-emerald-500"
                               min="0"
                               placeholder="ØµÙØ­Û Ù†Ù…Ø¨Ø±"
                               required>
                    </div>
                </div>
            `;

            periodsList.appendChild(card);
        });

        periodsSection.classList.remove('hidden');
        submitButtonArea.classList.remove('hidden');

        // ğŸ”’ Existing submission check
        checkExistingSubmissionForTeacher(jamiaName, teacherId, monthIndex, year);
    }

    // ----------------- REPLACE loadTeacherUserUpdates WITH THIS (FILTERED VERSION) -----------------
async function loadTeacherUserUpdates(jamiaId, teacherId, monthIndex, year) {
    try {
        const submissionsRef = db.collection('teacher_submissions');
        
        const q = submissionsRef
            .where('jamiaId', '==', jamiaId)
            .where('teacherId', '==', teacherId)
            .where('submissionMonth', '==', monthIndex)
            .where('submissionYear', '==', year)
            .where('role', '==', 'user_update');

        const snap = await q.get();
        if (snap.empty) return;

        // Pick latest update manually
        let latestDoc = null;
        snap.forEach(d => {
            const data = d.data();
            if (!latestDoc) latestDoc = { id: d.id, data };
            else {
                const prevT = latestDoc.data.updatedAt ? latestDoc.data.updatedAt.toMillis() : 0;
                const curT  = data.updatedAt ? data.updatedAt.toMillis() : 0;
                if (curT > prevT) latestDoc = { id: d.id, data };
            }
        });
        if (!latestDoc) return;
        const ud = latestDoc.data;

        const changesSummary = [];
        let hasValidUpdates = false; // Track agar waqai koi update valid hai

        if (Array.isArray(ud.changedValues)) {
            ud.changedValues.forEach(cv => {
                
                // --- ğŸ›‘ GHOST FILTER (Ye Naya Code Hai) ---
                // Agar Admin ne 0 save kiya hai aur koi ibarat nahi likhi, to ye ghalti se save hua hai.
                // Isay ignore karein taake teacher ko purana data hi nazar aaye.
                const pTaughtCheck = parseInt(cv.pagesTaught || 0, 10);
                const lIbaratCheck = (cv.lastIbarat || '').trim();
                
                // Agar Pages 0 hain AUR Ibarat khali hai -> to ye update bekaar hai, SKIP karo
                if (pTaughtCheck === 0 && lIbaratCheck === '') {
                    return; 
                }
                // ------------------------------------------

                hasValidUpdates = true; // Agar yahan tak pohanch gaye matlab update asli hai
                const pid = cv.periodId;

                // Find inputs
                const pagesInp = document.querySelector(`.pages-taught-input[data-period-id="${pid}"]`);
                const lastInp  = document.querySelector(`.last-lesson-input[data-period-id="${pid}"]`);
                const pnoInp   = document.querySelector(`.page-number-input[data-period-id="${pid}"]`);

                // Previous values (Fallback)
                const prevPages = pagesInp && pagesInp.value !== undefined && pagesInp.value !== '' ? pagesInp.value : '-';
                const prevLast  = lastInp  && lastInp.value  !== undefined && lastInp.value !== ''  ? lastInp.value  : '-';
                const prevPno   = pnoInp   && pnoInp.value   !== undefined && pnoInp.value !== ''   ? pnoInp.value   : '-';

                // New values
                const newPages = (cv.pagesTaught !== undefined && cv.pagesTaught !== null) ? String(cv.pagesTaught) : (pagesInp && pagesInp.value ? pagesInp.value : '-');
                const newLast  = (cv.lastIbarat !== undefined && cv.lastIbarat !== null) ? String(cv.lastIbarat) : (lastInp && lastInp.value ? lastInp.value : '-');
                const newPno   = (cv.lastPageNo !== undefined && cv.lastPageNo !== null) ? String(cv.lastPageNo) : (pnoInp && pnoInp.value ? pnoInp.value : '-');

                // Apply values
                if (pagesInp) pagesInp.value = newPages;
                if (lastInp)  lastInp.value  = newLast;
                if (pnoInp)   pnoInp.value   = newPno;

                // Highlight & Badge logic
                const card = pagesInp?.closest('.period-card') || pagesInp?.closest('.reporting-row') || pagesInp?.parentElement?.parentElement?.parentElement; // Adjust selector based on your HTML structure (usually card div)
                
                // Card dhoondne ka try karein (Tailwind classes ke hisab se)
                const actualCard = pagesInp ? pagesInp.closest('div.bg-gray-50') : null;

                if (actualCard) {
                    actualCard.classList.add('updated-highlight');
                    
                    if (!actualCard.querySelector('.user-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'user-badge';
                        badge.textContent = 'ØªØ¹Ù„ÛŒÙ…ÛŒ Ø°Ù…Û Ø¯Ø§Ø± Ù†Û’ Ø§Ù¾ ÚˆÛŒÙ¹ Ú©ÛŒØ§';

                        let header = actualCard.querySelector('.mb-2, .font-semibold') || actualCard.firstElementChild;
                        if (header) {
                            if (typeof header.prepend === 'function') header.prepend(badge);
                            else header.parentNode.insertBefore(badge, header);
                        } else {
                            actualCard.insertBefore(badge, actualCard.firstChild);
                        }
                    }
                }

                // Label for summary
                let periodLabel = pid;
                if (actualCard) {
                    const labelEl = actualCard.querySelector('.font-semibold, .text-emerald-700') || null;
                    if (labelEl && labelEl.textContent) periodLabel = labelEl.textContent.replace('ØªØ¹Ù„ÛŒÙ…ÛŒ Ø°Ù…Û Ø¯Ø§Ø± Ù†Û’ Ø§Ù¾ ÚˆÛŒÙ¹ Ú©ÛŒØ§', '').trim();
                }

                changesSummary.push({
                    periodLabel,
                    prev: { pages: prevPages, last: prevLast, pno: prevPno },
                    now:  { pages: newPages,  last: newLast,  pno: newPno }
                });
            });
        }

        // Agar koi valid update nahi mila, to function yahi rok do (Message mat dikhao)
        if (!hasValidUpdates) return;

        // Keep form readonly
        document.querySelectorAll('.pages-taught-input, .last-lesson-input, .page-number-input').forEach(el => {
            el.readOnly = true;
        });

        // Show Message
        const formMessage = document.getElementById('form-message');
        if (formMessage) {
            const when = ud.updatedAt && typeof ud.updatedAt.toDate === 'function'
                ? ud.updatedAt.toDate().toLocaleString()
                : (ud.updatedAt && ud.updatedAt.toMillis ? new Date(ud.updatedAt.toMillis()).toLocaleString() : '');

            let html = `<div class="text-right"><strong>Ø§Ø³ Ø±Ù¾ÙˆØ±Ù¹ Ù…ÛŒÚº ØªØ¹Ù„ÛŒÙ…ÛŒ Ø°Ù…Û Ø¯Ø§Ø± Ù†Û’ Ú©Ú†Ú¾ ØªØ¨Ø¯ÛŒÙ„ÛŒØ§Úº Ú©ÛŒ ÛÛŒÚº${ when ? ' (' + escapeHtml(when) + ')' : '' } :</strong></div>`;
            html += `<ul class="mt-2 text-right" style="list-style:none; padding-right:0; line-height:1.8;">`;

            if (changesSummary.length === 0) {
                html += `<li>ØªÙØµÛŒÙ„ÛŒ ØªØ¨Ø¯ÛŒÙ„ÛŒØ§Úº Ø¯Ø³ØªÛŒØ§Ø¨ Ù†ÛÛŒÚº ÛÛŒÚºÛ”</li>`;
            } else {
                changesSummary.forEach(ch => {
                    html += `<li class="mb-2">`;
                    html += `<strong>${escapeHtml(ch.periodLabel)}</strong><br>`;
                    if (ch.prev.pages !== ch.now.pages) html += `ØµÙØ­Û’: Ù¾ÛÙ„Û’ <u>${escapeHtml(ch.prev.pages)}</u> ØªÚ¾Û’ØŒ Ø§Ø¨ <u>${escapeHtml(ch.now.pages)}</u> Ú©Ø± Ø¯ÛŒÛ’ Ú¯Ø¦Û’ ÛÛŒÚºÛ”<br>`;
                    else html += `ØµÙØ­Û’: <u>${escapeHtml(ch.now.pages)}</u>Û”<br>`;
                    
                    if (ch.prev.last !== ch.now.last) html += `Ø¢Ø®Ø±ÛŒ Ø¹Ø¨Ø§Ø±Øª: Ù¾ÛÙ„Û’ "<u>${escapeHtml(ch.prev.last)}</u>" ØªÚ¾ÛŒØŒ Ø§Ø¨ "<u>${escapeHtml(ch.now.last)}</u>" Ú©Ø± Ø¯ÛŒ Ú¯Ø¦ÛŒ ÛÛ’Û”<br>`;
                    
                    if (ch.prev.pno !== ch.now.pno) html += `ØµÙØ­Û Ù†Ù…Ø¨Ø±: Ù¾ÛÙ„Û’ <u>${escapeHtml(ch.prev.pno)}</u> ØªÚ¾Ø§ØŒ Ø§Ø¨ <u>${escapeHtml(ch.now.pno)}</u> Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’Û”<br>`;
                    html += `</li>`;
                });
            }
            html += `</ul>`;
            html += `<div class="mt-2"><small>ÛŒÛ ØªØ¨Ø¯ÛŒÙ„ÛŒØ§Úº ÙØ§Ø±Ù… Ù…ÛŒÚº Ù†Ù…Ø§ÛŒØ§Úº Ú©Ø± Ø¯ÛŒ Ú¯Ø¦ÛŒ ÛÛŒÚºÛ”</small></div>`;

            formMessage.innerHTML = html;
            formMessage.className = 'mt-4 p-3 rounded-lg text-center bg-yellow-100 text-yellow-800 text-sm sm:text-base';
            formMessage.style.display = 'block';
        }

    } catch (err) {
        console.error('Error loading user updates for teacher:', err);
    }
}
    
    // ğŸ”’ Existing submission check & Partial Locking
    async function checkExistingSubmissionForTeacher(jamiaName, teacherId, monthIndex, year) {
        const formMessage = document.getElementById('form-message');
        const submitBtn   = document.getElementById('submit-button-area');
        const profileView = document.getElementById('teacher-profile-view');
        const periodsSection = document.getElementById('periods-section');

        try {
            const submissionsRef = db.collection('teacher_submissions');
            const q = submissionsRef
                .where('jamiaId', '==', jamiaName)
                .where('teacherId', '==', teacherId)
                .where('submissionMonth', '==', monthIndex)
                .where('submissionYear', '==', year);

            const snap = await q.get();
            const dataByPeriod = {};

            snap.forEach(doc => {
                const d = doc.data();
                // Filter Ghost/Deleted Data
                if (d.role === 'user_update' && parseInt(d.pagesTaught) === 0 && (!d.lastIbarat || d.lastIbarat.trim() === '')) return;

                const pId = d.periodId;
                if (!pId) return;

                // Simple aggregation
                if (!dataByPeriod[pId]) dataByPeriod[pId] = { ...d };
                else {
                    // Agar multiple entries hain to latest wali ya sum logic (Yahan hum simple exist check kar rahe hain)
                    // Behtar hai ke hum man len ke data exist karta hai.
                }
            });

            // Ab har card ko check karein
            const allPeriodInputs = document.querySelectorAll('.pages-taught-input');
            let totalPeriods = allPeriodInputs.length;
            let lockedCount = 0;

            allPeriodInputs.forEach(input => {
                const periodId = input.dataset.periodId;
                const rowId = input.dataset.rowId;
                const info = dataByPeriod[periodId];

                const cardDiv = input.closest('div.bg-gray-50');

                if (info) {
                    // DATA EXISTS -> LOCK THIS CARD
                    lockedCount++;
                    
                    input.value = info.pagesTaught;
                    input.readOnly = true;
                    input.classList.add('bg-gray-200', 'cursor-not-allowed');

                    const lastInp = document.querySelector(`.last-lesson-input[data-row-id="${rowId}"]`);
                    if (lastInp) {
                        lastInp.value = info.lastIbarat || '';
                        lastInp.readOnly = true;
                        lastInp.classList.add('bg-gray-200', 'cursor-not-allowed');
                    }

                    const pageNoInp = document.querySelector(`.page-number-input[data-row-id="${rowId}"]`);
                    if (pageNoInp) {
                        pageNoInp.value = info.lastPageNo || '';
                        pageNoInp.readOnly = true;
                        pageNoInp.classList.add('bg-gray-200', 'cursor-not-allowed');
                    }

                    // Add "Submitted" Badge
                    if (cardDiv && !cardDiv.querySelector('.submitted-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'submitted-badge float-left bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold';
                        badge.innerHTML = '<i class="fas fa-check"></i> Ø¬Ù…Ø¹ ÛÙˆ Ú¯ÛŒØ§';
                        cardDiv.querySelector('.font-semibold').appendChild(badge);
                    }
                }
            });

            // Agar sab kuch lock ho gaya hai -> Show Profile, Hide Submit
            if (totalPeriods > 0 && lockedCount === totalPeriods) {
                submitBtn.classList.add('hidden');
                periodsSection.classList.add('hidden'); // Cards chhupa dein
                formMessage.textContent = 'Ø§Ù„Ø­Ù…Ø¯Ù„Ù„Û! Ø¢Ù¾ Ú©ÛŒ ØªÙ…Ø§Ù… Ø±Ù¾ÙˆØ±Ù¹Ø³ Ø¬Ù…Ø¹ ÛÙˆ Ú†Ú©ÛŒ ÛÛŒÚºÛ”';
                formMessage.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700 font-bold';
                formMessage.classList.remove('hidden');
                
                // Show Profile
                renderTeacherSemesterProfile(jamiaName, teacherId, year);
            } else {
                // Kuch bacha hai -> Show Submit
                submitBtn.classList.remove('hidden');
                profileView.classList.add('hidden');
            }

        } catch (err) {
            console.error('Error checking existing submission:', err);
        }
    }

    function showLockedPopup() {
        alert('Ø¢Ù¾ Ú©ÛŒ Ø§Ø³ Ù…ÛÛŒÙ†Û’ Ú©ÛŒ Ø±Ù¾ÙˆØ±Ù¹ Ù¾ÛÙ„Û’ ÛÛŒ Ø¬Ù…Ø¹ ÛÙˆ Ú†Ú©ÛŒ ÛÛ’Û” Ú©ÙˆØ¦ÛŒ ØªØ¨Ø¯ÛŒÙ„ÛŒ Ø¯Ø±Ú©Ø§Ø± ÛÙˆ ØªÙˆ Ø§Ù¾Ù†Û’ ØªØ¹Ù„ÛŒÙ…ÛŒ Ø°Ù…Û Ø¯Ø§Ø± Ø³Û’ Ø±Ø§Ø¨Ø·Û ÙØ±Ù…Ø§Ø¦ÛŒÚºÛ”');
    }

    // ===== SUBMISSION (UPDATED: Only Submit Unlocked Cards) =====
    async function submitReport(jamiaId, activeYear, monthIndex, year) {
        const periodsList = document.getElementById('periods-list');
        const submitBtn   = document.getElementById('submit-btn');
        const formMessage = document.getElementById('form-message');

        if (!selectedTeacherData) {
            alert('Ù¾ÛÙ„Û’ Ø§Ù¾Ù†Ø§ ØµØ­ÛŒØ­ Ù¹ÛŒÚ†Ø± Ú©ÙˆÚˆ Ø¯Ø±Ø¬ Ú©Ø± Ú©Û’ ØªØµØ¯ÛŒÙ‚ Ú©Ø±ÛŒÚºÛ”');
            return;
        }

        // Sirf wo inputs uthayen jo READ-ONLY nahi hain (Yani jo abhi bhare gaye hain)
        const inputs = Array.from(periodsList.querySelectorAll('.pages-taught-input')).filter(input => !input.readOnly);
        
        if (inputs.length === 0) {
            alert('Ú©ÙˆØ¦ÛŒ Ù†ÛŒØ§ ÚˆÛŒÙ¹Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº ÛÛ’Û” ØªÙ…Ø§Ù… Ù¾ÛŒØ±ÛŒÚˆØ² Ù¾ÛÙ„Û’ ÛÛŒ Ø¬Ù…Ø¹ ÛÙˆ Ú†Ú©Û’ ÛÛŒÚºÛ”');
            return;
        }

        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø³Ø¨Ù…Ù¹ ÛÙˆ Ø±ÛÛŒ ÛÛ’â€¦';

            const submissionBatch = [];

            // Loop sirf unlocked inputs par
            inputs.forEach(input => {
                const rowId       = input.dataset.rowId;
                const pagesTaught = parseInt(input.value || '', 10); // Check empty string
                const lastTextInp = periodsList.querySelector(`.last-lesson-input[data-row-id="${rowId}"]`);
                const lastPageInp = periodsList.querySelector(`.page-number-input[data-row-id="${rowId}"]`);
                
                const lastText = lastTextInp?.value.trim();
                const lastPageNo = parseInt(lastPageInp?.value || '0', 10);

                // Validation: Agar user ne aadha card bhara hai to error dein
                if (input.value === '' || isNaN(pagesTaught) || pagesTaught < 0) {
                    throw new Error("Ø¬Ùˆ Ú©Ø§Ø±Úˆ Ø¢Ù¾ Ø¨Ú¾Ø± Ø±ÛÛ’ ÛÛŒÚºØŒ Ø§Ø³ Ù…ÛŒÚº 'ØµÙØ­Û Ù¾Ú‘Ú¾Ø§ÛŒØ§' Ø¯Ø±Ø³Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”");
                }
                if (!lastText) {
                    throw new Error("Ø¬Ùˆ Ú©Ø§Ø±Úˆ Ø¢Ù¾ Ø¨Ú¾Ø± Ø±ÛÛ’ ÛÛŒÚºØŒ Ø§Ø³ Ù…ÛŒÚº 'Ø³Ø¨Ù‚ Ú©ÛŒ Ø¢Ø®Ø±ÛŒ Ø¹Ø¨Ø§Ø±Øª' Ù„Ø§Ø²Ù…Ø§Ù‹ Ù„Ú©Ú¾ÛŒÚºÛ”");
                }
                if (isNaN(lastPageNo) || lastPageNo < 0) {
                    throw new Error("Ø¬Ùˆ Ú©Ø§Ø±Úˆ Ø¢Ù¾ Ø¨Ú¾Ø± Ø±ÛÛ’ ÛÛŒÚºØŒ Ø§Ø³ Ù…ÛŒÚº 'ØµÙØ­Û Ù†Ù…Ø¨Ø±' Ø¯Ø±Ø³Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”");
                }

                submissionBatch.push({
                    jamiaId: decodeURIComponent(jamiaId),
                    teacherId: selectedTeacherData.id,
                    teacherName: selectedTeacherData.name,
                    periodId: input.dataset.periodId,
                    className: input.dataset.className,
                    bookName: input.dataset.bookName,
                    pagesTaught: pagesTaught,
                    lastIbarat: lastText,
                    lastPageNo: lastPageNo,
                    submissionMonth: monthIndex,
                    submissionYear: year,
                    activeYear: activeYear,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            const batch = db.batch();
            const submissionsRef = db.collection('teacher_submissions');

            submissionBatch.forEach(data => {
                const docRef = submissionsRef.doc();
                batch.set(docRef, data);
            });

            await batch.commit();

            formMessage.textContent = 'âœ… Ù…Ù†ØªØ®Ø¨ Ù¾ÛŒØ±ÛŒÚˆØ² Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø¬Ù…Ø¹ ÛÙˆ Ú¯Ø¦Û’Û”';
            formMessage.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700 text-sm sm:text-base';
            formMessage.classList.remove('hidden');

            // Form ko dobara reload karein taake naya data LOCK ho jaye
            checkExistingSubmissionForTeacher(decodeURIComponent(jamiaId), selectedTeacherData.id, monthIndex, year);

        } catch (error) {
            console.error("Submission Error:", error);
            alert(`Error: ${error.message}`);
            formMessage.textContent = `âŒ Ø®Ø±Ø§Ø¨ÛŒ: ${error.message}`;
            formMessage.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700 text-sm sm:text-base';
            formMessage.classList.remove('hidden');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-upload ml-2"></i> Ù…Ø§ÛØ§Ù†Û ØªØ¹Ù„ÛŒÙ…ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ Ø¬Ù…Ø¹ Ú©Ø±ÛŒÚº';
        }
    }
    // basic HTML-escape helper (keep only one copy in file)
function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}
    // --- EXIT CONFIRMATION ---
    window.addEventListener('beforeunload', (e) => {
        // Agar form open hai aur abhi poora lock nahi hua (matlab kaam baki hai)
        const periodsSection = document.getElementById('periods-section');
        const isHidden = periodsSection.classList.contains('hidden');
        
        // Agar form dikh raha hai (yani submit nahi hua poora), to warning dein
        if (!isHidden) {
            e.preventDefault();
            e.returnValue = ''; // Standard browser popup trigger karega
        }
    });
    // --- SHOW PROFILE (Month-wise Breakdown) ---
    async function renderTeacherSemesterProfile(jamiaName, teacherId, currentYear) {
        const profileView = document.getElementById('teacher-profile-view');
        // Hum table structure JS se banayenge kyunki columns dynamic hain
        const tableContainer = profileView.querySelector('.overflow-x-auto');
        
        // Loader dikhayen
        tableContainer.innerHTML = '<p class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Ù¾Ø±ÙˆÙØ§Ø¦Ù„ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛÛŒ ÛÛ’...</p>';
        profileView.classList.remove('hidden');

        try {
            // 1. Semester & Months Determine Karein
            const mIndex = currentMonthIndex;
            let semMonths = [];
            let semTotalDays = 0;
            const isSem1 = (mIndex >= 3 && mIndex <= 7); // Apr-Aug

            if (isSem1) {
                semMonths = [3, 4, 5, 6, 7]; // Apr, May, Jun, Jul, Aug
                semTotalDays = parseInt(currentYearData.sem1TotalDays || 0, 10);
            } else {
                semMonths = [8, 9, 10, 11, 0]; // Sep, Oct, Nov, Dec, Jan
                semTotalDays = parseInt(currentYearData.sem2TotalDays || 0, 10);
            }

            // 2. Database se Data Layen
            const submissionsRef = db.collection('teacher_submissions');
            const q = submissionsRef
                .where('jamiaId', '==', jamiaName)
                .where('teacherId', '==', teacherId);
                
            const snap = await q.get();
            
            // Data Map: periodId -> monthIndex -> pagesTaught
            const dataMap = {}; 

            snap.forEach(doc => {
                const d = doc.data();
                // Filter Ghost Data
                if (d.role === 'user_update' && parseInt(d.pagesTaught) === 0 && (!d.lastIbarat || !d.lastIbarat.trim())) return;
                
                if (!dataMap[d.periodId]) dataMap[d.periodId] = {};
                
                // Agar teacher ne multiple baar bheja to sum karein
                if (!dataMap[d.periodId][d.submissionMonth]) dataMap[d.periodId][d.submissionMonth] = 0;
                dataMap[d.periodId][d.submissionMonth] += parseInt(d.pagesTaught || 0, 10);
            });

            // 3. Teacher Structure (Total Pages)
            const teacherStruct = currentJamiaData.teachers.find(t => t.id === teacherId);
            if (!teacherStruct) return;

            // 4. Table HTML Construct Karein
            let tableHtml = `
                <table class="w-full text-sm border border-gray-300 text-center whitespace-nowrap">
                    <thead class="bg-emerald-100 text-emerald-900">
                        <tr>
                            <th class="p-2 border border-emerald-300" rowspan="2" style="position:sticky; right:0; background:#d1fae5; z-index:10;">Ú©ØªØ§Ø¨ / Ú©Ù„Ø§Ø³</th>
            `;

            // Dynamic Month Headers
            semMonths.forEach(m => {
                const mName = getMonthNameUrdu(m);
                tableHtml += `<th class="p-2 border border-emerald-300" colspan="2">${mName}</th>`;
            });

            // Final Summary Headers
            tableHtml += `
                            <th class="p-2 border border-emerald-300 bg-blue-100" colspan="3">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ</th>
                        </tr>
                        <tr class="text-xs">
            `;

            // Month Sub-headers
            semMonths.forEach(() => {
                tableHtml += `<th class="p-1 border border-emerald-300 text-gray-600">ÛØ¯Ù</th>
                              <th class="p-1 border border-emerald-300 text-emerald-700 font-bold">Ù¾Ú‘Ú¾Ø§ÛŒØ§</th>`;
            });

            // Summary Sub-headers
            tableHtml += `
                            <th class="p-1 border border-emerald-300 bg-blue-50">Ú©Ù„ ØµÙØ­Ø§Øª</th>
                            <th class="p-1 border border-emerald-300 bg-blue-50">Ú©Ù„ Ù¾Ú‘Ú¾Ø§ÛŒØ§</th>
                            <th class="p-1 border border-emerald-300 bg-blue-50 text-red-600">Ø¨Ù‚ÛŒÛ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
            `;

            // 5. Rows Generate Karein
            let hasRows = false;
            teacherStruct.periods.forEach(p => {
                const pSem = p.semester || "1";
                const isCurrentSemPeriod = (isSem1 && pSem == "1") || (!isSem1 && pSem == "2");
                
                if (isCurrentSemPeriod) {
                    hasRows = true;
                    const totalBookPages = parseInt(p.totalPages || 0, 10);
                    let rowCumulativeTaught = 0;

                    tableHtml += `<tr class="hover:bg-gray-50">
                        <td class="p-2 border urdu-font text-right font-medium" style="position:sticky; right:0; background:white; z-index:5;">
                            ${p.bookName} <br><span class="text-xs text-gray-500">(${p.className})</span>
                        </td>`;

                    // Loop through each month of the semester
                    semMonths.forEach(m => {
                        // Calculate Monthly Target
                        const academicMonths = currentYearData.academicMonths || {};
                        const workingDays = academicMonths[m] || 0;
                        let monthlyTarget = 0;
                        
                        if (semTotalDays > 0 && workingDays > 0 && totalBookPages > 0) {
                            const perDayTarget = totalBookPages / semTotalDays;
                            monthlyTarget = Math.round(perDayTarget * workingDays);
                        }

                        // Get Taught Data
                        const taught = (dataMap[p.id] && dataMap[p.id][m]) ? dataMap[p.id][m] : 0;
                        rowCumulativeTaught += taught;

                        // Color Logic for Taught
                        let taughtColor = "text-gray-400"; // 0
                        if (taught > 0) {
                            if(taught >= monthlyTarget) taughtColor = "text-green-600 font-bold";
                            else taughtColor = "text-red-500 font-bold";
                        }

                        tableHtml += `
                            <td class="p-2 border text-gray-500 bg-gray-50">${monthlyTarget}</td>
                            <td class="p-2 border ${taughtColor}">${taught > 0 ? taught : '-'}</td>
                        `;
                    });

                    // Summary Columns
                    const remaining = totalBookPages - rowCumulativeTaught;
                    let remColor = "text-gray-800";
                    if (remaining <= 0) remColor = "text-green-600 font-bold"; 
                    else if (remaining < (totalBookPages * 0.2)) remColor = "text-yellow-600 font-bold"; // Less than 20% left

                    tableHtml += `
                        <td class="p-2 border font-semibold bg-blue-50">${totalBookPages}</td>
                        <td class="p-2 border font-bold text-blue-700 bg-blue-50">${rowCumulativeTaught}</td>
                        <td class="p-2 border ${remColor} bg-blue-50" dir="ltr">${remaining}</td>
                    </tr>`;
                }
            });

            tableHtml += `</tbody></table>`;

            if (!hasRows) {
                tableContainer.innerHTML = '<p class="text-center p-4 text-red-500">Ø§Ø³ Ø³Ù…Ø³Ù¹Ø± Ú©Ø§ Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº Ù…Ù„Ø§Û”</p>';
            } else {
                tableContainer.innerHTML = tableHtml;
            }

        } catch (error) {
            console.error("Profile Error:", error);
            tableContainer.innerHTML = `<p class="text-center p-4 text-red-600">Ù¾Ø±ÙˆÙØ§Ø¦Ù„ Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ: ${error.message}</p>`;
        }
    }
    function getMonthNameUrdu(index) {
        const urduMonths = [
            "Ø¬Ù†ÙˆØ±ÛŒ", "ÙØ±ÙˆØ±ÛŒ", "Ù…Ø§Ø±Ú†", "Ø§Ù¾Ø±ÛŒÙ„", "Ù…Ø¦ÛŒ", "Ø¬ÙˆÙ†",
            "Ø¬ÙˆÙ„Ø§Ø¦ÛŒ", "Ø§Ú¯Ø³Øª", "Ø³ØªÙ…Ø¨Ø±", "Ø§Ú©ØªÙˆØ¨Ø±", "Ù†ÙˆÙ…Ø¨Ø±", "Ø¯Ø³Ù…Ø¨Ø±"
        ];
        return urduMonths[index] || "";
    }
</script>
</body>
</html>

















