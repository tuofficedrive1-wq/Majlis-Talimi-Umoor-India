<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ماہانہ تعلیمی کارکردگی</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Jameel Noori Nastaleeq font -->
    <link href="https://fonts.cdnfonts.com/css/jameel-noori-nastaleeq" rel="stylesheet"/>

    <style>
        body {
            font-family: 'Jameel Noori Nastaleeq', serif !important;
        }

        h1, h2, h3, p, label, select, input, th, td, button {
            font-family: 'Jameel Noori Nastaleeq', serif !important;
        }
    </style>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFg0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        firebase.initializeApp(firebaseConfig);
        const db   = firebase.firestore();
        const auth = firebase.auth();

        // Anonymous sign-in
        auth.signInAnonymously().catch(err => {
            console.error("Anonymous auth error:", err);
        });
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 text-base sm:text-lg">

<div id="loading-spinner" class="text-center">
    <i class="fas fa-spinner fa-spin text-emerald-600 text-3xl"></i>
    <p class="mt-2 text-gray-700">ڈیٹا لوڈ ہو رہا ہے…</p>
</div>

<div id="report-form-container"
     class="bg-white p-4 sm:p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-3xl hidden">

    <!-- Heading / Subheading -->
    <h1 class="text-2xl sm:text-3xl font-bold text-center text-emerald-700 mb-1">
        ماہانہ تعلیمی کارکردگی
    </h1>
    <p class="text-center text-gray-600 mb-5 sm:mb-6">
        مجلس تعلیمی امور ہند
    </p>

    <div class="mb-4 sm:mb-6 p-3 bg-emerald-50 border-r-4 border-emerald-500 text-emerald-800 text-right rounded-lg">
        <p id="jamia-display" class="font-semibold">جامعہ: لوڈ ہو رہا ہے…</p>
        <p id="report-month-display" class="text-xs sm:text-sm mt-1">رپورٹ برائے: لوڈ ہو رہا ہے…</p>
    </div>

    <form id="teacher-report-form" class="text-right">
        <!-- TEACHER SELECT -->
        <div class="mb-4 sm:mb-6">
            <label for="teacher-select" class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base">
                ۱۔ اپنا نام منتخب کریں:
            </label>
            <select id="teacher-select"
                    class="w-full p-2.5 sm:p-3 border border-gray-300 rounded-lg
                           focus:ring-emerald-500 focus:border-emerald-500 bg-white text-right text-sm sm:text-base"
                    required>
                <option value="" disabled selected>۔۔۔ نام منتخب کریں ۔۔۔</option>
            </select>
        </div>

        <!-- PERIODS SECTION (NO HORIZONTAL SCROLL) -->
        <div id="periods-section" class="mb-6 sm:mb-8 hidden">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">
                ۲۔ پڑھائے گئے صفحات (ہر کلاس / کتاب کے لیے)
            </h2>
            <div id="periods-list" class="space-y-4"></div>
        </div>

        <!-- SUBMIT BUTTON -->
        <div id="submit-button-area" class="text-center hidden">
            <button type="submit" id="submit-btn"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold
                           py-2.5 sm:py-3 px-8 rounded-lg transition duration-150 shadow-md text-base sm:text-lg">
                <i class="fas fa-upload ml-2"></i> ماہانہ تعلیمی کارکردگی جمع کریں
            </button>
        </div>

        <div id="form-message"
             class="mt-4 p-3 rounded-lg text-center hidden text-sm sm:text-base"></div>
    </form>
</div>

<script>
    let selectedTeacherData = null;

    document.addEventListener('DOMContentLoaded', () => {
        const loadingSpinner = document.getElementById('loading-spinner');

        const urlParams   = new URLSearchParams(window.location.search);
        const jamiaId     = urlParams.get('jamiaId');   // encoded
        const userId      = urlParams.get('userId');    // dashboard user UID
        const activeYear  = urlParams.get('activeYear');
        const monthIndexQ = urlParams.get('monthIndex');
        const reportYearQ = urlParams.get('reportYear');

        if (!jamiaId || !userId || !activeYear) {
            loadingSpinner.innerHTML =
                '<p class="text-red-600 font-bold">Error: رپورٹنگ لنک درست نہیں ہے (جامعہ، یوزر یا سال missing ہے)</p>';
            return;
        }

        // Month/year decide
        let monthIndex, reportYear;
        if (monthIndexQ !== null && reportYearQ !== null) {
            monthIndex = parseInt(monthIndexQ, 10);
            reportYear = parseInt(reportYearQ, 10);
        } else {
            const today = new Date();
            monthIndex = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
            reportYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
        }

        const monthName = new Date(reportYear, monthIndex)
            .toLocaleString('en-US', {month: 'long'});

        document.getElementById('jamia-display').textContent =
            `جامعہ: ${decodeURIComponent(jamiaId)}`;
        document.getElementById('report-month-display').textContent =
            `رپورٹ برائے: ${monthName} ${reportYear}`;

        // Data load
        loadJamiaData(jamiaId, userId, activeYear, monthIndex, reportYear);

        // Submit handler
        document.getElementById('teacher-report-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitReport(jamiaId, activeYear, monthIndex, reportYear);
        });
    });

    // ===== DATA FETCHING =====
    async function loadJamiaData(jamia, userId, year, monthIndex, currentYear) {
        const loadingSpinner = document.getElementById('loading-spinner');
        const formContainer  = document.getElementById('report-form-container');
        const teacherSelect  = document.getElementById('teacher-select');

        try {
            const userRef  = db.collection('users').doc(userId);
            const userSnap = await userRef.get();

            if (!userSnap.exists) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">User کا ڈیٹا نہیں ملا (users collection).</p>';
                return;
            }

            const userData      = userSnap.data();
            const academicYears = userData.academicYears || {};
            const yearData      = academicYears[year];

            if (!yearData || !Array.isArray(yearData.karkardagiStructure)) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">اس سال کے لیے کارکردگی کا اسٹرکچر موجود نہیں ہے۔</p>';
                return;
            }

            const structure        = yearData.karkardagiStructure;
            const jamiaNameDecoded = decodeURIComponent(jamia);

            const jamiaData = structure.find(j => j.jamiaName === jamiaNameDecoded);

            if (!jamiaData || !Array.isArray(jamiaData.teachers) || jamiaData.teachers.length === 0) {
                loadingSpinner.innerHTML =
                    '<p class="text-red-600 font-bold">اس جامعہ کے اساتذہ کا اسٹرکچر سیٹ نہیں ہے۔</p>';
                return;
            }

            // Teachers dropdown
            jamiaData.teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                teacherSelect.appendChild(option);
            });

            loadingSpinner.classList.add('hidden');
            formContainer.classList.remove('hidden');

            // Teacher change par periods load
            teacherSelect.addEventListener('change', (e) => {
                loadTeacherPeriods(e.target.value, jamiaData.teachers);
            });

        } catch (error) {
            console.error("Error loading Jamia data:", error);
            loadingSpinner.innerHTML =
                `<p class="text-red-600 font-bold">ڈیٹا لوڈ کرتے وقت خرابی: ${error.message}</p>`;
        }
    }

    // ===== PERIODS (MOBILE-FRIENDLY CARDS) =====
    function loadTeacherPeriods(teacherId, allTeachers) {
        const periodsList     = document.getElementById('periods-list');
        const periodsSection  = document.getElementById('periods-section');
        const submitButtonArea = document.getElementById('submit-button-area');

        periodsList.innerHTML = '';

        const teacher = allTeachers.find(t => t.id === teacherId);

        if (!teacher || !Array.isArray(teacher.periods) || teacher.periods.length === 0) {
            periodsList.innerHTML =
                '<p class="text-center py-4 text-gray-500 text-sm sm:text-base">اس استاد کے لیے کوئی پیریڈ سیٹ نہیں ہے۔</p>';
            periodsSection.classList.remove('hidden');
            submitButtonArea.classList.add('hidden');
            return;
        }

        selectedTeacherData = teacher;

        teacher.periods.forEach(period => {
            const className = period.className || 'کلاس';
            const bookName  = period.bookName  || 'کتاب';

            const card = document.createElement('div');
            card.className = 'bg-gray-50 border border-gray-200 rounded-xl p-3 sm:p-4 shadow-sm';

            card.innerHTML = `
                <div class="mb-2 text-sm sm:text-base font-semibold text-emerald-700">
                    کلاس / کتاب: ${className} (${bookName})
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">صفحہ پڑھایا</label>
                        <input type="number"
                               data-row-id="${period.id}"
                               data-period-id="${period.id}"
                               data-class-name="${className}"
                               data-book-name="${bookName}"
                               class="pages-taught-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-center focus:border-emerald-500"
                               min="0"
                               placeholder="صفحہ"
                               required>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">سبق کی آخری عبارت</label>
                        <input type="text"
                               data-row-id="${period.id}"
                               class="last-lesson-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm focus:border-emerald-500"
                               placeholder="آخری عبارت"
                               required>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm mb-1">صفحہ نمبر</label>
                        <input type="number"
                               data-row-id="${period.id}"
                               class="page-number-input w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-center focus:border-emerald-500"
                               min="0"
                               placeholder="صفحہ نمبر"
                               required>
                    </div>
                </div>
            `;

            periodsList.appendChild(card);
        });

        periodsSection.classList.remove('hidden');
        submitButtonArea.classList.remove('hidden');
    }

    // ===== SUBMISSION =====
    async function submitReport(jamiaId, activeYear, monthIndex, year) {
        const submitBtn   = document.getElementById('submit-btn');
        const formMessage = document.getElementById('form-message');

        submitBtn.disabled = true;
        submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin ml-2"></i> جمع ہو رہی ہے…';
        formMessage.classList.add('hidden');

        try {
            if (!selectedTeacherData) {
                throw new Error("پہلے اپنا نام منتخب کریں۔");
            }

            const pageInputs = document.querySelectorAll('.pages-taught-input');
            const submissionBatch = [];

            pageInputs.forEach(input => {
                const pagesTaught = parseInt(input.value, 10);
                const rowId       = input.dataset.rowId;

                const lastInput = document.querySelector(`.last-lesson-input[data-row-id="${rowId}"]`);
                const pageNoInp = document.querySelector(`.page-number-input[data-row-id="${rowId}"]`);

                const lastText   = lastInput ? lastInput.value.trim() : '';
                const lastPageNo = pageNoInp ? parseInt(pageNoInp.value, 10) : NaN;

                if (isNaN(pagesTaught) || pagesTaught < 0) {
                    throw new Error("ہر کارڈ میں درست 'صفحہ پڑھایا' درج کریں۔");
                }
                if (!lastText) {
                    throw new Error("ہر کارڈ میں 'سبق کی آخری عبارت' لازماً لکھیں۔");
                }
                if (isNaN(lastPageNo) || lastPageNo < 0) {
                    throw new Error("ہر کارڈ میں درست 'صفحہ نمبر' درج کریں۔");
                }

                submissionBatch.push({
                    jamiaId: decodeURIComponent(jamiaId),
                    teacherId: selectedTeacherData.id,
                    teacherName: selectedTeacherData.name,
                    periodId: input.dataset.periodId,
                    className: input.dataset.className,
                    bookName: input.dataset.bookName,
                    pagesTaught: pagesTaught,
                    lastIbarat: lastText,
                    lastPageNo: lastPageNo,
                    submissionMonth: monthIndex,
                    submissionYear: year,
                    activeYear: activeYear,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            if (submissionBatch.length === 0) {
                throw new Error("کوئی ڈیٹا سبمٹ نہیں ہو رہا۔");
            }

            const batch = db.batch();
            const submissionsRef = db.collection('teacher_submissions');

            submissionBatch.forEach(data => {
                const docRef = submissionsRef.doc();
                batch.set(docRef, data);
            });

            await batch.commit();

            formMessage.textContent =
                '✅ رپورٹ کامیابی کے ساتھ جمع ہو گئی، جزاکم اللہ خیراً!';
            formMessage.className =
                'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700 text-sm sm:text-base';
            formMessage.classList.remove('hidden');

            document.getElementById('periods-section').classList.add('hidden');
            document.getElementById('submit-button-area').classList.add('hidden');
            document.getElementById('teacher-select').disabled = true;

        } catch (error) {
            console.error("Submission Error:", error);
            formMessage.textContent =
                `❌ رپورٹ جمع نہیں ہو سکی: ${error.message}`;
            formMessage.className =
                'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700 text-sm sm:text-base';
            formMessage.classList.remove('hidden');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML =
                '<i class="fas fa-upload ml-2"></i> ماہانہ رپورٹ جمع کریں';
        }
    }
</script>
</body>
</html>

