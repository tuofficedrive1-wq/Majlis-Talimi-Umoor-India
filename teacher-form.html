<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jamia Teacher Reporting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f9fb;
        }

        /* Applying Nastaleeq to specific elements */
        .urdu-text {
            font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif;
            direction: rtl;
        }

        .submission-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Custom Checkbox Style for Better Visibility */
        .custom-checkbox:checked + .checkbox-label {
            background-color: #059669; /* emerald-600 */
            border-color: #059669;
        }
        .custom-checkbox:checked + .checkbox-label i {
            color: white;
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-2xl">
        
        <header class="text-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800 urdu-text">جامعہ کارکردگی رپورٹ فارم</h1>
            <p class="text-gray-500 mt-1">Jamia Teacher Performance Report Submission</p>
        </header>

        <div id="loader" class="hidden text-center my-8">
            <i class="fas fa-spinner fa-spin text-emerald-600 text-4xl"></i>
            <p class="mt-2 text-gray-600 urdu-text">ڈیٹا لوڈ ہو رہا ہے، انتظار فرمائیں...</p>
        </div>

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold urdu-text">خرابی:</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <div id="notification" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold urdu-text">کامیابی:</strong>
            <span class="block sm:inline" id="notification-text"></span>
        </div>

        <div id="success-message" class="hidden text-center my-10 p-6 bg-emerald-50 border-4 border-emerald-300 rounded-lg">
            <i class="fas fa-check-circle text-emerald-600 text-6xl"></i>
            <h2 class="text-2xl font-semibold mt-4 text-gray-800 urdu-text">رپورٹ کامیابی سے جمع کر دی گئی ہے۔</h2>
            <p class="text-gray-600 mt-2 urdu-text">آپ کا شکریہ۔ مزید کارکردگی رپورٹ اس ماہ کے لیے جمع نہیں کی جا سکتی۔</p>
            <button id="reset-button" type="button" class="mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">
                Submit Another Report
            </button>
        </div>

        <form id="submission-form" class="space-y-6">
            
            <div id="initial-load-info" class="mb-4">
                <p class="text-sm text-gray-500 urdu-text">موجودہ رپورٹنگ مدت: <span id="current-period" class="font-semibold text-gray-800"></span></p>
                <p class="text-sm text-gray-500 urdu-text">جامعہ ID: <span id="current-jamiaId" class="font-semibold text-gray-800"></span></p>
            </div>

            <div id="teacher-selection-section">
                <label for="teacher-select" class="block text-lg font-medium text-gray-700 urdu-text">اپنا نام منتخب کریں:</label>
                <select id="teacher-select" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-lg rounded-md urdu-text">
                    <option value="" disabled selected>--- براہ کرم منتخب کریں ---</option>
                </select>
            </div>

            <div id="karkardagi-section" class="hidden space-y-4">
                <h3 class="text-xl font-semibold text-gray-800 mt-6 pb-2 border-b urdu-text">کارکردگی کی مدیں (Karkardagi Items)</h3>
                </div>

            <div id="previous-submission-status" class="hidden submission-container">
                <h4 class="text-lg font-semibold text-gray-800 urdu-text mb-2">پہلے سے جمع شدہ رپورٹ</h4>
                <p class="text-gray-600 urdu-text" id="previous-status-text">آپ نے اس مہینے کے لیے پہلے ہی رپورٹ جمع کر دی ہے۔</p>
                <div id="previous-submission-details" class="mt-4">
                    </div>
            </div>

            <button id="submit-button" type="submit" class="w-full py-3 mt-6 bg-emerald-600 hover:bg-emerald-700 text-white font-bold text-xl rounded-lg shadow-lg transition duration-150 ease-in-out urdu-text disabled:opacity-50" disabled>
                رپورٹ جمع کریں (Submit Report)
            </button>
        </form>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIGURATION ---
        // REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

        // --- GLOBAL VARIABLES ---
        let jamiaId = '';
        let adminUserId = '';
        let activeYear = '';
        let reportingMonth = '';
        let reportingYear = '';
        let selectedTeacherId = '';

        let allAcademicYearsData = {};
        let currentYearData = {};
        let currentMonthData = {};
        let currentKarkardagiItems = [];

        // --- DOM ELEMENTS ---
        const loader = document.getElementById('loader');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const notificationDiv = document.getElementById('notification');
        const notificationTextSpan = document.getElementById('notification-text');
        const submissionForm = document.getElementById('submission-form');
        const teacherSelect = document.getElementById('teacher-select');
        const karkardagiSection = document.getElementById('karkardagi-section');
        const submitButton = document.getElementById('submit-button');
        const successMessage = document.getElementById('success-message');
        const previousSubmissionStatus = document.getElementById('previous-submission-status');
        const previousSubmissionDetails = document.getElementById('previous-submission-details');

        // --- UTILITY FUNCTIONS ---
        const showLoader = (show) => {
            loader.classList.toggle('hidden', !show);
            submissionForm.classList.toggle('hidden', show);
            errorMessageDiv.classList.add('hidden');
        };

        const showError = (message) => {
            errorTextSpan.innerHTML = message;
            errorMessageDiv.classList.remove('hidden');
            showLoader(false);
            submissionForm.classList.add('hidden'); // Hide form on critical error
        };

        const showNotification = (message, isError = false) => {
            notificationTextSpan.textContent = message;
            notificationDiv.classList.toggle('hidden', false);
            notificationDiv.classList.toggle('bg-red-100', isError);
            notificationDiv.classList.toggle('border-red-400', isError);
            notificationDiv.classList.toggle('text-red-700', isError);
            notificationDiv.classList.toggle('bg-green-100', !isError);
            notificationDiv.classList.toggle('border-green-400', !isError);
            notificationDiv.classList.toggle('text-green-700', !isError);
            setTimeout(() => {
                notificationDiv.classList.add('hidden');
            }, 5000);
        };

        const monthNames = [
            "جنوری", "فروری", "مارچ", "اپریل", "مئی", "جون", 
            "جولائی", "اگست", "ستمبر", "اکتوبر", "نومبر", "دسمبر"
        ];

        const getMonthName = (monthNumber) => {
            return monthNames[monthNumber - 1] || 'نامعلوم مہینہ';
        };

        // --- URL PARAMETER PARSING ---
        const parseUrlParams = () => {
            const params = new URLSearchParams(window.location.search);
            jamiaId = params.get('jamiaId');
            adminUserId = params.get('userId');
            activeYear = params.get('activeYear');
            
            if (!jamiaId || !adminUserId || !activeYear) {
                showError("Missing required parameters in the URL (jamiaId, userId, or activeYear). Please contact your administrator.");
                return false;
            }

            document.getElementById('current-jamiaId').textContent = jamiaId;
            return true;
        };

        // --- REPORTING PERIOD ---
        const determineReportingPeriod = () => {
             const today = new Date();
             // Reporting is for the previous month
             let reportDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
             
             reportingMonth = reportDate.getMonth() + 1; // 1-12
             reportingYear = reportDate.getFullYear().toString();
             
             const monthName = getMonthName(reportingMonth);
             document.getElementById('current-period').textContent = `${monthName} ${reportingYear} (${activeYear} Academic Year)`;
        };

        // --- DATA LOADING ---
        const loadAdminData = async () => {
             showLoader(true);
             try {
                const userDocRef = db.collection('users').doc(adminUserId);
                const userDocSnap = await userDocRef.get();
                
                if (!userDocSnap.exists) {
                    showError("Admin profile not found. The Admin ID in the URL is incorrect or the account was deleted.");
                    return false;
                }
                
                const adminData = userDocSnap.data();
                
                // Check for null/undefined before accessing nested properties
                if (!adminData || !adminData.academicYears) {
                     showError("Admin's data structure is incomplete or missing academicYears setup for the specified user.");
                     return false;
                }
                
                allAcademicYearsData = adminData.academicYears;

                // 1. Check Year Data
                currentYearData = allAcademicYearsData[activeYear];
                if (!currentYearData) {
                    showError(`Academic Year ${activeYear} data not found in Admin setup.`);
                    return false;
                }

                // 2. Check Jamia Data
                const jamiaData = currentYearData.jamiyaat ? currentYearData.jamiyaat[jamiaId] : null;
                if (!jamiaData || !jamiaData.teachers) {
                    showError(`Jamia ID '${jamiaId}' not found or missing teachers list in Admin setup.`);
                    return false;
                }

                // 3. Check Reporting Month Data
                const monthKey = `${reportingMonth}-${reportingYear}`;
                currentMonthData = jamiaData.monthlyReportStructure ? jamiaData.monthlyReportStructure[monthKey] : null;

                // 4. Load Karkardagi Items
                currentKarkardagiItems = currentMonthData ? currentMonthData.karkardagiItems || [] : [];
                if (currentKarkardagiItems.length === 0) {
                     showError(`Karkardagi items for ${monthKey} are not set up by the Admin for Jamia ${jamiaId}.`);
                     return false;
                }


                // 5. Populate Teacher Dropdown
                const teachers = jamiaData.teachers;
                teacherSelect.innerHTML = '<option value="" disabled selected>--- براہ کرم منتخب کریں ---</option>';
                Object.keys(teachers).sort().forEach(teacherId => {
                    const option = document.createElement('option');
                    option.value = teacherId;
                    option.textContent = teachers[teacherId].nameUrdu || teachers[teacherId].name;
                    teacherSelect.appendChild(option);
                });

                // Enable submit button
                submitButton.disabled = false;
                
                return true;

             } catch (error) {
                console.error("Admin data load failed:", error);
                
                let errorMessage = `Data load failed. Error: ${error.message}`;
                // Crucial Check for Permission Denied
                if (error.message && error.message.includes('permission_denied')) {
                   errorMessage = "Admin data could not be loaded due to **Permission Denied**. <br><br>Please inform the Admin to check the **Firebase Security Rules (Rule 3)**. The 'users' collection must allow **unauthenticated read** access.";
                }
                showError(errorMessage);
                return false;
             } finally {
                showLoader(false);
             }
        };


        // --- UI RENDERING ---
        const renderKarkardagiItems = () => {
            karkardagiSection.classList.remove('hidden');
            karkardagiSection.innerHTML = '<h3 class="text-xl font-semibold text-gray-800 mt-6 pb-2 border-b urdu-text">کارکردگی کی مدیں (Karkardagi Items)</h3>';

            currentKarkardagiItems.forEach((item, index) => {
                const itemId = `karkardagi-item-${index}`;
                const itemHtml = `
                    <div class="flex items-center space-x-3 rtl:space-x-reverse submission-container">
                        <input id="${itemId}" type="checkbox" name="karkardagi-item" value="${item.id}" class="hidden custom-checkbox">
                        <label for="${itemId}" class="checkbox-label w-6 h-6 border-2 border-gray-400 rounded flex items-center justify-center cursor-pointer transition duration-150 ease-in-out">
                            <i class="fas fa-check text-xs hidden"></i>
                        </label>
                        <label for="${itemId}" class="flex-1 text-lg font-medium text-gray-700 urdu-text cursor-pointer">${item.itemUrdu || item.item}</label>
                    </div>
                `;
                karkardagiSection.insertAdjacentHTML('beforeend', itemHtml);
            });

            // Add event listener for custom checkboxes
            document.querySelectorAll('.custom-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const label = e.target.nextElementSibling;
                    const checkIcon = label.querySelector('i');
                    if (e.target.checked) {
                        label.classList.add('bg-emerald-600', 'border-emerald-600');
                        checkIcon.classList.remove('hidden');
                    } else {
                        label.classList.remove('bg-emerald-600', 'border-emerald-600');
                        checkIcon.classList.add('hidden');
                    }
                });
            });
        };

        const renderPreviousSubmission = (submission) => {
             previousSubmissionStatus.classList.remove('hidden');
             submissionForm.classList.add('hidden');

             const teacherName = teacherSelect.options[teacherSelect.selectedIndex].textContent;
             document.getElementById('previous-status-text').innerHTML = `
                 استاد کا نام: <span class="font-semibold">${teacherName}</span><br>
                 جمع کرنے کی تاریخ: <span class="font-semibold">${new Date(submission.updatedAt.toDate()).toLocaleString()}</span>
             `;
             
             previousSubmissionDetails.innerHTML = '';

             if (submission.submissions && submission.submissions.length > 0) {
                 const ul = document.createElement('ul');
                 ul.className = 'list-disc list-inside space-y-1 urdu-text text-gray-700';
                 
                 const submittedIds = submission.submissions.map(s => s.id);
                 
                 currentKarkardagiItems.forEach(item => {
                     if (submittedIds.includes(item.id)) {
                         const li = document.createElement('li');
                         li.textContent = item.itemUrdu || item.item;
                         ul.appendChild(li);
                     }
                 });
                 previousSubmissionDetails.appendChild(ul);
             } else {
                 previousSubmissionDetails.innerHTML = '<p class="text-gray-500 urdu-text">کوئی کارکردگی مد منتخب نہیں کی گئی تھی۔</p>';
             }
        };

        const clearFormState = () => {
            karkardagiSection.classList.add('hidden');
            karkardagiSection.innerHTML = '';
            previousSubmissionStatus.classList.add('hidden');
            submissionForm.classList.remove('hidden');
            successMessage.classList.add('hidden');
            // Re-enable submit button if data load was successful
            if (currentKarkardagiItems.length > 0) {
                 submitButton.disabled = false;
            }
        };
        
        // --- PREVIOUS SUBMISSION CHECK ---
        const loadPreviousSubmission = async (teacherId) => {
             const docId = `${jamiaId}-${reportingYear}-${reportingMonth}`;
             const submissionsRef = db.collection('teacher_submissions').doc(docId);

             try {
                 const docSnap = await submissionsRef.get();
                 
                 if (docSnap.exists) {
                     const data = docSnap.data();
                     const teacherSubmission = data.teacherSubmissions ? data.teacherSubmissions[teacherId] : null;
                     
                     if (teacherSubmission) {
                         // Submission found for this teacher/month
                         renderPreviousSubmission(teacherSubmission);
                         return true;
                     }
                 }
                 return false;
             } catch (error) {
                // IMPORTANT: If Rule 2 is set to 'allow read: if false', this will fail.
                // We'll proceed assuming no previous submission if read fails due to auth.
                // This is a known risk for unauthenticated forms.
                console.warn("Could not check previous submission status. Assuming no previous submission or check failed:", error);
                return false; 
             }
        };

        // --- EVENT HANDLERS ---
        teacherSelect.addEventListener('change', async (e) => {
            selectedTeacherId = e.target.value;
            clearFormState(); // Reset UI state

            if (selectedTeacherId) {
                renderKarkardagiItems();
                // Check if a report was already submitted
                const hasSubmitted = await loadPreviousSubmission(selectedTeacherId);
                
                if (hasSubmitted) {
                    submissionForm.classList.add('hidden');
                } else {
                    submissionForm.classList.remove('hidden');
                }
            }
        });

        document.getElementById('reset-button').addEventListener('click', () => {
             // Reset form to initial state
             teacherSelect.value = '';
             clearFormState();
        });

        const handleSubmitReport = async (e) => {
            e.preventDefault();
            showLoader(true);
            
            const month = reportingMonth.toString();
            const yearNum = reportingYear;

            try {
                const docId = `${jamiaId}-${yearNum}-${month}`;
                const submissionsRef = db.collection('teacher_submissions').doc(docId);

                // Get selected items
                const selectedItems = Array.from(document.querySelectorAll('input[name="karkardagi-item"]:checked'))
                    .map(checkbox => {
                        // Find the corresponding item from the currentKarkardagiItems list
                        const itemData = currentKarkardagiItems.find(item => item.id === checkbox.value);
                        return {
                            id: checkbox.value,
                            itemUrdu: itemData ? itemData.itemUrdu : 'N/A',
                            item: itemData ? itemData.item : 'N/A',
                            timestamp: serverTimestamp()
                        };
                    });

                // Prepare data structure for a single teacher submission
                const teacherSubmissionData = {
                    submissions: selectedItems,
                    updatedAt: serverTimestamp()
                };

                // Use a nested map update to save only for the selected teacher
                const dataToSave = {
                    // This is the correct way to update a nested map field in Firestore
                    [`teacherSubmissions.${selectedTeacherId}`]: teacherSubmissionData,
                    // Metadata for the main document
                    jamiaId: jamiaId,
                    adminUserId: adminUserId,
                    activeYear: activeYear,
                    reportingMonth: month,
                    reportingYear: yearNum,
                    updatedAt: serverTimestamp()
                };

                // Use setDoc with { merge: true } to create the document if it doesn't exist 
                // and safely update the nested map entry without overwriting other teachers' data.
                await submissionsRef.set(dataToSave, { merge: true });
                
                successMessage.classList.remove('hidden');
                submissionForm.classList.add('hidden');
                showNotification("Report submitted successfully!", false);
                // Optionally, clear the form or reset the selection
                // teacherSelect.value = '';
                
            } catch (error) {
                console.error("Submission failed:", error);
                showError(`Submission Error: ${error.message}`);
            } finally {
                showLoader(false);
            }
        };

        // --- INIT APP ---\
        const initReportingApp = async () => {
             determineReportingPeriod();

             if (parseUrlParams()) {
                 const dataLoaded = await loadAdminData();
                 if (dataLoaded) {
                     // Initial state is loaded, now wait for teacher selection
                 }
             }
        };

        submissionForm.addEventListener('submit', handleSubmitReport);

        initReportingApp();
    </script>
</body>
</html>

