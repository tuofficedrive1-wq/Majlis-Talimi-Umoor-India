<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jamia Teacher Reporting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
             unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF, U+FE70-FEFF;
        }
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; font-size: 1.1rem; line-height: 1.6; }
        th, td { padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; text-align: left; vertical-align: middle; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #14b8a6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="notification" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform translate-x-full hidden"></div>

    <div id="loader" class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-50 flex justify-center items-center z-[70] hidden">
        <div class="loader"></div>
    </div>
    
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="bg-white shadow-md rounded-lg p-4 mb-8">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800 text-center">Teacher Karkardagi Submission</h1>
            <p class="text-center text-sm text-gray-500 mt-1">Please fill the pages taught for **<span id="header-jamia-name" class="font-medium">...</span>**</p>
        </header>

        <main id="reporting-form-view" class="bg-white p-4 md:p-8 rounded-xl shadow-lg space-y-6">
            
            <div id="error-message" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
            
            <div id="info-section" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="teacher-select" class="block text-sm font-medium text-gray-700">Select Teacher</label>
                    <select id="teacher-select" class="w-full p-2 border rounded-lg bg-white urdu-font" required>
                        <option value="">-- Please select a teacher --</option>
                    </select>
                </div>
                <div>
                     <label for="current-period-display" class="block text-sm font-medium text-gray-700">Reporting Period (Auto-set)</label>
                     <p id="current-period-display" class="p-2 border rounded-lg bg-gray-50 font-medium text-sm"></p>
                </div>
            </div>

            <form id="submission-form" class="space-y-4 hidden">
                <h3 class="text-lg font-semibold border-b pb-2">Periods for <span id="teacher-name-display"></span></h3>
                
                <div id="periods-table-container" class="overflow-x-auto border rounded-lg">
                     </div>
                
                <div class="flex justify-end pt-4">
                    <button type="submit" id="submit-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg">Submit Monthly Report</button>
                </div>
            </form>
            
            <div id="success-message" class="p-6 bg-green-100 border border-green-400 text-green-700 rounded-lg text-center hidden">
                <p class="font-bold text-lg mb-2">Report Submitted Successfully!</p>
                <p>Thank you for your submission.</p>
            </div>

        </main>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // --- CONFIGURATION (Must match karkardagi.html) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
          authDomain: "data-f15ab.firebaseapp.com",
          projectId: "data-f15ab",
          storageBucket: "data-f15ab.appspot.com", 
          messagingSenderId: "449137002393",
          appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
          measurementId: "G-1PHNJQWNPZ"
        };
        
        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const notification = document.getElementById('notification');
        const errorMessage = document.getElementById('error-message');
        const headerJamiaName = document.getElementById('header-jamia-name');
        const teacherSelect = document.getElementById('teacher-select');
        const submissionForm = document.getElementById('submission-form');
        const teacherNameDisplay = document.getElementById('teacher-name-display');
        const periodsTableContainer = document.getElementById('periods-table-container');
        const currentPeriodDisplay = document.getElementById('current-period-display');
        const successMessage = document.getElementById('success-message');
        const submitReportBtn = document.getElementById('submit-report-btn');


        // --- Application State ---
        let urlParams = {};
        let adminUserId = null;
        let jamiaId = null;
        let activeYear = null;
        let allAcademicYearsData = {};
        let jamiaStructure = null; 
        let currentReportingPeriod = {}; // { month, yearNum, monthNum, semester }
        let currentTeachersData = []; 

        // --- HELPER FUNCTIONS ---
        const showLoader = (show) => loader.classList.toggle('hidden', !show);
        const showNotification = (message, isError = false) => {
            console[isError ? 'error' : 'log']("Notification:", message); 
            notification.textContent = message;
            notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform ${isError ? 'bg-red-500' : 'bg-emerald-600'}`;
            notification.classList.remove('hidden', 'translate-x-full'); 
            void notification.offsetWidth; 
            setTimeout(() => notification.classList.remove('translate-x-full'), 10); 
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 5000); 
        };
        const showError = (message) => {
             errorMessage.textContent = message;
             errorMessage.classList.remove('hidden');
             submissionForm.classList.add('hidden');
        };
        
        const getTimestampFromId = (id) => {
             const parts = id.split('-');
             if (parts.length >= 2) {
                 return parseInt(parts[1], 10);
             }
             return 0;
        };

        const getSemesterMonthNumber = (monthNum, semester) => {
            const sem1Months = [3, 4, 5, 6, 7]; // April, May, June, July, August
            const sem2Months = [8, 9, 10, 11, 0]; // September, October, November, December, January
            
            const months = semester === "1" ? sem1Months : sem2Months;
            const index = months.indexOf(monthNum);
            
            if (index === -1) return null; // Month is not in this semester
            return index + 1;
        };

        const getMonthName = (monthNum) => {
            return new Date(2000, monthNum, 1).toLocaleString('default', { month: 'long' });
        };
        
        // Function to determine the current reporting period
        const determineReportingPeriod = () => {
             const now = new Date();
             const currentDay = now.getDate();
             let targetDate = now;
             
             // Grace period (report previous month until the 5th)
             if (currentDay >= 1 && currentDay <= 5) {
                 targetDate = new Date(now.getFullYear(), now.getMonth(), 0); 
             }
             
             const month = targetDate.toLocaleString('default', { month: 'long' });
             const yearNum = targetDate.getFullYear();
             const monthNum = targetDate.getMonth(); 
             
             const isSemester1 = monthNum >= 3 && monthNum <= 7;
             const semester = isSemester1 ? "1" : "2";
             
             currentReportingPeriod = { month, yearNum, monthNum, semester };
             currentPeriodDisplay.textContent = `${month} ${yearNum} (Semester ${semester} Reporting)`;
        };


        // --- MAIN DATA FLOW ---
        const parseUrlParams = () => {
            const urlSearchParams = new URLSearchParams(window.location.search);
            urlParams = Object.fromEntries(urlSearchParams.entries());
            jamiaId = urlParams.jamiaId ? decodeURIComponent(urlParams.jamiaId) : null;
            adminUserId = urlParams.userId || null;
            activeYear = urlParams.activeYear || null;

            if (!jamiaId || !adminUserId || !activeYear) {
                showError("Invalid link. Jamia ID, Admin ID, or Academic Year is missing in the URL.");
                return false;
            }
            return true;
        };
        
        const loadAdminData = async () => {
             showLoader(true);
             try {
                const userDocRef = doc(db, 'users', adminUserId);
                const userDocSnap = await getDoc(userDocRef);
                
                if (!userDocSnap.exists()) {
                    showError("Admin profile not found. Please check the link with the admin.");
                    return false;
                }
                
                const adminData = userDocSnap.data();
                allAcademicYearsData = adminData.academicYears || {};

                // 1. Check Year Data
                const yearData = allAcademicYearsData[activeYear];
                if (!yearData) {
                    showError(`Setup for academic year ${activeYear} not found.`);
                    return false;
                }
                
                // 2. Find Jamia Structure
                const karkardagiStructure = yearData.karkardagiStructure || [];
                jamiaStructure = karkardagiStructure.find(j => j.jamiaName === jamiaId);
                
                if (!jamiaStructure) {
                    showError(`Jamia '${jamiaId}' structure not found for year ${activeYear}.`);
                    return false;
                }
                
                currentTeachersData = jamiaStructure.teachers || [];
                if (currentTeachersData.length === 0) {
                     showError(`No teachers found for Jamia '${jamiaId}' in year ${activeYear}.`);
                     return false;
                }

                headerJamiaName.textContent = jamiaId;
                
                // Load Previous Submissions (Optional, but good for UX)
                await loadPreviousSubmission();
                
                populateTeacherSelect(currentTeachersData);
                return true;

             } catch (error) {
                 console.error("Error loading admin data:", error);
                 showError(`Data load error: ${error.message}`);
                 return false;
             } finally {
                 showLoader(false);
             }
        };

        let previousSubmissionData = {}; // Stores submission by periodId
        
        const loadPreviousSubmission = async () => {
            previousSubmissionData = {};
            const { yearNum, monthNum } = currentReportingPeriod;
            
            // Submissions are saved as teacher_submissions/JAMIA_YEAR_MONTH
            const submissionId = `${jamiaId}_${activeYear}_${yearNum}_${monthNum}`;
            const subDocRef = doc(db, 'teacher_submissions', submissionId);
            
            try {
                const subDocSnap = await getDoc(subDocRef);
                if (subDocSnap.exists()) {
                    const data = subDocSnap.data().submissions || [];
                    // Group by teacher and then by period
                    data.forEach(sub => {
                        if (!previousSubmissionData[sub.teacherId]) {
                            previousSubmissionData[sub.teacherId] = {};
                        }
                        // This allows quickly retrieving the pages taught for a specific period
                        previousSubmissionData[sub.teacherId][sub.periodId] = sub.pagesTaught; 
                    });
                    console.log("Previous submissions loaded for month/year:", previousSubmissionData);
                } else {
                    console.log("No previous submission found for this period.");
                }
            } catch (error) {
                console.error("Error loading previous submission:", error);
            }
        };


        const populateTeacherSelect = (teachers) => {
             teacherSelect.innerHTML = '<option value="">-- Please select a teacher --</option>' + teachers.map(t => 
                 `<option value="${t.id}" class="urdu-font">${t.name}</option>`
             ).join('');
             teacherSelect.addEventListener('change', handleTeacherSelect);
        };

        const handleTeacherSelect = (e) => {
            const selectedTeacherId = e.target.value;
            if (!selectedTeacherId) {
                submissionForm.classList.add('hidden');
                return;
            }

            const selectedTeacher = currentTeachersData.find(t => t.id === selectedTeacherId);
            if (!selectedTeacher || !selectedTeacher.periods || selectedTeacher.periods.length === 0) {
                periodsTableContainer.innerHTML = '<p class="p-4 text-red-500">Is teacher ke liye koi periods set nahi hain.</p>';
                submissionForm.classList.remove('hidden');
                teacherNameDisplay.textContent = selectedTeacher.name;
                submitReportBtn.classList.add('hidden');
                return;
            }
            
            // Filter periods by the current reporting semester
            const { semester: currentSemester, monthNum } = currentReportingPeriod; 
            const academicMonths = allAcademicYearsData[activeYear].academicMonths || {};
            const daysThisMonth = academicMonths[monthNum] || 0;
            const semesterDays = currentSemester === '1' ? allAcademicYearsData[activeYear].sem1TotalDays : allAcademicYearsData[activeYear].sem2TotalDays;
            
            if (daysThisMonth === 0 || semesterDays === 0) {
                 periodsTableContainer.innerHTML = `<p class="p-4 text-red-500">Academic days or Semester total days for this period are not set in the Admin's setup.</p>`;
                 submissionForm.classList.remove('hidden');
                 teacherNameDisplay.textContent = selectedTeacher.name;
                 submitReportBtn.classList.add('hidden');
                 return;
            }


            // Render Periods Table
            const tableHTML = renderPeriodsTable(selectedTeacher, currentSemester, daysThisMonth, semesterDays);
            periodsTableContainer.innerHTML = tableHTML;
            teacherNameDisplay.textContent = selectedTeacher.name;
            submissionForm.classList.remove('hidden');
            submitReportBtn.classList.remove('hidden');
            successMessage.classList.add('hidden');
        };

        const renderPeriodsTable = (teacher, currentSemester, daysThisMonth, semesterDays) => {
            const periods = teacher.periods
                .filter(p => p.semester === currentSemester) // Only show periods for the current semester
                .sort((a, b) => getTimestampFromId(a.id) - getTimestampFromId(b.id));

            if (periods.length === 0) {
                 return '<p class="p-4 text-yellow-700">Is teacher ke is semester ke liye koi periods set nahi hain.</p>';
            }

            let table = `
                <table class="min-w-full text-sm bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="urdu-font">Class</th>
                            <th class="urdu-font">Book</th>
                            <th>Total Pages (Sem)</th>
                            <th>Monthly Target</th>
                            <th>Pages Taught</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            periods.forEach(period => {
                const perDayTarget = period.totalPages / semesterDays;
                const monthlyTarget = Math.round(perDayTarget * daysThisMonth);
                
                // Load previous value for this period
                const previousValue = previousSubmissionData[teacher.id]?.[period.id] || '';

                table += `
                    <tr data-period-id="${period.id}" data-teacher-id="${teacher.id}" data-monthly-target="${monthlyTarget}">
                        <td class="urdu-font">${period.className}</td>
                        <td class="urdu-font">${period.bookName}</td>
                        <td>${period.totalPages}</td>
                        <td class="font-medium text-center">${monthlyTarget}</td>
                        <td>
                            <input type="number" class="pages-taught-input w-24 p-2 border rounded-lg text-center" 
                                   name="pages-taught-${period.id}" value="${previousValue}" min="0" required>
                        </td>
                    </tr>
                `;
            });
            table += '</tbody></table>';
            return table;
        };


        const handleSubmitReport = async (e) => {
            e.preventDefault();
            showLoader(true);
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            
            const selectedTeacherId = teacherSelect.value;
            const selectedTeacher = currentTeachersData.find(t => t.id === selectedTeacherId);

            if (!selectedTeacher) {
                showError("Please select a valid teacher.");
                showLoader(false);
                return;
            }
            
            const { month, yearNum, monthNum, semester } = currentReportingPeriod; 
            const submissionId = `${jamiaId}_${activeYear}_${yearNum}_${monthNum}`;
            const submissionsRef = doc(db, 'teacher_submissions', submissionId);
            
            const newSubmissionEntries = [];
            let allInputsValid = true;

            periodsTableContainer.querySelectorAll('tr[data-period-id]').forEach(row => {
                const pagesTaughtInput = row.querySelector('.pages-taught-input');
                const pagesTaught = parseInt(pagesTaughtInput.value, 10);
                const periodId = row.dataset.periodId;
                const monthlyTarget = parseInt(row.dataset.monthlyTarget, 10);

                if (isNaN(pagesTaught) || pagesTaught < 0) {
                    allInputsValid = false;
                    pagesTaughtInput.classList.add('border-red-500');
                    return;
                }
                
                let achievement = 0;
                if (pagesTaught > 0 && monthlyTarget > 0) {
                    achievement = Math.round((pagesTaught / monthlyTarget) * 100);
                }
                
                const entry = {
                    periodId: periodId,
                    teacherId: selectedTeacherId,
                    jamiaName: jamiaId,
                    activeYear: activeYear,
                    month: month,
                    year: yearNum,
                    semester: semester,
                    pagesTaught: pagesTaught,
                    monthlyTarget: monthlyTarget,
                    achievement: achievement
                };
                newSubmissionEntries.push(entry);
                pagesTaughtInput.classList.remove('border-red-500');
            });
            
            if (!allInputsValid) {
                showError("Please enter valid (non-negative) pages taught for all subjects.");
                showLoader(false);
                return;
            }

            if (newSubmissionEntries.length === 0) {
                showError("No valid periods found for submission.");
                showLoader(false);
                return;
            }

            try {
                // Update the document by merging new submission entries based on teacherId/periodId
                // Note: Firestore does not support array union for objects with different fields, 
                // so we fetch all existing data, update the relevant teacher's data, and save the whole array back.
                
                const subDocSnap = await getDoc(submissionsRef);
                let existingSubmissions = [];
                if (subDocSnap.exists()) {
                    existingSubmissions = subDocSnap.data().submissions || [];
                }
                
                // Filter out old entries for the selected teacher and merge new ones
                const updatedSubmissions = existingSubmissions
                    .filter(sub => sub.teacherId !== selectedTeacherId)
                    .concat(newSubmissionEntries);
                    
                const dataToSave = {
                    submissions: updatedSubmissions,
                    jamiaId: jamiaId,
                    adminUserId: adminUserId,
                    activeYear: activeYear,
                    reportingMonth: month,
                    reportingYear: yearNum,
                    updatedAt: serverTimestamp()
                };

                await setDoc(submissionsRef, dataToSave, { merge: true });
                
                successMessage.classList.remove('hidden');
                submissionForm.classList.add('hidden');
                showNotification("Report submitted successfully!", false);
                // Optionally, clear the form or reset the selection
                teacherSelect.value = '';
                
            } catch (error) {
                console.error("Submission failed:", error);
                showError(`Submission Error: ${error.message}`);
            } finally {
                showLoader(false);
            }
        };

        // --- INIT APP ---
        const initReportingApp = async () => {
             determineReportingPeriod();

             if (parseUrlParams()) {
                 const dataLoaded = await loadAdminData();
                 if (dataLoaded) {
                     // Initial state is loaded, now wait for teacher selection
                 }
             }
        };

        submissionForm.addEventListener('submit', handleSubmitReport);

        initReportingApp();
    </script>
</body>
</html>
