<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karkardagi Report Submission</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // ***********************************************
        //  APNA ASLI FIREBASE CONFIG YAHAN DAALEIN
        // ***********************************************
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="loading-spinner" class="text-center">
        <i class="fas fa-spinner fa-spin text-emerald-600 text-3xl"></i>
        <p class="mt-2 text-gray-600">Loading Data...</p>
    </div>

    <div id="report-form-container" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl hidden">
        <h1 class="text-3xl font-bold text-center text-emerald-700 mb-6">üìö Karkardagi Report Submission</h1>
        
        <div class="mb-6 p-3 bg-emerald-50 border-l-4 border-emerald-500 text-emerald-800 font-semibold">
            <p id="jamia-display">Jamia: Loading...</p>
            <p id="report-month-display" class="text-sm">Report For: Loading...</p>
        </div>

        <form id="teacher-report-form">
            
            <div class="mb-6">
                <label for="teacher-select" class="block text-gray-700 font-semibold mb-2">1. Apna Naam Select Karein:</label>
                <select id="teacher-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 bg-white" required>
                    <option value="" disabled selected>--- Naam Chunein ---</option>
                </select>
            </div>

            <div id="periods-table-container" class="mb-8 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">2. Mahana Pages Taught (Har Class Ke Liye)</h2>
                <div class="overflow-x-auto bg-gray-50 p-4 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Class/Book</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Monthly Target</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-40">Pages Taught</th>
                            </tr>
                        </thead>
                        <tbody id="periods-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="submit-button-area" class="text-center hidden">
                <button type="submit" id="submit-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150 shadow-md">
                    <i class="fas fa-upload mr-2"></i> Submit Monthly Report
                </button>
            </div>
            
            <div id="form-message" class="mt-4 p-3 rounded-lg text-center hidden"></div>
        </form>
    </div>

    <script>
        let selectedTeacherData = null; // Submission ke liye data store karega

        document.addEventListener('DOMContentLoaded', () => {
            const loadingSpinner = document.getElementById('loading-spinner');
            const formContainer = document.getElementById('report-form-container');
            const teacherSelect = document.getElementById('teacher-select');
            
            const urlParams = new URLSearchParams(window.location.search);
            const jamiaId = urlParams.get('jamiaId');
            const activeYear = urlParams.get('activeYear'); // Active year bhi URL se aana zaroori hai

            if (!jamiaId || !activeYear) {
                loadingSpinner.innerHTML = '<p class="text-red-600 font-bold">Error: Ghalat Reporting Link. Sahi link istemal karein.</p>';
                return;
            }

            // Report ka mahina pichla mahina hoga
            const today = new Date();
            const currentMonthIndex = today.getMonth() === 0 ? 11 : today.getMonth() - 1; // 0=Jan, 11=Dec. Pichla mahina.
            const currentYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
            const monthName = new Date(currentYear, currentMonthIndex).toLocaleString('en-US', { month: 'long' });

            document.getElementById('jamia-display').textContent = `Jamia: ${decodeURIComponent(jamiaId)}`;
            document.getElementById('report-month-display').textContent = `Report For: ${monthName} ${currentYear}`;
            
            loadJamiaData(jamiaId, activeYear, currentMonthIndex, currentYear);

            // Submission handler
            document.getElementById('teacher-report-form').addEventListener('submit', (e) => {
                e.preventDefault();
                submitReport(jamiaId, activeYear, currentMonthIndex, currentYear);
            });
        });

        // =======================================================
        //  DATA FETCHING LOGIC
        // =======================================================

        async function loadJamiaData(jamia, year, monthIndex, currentYear) {
            const loadingSpinner = document.getElementById('loading-spinner');
            const formContainer = document.getElementById('report-form-container');
            const teacherSelect = document.getElementById('teacher-select');

            try {
                // *** IMPORTANT ***
                // HUM MANN KAR CHAL RAHE HAIN KI AAPKA 'karkardagiStructure' DATA IS PATH PAR HAI:
                // karkardagiStructure/[activeYear]
                // Agar aapka data user ke specific path par hai (users/[userID]/...) toh aapko
                // is form mein bhi user authentication (login) zaroori hoga.

                const structureRef = db.collection('karkardagiStructure').doc(year); 
                const doc = await structureRef.get();
                
                if (!doc.exists || !doc.data().structure) {
                    loadingSpinner.innerHTML = '<p class="text-red-600 font-bold">Structure data is saal ke liye nahi mila.</p>';
                    return;
                }
                
                const structure = doc.data().structure; 
                const jamiaData = structure.find(j => j.name === decodeURIComponent(jamia));

                if (!jamiaData || !jamiaData.teachers) {
                    loadingSpinner.innerHTML = '<p class="text-red-600 font-bold">Is Jamia ka koi Teacher data nahi mila.</p>';
                    return;
                }

                // Teachers Dropdown Mein Bharna
                jamiaData.teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id; // Teacher ki unique ID
                    option.textContent = teacher.name;
                    teacherSelect.appendChild(option);
                });
                
                // Success: Form dikhana
                loadingSpinner.classList.add('hidden');
                formContainer.classList.remove('hidden');

                // Dropdown change hone par periods load karna
                teacherSelect.addEventListener('change', (e) => {
                    loadTeacherPeriods(e.target.value, jamiaData.teachers);
                });

            } catch (error) {
                console.error("Error loading Jamia data:", error);
                loadingSpinner.innerHTML = `<p class="text-red-600 font-bold">Data load karte waqt error: ${error.message}</p>`;
            }
        }

        // =======================================================
        //  PERIODS DISPLAY LOGIC
        // =======================================================

        const loadTeacherPeriods = (teacherId, allTeachers) => {
            const periodsTableBody = document.getElementById('periods-table-body');
            const periodsTableContainer = document.getElementById('periods-table-container');
            const submitButtonArea = document.getElementById('submit-button-area');
            periodsTableBody.innerHTML = '';
            
            const teacher = allTeachers.find(t => t.id === teacherId);

            if (!teacher || !teacher.periods || teacher.periods.length === 0) {
                periodsTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Is teacher ke koi periods set nahi hain.</td></tr>';
                periodsTableContainer.classList.remove('hidden');
                submitButtonArea.classList.add('hidden');
                return;
            }
            
            selectedTeacherData = teacher;
            
            teacher.periods.forEach(period => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${period.class} (${period.book})</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-500">${period.monthlyTarget || 'N/A'}</td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <input type="number" 
                               data-period-id="${period.id}"
                               data-class-name="${period.class}"
                               data-book-name="${period.book}"
                               class="pages-taught-input w-full p-2 border border-gray-300 rounded-lg text-sm text-center focus:border-emerald-500" 
                               min="0"
                               placeholder="Pages"
                               required>
                    </td>
                `;
                periodsTableBody.appendChild(row);
            });
            
            periodsTableContainer.classList.remove('hidden');
            submitButtonArea.classList.remove('hidden');
        };

        // =======================================================
        //  SUBMISSION LOGIC
        // =======================================================

        const submitReport = async (jamiaId, activeYear, monthIndex, year) => {
            const submitBtn = document.getElementById('submit-btn');
            const formMessage = document.getElementById('form-message');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
            formMessage.classList.add('hidden');

            try {
                const inputs = document.querySelectorAll('.pages-taught-input');
                const submissionBatch = [];
                
                inputs.forEach(input => {
                    const pagesTaught = parseInt(input.value);
                    if (isNaN(pagesTaught) || pagesTaught < 0) {
                         throw new Error("Sahi Pages Taught value enter karein.");
                    }
                    
                    submissionBatch.push({
                        jamiaId: decodeURIComponent(jamiaId),
                        teacherId: selectedTeacherData.id,
                        teacherName: selectedTeacherData.name,
                        periodId: input.dataset.periodId,
                        className: input.dataset.className,
                        bookName: input.dataset.bookName,
                        pagesTaught: pagesTaught,
                        submissionMonth: monthIndex,
                        submissionYear: year,
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                if (submissionBatch.length === 0) {
                    throw new Error("Koi data submit nahi ho raha.");
                }
                
                // Data Firebase ke naye 'teacher_submissions' collection mein save karna
                const batch = db.batch();
                const submissionsRef = db.collection('teacher_submissions');

                submissionBatch.forEach(data => {
                    const docRef = submissionsRef.doc(); 
                    batch.set(docRef, data);
                });

                await batch.commit();

                formMessage.textContent = '‚úÖ Report kamyabi se submit ho gayi hai. Shukriya!';
                formMessage.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700';
                formMessage.classList.remove('hidden');
                
                // Form ko clean karna
                document.getElementById('periods-table-container').classList.add('hidden');
                document.getElementById('submit-button-area').classList.add('hidden');
                document.getElementById('teacher-select').disabled = true;

            } catch (error) {
                console.error("Submission Error:", error);
                formMessage.textContent = `‚ùå Report submit nahi ho payi: ${error.message}`;
                formMessage.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700';
                formMessage.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-upload mr-2"></i> Submit Monthly Report';
            }
        };
    </script>
</body>
</html>