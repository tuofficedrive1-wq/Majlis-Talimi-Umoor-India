<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Reporting App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff') format('woff');
            font-weight: normal; font-style: normal; font-display: swap;
             unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF, U+FE70-FEFF;
        }
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; font-size: 1.1rem; line-height: 1.6; }
        input, textarea, select, button { font-family: inherit; font-size: 1rem; }
        input.urdu-font, textarea.urdu-font, select.urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; font-size: 1rem; line-height: 1.5; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #14b8a6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn.active { border-color: #14b8a6; background-color: #14b8a6; color: white; }
        input:disabled, select:disabled, textarea:disabled { background-color: #e5e7eb; cursor: not-allowed; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; padding-top: 0; padding-bottom: 0; }
        .accordion-content.open { max-height: 1500px; padding-top: 1rem; padding-bottom: 1rem; border-top: 1px solid #e5e7eb; }
        .accordion-button svg { transition: transform 0.3s ease-out; }
        .accordion-button.open svg { transform: rotate(180deg); }
        .modal-body { max-height: 70vh; overflow-y: auto; }
        .comment-display { background-color: #f3f4f6; border-left: 3px solid #14b8a6; padding: 8px 12px; margin-top: 8px; border-radius: 4px; }
        .announcement-box { background-color: #fffbeb; border: 1px solid #fde68a; }
        .reminder-box { background-color: #fef2f2; border: 1px solid #fecaca; }
        .section-status-btn { border: 1px solid #e5e7eb; cursor: pointer; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="notification" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform translate-x-full hidden"></div>

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="bg-white shadow-md rounded-lg p-4 mb-8 relative flex justify-between items-center min-h-[80px]">
            <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 text-center absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full px-2">Majlis Talimi Umoor India</h1>
            <div id="user-info" class="hidden ml-auto flex items-center relative z-10">
                <button id="logout-btn" class="ml-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Logout</button>
            </div>
        </header>

        <div id="loader" class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-50 flex justify-center items-center z-[70] hidden"> <div class="loader"></div> </div>
        
        <div id="login-view">
             <div class="max-w-md mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg"> 
                <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                    </div>
                    <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Login</button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    <div class="text-center mt-4">
                        <a href="#" id="forgot-password-link" class="text-sm text-teal-600 hover:underline">Forgot Password?</a>
                    </div>
                </form>
            </div>
        </div>

        <div id="reset-password-view" class="hidden">
             <div class="max-w-md mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg"> 
                <h2 class="text-2xl font-bold text-center mb-6">Reset Password</h2>
                <form id="reset-password-form">
                    <div class="mb-4">
                        <label for="reset-email" class="block text-gray-700 font-medium mb-2">Email</label>
                        <input type="email" id="reset-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                    </div>
                    <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Send Reset Link</button>
                    <p id="reset-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    <div class="text-center mt-4">
                        <a href="#" id="back-to-login-link" class="text-sm text-teal-600 hover:underline">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
        
        <main id="dashboard-view" class="hidden">
            <div class="bg-white p-4 md:p-8 rounded-xl shadow-lg">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 mb-8 pb-8 border-b">
                    <div class="flex items-center justify-center relative group">
                        <img id="dash-profile-photo" src="https://placehold.co/150x150/e2e8f0/94a3b8?text=Photo" alt="Profile Photo" class="w-48 h-48 object-cover rounded-xl shadow-lg border-4 border-white" onerror="this.onerror=null;this.src='https://placehold.co/150x150/fecaca/991b1b?text=Error';">
                        <button id="dash-edit-photo-btn" class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center text-white text-2xl rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 cursor-pointer">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    
                    <div class="md:col-span-2">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                            <div class="bg-gray-50 p-4 md:p-6 rounded-lg border flex flex-col justify-center">
                                <h3 class="text-2xl font-bold mb-3 text-gray-800">Assalamu Alaikum,</h3>
                                <p id="dash-user-name" class="text-xl font-semibold text-teal-700 urdu-font mb-4">Loading...</p>
                                <p class="text-gray-600"><strong>Zimmeadari:</strong> <span id="dash-user-zimmedari" class="font-medium text-gray-800 urdu-font">Loading...</span></p>
                            </div>
                            <div class="space-y-4 flex flex-col justify-center">
                                <div class="bg-teal-100 text-teal-800 p-4 md:p-6 rounded-lg text-center shadow-sm">
                                    <p class="text-lg font-semibold">Total Jamiaat</p>
                                    <p id="dash-total-jamiaat" class="text-3xl font-bold">0</p>
                                </div>
                                <div id="dash-report-status" class="p-4 md:p-6 rounded-lg text-center shadow-sm">
                                    <p class="text-lg font-semibold">Overall Status</p>
                                    <p id="dash-overall-status-text" class="text-xl font-bold">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-8 text-center">
                    <h3 class="text-xl font-semibold mb-4">Report Month Select Karein:</h3>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <input type="month" id="report-month-selector" class="p-2 border border-gray-300 rounded-lg text-lg">
                        
                        <button id="go-to-report-btn" class="w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-10 rounded-lg transition duration-300 text-lg">
                            Report Fill/Edit Karein <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                    <p id="dash-current-month-year" class="text-sm text-gray-600 mt-2">Currently showing data for: Loading...</p>
                </div>
                
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <button class="section-status-btn p-4 rounded-lg text-center shadow-md transition-shadow duration-300 hover:shadow-lg" data-target-tab="jaiza" id="dash-jaiza-status">
                        <p class="text-md font-semibold text-gray-700">Jaiza Report</p>
                        <p class="text-xl font-bold mt-1 text-yellow-600" id="dash-jaiza-status-text">Pending</p>
                    </button>
                    <button class="section-status-btn p-4 rounded-lg text-center shadow-md transition-shadow duration-300 hover:shadow-lg" data-target-tab="tadris" id="dash-tadris-status">
                        <p class="text-md font-semibold text-gray-700">Tadris Recording</p>
                        <p class="text-xl font-bold mt-1 text-yellow-600" id="dash-tadris-status-text">Pending</p>
                    </button>
                    <button class="section-status-btn p-4 rounded-lg text-center shadow-md transition-shadow duration-300 hover:shadow-lg" data-target-tab="test" id="dash-test-status">
                        <p class="text-md font-semibold text-gray-700">Monthly Test</p>
                        <p class="text-xl font-bold mt-1 text-yellow-600" id="dash-test-status-text">Pending</p>
                    </button>
                    <button class="section-status-btn p-4 rounded-lg text-center shadow-md transition-shadow duration-300 hover:shadow-lg" data-target-tab="kkd" id="dash-kkd-status">
                        <p class="text-md font-semibold text-gray-700">Karkardagi</p>
                        <p class="text-xl font-bold mt-1 text-yellow-600" id="dash-kkd-status-text">Pending</p>
                    </button>
                </div>
                
                <div id="user-late-reminder" class="hidden p-4 mb-6 rounded-lg reminder-box">
                    <h4 class="font-bold text-red-800">Report Pending!</h4>
                    <p class="text-red-700 text-sm">Aapki pichle mahine ki report abhi tak submit nahi hui hai. Baraye karam jald se jald mukammal karein.</p>
                 </div>
                 <div id="user-announcements" class="mb-6 space-y-3"></div>
                 
                 <div id="academic-structure-setup" class="hidden mb-8 p-4 md:p-6 bg-yellow-100 border border-yellow-300 rounded-lg">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-3">Setup Academic Structure</h3>
                    <p class="text-yellow-700 mb-4">Aapke profile me Jamia/Class/Kitab ka data nahi mila hai. Kripya neeche diye गए box me JSON format me data paste karein aur save karein.</p>
                    <textarea id="academic-structure-json" rows="10" class="w-full p-2 border border-yellow-400 rounded-lg mb-3 font-mono text-sm" placeholder="Yahan par academic structure ka JSON data paste karein..."></textarea>
                    <button id="save-academic-structure-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Save Academic Structure</button>
                    <p id="structure-error" class="text-red-500 text-sm mt-2"></p>
                 </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Jamia-wise Summary (Selected Month Performance)</h3>

                    <div class="p-4 bg-white rounded-lg shadow-inner mb-6 border border-gray-200">
                        <h4 class="text-lg font-bold text-gray-700 mb-3" id="jaiza-chart-title">Jaiza Performance Comparison</h4>
                        <div style="height: 400px;"><canvas id="comparisonChart"></canvas></div>
                        <button id="download-jaiza-chart-btn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-download mr-2"></i> Jaiza Chart Download Karein</button>
                    </div>

                    <div class="p-4 bg-white rounded-lg shadow-inner mb-6 border border-gray-200">
                        <h4 class="text-lg font-bold text-gray-700 mb-3" id="test-chart-title">Monthly Test Performance Comparison</h4>
                        <div style="height: 400px;"><canvas id="testComparisonChart"></canvas></div>
                        <button id="download-test-chart-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-download mr-2"></i> Monthly Test Chart Download Karein</button>
                    </div>

                    <div id="dashboard-summary-container" class="overflow-x-auto">
                        <p id="summary-loading-msg" class="text-center text-gray-500">Loading summary...</p>
                        <table id="dashboard-summary-table" class="min-w-full divide-y divide-gray-200 hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jamia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">This Month Jaiza</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">This Month Test</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Month Jaiza %</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Month Test %</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-summary-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-12">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Past Report Explorer</h3>
                    
                    <div class="p-4 bg-gray-50 rounded-lg border grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label for="filter-month-year" class="block text-sm font-medium text-gray-700 mb-1">Select Month</label>
                            <input type="month" id="filter-month-year" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="filter-jamia" class="block text-sm font-medium text-gray-700 mb-1">Select Jamia</label>
                            <select id="filter-jamia" class="w-full p-2 border border-gray-300 rounded-lg bg-white urdu-font">
                                <option value="All Jamiaat">All Jamiaat</option>
                                </select>
                        </div>
                        <div>
                            <label for="filter-section" class="block text-sm font-medium text-gray-700 mb-1">Select Section</label>
                            <select id="filter-section" class="w-full p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="All Sections">All Sections</option>
                                <option value="Jaiza Report">Jaiza Report</option>
                                <option value="Tadris Recording">Tadris Recording</option>
                                <option value="Monthly Test">Monthly Test</option>
                            </select>
                        </div>
                        <div class="self-end">
                            <button id="filter-search-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">
                                <i class="fas fa-search mr-2"></i> Search
                            </button>
                        </div>
                    </div>

                    <div id="filter-results-container" class="space-y-6">
                        <p id="filter-results-msg" class="text-center text-gray-500 p-4 hidden">Select filters and click 'Search' to view past reports.</p>

                        <table id="jaiza-results-table" class="min-w-full divide-y divide-gray-200 hidden">
                            <thead class="bg-gray-100">
                                <tr><th colspan="4" class="px-6 py-3 text-left text-md font-bold text-gray-700">Jaiza Report</th></tr>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jamia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">%</th>
                                </tr>
                            </thead>
                            <tbody id="jaiza-results-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>

                        <table id="tadris-results-table" class="min-w-full divide-y divide-gray-200 hidden">
                            <thead class="bg-gray-100">
                                <tr><th colspan="6" class="px-6 py-3 text-left text-md font-bold text-gray-700">Tadris Recording</th></tr>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jamia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Teacher</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Class/Kitab</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recording par Tasurat</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Talimi Zimmedar ke Tasurat</th>
                                </tr>
                            </thead>
                            <tbody id="tadris-results-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                        
                        <table id="test-results-table" class="min-w-full divide-y divide-gray-200 hidden">
                            <thead class="bg-gray-100">
                                <tr><th colspan="5" class="px-6 py-3 text-left text-md font-bold text-gray-700">Monthly Test</th></tr>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jamia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">%</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wajah</th>
                                </tr>
                            </thead>
                            <tbody id="test-results-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
        <main id="user-view" class="hidden">
             <div class="bg-white p-4 md:p-8 rounded-xl shadow-lg">
                <button id="back-to-dashboard-btn" class="mb-4 text-teal-600 hover:text-teal-800 font-medium">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </button>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 mb-8 pb-8 border-b">
                    <div class="flex items-center justify-center relative group">
                        <img id="profile-details-photo" src="https://placehold.co/150x150/e2e8f0/94a3b8?text=Photo" alt="Profile Photo" class="w-48 h-48 object-cover rounded-xl shadow-lg border-4 border-white" onerror="this.onerror=null;this.src='https://placehold.co/150x150/fecaca/991b1b?text=Error';">
                        <button id="edit-photo-btn" class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center text-white text-2xl rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 cursor-pointer"> <i class="fas fa-edit"></i> </button>
                    </div>
                    <div class="md:col-span-2">
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                            <div class="bg-gray-50 p-4 md:p-6 rounded-lg border flex flex-col justify-center">
                                <h3 class="text-xl font-bold mb-4 text-gray-700">Profile Details</h3>
                                <div class="space-y-3 text-gray-600">
                                    <p><strong>Name:</strong> <span id="user-name" class="font-medium text-gray-800 urdu-font">Loading...</span></p>
                                    <p><strong>Zimmeadari:</strong> <span id="user-zimmedari" class="font-medium text-gray-800 urdu-font">Loading...</span></p>
                                    <p><strong>Contact No:</strong> <span id="user-contact" class="font-medium text-gray-800">Loading...</span></p>
                                    <p><strong>Ajeer Code:</strong> <span id="user-ajeer-code" class="font-medium text-gray-800">Loading...</span></p>
                                </div>
                            </div>
                            <div class="space-y-4 flex flex-col justify-center">
                                <div class="bg-teal-100 text-teal-800 p-4 md:p-6 rounded-lg text-center shadow-sm">
                                    <p class="text-lg font-semibold">Total Jamiaat</p> <p id="user-jamiaat" class="text-3xl font-bold">0</p>
                                </div>
                                <div class="bg-emerald-100 text-emerald-800 p-4 md:p-6 rounded-lg text-center shadow-sm">
                                    <p class="text-lg font-semibold">Total Asatiza</p> <p id="user-asatiza" class="text-3xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>

                <div>
                    <h3 class="text-xl font-semibold mb-2" id="current-month-year"></h3>
                    <div id="report-status" class="mb-6 p-4 rounded-lg text-center font-semibold"></div>
                    <div id="report-container" class="space-y-6">
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Monthly Report</h2>
                            <div class="border-b border-gray-200">
                                <nav class="-mb-px flex space-x-4 md:space-x-8 overflow-x-auto" aria-label="Tabs">
                                    <button type="button" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="jaiza">Jaiza Report</button>
                                    <button type="button" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="tadris">Tadris Recording</button>
                                    <button type="button" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="test">Monthly Test</button>
                                    <button type="button" id="kkd-tab-link" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Talimi & Shashmahi KKd <i class="fas fa-external-link-alt text-xs ml-2"></i></button>
                                </nav>
                            </div>
                            <div class="pt-6">
                               <div id="jaiza-tab-content" class="tab-content">
                                    <div class="mb-4 border-b border-gray-200">
                                        <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Jaiza inner tabs">
                                            <button type="button" id="jaiza-inner-form-tab" class="inline-flex items-center whitespace-nowrap py-2 px-3 border-b-2 border-emerald-600 text-sm font-medium text-emerald-700">Form</button>
                                            <button type="button" id="jaiza-inner-summary-tab" class="inline-flex items-center whitespace-nowrap py-2 px-3 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Summary</button>
                                        </nav>
                                    </div>
                                    <div id="jaiza-inner-form-panel">
                                        <div class="mb-4 flex gap-2 items-end">
                                             <div class="w-full md:w-1/3">
                                                  <label class="block text-sm font-medium text-gray-700 mb-1">External Form ke liye Jamia select karein</label>
                                                  <select id="jaiza-form-jamia-select" class="w-full p-2 border rounded-lg urdu-font"></select>
                                             </div>
                                             <button id="open-jaiza-form-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg mb-0.5">Open Form</button>
                                        </div>
                                        <form id="jaiza-form">
                                            <h4 id="jaiza-pending-title" class="text-lg font-semibold text-gray-800 mb-4 hidden">Pending Jaizaat</h4>
                                            <div id="jaiza-list-container" class="space-y-4"></div>
                                            <button type="submit" id="jaiza-save-btn" class="mt-4 w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg hidden">Save Filled Jaizaat</button>
                                        </form>
                                        <div id="jaiza-display" class="mt-6">
                                            <h4 id="jaiza-submitted-title" class="text-lg font-semibold text-gray-800 mb-4 hidden">Submitted Jaizaat</h4>
                                            <div id="jaiza-display-table"></div>
                                        </div>
                                    </div>
                                    <div id="jaiza-inner-summary-panel" class="hidden">
                                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Jaiza Summary (Class / Kitab wise)</h4>
                                        <p id="jaiza-summary-msg" class="text-sm text-gray-600 mb-4">Loading...</p>
                                        <div id="jaiza-summary-classes" class="space-y-3"></div>
                                    </div>
                                </div>

                                <div id="tadris-tab-content" class="tab-content hidden">
                                     <div id="tadris-accordion-container" class="space-y-3"></div>
                                    <p id="tadris-loading-msg" class="text-center text-gray-500 hidden">Loading Jamiaat...</p>
                                    <p id="tadris-no-data-msg" class="text-center text-red-500 hidden">Pehle Academic Structure data save karein.</p>
                                </div>
                                
                                <div id="test-tab-content" class="tab-content hidden">
                                    <form id="test-form">
                                        <h4 id="test-pending-title" class="text-lg font-semibold text-gray-800 mb-4 hidden">Pending Monthly Tests</h4>
                                        <div id="test-list-container" class="space-y-4"></div>
                                        <button type="submit" id="test-save-btn" class="mt-4 w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg hidden">Save Filled Test Reports</button>
                                    </form>
                                    <div id="test-display" class="mt-6">
                                        <h4 id="test-submitted-title" class="text-lg font-semibold text-gray-800 mb-4 hidden">Submitted Test Reports</h4>
                                        <div id="test-display-table"></div>
                                    </div>
                                </div>

                                <div id="kkd-tab-content" class="tab-content hidden">
                                     <p>Please click the "Talimi & Shashmahi KKd" tab to open the reporting page in a new window.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="past-reports-container" class="mt-12">
                     <h3 class="text-xl font-semibold mb-4 border-b pb-2">Aapki Pichli Reports</h3>
                     <div id="past-reports-list" class="space-y-4 mt-4"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40">
        <div class="relative top-1/2 -translate-y-1/2 mx-4 sm:mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3"> <h3 class="text-xl leading-6 font-medium text-gray-900 text-center" id="modal-title">Report Details</h3> <div id="modal-content" class="modal-body mt-4 px-4 sm:px-7 py-3 text-left"></div> <div class="items-center px-4 py-3 flex gap-3"> <button id="close-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300"> Close </button> </div> </div>
        </div>
    </div>
    <div id="photo-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40">
         <div class="relative top-1/2 -translate-y-1/2 mx-4 sm:mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3"> <h3 class="text-xl leading-6 font-medium text-gray-900 text-center">Update Profile Photo</h3> <div class="mt-4 px-4 sm:px-7 py-3"> <label for="photo-url-input" class="block text-sm font-medium text-gray-700 mb-1">New Photo URL</label> <input type="url" id="photo-url-input" placeholder="Paste image URL here (e.g., Google Drive link)" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"> <p class="text-xs text-gray-500 mt-1">Make sure the link is publicly accessible (Anyone with the link can view).</p> <p id="photo-error" class="text-red-500 text-sm mt-2"></p> </div> <div class="items-center px-4 py-3 flex gap-3"> <button id="save-photo-btn" class="px-4 py-2 bg-emerald-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-300"> Save Photo </button> <button id="close-photo-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300"> Cancel </button> </div> </div>
        </div>
    </div>
    
<script type="module">
// ===============================
// 1. IMPORTS & FIREBASE CONFIG
// ===============================
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  getAuth, setPersistence, browserSessionPersistence, signInWithEmailAndPassword,
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot,
  serverTimestamp, updateDoc, getDocs, orderBy
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
  authDomain: "data-f15ab.firebaseapp.com",
  projectId: "data-f15ab",
  storageBucket: "data-f15ab.appspot.com",
  messagingSenderId: "449137002393",
  appId: "1:449137002393:web:6a23721d00b1b0daeb3508",
  measurementId: "G-1PHNJQWNPZ",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_UID = "xB1E48oIdvN7jruPCIp7tzlH9lA2";

// ===============================
// 2. GLOBAL STATE
// ===============================
let currentUser = null;
let userProfileData = {};
let reportingDateInfo = {};
let selectedReportingDate = null;
let reportRef = null;
let allUserReports = [];
let unsubscribeUserReports = null;
let unsubscribeAnnouncements = null;
let dashboardChart = null;
let testDashboardChart = null;

// ===============================
// 3. DOM ELEMENTS
// ===============================
const loader = document.getElementById("loader");
const loginView = document.getElementById("login-view");
const dashboardView = document.getElementById("dashboard-view");
const userView = document.getElementById("user-view");
const userInfo = document.getElementById("user-info");
const resetPasswordView = document.getElementById("reset-password-view");
const logoutBtn = document.getElementById("logout-btn");
const loginForm = document.getElementById("login-form");
const loginEmailInput = document.getElementById("login-email");
const loginPasswordInput = document.getElementById("login-password");
const loginError = document.getElementById("login-error");
const forgotPasswordLink = document.getElementById("forgot-password-link");
const backToLoginLink = document.getElementById("back-to-login-link");
const resetPasswordForm = document.getElementById("reset-password-form");
const dashUserName = document.getElementById("dash-user-name");
const dashUserZimmedari = document.getElementById("dash-user-zimmedari");
const dashTotalJamiaat = document.getElementById("dash-total-jamiaat");
const dashProfilePhoto = document.getElementById("dash-profile-photo");
const dashJaizaStatusText = document.getElementById("dash-jaiza-status-text");
const dashTadrisStatusText = document.getElementById("dash-tadris-status-text");
const dashTestStatusText = document.getElementById("dash-test-status-text");
const dashKkdStatusText = document.getElementById("dash-kkd-status-text");
const dashOverallStatusText = document.getElementById("dash-overall-status-text");
const dashReportStatusDiv = document.getElementById("dash-report-status");
const dashCurrentMonthYear = document.getElementById("dash-current-month-year");
const reportMonthSelector = document.getElementById("report-month-selector");
const summaryTable = document.getElementById("dashboard-summary-table");
const summaryTableBody = document.getElementById("dashboard-summary-table-body");
const summaryLoadingMsg = document.getElementById("summary-loading-msg");
const goToReportBtn = document.getElementById("go-to-report-btn");
const backToDashboardBtn = document.getElementById("back-to-dashboard-btn");
const userTabButtons = document.querySelectorAll(".tab-btn");
const userTabContents = document.querySelectorAll(".tab-content");
const jaizaForm = document.getElementById("jaiza-form");
const jaizaPendingTitle = document.getElementById("jaiza-pending-title");
const jaizaListContainer = document.getElementById("jaiza-list-container");
const jaizaSaveBtn = document.getElementById("jaiza-save-btn");
const testForm = document.getElementById("test-form");
const testPendingTitle = document.getElementById("test-pending-title");
const testListContainer = document.getElementById("test-list-container");
const testSaveBtn = document.getElementById("test-save-btn");
const testSubmittedTitle = document.getElementById("test-submitted-title");
const testDisplayContainer = document.getElementById("test-display-table");
const jaizaInnerFormTab = document.getElementById("jaiza-inner-form-tab");
const jaizaInnerSummaryTab = document.getElementById("jaiza-inner-summary-tab");
const jaizaInnerFormPanel = document.getElementById("jaiza-inner-form-panel");
const jaizaInnerSummaryPanel = document.getElementById("jaiza-inner-summary-panel");
const jaizaSummaryClasses = document.getElementById("jaiza-summary-classes");
const jaizaSummaryMsg = document.getElementById("jaiza-summary-msg");
const tadrisAccordionContainer = document.getElementById("tadris-accordion-container");
const tadrisLoadingMsg = document.getElementById("tadris-loading-msg");
const tadrisNoDataMsg = document.getElementById("tadris-no-data-msg");
const academicStructureSetup = document.getElementById("academic-structure-setup");
const academicStructureJson = document.getElementById("academic-structure-json");
const saveAcademicStructureBtn = document.getElementById("save-academic-structure-btn");
const structureError = document.getElementById("structure-error");
const photoModal = document.getElementById("photo-modal");
const photoUrlInput = document.getElementById("photo-url-input");
const photoError = document.getElementById("photo-error");
const savePhotoBtn = document.getElementById("save-photo-btn");
const closePhotoModalBtn = document.getElementById("close-photo-modal-btn");
const editPhotoBtn = document.getElementById("edit-photo-btn");
const dashEditPhotoBtn = document.getElementById("dash-edit-photo-btn");
const profilePhotoImg = document.getElementById("profile-details-photo");
const pastReportsList = document.getElementById("past-reports-list");
const userAnnouncementsDiv = document.getElementById("user-announcements");
const userLateReminderDiv = document.getElementById("user-late-reminder");
const jaizaFormJamiaSelect = document.getElementById("jaiza-form-jamia-select");
const openJaizaFormBtn = document.getElementById("open-jaiza-form-btn");
const reportModal = document.getElementById("report-modal");
const modalContent = document.getElementById("modal-content");
const closeModalBtn = document.getElementById("close-modal-btn");

// ===============================
// 4. HELPER FUNCTIONS
// ===============================
const showLoader = (show) => { if (loader) loader.classList.toggle("hidden", !show); };

const showNotification = (message, isError = false) => {
  const notification = document.getElementById("notification");
  if (!notification) { alert(message); return; }
  notification.textContent = message;
  notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] transition-transform transform ${isError ? "bg-red-500" : "bg-emerald-600"}`;
  notification.classList.remove("hidden", "translate-x-full");
  setTimeout(() => { notification.classList.add("translate-x-full"); }, 3000);
};

const convertGoogleDriveURL = (url) => {
  if (!url || typeof url !== "string" || (!url.startsWith("http") && !url.startsWith("/"))) return "https://placehold.co/150x150/e2e8f0/94a3b8?text=Photo";
  if (!url.includes("drive.google.com")) return url;
  const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
  return match && match[1] ? `https://drive.google.com/uc?export=view&id=${match[1]}` : url;
};

const getReportingMonthYear = (targetDate = new Date()) => {
  const month = targetDate.toLocaleString("default", { month: "long" });
  const yearNum = targetDate.getFullYear();
  const monthNum = targetDate.getMonth();
  const monthInputFormat = `${yearNum}-${String(monthNum + 1).padStart(2, "0")}`;
  return { month, year: yearNum, monthNum, yearNum, monthInputFormat };
};

const getReportingMonthYearFromInput = (monthInputFormat) => {
  if (!monthInputFormat) return getReportingMonthYear(new Date());
  const [yearStr, monthStr] = monthInputFormat.split("-");
  const yearNum = parseInt(yearStr, 10);
  const monthNum = parseInt(monthStr, 10) - 1;
  const date = new Date(yearNum, monthNum, 1);
  return getReportingMonthYear(date);
};

const saveReportData = async (dataToSave) => {
    showLoader(true);
    const { month, year, monthNum, yearNum } = reportingDateInfo;
    const academicYear = (monthNum >= 3) ? `${yearNum}-${yearNum + 1}` : `${yearNum - 1}-${yearNum}`;
    const reportId = `${currentUser.uid}_${academicYear}_${yearNum}_${monthNum}`;

    reportRef = doc(db, 'monthly_reports', reportId); 

    const finalData = { 
        ...dataToSave, userId: currentUser.uid, userEmail: currentUser.email, month, year, academicYear, createdAt: serverTimestamp() 
    };

    try {
        await setDoc(reportRef, finalData, { merge: true }); 
    } catch (error) {
        console.error("Error saving report section: ", error);
        showNotification(`Failed to save. Please try again.`, true);
        throw error; 
    } finally {
        showLoader(false);
    }
};

const downloadChartImage = (chartId, filename) => {
    const canvas = document.getElementById(chartId);
    if(!canvas) return;
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = filename;
    link.href = url;
    link.click();
};

// ===============================
// 5. CORE LOGIC (Renderers)
// ===============================

const renderDashboard = (reports, monthInputFormat) => {
    const currentReportInfo = getReportingMonthYearFromInput(monthInputFormat);
    const prevMonthDate = new Date(currentReportInfo.yearNum, currentReportInfo.monthNum, 0); 
    const lastMonthReportInfo = getReportingMonthYear(prevMonthDate);

    dashCurrentMonthYear.textContent = `Currently showing data for: ${currentReportInfo.month} ${currentReportInfo.year}`;
    document.getElementById('jaiza-chart-title').textContent = `Jaiza Performance (${currentReportInfo.month} ${currentReportInfo.year})`;
    document.getElementById('test-chart-title').textContent = `Monthly Test Performance (${currentReportInfo.month} ${currentReportInfo.year})`;

    const { monthNum, yearNum } = currentReportInfo; 
    const allJamiaat = userProfileData.jamiaatList || [];

    const currentAcademicYear = (monthNum >= 3) ? `${yearNum}-${yearNum + 1}` : `${yearNum - 1}-${yearNum}`;
    const currentReportIdSimple = `${currentUser.uid}_${yearNum}_${monthNum}`; 
    const currentReportIdWithYear = `${currentUser.uid}_${currentAcademicYear}_${yearNum}_${monthNum}`; 
    const currentReport = reports.find(r => r.id === currentReportIdWithYear) || reports.find(r => r.id === currentReportIdSimple) || {};
    
    const prevMonthNum = lastMonthReportInfo.monthNum;
    const prevYearNum = lastMonthReportInfo.yearNum;
    const prevAcademicYear = (prevMonthNum >= 3) ? `${prevYearNum}-${prevYearNum + 1}` : `${prevYearNum - 1}-${prevYearNum}`;
    const prevReportIdSimple = `${currentUser.uid}_${prevYearNum}_${prevMonthNum}`;
    const prevReportIdWithYear = `${currentUser.uid}_${prevAcademicYear}_${prevYearNum}_${prevMonthNum}`;
    const lastMonthReport = reports.find(r => r.id === prevReportIdWithYear || r.id === prevReportIdSimple) || {};

    const jaizaDone = currentReport.jaizaReport?.status === 'Done';
    const tadrisDone = currentReport.tadrisRecording?.status === 'Done';
    const testDone = currentReport.monthlyTest?.status === 'Done'; 
    const kkdDone = currentReport.karkardagiReport?.status === 'Done' || currentReport.kkdReport?.status === 'Done';
    
    const updateStatusTile = (element, isDone, colorCode) => {
        element.textContent = isDone ? 'Done' : 'Pending';
        const button = element.closest('.section-status-btn');
        if (button) {
            button.className = `section-status-btn p-4 rounded-lg text-center shadow-md transition-shadow duration-300 hover:shadow-lg ${isDone ? `bg-${colorCode}-100` : 'bg-yellow-100'}`;
            element.className = `text-xl font-bold mt-1 ${isDone ? `text-${colorCode}-700` : 'text-yellow-600'}`;
        }
    };

    updateStatusTile(dashJaizaStatusText, jaizaDone, 'teal');
    updateStatusTile(dashTadrisStatusText, tadrisDone, 'blue');
    updateStatusTile(dashTestStatusText, testDone, 'indigo');
    updateStatusTile(dashKkdStatusText, kkdDone, 'purple');

    if (jaizaDone && tadrisDone && testDone && kkdDone) { 
        dashOverallStatusText.textContent = 'COMPLETE';
        dashReportStatusDiv.className = 'p-4 md:p-6 rounded-lg text-center shadow-sm bg-green-100 text-green-800';
    } else if (jaizaDone || tadrisDone || testDone || kkdDone) { 
        dashOverallStatusText.textContent = 'PARTIALLY COMPLETE';
        dashReportStatusDiv.className = 'p-4 md:p-6 rounded-lg text-center shadow-sm bg-blue-100 text-blue-800';
    } else {
        dashOverallStatusText.textContent = 'PENDING';
        dashReportStatusDiv.className = 'p-4 md:p-6 rounded-lg text-center shadow-sm bg-yellow-100 text-yellow-800';
    }

    summaryTableBody.innerHTML = ''; 
    
    if (allJamiaat.length === 0) {
        summaryLoadingMsg.textContent = "Aapke profile mein koi Jamia add nahi hai. Pehle Academic Structure save karein.";
        summaryLoadingMsg.classList.remove('hidden');
        summaryTable.classList.add('hidden');
        return;
    }

    const currentJaizaData = currentReport.jaizaReport?.data || [];
    const currentTestData = currentReport.monthlyTest?.data || [];
    const lastJaizaData = lastMonthReport.jaizaReport?.data || [];
    const lastTestData = lastMonthReport.monthlyTest?.data || [];

    const jaizaChartData = [];
    const testChartData = [];

    allJamiaat.forEach(jamiaName => {
        const thisMonthJaiza = currentJaizaData.find(j => j.name === jamiaName);
        const thisMonthTest = currentTestData.find(t => t.name === jamiaName);
        const lastMonthJaiza = lastJaizaData.find(j => j.name === jamiaName);
        const lastMonthTest = lastTestData.find(t => t.name === jamiaName);

        let jaizaStatus = '<span class="text-yellow-600 font-medium">Pending</span>';
        if (thisMonthJaiza) {
            jaizaStatus = (thisMonthJaiza.type === 'Nahi Hua' || thisMonthJaiza.type === 'Visit') 
                ? `<span class="text-blue-600">${thisMonthJaiza.type}</span>` 
                : `<span class="text-green-600">Done (${thisMonthJaiza.percentage || 'N/A'}%)</span>`;
        }
        
        let testStatus = '<span class="text-yellow-600 font-medium">Pending</span>';
        if (thisMonthTest) {
            testStatus = (thisMonthTest.status === 'Nahi Hua') 
                ? `<span class="text-blue-600">${thisMonthTest.status}</span>` 
                : `<span class="text-green-600">Done (${thisMonthTest.percentage || 'N/A'}%)</span>`;
        }

        const lastJaizaPercent = lastMonthJaiza?.percentage || (lastMonthJaiza ? lastMonthJaiza.type : 'N/A');
        const lastTestPercent = lastMonthTest?.percentage || (lastMonthTest ? lastMonthTest.status : 'N/A');

        const row = `
            <tr class="text-sm">
                <td class="px-6 py-4 urdu-font font-medium">${jamiaName}</td>
                <td class="px-6 py-4">${jaizaStatus}</td>
                <td class="px-6 py-4">${testStatus}</td>
                <td class="px-6 py-4">${lastJaizaPercent}</td>
                <td class="px-6 py-4">${lastTestPercent}</td>
            </tr>`;
        summaryTableBody.innerHTML += row;

        let thisMonthJaizaPercent = 0;
        if (thisMonthJaiza && thisMonthJaiza.type === 'Jaiza' && thisMonthJaiza.percentage) {
            thisMonthJaizaPercent = parseFloat(thisMonthJaiza.percentage.replace('%', '')) || 0;
        }
        let thisMonthTestPercent = 0;
        if (thisMonthTest && thisMonthTest.status === 'Test Hua' && thisMonthTest.percentage) {
            thisMonthTestPercent = parseFloat(thisMonthTest.percentage.replace('%', '')) || 0;
        }
        jaizaChartData.push({ jamia: jamiaName, thisMonth: thisMonthJaizaPercent });
        testChartData.push({ jamia: jamiaName, thisMonth: thisMonthTestPercent });
    });

    summaryLoadingMsg.classList.add('hidden');
    summaryTable.classList.remove('hidden');

    jaizaChartData.sort((a, b) => b.thisMonth - a.thisMonth); 
    testChartData.sort((a, b) => b.thisMonth - a.thisMonth);

    const ctxJaiza = document.getElementById('comparisonChart').getContext('2d');
    if (dashboardChart) dashboardChart.destroy();
    dashboardChart = new Chart(ctxJaiza, {
        type: 'bar',
        data: {
            labels: jaizaChartData.map(d => d.jamia),
            datasets: [{
                label: `${currentReportInfo.month} Jaiza %`,
                data: jaizaChartData.map(d => d.thisMonth),
                backgroundColor: 'rgba(20, 184, 166, 0.9)',
                borderColor: 'rgba(20, 184, 166, 1)',
                borderWidth: 1
            }]
        },
        plugins: [ChartDataLabels], 
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { font: { family: 'Jameel Noori Nastaleeq', size: 14, weight: 'bold' } } }, y: { beginAtZero: true, max: 100 } },
            plugins: { datalabels: { anchor: 'end', align: 'top', formatter: (v) => v > 0 ? v + '%' : '', color: '#4b5563', font: { weight: 'bold' } } }
        }
    });

    const ctxTest = document.getElementById('testComparisonChart').getContext('2d');
    if (testDashboardChart) testDashboardChart.destroy();
    testDashboardChart = new Chart(ctxTest, {
        type: 'bar',
        data: {
            labels: testChartData.map(d => d.jamia),
            datasets: [{
                label: `${currentReportInfo.month} Test %`,
                data: testChartData.map(d => d.thisMonth),
                backgroundColor: 'rgba(34, 197, 94, 0.9)',
                borderColor: 'rgba(34, 197, 94, 1)',
                borderWidth: 1
            }]
        },
        plugins: [ChartDataLabels], 
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { font: { family: 'Jameel Noori Nastaleeq', size: 14, weight: 'bold' } } }, y: { beginAtZero: true, max: 100 } },
            plugins: { datalabels: { anchor: 'end', align: 'top', formatter: (v) => v > 0 ? v + '%' : '', color: '#4b5563', font: { weight: 'bold' } } }
        }
    });
};

const renderUserDashboard = (reports, reportInfo) => {
    reportingDateInfo = reportInfo; 
    const { monthNum, yearNum } = reportInfo; 
    const currentAcademicYear = (monthNum >= 3) ? `${yearNum}-${yearNum + 1}` : `${yearNum - 1}-${yearNum}`;
    const currentReportIdSimple = `${currentUser.uid}_${yearNum}_${monthNum}`; 
    const currentReportIdWithYear = `${currentUser.uid}_${currentAcademicYear}_${yearNum}_${monthNum}`; 
    const currentReport = reports.find(r => r.id === currentReportIdWithYear) || reports.find(r => r.id === currentReportIdSimple) || {};

    document.getElementById('current-month-year').textContent = `Report for ${reportInfo.month} ${reportInfo.year}`;

    const reportStatusDiv = document.getElementById('report-status');
    const jaizaDone = currentReport.jaizaReport?.status === 'Done';
    const tadrisDone = currentReport.tadrisRecording?.status === 'Done';
    const testDone = currentReport.monthlyTest?.status === 'Done'; 
    const kkdDone = currentReport.karkardagiReport?.status === 'Done'; 
    
    const allJamiaatCount = userProfileData.jamiaatList?.length || 0;
    const submittedTestCount = currentReport.monthlyTest?.data?.length || 0;
    const testConsideredDone = testDone && (allJamiaatCount === 0 || submittedTestCount >= allJamiaatCount); 

    if (jaizaDone && tadrisDone && testConsideredDone && kkdDone) { 
         reportStatusDiv.innerHTML = 'Overall Status: <span class="font-bold text-green-600">COMPLETE</span>';
         reportStatusDiv.className = 'mb-6 p-4 rounded-lg bg-green-100 text-green-800 text-center font-semibold';
    } else if (jaizaDone || tadrisDone || testDone || kkdDone) { 
         reportStatusDiv.innerHTML = 'Overall Status: <span class="font-bold text-blue-600">PARTIALLY COMPLETE</span>';
         reportStatusDiv.className = 'mb-6 p-4 rounded-lg bg-blue-100 text-blue-800 text-center font-semibold';
    } else {
         reportStatusDiv.innerHTML = 'Overall Status: <span class="font-bold text-yellow-600">PENDING</span>';
         reportStatusDiv.className = 'mb-6 p-4 rounded-lg bg-yellow-100 text-yellow-800 text-center font-semibold';
    }

    if (userProfileData && Object.keys(userProfileData).length > 0) {
        renderJaizaTab(currentReport);
        renderTadrisTab(currentReport);
        renderTestTab(currentReport); 
    }
    renderPastReports(reports);
};

const renderJaizaTab = (currentReport) => {
  const submittedJaizaat = currentReport.jaizaReport?.data || [];
  const allJamiaat = userProfileData.jamiaatList || [];
  
  const pendingJaizaat = allJamiaat.filter(name => !submittedJaizaat.some(j => j.name === name));

  // Pending (Form)
  if (pendingJaizaat.length > 0) {
    jaizaPendingTitle.classList.remove('hidden');
    jaizaSaveBtn.classList.remove('hidden');
    jaizaListContainer.innerHTML = pendingJaizaat.map(name => `
      <div class="jaiza-row p-4 border rounded-lg bg-white shadow-sm grid grid-cols-1 sm:grid-cols-4 gap-4 items-center">
        <div class="sm:col-span-1 font-semibold text-gray-700 urdu-font">${name}</div>
        <div class="sm:col-span-1"><input type="date" class="jaiza-date w-full p-2 border rounded-lg"></div>
        <div class="sm:col-span-1">
          <select class="jaiza-type w-full p-2 border rounded-lg bg-white">
            <option value="Jaiza">Jaiza</option>
            <option value="Visit">Visit</option>
            <option value="Nahi Hua">Nahi Hua</option>
          </select>
        </div>
        <div class="sm:col-span-1">
            <div class="flex gap-2">
                <input type="text" placeholder="Majmui %" class="jaiza-percentage w-full p-2 border rounded-lg">
                <button type="button" class="open-jaiza-form-btn px-3 py-2 rounded bg-emerald-600 text-white text-xs" data-jamia="${name}">Form</button>
            </div>
        </div>
      </div>`).join('');
  } else {
    jaizaPendingTitle.classList.add('hidden');
    jaizaSaveBtn.classList.add('hidden');
    jaizaListContainer.innerHTML = '<p class="text-sm text-gray-500">Sabhi Jamiaat ke Jaiza/Visit ki report submit ho chuki hai.</p>';
  }

  // Submitted List
  const jaizaDisplayContainer = document.getElementById('jaiza-display-table');
  if (submittedJaizaat.length > 0) {
    document.getElementById('jaiza-submitted-title').classList.remove('hidden');
    let tableHTML = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jamia</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">%</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
    submittedJaizaat.forEach(item => {
      tableHTML += `<tr><td class="px-6 py-4 urdu-font">${item.name}</td><td class="px-6 py-4">${item.date || '-'}</td><td class="px-6 py-4">${item.type}</td><td class="px-6 py-4">${item.percentage || '-'}</td></tr>`;
    });
    tableHTML += `</tbody></table></div>`;
    jaizaDisplayContainer.innerHTML = tableHTML;
  } else {
    document.getElementById('jaiza-submitted-title').classList.add('hidden');
    jaizaDisplayContainer.innerHTML = '';
  }
};
    const renderTadrisTab = (currentReport) => { 
    const academicData = userProfileData.academicStructure || [];
    const submittedTadrisData = currentReport.tadrisRecording?.data || [];
    if (!tadrisAccordionContainer) return; 
    tadrisAccordionContainer.innerHTML = ''; 
    
    if (!academicStructureSetup || academicStructureSetup.classList.contains('hidden') === false || !Array.isArray(academicData) || academicData.length === 0) {
         if(tadrisLoadingMsg) tadrisLoadingMsg.classList.add('hidden');
         if(tadrisNoDataMsg) tadrisNoDataMsg.classList.remove('hidden'); return; 
    }
    
    if(tadrisLoadingMsg) tadrisLoadingMsg.classList.add('hidden');
    if(tadrisNoDataMsg) tadrisNoDataMsg.classList.add('hidden');

    academicData.forEach((jamia, jamiaIndex) => {
        const jamiaSavedRecordings = submittedTadrisData.filter(rec => rec.jamiaName === jamia.jamiaName);
        const accordionItem = document.createElement('div');
        accordionItem.className = 'border rounded-lg bg-white shadow-sm overflow-hidden';
        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'accordion-button w-full flex justify-between items-center p-4 text-left font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none';
        header.innerHTML = `<span class="urdu-font">${jamia.jamiaName}</span><span class="text-sm font-normal text-teal-600">${jamiaSavedRecordings.length} Recording(s) Saved</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
        
        const content = document.createElement('div');
        content.className = 'accordion-content'; 
        
        let savedRecordingsHTML = jamiaSavedRecordings.length > 0 ? jamiaSavedRecordings.map((rec, index) => {
            return `<div class="p-3 bg-gray-100 rounded text-sm border-b" id="tadris-record-${jamiaIndex}-${index}" data-jamia-name="${rec.jamiaName}" data-date="${rec.date}" data-teacher-name="${rec.teacherName}" data-class-name="${rec.className}" data-kitab-name="${rec.kitabName}" data-tasurat="${encodeURIComponent(rec.tasurat || '')}">
                <p class="urdu-font"><strong>${rec.className} - ${rec.kitabName}</strong> (${rec.teacherName}, ${rec.date})</p>
                <div class="mt-2"><p class="text-xs font-semibold text-gray-600">Admin Tasurat:</p><p class="urdu-font">${rec.tasurat || 'No comment'}</p></div>
                <div class="mt-2 p-2 rounded comment-display">
                    <label class="block text-xs font-medium text-gray-600">Talimi Zimmedar Tasurat:</label>
                    <textarea rows="2" class="user-admin-tasurat-input w-full p-2 border rounded-lg urdu-font" data-jamia-name="${rec.jamiaName}" data-date="${rec.date}" data-teacher-name="${rec.teacherName}">${rec.adminTasurat || ''}</textarea>
                    <button type="button" class="save-user-admin-tasurat-btn w-full mt-1 bg-teal-600 text-white text-xs py-1 rounded">Save Comment</button>
                </div>
                <button type="button" class="download-tadris-pdf-btn w-full mt-3 bg-red-600 text-white text-xs py-1 rounded" data-record-id="tadris-record-${jamiaIndex}-${index}"><i class="fas fa-file-pdf mr-2"></i> PDF</button>
            </div>`;
        }).join('') : '<p class="text-sm text-gray-500">No recordings yet.</p>';
        
        content.innerHTML = `
            <div class="p-4 border-t"> 
                <div class="space-y-4 mb-6"> 
                    <h5 class="text-md font-semibold text-gray-700">Add New Recording</h5>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="text-xs">Class</label><select class="tadris-class-select w-full p-2 border rounded"><option value="">Select Class</option></select></div>
                        <div><label class="text-xs">Kitab</label><select class="tadris-kitab-select w-full p-2 border rounded" disabled><option value="">Select Class First</option></select></div>
                        <div><label class="text-xs">Teacher</label><input type="text" class="tadris-teacher-name w-full p-2 border rounded urdu-font"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="text-xs">Date</label><input type="date" class="tadris-date w-full p-2 border rounded"></div>
                        <div><label class="text-xs">Admin Tasurat</label><textarea class="tadris-tasurat w-full p-2 border rounded urdu-font"></textarea></div>
                    </div>
                    <button type="button" class="add-tadris-entry-btn w-full bg-blue-600 text-white py-2 rounded" data-jamia-name="${jamia.jamiaName}">Add Entry</button>
                </div>
                <div><h5 class="text-md font-semibold text-gray-600 mb-2 border-b pb-1">Saved Recordings</h5><div class="space-y-2">${savedRecordingsHTML}</div></div>
            </div>`;
        
        accordionItem.appendChild(header);
        accordionItem.appendChild(content);
        tadrisAccordionContainer.appendChild(accordionItem);

        const classSelect = content.querySelector('.tadris-class-select');
        if (jamia.classes) Object.keys(jamia.classes).forEach(c => classSelect.innerHTML += `<option value="${c}">${c}</option>`);
        
        header.addEventListener('click', () => { header.classList.toggle('open'); content.classList.toggle('open'); });

        classSelect.addEventListener('change', (e) => { 
            const kSelect = content.querySelector('.tadris-kitab-select');
            kSelect.innerHTML = '<option value="">Select Kitab</option>';
            kSelect.disabled = true;
            if (e.target.value && jamia.classes[e.target.value]?.kitabs) {
                jamia.classes[e.target.value].kitabs.forEach(k => kSelect.innerHTML += `<option value="${k}">${k}</option>`);
                kSelect.disabled = false;
            }
        });
        
        content.querySelector('.add-tadris-entry-btn').addEventListener('click', handleAddTadrisEntry);
        content.querySelectorAll('.save-user-admin-tasurat-btn').forEach(b => b.addEventListener('click', handleUserEditAdminTasurat));
        content.querySelectorAll('.download-tadris-pdf-btn').forEach(b => b.addEventListener('click', handleDownloadTadrisPDF));
    });
};

const renderTestTab = (currentReport) => {
    const submittedTestData = currentReport.monthlyTest?.data || [];
    const allJamiaat = userProfileData.jamiaatList || [];
    const submittedNames = submittedTestData.map(t => t.name);
    const pending = allJamiaat.filter(n => !submittedNames.includes(n));

    if (pending.length > 0) {
        testPendingTitle.classList.remove('hidden');
        testSaveBtn.classList.remove('hidden');
        testListContainer.innerHTML = pending.map(name => `
            <div class="test-row p-4 border rounded-lg bg-white shadow-sm grid grid-cols-1 sm:grid-cols-5 gap-4 items-start">
                <div class="sm:col-span-1 font-semibold text-gray-700 urdu-font">${name}</div>
                <div class="sm:col-span-1"><select class="test-status w-full p-2 border rounded"><option value="">Select Status</option><option value="Test Hua">Test Hua</option><option value="Nahi Hua">Nahi Hua</option></select></div>
                <div class="sm:col-span-1"><input type="month" class="test-month w-full p-2 border rounded" value="${reportingDateInfo.monthInputFormat}"></div>
                <div class="sm:col-span-1"><input type="text" placeholder="%" class="test-percentage w-full p-2 border rounded"></div>
                <div class="sm:col-span-1"><textarea placeholder="Wajah" class="test-wajah w-full p-2 border rounded urdu-font" disabled></textarea></div>
            </div>`).join('');
        
        testListContainer.querySelectorAll('.test-status').forEach(s => {
            s.addEventListener('change', (e) => {
                const row = e.target.closest('.test-row');
                const isNahiHua = e.target.value === 'Nahi Hua';
                row.querySelector('.test-month').disabled = isNahiHua;
                row.querySelector('.test-percentage').disabled = isNahiHua;
                row.querySelector('.test-wajah').disabled = !isNahiHua;
            });
        });
    } else {
        testPendingTitle.classList.add('hidden');
        testSaveBtn.classList.add('hidden');
        testListContainer.innerHTML = '<p class="text-sm text-gray-500">Sabhi Jamiaat ki Monthly Test report submit ho chuki hai.</p>';
    }
    
    if (submittedTestData.length > 0) {
        testSubmittedTitle.classList.remove('hidden');
        let html = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th>Jamia</th><th>Status</th><th>Month</th><th>%</th><th>Wajah</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
        submittedTestData.forEach(i => html += `<tr><td class="px-6 py-4 urdu-font">${i.name}</td><td>${i.status}</td><td>${i.month||'-'}</td><td>${i.percentage||'-'}</td><td class="urdu-font">${i.wajah||'-'}</td></tr>`);
        html += `</tbody></table>`;
        testDisplayContainer.innerHTML = html;
    } else {
        testSubmittedTitle.classList.add('hidden');
        testDisplayContainer.innerHTML = '';
    }
};

const renderPastReports = (reports) => {
    if (!pastReportsList) return;
    const { monthNum, yearNum } = getReportingMonthYearFromInput(selectedReportingDate || new Date());
    const currentIdShort = `${currentUser.uid}_${yearNum}_${monthNum}`;
    
    const sorted = reports.filter(r => !r.id.includes(currentIdShort)).sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
    
    pastReportsList.innerHTML = sorted.length ? sorted.map(r => `
        <div class="p-4 bg-gray-50 rounded-lg border flex justify-between items-center">
            <div><p class="font-semibold">${r.month} ${r.year}</p><p class="text-sm text-gray-500">Submitted: ${r.createdAt ? new Date(r.createdAt.seconds*1000).toLocaleDateString() : 'N/A'}</p></div>
            <button class="view-past-report-btn bg-teal-500 text-white px-4 py-2 rounded" data-report-id="${r.id}">View</button>
        </div>`).join('') : '<p>No past reports.</p>';
};

// ===============================
// 6. HANDLERS
// ===============================

const handleJaizaSubmit = async (e) => {
    e.preventDefault();
    const filled = [];
    document.querySelectorAll('#jaiza-list-container .jaiza-row').forEach(row => {
        const name = row.querySelector('.font-semibold').textContent;
        const type = row.querySelector('.jaiza-type').value;
        const date = row.querySelector('.jaiza-date').value;
        const perc = row.querySelector('.jaiza-percentage').value;
        
        if (type === 'Nahi Hua') filled.push({ name, date: '', type, percentage: '' });
        else if (type === 'Visit' && date) filled.push({ name, date, type, percentage: '' });
        else if (type === 'Jaiza' && date && perc) filled.push({ name, date, type, percentage: perc });
    });

    if (!filled.length) { showNotification("Fill at least one entry correctly.", true); return; }
    
    try {
        await saveReportData({});
        const snap = await getDoc(reportRef);
        const existing = snap.exists() ? snap.data().jaizaReport?.data || [] : [];
        const merged = [...existing.filter(e => !filled.find(f => f.name === e.name)), ...filled];
        await updateDoc(reportRef, { jaizaReport: { status: 'Done', data: merged } });
        showNotification("Jaiza Saved!");
    } catch(e) { console.error(e); showNotification("Error saving.", true); }
};

const handleTestFormSubmit = async (e) => {
    e.preventDefault();
    const filled = [];
    document.querySelectorAll('#test-list-container .test-row').forEach(row => {
        const name = row.querySelector('.font-semibold').textContent;
        const status = row.querySelector('.test-status').value;
        const month = row.querySelector('.test-month').value;
        const perc = row.querySelector('.test-percentage').value;
        const wajah = row.querySelector('.test-wajah').value;

        if(status === 'Nahi Hua' && wajah) filled.push({ name, status, wajah });
        else if (status === 'Test Hua' && month && perc) filled.push({ name, status, month, percentage: perc });
    });

    if (!filled.length) { showNotification("Fill at least one entry.", true); return; }

    try {
        await saveReportData({});
        const snap = await getDoc(reportRef);
        const existing = snap.exists() ? snap.data().monthlyTest?.data || [] : [];
        const merged = [...existing.filter(e => !filled.find(f => f.name === e.name)), ...filled];
        await updateDoc(reportRef, { monthlyTest: { status: 'Done', data: merged } });
        showNotification("Test Saved!");
    } catch(e) { console.error(e); showNotification("Error saving.", true); }
};

async function handleAddTadrisEntry(e) {
    e.preventDefault();
    const btn = e.target;
    const div = btn.closest('.p-4');
    const jamiaName = btn.dataset.jamiaName;
    const className = div.querySelector('.tadris-class-select').value;
    const kitabName = div.querySelector('.tadris-kitab-select').value;
    const teacherName = div.querySelector('.tadris-teacher-name').value;
    const date = div.querySelector('.tadris-date').value;
    const tasurat = div.querySelector('.tadris-tasurat').value;

    if (!className || !kitabName || !teacherName || !date) { showNotification("All fields mandatory.", true); return; }
    
    try {
        await saveReportData({});
        const snap = await getDoc(reportRef);
        const existing = snap.exists() ? snap.data().tadrisRecording?.data || [] : [];
        await updateDoc(reportRef, { tadrisRecording: { status: 'Done', data: [...existing, { jamiaName, className, kitabName, teacherName, date, tasurat, adminTasurat: '' }] } });
        showNotification("Entry Added");
        div.querySelector('.tadris-teacher-name').value = '';
        div.querySelector('.tadris-tasurat').value = '';
    } catch(e) { console.error(e); showNotification("Error adding.", true); }
}

async function handleUserEditAdminTasurat(e) {
    const txt = e.target.previousElementSibling;
    const val = txt.value;
    const { jamiaName, date, teacherName } = txt.dataset;

    try {
        const snap = await getDoc(reportRef);
        const data = snap.data().tadrisRecording?.data || [];
        const updated = data.map(d => (d.jamiaName === jamiaName && d.date === date && d.teacherName === teacherName) ? { ...d, adminTasurat: val } : d);
        await updateDoc(reportRef, { tadrisRecording: { data: updated } });
        showNotification("Comment Saved");
    } catch(e) { console.error(e); showNotification("Error saving comment.", true); }
}

async function handleDownloadTadrisPDF(e) {
    const btn = e.target.closest('button');
    const rec = document.getElementById(btn.dataset.recordId);
    const { teacherName, date } = rec.dataset;
    
    showLoader(true);
    try {
        const canvas = await window.html2canvas(rec, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Tadris Report: ${teacherName} - ${date}`, 10, 10);
        doc.addImage(imgData, 'PNG', 10, 20, 190, 0);
        doc.save(`Tadris_${teacherName}.pdf`);
    } catch(e) { console.error(e); showNotification("PDF Error", true); }
    finally { showLoader(false); }
}

const showReportModal = (report) => {
    modalContent.innerHTML = `<pre class="text-xs overflow-auto">${JSON.stringify(report, null, 2)}</pre>`;
    reportModal.classList.remove('hidden');
};

async function loadJaizaSummaryForCurrentMonth() {
    jaizaSummaryMsg.textContent = "Loading summary...";
    jaizaSummaryClasses.innerHTML = "";
    // Placeholder logic - fetch from jaiza_forms collection
    jaizaSummaryMsg.textContent = "Summary feature coming soon with Firebase integration.";
}

// ===============================
// 7. INITIALIZATION & LISTENERS
// ===============================

const initUserView = () => {
    // Tabs
    userTabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            userTabButtons.forEach(b => b.classList.remove('active'));
            userTabContents.forEach(c => c.classList.add('hidden'));
            btn.classList.add('active');
            const target = document.getElementById(`${btn.dataset.tab}-tab-content`);
            if(target) target.classList.remove('hidden');
        });
    });

    // Jaiza Inner Tabs
    jaizaInnerFormTab.addEventListener('click', () => {
        jaizaInnerFormPanel.classList.remove('hidden');
        jaizaInnerSummaryPanel.classList.add('hidden');
        jaizaInnerFormTab.classList.add('border-emerald-600', 'text-emerald-700');
        jaizaInnerSummaryTab.classList.remove('border-emerald-600', 'text-emerald-700');
    });
    jaizaInnerSummaryTab.addEventListener('click', () => {
        jaizaInnerFormPanel.classList.add('hidden');
        jaizaInnerSummaryPanel.classList.remove('hidden');
        jaizaInnerSummaryTab.classList.add('border-emerald-600', 'text-emerald-700');
        jaizaInnerFormTab.classList.remove('border-emerald-600', 'text-emerald-700');
        loadJaizaSummaryForCurrentMonth();
    });

    // Forms
    jaizaForm.addEventListener('submit', handleJaizaSubmit);
    testForm.addEventListener('submit', handleTestFormSubmit);

    // Jaiza External Form Link
    if (userProfileData.jamiaatList) {
        jaizaFormJamiaSelect.innerHTML = '<option value="">Select Jamia</option>';
        userProfileData.jamiaatList.forEach(j => jaizaFormJamiaSelect.innerHTML += `<option value="${j}">${j}</option>`);
    }
    openJaizaFormBtn.addEventListener('click', () => {
        const j = jaizaFormJamiaSelect.value;
        if (!j || !selectedReportingDate) { showNotification("Select Jamia and Month", true); return; }
        window.open(`jaiza-form.html?jamia=${encodeURIComponent(j)}&month=${selectedReportingDate}`, '_blank');
    });
    
    // Past Reports
    pastReportsList.addEventListener('click', (e) => {
        if(e.target.classList.contains('view-past-report-btn')) {
            const r = allUserReports.find(rep => rep.id === e.target.dataset.reportId);
            if(r) showReportModal(r);
        }
    });

    // Jaiza "Form" button inside the list (Dynamic)
    jaizaListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('open-jaiza-form-btn')) {
             const j = e.target.dataset.jamia;
             window.open(`jaiza-form.html?jamia=${encodeURIComponent(j)}&month=${selectedReportingDate}`, '_blank');
        }
    });
};

// Auth Listener
onAuthStateChanged(auth, async (user) => {
    showLoader(true);
    if (user) {
        currentUser = user;
        if (user.uid === ADMIN_UID) { window.location.href = "admin.html"; return; }

        const docSnap = await getDoc(doc(db, "users", user.uid));
        userProfileData = docSnap.exists() ? docSnap.data() : {};
        
        // Set UI
        loginView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        userInfo.classList.remove('hidden');
        if(userProfileData.name) dashUserName.textContent = userProfileData.name;

        // Load Reports
        selectedReportingDate = getReportingMonthYear().monthInputFormat; // Default current month
        reportMonthSelector.value = selectedReportingDate;
        
        const q = query(collection(db, 'monthly_reports'), where("userId", "==", user.uid));
        unsubscribeUserReports = onSnapshot(q, (snap) => {
            allUserReports = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderDashboard(allUserReports, selectedReportingDate);
        });

        initUserView(); // Attach listeners once
    } else {
        currentUser = null;
        loginView.classList.remove('hidden');
        dashboardView.classList.add('hidden');
        userInfo.classList.add('hidden');
        userView.classList.add('hidden');
    }
    showLoader(false);
});

// Static Event Listeners (Run once)
loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value)
    .catch(e => { loginError.textContent = e.message; });
});

logoutBtn.addEventListener('click', () => signOut(auth));

reportMonthSelector.addEventListener('change', (e) => {
    selectedReportingDate = e.target.value;
    renderDashboard(allUserReports, selectedReportingDate);
});

goToReportBtn.addEventListener('click', () => {
    dashboardView.classList.add('hidden');
    userView.classList.remove('hidden');
    renderUserDashboard(allUserReports, getReportingMonthYearFromInput(selectedReportingDate));
});

backToDashboardBtn.addEventListener('click', () => {
    userView.classList.add('hidden');
    dashboardView.classList.remove('hidden');
});

document.querySelectorAll('.section-status-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tab = btn.dataset.targetTab;
        dashboardView.classList.add('hidden');
        userView.classList.remove('hidden');
        renderUserDashboard(allUserReports, getReportingMonthYearFromInput(selectedReportingDate));
        document.querySelector(`.tab-btn[data-tab="${tab}"]`)?.click();
    });
});

// Download Chart Buttons
document.getElementById('download-jaiza-chart-btn').addEventListener('click', () => downloadChartImage('comparisonChart', 'jaiza-chart.png'));
document.getElementById('download-test-chart-btn').addEventListener('click', () => downloadChartImage('testComparisonChart', 'test-chart.png'));

// Profile Photo Logic
dashEditPhotoBtn.addEventListener('click', () => { photoUrlInput.value = userProfileData.photoURL || ''; photoModal.classList.remove('hidden'); });
editPhotoBtn.addEventListener('click', () => { photoUrlInput.value = userProfileData.photoURL || ''; photoModal.classList.remove('hidden'); });
closePhotoModalBtn.addEventListener('click', () => photoModal.classList.add('hidden'));
savePhotoBtn.addEventListener('click', async () => {
    const url = photoUrlInput.value;
    if (!url) return;
    await updateDoc(doc(db, 'users', currentUser.uid), { photoURL: url });
    userProfileData.photoURL = url;
    dashProfilePhoto.src = convertGoogleDriveURL(url);
    profilePhotoImg.src = convertGoogleDriveURL(url);
    photoModal.classList.add('hidden');
});

// Academic Structure
saveAcademicStructureBtn.addEventListener('click', async () => {
    try {
        const data = JSON.parse(academicStructureJson.value);
        await updateDoc(doc(db, 'users', currentUser.uid), { academicStructure: data });
        userProfileData.academicStructure = data;
        academicStructureSetup.classList.add('hidden');
        showNotification("Structure Saved");
        renderDashboard(allUserReports, selectedReportingDate);
    } catch(e) { structureError.textContent = "Invalid JSON"; }
});

closeModalBtn.addEventListener('click', () => reportModal.classList.add('hidden'));

</script>
</body>
</html>
