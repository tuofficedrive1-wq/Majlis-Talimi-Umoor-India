<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibtidaiya Result Sheet (Semester System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Noto Nastaliq Urdu', sans-serif; background-color: #f8fafc; }
        .urdu-font { font-family: 'Noto Nastaliq Urdu', serif; }
        .eng-font { font-family: 'Poppins', sans-serif; direction: ltr; }
        
        /* Table Styling to match Image */
        table { border-collapse: collapse; width: 100%; font-size: 0.85rem; }
        th, td { border: 1px solid #475569; padding: 4px; text-align: center; vertical-align: middle; }
        th { background-color: #e2e8f0; font-weight: bold; color: #1e293b; white-space: nowrap; }
        
        /* Input Styling inside cells */
        .cell-input { 
            width: 100%; 
            border: none; 
            background: transparent; 
            text-align: center; 
            outline: none; 
            font-family: 'Poppins', sans-serif; 
            font-weight: 500;
        }
        .cell-input:focus { background-color: #f0f9ff; }
        .name-input { font-family: 'Noto Nastaliq Urdu', serif; text-align: right; width: 120px; }
        
        /* Status Colors */
        .status-pass { background-color: #dcfce7; color: #166534; font-weight: bold; }
        .status-fail { background-color: #fee2e2; color: #991b1b; font-weight: bold; }
        .bg-gray-header { background-color: #cbd5e1; }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0f766e; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4">

    <div class="max-w-[98%] mx-auto bg-white shadow-xl rounded-none border border-gray-400 min-h-screen">
        
        <div class="p-4 text-center border-b-2 border-gray-800">
            <h1 class="text-2xl font-bold mb-2">نتیجہ سالانہ / ششماہی امتحان</h1>
            <h2 class="text-xl font-semibold text-teal-800" id="display-jamia">Loading...</h2>
            
            <div class="flex flex-wrap justify-center gap-4 mt-4 items-end no-print">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">امتحان منتخب کریں</label>
                    <select id="exam-selector" class="border border-gray-400 rounded p-1 text-sm w-48 urdu-font" onchange="loadExamData()">
                        <option value="Shashmahi">ششماہی امتحان (Half Yearly)</option>
                        <option value="Salana">سالانہ امتحان (Annual)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">تعلیمی سال</label>
                    <input type="text" id="academic-year" class="border border-gray-400 rounded p-1 text-sm w-32 text-center eng-font" value="1447H - 2026">
                </div>
                <div>
                     <button onclick="loadExamData()" class="bg-blue-600 text-white px-4 py-1.5 rounded shadow text-sm">
                        <i class="fas fa-sync-alt"></i> Load Data
                    </button>
                </div>
            </div>
        </div>

        <div id="loader" class="text-center py-10"><div class="loader mx-auto"></div><p class="mt-2 text-gray-500">Loading Result Sheet...</p></div>

        <div id="main-content" class="p-2 hidden">
            
            <div class="flex justify-between items-center mb-2 no-print">
                <div class="text-sm text-red-600 font-bold">
                    * پاسنگ مارکس: 40% (ہر مضمون میں)
                </div>
                <button onclick="addStudentRow()" class="bg-teal-600 text-white px-3 py-1 rounded text-sm shadow hover:bg-teal-700">
                    <i class="fas fa-plus"></i> طالب علم شامل کریں
                </button>
            </div>

            <div class="overflow-x-auto" id="sheet-area">
                <div class="flex justify-between border border-gray-800 p-2 bg-gray-100 mb-0 border-b-0 font-bold text-sm">
                    <span class="w-1/3 text-right">جامعات المدینہ للبنین ہند (دعوت اسلامی)</span>
                    <span class="w-1/3 text-center">ابتدائیہ</span>
                    <span class="w-1/3 text-left pl-4">درجہ</span>
                </div>

                <table id="result-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="w-10">نمبر شمار</th>
                            <th rowspan="2" class="w-40">نام</th>
                            <th rowspan="2" class="w-32">ولدیت</th>
                            
                            <th class="bg-gray-100">تجوید</th>
                            <th class="bg-gray-100">ورک بک</th>
                            <th class="bg-gray-100">اردو</th>
                            <th class="bg-gray-100">ہم نصابی<br>سرگرمیاں</th>
                            <th class="bg-gray-100">املا</th>
                            <th class="bg-gray-100">انگلش<br>(تحریری)</th>
                            <th class="bg-gray-100">انگلش<br>(تقریری)</th>
                            <th class="bg-gray-100">ریاضی</th>
                            
                            <th rowspan="2" class="bg-gray-200 w-16">کل<br>نمبر</th>
                            <th rowspan="2" class="w-16">حاصل کردہ<br>نمبر</th>
                            <th rowspan="2" class="w-16">فیصد</th>
                            <th rowspan="2" class="w-16">پیپرز میں<br>ناکام</th>
                            <th rowspan="2" class="w-24">کیفیت</th>
                            <th rowspan="2" class="no-print w-8">x</th>
                        </tr>
                        <tr>
                            <th class="eng-font">100</th> <th class="eng-font">40</th>  <th class="eng-font">40</th>  <th class="eng-font">20</th>  <th class="eng-font">100</th> <th class="eng-font">80</th>  <th class="eng-font">20</th>  <th class="eng-font">100</th> </tr>
                        <tr class="bg-white text-xs text-gray-500">
                            <td></td><td></td><td></td>
                            <td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td>
                            <td></td><td></td><td></td><td></td><td></td><td></td>
                        </tr>
                    </thead>
                    <tbody id="students-body">
                        </tbody>
                </table>
            </div>

            <div class="mt-6 flex gap-4 justify-end no-print">
                <button onclick="saveResult()" id="btn-save" class="bg-blue-700 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold shadow-md flex items-center gap-2">
                    <i class="fas fa-save"></i> Save Record
                </button>
                <button onclick="downloadPDF()" class="bg-red-700 hover:bg-red-800 text-white px-6 py-2 rounded font-bold shadow-md flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> Download Result Sheet
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let globalYear = "1447H-2026"; // Default
        
        // --- Fixed Subject Configuration (Based on Image) ---
        // Order: Right to Left (Tajweed first)
        const subjectsConfig = [
            { id: "tajweed", name: "تجوید", max: 100, pass: 40 },
            { id: "workbook", name: "ورک بک", max: 40, pass: 16 },
            { id: "urdu", name: "اردو", max: 40, pass: 16 },
            { id: "ham_nisabi", name: "ہم نصابی", max: 20, pass: 8 },
            { id: "imla", name: "املا", max: 100, pass: 40 },
            { id: "eng_written", name: "انگلش (تحریری)", max: 80, pass: 32 },
            { id: "eng_oral", name: "انگلش (تقریری)", max: 20, pass: 8 },
            { id: "riyazi", name: "ریاضی", max: 100, pass: 40 }
        ];

        const TOTAL_MARKS = 500;
        let studentsData = [];

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            
            // Note: Month is not used for Semester system, but we keep it safe
            
            if (!adminUid || !jamiaName) {
                alert("Link Invalid. Missing UID or Jamia Name."); return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            await loadExamData();
        };

        // Make loadExamData globally available
        window.loadExamData = async () => {
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            
            loader.classList.remove('hidden');
            mainContent.classList.add('hidden');

            const examType = document.getElementById('exam-selector').value; // Shashmahi / Salana
            const academicYearVal = document.getElementById('academic-year').value;
            globalYear = academicYearVal.replace(/\s/g, '');

            // Doc ID format: UID_Jamia_Year_ExamType
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            console.log("Loading Doc ID:", docId);

            try {
                const docSnap = await getDoc(doc(db, "ibtidaiya_exams", docId));
                
                studentsData = [];
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) studentsData = data.students;
                }

                // Render
                const tbody = document.getElementById('students-body');
                tbody.innerHTML = '';
                
                if(studentsData.length > 0) {
                    studentsData.forEach(std => addStudentRow(std));
                } else {
                    // Add 10 empty rows by default for layout
                    for(let i=0; i<10; i++) addStudentRow();
                }

                loader.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (error) {
                console.error("Error:", error);
                alert("Data load karne me masla aaya.");
            }
        };

        window.addStudentRow = (data = null) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            
            const name = data ? data.name : "";
            const fatherName = data ? data.fatherName : "";
            const marks = data ? data.marks : {};

            let inputsHTML = "";
            
            subjectsConfig.forEach(sub => {
                const val = marks[sub.id] || "";
                inputsHTML += `
                    <td class="p-0 border relative">
                        <input type="number" 
                            class="cell-input subject-mark" 
                            data-id="${sub.id}" 
                            data-max="${sub.max}" 
                            data-pass="${sub.pass}"
                            value="${val}"
                            oninput="calcRow(this)"
                        >
                    </td>`;
            });

            tr.innerHTML = `
                <td class="eng-font bg-gray-50">${index}</td>
                <td class="p-0 border"><input type="text" class="cell-input name-input" placeholder="نام" value="${name}"></td>
                <td class="p-0 border"><input type="text" class="cell-input name-input std-father" placeholder="ولدیت" value="${fatherName}"></td>
                
                ${inputsHTML}

                <td class="eng-font font-bold bg-gray-50">${TOTAL_MARKS}</td>
                <td class="eng-font font-bold text-blue-800 cell-obtained">0</td>
                <td class="eng-font font-bold cell-percent">0%</td>
                <td class="eng-font font-bold text-red-600 cell-fail-count">0</td>
                <td class="cell-status urdu-font text-xs"></td>
                <td class="no-print cursor-pointer text-red-400 hover:bg-red-50" onclick="this.parentElement.remove()">×</td>
            `;

            tbody.appendChild(tr);
            if (data) calcRow(tr.querySelector('.subject-mark'));
        };

        window.calcRow = (inputElement) => {
            const row = inputElement.closest('tr');
            const inputs = row.querySelectorAll('.subject-mark');
            
            let obtained = 0;
            let failCount = 0;
            let hasEntry = false;

            inputs.forEach(inp => {
                const valStr = inp.value;
                const max = parseInt(inp.dataset.max);
                const pass = parseInt(inp.dataset.pass);

                if (valStr !== "") {
                    hasEntry = true;
                    let val = parseFloat(valStr);
                    
                    if (val > max) { val = max; inp.value = max; } // Limit max
                    obtained += val;

                    // Fail Check (Visual)
                    if (val < pass) {
                        inp.style.color = "red";
                        inp.style.fontWeight = "bold";
                        failCount++;
                    } else {
                        inp.style.color = "black";
                        inp.style.fontWeight = "normal";
                    }
                }
            });

            if (!hasEntry) return;

            // Calculations
            const percent = (obtained / TOTAL_MARKS) * 100;

            // Update Cells
            row.querySelector('.cell-obtained').innerText = obtained;
            row.querySelector('.cell-percent').innerText = percent.toFixed(2);
            row.querySelector('.cell-fail-count').innerText = failCount;

            // Status Logic (Kaifiyat)
            const statusCell = row.querySelector('.cell-status');
            
            if (failCount > 0) {
                statusCell.innerText = "ناکام";
                statusCell.className = "cell-status status-fail";
            } else {
                statusCell.innerText = "کامیاب"; // Pas
                statusCell.className = "cell-status status-pass";
            }
        };

        window.saveResult = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            const examType = document.getElementById('exam-selector').value;
            const rows = document.querySelectorAll('#students-body tr');
            const studentsToSave = [];

            rows.forEach(row => {
                const name = row.querySelector('.name-input').value.trim();
                const fatherName = row.querySelector('.std-father').value.trim();
                
                if (name) {
                    const marks = {};
                    row.querySelectorAll('.subject-mark').forEach(inp => {
                        marks[inp.dataset.id] = inp.value;
                    });
                    
                    const obtained = row.querySelector('.cell-obtained').innerText;
                    const percent = row.querySelector('.cell-percent').innerText;
                    const status = row.querySelector('.cell-status').innerText;
                    const failCount = row.querySelector('.cell-fail-count').innerText;

                    studentsToSave.push({
                        name, fatherName, marks, obtained, percent, status, failCount
                    });
                }
            });

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;

            try {
                await setDoc(doc(db, "ibtidaiya_exams", docId), {
                    adminUid,
                    jamiaName,
                    examType,
                    year: globalYear,
                    students: studentsToSave,
                    updatedAt: serverTimestamp()
                });
                alert("Result Saved Successfully!");
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error: " + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-save"></i> Save Record';
                btn.disabled = false;
            }
        };

        window.downloadPDF = async () => {
            if (!window.html2canvas) return;
            
            const area = document.getElementById('sheet-area');
            const header = document.querySelector('.p-4.text-center'); // Title area
            const btnDiv = document.querySelector('.mt-6');
            
            // Temporary Adjustments for Print
            btnDiv.style.display = 'none';
            document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none');

            const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4'); // Landscape
            
            await html2canvas(document.body, { 
                scale: 1.5,
                windowWidth: 1400 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 290; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 5, 5, imgWidth, imgHeight);
                pdf.save(`Result_${jamiaName}_${globalYear}.pdf`);
            });

            // Restore
            btnDiv.style.display = 'flex';
            document.querySelectorAll('.no-print').forEach(e => e.style.display = '');
            window.location.reload(); // Quick fix to restore layout if broken
        };
    </script>
</body>
</html>
