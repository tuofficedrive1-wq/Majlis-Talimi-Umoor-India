<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibtidaiya Result Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2');
            font-display: swap;
        }
        body { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; background-color: #f8fafc; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .eng-font { font-family: 'Poppins', sans-serif; direction: ltr; }
        
        /* Table Styling */
        table { border-collapse: collapse; width: 100%; font-size: 0.85rem; table-layout: auto; } 
        
        /* Header Colors */
        .th-personal { background-color: #1e3a8a !important; color: white; border: 1px solid #1e3a8a; } 
        .th-subject { background-color: #e0e7ff !important; color: #3730a3; border: 1px solid #c7d2fe; } 
        .th-result { background-color: #f3f4f6 !important; color: #1f2937; border: 1px solid #d1d5db; } 
        
        th { font-weight: bold; padding: 4px 2px; text-align: center; vertical-align: middle; white-space: nowrap; }
        td { border: 1px solid #cbd5e1; padding: 2px; text-align: center; vertical-align: middle; background-color: white; white-space: nowrap; }
        
        /* Inputs Styling */
        .cell-input { width: 100%; min-width: 35px; border: none; background: transparent; text-align: center; outline: none; padding: 0; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 500; }
        .cell-input:focus { background-color: #eff6ff; }
        
        .name-input-ur { font-family: 'Jameel Noori Nastaleeq', serif; text-align: right; width: 110px; font-size: 1rem; padding-right: 4px; }
        .name-input-en { font-family: 'Poppins', sans-serif; text-align: left; direction: ltr; width: 110px; font-size: 0.8rem; padding-left: 4px; }
        
        /* Status Colors */
        .cell-pass { background-color: #dcfce7 !important; color: #14532d; font-weight: bold; } 
        .cell-fail { background-color: #fee2e2 !important; color: #7f1d1d; font-weight: bold; } 
        .cell-sup { background-color: #f3e8ff !important; color: #581c87; font-weight: bold; } 

        .grade-A-plus { color: #15803d; font-weight: bold; } 
        .grade-A { color: #16a34a; font-weight: bold; } 
        .grade-B { color: #2563eb; font-weight: bold; } 
        .grade-C { color: #ca8a04; font-weight: bold; } 
        .grade-D { color: #dc2626; font-weight: bold; } 

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-[99%] mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-indigo-100 min-h-screen">
        
        <div class="bg-indigo-900 text-white p-3 shadow-md no-print">
            <div class="flex justify-between items-center flex-wrap gap-2">
                <div><h1 class="text-xl font-bold urdu-font">Ibtidaiya Result Control Panel</h1></div>
                <div class="flex gap-2 items-center">
                    <select id="exam-selector" class="text-black text-xs p-1.5 rounded" onchange="updateHeaders(); loadExamData();">
                        <option value="Shashmahi">ششماہی امتحان (Half Yearly)</option>
                        <option value="Salana">سالانہ امتحان (Annual)</option>
                    </select>
                    <input type="text" id="academic-year" class="text-black text-xs p-1.5 rounded w-32 text-center" value="1447H - 2026">
                    <button onclick="updateHeaders(); loadExamData();" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded text-xs border border-indigo-400">Load Data</button>
                </div>
            </div>
        </div>

        <div id="loader" class="text-center py-20"><i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i></div>

        <div id="main-content" class="p-2 hidden">
            
            <div class="flex flex-col md:flex-row justify-between items-end mb-2 no-print gap-4">
                <div>
                    <button onclick="addStudentRow()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>

                <div class="flex gap-3 items-center bg-gray-50 p-2 rounded border border-gray-200">
                    
                    <label class="flex items-center gap-1 text-xs font-semibold text-gray-700 cursor-pointer select-none border-r pr-3 border-gray-300">
                        <input type="checkbox" id="chk-allow-dl" class="accent-indigo-600 w-4 h-4 cursor-pointer">
                        <span>Allow Download PDF</span>
                    </label>

                    <button onclick="saveResult()" id="btn-save" class="bg-emerald-600 text-white px-4 py-1.5 rounded text-xs hover:bg-emerald-700 transition font-bold flex items-center gap-2">
                        <i class="fas fa-save"></i> Save Record
                    </button>
                    
                    <button onclick="downloadPDF()" id="btn-download" style="display: none;" 
                        class="bg-red-700 text-white px-4 py-1.5 rounded text-xs font-bold hover:bg-red-800 transition flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded border border-gray-300" id="sheet-area">
                <div class="bg-white p-4 border-b-2 border-indigo-900">
                    <div class="text-center mb-2"><h1 class="text-4xl font-bold text-indigo-900 urdu-font" id="sheet-title">نتیجہ امتحان</h1></div>
                    <div class="text-center">
                        <div class="inline-flex flex-wrap justify-center items-center gap-x-8 gap-y-2 text-sm font-semibold text-gray-700 urdu-font py-2 px-8">
                            <div class="flex items-center gap-2"><span class="text-gray-500">جامعۃ المدینہ:</span><span id="display-jamia" class="text-indigo-800 font-bold text-lg">...</span></div>
                            <div class="flex items-center gap-2"><span class="text-gray-500">درجہ:</span><span class="text-indigo-800 font-bold text-lg">ابتدائیہ</span></div>
                            <div class="flex items-center gap-2"><span class="text-gray-500">تعلیمی سال:</span><span id="display-year" class="text-indigo-800 eng-font font-bold text-lg">...</span></div>
                        </div>
                    </div>
                </div>

                <table id="result-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="th-personal w-6">#</th>
                            <th rowspan="2" class="th-personal">داخلہ نمبر</th>
                            <th rowspan="2" class="th-personal">نام (اردو)</th>
                            <th rowspan="2" class="th-personal" style="direction: ltr;">Name (Eng)</th>
                            <th rowspan="2" class="th-personal">ولدیت (اردو)</th>
                            <th rowspan="2" class="th-personal" style="direction: ltr;">Father (Eng)</th>
                            <th rowspan="2" class="th-personal">تاریخ پیدائش</th>
                            <th class="th-subject">تجوید</th>
                            <th class="th-subject">ورک بک</th>
                            <th class="th-subject">اردو</th>
                            <th class="th-subject">ہم نصابی سرگرمیاں</th>
                            <th class="th-subject">املا</th>
                            <th class="th-subject">انگلش(تحریری)</th>
                            <th class="th-subject">انگلش(تقریری)</th>
                            <th class="th-subject">ریاضی</th>
                            <th rowspan="2" class="th-result">کل</th>
                            <th rowspan="2" class="th-result">حاصل</th>
                            <th rowspan="2" class="th-result">فیصد</th>
                            <th rowspan="2" class="th-result">کیفیت</th>
                            <th rowspan="2" class="th-personal">Grade</th>
                            <th rowspan="2" class="th-personal">Rank</th>
                            <th rowspan="2" class="no-print bg-white border-0 w-6"></th>
                        </tr>
                        <tr>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">100</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">40</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">40</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">20</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">100</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">70</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">30</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">100</th>
                        </tr>
                    </thead>
                    <tbody id="students-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let globalYear = "1447H-2026"; 
        const TOTAL_MARKS = 500;

        const subjectsConfig = [
            { id: "tajweed", max: 100 }, { id: "workbook", max: 40 },
            { id: "urdu", max: 40 }, { id: "ham_nisabi", max: 20 },
            { id: "imla", max: 100 }, { id: "eng_written", max: 70 },
            { id: "eng_oral", max: 30 }, { id: "riyazi", max: 100 }
        ];

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            if (!adminUid || !jamiaName) { alert("Link Invalid."); return; }
            document.getElementById('display-jamia').textContent = jamiaName;
            await autoSelectExamType();
            updateHeaders();
            await loadExamData();
        };

        window.updateHeaders = () => {
            const selector = document.getElementById('exam-selector');
            const yearInput = document.getElementById('academic-year');
            const titleEl = document.getElementById('sheet-title');
            const displayYearEl = document.getElementById('display-year');
            let examName = selector.value === "Shashmahi" ? "نتیجہ ششماہی امتحان" : "نتیجہ سالانہ امتحان";
            titleEl.textContent = examName;
            displayYearEl.textContent = yearInput.value; 
        };

        async function autoSelectExamType() {
            const selector = document.getElementById('exam-selector');
            try {
                const userDoc = await getDoc(doc(db, "users", adminUid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.currentSemester == 1) { selector.value = "Shashmahi"; return; } 
                    else if (data.currentSemester == 2) { selector.value = "Salana"; return; }
                }
            } catch (error) { console.error(error); }
            const now = new Date();
            const month = now.getMonth() + 1; 
            if (month >= 1 && month <= 5) { selector.value = "Salana"; } 
            else { selector.value = "Shashmahi"; }
        }

        // --- UPDATED LOAD DATA: Check Admin Settings ---
        window.loadExamData = async () => {
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
            const examType = document.getElementById('exam-selector').value; 
            const academicYearVal = document.getElementById('academic-year').value;
            globalYear = academicYearVal.replace(/\s/g, '');
            updateHeaders();
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            
            try {
                const docSnap = await getDoc(doc(db, "ibtidaiya_exams", docId));
                let studentsData = [];
                let isDownloadAllowed = false; // Default off

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) studentsData = data.students;
                    
                    // Check if Admin allowed download
                    if (data.downloadEnabled === true) {
                        isDownloadAllowed = true;
                    }
                }

                // Update UI based on saved setting
                document.getElementById('chk-allow-dl').checked = isDownloadAllowed;
                const dlBtn = document.getElementById('btn-download');
                if(isDownloadAllowed) {
                    dlBtn.style.display = 'flex';
                } else {
                    dlBtn.style.display = 'none';
                }

                const tbody = document.getElementById('students-body');
                tbody.innerHTML = '';
                if(studentsData.length > 0) studentsData.forEach(std => addStudentRow(std));
                else for(let i=0; i<5; i++) addStudentRow(); 
                
                calculateRanks(); 
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } catch (error) { console.error("Error:", error); alert("Data load error."); }
        };

        window.updateIndices = () => {
            const rows = document.querySelectorAll('#students-body tr');
            rows.forEach((row, index) => { row.cells[0].innerText = index + 1; });
        };

        window.deleteRow = (btn) => {
            if(confirm("Remove this student?")) {
                const row = btn.closest('tr');
                row.remove();
                updateIndices();
                calculateRanks(); // Update Rank after delete
            }
        };

        window.validateDakhila = (el) => { el.value = el.value.replace(/[^0-9]/g, ''); };
        window.validateMarks = (el) => { let clean = el.value.replace(/[^0-9Aa]/g, ''); el.value = clean.toUpperCase(); };

        window.addStudentRow = (data = null) => {
            const tbody = document.getElementById('students-body');
            const tr = document.createElement('tr');
            
            const dakhila = data ? (data.dakhila || "") : "";
            const nameUr = data ? (data.name || "") : "";
            const nameEn = data ? (data.nameEng || "") : "";
            const fatherUr = data ? (data.fatherName || "") : "";
            const fatherEn = data ? (data.fatherEng || "") : "";
            const dob = data ? (data.dob || "") : "";
            const marks = data ? data.marks : {};

            let inputsHTML = "";
            subjectsConfig.forEach(sub => {
                const val = marks[sub.id] || "";
                inputsHTML += `<td class="p-0 border"><input type="text" class="cell-input subject-mark" data-id="${sub.id}" data-max="${sub.max}" value="${val}" placeholder="-" oninput="validateMarks(this); calcRow(this)"></td>`;
            });

            tr.innerHTML = `
                <td class="font-bold text-gray-500 bg-gray-50 text-center"></td>
                <td class="p-0 border"><input type="text" class="cell-input eng-font dakhila-input" placeholder=".." value="${dakhila}" oninput="validateDakhila(this)"></td>
                <td class="p-0 border"><input type="text" class="cell-input name-input-ur name-ur" placeholder="نام" value="${nameUr}"></td>
                <td class="p-0 border" style="direction: ltr;"><input type="text" class="cell-input name-input-en name-en" placeholder="Name" value="${nameEn}"></td>
                <td class="p-0 border"><input type="text" class="cell-input name-input-ur father-ur" placeholder="ولدیت" value="${fatherUr}"></td>
                <td class="p-0 border" style="direction: ltr;"><input type="text" class="cell-input name-input-en father-en" placeholder="Father" value="${fatherEn}"></td>
                <td class="p-0 border"><input type="text" class="cell-input eng-font dob-input" placeholder="D-M-Y" value="${dob}"></td>
                ${inputsHTML}
                <td class="font-bold bg-gray-50 text-gray-600 text-[10px] text-center">${TOTAL_MARKS}</td>
                <td class="font-bold text-blue-700 cell-obtained bg-blue-50 text-[10px] text-center">0</td>
                <td class="font-bold text-indigo-700 cell-percent bg-indigo-50 text-[10px] text-center">0%</td>
                <td class="text-center p-1 cell-status text-xs">-</td>
                <td class="font-bold text-center p-1 cell-grade text-xs">-</td>
                <td class="font-bold text-center p-1 cell-rank text-xs text-gray-500">-</td>
                <td class="no-print text-center cursor-pointer text-red-300 hover:text-red-600" onclick="deleteRow(this)"><i class="fas fa-trash-alt"></i></td>
            `;
            tbody.appendChild(tr);
            updateIndices();
            if (data) calcRow(tr.querySelector('.subject-mark'));
        };

        window.calcRow = (inputElement) => {
            const row = inputElement.closest('tr');
            const isAbsent = (id) => { const el = row.querySelector(`input[data-id="${id}"]`); return el && el.value.trim().toUpperCase() === 'A'; };
            const getVal = (id) => { const el = row.querySelector(`input[data-id="${id}"]`); if(!el) return 0; const v = el.value.trim(); return (v === '' || v.toUpperCase() === 'A') ? 0 : (parseFloat(v) || 0); };
            const setStatus = (ids, isFail) => {
                ids.forEach(id => {
                    const el = row.querySelector(`input[data-id="${id}"]`);
                    if(el) {
                        el.style.color = isFail ? "#ef4444" : "#000";
                        el.style.fontWeight = isFail ? "bold" : "500";
                        el.style.backgroundColor = isFail ? "#fef2f2" : "transparent";
                    }
                });
            };

            let obtainedTotal = 0; let failCount = 0; let hasEntry = false;

            const engAbs = isAbsent('eng_written') || isAbsent('eng_oral');
            const engTotal = getVal('eng_written') + getVal('eng_oral');
            if (engAbs || engTotal < 33) { setStatus(['eng_written', 'eng_oral'], true); failCount++; } 
            else setStatus(['eng_written', 'eng_oral'], false);

            const urduAbs = isAbsent('urdu') || isAbsent('workbook') || isAbsent('ham_nisabi');
            const urduTotal = getVal('urdu') + getVal('workbook') + getVal('ham_nisabi');
            if (urduAbs || urduTotal < 40) { setStatus(['urdu', 'workbook', 'ham_nisabi'], true); failCount++; } 
            else setStatus(['urdu', 'workbook', 'ham_nisabi'], false);

            ['tajweed', 'imla'].forEach(sub => { if (isAbsent(sub) || getVal(sub) < 40) { setStatus([sub], true); failCount++; } else setStatus([sub], false); });
            if (isAbsent('riyazi') || getVal('riyazi') < 33) { setStatus(['riyazi'], true); failCount++; } else setStatus(['riyazi'], false);

            row.querySelectorAll('.subject-mark').forEach(inp => {
                const v = inp.value.trim();
                if(v !== "") { hasEntry = true; if(v.toUpperCase() !== 'A') { let max = parseInt(inp.dataset.max); let val = parseFloat(v); if(val > max) { inp.value = max; val = max; } obtainedTotal += val; } }
            });

            if (!hasEntry && !row.querySelector('.name-ur').value) return;

            const percent = (obtainedTotal / TOTAL_MARKS) * 100;
            row.querySelector('.cell-obtained').innerText = obtainedTotal;
            row.querySelector('.cell-percent').innerText = percent.toFixed(2);
            
            const statusCell = row.querySelector('.cell-status');
            let statusText = "ناکام"; 
            statusCell.classList.remove('cell-pass', 'cell-fail', 'cell-sup');

            if (failCount === 0) { statusText = "کامیاب"; statusCell.classList.add('cell-pass'); } 
            else if (failCount <= 2) { statusText = "مجاز ضمنی"; statusCell.classList.add('cell-sup'); } 
            else { statusText = "ناکام"; statusCell.classList.add('cell-fail'); }
            statusCell.innerText = statusText;

            const gradeCell = row.querySelector('.cell-grade');
            let grade = "D"; let gradeCls = "grade-D";
            if (failCount === 0) {
                if (percent >= 80) { grade = "A+"; gradeCls = "grade-A-plus"; }
                else if (percent >= 70) { grade = "A"; gradeCls = "grade-A"; }
                else if (percent >= 60) { grade = "B"; gradeCls = "grade-B"; }
                else if (percent >= 50) { grade = "C"; gradeCls = "grade-C"; }
                else { grade = "D"; gradeCls = "grade-D"; }
            } else { grade = "F"; gradeCls = "grade-D"; }
            gradeCell.innerText = grade;
            gradeCell.className = `font-bold text-center p-1 cell-grade text-xs ${gradeCls}`;

            // Auto Update Ranks on Change
            calculateRanks();
        };

        window.calculateRanks = () => {
            const tbody = document.getElementById('students-body');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            let data = rows.map(row => { const percStr = row.querySelector('.cell-percent').innerText; const perc = parseFloat(percStr) || 0; return { row: row, percentage: perc }; });
            data.sort((a, b) => b.percentage - a.percentage);
            let rank = 1;
            data.forEach((item, index) => {
                if (index > 0 && item.percentage === data[index - 1].percentage) { item.row.querySelector('.cell-rank').innerText = data[index - 1].row.querySelector('.cell-rank').innerText; } 
                else { item.row.querySelector('.cell-rank').innerText = rank; }
                rank++;
            });
        };

        // --- UPDATED SAVE: Saves the download setting ---
        window.saveResult = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...'; btn.disabled = true;
            calculateRanks(); 
            
            const examType = document.getElementById('exam-selector').value;
            const downloadSetting = document.getElementById('chk-allow-dl').checked; // Read Setting

            const rows = document.querySelectorAll('#students-body tr');
            const studentsToSave = [];
            rows.forEach(row => {
                const name = row.querySelector('.name-ur').value.trim();
                if (name) {
                    const marks = {};
                    row.querySelectorAll('.subject-mark').forEach(inp => { let v = inp.value.trim(); if(v.toUpperCase() === 'A') v = 'A'; marks[inp.dataset.id] = v; });
                    studentsToSave.push({
                        dakhila: row.querySelector('.dakhila-input').value.trim(),
                        name: name,
                        nameEng: row.querySelector('.name-en').value.trim(),
                        fatherName: row.querySelector('.father-ur').value.trim(),
                        fatherEng: row.querySelector('.father-en').value.trim(),
                        dob: row.querySelector('.dob-input').value.trim(),
                        marks: marks,
                        obtained: row.querySelector('.cell-obtained').innerText,
                        percent: row.querySelector('.cell-percent').innerText,
                        status: row.querySelector('.cell-status').innerText,
                        grade: row.querySelector('.cell-grade').innerText,
                        rank: row.querySelector('.cell-rank').innerText
                    });
                }
            });
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            try { 
                await setDoc(doc(db, "ibtidaiya_exams", docId), { 
                    adminUid, 
                    jamiaName, 
                    examType, 
                    year: globalYear, 
                    downloadEnabled: downloadSetting, // Saving the setting
                    students: studentsToSave, 
                    updatedAt: serverTimestamp() 
                });
                
                // Update UI immediately based on saved setting
                const dlBtn = document.getElementById('btn-download');
                dlBtn.style.display = downloadSetting ? 'flex' : 'none';

                alert("Result & Settings Saved Successfully!"); 
            } 
            catch (error) { console.error(error); alert("Error saving."); } 
            finally { btn.innerHTML = '<i class="fas fa-save"></i> Save Record'; btn.disabled = false; }
        };

        window.downloadPDF = async () => {
            if (!window.html2canvas) return;
            const btn = document.getElementById('btn-download');
            btn.innerText = "Generating PDF...";
            calculateRanks();

            const rowsPerPage = 20; 
            const allRows = Array.from(document.querySelectorAll('#students-body tr'));
            const totalPages = Math.ceil(allRows.length / rowsPerPage);
            
            const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4');
            const pageWidth = 297; 
            
            const examTitle = document.getElementById('sheet-title').innerText;
            const jamiaTitle = document.getElementById('display-jamia').innerText;
            const yearTitle = document.getElementById('display-year').value || document.getElementById('display-year').innerText;

            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.top = '-10000px'; tempContainer.style.width = '1400px'; 
            document.body.appendChild(tempContainer);

            const createPageHTML = (rowsSlice) => {
                let rowsHTML = "";
                rowsSlice.forEach(row => {
                    const dakhila = row.querySelector('.dakhila-input').value;
                    const nameUr = row.querySelector('.name-ur').value;
                    const nameEn = row.querySelector('.name-en').value;
                    const fatherUr = row.querySelector('.father-ur').value;
                    const fatherEn = row.querySelector('.father-en').value;
                    const dob = row.querySelector('.dob-input').value;
                    
                    let marksHTML = "";
                    row.querySelectorAll('.subject-mark').forEach(inp => {
                        const val = inp.value;
                        const color = inp.style.color;
                        const bg = inp.style.backgroundColor;
                        const weight = inp.style.fontWeight;
                        marksHTML += `<td style="border:1px solid #ccc; padding:6px; text-align:center; color:${color}; background:${bg}; font-weight:${weight}; font-family:sans-serif; font-size:14px;">${val}</td>`;
                    });

                    const total = row.querySelector('.cell-obtained').innerText;
                    const perc = row.querySelector('.cell-percent').innerText;
                    
                    const statusCell = row.querySelector('.cell-status');
                    const statusBg = getComputedStyle(statusCell).backgroundColor;
                    const statusColor = getComputedStyle(statusCell).color;
                    const statusText = statusCell.innerText;

                    const gradeCell = row.querySelector('.cell-grade');
                    const gradeColor = getComputedStyle(gradeCell).color;
                    const gradeText = gradeCell.innerText;
                    const rankText = row.querySelector('.cell-rank').innerText;
                    const indexText = row.cells[0].innerText;

                    rowsHTML += `
                        <tr>
                            <td style="border:1px solid #ccc; padding:6px; text-align:center; background:#1e3a8a; color:white;">${indexText}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:center;">${dakhila}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:right; font-family:'Jameel Noori Nastaleeq', serif; font-size:18px;">${nameUr}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:left; font-family:sans-serif;">${nameEn}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:right; font-family:'Jameel Noori Nastaleeq', serif; font-size:18px;">${fatherUr}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:left; font-family:sans-serif;">${fatherEn}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:center;">${dob}</td>
                            ${marksHTML}
                            <td style="border:1px solid #ccc; padding:6px; text-align:center; font-weight:bold; background:#f3f4f6;">${TOTAL_MARKS}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:center; font-weight:bold; color:blue;">${total}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:center; font-weight:bold; color:#4f46e5;">${perc}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:center; font-weight:bold; background-color:${statusBg}; color:${statusColor}; font-family:'Jameel Noori Nastaleeq'; font-size:16px;">${statusText}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:center; font-weight:bold; color:${gradeColor};">${gradeText}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:center; color:gray;">${rankText}</td>
                        </tr>
                    `;
                });

                return `
                    <div style="background:white; padding:20px; font-family:sans-serif;">
                        <div style="text-align:center; margin-bottom:15px; border-bottom:2px solid #312e81; padding-bottom:10px;">
                            <h1 style="font-family:'Jameel Noori Nastaleeq', serif; font-size:36px; color:#312e81; margin:0;">${examTitle}</h1>
                            <div style="display:flex; justify-content:center; gap:20px; margin-top:10px; font-family:'Jameel Noori Nastaleeq', serif; font-size:18px; color:#333;">
                                <div><span style="color:#666;">جامعۃ المدینہ:</span> <span style="font-weight:bold; color:#312e81;">${jamiaTitle}</span></div>
                                <div><span style="color:#666;">درجہ:</span> <span style="font-weight:bold; color:#312e81;">ابتدائیہ</span></div>
                                <div><span style="color:#666;">تعلیمی سال:</span> <span style="font-weight:bold; color:#312e81; font-family:sans-serif;">${yearTitle}</span></div>
                            </div>
                        </div>
                        <table style="width:100%; border-collapse:collapse; font-size:12px;">
                            <thead>
                                <tr style="color:white; font-family:'Jameel Noori Nastaleeq', serif; font-size:16px;">
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#1e3a8a;">#</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#1e3a8a;">داخلہ</th>
                                    <th style="border:1px solid #ccc; padding:8px; width:120px; background-color:#1e3a8a;">نام</th>
                                    <th style="border:1px solid #ccc; padding:8px; width:120px; font-family:sans-serif; background-color:#1e3a8a;">Name</th>
                                    <th style="border:1px solid #ccc; padding:8px; width:120px; background-color:#1e3a8a;">ولدیت</th>
                                    <th style="border:1px solid #ccc; padding:8px; width:120px; font-family:sans-serif; background-color:#1e3a8a;">Father</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#1e3a8a;">پیدائش</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#e0e7ff; color:#3730a3;">تجوید</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#e0e7ff; color:#3730a3;">ورک بک</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#e0e7ff; color:#3730a3;">اردو</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#e0e7ff; color:#3730a3;">ہم نصابی</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#e0e7ff; color:#3730a3;">املا</th>
                                    <th style="border:1px solid #ccc; padding:8px; font-family:sans-serif; font-size:10px; background-color:#e0e7ff; color:#3730a3;">Eng(W)</th>
                                    <th style="border:1px solid #ccc; padding:8px; font-family:sans-serif; font-size:10px; background-color:#e0e7ff; color:#3730a3;">Eng(O)</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#e0e7ff; color:#3730a3;">ریاضی</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#f3f4f6; color:#1f2937;">کل</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#f3f4f6; color:#1f2937;">حاصل</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#f3f4f6; color:#1f2937;">فیصد</th>
                                    <th style="border:1px solid #ccc; padding:8px; background-color:#f3f4f6; color:#1f2937;">کیفیت</th>
                                    <th style="border:1px solid #ccc; padding:8px; font-family:sans-serif; background-color:#1e3a8a;">G</th>
                                    <th style="border:1px solid #ccc; padding:8px; font-family:sans-serif; background-color:#1e3a8a;">Rank</th>
                                </tr>
                            </thead>
                            <tbody>${rowsHTML}</tbody>
                        </table>
                    </div>
                `;
            };

            for (let i = 0; i < totalPages; i++) {
                if (i > 0) pdf.addPage();
                const rowsSlice = allRows.slice(i * rowsPerPage, (i + 1) * rowsPerPage);
                tempContainer.innerHTML = createPageHTML(rowsSlice);
                const canvas = await html2canvas(tempContainer, { scale: 1.5, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = pageWidth; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            }

            document.body.removeChild(tempContainer);
            btn.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF';
            pdf.save(`Result_${jamiaName}.pdf`);
        };
    </script>
</body>
</html>

