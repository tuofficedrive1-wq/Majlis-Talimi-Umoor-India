<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibtidaiya Result Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Poppins', 'Noto Nastaliq Urdu', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Noto Nastaliq Urdu', serif; line-height: 2.0; font-size: 1.1rem; }
        .mark-input { text-align: center; font-weight: 500; }
        .mark-input:focus { background-color: #eff6ff; border-color: #3b82f6; }
        
        /* Custom Scrollbar for table */
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        /* Fail Input Style */
        .input-fail { color: #dc2626 !important; font-weight: bold !important; background-color: #fef2f2 !important; border-color: #fca5a5 !important; }

        /* Grades Colors */
        .grade-mumtaz { background-color: #15803d; color: white; } 
        .grade-jayyid { background-color: #eab308; color: white; } 
        .grade-pass { background-color: #22c55e; color: white; } 
        .grade-fail { background-color: #ef4444; color: white; } 
    </style>
</head>
<body class="p-4">

    <div class="max-w-[95%] mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg">Ibtidaiya Result (Primary Section)</p>
            <p class="text-sm text-teal-300 mt-1" id="display-month">...</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div id="result-area">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-edit text-teal-600"></i> Student Marks Entry
                    </h2>
                    
                    <div class="flex gap-2">
                         <div class="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded border border-blue-200">
                            <strong>Passing:</strong> 40%
                        </div>
                        <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 transition">
                            <i class="fas fa-plus mr-1"></i> Add Student
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto border rounded-lg shadow-sm table-container">
                    <table class="w-full text-sm text-left bg-white border-collapse whitespace-nowrap" id="result-table">
                        <thead class="bg-teal-50 text-teal-900 font-bold text-center" id="table-head">
                            </thead>
                        <tbody id="students-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                    <button onclick="saveResult()" id="btn-save" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-lg font-bold text-lg shadow-md transition flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Save Result
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-md transition flex justify-center items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let monthKey = "";
        
        // --- FIXED SUBJECTS CONFIGURATION (Image ke hisab se) ---
        // Note: Order code me LTR hai, lekin display hume logic ke hisab se karna hai.
        const fixedSubjects = [
            { id: "tajweed", name: "Tajweed", max: 100 },
            { id: "workbook", name: "Work Book", max: 40 },
            { id: "urdu", name: "Urdu", max: 40 },
            { id: "ham_nisabi", name: "Ham Nisabi", label: "Ham Nisabi Sargargamiyan", max: 20 },
            { id: "imla", name: "Imla", max: 100 },
            { id: "eng_written", name: "English (W)", label: "English (Tehreer)", max: 80 },
            { id: "eng_oral", name: "English (O)", label: "English (Taqreer)", max: 20 },
            { id: "riyazi", name: "Riyazi", max: 100 }
        ];

        let studentsData = [];

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            // Support both 'uid' and 'id' for backward compatibility
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Invalid Link! UID, Jamia, or Month is missing.");
                return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Result for: ${monthKey}`;

            await loadIbtidaiyaData();
        };

        // --- Load Data ---
        async function loadIbtidaiyaData() {
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_Ibtidaiya`;
            
            try {
                const docSnap = await getDoc(doc(db, "ibtidaiya_sheets", docId));
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) {
                        studentsData = data.students;
                    }
                }
                
                renderTableStructure();
                
                // Populate students if exist
                const tbody = document.getElementById('students-body');
                tbody.innerHTML = '';
                if(studentsData.length > 0) {
                    studentsData.forEach(std => addStudentRow(std.name, std.marks));
                } else {
                    addStudentRow(); // Empty row
                }

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

            } catch (error) {
                console.error("Error loading:", error);
                alert("Error loading data.");
            }
        }

        // --- Table Structure ---
        function renderTableStructure() {
            const head = document.getElementById('table-head');
            
            // Grand Total Max Calculate
            let grandMax = fixedSubjects.reduce((acc, sub) => acc + sub.max, 0);

            let cols = `<th class="px-4 py-3 border w-10 bg-gray-100">#</th>
                        <th class="px-4 py-3 border text-left min-w-[150px] bg-gray-100">Talib-e-Ilm</th>`;
            
            // Subjects Loop (Reverse order agar Urdu flow chahiye, but table LTR hai to seedha rakhte hain)
            // Image me Tajweed Right pe tha, Riyazi Left pe. 
            // Agar hume Urdu style chahiye to array reverse kar sakte hain.
            // Filhal array order me render kar rahe hain.
            
            fixedSubjects.forEach(sub => {
                cols += `<th class="px-2 py-3 border urdu-font bg-teal-50">
                            ${sub.label || sub.name}
                            <br><span class="text-xs font-normal text-teal-700">/${sub.max}</span>
                         </th>`;
            });
            
            cols += `<th class="px-4 py-3 border bg-gray-100">Total <span class="text-xs font-normal">/${grandMax}</span></th>
                     <th class="px-4 py-3 border bg-gray-100">%</th>
                     <th class="px-4 py-3 border bg-gray-100">Grade</th>
                     <th class="px-2 py-3 border text-red-500 bg-gray-100 no-print"><i class="fas fa-trash"></i></th>`;
            
            head.innerHTML = `<tr>${cols}</tr>`;
        }

        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50 transition";

            let inputs = "";
            fixedSubjects.forEach(sub => {
                const val = marks[sub.id] || "";
                
                inputs += `<td class="border p-1">
                            <input type="number" 
                                   data-sub-id="${sub.id}" 
                                   data-max="${sub.max}"
                                   value="${val}" 
                                   class="w-full p-2 text-center outline-none mark-input border border-transparent focus:border-blue-300 rounded" 
                                   oninput="calcRow(this)" 
                                   placeholder="-">
                           </td>`;
            });

            tr.innerHTML = `
                <td class="border p-2 text-center text-gray-500 bg-gray-50 font-bold">${index}</td>
                <td class="border p-1"><input type="text" value="${name}" placeholder="Naam likhein" class="w-full p-2 font-semibold urdu-font outline-none std-name bg-transparent"></td>
                ${inputs}
                <td class="border p-2 text-center font-bold text-gray-800 total-val bg-gray-50">-</td>
                <td class="border p-2 text-center font-bold text-blue-700 perc-val bg-gray-50">-</td>
                <td class="border p-2 text-center font-bold text-xs grade-val bg-gray-50">-</td>
                <td class="border p-2 text-center cursor-pointer text-red-400 hover:text-red-600 no-print" onclick="this.parentElement.remove()">Ã—</td>
            `;
            tbody.appendChild(tr);
            
            // Agar data load hua hai to calculation run karein
            if(name) calcRow(tr.querySelector('input.mark-input'));
        };

        window.calcRow = (el) => {
            const row = el.closest('tr');
            const inputs = row.querySelectorAll('.mark-input');
            
            let obtained = 0;
            let grandTotalMax = 0;
            let failCount = 0; // Kitne subjects me fail hai

            inputs.forEach(inp => {
                const max = parseInt(inp.dataset.max);
                grandTotalMax += max;
                
                let valStr = inp.value;
                if (valStr !== "") {
                    let val = parseFloat(valStr);
                    
                    // Validate Max Marks
                    if(val > max) { 
                        // alert(`Max marks ${max} hain.`); 
                        inp.value = max; 
                        val = max; 
                    }
                    
                    obtained += val;

                    // Passing Criteria: 40% of Max
                    const passingMarks = max * 0.40;
                    
                    if (val < passingMarks) {
                        inp.classList.add('input-fail'); // Red color class
                        failCount++;
                    } else {
                        inp.classList.remove('input-fail');
                    }
                }
            });

            // Calculate Percentage
            const percentage = grandTotalMax > 0 ? (obtained / grandTotalMax) * 100 : 0;
            
            // UI Update
            row.querySelector('.total-val').innerText = obtained;
            row.querySelector('.perc-val').innerText = percentage.toFixed(1) + '%';
            
            const gradeCell = row.querySelector('.grade-val');
            
            // Grade Logic (Based on Percentage & Fail Count)
            let grade = "Fail";
            let gradeClass = "grade-fail";

            // Agar 3 se zyada me fail hai to seedha Fail
            /*
               Note: User ne explicit logic nahi bataya fail count ka, 
               bas "40 se paas hai" kaha. Hum standard logic use karte hain.
            */
            
            if (percentage >= 80) {
                grade = "Mumtaz";
                gradeClass = "grade-mumtaz";
            } else if (percentage >= 60) {
                grade = "Jayyid";
                gradeClass = "grade-jayyid";
            } else if (percentage >= 40) {
                grade = "Pass";
                gradeClass = "grade-pass";
            } else {
                grade = "Fail";
                gradeClass = "grade-fail";
            }

            // Agar fail subjects hain to thoda indicate kar sakte hain, par abhi simple rakhte hain
            gradeCell.innerText = grade;
            gradeCell.className = `grade-val px-2 py-1 text-center font-bold text-xs border rounded shadow-sm ${gradeClass}`;
        };

        // --- Save Data ---
        window.saveResult = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerText = "Saving...";
            btn.disabled = true;

            const rows = document.querySelectorAll('#students-body tr');
            const studentsToSave = [];
            
            rows.forEach(row => {
                const name = row.querySelector('.std-name').value.trim();
                if(name) {
                    const marks = {};
                    row.querySelectorAll('.mark-input').forEach(inp => {
                        marks[inp.dataset.subId] = inp.value.trim();
                    });
                    
                    // Extra calculations bhi save kar lete hain for ease
                    const total = row.querySelector('.total-val').innerText;
                    const perc = row.querySelector('.perc-val').innerText;
                    
                    studentsToSave.push({ name, marks, total, percentage: perc });
                }
            });

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_Ibtidaiya`;

            try {
                await setDoc(doc(db, "ibtidaiya_sheets", docId), {
                    adminUid,
                    jamiaName,
                    month: monthKey,
                    class: "Ibtidaiya",
                    subjects: fixedSubjects, // Save structure too
                    students: studentsToSave,
                    updatedAt: serverTimestamp()
                });

                alert("Result Successfully Saved!");
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error saving data: " + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-save"></i> Save Result';
                btn.disabled = false;
            }
        };

        // --- PDF Generation ---
        window.downloadPDF = async () => {
            if (!window.html2canvas) { alert("Library missing."); return; }
            
            const element = document.getElementById('result-area');
            const originalBtnArea = document.querySelector('.mt-8');
            const addBtnArea = document.querySelector('.flex.gap-2'); // Header buttons
            
            // Hide Buttons for Print
            if(originalBtnArea) originalBtnArea.style.display = 'none';
            if(addBtnArea) addBtnArea.style.display = 'none';

            // Add Header Info for PDF
            const pdfHeader = document.createElement('div');
            pdfHeader.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px; font-family: sans-serif;">
                    <h2 style="font-size: 24px; font-weight: bold; color: #115e59;">${jamiaName}</h2>
                    <h3 style="font-size: 18px; color: #555;">Ibtidaiya Result Sheet - ${monthKey}</h3>
                </div>
            `;
            element.prepend(pdfHeader);

            const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4');
            
            await html2canvas(element, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 280; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save(`Ibtidaiya_${jamiaName}_${monthKey}.pdf`);
            });

            // Cleanup
            pdfHeader.remove();
            if(originalBtnArea) originalBtnArea.style.display = 'flex';
            if(addBtnArea) addBtnArea.style.display = 'flex';
        };
    </script>
</body>
</html>
