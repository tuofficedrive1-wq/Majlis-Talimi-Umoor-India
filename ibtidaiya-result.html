<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibtidaiya Result Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Jameel Noori Font Definition */
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body { 
            font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; 
            background-color: #eef2ff; /* Light Indigo BG */
        }
        
        .urdu-font { 
            font-family: 'Jameel Noori Nastaleeq', serif; 
            line-height: 1.6; 
        }
        
        .eng-font { 
            font-family: 'Poppins', sans-serif; 
            direction: ltr; 
        }
        
        /* Table Styling */
        table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.95rem; } 
        th { background-color: #e0e7ff; color: #3730a3; font-weight: bold; padding: 8px; border: 1px solid #c7d2fe; font-family: 'Jameel Noori Nastaleeq'; font-size: 1rem; }
        td { border: 1px solid #e5e7eb; padding: 4px; text-align: center; vertical-align: middle; background-color: white; }
        
        /* Headers Specifics (New Theme) */
        .header-dark { background-color: #312e81 !important; color: white !important; border-color: #3730a3 !important; } /* Dark Indigo */
        .header-light { background-color: #e0e7ff !important; color: #312e81 !important; border-color: #c7d2fe !important; }
        
        /* Input Styling */
        .cell-input { 
            width: 100%; 
            border: 1px solid transparent; 
            border-radius: 4px;
            background: #f9fafb; 
            text-align: center; 
            outline: none; 
            padding: 6px; /* Padding badhayi */
            font-family: 'Poppins', sans-serif; 
            font-weight: 500;
            transition: all 0.2s;
            -moz-appearance: textfield; 
        }
        
        .cell-input::-webkit-outer-spin-button,
        .cell-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .cell-input:focus { background-color: #fff; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        
        /* Name Inputs */
        .name-input { 
            font-family: 'Jameel Noori Nastaleeq', serif; 
            text-align: right; 
            width: 100%; 
            min-width: 120px; 
            font-size: 1.1rem; 
            padding-right: 8px;
        }
        
        /* Select & Inputs in Header */
        .header-input {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s;
        }
        .header-input:focus {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: white;
        }
        .header-input option { color: #333; }

        /* Status Badges */
        .status-pass { background-color: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 9999px; font-weight: bold; font-size: 0.8rem; border: 1px solid #86efac; font-family: 'Jameel Noori Nastaleeq'; }
        .status-fail { background-color: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 9999px; font-weight: bold; font-size: 0.8rem; border: 1px solid #fca5a5; font-family: 'Jameel Noori Nastaleeq'; }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-[98%] mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-indigo-200 min-h-screen">
        
        <div class="bg-indigo-900 text-white p-6 text-center relative shadow-md">
            <h1 class="text-3xl font-bold mb-2 urdu-font tracking-wide">نتیجہ سالانہ / ششماہی امتحان</h1>
            <h2 class="text-xl text-indigo-200 font-semibold urdu-font" id="display-jamia">Loading...</h2>
            
            <div class="flex flex-wrap justify-center items-end gap-4 mt-6 no-print">
                
                <div class="flex flex-col items-start">
                    <label class="text-xs font-bold text-indigo-200 mb-1 urdu-font">امتحان منتخب کریں</label>
                    <select id="exam-selector" class="header-input w-48 urdu-font cursor-pointer h-10" onchange="loadExamData()">
                        <option value="Shashmahi">ششماہی امتحان</option>
                        <option value="Salana">سالانہ امتحان</option>
                    </select>
                </div>

                <div class="flex flex-col items-start">
                    <label class="text-xs font-bold text-indigo-200 mb-1 urdu-font">تعلیمی سال</label>
                    <input type="text" id="academic-year" class="header-input w-36 text-center eng-font h-10" value="1447H - 2026">
                </div>

                <button onclick="loadExamData()" class="h-10 bg-indigo-500 hover:bg-indigo-400 text-white font-bold px-6 rounded-md shadow-lg transition transform hover:scale-105 text-sm flex items-center gap-2 border border-indigo-400">
                    <i class="fas fa-sync-alt"></i> Load Data
                </button>

            </div>
        </div>

        <div id="loader" class="text-center py-20"><div class="loader mx-auto"></div><p class="mt-4 text-indigo-600 font-semibold">Loading Result Sheet...</p></div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="flex justify-between items-center mb-4 no-print">
                <div class="text-sm bg-red-50 text-red-700 px-4 py-2 rounded-lg border border-red-200 font-bold flex items-center gap-2 urdu-font shadow-sm">
                    <i class="fas fa-exclamation-circle"></i> پاسنگ مارکس: 40% (ہر مضمون میں)
                </div>
                <button onclick="addStudentRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow-md transition flex items-center gap-2 urdu-font font-bold">
                    <i class="fas fa-plus"></i> طالب علم شامل کریں
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-300 shadow-sm" id="sheet-area">
                <div class="flex justify-between bg-indigo-50 p-3 border-b border-indigo-200 font-bold text-indigo-900 text-sm">
                    <span class="w-1/3 text-right urdu-font text-lg">جامعات المدینہ للبنین ہند (دعوت اسلامی)</span>
                    <span class="w-1/3 text-center text-xl urdu-font">ابتدائیہ</span>
                    <span class="w-1/3 text-left pl-4 urdu-font text-lg">درجہ</span>
                </div>

                <table id="result-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-dark w-12 rounded-tr-lg">نمبر<br>شمار</th>
                            <th rowspan="2" class="header-dark w-48">نام</th>
                            <th rowspan="2" class="header-dark w-40">ولدیت</th>
                            
                            <th class="header-light">تجوید</th>
                            <th class="header-light">ورک بک</th>
                            <th class="header-light">اردو</th>
                            <th class="header-light">ہم نصابی<br>سرگرمیاں</th>
                            <th class="header-light">املا</th>
                            <th class="header-light">انگلش<br>(تحریری)</th>
                            <th class="header-light">انگلش<br>(تقریری)</th>
                            <th class="header-light">ریاضی</th>
                            
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">کل<br>نمبر</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">حاصل کردہ<br>نمبر</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">فیصد</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">پیپرز میں<br>ناکام</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-28 border-gray-300 rounded-tl-lg">کیفیت</th>
                            <th rowspan="2" class="no-print bg-white border-0 w-10"></th>
                        </tr>
                        <tr>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">100</th> <th class="eng-font bg-white text-indigo-700 border-indigo-100">40</th>  <th class="eng-font bg-white text-indigo-700 border-indigo-100">40</th>  <th class="eng-font bg-white text-indigo-700 border-indigo-100">20</th>  <th class="eng-font bg-white text-indigo-700 border-indigo-100">100</th> <th class="eng-font bg-white text-indigo-700 border-indigo-100">80</th>  <th class="eng-font bg-white text-indigo-700 border-indigo-100">20</th>  <th class="eng-font bg-white text-indigo-700 border-indigo-100">100</th> </tr>
                    </thead>
                    <tbody id="students-body" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>

            <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-end border-t border-gray-200 pt-6 no-print">
                <button onclick="saveResult()" id="btn-save" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition transform hover:scale-105">
                    <i class="fas fa-save"></i> Save Record
                </button>
                <button onclick="downloadPDF()" class="bg-red-700 hover:bg-red-800 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition transform hover:scale-105">
                    <i class="fas fa-file-pdf"></i> Download Result Sheet
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let globalYear = "1447H-2026"; 
        
        // --- Fixed Subject Configuration ---
        const subjectsConfig = [
            { id: "tajweed", name: "تجوید", max: 100, pass: 40 },
            { id: "workbook", name: "ورک بک", max: 40, pass: 16 },
            { id: "urdu", name: "اردو", max: 40, pass: 16 },
            { id: "ham_nisabi", name: "ہم نصابی", max: 20, pass: 8 },
            { id: "imla", name: "املا", max: 100, pass: 40 },
            { id: "eng_written", name: "انگلش (تحریری)", max: 80, pass: 32 },
            { id: "eng_oral", name: "انگلش (تقریری)", max: 20, pass: 8 },
            { id: "riyazi", name: "ریاضی", max: 100, pass: 40 }
        ];

        const TOTAL_MARKS = 500;
        let studentsData = [];

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            
            if (!adminUid || !jamiaName) {
                alert("Link Invalid. Missing UID or Jamia Name."); return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            await loadExamData();
        };

        window.loadExamData = async () => {
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            
            loader.classList.remove('hidden');
            mainContent.classList.add('hidden');

            const examType = document.getElementById('exam-selector').value; 
            const academicYearVal = document.getElementById('academic-year').value;
            globalYear = academicYearVal.replace(/\s/g, '');

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            
            try {
                const docSnap = await getDoc(doc(db, "ibtidaiya_exams", docId));
                studentsData = [];
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) studentsData = data.students;
                }

                const tbody = document.getElementById('students-body');
                tbody.innerHTML = '';
                
                if(studentsData.length > 0) {
                    studentsData.forEach(std => addStudentRow(std));
                } else {
                    for(let i=0; i<5; i++) addStudentRow(); 
                }

                loader.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (error) {
                console.error("Error:", error);
                alert("Data load karne me masla aaya.");
            }
        };

        window.addStudentRow = (data = null) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-indigo-50 transition duration-150"; 
            
            const name = data ? data.name : "";
            const fatherName = data ? data.fatherName : "";
            const marks = data ? data.marks : {};

            let inputsHTML = "";
            
            subjectsConfig.forEach(sub => {
                const val = marks[sub.id] || "";
                inputsHTML += `
                    <td class="p-1">
                        <input type="number" 
                            class="cell-input subject-mark focus:ring-2 focus:ring-indigo-200" 
                            data-id="${sub.id}" 
                            data-max="${sub.max}" 
                            data-pass="${sub.pass}"
                            value="${val}"
                            placeholder="-"
                            oninput="calcRow(this)"
                        >
                    </td>`;
            });

            tr.innerHTML = `
                <td class="eng-font bg-gray-50 font-bold text-gray-500">${index}</td>
                <td class="p-1"><input type="text" class="cell-input name-input font-semibold text-gray-800" placeholder="نام" value="${name}"></td>
                <td class="p-1"><input type="text" class="cell-input name-input text-gray-600" placeholder="ولدیت" value="${fatherName}"></td>
                
                ${inputsHTML}

                <td class="eng-font font-bold bg-gray-100 text-gray-700">${TOTAL_MARKS}</td>
                <td class="eng-font font-bold text-blue-700 cell-obtained bg-blue-50">0</td>
                <td class="eng-font font-bold text-indigo-700 cell-percent bg-indigo-50">0%</td>
                <td class="eng-font font-bold text-red-600 cell-fail-count bg-red-50">0</td>
                <td class="urdu-font text-xs flex justify-center items-center h-full py-2"><span class="cell-status px-2 py-1 rounded">-</span></td>
                <td class="no-print text-center cursor-pointer text-red-300 hover:text-red-600 transition" onclick="this.parentElement.remove()"><i class="fas fa-trash-alt"></i></td>
            `;

            tbody.appendChild(tr);
            if (data) calcRow(tr.querySelector('.subject-mark'));
        };

        window.calcRow = (inputElement) => {
            const row = inputElement.closest('tr');
            
            // --- Helper Functions ---
            // Value lene ke liye
            const getVal = (id) => {
                const el = row.querySelector(`input[data-id="${id}"]`);
                // Agar khali hai ya number nahi hai to 0 maano
                return el && el.value !== "" ? parseFloat(el.value) : 0;
            };

            // Color set karne ke liye (Pass/Fail)
            const setStatus = (ids, isFail) => {
                ids.forEach(id => {
                    const el = row.querySelector(`input[data-id="${id}"]`);
                    if(el) {
                        if(isFail) {
                            el.style.color = "#ef4444"; // Red
                            el.style.fontWeight = "bold";
                            el.style.backgroundColor = "#fef2f2"; // Light Red Bg
                        } else {
                            el.style.color = "#000"; // Black
                            el.style.fontWeight = "500";
                            el.style.backgroundColor = "#f9fafb"; // Normal Bg
                        }
                    }
                });
            };

            let obtainedTotal = 0;
            let failCount = 0; // Kitne "Subjects/Groups" me fail hai

            // ==========================================
            // 1. ENGLISH GROUP CHECK (Total 100, Pass 40)
            // ==========================================
            const engWritten = getVal('eng_written');
            const engOral = getVal('eng_oral');
            const engTotal = engWritten + engOral;

            if (engTotal < 40) {
                // Agar dono mila ke 40 se kam hai to FAIL
                setStatus(['eng_written', 'eng_oral'], true);
                failCount++; 
            } else {
                // Agar 40 ya zyada hai to PASS (Chahe Written me 0 hi kyun na ho)
                setStatus(['eng_written', 'eng_oral'], false);
            }

            // ==========================================
            // 2. URDU GROUP CHECK (Total 100, Pass 40)
            // ==========================================
            const urdu = getVal('urdu');
            const workbook = getVal('workbook');
            const hamNisabi = getVal('ham_nisabi');
            const urduTotal = urdu + workbook + hamNisabi;

            if (urduTotal < 40) {
                // Agar teeno mila ke 40 se kam hai to FAIL
                setStatus(['urdu', 'workbook', 'ham_nisabi'], true);
                failCount++;
            } else {
                setStatus(['urdu', 'workbook', 'ham_nisabi'], false);
            }

            // ==========================================
            // 3. INDEPENDENT SUBJECTS CHECK (Total 100, Pass 40)
            // ==========================================
            const singles = ['tajweed', 'imla', 'riyazi'];
            
            singles.forEach(sub => {
                const marks = getVal(sub);
                if (marks < 40) {
                    setStatus([sub], true); // Fail
                    failCount++;
                } else {
                    setStatus([sub], false); // Pass
                }
            });

            // ==========================================
            // 4. TOTAL & PERCENTAGE CALCULATION
            // ==========================================
            // Sare inputs ka simple sum (Total marks obtained)
            row.querySelectorAll('.subject-mark').forEach(inp => {
                if(inp.value !== "") {
                    // Limit check (Validation)
                    const max = parseInt(inp.dataset.max);
                    if(parseFloat(inp.value) > max) {
                        inp.value = max; // Auto correct max marks
                    }
                    obtainedTotal += parseFloat(inp.value);
                }
            });

            const percent = (obtainedTotal / 500) * 100;

            // Update UI
            row.querySelector('.cell-obtained').innerText = obtainedTotal;
            row.querySelector('.cell-percent').innerText = percent.toFixed(2);
            row.querySelector('.cell-fail-count').innerText = failCount;

            const statusCell = row.querySelector('.cell-status');
            
            // Final Status Logic
            if (failCount > 0) {
                statusCell.innerText = "ناکام";
                statusCell.className = "cell-status status-fail";
            } else {
                statusCell.innerText = "کامیاب";
                statusCell.className = "cell-status status-pass";
            }
        };

        window.saveResult = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            const examType = document.getElementById('exam-selector').value;
            const rows = document.querySelectorAll('#students-body tr');
            const studentsToSave = [];

            rows.forEach(row => {
                const name = row.querySelector('.name-input').value.trim();
                const fatherName = row.querySelector('.std-father')?.value.trim() || ""; 
                
                if (name) {
                    const marks = {};
                    row.querySelectorAll('.subject-mark').forEach(inp => {
                        marks[inp.dataset.id] = inp.value;
                    });
                    
                    const obtained = row.querySelector('.cell-obtained').innerText;
                    const percent = row.querySelector('.cell-percent').innerText;
                    const status = row.querySelector('.cell-status').innerText;
                    const failCount = row.querySelector('.cell-fail-count').innerText;

                    studentsToSave.push({ name, fatherName, marks, obtained, percent, status, failCount });
                }
            });

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;

            try {
                await setDoc(doc(db, "ibtidaiya_exams", docId), {
                    adminUid, jamiaName, examType, year: globalYear,
                    students: studentsToSave,
                    updatedAt: serverTimestamp()
                });
                alert("Result Successfully Saved!");
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error: " + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-save"></i> Save Record';
                btn.disabled = false;
            }
        };

        window.downloadPDF = async () => {
            if (!window.html2canvas) return;
            
            const area = document.getElementById('sheet-area');
            const btnDiv = document.querySelector('.mt-8'); 
            
            btnDiv.style.display = 'none';
            document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none');

            const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4');
            
            await html2canvas(document.body, { 
                scale: 1.5,
                windowWidth: 1400 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 290; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 5, 5, imgWidth, imgHeight);
                pdf.save(`Result_${jamiaName}_${globalYear}.pdf`);
            });

            btnDiv.style.display = 'flex';
            document.querySelectorAll('.no-print').forEach(e => e.style.display = '');
            window.location.reload(); 
        };
    </script>
</body>
</html>

