<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibtidaiya Result Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2');
            font-display: swap;
        }
        body { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; background-color: #f8fafc; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .eng-font { font-family: 'Poppins', sans-serif; direction: ltr; }
        
        /* Table Styling */
        table { border-collapse: collapse; width: 100%; font-size: 0.85rem; table-layout: auto; } 
        th { background-color: #e0e7ff; color: #312e81; font-weight: bold; padding: 6px 4px; border: 1px solid #c7d2fe; text-align: center; vertical-align: middle; white-space: nowrap; }
        td { border: 1px solid #cbd5e1; padding: 2px 4px; text-align: center; vertical-align: middle; background-color: white; white-space: nowrap; }
        
        .header-dark { background-color: #312e81 !important; color: white !important; border-color: #3730a3 !important; }
        .header-light { background-color: #e0e7ff !important; color: #312e81 !important; }
        
        /* Inputs Styling */
        .cell-input { width: 100%; min-width: 40px; border: none; background: transparent; text-align: center; outline: none; padding: 4px 2px; font-family: 'Poppins', sans-serif; font-size: 0.85rem; }
        .cell-input:focus { background-color: #eff6ff; }
        
        /* Urdu Inputs (Auto Width) */
        .name-input-ur { 
            font-family: 'Jameel Noori Nastaleeq', serif; 
            text-align: right; 
            min-width: 140px; 
            font-size: 1rem; 
            padding-right: 5px;
        }
        
        /* English Inputs */
        .name-input-en { 
            font-family: 'Poppins', sans-serif; 
            text-align: left; 
            direction: ltr; 
            min-width: 140px; 
            font-size: 0.8rem; 
            padding-left: 5px;
        }
        
        /* Status Badges */
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; display: inline-block; }
        .bg-pass { background-color: #dcfce7; color: #166534; }
        .bg-fail { background-color: #fee2e2; color: #991b1b; }
        .bg-sup { background-color: #f3e8ff; color: #6b21a8; }

        /* Grades Colors */
        .grade-A-plus { color: #15803d; font-weight: bold; } 
        .grade-A { color: #16a34a; font-weight: bold; } 
        .grade-B { color: #2563eb; font-weight: bold; } 
        .grade-C { color: #ca8a04; font-weight: bold; } 
        .grade-D { color: #dc2626; font-weight: bold; } 

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-[99%] mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-indigo-100 min-h-screen">
        
        <div class="bg-indigo-900 text-white p-3 shadow-md no-print">
            <div class="flex justify-between items-center flex-wrap gap-2">
                <div>
                    <h1 class="text-xl font-bold urdu-font">Ibtidaiya Result Control Panel</h1>
                </div>
                <div class="flex gap-2 items-center">
                    <select id="exam-selector" class="text-black text-xs p-1.5 rounded" onchange="updateHeaders(); loadExamData();">
                        <option value="Shashmahi">ششماہی امتحان (Half Yearly)</option>
                        <option value="Salana">سالانہ امتحان (Annual)</option>
                    </select>
                    <input type="text" id="academic-year" class="text-black text-xs p-1.5 rounded w-32 text-center" value="1447H - 2026">
                    <button onclick="updateHeaders(); loadExamData();" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded text-xs border border-indigo-400">Load Data</button>
                </div>
            </div>
        </div>

        <div id="loader" class="text-center py-20"><i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i></div>

        <div id="main-content" class="p-2 hidden">
            
            <div class="flex justify-end mb-2 no-print gap-2">
                <button onclick="calculateRanks()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                    <i class="fas fa-sort-numeric-down"></i> Update Ranks
                </button>
                <button onclick="addStudentRow()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                    <i class="fas fa-plus"></i> Add Student
                </button>
            </div>

            <div class="overflow-x-auto rounded border border-gray-300" id="sheet-area">
                
                <div class="bg-white p-4 border-b-2 border-indigo-900">
                    
                    <div class="text-center mb-3">
                        <h1 class="text-4xl font-bold text-indigo-900 urdu-font" id="sheet-title">نتیجہ امتحان</h1>
                    </div>
                    
                    <div class="text-center">
                        <div class="inline-flex flex-wrap justify-center items-center gap-x-6 gap-y-2 text-sm font-semibold text-gray-700 urdu-font bg-gray-50 py-2 px-8 rounded-lg border border-gray-200 shadow-sm">
                            
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">جامعۃ المدینہ:</span>
                                <span id="display-jamia" class="text-indigo-800 font-bold text-lg">...</span>
                            </div>

                            <span class="text-gray-300 hidden sm:inline">|</span>

                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">درجہ:</span>
                                <span class="text-indigo-800 font-bold text-lg">ابتدائیہ</span>
                            </div>

                            <span class="text-gray-300 hidden sm:inline">|</span>

                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">تعلیمی سال:</span>
                                <span id="display-year" class="text-indigo-800 eng-font font-bold text-lg">...</span>
                            </div>

                        </div>
                    </div>

                </div>

                <table id="result-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-dark w-8">#</th>
                            <th rowspan="2" class="header-dark">داخلہ نمبر</th>
                            <th rowspan="2" class="header-dark">نام (اردو)</th>
                            <th rowspan="2" class="header-dark" style="direction: ltr;">Name (Eng)</th>
                            <th rowspan="2" class="header-dark">ولدیت (اردو)</th>
                            <th rowspan="2" class="header-dark" style="direction: ltr;">Father (Eng)</th>
                            <th rowspan="2" class="header-dark">تاریخ پیدائش</th>

                            <th class="header-light">تجوید</th>
                            <th class="header-light">ورک بک</th>
                            <th class="header-light">اردو</th>
                            <th class="header-light">ہم نصابی</th>
                            <th class="header-light">املا</th>
                            <th class="header-light">انگلش(W)</th>
                            <th class="header-light">انگلش(O)</th>
                            <th class="header-light">ریاضی</th>

                            <th rowspan="2" class="bg-gray-100">کل</th>
                            <th rowspan="2" class="bg-gray-100">حاصل</th>
                            <th rowspan="2" class="bg-gray-100">فیصد</th>
                            <th rowspan="2" class="bg-gray-100">کیفیت</th>
                            <th rowspan="2" class="header-dark">Grade</th>
                            <th rowspan="2" class="header-dark">Rank</th>
                            <th rowspan="2" class="no-print bg-white border-0 w-6"></th>
                        </tr>
                        <tr>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">100</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">40</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">40</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">20</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">100</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">70</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">30</th>
                            <th class="eng-font bg-white text-indigo-800 text-[10px]">100</th>
                        </tr>
                    </thead>
                    <tbody id="students-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div class="mt-4 flex gap-4 justify-end no-print">
                <button onclick="saveResult()" id="btn-save" class="bg-emerald-600 text-white px-6 py-2 rounded shadow hover:bg-emerald-700 font-bold text-sm">Save Record</button>
                <button onclick="downloadPDF()" id="btn-download" class="bg-red-700 text-white px-6 py-2 rounded shadow hover:bg-red-800 font-bold text-sm">Download PDF</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let globalYear = "1447H-2026"; 
        const TOTAL_MARKS = 500;

        const subjectsConfig = [
            { id: "tajweed", max: 100 }, { id: "workbook", max: 40 },
            { id: "urdu", max: 40 }, { id: "ham_nisabi", max: 20 },
            { id: "imla", max: 100 }, { id: "eng_written", max: 70 },
            { id: "eng_oral", max: 30 }, { id: "riyazi", max: 100 }
        ];

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            if (!adminUid || !jamiaName) { alert("Link Invalid."); return; }
            
            document.getElementById('display-jamia').textContent = jamiaName;
            await autoSelectExamType();
            updateHeaders();
            await loadExamData();
        };

        window.updateHeaders = () => {
            const selector = document.getElementById('exam-selector');
            const yearInput = document.getElementById('academic-year');
            const titleEl = document.getElementById('sheet-title');
            const displayYearEl = document.getElementById('display-year');
            
            let examName = selector.value === "Shashmahi" ? "نتیجہ ششماہی امتحان" : "نتیجہ سالانہ امتحان";
            titleEl.textContent = examName;
            displayYearEl.textContent = yearInput.value; 
        };

        async function autoSelectExamType() {
            const selector = document.getElementById('exam-selector');
            try {
                const userDoc = await getDoc(doc(db, "users", adminUid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.currentSemester == 1) { selector.value = "Shashmahi"; return; } 
                    else if (data.currentSemester == 2) { selector.value = "Salana"; return; }
                }
            } catch (error) { console.error(error); }
            const now = new Date();
            const month = now.getMonth() + 1; 
            if (month >= 1 && month <= 5) { selector.value = "Salana"; } 
            else { selector.value = "Shashmahi"; }
        }

        window.loadExamData = async () => {
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');

            const examType = document.getElementById('exam-selector').value; 
            const academicYearVal = document.getElementById('academic-year').value;
            globalYear = academicYearVal.replace(/\s/g, '');
            updateHeaders();

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            
            try {
                const docSnap = await getDoc(doc(db, "ibtidaiya_exams", docId));
                let studentsData = [];
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) studentsData = data.students;
                }
                const tbody = document.getElementById('students-body');
                tbody.innerHTML = '';
                if(studentsData.length > 0) studentsData.forEach(std => addStudentRow(std));
                else for(let i=0; i<5; i++) addStudentRow(); 
                
                calculateRanks(); 
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } catch (error) { console.error("Error:", error); alert("Data load error."); }
        };

        window.updateIndices = () => {
            const rows = document.querySelectorAll('#students-body tr');
            rows.forEach((row, index) => { row.cells[0].innerText = index + 1; });
        };

        window.deleteRow = (btn) => {
            if(confirm("Remove this student?")) {
                const row = btn.closest('tr');
                row.remove();
                updateIndices();
            }
        };

        window.addStudentRow = (data = null) => {
            const tbody = document.getElementById('students-body');
            const tr = document.createElement('tr');
            
            const dakhila = data ? (data.dakhila || "") : "";
            const nameUr = data ? (data.name || "") : "";
            const nameEn = data ? (data.nameEng || "") : "";
            const fatherUr = data ? (data.fatherName || "") : "";
            const fatherEn = data ? (data.fatherEng || "") : "";
            const dob = data ? (data.dob || "") : "";
            const marks = data ? data.marks : {};

            let inputsHTML = "";
            subjectsConfig.forEach(sub => {
                const val = marks[sub.id] || "";
                inputsHTML += `<td class="p-0 border"><input type="text" class="cell-input subject-mark" data-id="${sub.id}" data-max="${sub.max}" value="${val}" placeholder="-" oninput="calcRow(this)"></td>`;
            });

            tr.innerHTML = `
                <td class="font-bold text-gray-500 bg-gray-50"></td>
                <td class="p-0 border"><input type="text" class="cell-input eng-font dakhila-input" placeholder=".." value="${dakhila}"></td>
                
                <td class="p-0 border"><input type="text" class="cell-input name-input-ur name-ur" placeholder="نام" value="${nameUr}"></td>
                <td class="p-0 border" style="direction: ltr;"><input type="text" class="cell-input name-input-en name-en" placeholder="Name" value="${nameEn}"></td>
                <td class="p-0 border"><input type="text" class="cell-input name-input-ur father-ur" placeholder="ولدیت" value="${fatherUr}"></td>
                <td class="p-0 border" style="direction: ltr;"><input type="text" class="cell-input name-input-en father-en" placeholder="Father" value="${fatherEn}"></td>
                <td class="p-0 border"><input type="text" class="cell-input eng-font dob-input" placeholder="D-M-Y" value="${dob}"></td>
                
                ${inputsHTML}

                <td class="font-bold bg-gray-50 text-gray-600 text-[10px]">${TOTAL_MARKS}</td>
                <td class="font-bold text-blue-700 cell-obtained bg-blue-50 text-[10px]">0</td>
                <td class="font-bold text-indigo-700 cell-percent bg-indigo-50 text-[10px]">0%</td>
                <td class="text-center p-1"><span class="status-badge rounded">-</span></td>
                
                <td class="font-bold text-center p-1 cell-grade text-xs">-</td>
                <td class="font-bold text-center p-1 cell-rank text-xs text-gray-500">-</td>

                <td class="no-print text-center cursor-pointer text-red-300 hover:text-red-600" onclick="deleteRow(this)">
                    <i class="fas fa-trash-alt"></i>
                </td>
            `;
            
            tbody.appendChild(tr);
            updateIndices();
            if (data) calcRow(tr.querySelector('.subject-mark'));
        };

        window.calcRow = (inputElement) => {
            const row = inputElement.closest('tr');
            const isAbsent = (id) => { const el = row.querySelector(`input[data-id="${id}"]`); return el && el.value.trim().toUpperCase() === 'A'; };
            const getVal = (id) => { const el = row.querySelector(`input[data-id="${id}"]`); if(!el) return 0; const v = el.value.trim(); return (v === '' || v.toUpperCase() === 'A') ? 0 : (parseFloat(v) || 0); };
            const setStatus = (ids, isFail) => {
                ids.forEach(id => {
                    const el = row.querySelector(`input[data-id="${id}"]`);
                    if(el) {
                        el.style.color = isFail ? "#ef4444" : "#000";
                        el.style.fontWeight = isFail ? "bold" : "500";
                        el.style.backgroundColor = isFail ? "#fef2f2" : "transparent";
                    }
                });
            };

            let obtainedTotal = 0; let failCount = 0; let hasEntry = false;

            const engAbs = isAbsent('eng_written') || isAbsent('eng_oral');
            const engTotal = getVal('eng_written') + getVal('eng_oral');
            if (engAbs || engTotal < 33) { setStatus(['eng_written', 'eng_oral'], true); failCount++; } 
            else setStatus(['eng_written', 'eng_oral'], false);

            const urduAbs = isAbsent('urdu') || isAbsent('workbook') || isAbsent('ham_nisabi');
            const urduTotal = getVal('urdu') + getVal('workbook') + getVal('ham_nisabi');
            if (urduAbs || urduTotal < 40) { setStatus(['urdu', 'workbook', 'ham_nisabi'], true); failCount++; } 
            else setStatus(['urdu', 'workbook', 'ham_nisabi'], false);

            ['tajweed', 'imla'].forEach(sub => { if (isAbsent(sub) || getVal(sub) < 40) { setStatus([sub], true); failCount++; } else setStatus([sub], false); });
            if (isAbsent('riyazi') || getVal('riyazi') < 33) { setStatus(['riyazi'], true); failCount++; } else setStatus(['riyazi'], false);

            row.querySelectorAll('.subject-mark').forEach(inp => {
                const v = inp.value.trim();
                if(v !== "") {
                    hasEntry = true;
                    if(v.toUpperCase() !== 'A') {
                        let max = parseInt(inp.dataset.max);
                        let val = parseFloat(v);
                        if(val > max) { inp.value = max; val = max; }
                        obtainedTotal += val;
                    }
                }
            });

            if (!hasEntry && !row.querySelector('.name-ur').value) return;

            const percent = (obtainedTotal / TOTAL_MARKS) * 100;
            row.querySelector('.cell-obtained').innerText = obtainedTotal;
            row.querySelector('.cell-percent').innerText = percent.toFixed(2);
            
            const statusCell = row.querySelector('.status-badge');
            let statusText = "ناکام"; let statusClass = "bg-fail";

            if (failCount === 0) { statusText = "کامیاب"; statusClass = "bg-pass"; } 
            else if (failCount <= 2) { statusText = "مجاز ضمنی"; statusClass = "bg-sup"; } 
            else { statusText = "ناکام"; statusClass = "bg-fail"; }
            statusCell.innerText = statusText;
            statusCell.className = `status-badge ${statusClass}`;

            const gradeCell = row.querySelector('.cell-grade');
            let grade = "D"; let gradeCls = "grade-D";
            if (failCount === 0) {
                if (percent >= 80) { grade = "A+"; gradeCls = "grade-A-plus"; }
                else if (percent >= 70) { grade = "A"; gradeCls = "grade-A"; }
                else if (percent >= 60) { grade = "B"; gradeCls = "grade-B"; }
                else if (percent >= 50) { grade = "C"; gradeCls = "grade-C"; }
                else { grade = "D"; gradeCls = "grade-D"; }
            } else { grade = "F"; gradeCls = "grade-D"; }
            gradeCell.innerText = grade;
            gradeCell.className = `font-bold text-center p-1 cell-grade text-xs ${gradeCls}`;
        };

        window.calculateRanks = () => {
            const tbody = document.getElementById('students-body');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            let data = rows.map(row => { const percStr = row.querySelector('.cell-percent').innerText; const perc = parseFloat(percStr) || 0; return { row: row, percentage: perc }; });
            data.sort((a, b) => b.percentage - a.percentage);
            let rank = 1;
            data.forEach((item, index) => {
                if (index > 0 && item.percentage === data[index - 1].percentage) { item.row.querySelector('.cell-rank').innerText = data[index - 1].row.querySelector('.cell-rank').innerText; } 
                else { item.row.querySelector('.cell-rank').innerText = rank; }
                rank++;
            });
        };

        window.saveResult = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...'; btn.disabled = true;
            calculateRanks(); 
            const examType = document.getElementById('exam-selector').value;
            const rows = document.querySelectorAll('#students-body tr');
            const studentsToSave = [];
            rows.forEach(row => {
                const name = row.querySelector('.name-ur').value.trim();
                if (name) {
                    const marks = {};
                    row.querySelectorAll('.subject-mark').forEach(inp => { let v = inp.value.trim(); if(v.toUpperCase() === 'A') v = 'A'; marks[inp.dataset.id] = v; });
                    studentsToSave.push({
                        dakhila: row.querySelector('.dakhila-input').value.trim(),
                        name: name,
                        nameEng: row.querySelector('.name-en').value.trim(),
                        fatherName: row.querySelector('.father-ur').value.trim(),
                        fatherEng: row.querySelector('.father-en').value.trim(),
                        dob: row.querySelector('.dob-input').value.trim(),
                        marks: marks,
                        obtained: row.querySelector('.cell-obtained').innerText,
                        percent: row.querySelector('.cell-percent').innerText,
                        status: row.querySelector('.status-badge').innerText,
                        grade: row.querySelector('.cell-grade').innerText,
                        rank: row.querySelector('.cell-rank').innerText
                    });
                }
            });
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            try { await setDoc(doc(db, "ibtidaiya_exams", docId), { adminUid, jamiaName, examType, year: globalYear, students: studentsToSave, updatedAt: serverTimestamp() }); alert("Result Saved Successfully!"); } 
            catch (error) { console.error(error); alert("Error saving."); } 
            finally { btn.innerHTML = 'Save Record'; btn.disabled = false; }
        };

        window.downloadPDF = async () => {
            if (!window.html2canvas) return;
            const btn = document.getElementById('btn-download');
            btn.innerText = "Processing...";
            calculateRanks();
            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            
            // Fix: Replace inputs with div for PDF to avoid cutoff
            const inputs = document.querySelectorAll('input.cell-input');
            inputs.forEach(input => {
                const span = document.createElement('span');
                span.innerText = input.value;
                span.className = 'pdf-text-replace'; 
                span.style.fontFamily = getComputedStyle(input).fontFamily;
                span.style.fontSize = "10px"; 
                span.style.display = "block";
                span.style.width = "100%";
                span.style.textAlign = "center";
                input.style.display = 'none';
                input.parentNode.appendChild(span);
            });

            const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4');
            const pageWidth = 297; 
            await html2canvas(document.body, { scale: 1.5, windowWidth: 1600, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = pageWidth - 10; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                pdf.addImage(imgData, 'PNG', 5, 5, imgWidth, imgHeight);
                pdf.save(`Result_${jamiaName}.pdf`);
            });

            document.querySelectorAll('.pdf-text-replace').forEach(span => span.remove());
            inputs.forEach(input => input.style.display = '');
            document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
            btn.innerText = "Download PDF";
        };
    </script>
</body>
</html>
