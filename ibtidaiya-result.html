<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibtidaiya Result Sheet (Semester System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Noto Nastaliq Urdu', sans-serif; background-color: #f0fdfa; } /* Light Teal BG */
        .urdu-font { font-family: 'Noto Nastaliq Urdu', serif; }
        .eng-font { font-family: 'Poppins', sans-serif; direction: ltr; }
        
        /* Table Styling (Modern) */
        table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.9rem; }
        th { background-color: #f0fdfa; color: #115e59; font-weight: bold; padding: 10px; border: 1px solid #ccfbf1; }
        td { border: 1px solid #e5e7eb; padding: 6px; text-align: center; vertical-align: middle; background-color: white; }
        
        /* Headers Specifics */
        .header-dark { background-color: #0f766e !important; color: white !important; border-color: #115e59 !important; }
        .header-light { background-color: #ccfbf1 !important; color: #0f766e !important; border-color: #99f6e4 !important; }
        
        /* Input Styling */
        .cell-input { 
            width: 100%; 
            border: 1px solid transparent; 
            border-radius: 4px;
            background: #f9fafb; 
            text-align: center; 
            outline: none; 
            padding: 4px;
            font-family: 'Poppins', sans-serif; 
            font-weight: 500;
            transition: all 0.2s;
        }
        .cell-input:focus { background-color: #fff; border-color: #0d9488; box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2); }
        .name-input { font-family: 'Noto Nastaliq Urdu', serif; text-align: right; width: 100%; min-width: 120px; }
        
        /* Status Badges */
        .status-pass { background-color: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 9999px; font-weight: bold; font-size: 0.75rem; border: 1px solid #86efac; }
        .status-fail { background-color: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 9999px; font-weight: bold; font-size: 0.75rem; border: 1px solid #fca5a5; }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0f766e; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-[98%] mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100 min-h-screen">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold mb-2">نتیجہ سالانہ / ششماہی امتحان</h1>
            <h2 class="text-xl text-teal-200 font-semibold" id="display-jamia">Loading...</h2>
            
            <div class="flex flex-wrap justify-center gap-4 mt-6 items-end no-print">
                <div class="text-right">
                    <label class="block text-xs font-bold text-teal-200 mb-1">امتحان منتخب کریں</label>
                    <select id="exam-selector" class="border-2 border-teal-600 bg-teal-900 text-white rounded-lg p-2 text-sm w-48 urdu-font focus:outline-none focus:border-teal-400 cursor-pointer" onchange="loadExamData()">
                        <option value="Shashmahi">ششماہی امتحان (Half Yearly)</option>
                        <option value="Salana">سالانہ امتحان (Annual)</option>
                    </select>
                </div>
                <div class="text-right">
                    <label class="block text-xs font-bold text-teal-200 mb-1">تعلیمی سال</label>
                    <input type="text" id="academic-year" class="border-2 border-teal-600 bg-teal-900 text-white rounded-lg p-2 text-sm w-32 text-center eng-font focus:outline-none focus:border-teal-400" value="1447H - 2026">
                </div>
                <div>
                     <button onclick="loadExamData()" class="bg-teal-500 hover:bg-teal-400 text-teal-900 font-bold px-6 py-2 rounded-lg shadow-lg transition transform hover:scale-105 text-sm flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i> Load Data
                    </button>
                </div>
            </div>
        </div>

        <div id="loader" class="text-center py-20"><div class="loader mx-auto"></div><p class="mt-4 text-teal-600 font-semibold">Loading Result Sheet...</p></div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="flex justify-between items-center mb-4 no-print">
                <div class="text-sm bg-red-50 text-red-700 px-4 py-2 rounded-lg border border-red-200 font-bold flex items-center gap-2">
                    <i class="fas fa-exclamation-circle"></i> پاسنگ مارکس: 40% (ہر مضمون میں)
                </div>
                <button onclick="addStudentRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow-md transition flex items-center gap-2">
                    <i class="fas fa-plus"></i> طالب علم شامل کریں
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm" id="sheet-area">
                <div class="flex justify-between bg-teal-50 p-3 border-b border-teal-200 font-bold text-teal-800 text-sm">
                    <span class="w-1/3 text-right">جامعات المدینہ للبنین ہند (دعوت اسلامی)</span>
                    <span class="w-1/3 text-center text-lg">ابتدائیہ</span>
                    <span class="w-1/3 text-left pl-4">درجہ</span>
                </div>

                <table id="result-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-dark w-12 rounded-tr-lg">نمبر شمار</th>
                            <th rowspan="2" class="header-dark w-48">نام</th>
                            <th rowspan="2" class="header-dark w-40">ولدیت</th>
                            
                            <th class="header-light">تجوید</th>
                            <th class="header-light">ورک بک</th>
                            <th class="header-light">اردو</th>
                            <th class="header-light">ہم نصابی<br>سرگرمیاں</th>
                            <th class="header-light">املا</th>
                            <th class="header-light">انگلش<br>(تحریری)</th>
                            <th class="header-light">انگلش<br>(تقریری)</th>
                            <th class="header-light">ریاضی</th>
                            
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">کل<br>نمبر</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">حاصل کردہ<br>نمبر</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">فیصد</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">پیپرز میں<br>ناکام</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-28 border-gray-300 rounded-tl-lg">کیفیت</th>
                            <th rowspan="2" class="no-print bg-white border-0 w-10"></th>
                        </tr>
                        <tr>
                            <th class="eng-font bg-white text-teal-600 border-teal-100">100</th> <th class="eng-font bg-white text-teal-600 border-teal-100">40</th>  <th class="eng-font bg-white text-teal-600 border-teal-100">40</th>  <th class="eng-font bg-white text-teal-600 border-teal-100">20</th>  <th class="eng-font bg-white text-teal-600 border-teal-100">100</th> <th class="eng-font bg-white text-teal-600 border-teal-100">80</th>  <th class="eng-font bg-white text-teal-600 border-teal-100">20</th>  <th class="eng-font bg-white text-teal-600 border-teal-100">100</th> </tr>
                    </thead>
                    <tbody id="students-body" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>

            <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-end border-t pt-6 no-print">
                <button onclick="saveResult()" id="btn-save" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition transform hover:scale-105">
                    <i class="fas fa-save"></i> Save Record
                </button>
                <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition transform hover:scale-105">
                    <i class="fas fa-file-pdf"></i> Download Result Sheet
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let globalYear = "1447H-2026"; 
        
        // --- Fixed Subject Configuration (Based on Image) ---
        const subjectsConfig = [
            { id: "tajweed", name: "تجوید", max: 100, pass: 40 },
            { id: "workbook", name: "ورک بک", max: 40, pass: 16 },
            { id: "urdu", name: "اردو", max: 40, pass: 16 },
            { id: "ham_nisabi", name: "ہم نصابی", max: 20, pass: 8 },
            { id: "imla", name: "املا", max: 100, pass: 40 },
            { id: "eng_written", name: "انگلش (تحریری)", max: 80, pass: 32 },
            { id: "eng_oral", name: "انگلش (تقریری)", max: 20, pass: 8 },
            { id: "riyazi", name: "ریاضی", max: 100, pass: 40 }
        ];

        const TOTAL_MARKS = 500;
        let studentsData = [];

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            
            if (!adminUid || !jamiaName) {
                alert("Link Invalid. Missing UID or Jamia Name."); return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            await loadExamData();
        };

        window.loadExamData = async () => {
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            
            loader.classList.remove('hidden');
            mainContent.classList.add('hidden');

            const examType = document.getElementById('exam-selector').value; 
            const academicYearVal = document.getElementById('academic-year').value;
            globalYear = academicYearVal.replace(/\s/g, '');

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            
            try {
                const docSnap = await getDoc(doc(db, "ibtidaiya_exams", docId));
                studentsData = [];
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) studentsData = data.students;
                }

                const tbody = document.getElementById('students-body');
                tbody.innerHTML = '';
                
                if(studentsData.length > 0) {
                    studentsData.forEach(std => addStudentRow(std));
                } else {
                    for(let i=0; i<5; i++) addStudentRow(); // Default rows
                }

                loader.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (error) {
                console.error("Error:", error);
                alert("Data load karne me masla aaya.");
            }
        };

        window.addStudentRow = (data = null) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-teal-50 transition duration-150"; // Hover Effect
            
            const name = data ? data.name : "";
            const fatherName = data ? data.fatherName : "";
            const marks = data ? data.marks : {};

            let inputsHTML = "";
            
            subjectsConfig.forEach(sub => {
                const val = marks[sub.id] || "";
                inputsHTML += `
                    <td class="p-1">
                        <input type="number" 
                            class="cell-input subject-mark focus:ring-2 focus:ring-teal-200" 
                            data-id="${sub.id}" 
                            data-max="${sub.max}" 
                            data-pass="${sub.pass}"
                            value="${val}"
                            placeholder="-"
                            oninput="calcRow(this)"
                        >
                    </td>`;
            });

            tr.innerHTML = `
                <td class="eng-font bg-gray-50 font-bold text-gray-500">${index}</td>
                <td class="p-1"><input type="text" class="cell-input name-input font-semibold text-gray-800" placeholder="نام" value="${name}"></td>
                <td class="p-1"><input type="text" class="cell-input name-input text-gray-600" placeholder="ولدیت" value="${fatherName}"></td>
                
                ${inputsHTML}

                <td class="eng-font font-bold bg-gray-100 text-gray-700">${TOTAL_MARKS}</td>
                <td class="eng-font font-bold text-blue-700 cell-obtained bg-blue-50">0</td>
                <td class="eng-font font-bold text-teal-700 cell-percent bg-teal-50">0%</td>
                <td class="eng-font font-bold text-red-600 cell-fail-count bg-red-50">0</td>
                <td class="urdu-font text-xs flex justify-center items-center h-full py-2"><span class="cell-status px-2 py-1 rounded">-</span></td>
                <td class="no-print text-center cursor-pointer text-red-300 hover:text-red-600 transition" onclick="this.parentElement.remove()"><i class="fas fa-trash-alt"></i></td>
            `;

            tbody.appendChild(tr);
            if (data) calcRow(tr.querySelector('.subject-mark'));
        };

        window.calcRow = (inputElement) => {
            const row = inputElement.closest('tr');
            const inputs = row.querySelectorAll('.subject-mark');
            
            let obtained = 0;
            let failCount = 0;
            let hasEntry = false;

            inputs.forEach(inp => {
                const valStr = inp.value;
                const max = parseInt(inp.dataset.max);
                const pass = parseInt(inp.dataset.pass);

                if (valStr !== "") {
                    hasEntry = true;
                    let val = parseFloat(valStr);
                    
                    if (val > max) { val = max; inp.value = max; } 
                    obtained += val;

                    if (val < pass) {
                        inp.style.color = "#ef4444"; // Red
                        inp.style.fontWeight = "bold";
                        inp.style.backgroundColor = "#fef2f2"; // Light Red Bg
                        failCount++;
                    } else {
                        inp.style.color = "#000";
                        inp.style.fontWeight = "500";
                        inp.style.backgroundColor = "#f9fafb";
                    }
                }
            });

            if (!hasEntry) return;

            const percent = (obtained / TOTAL_MARKS) * 100;

            row.querySelector('.cell-obtained').innerText = obtained;
            row.querySelector('.cell-percent').innerText = percent.toFixed(2);
            row.querySelector('.cell-fail-count').innerText = failCount;

            const statusCell = row.querySelector('.cell-status');
            
            if (failCount > 0) {
                statusCell.innerText = "ناکام";
                statusCell.className = "cell-status status-fail";
            } else {
                statusCell.innerText = "کامیاب";
                statusCell.className = "cell-status status-pass";
            }
        };

        window.saveResult = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            const examType = document.getElementById('exam-selector').value;
            const rows = document.querySelectorAll('#students-body tr');
            const studentsToSave = [];

            rows.forEach(row => {
                const name = row.querySelector('.name-input').value.trim();
                const fatherName = row.querySelector('.std-father')?.value.trim() || ""; 
                // Note: Agar father input class match nahi hui to empty string
                
                if (name) {
                    const marks = {};
                    row.querySelectorAll('.subject-mark').forEach(inp => {
                        marks[inp.dataset.id] = inp.value;
                    });
                    
                    const obtained = row.querySelector('.cell-obtained').innerText;
                    const percent = row.querySelector('.cell-percent').innerText;
                    const status = row.querySelector('.cell-status').innerText;
                    const failCount = row.querySelector('.cell-fail-count').innerText;

                    studentsToSave.push({ name, fatherName, marks, obtained, percent, status, failCount });
                }
            });

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;

            try {
                await setDoc(doc(db, "ibtidaiya_exams", docId), {
                    adminUid, jamiaName, examType, year: globalYear,
                    students: studentsToSave,
                    updatedAt: serverTimestamp()
                });
                alert("Result Successfully Saved!");
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error: " + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-save"></i> Save Record';
                btn.disabled = false;
            }
        };

        window.downloadPDF = async () => {
            if (!window.html2canvas) return;
            
            const area = document.getElementById('sheet-area');
            const btnDiv = document.querySelector('.mt-8'); // Action buttons area
            
            // Hide for print
            btnDiv.style.display = 'none';
            document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none');

            const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4');
            
            await html2canvas(document.body, { 
                scale: 1.5,
                windowWidth: 1400 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 290; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 5, 5, imgWidth, imgHeight);
                pdf.save(`Result_${jamiaName}_${globalYear}.pdf`);
            });

            btnDiv.style.display = 'flex';
            document.querySelectorAll('.no-print').forEach(e => e.style.display = '');
            window.location.reload(); 
        };
    </script>
</body>
</html>
