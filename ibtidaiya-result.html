<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibtidaiya Result Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Jameel Noori Font Definition */
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body { 
            font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; 
            background-color: #eef2ff; 
        }
        
        .urdu-font { 
            font-family: 'Jameel Noori Nastaleeq', serif; 
            line-height: 1.6; 
        }
        
        .eng-font { 
            font-family: 'Poppins', sans-serif; 
            direction: ltr; 
        }
        
        table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.95rem; } 
        th { background-color: #e0e7ff; color: #3730a3; font-weight: bold; padding: 8px; border: 1px solid #c7d2fe; font-family: 'Jameel Noori Nastaleeq'; font-size: 1rem; }
        td { border: 1px solid #e5e7eb; padding: 4px; text-align: center; vertical-align: middle; background-color: white; }
        
        /* Headers Specifics */
        .header-dark { background-color: #312e81 !important; color: white !important; border-color: #3730a3 !important; }
        .header-light { background-color: #e0e7ff !important; color: #312e81 !important; border-color: #c7d2fe !important; }
        
        /* Input Styling */
        .cell-input { 
            width: 100%; 
            border: 1px solid transparent; 
            border-radius: 4px;
            background: #f9fafb; 
            text-align: center; 
            outline: none; 
            padding: 6px; 
            font-family: 'Poppins', sans-serif; 
            font-weight: 500;
            transition: all 0.2s;
            -moz-appearance: textfield; 
        }
        
        .cell-input::-webkit-outer-spin-button,
        .cell-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .cell-input:focus { background-color: #fff; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        
        .name-input { 
            font-family: 'Jameel Noori Nastaleeq', serif; 
            text-align: right; 
            width: 100%; 
            min-width: 120px; 
            font-size: 1.1rem; 
            padding-right: 8px;
        }
        
        .header-input {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s;
        }
        .header-input:focus { background-color: rgba(255, 255, 255, 0.2); border-color: white; }
        .header-input option { color: #333; }

        .status-pass { background-color: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 9999px; font-weight: bold; font-size: 0.8rem; border: 1px solid #86efac; font-family: 'Jameel Noori Nastaleeq'; }
        .status-fail { background-color: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 9999px; font-weight: bold; font-size: 0.8rem; border: 1px solid #fca5a5; font-family: 'Jameel Noori Nastaleeq'; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-[98%] mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-indigo-200 min-h-screen">
        
        <div class="bg-indigo-900 text-white p-6 text-center relative shadow-md">
            <h1 class="text-3xl font-bold mb-2 urdu-font tracking-wide">نتیجہ سالانہ / ششماہی امتحان</h1>
            <h2 class="text-xl text-indigo-200 font-semibold urdu-font" id="display-jamia">Loading...</h2>
            
            <div class="flex flex-wrap justify-center items-end gap-4 mt-6 no-print">
                <div class="flex flex-col items-start">
                    <label class="text-xs font-bold text-indigo-200 mb-1 urdu-font">امتحان منتخب کریں</label>
                    <select id="exam-selector" class="header-input w-48 urdu-font cursor-pointer h-10" onchange="loadExamData()">
                        <option value="Shashmahi">ششماہی امتحان</option>
                        <option value="Salana">سالانہ امتحان</option>
                    </select>
                </div>
                <div class="flex flex-col items-start">
                    <label class="text-xs font-bold text-indigo-200 mb-1 urdu-font">تعلیمی سال</label>
                    <input type="text" id="academic-year" class="header-input w-36 text-center eng-font h-10" value="1447H - 2026">
                </div>
                <button onclick="loadExamData()" class="h-10 bg-indigo-500 hover:bg-indigo-400 text-white font-bold px-6 rounded-md shadow-lg transition transform hover:scale-105 text-sm flex items-center gap-2 border border-indigo-400">
                    <i class="fas fa-sync-alt"></i> Load Data
                </button>
            </div>
        </div>

        <div id="loader" class="text-center py-20"><div class="loader mx-auto"></div><p class="mt-4 text-indigo-600 font-semibold">Loading Result Sheet...</p></div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="flex justify-between items-center mb-4 no-print">
                <div class="text-sm bg-red-50 text-red-700 px-4 py-2 rounded-lg border border-red-200 font-bold flex items-center gap-2 urdu-font shadow-sm">
                    <i class="fas fa-exclamation-circle"></i> پاسنگ: انگلش/ریاضی (33)، دیگر (40)
                </div>
                <button onclick="addStudentRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow-md transition flex items-center gap-2 urdu-font font-bold">
                    <i class="fas fa-plus"></i> طالب علم شامل کریں
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-300 shadow-sm" id="sheet-area">
                <div class="flex justify-between bg-indigo-50 p-3 border-b border-indigo-200 font-bold text-indigo-900 text-sm">
                    <span class="w-1/3 text-right urdu-font text-lg">جامعات المدینہ للبنین ہند (دعوت اسلامی)</span>
                    <span class="w-1/3 text-center text-xl urdu-font">ابتدائیہ</span>
                    <span class="w-1/3 text-left pl-4 urdu-font text-lg">درجہ</span>
                </div>

                <table id="result-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-dark w-12 rounded-tr-lg">نمبر<br>شمار</th>
                            <th rowspan="2" class="header-dark w-48">نام</th>
                            <th rowspan="2" class="header-dark w-40">ولدیت</th>
                            <th class="header-light">تجوید</th>
                            <th class="header-light">ورک بک</th>
                            <th class="header-light">اردو</th>
                            <th class="header-light">ہم نصابی<br>سرگرمیاں</th>
                            <th class="header-light">املا</th>
                            <th class="header-light">انگلش<br>(تحریری)</th>
                            <th class="header-light">انگلش<br>(تقریری)</th>
                            <th class="header-light">ریاضی</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">کل<br>نمبر</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">حاصل کردہ<br>نمبر</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">فیصد</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-20 border-gray-300">پیپرز میں<br>ناکام</th>
                            <th rowspan="2" class="bg-gray-100 text-gray-700 w-28 border-gray-300 rounded-tl-lg">کیفیت</th>
                            <th rowspan="2" class="no-print bg-white border-0 w-10"></th>
                        </tr>
                        <tr>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">100</th>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">40</th>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">40</th>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">20</th>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">100</th>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">70</th>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">30</th>
                            <th class="eng-font bg-white text-indigo-700 border-indigo-100">100</th>
                        </tr>
                    </thead>
                    <tbody id="students-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>

            <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-end border-t border-gray-200 pt-6 no-print">
                <button onclick="saveResult()" id="btn-save" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition transform hover:scale-105">
                    <i class="fas fa-save"></i> Save Record
                </button>
                <button onclick="downloadPDF()" id="btn-download" class="bg-red-700 hover:bg-red-800 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition transform hover:scale-105">
                    <i class="fas fa-file-pdf"></i> Download Result Sheet
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let globalYear = "1447H-2026"; 
        
        const subjectsConfig = [
            { id: "tajweed", name: "تجوید", max: 100 },
            { id: "workbook", name: "ورک بک", max: 40 },
            { id: "urdu", name: "اردو", max: 40 },
            { id: "ham_nisabi", name: "ہم نصابی", max: 20 },
            { id: "imla", name: "املا", max: 100 },
            { id: "eng_written", name: "انگلش (تحریری)", max: 70 },
            { id: "eng_oral", name: "انگلش (تقریری)", max: 30 },
            { id: "riyazi", name: "ریاضی", max: 100 }
        ];

        const TOTAL_MARKS = 500;
        let studentsData = [];

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            if (!adminUid || !jamiaName) { alert("Link Invalid."); return; }
            document.getElementById('display-jamia').textContent = jamiaName;
            
            // Check Database for Semester
            await autoSelectExamType();
            
            await loadExamData();
        };

        // --- UPDATED LOGIC: CHECK DB STRUCTURE ---
        async function autoSelectExamType() {
            const selector = document.getElementById('exam-selector');
            try {
                // Fetch Admin User Data
                const userDoc = await getDoc(doc(db, "users", adminUid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    
                    // Check 'currentSemester' (assuming 1 = Shashmahi, 2 = Salana)
                    if (data.currentSemester == 1) {
                        selector.value = "Shashmahi";
                        console.log("Selected Shashmahi based on DB");
                        return;
                    } else if (data.currentSemester == 2) {
                        selector.value = "Salana";
                        console.log("Selected Salana based on DB");
                        return;
                    }
                }
            } catch (error) {
                console.error("Could not fetch user structure:", error);
            }

            // Fallback: If DB check fails, use Default Month Logic (Standard Madrasa Cycle)
            // Jan-May = Salana (End of year)
            // Jun-Dec = Shashmahi (Start of year)
            const now = new Date();
            const month = now.getMonth() + 1; 
            if (month >= 1 && month <= 5) { selector.value = "Salana"; } 
            else { selector.value = "Shashmahi"; }
        }

        window.loadExamData = async () => {
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            loader.classList.remove('hidden');
            mainContent.classList.add('hidden');

            const examType = document.getElementById('exam-selector').value; 
            const academicYearVal = document.getElementById('academic-year').value;
            globalYear = academicYearVal.replace(/\s/g, '');

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            
            try {
                const docSnap = await getDoc(doc(db, "ibtidaiya_exams", docId));
                studentsData = [];
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.students) studentsData = data.students;
                }
                const tbody = document.getElementById('students-body');
                tbody.innerHTML = '';
                if(studentsData.length > 0) studentsData.forEach(std => addStudentRow(std));
                else for(let i=0; i<10; i++) addStudentRow();
                loader.classList.add('hidden');
                mainContent.classList.remove('hidden');
            } catch (error) { console.error("Error:", error); alert("Data load error."); }
        };

        window.addStudentRow = (data = null) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-indigo-50 transition duration-150"; 
            
            const name = data ? data.name : "";
            const fatherName = data ? data.fatherName : "";
            const marks = data ? data.marks : {};

            let inputsHTML = "";
            subjectsConfig.forEach(sub => {
                const val = marks[sub.id] || "";
                inputsHTML += `<td class="p-1"><input type="number" class="cell-input subject-mark focus:ring-2 focus:ring-indigo-200" data-id="${sub.id}" data-max="${sub.max}" value="${val}" placeholder="-" oninput="calcRow(this)"></td>`;
            });

            tr.innerHTML = `<td class="eng-font bg-gray-50 font-bold text-gray-500 text-center">${index}</td><td class="p-1"><input type="text" class="cell-input name-input font-semibold text-gray-800" placeholder="نام" value="${name}"></td><td class="p-1"><input type="text" class="cell-input name-input std-father text-gray-600" placeholder="ولدیت" value="${fatherName}"></td>${inputsHTML}<td class="eng-font font-bold bg-gray-100 text-gray-700 text-center">${TOTAL_MARKS}</td><td class="eng-font font-bold text-blue-700 cell-obtained bg-blue-50 text-center">0</td><td class="eng-font font-bold text-indigo-700 cell-percent bg-indigo-50 text-center">0%</td><td class="eng-font font-bold text-red-600 cell-fail-count bg-red-50 text-center">0</td><td class="urdu-font text-xs flex justify-center items-center h-full py-2"><span class="cell-status px-2 py-1 rounded">-</span></td><td class="no-print text-center cursor-pointer text-red-300 hover:text-red-600 transition" onclick="this.parentElement.remove()"><i class="fas fa-trash-alt"></i></td>`;
            tbody.appendChild(tr);
            if (data) calcRow(tr.querySelector('.subject-mark'));
        };

        window.calcRow = (inputElement) => {
            const row = inputElement.closest('tr');
            const getVal = (id) => { const el = row.querySelector(`input[data-id="${id}"]`); return el && el.value !== "" ? parseFloat(el.value) : 0; };
            const setStatus = (ids, isFail) => {
                ids.forEach(id => {
                    const el = row.querySelector(`input[data-id="${id}"]`);
                    if(el) {
                        if(isFail) { el.style.color = "#ef4444"; el.style.fontWeight = "bold"; el.style.backgroundColor = "#fef2f2"; } 
                        else { el.style.color = "#000"; el.style.fontWeight = "500"; el.style.backgroundColor = "#f9fafb"; }
                    }
                });
            };

            let obtainedTotal = 0; let failCount = 0; 
            let hasAnyEntry = false; 

            // 1. English Check (Total 100, Pass 33)
            const engTotal = getVal('eng_written') + getVal('eng_oral');
            if (engTotal < 33) { setStatus(['eng_written', 'eng_oral'], true); failCount++; } 
            else setStatus(['eng_written', 'eng_oral'], false);

            // 2. Urdu Check (Total 100, Pass 40)
            const urduTotal = getVal('urdu') + getVal('workbook') + getVal('ham_nisabi');
            if (urduTotal < 40) { setStatus(['urdu', 'workbook', 'ham_nisabi'], true); failCount++; } 
            else setStatus(['urdu', 'workbook', 'ham_nisabi'], false);

            // 3. Other Subjects
            const marksTajweed = getVal('tajweed');
            if (marksTajweed < 40) { setStatus(['tajweed'], true); failCount++; } else setStatus(['tajweed'], false);

            const marksImla = getVal('imla');
            if (marksImla < 40) { setStatus(['imla'], true); failCount++; } else setStatus(['imla'], false);

            const marksRiyazi = getVal('riyazi');
            // Math Passing 33
            if (marksRiyazi < 33) { setStatus(['riyazi'], true); failCount++; } else setStatus(['riyazi'], false);

            row.querySelectorAll('.subject-mark').forEach(inp => {
                if(inp.value !== "") { hasAnyEntry = true; let max = parseInt(inp.dataset.max); if(parseFloat(inp.value) > max) inp.value = max; obtainedTotal += parseFloat(inp.value); }
            });

            if (!hasAnyEntry && !row.querySelector('.name-input').value) return;

            const percent = (obtainedTotal / 500) * 100;
            row.querySelector('.cell-obtained').innerText = obtainedTotal;
            row.querySelector('.cell-percent').innerText = percent.toFixed(2);
            row.querySelector('.cell-fail-count').innerText = failCount;
            const statusCell = row.querySelector('.cell-status');
            if (failCount > 0) { statusCell.innerText = "ناکام"; statusCell.className = "cell-status status-fail"; } 
            else { statusCell.innerText = "کامیاب"; statusCell.className = "cell-status status-pass"; }
        };

        window.saveResult = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...'; btn.disabled = true;
            const examType = document.getElementById('exam-selector').value;
            const rows = document.querySelectorAll('#students-body tr');
            const studentsToSave = [];
            rows.forEach(row => {
                const name = row.querySelector('.name-input').value.trim();
                const fatherName = row.querySelector('.std-father')?.value.trim() || ""; 
                if (name) {
                    const marks = {};
                    row.querySelectorAll('.subject-mark').forEach(inp => { marks[inp.dataset.id] = inp.value; });
                    const obtained = row.querySelector('.cell-obtained').innerText;
                    const percent = row.querySelector('.cell-percent').innerText;
                    const status = row.querySelector('.cell-status').innerText;
                    const failCount = row.querySelector('.cell-fail-count').innerText;
                    studentsToSave.push({ name, fatherName, marks, obtained, percent, status, failCount });
                }
            });
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${globalYear}_${examType}`;
            try {
                await setDoc(doc(db, "ibtidaiya_exams", docId), { adminUid, jamiaName, examType, year: globalYear, students: studentsToSave, updatedAt: serverTimestamp() });
                alert("Result Successfully Saved!");
            } catch (error) { console.error("Save Error:", error); alert("Error: " + error.message); } 
            finally { btn.innerHTML = '<i class="fas fa-save"></i> Save Record'; btn.disabled = false; }
        };

        window.downloadPDF = async () => {
            if (!window.html2canvas) { alert("Library missing."); return; }
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...'; btn.disabled = true;

            const examType = document.getElementById('exam-selector').value;
            const academicYearVal = document.getElementById('academic-year').value;
            
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px'; tempContainer.style.top = '0px'; tempContainer.style.width = '1100px';
            document.body.appendChild(tempContainer);

            const COLOR_DARK = "#312e81"; 
            const COLOR_LIGHT = "#e0e7ff"; 
            const COLOR_BORDER = "#312e81";

            function createNewPage() {
                const pageDiv = document.createElement('div');
                pageDiv.style.backgroundColor = "white"; pageDiv.style.padding = "20px"; pageDiv.style.width = "100%"; pageDiv.style.boxSizing = "border-box";
                pageDiv.innerHTML = `
                    <div style="margin-bottom: 10px; border: 2px solid ${COLOR_BORDER}; border-radius: 8px; overflow: hidden; font-family: 'Jameel Noori Nastaleeq', serif;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="height: 40px;">
                                <td style="background-color: ${COLOR_DARK}; color: white; text-align: center; font-weight: bold; font-size: 20px; width: 70%; border-right: 1px solid white;">نتیجہ سالانہ / ششماہی امتحان</td>
                                <td style="background-color: ${COLOR_LIGHT}; color: #312e81; text-align: center; font-weight: bold; border-bottom: 1px solid ${COLOR_BORDER}; border-right: 1px solid ${COLOR_BORDER}; width: 15%;">درجہ</td>
                                <td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold; font-size: 18px; border-bottom: 1px solid ${COLOR_BORDER}; width: 15%;">ابتدائیہ</td>
                            </tr>
                            <tr style="height: 50px;">
                                <td style="background-color: white; color: #312e81; text-align: center; font-size: 26px; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">${jamiaName}</td>
                                <td style="background-color: ${COLOR_LIGHT}; color: #312e81; text-align: center; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">امتحان</td>
                                <td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold;">${examType}</td>
                            </tr>
                        </table>
                    </div>
                    <table class="result-table" style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 12px; direction: rtl;">
                        <thead style="background-color: ${COLOR_DARK}; color: white; text-align: center; font-weight: bold; font-family: 'Jameel Noori Nastaleeq';">
                            <tr>
                                <th style="border: 1px solid #ccc; padding: 5px; width: 40px;">نمبر شمار</th>
                                <th style="border: 1px solid #ccc; padding: 5px; width: 120px;">نام</th>
                                <th style="border: 1px solid #ccc; padding: 5px; width: 100px;">ولدیت</th>
                                <th style="border: 1px solid #ccc;">تجوید<br><span style="font-size:10px; font-family:sans-serif;">/100</span></th>
                                <th style="border: 1px solid #ccc;">ورک بک<br><span style="font-size:10px; font-family:sans-serif;">/40</span></th>
                                <th style="border: 1px solid #ccc;">اردو<br><span style="font-size:10px; font-family:sans-serif;">/40</span></th>
                                <th style="border: 1px solid #ccc;">ہم نصابی<br><span style="font-size:10px; font-family:sans-serif;">/20</span></th>
                                <th style="border: 1px solid #ccc;">املا<br><span style="font-size:10px; font-family:sans-serif;">/100</span></th>
                                <th style="border: 1px solid #ccc;">انگلش(تحریر)<br><span style="font-size:10px; font-family:sans-serif;">/70</span></th>
                                <th style="border: 1px solid #ccc;">انگلش(تقریر)<br><span style="font-size:10px; font-family:sans-serif;">/30</span></th>
                                <th style="border: 1px solid #ccc;">ریاضی<br><span style="font-size:10px; font-family:sans-serif;">/100</span></th>
                                <th style="border: 1px solid #ccc; width: 50px;">کل<br>نمبر</th>
                                <th style="border: 1px solid #ccc; width: 50px;">حاصل<br>کردہ</th>
                                <th style="border: 1px solid #ccc; width: 50px;">فیصد</th>
                                <th style="border: 1px solid #ccc; width: 50px;">ناکام<br>پیپر</th>
                                <th style="border: 1px solid #ccc; width: 70px;">کیفیت</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200" style="text-align: center;"></tbody>
                    </table>
                `;
                tempContainer.appendChild(pageDiv);
                return pageDiv;
            }

            try {
                const originalRows = document.querySelectorAll('#students-body tr');
                const PAGE_HEIGHT_LIMIT = 720; 
                let currentPage = createNewPage();
                let currentTbody = currentPage.querySelector('.result-table tbody');

                for (let row of originalRows) {
                    const index = row.cells[0].innerText;
                    const name = row.querySelector('.name-input').value;
                    const father = row.querySelector('.std-father').value;
                    
                    const newRow = document.createElement('tr');
                    let marksCells = "";
                    row.querySelectorAll('.subject-mark').forEach(inp => {
                        const val = inp.value || '-';
                        const style = inp.style.color === 'rgb(239, 68, 68)' || inp.style.color === '#ef4444' || inp.style.fontWeight === 'bold' 
                            ? 'background-color: #fee2e2; color: #991b1b; font-weight: bold;' : '';
                        marksCells += `<td style="border: 1px solid #e5e7eb; padding: 5px; ${style} font-family: sans-serif;">${val}</td>`;
                    });

                    const total = row.querySelector('.cell-obtained').innerText;
                    const perc = row.querySelector('.cell-percent').innerText;
                    const fail = row.querySelector('.cell-fail-count').innerText;
                    const statusText = row.querySelector('.cell-status').innerText;
                    const statusClass = row.querySelector('.cell-status').classList.contains('status-pass') 
                        ? 'background-color: #dcfce7; color: #166534;' : 'background-color: #fee2e2; color: #991b1b;';

                    newRow.innerHTML = `
                        <td style="border: 1px solid #e5e7eb; padding: 5px; font-family: sans-serif;">${index}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 5px; font-family: 'Jameel Noori Nastaleeq'; text-align: right; font-size: 14px;">${name}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 5px; font-family: 'Jameel Noori Nastaleeq'; text-align: right; font-size: 14px;">${father}</td>
                        ${marksCells}
                        <td style="border: 1px solid #e5e7eb; padding: 5px; font-weight: bold; font-family: sans-serif;">${TOTAL_MARKS}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 5px; font-weight: bold; color: #312e81; font-family: sans-serif;">${total}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 5px; font-weight: bold; font-family: sans-serif;">${perc}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 5px; font-weight: bold; color: #dc2626; font-family: sans-serif;">${fail}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 5px;"><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; font-family: 'Jameel Noori Nastaleeq'; ${statusClass}">${statusText}</span></td>
                    `;

                    currentTbody.appendChild(newRow);

                    if (currentPage.offsetHeight > PAGE_HEIGHT_LIMIT) {
                        currentTbody.removeChild(newRow);
                        currentPage = createNewPage();
                        currentTbody = currentPage.querySelector('.result-table tbody');
                        currentTbody.appendChild(newRow);
                    }
                }

                const { jsPDF } = window.jspdf;
                const pdfDoc = new jsPDF('l', 'mm', 'a4');
                const pages = Array.from(tempContainer.children);

                for (let i = 0; i < pages.length; i++) {
                    if (i > 0) pdfDoc.addPage();
                    const canvas = await html2canvas(pages[i], { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 297; 
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    pdfDoc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                }

                pdfDoc.save(`Ibtidaiya_Result_${jamiaName}_${globalYear}.pdf`);
                document.body.removeChild(tempContainer);

            } catch (error) {
                console.error(error);
                alert("PDF Generation Error: " + error.message);
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        };
    </script>
</body>
</html>
