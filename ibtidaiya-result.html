<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibtidaiya Result Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @font-face { 
            font-family: 'Jameel Noori Nastaleeq'; 
            src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2'); 
            font-display: swap; 
        }
        body { font-family: 'Poppins', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .mark-input { text-align: center; }

        /* Grades Colors */
        .grade-mumtaz { background-color: #15803d; color: white; } 
        .grade-jayyid { background-color: #eab308; color: white; } 
        .grade-pass { background-color: #22c55e; color: white; } 
        .grade-fail { background-color: #ef4444; color: white; } 
    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg">Ibtidaiya Result (Primary Section)</p>
            <p class="text-sm text-teal-300 mt-1" id="display-month">...</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div id="subject-config" class="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-indigo-800"><i class="fas fa-book-open mr-2"></i> Ibtidaiya Subjects List</h3>
                    <button onclick="toggleSubjectEdit()" id="edit-subs-btn" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">
                        Edit Subjects
                    </button>
                </div>
                
                <div id="subjects-display" class="flex flex-wrap gap-2"></div>

                <div id="subjects-edit-area" class="hidden mt-4 pt-4 border-t border-indigo-200">
                    <p class="text-xs text-gray-500 mb-2">Subject ka naam likh kar Add dabayein. Remove karne ke liye cross dabayein.</p>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-subject-input" placeholder="New Subject (e.g. Urdu)" class="border p-2 rounded w-full urdu-font">
                        <button onclick="addSubject()" class="bg-green-600 text-white px-4 py-2 rounded">Add</button>
                    </div>
                    <div id="subjects-edit-list" class="flex flex-wrap gap-2"></div>
                    <button onclick="saveSubjectsConfig()" class="mt-3 bg-indigo-600 text-white px-6 py-2 rounded w-full font-bold">Done & Update Table</button>
                </div>
            </div>

            <div id="result-area">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Student Marks Entry</h2>
                    <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                        <i class="fas fa-plus mr-1"></i> Add Student
                    </button>
                </div>

                <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="w-full text-sm text-left bg-white border-collapse" id="result-table">
                        <thead class="bg-teal-50 text-teal-900 uppercase font-bold text-center" id="table-head">
                            </thead>
                        <tbody id="students-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                    <button onclick="saveResult()" id="btn-save" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Save Result
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let monthKey = "";
        
        // Default Subjects for Ibtidaiya
        let currentSubjects = ["Quran", "Urdu", "Math", "Hindi", "English", "Diniyat"];
        let studentsData = [];

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Invalid Link! UID, Jamia, or Month is missing.");
                return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Result for: ${monthKey}`;

            await loadIbtidaiyaData();
        };

        // --- Load Data ---
        async function loadIbtidaiyaData() {
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_Ibtidaiya`;
            
            try {
                const docSnap = await getDoc(doc(db, "ibtidaiya_sheets", docId));
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.subjects && data.subjects.length > 0) {
                        currentSubjects = data.subjects;
                    }
                    if (data.students) {
                        studentsData = data.students;
                    }
                }
                
                renderSubjectBadges();
                renderTableStructure();
                
                // Populate students if exist
                const tbody = document.getElementById('students-body');
                tbody.innerHTML = '';
                if(studentsData.length > 0) {
                    studentsData.forEach(std => addStudentRow(std.name, std.marks));
                } else {
                    // Add one empty row to start
                    addStudentRow();
                }

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

            } catch (error) {
                console.error("Error loading:", error);
                alert("Error loading data.");
            }
        }

        // --- Subject Management ---
        window.toggleSubjectEdit = () => {
            const area = document.getElementById('subjects-edit-area');
            const display = document.getElementById('subjects-display');
            const btn = document.getElementById('edit-subs-btn');
            
            if(area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                display.classList.add('hidden');
                btn.innerText = "Cancel Editing";
                renderEditList();
            } else {
                area.classList.add('hidden');
                display.classList.remove('hidden');
                btn.innerText = "Edit Subjects";
            }
        };

        function renderSubjectBadges() {
            const container = document.getElementById('subjects-display');
            container.innerHTML = currentSubjects.map(sub => 
                `<span class="bg-indigo-100 text-indigo-800 text-sm font-semibold px-2.5 py-0.5 rounded border border-indigo-200">${sub}</span>`
            ).join('');
        }

        function renderEditList() {
            const container = document.getElementById('subjects-edit-list');
            container.innerHTML = currentSubjects.map((sub, index) => 
                `<span class="bg-white border p-1 rounded flex items-center gap-2 text-sm shadow-sm">
                    ${sub} 
                    <button onclick="removeSubject(${index})" class="text-red-500 hover:text-red-700 font-bold">×</button>
                </span>`
            ).join('');
        }

        window.addSubject = () => {
            const input = document.getElementById('new-subject-input');
            const val = input.value.trim();
            if(val && !currentSubjects.includes(val)) {
                currentSubjects.push(val);
                input.value = '';
                renderEditList();
            }
        };

        window.removeSubject = (index) => {
            currentSubjects.splice(index, 1);
            renderEditList();
        };

        window.saveSubjectsConfig = async () => {
            if(currentSubjects.length === 0) {
                alert("Kam se kam ek subject hona zaroori hai.");
                return;
            }
            
            // Capture current marks before rebuilding table
            saveTempData();
            
            renderSubjectBadges();
            renderTableStructure();
            
            // Restore data
            const tbody = document.getElementById('students-body');
            tbody.innerHTML = '';
            studentsData.forEach(std => addStudentRow(std.name, std.marks));
            
            toggleSubjectEdit(); // Close menu
        };

        function saveTempData() {
            const rows = document.querySelectorAll('#students-body tr');
            studentsData = [];
            rows.forEach(row => {
                const name = row.querySelector('.std-name').value.trim();
                if(name) {
                    const marks = {};
                    row.querySelectorAll('.mark-input').forEach(inp => {
                        marks[inp.dataset.sub] = inp.value.trim();
                    });
                    studentsData.push({ name, marks });
                }
            });
        }

        // --- Table Logic ---
        function renderTableStructure() {
            const head = document.getElementById('table-head');
            let cols = `<th class="px-4 py-3 border w-12">#</th>
                        <th class="px-4 py-3 border text-left w-64">Talib-e-Ilm</th>`;
            
            currentSubjects.forEach(sub => {
                cols += `<th class="px-2 py-3 border urdu-font">${sub} <br><span class="text-xs font-normal text-gray-500">/100</span></th>`;
            });
            
            cols += `<th class="px-4 py-3 border bg-gray-50">Total</th>
                     <th class="px-4 py-3 border bg-gray-50">%</th>
                     <th class="px-4 py-3 border bg-gray-50">Result</th>
                     <th class="px-2 py-3 border text-red-500"><i class="fas fa-trash"></i></th>`;
            
            head.innerHTML = `<tr>${cols}</tr>`;
        }

        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";

            let inputs = "";
            currentSubjects.forEach(sub => {
                const val = marks[sub] || "";
                inputs += `<td class="border p-1">
                            <input type="number" data-sub="${sub}" value="${val}" 
                            class="w-full p-2 text-center outline-none mark-input focus:bg-blue-50" 
                            oninput="calcRow(this)" placeholder="-">
                           </td>`;
            });

            tr.innerHTML = `
                <td class="border p-2 text-center text-gray-500">${index}</td>
                <td class="border p-1"><input type="text" value="${name}" placeholder="Naam likhein" class="w-full p-2 font-semibold urdu-font outline-none std-name"></td>
                ${inputs}
                <td class="border p-2 text-center font-bold text-gray-700 total-val">0</td>
                <td class="border p-2 text-center font-bold text-blue-600 perc-val">0%</td>
                <td class="border p-2 text-center font-bold text-xs result-val">-</td>
                <td class="border p-2 text-center cursor-pointer text-red-400 hover:text-red-600" onclick="this.parentElement.remove()">×</td>
            `;
            tbody.appendChild(tr);
            
            if(name) calcRow(tr.querySelector('input'));
        };

        window.calcRow = (el) => {
            const row = el.closest('tr');
            const inputs = row.querySelectorAll('.mark-input');
            
            let obtained = 0;
            let maxTotal = currentSubjects.length * 100;
            let failCount = 0;

            inputs.forEach(inp => {
                const val = parseFloat(inp.value);
                if (!isNaN(val)) {
                    if(val > 100) { inp.value = 100; obtained += 100; }
                    else obtained += val;

                    if (val < 40) { // Passing marks 40
                        inp.style.color = 'red';
                        inp.style.fontWeight = 'bold';
                        failCount++;
                    } else {
                        inp.style.color = 'black';
                        inp.style.fontWeight = 'normal';
                    }
                }
            });

            const percentage = maxTotal > 0 ? (obtained / maxTotal) * 100 : 0;
            
            row.querySelector('.total-val').innerText = obtained;
            row.querySelector('.perc-val').innerText = percentage.toFixed(1) + '%';
            
            const resCell = row.querySelector('.result-val');
            
            if (failCount >= 3) { // Fail logic (if failed in 3 or more)
                resCell.innerText = "FAIL";
                resCell.className = "result-val px-2 py-1 text-center font-bold text-xs border rounded shadow-sm grade-fail";
            } else if (percentage >= 80) {
                resCell.innerText = "MUMTAZ";
                resCell.className = "result-val px-2 py-1 text-center font-bold text-xs border rounded shadow-sm grade-mumtaz";
            } else if (percentage >= 60) {
                resCell.innerText = "JAYYID";
                resCell.className = "result-val px-2 py-1 text-center font-bold text-xs border rounded shadow-sm grade-jayyid";
            } else if (percentage >= 40) {
                resCell.innerText = "PASS";
                resCell.className = "result-val px-2 py-1 text-center font-bold text-xs border rounded shadow-sm grade-pass";
            } else {
                resCell.innerText = "FAIL";
                resCell.className = "result-val px-2 py-1 text-center font-bold text-xs border rounded shadow-sm grade-fail";
            }
        };

        // --- Save Data ---
        window.saveResult = async () => {
            const btn = document.getElementById('btn-save');
            btn.innerText = "Saving...";
            btn.disabled = true;

            saveTempData(); // Refresh global studentsData from UI

            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_Ibtidaiya`;

            try {
                await setDoc(doc(db, "ibtidaiya_sheets", docId), {
                    adminUid,
                    jamiaName,
                    month: monthKey,
                    class: "Ibtidaiya",
                    subjects: currentSubjects,
                    students: studentsData,
                    updatedAt: serverTimestamp()
                });

                alert("Result Successfully Saved!");
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error saving data: " + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-save"></i> Save Result';
                btn.disabled = false;
            }
        };

        // --- PDF Generation ---
        window.downloadPDF = async () => {
            if (!window.html2canvas) { alert("Library missing."); return; }
            
            const element = document.getElementById('result-area');
            const originalBtnArea = document.querySelector('.mt-8');
            originalBtnArea.style.display = 'none'; // Hide buttons

            const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4');
            
            // Add Header Info to PDF
            const title = `Ibtidaiya Result - ${jamiaName} (${monthKey})`;
            pdf.setFontSize(14);
            pdf.text(title, 15, 15);

            await html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 280; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 25, imgWidth, imgHeight);
                pdf.save(`Ibtidaiya_${jamiaName}_${monthKey}.pdf`);
            });

            originalBtnArea.style.display = 'flex'; // Show buttons
        };
    </script>
</body>
</html>
