<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Test Sheet (Teacher View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2'); font-display: swap; }
        body { font-family: 'Poppins', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .mark-input { text-align: center; }
        
        /* Grades Colors */
        .grade-mumtaz-sharf { background-color: #15803d; color: white; } /* Green Dark */
        .grade-mumtaz { background-color: #22c55e; color: white; } /* Green */
        .grade-jayyid { background-color: #eab308; color: white; } /* Yellow/Gold */
        .grade-maqbul { background-color: #f97316; color: white; } /* Orange */
        .grade-nakam { background-color: #ef4444; color: white; } /* Red */

        /* Input Validation Colors */
        .bg-fail-input { background-color: #fee2e2 !important; color: #991b1b; font-weight: bold; }
        
        .subject-checkbox:checked + div { background-color: #0d9488; color: white; border-color: #0d9488; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg" id="display-month">...</p>
            <p class="text-xs text-teal-300 mt-2">Teacher/Principal Portal</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Step 1: Class & Subjects Select Karein</h3>
                
                <div class="mb-4">
                    <label class="block text-gray-600 font-semibold mb-1">Class:</label>
                   <select id="class-select"
                  class="w-full md:w-1/3 p-3 border rounded-lg urdu-font text-lg shadow-sm focus:ring-2 focus:ring-teal-500 bg-white">
                        <div id="class-tabs" class="flex flex-wrap gap-2 mt-4"></div>
                        <option value="">-- Select Class --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Ek class save karne ke baad dusri select karein.</p>
                </div>

                <div id="subject-selection-area" class="hidden">
                    <p class="text-sm text-gray-500 mb-2">Is Class ki kitabon me se koi <strong>3 Kitabein</strong> select karein:</p>
                    
                    <div id="checkbox-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        </div>

                    <div class="bg-blue-50 p-3 rounded border border-blue-200 mb-4 text-sm text-blue-800 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        Note: <strong>English (25)</strong> aur <strong>Maths (25)</strong> automatically shamil rahenge. Baqi 100 number ke honge.
                    </div>

                    <button onclick="generateSheet()" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition w-full md:w-auto">
                        Result Sheet Banayein (Total 350)
                    </button>
                </div>
            </div>

            <div id="result-area" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 border-b-2 border-teal-500 pb-1">Result Sheet</h2>
                    <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>

                <div class="overflow-x-auto border rounded-lg shadow-sm" id="print-area">
                     <div class="hidden print-header text-center mb-4 pt-4">
                        <h2 class="text-2xl font-bold urdu-font" id="pdf-jamia"></h2>
                        <p id="pdf-month"></p>
                    </div>

                    <table class="w-full text-sm text-left bg-white border-collapse">
                        <thead class="bg-teal-50 text-teal-900 uppercase font-bold" id="table-head">
                            </thead>
                        <tbody id="students-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                    <button onclick="saveResult()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Save Result Sheet
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let monthKey = "";
        let finalSubjectsList = []; 
        let classBooksMap = {}; 

        // 1. Initialize
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Invalid Link."); return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Month: ${monthKey}`;
            document.getElementById('pdf-jamia').textContent = jamiaName;
            document.getElementById('pdf-month').textContent = monthKey;

            await loadTeachingData();
        };

        function getAcademicYear(key) {
            if (!key) return null;
            const [yStr, mStr] = key.split("-");
            const yearNum  = parseInt(yStr);
            const monthNum = parseInt(mStr) - 1; 
            return monthNum >= 3 ? `${yearNum}-${yearNum+1}` : `${yearNum-1}-${yearNum}`;
        }

        // 2. Load Teaching Data
        async function loadTeachingData() {
            try {
                const acYear = getAcademicYear(monthKey);
                const userDoc = await getDoc(doc(db, "users", adminUid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const years = userData.academicYears || {};
                    const yearData = years[acYear];
                    let jamiaStruct = null;

                    if (yearData && Array.isArray(yearData.karkardagiStructure)) {
                        jamiaStruct = yearData.karkardagiStructure.find(j => j.jamiaName === jamiaName);
                    } 
                    if (!jamiaStruct && Array.isArray(userData.academicStructure)) {
                        jamiaStruct = userData.academicStructure.find(j => j.jamiaName === jamiaName);
                    }

                    if (!jamiaStruct) {
                        alert("Setup nahi mila. Admin se rabta karein.");
                        return;
                    }

                    classBooksMap = {};
                    if (Array.isArray(jamiaStruct.teachers)) {
                        jamiaStruct.teachers.forEach(t => {
                            if(Array.isArray(t.periods)) {
                                t.periods.forEach(p => {
                                    const cName = p.className || p.class || p.darja;
                                    const bName = p.bookName || p.book || p.kitab || p.subject;
                                    if (cName && bName) {
                                        if (!classBooksMap[cName]) classBooksMap[cName] = new Set();
                                        classBooksMap[cName].add(bName);
                                    }
                                });
                            }
                        });
                    }

                    const select = document.getElementById('class-select');
                    const sortedClasses = Object.keys(classBooksMap).sort();
                    sortedClasses.forEach(cls => {
                        const opt = document.createElement('option');
                        opt.value = cls;
                        opt.textContent = cls;
                        select.appendChild(opt);
                    });
                }
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } catch (error) {
                console.error("Error:", error);
            }
        }

        // 3. Handle Class Change
        window.handleClassChange = () => {
            const clsName = document.getElementById('class-select').value;
            const container = document.getElementById('checkbox-container');
            const selectionArea = document.getElementById('subject-selection-area');
            const resultArea = document.getElementById('result-area');

            document.getElementById('class-select').disabled = false;
            
            container.innerHTML = '';
            resultArea.classList.add('hidden'); 

            if (!clsName) {
                selectionArea.classList.add('hidden');
                return;
            }

            // Yahan students-body ko bhi clear kar dena chahiye.
            document.getElementById('students-body').innerHTML = '';

            const rawSubjectsSet = classBooksMap[clsName];
            if (!rawSubjectsSet) return;
            
            const filteredSubjects = Array.from(rawSubjectsSet).filter(s => {
                const lower = s.toLowerCase();
                return lower !== 'english' && lower !== 'maths' && lower !== 'math' && lower !== 'mathematics';
            });

            filteredSubjects.forEach((sub) => {
                const label = document.createElement('label');
                label.className = "cursor-pointer block";
                label.innerHTML = `
                    <input type="checkbox" value="${sub}" class="subject-checkbox hidden" onchange="checkLimit(this)">
                    <div class="border p-2 rounded text-center hover:bg-teal-50 transition urdu-font select-none bg-white shadow-sm">
                        ${sub}
                    </div>
                `;
                container.appendChild(label);
            });

            selectionArea.classList.remove('hidden');
            checkExistingForClass(clsName);
        };

        window.checkLimit = (elem) => {
            const checked = document.querySelectorAll('.subject-checkbox:checked');
            if (checked.length > 3) {
                elem.checked = false;
                alert("Sirf 3 kitabein select kar sakte hain.");
            }
        };

        // 4. Generate Table
        window.generateSheet = () => {
            const checkedBoxes = document.querySelectorAll('.subject-checkbox:checked');
            if (document.querySelectorAll('.subject-checkbox').length > 0 && checkedBoxes.length !== 3) {
                if(!confirm(`Apne sirf ${checkedBoxes.length} kitabein select ki hain. Kya aap aage badhna chahte hain?`)) return;
            }

            const selected3 = Array.from(checkedBoxes).map(cb => cb.value);
            finalSubjectsList = [...selected3, "English", "Maths"];

            renderTableHeaders();
            document.getElementById('result-area').classList.remove('hidden');
        };

        function renderTableHeaders() {
            const head = document.getElementById('table-head');
            let html = `<tr>
                <th class="px-4 py-3 border border-gray-300 w-12">#</th>
                <th class="px-4 py-3 border border-gray-300 text-left w-1/4">Talib-e-Ilm</th>`;
            
            finalSubjectsList.forEach(sub => {
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                html += `<th class="px-4 py-3 border border-gray-300 text-center">${sub} <br><span class="text-xs font-normal text-gray-200">/${max}</span></th>`;
            });

            html += `
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Total (350)</th>
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">%</th>
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Grade</th>
                <th class="px-2 py-3 border border-gray-300 text-center text-red-500 no-print"><i class="fas fa-trash"></i></th>
            </tr>`;
            head.innerHTML = html;
        }

        // 5. Add Student Row (Updated for 'A')
        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";

            let inputs = "";
            finalSubjectsList.forEach(sub => {
                const val = marks[sub] !== undefined ? marks[sub] : "";
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                
                // Input Type Text kar diya taake 'A' likh sakein
                inputs += `<td class="border border-gray-200 p-1">
                    <input type="text" data-sub="${sub}" data-max="${max}" value="${val}" 
                           class="w-full p-2 text-center outline-none mark-input focus:bg-blue-50" 
                           oninput="calcRow(this)" placeholder="-">
                </td>`;
            });

            tr.innerHTML = `
                <td class="border border-gray-200 p-2 text-center text-gray-500">${index}</td>
                <td class="border border-gray-200 p-1"><input type="text" value="${name}" placeholder="Naam likhein" class="w-full p-2 font-semibold urdu-font outline-none std-name"></td>
                ${inputs}
                <td class="border border-gray-200 p-2 text-center font-bold text-gray-700 total-val">0</td>
                <td class="border border-gray-200 p-2 text-center font-bold text-blue-600 perc-val">0%</td>
                <td class="border border-gray-200 p-2 text-center font-bold text-xs grade-val">-</td>
                <td class="border border-gray-200 p-2 text-center cursor-pointer text-red-400 hover:text-red-600 no-print" onclick="this.parentElement.remove()">√ó</td>
            `;
            tbody.appendChild(tr);
            if(name) calcRow(tr.querySelector('input'));
        };

        // 6. Calculation Logic (Updated for 'A', Fail Color, New Grades)
        window.calcRow = (el) => {
            const row = el.closest('tr');
            let obtained = 0;
            const inputs = row.querySelectorAll('.mark-input');
            
            inputs.forEach(inp => {
                const max = parseInt(inp.dataset.max); // Max marks for this subject (25 or 100)
                let rawVal = inp.value.trim().toUpperCase();
                
                // 1. Text Validation (Only Numbers or 'A')
                // Agar 'A' nahi hai, to check karo ki sirf numbers ho
                if (rawVal !== 'A' && rawVal !== '') {
                    // Check if input is not a valid number
                    if (isNaN(parseFloat(rawVal)) || !isFinite(rawVal)) {
                        // Agar valid number nahi hai to input ko khali kar do
                        inp.value = '';
                        rawVal = '';
                    }
                }

                // 2. Maximum Marks Validation
                let numVal = 0;
                
                if (rawVal === 'A') {
                    numVal = 0;
                    inp.style.color = 'red';
                    inp.classList.add('bg-fail-input');
                } else if (rawVal === '') {
                    numVal = 0;
                    inp.classList.remove('bg-fail-input');
                    inp.style.color = '';
                } else {
                    numVal = parseFloat(rawVal);
                    
                    // Agar marks Max se zyada hain
                    if (numVal > max) {
                        alert(`Maximum marks ${max} hain. ${max} ya usse kam enter karein.`);
                        inp.value = max; // Input ko Max marks par set kar do
                        numVal = max;
                    }

                    // Passing Marks Logic
                    const pass = max === 25 ? 10 : 40; 
                    
                    // Check Passing (Fail Color)
                    if (numVal < pass) {
                        inp.classList.add('bg-fail-input');
                    } else {
                        inp.classList.remove('bg-fail-input');
                        inp.style.color = '';
                    }
                }
                
                obtained += numVal;
            });
            
            // ... Baaki calculation logic yahan neeche hai, usme koi change nahi karna
            const totalMax = 350; 
            const percent = (obtained / totalMax * 100).toFixed(1);
            
            row.querySelector('.total-val').textContent = obtained;
            row.querySelector('.perc-val').textContent = percent + '%';
            
            // Grade Logic
            let grade = "Nakam";
            let cls = "grade-nakam";
            const p = parseFloat(percent);

            if (p >= 80) { grade = "Mumtaz Ma Sharf"; cls = "grade-mumtaz-sharf"; }
            else if (p >= 70) { grade = "Mumtaz"; cls = "grade-mumtaz"; }
            else if (p >= 50) { grade = "Jayyid"; cls = "grade-jayyid"; }
            else if (p >= 40) { grade = "Maqbul"; cls = "grade-maqbul"; }
            else { grade = "Nakam"; cls = "grade-nakam"; }
            
            const gVal = row.querySelector('.grade-val');
            gVal.textContent = grade;
            gVal.className = `border border-gray-200 p-2 text-center font-bold text-xs grade-val ${cls} rounded`;
        };

        // 7. Save Logic
        window.saveResult = async () => {
            const rows = document.querySelectorAll('#students-body tr');
            if(rows.length === 0) { alert("Koi student add nahi kiya gaya."); return; }
            
            // FIX 1: Doc ID ko sirf ek baar define karein (Syntax Error theek kiya)
            const rawClass = document.getElementById('class-select').value;
            const cleanClass = rawClass.split('_')[0]; 
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`; 
            console.log("üíæ Doc ID used for SAVE:", docId); // Debug Log
            
            const selectedClass = rawClass; // Poora class name Firestore mein save hoga

            const students = [];
            let grandObtained = 0;
            let grandMax = 0;

            rows.forEach(row => {
                const name = row.querySelector('.std-name').value.trim();
                if(!name) return;
                
                const marks = {};
                row.querySelectorAll('.mark-input').forEach(inp => {
                    // Save as String if 'A', else Number
                    const val = inp.value.trim().toUpperCase();
                    marks[inp.dataset.sub] = (val === 'A') ? 'A' : (val === '' ? 0 : parseFloat(val));
                });
                
                const total = parseFloat(row.querySelector('.total-val').textContent);
                const perc = parseFloat(row.querySelector('.perc-val').textContent);
                students.push({ name, marks, total, percentage: perc });
                
                grandObtained += total;
                grandMax += 350;
            });

            const overallPerc = grandMax > 0 ? ((grandObtained / grandMax) * 100).toFixed(1) + '%' : '0%';
            
            try {
                // ‚úÖ Save to monthly_test_sheets
                await setDoc(doc(db, "monthly_test_sheets", docId), {
                    adminUid, jamiaName, month: monthKey, class: selectedClass,
                    subjects: finalSubjectsList, students, updatedAt: serverTimestamp()
                }); 
                
                console.log("‚úÖ Data successfully saved to monthly_test_sheets with ID:", docId); // Confirmation Log

                // Update Admin Dashboard
                const [yStr, mStr] = monthKey.split('-');
                const y = parseInt(yStr);
                const m = parseInt(mStr) - 1;
                const acYear = m >= 3 ? `${y}-${y + 1}` : `${y - 1}-${y}`;
                const reportId = `${adminUid}_${acYear}_${y}_${m}`;

                const reportRef = doc(db, 'monthly_reports', reportId);
                const reportSnap = await getDoc(reportRef);
                let testData = reportSnap.exists() ? (reportSnap.data().monthlyTest?.data || []) : [];
                
                // Update specific entry
                testData = testData.filter(t => t.name !== jamiaName);
                testData.push({
                    name: jamiaName, status: 'Test Hua', month: monthKey,
                    percentage: overallPerc, wajah: ''
                });

                await setDoc(reportRef, { monthlyTest: { status: 'Done', data: testData } }, { merge: true });

                alert(`Class ${selectedClass} ka Result Save ho gaya!`);
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error: " + error.message);
            }
        };

       // 8. Load Existing
async function checkExistingForClass(clsName) {
    
    // FIX 2: Doc ID ko sirf ek baar define karein (Syntax Error theek kiya)
    const cleanClass = clsName.split('_')[0]; 
    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
    
    console.log("üîé Doc ID used for LOAD:", docId); // Debug Log
    
    const resultArea = document.getElementById('result-area');
    const studentsBody = document.getElementById('students-body');
    const classSelect = document.getElementById('class-select');
    const selectionArea = document.getElementById('subject-selection-area'); 

    // **Step 1: Subjects aur Table ko Reset Karein (Important!)**
    finalSubjectsList = [];
    studentsBody.innerHTML = '';
    resultArea.classList.add('hidden'); 
    document.getElementById('table-head').innerHTML = '';
    
    // Select kiye gaye subjects ke checkboxes ko uncheck karein
    document.querySelectorAll('.subject-checkbox').forEach(chk => chk.checked = false);
    
    // Hamesha Class Select ko enable rakhein shuru mein
    classSelect.disabled = false; 

    console.log("Attempting to load docId:", docId); // ‚¨ÖÔ∏è Doc ID check karein
    
    try {
        const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
        
        if (snap.exists()) {
            const data = snap.data(); 
            
            console.log("‚úÖ Data Found:", data); // ‚¨ÖÔ∏è Data object ko check karein
            
            // 1. Subjects ko Check karein:
            const allChecks = document.querySelectorAll('.subject-checkbox');
            const savedVariableSubjects = data.subjects.filter(s => s !== 'English' && s !== 'Maths');
            
            allChecks.forEach(chk => {
                if (savedVariableSubjects.includes(chk.value)) chk.checked = true;
            });
            
            // 2. Final Subjects Set karein:
            finalSubjectsList = data.subjects;
            
            // 3. Header aur Result Area dikhayein:
            renderTableHeaders(); 
            resultArea.classList.remove('hidden'); 
            
            // ======================================================
            // Naye Changes Yahan Hain (Loading ke baad ka action)
            // ======================================================
            classSelect.disabled = true; // Class Select ko disable kar do
            selectionArea.classList.add('hidden'); // Subject Selection Area chhipa do
            // ======================================================
            
            // 4. Students Load karein:
            document.getElementById('students-body').innerHTML = ''; 
            data.students.forEach(s => addStudentRow(s.name, s.marks)); 
            
            console.log("Total students loaded:", data.students.length); // ‚¨ÖÔ∏è Students count check karein

            alert(`Class ${clsName} ka purana data load kiya gaya.`);
            
        } else {
             console.log("‚ùå Document does not exist for this class."); 
        }
    } catch(e) { 
        console.log("New sheet or error loading:", e);
    }
}
        // PDF
        window.downloadPDF = async () => {
            const el = document.getElementById('print-area');
            document.querySelectorAll('.no-print').forEach(e => e.style.display = 'none');
            
            const hiddenHeader = el.querySelector('.print-header');
            const cls = document.getElementById('class-select').value;
            hiddenHeader.classList.remove('hidden');
            hiddenHeader.innerHTML += `<p class="text-sm">Class: ${cls}</p>`;
            
            const canvas = await html2canvas(el, { scale: 2 });
            const img = canvas.toDataURL('image/png');
            
            hiddenHeader.classList.add('hidden');
            document.querySelectorAll('.no-print').forEach(e => e.style.display = '');

            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            const props = pdf.getImageProperties(img);
            const w = pdf.internal.pageSize.getWidth();
            const h = (props.height * w) / props.width;
            pdf.addImage(img, 'PNG', 0, 0, w, h);
            pdf.save(`Result_${jamiaName}_${cls}.pdf`);
        };
        // Step 1: ID nikalna (Smart Check)
const urlParams = new URLSearchParams(window.location.search);

// Hum 'id' check karenge, agar wo nahi mila to 'uid' check karenge
let reportId = urlParams.get('id') || urlParams.get('uid');

console.log("üîç Checking URL Params:", window.location.search); // Debugging ke liye

if (!reportId) {
    // Agar ID abhi bhi nahi mili, to user ko alert karo
    console.error("‚ùå Report ID Missing! URL sahi nahi hai.");
    alert("Error: Link me ID nahi hai. Kripya sahi link use karein.");
} else {
    console.log("‚úÖ Report ID Found:", reportId);
}

// Step 2: Save Function (DHYAN DEN: Yahin do baar save ho raha tha)
window.saveResult_Admin = async function() { // Function ka naam badal diya
    
    if (!reportId) {
        alert("Cannot Save: Report ID is missing.");
        return;
    }

    const saveBtn = document.getElementById('save-btn'); 
    if(saveBtn) saveBtn.innerText = "Saving...";

    try {
        const collectionName = "monthly_reports"; 
        const reportRef = doc(db, collectionName, reportId);

        console.log(`üì§ Saving to: ${collectionName}/${reportId}`);

        // Yeh code monthly_reports update karta hai (Jo pehle se exist karta hai)
        const dataToSave = typeof testData !== 'undefined' ? testData : { check: "Testing" };

        await setDoc(reportRef, { 
            monthlyTest: { 
                status: 'Done', 
                lastUpdated: new Date(),
                data: dataToSave 
            } 
        }, { merge: true });

        console.log("‚úÖ Save Success (Admin Dashboard)!");
        if(saveBtn) saveBtn.innerText = "Saved";

    } catch (error) {
        console.error("üî• Firestore Error (Admin):", error);
        if(saveBtn) saveBtn.innerText = "Try Again";
    }
};
    </script>
</body>
</html>
















