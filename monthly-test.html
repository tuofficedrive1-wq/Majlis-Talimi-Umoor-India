<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Test Sheet (Teacher View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="jameel-font.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2'); font-display: swap; }
        body { font-family: 'Poppins', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .mark-input { text-align: center; }

        /* ===== PDF FIX CSS (YAHAN ADD KARO) ===== */
    .pdf-mode table {
        width: 100% !important;
        table-layout: fixed !important;
    }

    /* ===== PDF MODE (FONT BALANCE FIX) ===== */
.pdf-mode table {
  width: 100% !important;
  table-layout: fixed !important;
}

.pdf-mode th,
.pdf-mode td {
  word-wrap: break-word;
  white-space: normal !important;

  /* üî¥ font chhota NA ho */
  font-size: 12px !important;

  /* üî¥ padding kam, taake width fit ho */
  padding: 4px 3px !important;
}

.pdf-mode .urdu-font {
  font-size: 13px !important;
}
        
        /* Grades Colors */
        .grade-mumtaz-sharf { background-color: #15803d; color: white; } /* Green Dark */
        .grade-mumtaz { background-color: #22c55e; color: white; } /* Green */
        .grade-jayyid { background-color: #eab308; color: white; } /* Yellow/Gold */
        .grade-maqbul { background-color: #f97316; color: white; } /* Orange */
        .grade-nakam { background-color: #ef4444; color: white; } /* Red */

        /* Input Validation Colors */
        .bg-fail-input { background-color: #fee2e2 !important; color: #991b1b; font-weight: bold; }
        
        .subject-checkbox:checked + div { background-color: #0d9488; color: white; border-color: #0d9488; }
            </style>
</head>
<body class="p-4">

    

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg" id="display-month">...</p>
            <p class="text-xs text-teal-300 mt-2">Teacher/Principal Portal</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Step 1: Class & Subjects Select Karein</h3>
                
                <div class="mb-4">
                    <label class="block text-gray-600 font-semibold mb-1">Class:</label>
                    <div id="class-tabs"
     class="flex flex-wrap gap-2 bg-gray-100 p-3 rounded-lg border">
</div>
                  <select id="class-select" class="hidden">
    <option value="">-- Select Class --</option>
</select>

<div id="class-tabs" class="flex flex-wrap gap-2 mt-4"></div>

<p class="text-xs text-gray-500 mt-1">
    Ek class save karne ke baad dusri select karein.
</p>

                <div id="subject-selection-area" class="hidden">
                    <p class="text-sm text-gray-500 mb-2">Is Class ki kitabon me se koi <strong>3 Kitabein</strong> select karein:</p>
                    <div class="flex gap-4 mb-4">
  <label class="flex items-center gap-2 cursor-pointer">
    <input type="checkbox" id="include-english" checked>
    <span class="font-semibold">English</span>
  </label>

  <label class="flex items-center gap-2 cursor-pointer">
    <input type="checkbox" id="include-maths" checked>
    <span class="font-semibold">Maths</span>
  </label>
</div>
                    
                    <div id="checkbox-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        </div>

                    <div class="bg-blue-50 p-3 rounded border border-blue-200 mb-4 text-sm text-blue-800 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        Note: <strong>English (25)</strong> aur <strong>Maths (25)</strong> automatically shamil rahenge. Baqi 100 number ke honge.
                    </div>

                    <button onclick="generateSheet()" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition w-full md:w-auto">
                        Result Sheet Banayein (Total 350)
                    </button>
                </div>
            </div>

            <div id="result-area" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 border-b-2 border-teal-500 pb-1">Result Sheet</h2>
                    <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>

                <div class="overflow-x-auto border rounded-lg shadow-sm" id="print-area">
                     <div class="hidden print-header text-center mb-4 pt-4">
                        <h2 class="text-2xl font-bold urdu-font" id="pdf-jamia"></h2>
                        <p id="pdf-month"></p>
                    </div>

                    <table class="w-full text-sm text-left bg-white border-collapse">
                        <thead class="bg-teal-50 text-teal-900 uppercase font-bold" id="table-head">
                            </thead>
                        <tbody id="students-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                    <button onclick="saveResult()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Save Result Sheet
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                    <button id="download-all-btn" onclick="downloadAllClassesPDF()" class="bg-purple-700 hover:bg-purple-800 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
    <i class="fas fa-layer-group"></i> Download ALL Classes
</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let monthKey = "";
        let finalSubjectsList = []; 
        let totalMax = 350; // default
        let classBooksMap = {}; 
        let selectedClassName = '';
        let activeClass = null;


        // 1. Initialize
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Invalid Link."); return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Month: ${monthKey}`;
            document.getElementById('pdf-jamia').textContent = jamiaName;
            document.getElementById('pdf-month').textContent = monthKey;

            await loadTeachingData();
        };

        function getAcademicYear(key) {
            if (!key) return null;
            const [yStr, mStr] = key.split("-");
            const yearNum  = parseInt(yStr);
            const monthNum = parseInt(mStr) - 1; 
            return monthNum >= 3 ? `${yearNum}-${yearNum+1}` : `${yearNum-1}-${yearNum}`;
        }

        // 2. Load Teaching Data
async function loadTeachingData() {
    try {
        const acYear = getAcademicYear(monthKey);
        const userDoc = await getDoc(doc(db, "users", adminUid));

        if (!userDoc.exists()) {
            alert("User data nahi mila");
            return;
        }

        const userData = userDoc.data();
        const years = userData.academicYears || {};
        const yearData = years[acYear];
        let jamiaStruct = null;

        if (yearData && Array.isArray(yearData.karkardagiStructure)) {
            jamiaStruct = yearData.karkardagiStructure.find(
                j => j.jamiaName === jamiaName
            );
        }

        if (!jamiaStruct && Array.isArray(userData.academicStructure)) {
            jamiaStruct = userData.academicStructure.find(
                j => j.jamiaName === jamiaName
            );
        }

        if (!jamiaStruct) {
            alert("Setup nahi mila. Admin se rabta karein.");
            return;
        }

        // ===============================
        // Class ‚Üí Books mapping
        // ===============================
        classBooksMap = {};

        if (Array.isArray(jamiaStruct.teachers)) {
            jamiaStruct.teachers.forEach(t => {
                if (Array.isArray(t.periods)) {
                    t.periods.forEach(p => {
                        const cName = p.className || p.class || p.darja;
                        const bName = p.bookName || p.book || p.kitab || p.subject;

                        if (cName && bName) {
                            if (!classBooksMap[cName]) {
                                classBooksMap[cName] = new Set();
                            }
                            classBooksMap[cName].add(bName);
                        }
                    });
                }
            });
        }

        // ===============================
        // ‚úÖ EXCEL STYLE CLASS TABS
        // ===============================
        const tabs = document.getElementById('class-tabs');
        const select = document.getElementById('class-select');

        tabs.innerHTML = '';
        select.innerHTML = '<option value="">-- Select Class --</option>';

        // üî¥ YAHI LINE MISSING THI
        const sortedClasses = Object.keys(classBooksMap).sort();

        sortedClasses.forEach(cls => {
            // hidden select option (JS compatibility)
            const opt = document.createElement('option');
            opt.value = cls;
            opt.textContent = cls;
            select.appendChild(opt);

            // Excel-style tab
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = cls;
            btn.dataset.class = cls;
            let baseClass =
  "px-4 py-2 rounded-lg border text-sm font-semibold transition";

if (cls === selectedClassName) {
  btn.className = baseClass + " bg-teal-600 text-white";
} else {
  btn.className = baseClass + " bg-white hover:bg-teal-600 hover:text-white";
}

           btn.onclick = () => {
    // sirf highlight toggle
    document.querySelectorAll('#class-tabs button').forEach(b => {
        b.classList.remove('bg-teal-600', 'text-white');
        b.classList.add('bg-white', 'text-gray-800');
    });

    btn.classList.remove('bg-white', 'text-gray-800');
    btn.classList.add('bg-teal-600', 'text-white');

    // value sync
    select.value = cls;

    handleClassChange();
};

            tabs.appendChild(btn);
        });

        // UI show
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

    } catch (error) {
        console.error("Error loading teaching data:", error);
    }
}

        // 3. Handle Class Change
        window.handleClassChange = () => {
            const clsName = document.getElementById('class-select').value;
            const container = document.getElementById('checkbox-container');
            const selectionArea = document.getElementById('subject-selection-area');
            const resultArea = document.getElementById('result-area');

            document.getElementById('class-select').disabled = false;
            
            container.innerHTML = '';
            resultArea.classList.add('hidden'); 

            if (!clsName) {
                selectionArea.classList.add('hidden');
                return;
            }

            // Yahan students-body ko bhi clear kar dena chahiye.
            document.getElementById('students-body').innerHTML = '';

            const rawSubjectsSet = classBooksMap[clsName];
            if (!rawSubjectsSet) return;
            
            const filteredSubjects = Array.from(rawSubjectsSet).filter(s => {
                const lower = s.toLowerCase();
                return lower !== 'english' && lower !== 'maths' && lower !== 'math' && lower !== 'mathematics';
            });

            filteredSubjects.forEach((sub) => {
                const label = document.createElement('label');
                label.className = "cursor-pointer block";
                label.innerHTML = `
                    <input type="checkbox" value="${sub}" class="subject-checkbox hidden" onchange="checkLimit(this)">
                    <div class="border p-2 rounded text-center hover:bg-teal-50 transition urdu-font select-none bg-white shadow-sm">
                        ${sub}
                    </div>
                `;
                container.appendChild(label);
            });

            selectionArea.classList.remove('hidden');
            checkExistingForClass(clsName);
        };

        window.checkLimit = (elem) => {
            const checked = document.querySelectorAll('.subject-checkbox:checked');
            if (checked.length > 3) {
                elem.checked = false;
                alert("Sirf 3 kitabein select kar sakte hain.");
            }
        };

        // 4. Generate Table
        window.generateSheet = () => {
    const checkedBoxes = document.querySelectorAll('.subject-checkbox:checked');

    if (
        document.querySelectorAll('.subject-checkbox').length > 0 &&
        checkedBoxes.length !== 3
    ) {
        if (!confirm(`Apne sirf ${checkedBoxes.length} kitabein select ki hain. Kya aap aage badhna chahte hain?`)) {
            return;
        }
    }

    const selected3 = Array.from(checkedBoxes).map(cb => cb.value);
    finalSubjectsList = [...selected3];

    // ‚úÖ English / Maths optional
    if (document.getElementById('include-english')?.checked) {
        finalSubjectsList.push('English');
    }
    if (document.getElementById('include-maths')?.checked) {
        finalSubjectsList.push('Maths');
    }

    // ‚úÖ TOTAL MAX CALCULATION (GLOBAL SET)
    totalMax = 0;
    finalSubjectsList.forEach(sub => {
        if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') {
            totalMax += 25;
        } else {
            totalMax += 100;
        }
    });

    renderTableHeaders();
    document.getElementById('result-area').classList.remove('hidden');
};

        function renderTableHeaders() {
            const head = document.getElementById('table-head');
            let html = `<tr>
                <th class="px-4 py-3 border border-gray-300 w-12">#</th>
                <th class="px-4 py-3 border border-gray-300 text-left w-1/4">Talib-e-Ilm</th>`;
            
            finalSubjectsList.forEach(sub => {
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                html += `<th class="px-4 py-3 border border-gray-300 text-center">${sub} <br><span class="text-xs font-normal text-gray-200">/${max}</span></th>`;
            });

            html += `
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Total (${totalMax})</th>
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">%</th>
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Grade</th>
                <th class="px-2 py-3 border border-gray-300 text-center text-red-500 no-print"><i class="fas fa-trash"></i></th>
            </tr>`;
            head.innerHTML = html;
        }

        // 5. Add Student Row (Updated for 'A')
        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";

            let inputs = "";
            finalSubjectsList.forEach(sub => {
                const val = marks[sub] !== undefined ? marks[sub] : "";
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                
                // Input Type Text kar diya taake 'A' likh sakein
                inputs += `<td class="border border-gray-200 p-1">
                    <input type="text" data-sub="${sub}" data-max="${max}" value="${val}" 
                           class="w-full p-2 text-center outline-none mark-input focus:bg-blue-50" 
                           oninput="calcRow(this)" placeholder="-">
                </td>`;
            });

            tr.innerHTML = `
                <td class="border border-gray-200 p-2 text-center text-gray-500">${index}</td>
                <td class="border border-gray-200 p-1"><input type="text" value="${name}" placeholder="Naam likhein" class="w-full p-2 font-semibold urdu-font outline-none std-name"></td>
                ${inputs}
                <td class="border border-gray-200 p-2 text-center font-bold text-gray-700 total-val">0</td>
                <td class="border border-gray-200 p-2 text-center font-bold text-blue-600 perc-val">0%</td>
                <td class="border border-gray-200 p-2 text-center font-bold text-xs grade-val">-</td>
                <td class="border border-gray-200 p-2 text-center cursor-pointer text-red-400 hover:text-red-600 no-print" onclick="this.parentElement.remove()">√ó</td>
            `;
            tbody.appendChild(tr);
            if(name) calcRow(tr.querySelector('input'));
        };

        // 6. Calculation Logic (Updated: Absent = Direct Fail)
window.calcRow = (el) => {
    const row = el.closest('tr');
    let obtained = 0;
    let hasAbsent = false; // üî¥ Flag: Check karne ke liye ki student absent hai ya nahi
    
    const inputs = row.querySelectorAll('.mark-input');
    
    inputs.forEach(inp => {
        const max = parseInt(inp.dataset.max); 
        let rawVal = inp.value.trim().toUpperCase();
        
        // 1. Validation (Numbers or A)
        if (rawVal !== 'A' && rawVal !== '') {
            if (isNaN(parseFloat(rawVal)) || !isFinite(rawVal)) {
                inp.value = '';
                rawVal = '';
            }
        }

        // 2. Marks Calculation
        let numVal = 0;
        
        if (rawVal === 'A') {
            hasAbsent = true; // üî¥ Agar 'A' mila, to flag ko TRUE kar do
            numVal = 0;
            inp.style.color = 'red';
            inp.classList.add('bg-fail-input');
        } else if (rawVal === '') {
            numVal = 0;
            inp.classList.remove('bg-fail-input');
            inp.style.color = '';
        } else {
            numVal = parseFloat(rawVal);
            
            if (numVal > max) {
                alert(`Maximum marks ${max} hain.`);
                inp.value = max;
                numVal = max;
            }

            // Passing Marks Logic (Fail Color check)
            const pass = max === 25 ? 10 : 40; 
            if (numVal < pass) {
                inp.classList.add('bg-fail-input');
            } else {
                inp.classList.remove('bg-fail-input');
                inp.style.color = '';
            }
        }
        
        obtained += numVal;
    });
    
    // Total Max Calculation
    let totalMax = 0;
    finalSubjectsList.forEach(sub => {
        if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') {
            totalMax += 25;
        } else {
            totalMax += 100;
        }
    });

    const percent = totalMax > 0 ? (obtained / totalMax * 100).toFixed(1) : 0;
    
    row.querySelector('.total-val').textContent = obtained;
    row.querySelector('.perc-val').textContent = percent + '%';
    
    // Grade Logic
    let grade = "Nakam";
    let cls = "grade-nakam";
    const p = parseFloat(percent);

    if (p >= 80) { grade = "Mumtaz Ma Sharf"; cls = "grade-mumtaz-sharf"; }
    else if (p >= 70) { grade = "Mumtaz"; cls = "grade-mumtaz"; }
    else if (p >= 50) { grade = "Jayyid"; cls = "grade-jayyid"; }
    else if (p >= 40) { grade = "Maqbul"; cls = "grade-maqbul"; }
    else { grade = "Nakam"; cls = "grade-nakam"; }
    
    // üî¥ FINAL CHECK: Agar ek subject me bhi 'A' hai, to result 'Nakam' kar do
    if (hasAbsent) {
        grade = "Nakam";
        cls = "grade-nakam";
    }
    
    const gVal = row.querySelector('.grade-val');
    gVal.textContent = grade;
    gVal.className = `border border-gray-200 p-2 text-center font-bold text-xs grade-val ${cls} rounded`;
};

        // 7. Save Logic
        window.saveResult = async () => {
            const rows = document.querySelectorAll('#students-body tr');
            if(rows.length === 0) { alert("Koi student add nahi kiya gaya."); return; }
            
            // FIX 1: Doc ID ko sirf ek baar define karein (Syntax Error theek kiya)
            const rawClass = document.getElementById('class-select').value;
            const cleanClass = rawClass.split('_')[0]; 
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`; 
            console.log("üíæ Doc ID used for SAVE:", docId); // Debug Log
            
            const selectedClass = rawClass; // Poora class name Firestore mein save hoga

            const students = [];
            let grandObtained = 0;
            let grandMax = 0;

            rows.forEach(row => {
                const name = row.querySelector('.std-name').value.trim();
                if(!name) return;
                
                const marks = {};
                row.querySelectorAll('.mark-input').forEach(inp => {
                    // Save as String if 'A', else Number
                    const val = inp.value.trim().toUpperCase();
                    marks[inp.dataset.sub] = (val === 'A') ? 'A' : (val === '' ? 0 : parseFloat(val));
                });
                
                const total = parseFloat(row.querySelector('.total-val').textContent);
                const perc = parseFloat(row.querySelector('.perc-val').textContent);
                students.push({ name, marks, total, percentage: perc });
                
                grandObtained += total;
                grandMax += 350;
            });

            const overallPerc = grandMax > 0 ? ((grandObtained / grandMax) * 100).toFixed(1) + '%' : '0%';
            
            try {
                // ‚úÖ Save to monthly_test_sheets
                await setDoc(doc(db, "monthly_test_sheets", docId), {
                    adminUid, jamiaName, month: monthKey, class: selectedClass,
                    subjects: finalSubjectsList, students, updatedAt: serverTimestamp()
                }); 
                
                console.log("‚úÖ Data successfully saved to monthly_test_sheets with ID:", docId); // Confirmation Log

                // Update Admin Dashboard
                const [yStr, mStr] = monthKey.split('-');
                const y = parseInt(yStr);
                const m = parseInt(mStr) - 1;
                const acYear = m >= 3 ? `${y}-${y + 1}` : `${y - 1}-${y}`;
                const reportId = `${adminUid}_${acYear}_${y}_${m}`;

                const reportRef = doc(db, 'monthly_reports', reportId);
                const reportSnap = await getDoc(reportRef);
                let testData = reportSnap.exists() ? (reportSnap.data().monthlyTest?.data || []) : [];
                
                // Update specific entry
                testData = testData.filter(t => t.name !== jamiaName);
                testData.push({
                    name: jamiaName, status: 'Test Hua', month: monthKey,
                    percentage: overallPerc, wajah: ''
                });

                await setDoc(reportRef, { monthlyTest: { status: 'Done', data: testData } }, { merge: true });

                alert(`Class ${selectedClass} ka Result Save ho gaya!`);
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error: " + error.message);
            }
        };

       // 8. Load Existing
async function checkExistingForClass(clsName) {
    
    // FIX 2: Doc ID ko sirf ek baar define karein (Syntax Error theek kiya)
    const cleanClass = clsName.split('_')[0]; 
    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
    
    console.log("üîé Doc ID used for LOAD:", docId); // Debug Log
    
    const resultArea = document.getElementById('result-area');
    const studentsBody = document.getElementById('students-body');
    const classSelect = document.getElementById('class-select');
    const selectionArea = document.getElementById('subject-selection-area'); 

    // **Step 1: Subjects aur Table ko Reset Karein (Important!)**
    finalSubjectsList = [];
    studentsBody.innerHTML = '';
    resultArea.classList.add('hidden'); 
    document.getElementById('table-head').innerHTML = '';
    
    // Select kiye gaye subjects ke checkboxes ko uncheck karein
    document.querySelectorAll('.subject-checkbox').forEach(chk => chk.checked = false);
    
    // Hamesha Class Select ko enable rakhein shuru mein
    classSelect.disabled = false; 

    console.log("Attempting to load docId:", docId); // ‚¨ÖÔ∏è Doc ID check karein
    
    try {
        const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
        
        if (snap.exists()) {
            const data = snap.data(); 
            
            console.log("‚úÖ Data Found:", data); // ‚¨ÖÔ∏è Data object ko check karein
            
            // 1. Subjects ko Check karein:
            const allChecks = document.querySelectorAll('.subject-checkbox');
            const savedVariableSubjects = data.subjects.filter(s => s !== 'English' && s !== 'Maths');
            
            allChecks.forEach(chk => {
                if (savedVariableSubjects.includes(chk.value)) chk.checked = true;
            });
            
            // 2. Final Subjects Set karein:
            finalSubjectsList = data.subjects;
            
            // 3. Header aur Result Area dikhayein:
            renderTableHeaders(); 
            resultArea.classList.remove('hidden'); 
            
            // ======================================================
            // Naye Changes Yahan Hain (Loading ke baad ka action)
            // ======================================================
            classSelect.disabled = true; // Class Select ko disable kar do
            selectionArea.classList.add('hidden'); // Subject Selection Area chhipa do
            // ======================================================
            
            // 4. Students Load karein:
            document.getElementById('students-body').innerHTML = ''; 
            data.students.forEach(s => addStudentRow(s.name, s.marks)); 
            
            console.log("Total students loaded:", data.students.length); // ‚¨ÖÔ∏è Students count check karein

            alert(`Class ${clsName} ka purana data load kiya gaya.`);
            
        } else {
             console.log("‚ùå Document does not exist for this class."); 
        }
    } catch(e) { 
        console.log("New sheet or error loading:", e);
    }
}
        window.downloadPDF = async () => {
    // 1. Library Check
    if (!window.html2canvas) {
        alert("Error: html2canvas library missing hai.");
        return;
    }

    const saveBtn = document.querySelector('button[onclick="downloadPDF()"]');
    if(saveBtn) saveBtn.innerText = "Processing...";

    // Original Data
    const originalTableBody = document.getElementById('students-body');
    const tableHeadHTML = document.getElementById('table-head').innerHTML;
    
    // Header Info
    const jamiaTitle = document.getElementById('pdf-jamia').innerText;
    const currentClass = document.getElementById('class-select').value || "";
    const monthText = `Month: ${monthKey}  |  Class: ${currentClass}`;

    // --- STEP A: Temporary Container ---
    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0px';
    // Width 1100px rakhi hai taaki quality achi rahe A4 Landscape par
    tempContainer.style.width = '1100px'; 
    document.body.appendChild(tempContainer);

    // üî• SETTING 1: HEIGHT LIMIT BADHAYI (Pehle 700 tha, ab 765 kiya)
    // Isse page ke bottom tak print hoga
    const PAGE_HEIGHT_LIMIT = 765; 
    
    // Helper: Naya Page Banane ka function
    function createNewPage() {
        const pageDiv = document.createElement('div');
        // üî• SETTING 2: PADDING KAM KI (p-6 ki jagah p-3)
        pageDiv.className = "bg-white p-3 border-none"; 
        pageDiv.style.width = "100%";
        pageDiv.style.backgroundColor = "white";

        // üî• SETTING 3: HEADER MARGIN KAM KIYA
        pageDiv.innerHTML = `
            <div class="text-center mb-2"> <h2 class="text-xl font-bold urdu-font" style="font-family: 'Jameel Noori Nastaleeq', serif; margin-bottom: 2px;">${jamiaTitle}</h2>
                <p style="color: #333; font-size: 13px; margin-top: 0px;">${monthText}</p>
            </div>
            <table class="w-full text-sm text-left border-collapse" style="width: 100%; table-layout: fixed;">
                <thead class="bg-teal-50 text-teal-900 uppercase font-bold text-center">
                    ${tableHeadHTML}
                </thead>
                <tbody class="divide-y divide-gray-200">
                </tbody>
            </table>
        `;
        
        // Delete button header remove
        const ths = pageDiv.querySelectorAll('th');
        if(ths.length > 0) ths[ths.length - 1].remove(); 

        tempContainer.appendChild(pageDiv);
        return pageDiv;
    }

    try {
        // --- STEP B: Rows Divide Logic ---
        const rows = Array.from(originalTableBody.querySelectorAll('tr'));
        
        let currentPage = createNewPage();
        let currentTbody = currentPage.querySelector('tbody');

        for (let row of rows) {
            const clonedRow = row.cloneNode(true);
            
            // Delete Column Hatana
            const lastTd = clonedRow.querySelector('td:last-child');
            if(lastTd) lastTd.remove();

            // Inputs to Text Conversion
            const inputs = clonedRow.querySelectorAll('input');
            inputs.forEach(input => {
                const div = document.createElement('div');
                div.innerText = input.value || '-';
                
                // üî• SETTING 4: COMPACT STYLING (Padding kam ki)
                div.style.textAlign = "center";
                div.style.fontWeight = "bold";
                div.style.border = "none";
                div.style.background = "transparent";
                div.style.width = "100%";
                div.style.padding = "2px 0"; // Padding bilkul kam kar di
                div.style.fontSize = "13px"; // Font size adjust

                if(input.classList.contains('bg-fail-input')) {
                    div.style.backgroundColor = "#fee2e2"; 
                    div.style.color = "#991b1b";
                }
                
                if(input.parentNode) input.parentNode.replaceChild(div, input);
            });
            
            // Table Cells (TD) ki padding bhi kam karein
            clonedRow.querySelectorAll('td').forEach(td => {
                td.style.padding = "3px 2px"; // Row height kam ho jayegi
            });

            // Add & Check Height
            currentTbody.appendChild(clonedRow);
            
            if (currentPage.offsetHeight > PAGE_HEIGHT_LIMIT) {
                currentTbody.removeChild(clonedRow);
                currentPage = createNewPage();
                currentTbody = currentPage.querySelector('tbody');
                currentTbody.appendChild(clonedRow);
            }
        }

        // --- STEP C: Generate PDF ---
        const pages = tempContainer.querySelectorAll('div.bg-white');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');

        for (let i = 0; i < pages.length; i++) {
            const page = pages[i];
            
            const canvas = await html2canvas(page, { 
                scale: 2, 
                useCORS: true,
                backgroundColor: "#ffffff"
            });
            
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 297; 
            const imgHeight = canvas.height * imgWidth / canvas.width;

            if (i > 0) doc.addPage();
            doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        }

        document.body.removeChild(tempContainer);
        const cls = document.getElementById('class-select').value || 'Sheet';
        doc.save(`Result_${jamiaName}_${cls}.pdf`);

    } catch (error) {
        console.error("PDF Logic Error:", error);
        alert("PDF Generation Failed: " + error.message);
    } finally {
        if(saveBtn) saveBtn.innerText = "Download PDF";
    }
};

window.downloadAllClassesPDF = async () => {
    // 1. Library Check
    if (!window.html2canvas) { alert("html2canvas library missing hai."); return; }

    const btn = document.getElementById('download-all-btn');
    const originalText = btn.innerText;
    btn.innerText = "Processing..."; // Button text change
    btn.disabled = true;             // Button disable taaki do baar click na ho

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // Landscape PDF
        let pageCount = 0;

        // System me jitni bhi classes hain unki list nikalein
        const allClasses = Object.keys(classBooksMap).sort();

        // --- LOOP: Har Class ke liye ---
        for (const clsName of allClasses) {
            
            // Button par dikhayein ki kaunsi class chal rahi hai
            btn.innerText = `Generating: ${clsName}...`;

            // 1. Firestore se Data layein
            const cleanClass = clsName.split('_')[0]; 
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
            
            const docSnap = await getDoc(doc(db, "monthly_test_sheets", docId));

            // Agar is class ka result save nahi hai, to skip karein
            if (!docSnap.exists()) {
                console.log(`Class ${clsName} ka data nahi mila, skipping...`);
                continue;
            }

            const data = docSnap.data();
            const students = data.students || [];
            const subjects = data.subjects || [];

            if (students.length === 0) continue; // Agar students nahi hain to skip

            // --- 2. Temporary HTML Structure Banayein ---
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.width = '1100px'; // A4 Width Fixed
            document.body.appendChild(tempContainer);

            // Table Header Generate Karein
            let headerHTML = `<tr>
                <th class="px-2 py-1 border border-gray-300 w-12">#</th>
                <th class="px-2 py-1 border border-gray-300 text-left w-1/4">Talib-e-Ilm</th>`;
            
            let totalMax = 0;
            subjects.forEach(sub => {
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                totalMax += max;
                headerHTML += `<th class="px-2 py-1 border border-gray-300 text-center">${sub} <br><span class="text-xs font-normal text-gray-400">/${max}</span></th>`;
            });

            headerHTML += `
                <th class="px-2 py-1 border border-gray-300 text-center bg-gray-100">Total (${totalMax})</th>
                <th class="px-2 py-1 border border-gray-300 text-center bg-gray-100">%</th>
                <th class="px-2 py-1 border border-gray-300 text-center bg-gray-100">Grade</th>
            </tr>`;

            // Page Helper (Same "Compact" styling as before)
            const PAGE_HEIGHT_LIMIT = 765; 

            function createNewPage() {
                const pageDiv = document.createElement('div');
                pageDiv.className = "bg-white p-3 border-none"; 
                pageDiv.style.width = "100%";
                pageDiv.style.backgroundColor = "white";

                pageDiv.innerHTML = `
                    <div class="text-center mb-2">
                        <h2 class="text-xl font-bold urdu-font" style="font-family: 'Jameel Noori Nastaleeq', serif; margin-bottom: 2px;">${jamiaName}</h2>
                        <p style="color: #333; font-size: 13px; margin-top: 0px;">Month: ${monthKey}  |  Class: ${clsName}</p>
                    </div>
                    <table class="w-full text-sm text-left border-collapse" style="width: 100%; table-layout: fixed;">
                        <thead class="bg-teal-50 text-teal-900 uppercase font-bold text-center">
                            ${headerHTML}
                        </thead>
                        <tbody class="divide-y divide-gray-200"></tbody>
                    </table>
                `;
                tempContainer.appendChild(pageDiv);
                return pageDiv;
            }

            // --- 3. Rows Fill Karein ---
            let currentPage = createNewPage();
            let currentTbody = currentPage.querySelector('tbody');

            for (let i = 0; i < students.length; i++) {
                const std = students[i];
                const tr = document.createElement('tr');
                
                let tds = "";
                let hasAbsent = false; // üî¥ Absent Logic Check

                subjects.forEach(sub => {
                    let val = std.marks[sub];
                    if (val === undefined) val = "-";
                    
                    let cellStyle = "background: transparent;";
                    let displayVal = val;

                    // Check 'A' (Absent) or Fail Marks
                    if (val === 'A') {
                        hasAbsent = true;
                        cellStyle = "background-color: #fee2e2; color: #991b1b;"; // Fail Color
                    } else if (val !== '-' && typeof val === 'number') {
                         const max = (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') ? 25 : 100;
                         const pass = max === 25 ? 10 : 40;
                         if (val < pass) cellStyle = "background-color: #fee2e2; color: #991b1b;";
                    }

                    tds += `<td class="border border-gray-300 p-1 text-center font-bold" style="${cellStyle} padding: 3px 2px; font-size: 13px;">${displayVal}</td>`;
                });

                // Grade Calculation (Absent = Nakam Logic)
                let grade = "Nakam";
                let cls = "background-color: #ef4444; color: white;"; // Red Default
                const p = parseFloat(std.percentage);

                if (p >= 80) { grade = "Mumtaz Ma Sharf"; cls = "background-color: #15803d; color: white;"; }
                else if (p >= 70) { grade = "Mumtaz"; cls = "background-color: #22c55e; color: white;"; }
                else if (p >= 50) { grade = "Jayyid"; cls = "background-color: #eab308; color: white;"; }
                else if (p >= 40) { grade = "Maqbul"; cls = "background-color: #f97316; color: white;"; }
                else { grade = "Nakam"; cls = "background-color: #ef4444; color: white;"; }

                // üî¥ Agar 'A' hai to Force Fail
                if (hasAbsent) {
                    grade = "Nakam";
                    cls = "background-color: #ef4444; color: white;";
                }

                tr.innerHTML = `
                    <td class="border border-gray-300 p-1 text-center text-gray-500" style="padding: 3px 2px;">${i + 1}</td>
                    <td class="border border-gray-300 p-1 font-semibold urdu-font text-center" style="padding: 3px 2px; font-size: 14px;">${std.name}</td>
                    ${tds}
                    <td class="border border-gray-300 p-1 text-center font-bold" style="padding: 3px 2px;">${std.total}</td>
                    <td class="border border-gray-300 p-1 text-center font-bold text-blue-600" style="padding: 3px 2px;">${std.percentage}%</td>
                    <td class="border border-gray-300 p-1 text-center font-bold text-xs rounded" style="${cls} padding: 3px 2px;">${grade}</td>
                `;

                // Add Row & Pagination Check
                currentTbody.appendChild(tr);

                if (currentPage.offsetHeight > PAGE_HEIGHT_LIMIT) {
                    currentTbody.removeChild(tr); // Wapas nikalo
                    currentPage = createNewPage(); // Naya page banao
                    currentTbody = currentPage.querySelector('tbody');
                    currentTbody.appendChild(tr); // Wahan daalo
                }
            }

            // --- 4. Capture Pages & Add to PDF ---
            const pages = tempContainer.querySelectorAll('div.bg-white');
            for (let j = 0; j < pages.length; j++) {
                const page = pages[j];
                const canvas = await html2canvas(page, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 297; // A4 Landscape mm
                const imgHeight = canvas.height * imgWidth / canvas.width;

                if (pageCount > 0) doc.addPage();
                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pageCount++;
            }

            // Cleanup temp container
            document.body.removeChild(tempContainer);
        }

        // --- 5. Save Final PDF ---
        if (pageCount === 0) {
            alert("Koi bhi saved data nahi mila. Pehle 'Save Result' karein.");
        } else {
            doc.save(`All_Classes_Result_${jamiaName}_${monthKey}.pdf`);
        }

    } catch (error) {
        console.error("PDF Error:", error);
        alert("Error: " + error.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};
        // Step 1: ID nikalna (Smart Check)
const urlParams = new URLSearchParams(window.location.search);

// Hum 'id' check karenge, agar wo nahi mila to 'uid' check karenge
let reportId = urlParams.get('id') || urlParams.get('uid');

console.log("üîç Checking URL Params:", window.location.search); // Debugging ke liye

if (!reportId) {
    // Agar ID abhi bhi nahi mili, to user ko alert karo
    console.error("‚ùå Report ID Missing! URL sahi nahi hai.");
    alert("Error: Link me ID nahi hai. Kripya sahi link use karein.");
} else {
    console.log("‚úÖ Report ID Found:", reportId);
}

// Step 2: Save Function (DHYAN DEN: Yahin do baar save ho raha tha)
window.saveResult_Admin = async function() { // Function ka naam badal diya
    
    if (!reportId) {
        alert("Cannot Save: Report ID is missing.");
        return;
    }

    const saveBtn = document.getElementById('save-btn'); 
    if(saveBtn) saveBtn.innerText = "Saving...";

    try {
        const collectionName = "monthly_reports"; 
        const reportRef = doc(db, collectionName, reportId);

        console.log(`üì§ Saving to: ${collectionName}/${reportId}`);

        // Yeh code monthly_reports update karta hai (Jo pehle se exist karta hai)
        const dataToSave = typeof testData !== 'undefined' ? testData : { check: "Testing" };

        await setDoc(reportRef, { 
            monthlyTest: { 
                status: 'Done', 
                lastUpdated: new Date(),
                data: dataToSave 
            } 
        }, { merge: true });

        console.log("‚úÖ Save Success (Admin Dashboard)!");
        if(saveBtn) saveBtn.innerText = "Saved";

    } catch (error) {
        console.error("üî• Firestore Error (Admin):", error);
        if(saveBtn) saveBtn.innerText = "Try Again";
    }
};
    </script>
</body>
</html>









































