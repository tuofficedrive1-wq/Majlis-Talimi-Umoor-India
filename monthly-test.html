<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Test Sheet (Teacher View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="jameel-font.js"></script> 

    <style>
        @font-face { 
            font-family: 'Jameel Noori Nastaleeq'; 
            src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2'); 
            font-display: swap; 
        }
        body { font-family: 'Poppins', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .mark-input { text-align: center; }

        /* Grades Colors */
        .grade-mumtaz-sharf { background-color: #15803d; color: white; } 
        .grade-mumtaz { background-color: #22c55e; color: white; } 
        .grade-jayyid { background-color: #eab308; color: white; } 
        .grade-maqbul { background-color: #f97316; color: white; } 
        .grade-nakam { background-color: #ef4444; color: white; } 

        /* Input Validation Colors */
        .bg-fail-input { background-color: #fee2e2 !important; color: #991b1b; font-weight: bold; }
        
        .subject-checkbox:checked + div { background-color: #0d9488; color: white; border-color: #0d9488; }

        /* Summary Table Borders */
        #summary-view-area table th, 
        #summary-view-area table td {
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg" id="display-month">...</p>
            <span id="pdf-jamia" class="hidden"></span>
            <span id="pdf-month" class="hidden"></span>
            <p class="text-xs text-teal-300 mt-2">Teacher/Principal Portal</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="flex justify-between items-center mb-6 no-print">
                <h2 class="text-2xl font-bold text-teal-800 urdu-font">Result Entry Panel</h2>
                <div class="flex gap-2">
                    <button onclick="toggleSummary()" id="btn-view-summary" class="bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2">
                        <i class="fas fa-chart-bar"></i> View Summary
                    </button>
                    <button onclick="toggleSummary()" id="btn-back-entry" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back to Entry
                    </button>
                </div>
            </div>

            <div id="summary-view-area" class="hidden">
                <div class="bg-white shadow-lg rounded-lg overflow-hidden border border-purple-200 mb-8">
                    <div class="bg-purple-700 text-white text-center py-2 font-bold text-xl font-serif">
                        Result Summary (All Subjects)
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-center border-collapse">
                            <thead>
                                <tr class="bg-purple-100 text-purple-900 text-sm font-bold">
                                    <th class="p-2">S.No.</th>
                                    <th class="p-2 text-left">Class</th>
                                    <th class="p-2">Total Students</th>
                                    <th class="p-2">Present</th>
                                    <th class="p-2">Pass</th>
                                    <th class="p-2">Fail</th>
                                    <th class="p-2">Percent</th>
                                    <th class="p-2">Grade</th>
                                </tr>
                            </thead>
                            <tbody id="summary-body-main" class="text-sm"></tbody>
                            <tfoot id="summary-foot-main" class="font-bold text-white"></tfoot>
                        </table>
                    </div>
                </div>

                <div class="bg-white shadow-lg rounded-lg overflow-hidden border border-purple-200 mb-8">
                    <div class="bg-purple-700 text-white text-center py-2 font-bold text-xl font-serif">
                        (Asri) Result Summary (English & Maths)
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-center border-collapse">
                            <thead>
                                <tr class="bg-purple-100 text-purple-900 text-sm font-bold">
                                    <th class="p-2">S.No.</th>
                                    <th class="p-2 text-left">Class</th>
                                    <th class="p-2">Total Students</th>
                                    <th class="p-2">Present (In Asri)</th>
                                    <th class="p-2">Pass</th>
                                    <th class="p-2">Fail</th>
                                    <th class="p-2">Percent</th>
                                    <th class="p-2">Grade</th>
                                </tr>
                            </thead>
                            <tbody id="summary-body-asri" class="text-sm"></tbody>
                            <tfoot id="summary-foot-asri" class="font-bold text-white"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="data-entry-area">
                <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <h3 id="step-heading" class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Step 1: Class & Subjects Select Karein</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-600 font-semibold mb-1">Class:</label>
                        <div id="class-tabs" class="flex flex-wrap gap-2 mt-4"></div>
                        
                        <select id="class-select" class="hidden">
                            <option value="">-- Select Class --</option>
                        </select>
                    </div>

                    <p id="step-instruction" class="text-xs text-gray-500 mt-1">
                        Ek class save karne ke baad dusri select karein.
                    </p>

                    <div id="subject-selection-area" class="hidden mt-4">
                        <p class="text-sm text-gray-500 mb-2">Is Class ki kitabon me se koi <strong>3 Kitabein</strong> select karein:</p>
                        <div class="flex gap-4 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="include-english" checked>
                                <span class="font-semibold">English</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="include-maths" checked>
                                <span class="font-semibold">Maths</span>
                            </label>
                        </div>
                        
                        <div id="checkbox-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>

                        <div class="bg-blue-50 p-3 rounded border border-blue-200 mb-4 text-sm text-blue-800 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>
                            Note: <strong>English (25)</strong> aur <strong>Maths (25)</strong> automatically shamil rahenge. Baqi 100 number ke honge.
                        </div>

                        <button onclick="generateSheet()" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition w-full md:w-auto">
                            Result Sheet Banayein (Total 350)
                        </button>
                    </div>
                </div>

                <div id="result-area" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 border-b-2 border-teal-500 pb-1">Result Sheet</h2>
                        <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>

                    <div class="overflow-x-auto border rounded-lg shadow-sm" id="print-area">
                        <table class="w-full text-sm text-left bg-white border-collapse">
                            <thead class="bg-teal-50 text-teal-900 uppercase font-bold" id="table-head"></thead>
                            <tbody id="students-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>

                    <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                        <button onclick="saveResult()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                            <i class="fas fa-save"></i> Save Result Sheet
                        </button>
                        <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                        <button id="download-all-btn" onclick="downloadAllClassesPDF()" class="bg-purple-700 hover:bg-purple-800 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                            <i class="fas fa-layer-group"></i> Download ALL Classes
                        </button>
                    </div>
                </div>
            </div> </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let monthKey = "";
        let finalSubjectsList = []; 
        let totalMax = 350; 
        let classBooksMap = {}; 
        let selectedClassName = '';

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            // Fallback support for 'id' if 'uid' is missing (as seen in older links)
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Link Invalid hai. Link me ID, Jamia, ya Month missing hai."); return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Month: ${monthKey}`;
            
            // Set hidden fields for PDF
            if(document.getElementById('pdf-jamia')) document.getElementById('pdf-jamia').textContent = jamiaName;
            if(document.getElementById('pdf-month')) document.getElementById('pdf-month').textContent = monthKey;

            await loadTeachingData();
        };

        function getAcademicYear(key) {
            if (!key) return null;
            const [yStr, mStr] = key.split("-");
            const yearNum  = parseInt(yStr);
            const monthNum = parseInt(mStr) - 1; 
            return monthNum >= 3 ? `${yearNum}-${yearNum+1}` : `${yearNum-1}-${yearNum}`;
        }

        async function loadTeachingData() {
            try {
                const acYear = getAcademicYear(monthKey);
                const userDoc = await getDoc(doc(db, "users", adminUid));
                if (!userDoc.exists()) { alert("User data nahi mila"); return; }
                const userData = userDoc.data();
                const years = userData.academicYears || {};
                const yearData = years[acYear];
                let jamiaStruct = null;
                
                // Prioritize Year-based structure
                if (yearData && Array.isArray(yearData.karkardagiStructure)) {
                    jamiaStruct = yearData.karkardagiStructure.find(j => j.jamiaName === jamiaName);
                }
                // Fallback to old structure
                if (!jamiaStruct && Array.isArray(userData.academicStructure)) {
                    jamiaStruct = userData.academicStructure.find(j => j.jamiaName === jamiaName);
                }
                if (!jamiaStruct) { alert("Setup nahi mila. Admin se rabta karein."); return; }

                classBooksMap = {};
                if (Array.isArray(jamiaStruct.teachers)) {
                    jamiaStruct.teachers.forEach(t => {
                        if (Array.isArray(t.periods)) {
                            t.periods.forEach(p => {
                                const cName = p.className || p.class || p.darja;
                                const bName = p.bookName || p.book || p.kitab || p.subject;
                                if (cName && bName) {
                                    if (!classBooksMap[cName]) classBooksMap[cName] = new Set();
                                    classBooksMap[cName].add(bName);
                                }
                            });
                        }
                    });
                }

                const tabs = document.getElementById('class-tabs');
                const select = document.getElementById('class-select');
                tabs.innerHTML = '';
                select.innerHTML = '<option value="">-- Select Class --</option>';

                const sortedClasses = Object.keys(classBooksMap).sort();
                sortedClasses.forEach(cls => {
                    const opt = document.createElement('option');
                    opt.value = cls;
                    opt.textContent = cls;
                    select.appendChild(opt);

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = cls;
                    btn.dataset.class = cls;
                    let baseClass = "px-4 py-2 rounded-lg border text-sm font-semibold transition";
                    btn.className = baseClass + " bg-white hover:bg-teal-600 hover:text-white";
                    
                    btn.onclick = () => {
                        document.querySelectorAll('#class-tabs button').forEach(b => {
                            b.classList.remove('bg-teal-600', 'text-white');
                            b.classList.add('bg-white', 'text-gray-800');
                        });
                        btn.classList.remove('bg-white', 'text-gray-800');
                        btn.classList.add('bg-teal-600', 'text-white');
                        select.value = cls;
                        handleClassChange();
                    };
                    tabs.appendChild(btn);
                });

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } catch (error) { console.error("Error loading data:", error); }
        }

        window.handleClassChange = () => {
            const clsName = document.getElementById('class-select').value;
            const container = document.getElementById('checkbox-container');
            const selectionArea = document.getElementById('subject-selection-area');
            const resultArea = document.getElementById('result-area');

            container.innerHTML = '';
            resultArea.classList.add('hidden'); 
            document.getElementById('students-body').innerHTML = ''; // Clear previous students

            if (!clsName) { selectionArea.classList.add('hidden'); return; }

            const rawSubjectsSet = classBooksMap[clsName];
            if (!rawSubjectsSet) return;
            const filteredSubjects = Array.from(rawSubjectsSet).filter(s => {
                const lower = s.toLowerCase();
                return lower !== 'english' && lower !== 'maths' && lower !== 'math' && lower !== 'mathematics';
            });
            filteredSubjects.forEach((sub) => {
                const label = document.createElement('label');
                label.className = "cursor-pointer block";
                label.innerHTML = `<input type="checkbox" value="${sub}" class="subject-checkbox hidden" onchange="checkLimit(this)"><div class="border p-2 rounded text-center hover:bg-teal-50 transition urdu-font select-none bg-white shadow-sm">${sub}</div>`;
                container.appendChild(label);
            });
            selectionArea.classList.remove('hidden');
            checkExistingForClass(clsName);
        };

        window.checkLimit = (elem) => {
            const checked = document.querySelectorAll('.subject-checkbox:checked');
            if (checked.length > 3) {
                elem.checked = false;
                alert("Sirf 3 kitabein select kar sakte hain.");
            }
        };

        window.generateSheet = () => {
            const checkedBoxes = document.querySelectorAll('.subject-checkbox:checked');
            if (document.querySelectorAll('.subject-checkbox').length > 0 && checkedBoxes.length !== 3) {
                if (!confirm(`Apne sirf ${checkedBoxes.length} kitabein select ki hain. Kya aap aage badhna chahte hain?`)) return;
            }
            const selected3 = Array.from(checkedBoxes).map(cb => cb.value);
            finalSubjectsList = [...selected3];
            if (document.getElementById('include-english')?.checked) finalSubjectsList.push('English');
            if (document.getElementById('include-maths')?.checked) finalSubjectsList.push('Maths');

            totalMax = 0;
            finalSubjectsList.forEach(sub => {
                if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') totalMax += 25;
                else totalMax += 100;
            });
            renderTableHeaders();
            document.getElementById('result-area').classList.remove('hidden');
        };

        function renderTableHeaders() {
            const head = document.getElementById('table-head');
            let html = `<tr><th class="px-4 py-3 border border-gray-300 w-12">#</th><th class="px-4 py-3 border border-gray-300 text-left w-1/4">Talib-e-Ilm</th>`;
            finalSubjectsList.forEach(sub => {
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                html += `<th class="px-4 py-3 border border-gray-300 text-center">${sub} <br><span class="text-xs font-normal text-gray-200">/${max}</span></th>`;
            });
            html += `<th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Total (${totalMax})</th><th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">%</th><th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Grade</th><th class="px-2 py-3 border border-gray-300 text-center text-red-500 no-print"><i class="fas fa-trash"></i></th></tr>`;
            head.innerHTML = html;
        }

        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            let inputs = "";
            finalSubjectsList.forEach(sub => {
                const val = marks[sub] !== undefined ? marks[sub] : "";
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                inputs += `<td class="border border-gray-200 p-1"><input type="text" data-sub="${sub}" data-max="${max}" value="${val}" class="w-full p-2 text-center outline-none mark-input focus:bg-blue-50" oninput="calcRow(this)" placeholder="-"></td>`;
            });
            tr.innerHTML = `<td class="border border-gray-200 p-2 text-center text-gray-500">${index}</td><td class="border border-gray-200 p-1"><input type="text" value="${name}" placeholder="Naam likhein" class="w-full p-2 font-semibold urdu-font outline-none std-name"></td>${inputs}<td class="border border-gray-200 p-2 text-center font-bold text-gray-700 total-val">0</td><td class="border border-gray-200 p-2 text-center font-bold text-blue-600 perc-val">0%</td><td class="border border-gray-200 p-2 text-center font-bold text-xs grade-val">-</td><td class="border border-gray-200 p-2 text-center cursor-pointer text-red-400 hover:text-red-600 no-print" onclick="this.parentElement.remove()">Ã—</td>`;
            tbody.appendChild(tr);
            if(name) calcRow(tr.querySelector('input'));
        };

        window.calcRow = (el) => {
            const row = el.closest('tr');
            let obtained = 0;
            let hasAbsent = false;
            row.querySelectorAll('.mark-input').forEach(inp => {
                const max = parseInt(inp.dataset.max);
                let rawVal = inp.value.trim().toUpperCase();
                if (rawVal !== 'A' && rawVal !== '') { if (isNaN(parseFloat(rawVal))) { inp.value = ''; rawVal = ''; } }
                let numVal = 0;
                if (rawVal === 'A') { hasAbsent = true; numVal = 0; inp.style.color = 'red'; inp.classList.add('bg-fail-input'); }
                else if (rawVal === '') { numVal = 0; inp.classList.remove('bg-fail-input'); inp.style.color = ''; }
                else {
                    numVal = parseFloat(rawVal);
                    if (numVal > max) { alert(`Maximum marks ${max} hain.`); inp.value = max; numVal = max; }
                    const pass = max === 25 ? 10 : 40;
                    if (numVal < pass) inp.classList.add('bg-fail-input'); else { inp.classList.remove('bg-fail-input'); inp.style.color = ''; }
                }
                obtained += numVal;
            });
            let currentTotalMax = 0;
            finalSubjectsList.forEach(sub => { if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') currentTotalMax += 25; else currentTotalMax += 100; });
            const percent = currentTotalMax > 0 ? (obtained / currentTotalMax * 100).toFixed(1) : 0;
            row.querySelector('.total-val').textContent = obtained;
            row.querySelector('.perc-val').textContent = percent + '%';
            
            let grade = "Nakam"; let cls = "grade-nakam"; const p = parseFloat(percent);
            if (p >= 80) { grade = "Mumtaz Ma Sharf"; cls = "grade-mumtaz-sharf"; }
            else if (p >= 70) { grade = "Mumtaz"; cls = "grade-mumtaz"; }
            else if (p >= 50) { grade = "Jayyid"; cls = "grade-jayyid"; }
            else if (p >= 40) { grade = "Maqbul"; cls = "grade-maqbul"; }
            
            // Absent hone par FAIL
            if (hasAbsent || p < 40) { grade = "Nakam"; cls = "grade-nakam"; }
            
            const gVal = row.querySelector('.grade-val');
            gVal.textContent = grade;
            gVal.className = `border border-gray-200 p-2 text-center font-bold text-xs grade-val ${cls} rounded`;
        };

        // --- NEW SAVE LOGIC (PASS/FAIL AGGREGATION) ---
        window.saveResult = async () => {
            const rows = document.querySelectorAll('#students-body tr');
            if(rows.length === 0) { alert("Koi student add nahi kiya gaya."); return; }
            const btn = document.querySelector('button[onclick="saveResult()"]');
            const originalText = btn.innerText;
            btn.innerText = "Saving..."; btn.disabled = true;

            const rawClass = document.getElementById('class-select').value;
            const cleanClass = rawClass.split('_')[0]; 
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`; 
            const selectedClass = rawClass; 
            const students = [];

            rows.forEach(row => {
                const name = row.querySelector('.std-name').value.trim();
                if(!name) return;
                const marks = {};
                row.querySelectorAll('.mark-input').forEach(inp => {
                    const val = inp.value.trim().toUpperCase();
                    marks[inp.dataset.sub] = (val === 'A') ? 'A' : (val === '' ? 0 : parseFloat(val));
                });
                const total = parseFloat(row.querySelector('.total-val').textContent);
                const perc = parseFloat(row.querySelector('.perc-val').textContent);
                students.push({ name, marks, total, percentage: perc });
            });

            try {
                // 1. Current Class Save
                await setDoc(doc(db, "monthly_test_sheets", docId), {
                    adminUid, jamiaName, month: monthKey, class: selectedClass,
                    subjects: finalSubjectsList, students, updatedAt: serverTimestamp()
                }); 
                
                // 2. Aggregation Logic (Count Pass/Fail)
                let grandTotalStudents = 0;
                let grandPassedStudents = 0;
                const allClasses = Object.keys(classBooksMap);
                
                for (const cls of allClasses) {
                    const clsClean = cls.split('_')[0];
                    const sheetId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${clsClean.replace(/\s/g, '_')}`;
                    const sheetSnap = await getDoc(doc(db, "monthly_test_sheets", sheetId));
                    if (sheetSnap.exists()) {
                        const sData = sheetSnap.data();
                        const sStudents = sData.students || [];
                        const sSubjects = sData.subjects || [];
                        sStudents.forEach(std => {
                            grandTotalStudents++; 
                            let isFail = false;
                            // Criteria 1: < 40%
                            if (parseFloat(std.percentage) < 40) isFail = true;
                            // Criteria 2: Any Absent
                            if (!isFail) {
                                sSubjects.forEach(sub => { if (std.marks[sub] === 'A') isFail = true; });
                            }
                            if (!isFail) grandPassedStudents++;
                        });
                    }
                }

                let jamiaPassPerc = "0%";
                if (grandTotalStudents > 0) {
                    jamiaPassPerc = ((grandPassedStudents / grandTotalStudents) * 100).toFixed(1) + '%';
                }

                // 3. Admin Report Update
                const [yStr, mStr] = monthKey.split('-');
                const y = parseInt(yStr);
                const m = parseInt(mStr) - 1;
                const acYear = m >= 3 ? `${y}-${y + 1}` : `${y - 1}-${y}`;
                const reportId = `${adminUid}_${acYear}_${y}_${m}`;
                const reportRef = doc(db, 'monthly_reports', reportId);
                const reportSnap = await getDoc(reportRef);
                let testData = reportSnap.exists() ? (reportSnap.data().monthlyTest?.data || []) : [];
                testData = testData.filter(t => t.name !== jamiaName);
                testData.push({ name: jamiaName, status: 'Test Hua', month: monthKey, percentage: jamiaPassPerc, wajah: '' });
                await setDoc(reportRef, { monthlyTest: { status: 'Done', data: testData } }, { merge: true });

                alert(`Class Save ho gayi!\n\nJamia Result Update: ${grandPassedStudents} Pass / ${grandTotalStudents} Hazir (${jamiaPassPerc})`);
            } catch (error) { console.error("Save Error:", error); alert("Error: " + error.message); } 
            finally { btn.innerText = originalText; btn.disabled = false; }
        };

        // 8. View Mode Logic (Tabs fixed)
        window.checkExistingForClass = async (clsName) => {
            const cleanClass = clsName.split('_')[0]; 
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
            const resultArea = document.getElementById('result-area');
            const studentsBody = document.getElementById('students-body');
            const classSelect = document.getElementById('class-select');
            const selectionArea = document.getElementById('subject-selection-area'); 

            finalSubjectsList = [];
            studentsBody.innerHTML = '';
            resultArea.classList.add('hidden'); 
            document.getElementById('table-head').innerHTML = '';
            document.querySelectorAll('.subject-checkbox').forEach(chk => chk.checked = false);
            classSelect.disabled = false; 

            try {
                const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
                if (snap.exists()) {
                    const data = snap.data(); 
                    const allChecks = document.querySelectorAll('.subject-checkbox');
                    const savedVariableSubjects = data.subjects.filter(s => s !== 'English' && s !== 'Maths');
                    allChecks.forEach(chk => { if (savedVariableSubjects.includes(chk.value)) chk.checked = true; });
                    finalSubjectsList = data.subjects;
                    
                    totalMax = 0;
                    finalSubjectsList.forEach(sub => {
                        if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') totalMax += 25; else totalMax += 100;
                    });
                    
                    renderTableHeaders(); 
                    resultArea.classList.remove('hidden'); 
                    selectionArea.classList.add('hidden'); 
                    
                    document.getElementById('students-body').innerHTML = ''; 
                    data.students.forEach(s => addStudentRow(s.name, s.marks)); 

                    // VIEW MODE HANDLING
                    const params = new URLSearchParams(window.location.search);
                    if (params.get('mode') === 'view') {
                        const headerTitle = document.querySelector('h1');
                        if(headerTitle && !headerTitle.innerText.includes("View Only")) {
                            headerTitle.innerHTML += ` <span class="text-xl bg-yellow-200 text-yellow-800 px-2 py-1 rounded ml-2 align-middle">View Only</span>`;
                        }
                        const stepHeading = document.getElementById('step-heading');
                        const stepInstruction = document.getElementById('step-instruction');
                        if(stepHeading) stepHeading.style.display = 'none';
                        if(stepInstruction) stepInstruction.style.display = 'none';
                        
                        // NOTE: Tabs ko hide NAHI karenge taaki switch kar sakein
                        const elementsToHide = ['subject-selection-area', 'class-select']; 
                        elementsToHide.forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
                        
                        const addStudentBtn = document.querySelector('button[onclick="addStudentRow()"]');
                        const saveResultBtn = document.querySelector('button[onclick="saveResult()"]');
                        if(addStudentBtn) addStudentBtn.style.display = 'none';
                        if(saveResultBtn) saveResultBtn.style.display = 'none';

                        document.querySelectorAll('#students-body input').forEach(inp => {
                            inp.disabled = true;
                            inp.style.backgroundColor = 'transparent';
                            inp.style.border = 'none';
                            inp.style.textAlign = 'center';
                            inp.style.fontWeight = 'bold';
                            inp.style.color = '#1f2937'; 
                            inp.placeholder = "";
                        });
                        document.querySelectorAll('.no-print').forEach(btn => btn.style.display = 'none');
                        const headerTrash = document.querySelector('#table-head th:last-child');
                        if(headerTrash) headerTrash.style.display = 'none';
                        const actionContainer = document.querySelector('.mt-8.flex.flex-col');
                        if (actionContainer) { actionContainer.classList.remove('justify-end'); actionContainer.classList.add('justify-center'); }
                    } else {
                        alert(`Class ${clsName} ka purana data load kiya gaya.`);
                    }
                } else {
                     const params = new URLSearchParams(window.location.search);
                     if (params.get('mode') === 'view') {
                         resultArea.classList.add('hidden');
                         // View mode mein message dikha sakte hain ya blank rakh sakte hain
                     }
                }
            } catch(e) { console.log("New sheet or error loading:", e); }
        };

        // --- SUMMARY FEATURE LOGIC ---
        window.toggleSummary = async () => {
            const entryArea = document.getElementById('data-entry-area');
            const summaryArea = document.getElementById('summary-view-area');
            const btnView = document.getElementById('btn-view-summary');
            const btnBack = document.getElementById('btn-back-entry');

            if (summaryArea.classList.contains('hidden')) {
                entryArea.classList.add('hidden');
                summaryArea.classList.remove('hidden');
                btnView.classList.add('hidden');
                btnBack.classList.remove('hidden');
                await loadSummaryData();
            } else {
                summaryArea.classList.add('hidden');
                entryArea.classList.remove('hidden');
                btnBack.classList.add('hidden');
                btnView.classList.remove('hidden');
            }
        };

        async function loadSummaryData() {
            const mainBody = document.getElementById('summary-body-main');
            const asriBody = document.getElementById('summary-body-asri');
            const mainFoot = document.getElementById('summary-foot-main');
            const asriFoot = document.getElementById('summary-foot-asri');

            mainBody.innerHTML = '<tr><td colspan="8" class="p-4 text-gray-500">Loading data...</td></tr>';
            asriBody.innerHTML = '<tr><td colspan="8" class="p-4 text-gray-500">Loading data...</td></tr>';

            try {
                const allClasses = Object.keys(classBooksMap).sort();
                let mainRowsHTML = "";
                let asriRowsHTML = "";
                let gMain = { total: 0, present: 0, pass: 0, fail: 0 };
                let gAsri = { total: 0, present: 0, pass: 0, fail: 0 };
                let sn = 1;

                for (const clsName of allClasses) {
                    const cleanClass = clsName.split('_')[0];
                    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
                    const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
                    if (!snap.exists()) continue;
                    const data = snap.data();
                    const students = data.students || [];
                    if (students.length === 0) continue;

                    let mTotal = students.length; let mPresent = 0; let mPass = 0; let mFail = 0;
                    let aTotal = students.length; let aPresent = 0; let aPass = 0; let aFail = 0;
                    let hasAsriSubjects = false;

                    students.forEach(std => {
                        // Main Calculation
                        mPresent++;
                        let isFailMain = false;
                        if (parseFloat(std.percentage) < 40) isFailMain = true;
                        const subjects = Object.keys(std.marks);
                        subjects.forEach(sub => { if(std.marks[sub] === 'A') isFailMain = true; });
                        if (isFailMain) mFail++; else mPass++;

                        // Asri Calculation
                        let engMark = std.marks['English'];
                        let mathMark = std.marks['Maths'];
                        if (engMark !== undefined || mathMark !== undefined) {
                            hasAsriSubjects = true;
                            aPresent++;
                            let isFailAsri = false;
                            if (engMark === 'A' || mathMark === 'A') isFailAsri = true;
                            if (engMark !== undefined && typeof engMark === 'number' && engMark < 10) isFailAsri = true;
                            if (mathMark !== undefined && typeof mathMark === 'number' && mathMark < 10) isFailAsri = true;
                            if (isFailAsri) aFail++; else aPass++;
                        }
                    });

                    let mPerc = mPresent > 0 ? ((mPass / mPresent) * 100).toFixed(2) : "0.00";
                    let mGrade = getSummaryGrade(mPerc);
                    gMain.total += mTotal; gMain.present += mPresent; gMain.pass += mPass; gMain.fail += mFail;

                    mainRowsHTML += `<tr class="odd:bg-white even:bg-gray-50 hover:bg-purple-50"><td class="p-2 border">${sn}</td><td class="p-2 border text-left font-semibold">${clsName}</td><td class="p-2 border">${mTotal}</td><td class="p-2 border">${mPresent}</td><td class="p-2 border text-green-700 font-bold">${mPass}</td><td class="p-2 border text-red-600 font-bold">${mFail}</td><td class="p-2 border font-bold">${mPerc}%</td><td class="p-2 border"><span class="${getGradeColor(mGrade)} px-2 py-1 rounded text-xs text-white">${mGrade}</span></td></tr>`;

                    if (hasAsriSubjects) {
                        let aPerc = aPresent > 0 ? ((aPass / aPresent) * 100).toFixed(2) : "0.00";
                        let aGrade = getSummaryGrade(aPerc);
                        gAsri.total += aTotal; gAsri.present += aPresent; gAsri.pass += aPass; gAsri.fail += aFail;
                        asriRowsHTML += `<tr class="odd:bg-white even:bg-gray-50 hover:bg-purple-50"><td class="p-2 border">${sn}</td><td class="p-2 border text-left font-semibold">${clsName}</td><td class="p-2 border">${aTotal}</td><td class="p-2 border">${aPresent}</td><td class="p-2 border text-green-700 font-bold">${aPass}</td><td class="p-2 border text-red-600 font-bold">${aFail}</td><td class="p-2 border font-bold">${aPerc}%</td><td class="p-2 border"><span class="${getGradeColor(aGrade)} px-2 py-1 rounded text-xs text-white">${aGrade}</span></td></tr>`;
                    } else {
                        asriRowsHTML += `<tr><td class="p-2 border">${sn}</td><td class="p-2 border text-left font-semibold">${clsName}</td><td colspan="6" class="p-2 border text-gray-400">Asri subjects nahi hain</td></tr>`;
                    }
                    sn++;
                }

                mainBody.innerHTML = mainRowsHTML || '<tr><td colspan="8" class="p-4">No data found</td></tr>';
                asriBody.innerHTML = asriRowsHTML || '<tr><td colspan="8" class="p-4">No data found</td></tr>';

                let gMainPerc = gMain.present > 0 ? ((gMain.pass / gMain.present) * 100).toFixed(2) : "0.00";
                mainFoot.innerHTML = `<tr class="bg-green-600"><td colspan="2" class="p-2 border text-right text-lg">Total</td><td class="p-2 border bg-purple-300 text-black">${gMain.total}</td><td class="p-2 border bg-purple-300 text-black">${gMain.present}</td><td class="p-2 border bg-purple-300 text-black">${gMain.pass}</td><td class="p-2 border bg-purple-300 text-black">${gMain.fail}</td><td class="p-2 border bg-purple-300 text-black">${gMainPerc}%</td><td class="p-2 border bg-red-600">${getSummaryGrade(gMainPerc)}</td></tr>`;

                let gAsriPerc = gAsri.present > 0 ? ((gAsri.pass / gAsri.present) * 100).toFixed(2) : "0.00";
                asriFoot.innerHTML = `<tr class="bg-green-600"><td colspan="2" class="p-2 border text-right text-lg">Total</td><td class="p-2 border bg-purple-300 text-black">${gAsri.total}</td><td class="p-2 border bg-purple-300 text-black">${gAsri.present}</td><td class="p-2 border bg-purple-300 text-black">${gAsri.pass}</td><td class="p-2 border bg-purple-300 text-black">${gAsri.fail}</td><td class="p-2 border bg-purple-300 text-black">${gAsriPerc}%</td><td class="p-2 border bg-red-600">${getSummaryGrade(gAsriPerc)}</td></tr>`;
            } catch (e) { console.error("Summary Error:", e); mainBody.innerHTML = '<tr><td colspan="8" class="text-red-500 p-4">Error loading summary.</td></tr>'; }
        }

        function getSummaryGrade(perc) { const p = parseFloat(perc); if (p >= 80) return "Mumtaz"; if (p >= 70) return "Jayyid Jiddan"; if (p >= 60) return "Jayyid"; if (p >= 50) return "Maqbul"; if (p >= 40) return "Pass"; return "Kamzoor"; }
        function getGradeColor(grade) { if (grade === "Mumtaz") return "bg-green-700"; if (grade === "Jayyid Jiddan") return "bg-green-600"; if (grade === "Jayyid") return "bg-yellow-500"; if (grade === "Maqbul") return "bg-orange-500"; return "bg-red-600"; }

        // --- PDF GENERATION (FIXED & COMPLETE) ---
        window.downloadPDF = async () => {
            if (!window.html2canvas) { alert("Error: html2canvas library missing hai."); return; }
            const saveBtn = document.querySelector('button[onclick="downloadPDF()"]');
            if(saveBtn) saveBtn.innerText = "Processing...";
            const jamiaTitle = document.getElementById('pdf-jamia').innerText;
            const currentClass = document.getElementById('class-select').value || "";
            const monthText = monthKey;
            const tableHeadHTML = document.getElementById('table-head').innerHTML;
            const originalTableBody = document.getElementById('students-body');

            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px'; tempContainer.style.top = '0px'; tempContainer.style.width = '1100px'; 
            document.body.appendChild(tempContainer);
            const PAGE_HEIGHT_LIMIT = 760; 
            const COLOR_TEAL_DARK = "#0f766e"; const COLOR_TEAL_LIGHT = "#f0fdfa"; const COLOR_BORDER = "#0f766e";

            function createNewPage() {
                const pageDiv = document.createElement('div');
                pageDiv.style.backgroundColor = "white"; pageDiv.style.padding = "20px"; pageDiv.style.width = "100%"; pageDiv.style.boxSizing = "border-box";
                pageDiv.innerHTML = `<div style="margin-bottom: 10px; border: 2px solid ${COLOR_BORDER}; border-radius: 8px; overflow: hidden;"><table style="width: 100%; border-collapse: collapse;"><tr style="height: 40px;"><td style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold; font-size: 18px; width: 66%; border-right: 1px solid white; text-transform: uppercase;">Monthly Test Result</td><td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-bottom: 1px solid ${COLOR_BORDER}; border-right: 1px solid ${COLOR_BORDER}; width: 17%;">CLASS</td><td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold; font-size: 16px; border-bottom: 1px solid ${COLOR_BORDER}; width: 17%;">${currentClass}</td></tr><tr style="height: 50px;"><td style="background-color: white; color: #115e59; text-align: center; font-family: 'Jameel Noori Nastaleeq', serif; font-size: 24px; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">${jamiaTitle}</td><td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">MONTH</td><td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold;">${monthText}</td></tr></table></div><table class="result-table" style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 13px;"><thead style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold;">${tableHeadHTML}</thead><tbody class="divide-y divide-gray-200" style="text-align: center;"></tbody></table>`;
                const ths = pageDiv.querySelectorAll('.result-table th'); if(ths.length > 0) ths[ths.length - 1].remove(); 
                pageDiv.querySelectorAll('.result-table th').forEach(th => { th.style.backgroundColor = COLOR_TEAL_DARK; th.style.color = "white"; th.style.padding = "8px 4px"; th.style.border = "1px solid #ccc"; });
                tempContainer.appendChild(pageDiv); return pageDiv;
            }

            try {
                const rows = Array.from(originalTableBody.querySelectorAll('tr'));
                let currentPage = createNewPage(); let currentTbody = currentPage.querySelector('.result-table tbody');
                for (let row of rows) {
                    const clonedRow = row.cloneNode(true);
                    const lastTd = clonedRow.querySelector('td:last-child'); if(lastTd) lastTd.remove();
                    const inputs = clonedRow.querySelectorAll('input');
                    inputs.forEach(input => {
                        const div = document.createElement('div'); div.innerText = input.value || '-';
                        div.style.textAlign = "center"; div.style.fontWeight = "bold"; div.style.width = "100%"; div.style.padding = "5px 0";
                        if(input.classList.contains('bg-fail-input')) { div.style.backgroundColor = "#fee2e2"; div.style.color = "#991b1b"; }
                        if(input.parentNode) input.parentNode.replaceChild(div, input);
                    });
                    clonedRow.querySelectorAll('td').forEach(td => { td.style.padding = "5px 2px"; td.style.textAlign = "center"; td.style.border = "1px solid #e5e7eb"; td.classList.remove('text-right', 'pr-2'); });
                    currentTbody.appendChild(clonedRow);
                    if (currentPage.offsetHeight > PAGE_HEIGHT_LIMIT) { currentTbody.removeChild(clonedRow); currentPage = createNewPage(); currentTbody = currentPage.querySelector('.result-table tbody'); currentTbody.appendChild(clonedRow); }
                }
                const pages = Array.from(tempContainer.children); const { jsPDF } = window.jspdf; const pdfDoc = new jsPDF('l', 'mm', 'a4'); 
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i]; const canvas = await html2canvas(page, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                    const imgData = canvas.toDataURL('image/png'); const imgWidth = 297; const imgHeight = canvas.height * imgWidth / canvas.width;
                    if (i > 0) pdfDoc.addPage(); pdfDoc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                }
                document.body.removeChild(tempContainer); pdfDoc.save(`Result_${jamiaTitle}_${currentClass}.pdf`);
            } catch (error) { console.error("PDF Logic Error:", error); alert("PDF Generation Failed: " + error.message); } finally { if(saveBtn) saveBtn.innerText = "Download PDF"; }
        };

        window.downloadAllClassesPDF = async () => {
            if (!window.html2canvas) { alert("html2canvas library missing hai."); return; }
            const btn = document.getElementById('download-all-btn'); const originalText = btn.innerText;
            btn.innerText = "Processing..."; btn.disabled = true;             
            try {
                const { jsPDF } = window.jspdf; const pdfDoc = new jsPDF('l', 'mm', 'a4'); let pageCount = 0;
                const allClasses = Object.keys(classBooksMap).sort(); const COLOR_TEAL_DARK = "#0f766e"; const COLOR_TEAL_LIGHT = "#f0fdfa"; const COLOR_BORDER = "#0f766e";
                for (const clsName of allClasses) {
                    btn.innerText = `Generating: ${clsName}...`;
                    const cleanClass = clsName.split('_')[0]; 
                    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
                    const docSnap = await getDoc(doc(db, "monthly_test_sheets", docId));
                    if (!docSnap.exists()) continue;
                    const data = docSnap.data(); const students = data.students || []; const subjects = data.subjects || [];
                    if (students.length === 0) continue;
                    const tempContainer = document.createElement('div'); tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px'; tempContainer.style.top = '0px'; tempContainer.style.width = '1100px'; 
                    document.body.appendChild(tempContainer);
                    let totalMax = 0; let headerCells = "";
                    subjects.forEach(sub => {
                        const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths'; const max = isSmall ? 25 : 100; totalMax += max;
                        headerCells += `<th style="background-color: ${COLOR_TEAL_DARK}; color: white; padding: 8px 4px; border: 1px solid #ccc;">${sub} <br><span style="font-size: 10px; font-weight: normal; color: #ccfbf1;">/${max}</span></th>`;
                    });
                    const PAGE_HEIGHT_LIMIT = 760; 
                    function createNewPage() {
                        const pageDiv = document.createElement('div'); pageDiv.style.backgroundColor = "white"; pageDiv.style.padding = "20px"; pageDiv.style.width = "100%"; pageDiv.style.boxSizing = "border-box";
                        pageDiv.innerHTML = `<div style="margin-bottom: 10px; border: 2px solid ${COLOR_BORDER}; border-radius: 8px; overflow: hidden;"><table style="width: 100%; border-collapse: collapse;"><tr style="height: 40px;"><td style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold; font-size: 18px; width: 66%; border-right: 1px solid white; text-transform: uppercase;">Monthly Test Result</td><td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-bottom: 1px solid ${COLOR_BORDER}; border-right: 1px solid ${COLOR_BORDER}; width: 17%;">CLASS</td><td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold; font-size: 16px; border-bottom: 1px solid ${COLOR_BORDER}; width: 17%;">${clsName}</td></tr><tr style="height: 50px;"><td style="background-color: white; color: #115e59; text-align: center; font-family: 'Jameel Noori Nastaleeq', serif; font-size: 24px; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">${jamiaName}</td><td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">MONTH</td><td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold;">${monthKey}</td></tr></table></div><table class="result-table" style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 13px;"><thead style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold;"><tr><th style="background-color: ${COLOR_TEAL_DARK}; color: white; padding: 8px 4px; border: 1px solid #ccc; width: 40px;">#</th><th style="background-color: ${COLOR_TEAL_DARK}; color: white; padding: 8px 4px; border: 1px solid #ccc; width: 25%; text-align: center;">Talib-e-Ilm</th>${headerCells}<th style="background-color: #115e59; color: white; padding: 8px 4px; border: 1px solid #ccc;">Total (${totalMax})</th><th style="background-color: #115e59; color: white; padding: 8px 4px; border: 1px solid #ccc;">%</th><th style="background-color: #115e59; color: white; padding: 8px 4px; border: 1px solid #ccc;">Grade</th></tr></thead><tbody class="divide-y divide-gray-200" style="text-align: center;"></tbody></table>`;
                        tempContainer.appendChild(pageDiv); return pageDiv;
                    }
                    let currentPage = createNewPage(); let currentTbody = currentPage.querySelector('.result-table tbody');
                    for (let i = 0; i < students.length; i++) {
                        const std = students[i]; const tr = document.createElement('tr'); let tds = ""; let hasAbsent = false;
                        subjects.forEach(sub => {
                            let val = std.marks[sub]; if (val === undefined) val = "-"; let cellStyle = "background: transparent;"; let displayVal = val;
                            if (val === 'A') { hasAbsent = true; cellStyle = "background-color: #fee2e2; color: #991b1b;"; } 
                            else if (val !== '-' && typeof val === 'number') { const max = (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') ? 25 : 100; const pass = max === 25 ? 10 : 40; if (val < pass) cellStyle = "background-color: #fee2e2; color: #991b1b;"; }
                            tds += `<td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: bold; ${cellStyle}">${displayVal}</td>`;
                        });
                        let grade = "Nakam"; let cls = "background-color: #ef4444; color: white;"; const p = parseFloat(std.percentage);
                        if (p >= 80) { grade = "Mumtaz Ma Sharf"; cls = "background-color: #15803d; color: white;"; }
                        else if (p >= 70) { grade = "Mumtaz"; cls = "background-color: #22c55e; color: white;"; }
                        else if (p >= 50) { grade = "Jayyid"; cls = "background-color: #eab308; color: white;"; }
                        else if (p >= 40) { grade = "Maqbul"; cls = "background-color: #f97316; color: white;"; }
                        if (hasAbsent || p < 40) { grade = "Nakam"; cls = "background-color: #ef4444; color: white;"; }
                        tr.innerHTML = `<td style="border: 1px solid #e5e7eb; padding: 5px 2px; color: #6b7280;">${i + 1}</td><td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: 600; font-family: 'Jameel Noori Nastaleeq', serif; font-size: 14px; text-align: center;">${std.name}</td>${tds}<td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: bold;">${std.total}</td><td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: bold; color: #2563eb;">${std.percentage}%</td><td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: bold; font-size: 12px; border-radius: 4px; ${cls}">${grade}</td>`;
                        currentTbody.appendChild(tr);
                        if (currentPage.offsetHeight > PAGE_HEIGHT_LIMIT) { currentTbody.removeChild(tr); currentPage = createNewPage(); currentTbody = currentPage.querySelector('.result-table tbody'); currentTbody.appendChild(tr); }
                    }
                    const directPages = Array.from(tempContainer.children);
                    for (let j = 0; j < directPages.length; j++) {
                        const page = directPages[j]; const canvas = await html2canvas(page, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                        const imgData = canvas.toDataURL('image/png'); const imgWidth = 297; const imgHeight = canvas.height * imgWidth / canvas.width;
                        if (pageCount > 0) pdfDoc.addPage(); pdfDoc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight); pageCount++;
                    }
                    document.body.removeChild(tempContainer);
                }
                if (pageCount === 0) { alert("Koi bhi saved data nahi mila."); } else { pdfDoc.save(`All_Classes_Result_${jamiaName}_${monthKey}.pdf`); }
            } catch (error) { console.error("PDF Error:", error); alert("Error: " + error.message); } finally { btn.innerText = originalText; btn.disabled = false; }
        };
    </script>
</body>
</html>
