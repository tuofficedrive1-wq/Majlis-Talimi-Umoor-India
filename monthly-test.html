<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Test Sheet (Teacher View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2'); font-display: swap; }
        body { font-family: 'Poppins', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .mark-input { text-align: center; }
        .pass-bg { background-color: #dcfce7; color: #166534; }
        .fail-bg { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg" id="display-month">...</p>
            <p class="text-xs text-teal-300 mt-2">Teacher/Principal Portal</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <label class="block text-gray-700 font-bold mb-2">Class Select Karein:</label>
                <div class="flex gap-4 items-center">
                    <select id="class-select" class="w-full md:w-1/3 p-3 border rounded-lg urdu-font text-lg shadow-sm focus:ring-2 focus:ring-teal-500">
                        <option value="">-- Select Class --</option>
                    </select>
                    <button onclick="loadClassSubjects()" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition">
                        Load Subjects
                    </button>
                </div>
                <p id="subjects-info" class="mt-3 text-sm text-gray-500 italic"></p>
            </div>

            <div id="result-area" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 border-b-2 border-teal-500 pb-1">Result Sheet</h2>
                    <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>

                <div class="overflow-x-auto border rounded-lg shadow-sm" id="print-area">
                     <div class="hidden print-header text-center mb-4 pt-4">
                        <h2 class="text-2xl font-bold urdu-font" id="pdf-jamia"></h2>
                        <p id="pdf-month"></p>
                    </div>

                    <table class="w-full text-sm text-left bg-white">
                        <thead class="bg-teal-50 text-teal-900 uppercase font-bold" id="table-head">
                            </thead>
                        <tbody id="students-body" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                    <button onclick="saveResult()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Save Result Sheet
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG (Same as index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State
        let adminUid = "";
        let jamiaName = "";
        let monthKey = ""; // 2025-11
        let subjectsList = []; // ["Quran", "Fiqh"]
        let maxMarks = 100; // Default

        // 1. Initialize & Read URL
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Link invalid hai. Barae karam Admin se naya link mangein.");
                document.body.innerHTML = "<h1 class='text-center mt-10 text-red-500'>Invalid Link Parameters</h1>";
                return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Month: ${monthKey}`;
            document.getElementById('pdf-jamia').textContent = jamiaName;
            document.getElementById('pdf-month').textContent = monthKey;

            await loadAdminData();
            await loadExistingResult(); // Check if already filled
        };

        // 2. Load Admin's Structure (To get Classes/Subjects)
        async function loadAdminData() {
            try {
                // Admin (User) ka document fetch kar rahe hain bina login kiye
                // Note: Firestore Rules must allow read access to 'users/{uid}'
                const userDoc = await getDoc(doc(db, "users", adminUid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    const structure = data.academicStructure || data.structure || [];
                    
                    // Filter structure for this Jamia
                    const jamiaData = structure.find(j => j.jamiaName === jamiaName);
                    
                    if (jamiaData && jamiaData.classes) {
                        const select = document.getElementById('class-select');
                        
                        // Handle Object vs Array structure
                        let classes = [];
                        if (Array.isArray(jamiaData.classes)) {
                            classes = jamiaData.classes; // Simple array of names
                        } else if (typeof jamiaData.classes === 'object') {
                            classes = Object.keys(jamiaData.classes); // Object keys
                        }

                        classes.forEach(cls => {
                            // If cls is object, try to get name, else use string
                            const clsName = (typeof cls === 'object') ? cls.className : cls;
                            const opt = document.createElement('option');
                            opt.value = clsName;
                            opt.textContent = clsName;
                            select.appendChild(opt);
                        });
                    }
                }
                
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

            } catch (error) {
                console.error("Error loading admin data:", error);
                alert("Data load karne me masla aaya. Internet check karein.");
            }
        }

        // 3. Setup Table based on Class
        window.loadClassSubjects = () => {
            const cls = document.getElementById('class-select').value;
            if(!cls) { alert("Class select karein"); return; }

            // Default Subjects (Agar structure se exact na milein to ye use honge)
            // Aap chahein to yahan complex logic laga sakte hain structure se subject uthane ka
            // Abhi ke liye hum Teacher ko allow karenge ki wo subjects edit na kare, bas default dikhaye
            
            // Simple approach: Use standard subjects or prompt
            // Let's assume standard set for simplicity or ask user
            const manualSubjects = prompt("Subjects enter karein (comma se alag karke)\nMisal: Quran, Fiqh, Urdu", "Quran, Fiqh, Nahw, Urdu");
            
            if(manualSubjects) {
                subjectsList = manualSubjects.split(',').map(s => s.trim());
                renderTableHeaders();
                document.getElementById('result-area').classList.remove('hidden');
                document.getElementById('subjects-info').textContent = `Selected Subjects: ${subjectsList.join(', ')}`;
            }
        };

        function renderTableHeaders() {
            const head = document.getElementById('table-head');
            let html = `<tr>
                <th class="px-4 py-3 border">#</th>
                <th class="px-4 py-3 border w-1/4">Name</th>`;
            
            subjectsList.forEach(sub => {
                html += `<th class="px-4 py-3 border text-center">${sub} <br><span class="text-xs font-normal">/100</span></th>`;
            });

            html += `
                <th class="px-4 py-3 border text-center bg-gray-100">Total</th>
                <th class="px-4 py-3 border text-center bg-gray-100">%</th>
                <th class="px-4 py-3 border text-center bg-gray-100">Grade</th>
                <th class="px-2 py-3 border text-center text-red-500"><i class="fas fa-trash"></i></th>
            </tr>`;
            head.innerHTML = html;
        }

        // 4. Row Operations
        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";

            let inputs = "";
            subjectsList.forEach(sub => {
                const val = marks[sub] || "";
                inputs += `<td class="border p-1"><input type="number" data-sub="${sub}" value="${val}" class="w-full p-2 text-center outline-none mark-input focus:bg-blue-50" oninput="calcRow(this)"></td>`;
            });

            tr.innerHTML = `
                <td class="border p-2 text-center text-gray-500">${index}</td>
                <td class="border p-1"><input type="text" value="${name}" placeholder="Student Name" class="w-full p-2 font-semibold urdu-font outline-none std-name"></td>
                ${inputs}
                <td class="border p-2 text-center font-bold text-gray-700 total-val">0</td>
                <td class="border p-2 text-center font-bold text-blue-600 perc-val">0%</td>
                <td class="border p-2 text-center font-bold grade-val">-</td>
                <td class="border p-2 text-center cursor-pointer text-red-400 hover:text-red-600" onclick="this.parentElement.remove()">Ã—</td>
            `;
            tbody.appendChild(tr);
            
            // Calc initial if data exists
            if(name) calcRow(tr.querySelector('input'));
        };

        window.calcRow = (el) => {
            const row = el.closest('tr');
            let obtained = 0;
            const inputs = row.querySelectorAll('.mark-input');
            
            inputs.forEach(inp => obtained += Number(inp.value));
            
            const totalMax = subjectsList.length * 100; // Assuming 100 per subject
            const percent = totalMax > 0 ? (obtained / totalMax * 100).toFixed(1) : 0;
            
            row.querySelector('.total-val').textContent = obtained;
            row.querySelector('.perc-val').textContent = percent + '%';
            
            let grade = "-";
            let cls = "";
            if (percent >= 80) { grade = "Mumtaz"; cls = "pass-bg"; }
            else if (percent >= 60) { grade = "Jayyid Jiddan"; cls = "text-green-600"; }
            else if (percent >= 50) { grade = "Jayyid"; cls = "text-yellow-600"; }
            else if (percent >= 40) { grade = "Maqbool"; cls = "text-orange-600"; }
            else { grade = "Rasib"; cls = "fail-bg"; }
            
            const gVal = row.querySelector('.grade-val');
            gVal.textContent = grade;
            gVal.className = `border p-2 text-center font-bold grade-val ${cls}`;
        };

        // 5. Save Logic (Using Admin UID)
        window.saveResult = async () => {
            const rows = document.querySelectorAll('#students-body tr');
            if(rows.length === 0) { alert("Koi student add nahi kiya gaya."); return; }

            const students = [];
            let grandObtained = 0;
            let grandMax = 0;

            rows.forEach(row => {
                const name = row.querySelector('.std-name').value.trim();
                if(!name) return;

                const marks = {};
                row.querySelectorAll('.mark-input').forEach(inp => {
                    marks[inp.dataset.sub] = Number(inp.value);
                });
                
                const total = Number(row.querySelector('.total-val').textContent);
                const perc = parseFloat(row.querySelector('.perc-val').textContent);
                
                students.push({ name, marks, total, percentage: perc });
                
                grandObtained += total;
                grandMax += (subjectsList.length * 100);
            });

            const overallPerc = grandMax > 0 ? ((grandObtained / grandMax) * 100).toFixed(1) + '%' : '0%';
            
            // ID Creation (Using Admin UID from URL)
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}`;

            try {
                // 1. Save Full Sheet
                await setDoc(doc(db, "monthly_test_sheets", docId), {
                    adminUid,
                    jamiaName,
                    month: monthKey,
                    class: document.getElementById('class-select').value,
                    subjects: subjectsList,
                    students,
                    updatedAt: serverTimestamp()
                });

                // 2. Update Admin's Dashboard Report
                // Logic: monthly_reports collection me update
                const [yStr, mStr] = monthKey.split('-');
                const y = parseInt(yStr);
                const m = parseInt(mStr) - 1;
                const acYear = (m >= 3) ? `${y}-${y + 1}` : `${y - 1}-${y}`;
                const reportId = `${adminUid}_${acYear}_${y}_${m}`;

                // Note: Array update bina read kiye mushkil hai, lekin hum overwrite approach use karenge safe side ke liye
                // Ya phir hum maan ke chalte hain admin baad me refresh karega
                
                // Hum ek "Trigger" document bana sakte hain ya direct update koshish karte hain
                // Since this is public write, we need to be careful. 
                // For now, let's just save the Sheet. The Dashboard code needs to read from 'monthly_test_sheets' 
                // OR we enable writes to 'monthly_reports' as well.
                
                // Simple Update:
                const reportRef = doc(db, 'monthly_reports', reportId);
                const reportSnap = await getDoc(reportRef);
                
                let testData = [];
                if (reportSnap.exists()) {
                     testData = reportSnap.data().monthlyTest?.data || [];
                }
                
                // Remove old
                testData = testData.filter(t => t.name !== jamiaName);
                // Add new
                testData.push({
                    name: jamiaName,
                    status: 'Test Hua',
                    month: monthKey,
                    percentage: overallPerc,
                    wajah: ''
                });

                await setDoc(reportRef, {
                    monthlyTest: { status: 'Done', data: testData }
                }, { merge: true });

                alert("Result Successfully Save ho gaya! Shukriya.");
                // Optional: Disable buttons
            } catch (error) {
                console.error("Save Error:", error);
                alert("Save karne me error aaya: " + error.message);
            }
        };

        // 6. Load Existing
        async function loadExistingResult() {
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}`;
            try {
                const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
                if (snap.exists()) {
                    const data = snap.data();
                    subjectsList = data.subjects || [];
                    
                    // UI Restore
                    if (subjectsList.length > 0) {
                        document.getElementById('class-select').value = data.class || "";
                        renderTableHeaders();
                        document.getElementById('result-area').classList.remove('hidden');
                        document.getElementById('subjects-info').textContent = `Loaded Subjects: ${subjectsList.join(', ')}`;
                        
                        data.students.forEach(s => addStudentRow(s.name, s.marks));
                    }
                }
            } catch (e) {
                console.log("No existing data found or permission denied");
            }
        }
        
        // PDF Generator
        window.downloadPDF = async () => {
            const el = document.getElementById('print-area');
            const hiddenHeader = el.querySelector('.print-header');
            hiddenHeader.classList.remove('hidden'); // Show title
            
            const canvas = await html2canvas(el, { scale: 2 });
            const img = canvas.toDataURL('image/png');
            
            hiddenHeader.classList.add('hidden'); // Hide title again

            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            const props = pdf.getImageProperties(img);
            const w = pdf.internal.pageSize.getWidth();
            const h = (props.height * w) / props.width;
            
            pdf.addImage(img, 'PNG', 0, 0, w, h);
            pdf.save(`Result_${jamiaName}.pdf`);
        };

    </script>
</body>
</html>
