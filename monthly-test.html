<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Test Sheet (Teacher View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="jameel-font.js"></script> 

    <style>
        @font-face { 
            font-family: 'Jameel Noori Nastaleeq'; 
            src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2'); 
            font-display: swap; 
        }
        body { font-family: 'Poppins', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .mark-input { text-align: center; }

        /* Grades Colors */
        .grade-mumtaz-sharf { background-color: #15803d; color: white; } 
        .grade-mumtaz { background-color: #22c55e; color: white; } 
        .grade-jayyid { background-color: #eab308; color: white; } 
        .grade-maqbul { background-color: #f97316; color: white; } 
        .grade-nakam { background-color: #ef4444; color: white; } 
        .grade-absent { background-color: #6b7280; color: white; }

        /* Input Validation Colors */
        .bg-fail-input { background-color: #fee2e2 !important; color: #991b1b; font-weight: bold; }
        
        .subject-checkbox:checked + div { background-color: #0d9488; color: white; border-color: #0d9488; }

        /* Summary Table Borders */
        #summary-view-area table th, 
        #summary-view-area table td {
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg" id="display-month">...</p>
            <span id="pdf-jamia" class="hidden"></span>
            <span id="pdf-month" class="hidden"></span>
            <p class="text-xs text-teal-300 mt-2">Teacher/Principal Portal</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="flex justify-between items-center mb-6 print:hidden">
                <h2 class="text-2xl font-bold text-teal-800 urdu-font">Result Entry Panel</h2>
                <div class="flex gap-2">
                    <button onclick="toggleSummary()" id="btn-view-summary" class="bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2">
                        <i class="fas fa-chart-bar"></i> View Summary
                    </button>
                    <button onclick="toggleSummary()" id="btn-back-entry" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back to Entry
                    </button>
                </div>
            </div>

            <div id="summary-view-area" class="hidden">
                <div class="bg-white shadow-lg rounded-lg overflow-hidden border border-purple-200 mb-8">
                    <div class="bg-purple-700 text-white text-center py-2 font-bold text-xl font-serif">
                        Result Summary (All Subjects)
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-center border-collapse">
                            <thead>
                                <tr class="bg-purple-100 text-purple-900 text-sm font-bold">
                                    <th class="p-2">S.No.</th>
                                    <th class="p-2 text-left">Class</th>
                                    <th class="p-2">Total Students</th>
                                    <th class="p-2">Present</th>
                                    <th class="p-2">Pass</th>
                                    <th class="p-2">Fail</th>
                                    <th class="p-2">Percent</th>
                                    <th class="p-2">Grade</th>
                                </tr>
                            </thead>
                            <tbody id="summary-body-main" class="text-sm"></tbody>
                            <tfoot id="summary-foot-main" class="font-bold text-white"></tfoot>
                        </table>
                    </div>
                </div>

                <div class="bg-white shadow-lg rounded-lg overflow-hidden border border-purple-200 mb-8">
                    <div class="bg-purple-700 text-white text-center py-2 font-bold text-xl font-serif">
                        (Asri) Result Summary (English & Maths)
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-center border-collapse">
                            <thead>
                                <tr class="bg-purple-100 text-purple-900 text-sm font-bold">
                                    <th class="p-2">S.No.</th>
                                    <th class="p-2 text-left">Class</th>
                                    <th class="p-2">Total Students</th>
                                    <th class="p-2">Present (In Asri)</th>
                                    <th class="p-2">Pass</th>
                                    <th class="p-2">Fail</th>
                                    <th class="p-2">Percent</th>
                                    <th class="p-2">Grade</th>
                                </tr>
                            </thead>
                            <tbody id="summary-body-asri" class="text-sm"></tbody>
                            <tfoot id="summary-foot-asri" class="font-bold text-white"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="data-entry-area">
                <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <h3 id="step-heading" class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Step 1: Class & Subjects Select Karein</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-600 font-semibold mb-1">Class:</label>
                        <div id="class-tabs" class="flex flex-wrap gap-2 mt-4"></div>
                        
                        <select id="class-select" class="hidden">
                            <option value="">-- Select Class --</option>
                        </select>
                    </div>

                    <p id="step-instruction" class="text-xs text-gray-500 mt-1">
                        Ek class save karne ke baad dusri select karein.
                    </p>

                    <div id="subject-selection-area" class="hidden mt-4">
                        <p class="text-sm text-gray-500 mb-2">Is Class ki kitabon me se koi <strong>3 Kitabein</strong> select karein:</p>
                        <div class="flex gap-4 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="include-english" checked>
                                <span class="font-semibold">English</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="include-maths" checked>
                                <span class="font-semibold">Maths</span>
                            </label>
                        </div>
                        
                        <div id="checkbox-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>

                        <div class="bg-blue-50 p-3 rounded border border-blue-200 mb-4 text-sm text-blue-800 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>
                            Note: <strong>English (25)</strong> aur <strong>Maths (25)</strong> automatically shamil rahenge. Baqi 100 number ke honge.
                        </div>

                        <button onclick="generateSheet()" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition w-full md:w-auto">
                            Result Sheet Banayein (Total 350)
                        </button>
                    </div>
                </div>

                <div id="result-area" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 border-b-2 border-teal-500 pb-1">Result Sheet</h2>
                        <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>

                    <div class="overflow-x-auto border rounded-lg shadow-sm" id="print-area">
                        <table class="w-full text-sm text-left bg-white border-collapse">
                            <thead class="bg-teal-50 text-teal-900 uppercase font-bold" id="table-head"></thead>
                            <tbody id="students-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>

                    <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                        <button onclick="saveResult()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                            <i class="fas fa-save"></i> Save Result Sheet
                        </button>
                        <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                        <button id="download-all-btn" onclick="downloadAllClassesPDF()" class="bg-purple-700 hover:bg-purple-800 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                            <i class="fas fa-layer-group"></i> Download ALL Classes
                        </button>
                        <button onclick="downloadReportCards()" class="bg-blue-800 hover:bg-blue-900 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
    <i class="fas fa-id-card"></i> Report Cards
</button>
                    </div>
                </div>
            </div> </div>
    </div>
<div id="report-card-container" style="position: absolute; left: -9999px; top: 0; width: 800px;">
    
    <div id="report-card-template" style="width: 794px; height: 1123px; padding: 20px; background-color: #fff; box-sizing: border-box; font-family: 'Poppins', sans-serif;">
        
        <div style="border: 5px solid #b0c4de; height: 100%; padding: 10px; position: relative;">
            
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.1; z-index: 0;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Jamia_logo.png" style="width: 400px;">
            </div>

            <div style="text-align: center; position: relative; z-index: 10;">
                <h1 style="color: #2c5282; font-weight: 900; font-size: 36px; margin: 0; text-transform: uppercase;">Monthly Test Result</h1>
                <h2 style="color: #2c5282; font-weight: 700; font-size: 28px; margin: 5px 0;" id="rc-month">MONTH 2025</h2>
                <h3 style="color: #2b6cb0; font-weight: 800; font-size: 24px; margin: 5px 0;">JAMIA TUL MADINA INDIA</h3>
            </div>

            <div style="position: absolute; top: 20px; right: 20px; width: 100px;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Jamia_logo.png" style="width: 100%;">
            </div>

            <br>

            <div style="display: flex; gap: 20px; margin-top: 20px; position: relative; z-index: 10;">
                
                <table style="width: 50%; border-collapse: collapse; border: 2px solid #000;">
                    <tr>
                        <td style="background: #b0c4de; font-weight: bold; padding: 8px; border: 1px solid #000; text-align: center;">Class</td>
                        <td style="padding: 8px; border: 1px solid #000; font-weight: bold;" id="rc-class">...</td>
                    </tr>
                    <tr>
                        <td style="background: #b0c4de; font-weight: bold; padding: 8px; border: 1px solid #000; text-align: center; vertical-align: middle;">Name :</td>
                        <td style="padding: 8px; border: 1px solid #000; height: 60px; font-family: 'Jameel Noori Nastaleeq'; font-size: 22px; font-weight: bold; text-align: center;" id="rc-name">...</td>
                    </tr>
                </table>

                <table style="width: 50%; border-collapse: collapse; border: 2px solid #000;">
                    <tr>
                        <td style="background: #b0c4de; font-weight: bold; padding: 8px; border: 1px solid #000; text-align: center;">Roll No :</td>
                        <td style="padding: 8px; border: 1px solid #000; font-weight: bold;" id="rc-roll">...</td>
                    </tr>
                    <tr>
                        <td style="background: #b0c4de; font-weight: bold; padding: 8px; border: 1px solid #000; text-align: center;">BRANCH NAME:</td>
                        <td style="padding: 8px; border: 1px solid #000; font-family: 'Jameel Noori Nastaleeq'; font-size: 20px; text-align: right;" id="rc-branch">...</td>
                    </tr>
                </table>
            </div>

            <div style="margin-top: 20px; position: relative; z-index: 10;">
                <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; text-align: center;">
                    <thead>
                        <tr style="background: #b0c4de;">
                            <th style="border: 1px solid #000; padding: 10px; width: 40%;">Subjects</th>
                            <th style="border: 1px solid #000; padding: 10px; width: 20%;">Total Marks</th>
                            <th style="border: 1px solid #000; padding: 10px; width: 20%;">Marks Obtained</th>
                            <th style="border: 1px solid #000; padding: 10px; width: 20%; font-family: 'Jameel Noori Nastaleeq';">Ù…Ø¶Ù…ÙˆÙ†</th>
                        </tr>
                    </thead>
                    <tbody id="rc-marks-body">
                        </tbody>
                </table>
            </div>

            <div style="display: flex; gap: 20px; margin-top: 0; position: relative; z-index: 10;">
                <table style="width: 50%; border-collapse: collapse; border: 2px solid #000; border-top: none;">
                    <tr>
                        <td style="background: #b0c4de; font-weight: bold; padding: 8px; border: 1px solid #000;">Total Marks :</td>
                        <td style="padding: 8px; border: 1px solid #000; font-weight: bold;" id="rc-grand-total">300</td>
                    </tr>
                    <tr>
                        <td style="background: #b0c4de; font-weight: bold; padding: 8px; border: 1px solid #000;">Passing Marks</td>
                        <td style="padding: 8px; border: 1px solid #000;">40/Subject</td>
                    </tr>
                </table>

                <table style="width: 50%; border-collapse: collapse; border: 2px solid #000; border-top: none;">
                    <tr>
                        <td style="background: #b0c4de; font-weight: bold; padding: 8px; border: 1px solid #000;">Obtained Marks</td>
                        <td style="padding: 8px; border: 1px solid #000; font-weight: bold;" id="rc-obtained">160</td>
                    </tr>
                    <tr>
                        <td style="background: #b0c4de; font-weight: bold; padding: 8px; border: 1px solid #000;">Percentage</td>
                        <td style="padding: 8px; border: 1px solid #000; font-weight: bold;" id="rc-percentage">53.33</td>
                    </tr>
                </table>
            </div>

            <div style="text-align: center; margin: 10px 0; font-weight: bold; font-size: 18px;">
                You Are <span id="rc-status" style="margin-left: 10px;">Pass</span>
            </div>

            <div style="margin-top: 10px; border: 2px solid #000; display: flex;">
                <div style="flex: 1; border-right: 1px solid #000;">
                    <div style="background: #b0c4de; border-bottom: 1px solid #000; padding: 5px; font-weight: bold; text-align: center;">Grade</div>
                    <div style="padding: 10px; text-align: center; font-weight: bold; font-size: 20px;" id="rc-grade">B</div>
                </div>
                <div style="flex: 1; border-right: 1px solid #000;">
                    <div style="background: #b0c4de; border-bottom: 1px solid #000; padding: 5px; font-weight: bold; text-align: center;">Rank</div>
                    <div style="padding: 10px; text-align: center; font-weight: bold; font-size: 20px;" id="rc-rank">4</div>
                </div>
                <div style="flex: 2;">
                    <div style="background: #b0c4de; border-bottom: 1px solid #000; padding: 5px; font-weight: bold; text-align: center;">Rank In Jamia</div>
                    <div style="padding: 10px; text-align: center;"></div>
                </div>
            </div>

            <div style="margin-top: 0px; border: 2px solid #000; border-top: none; height: 60px; padding: 10px; text-align: center; color: #555;">
                Any Additional Information
            </div>

            <div style="margin-top: 80px; display: flex; justify-content: space-between; align-items: flex-end;">
                <div style="text-align: center; width: 200px;">
                    <div style="font-family: 'Dancing Script', cursive; font-size: 24px; margin-bottom: 5px;">Principal Sign</div>
                    <div style="border-top: 2px solid #000; padding-top: 5px;">Principal Signature</div>
                </div>

                <div style="text-align: center; width: 200px;">
                    <div style="font-family: 'Dancing Script', cursive; font-size: 24px; margin-bottom: 5px;">Taleemi Zimm.</div>
                    <div style="border-top: 2px solid #000; padding-top: 5px;">Signature Taleemi Zimmedar</div>
                </div>
            </div>

        </div>
    </div>
</div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let currentSheetData = [];
        let isEditingMode = false;
        let monthKey = "";
        let globalUserData = {};
        let finalSubjectsList = [];
        let subjectTranslationMap = {};
        let totalMax = 350; 
        let classBooksMap = {}; 
        let selectedClassName = '';

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            // Fallback support for 'id' if 'uid' is missing (as seen in older links)
            adminUid = params.get('uid') || params.get('id');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Link Invalid hai. Link me ID, Jamia, ya Month missing hai."); return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Month: ${monthKey}`;
            
            // Set hidden fields for PDF
            if(document.getElementById('pdf-jamia')) document.getElementById('pdf-jamia').textContent = jamiaName;
            if(document.getElementById('pdf-month')) document.getElementById('pdf-month').textContent = monthKey;

            await loadTeachingData();
        };

        function getAcademicYear(key) {
            if (!key) return null;
            const [yStr, mStr] = key.split("-");
            const yearNum  = parseInt(yStr);
            const monthNum = parseInt(mStr) - 1; 
            return monthNum >= 3 ? `${yearNum}-${yearNum+1}` : `${yearNum-1}-${yearNum}`;
        }

        async function loadTeachingData() {
            try {
                const acYear = getAcademicYear(monthKey);
                const userDoc = await getDoc(doc(db, "users", adminUid));
                if (!userDoc.exists()) { alert("User data nahi mila"); return; }
                const userData = userDoc.data();
                globalUserData = userData;
                const years = userData.academicYears || {};
                const yearData = years[acYear];
                let jamiaStruct = null;
                
                // Prioritize Year-based structure
                if (yearData && Array.isArray(yearData.karkardagiStructure)) {
                    jamiaStruct = yearData.karkardagiStructure.find(j => j.jamiaName === jamiaName);
                }
                // Fallback to old structure
                if (!jamiaStruct && Array.isArray(userData.academicStructure)) {
                    jamiaStruct = userData.academicStructure.find(j => j.jamiaName === jamiaName);
                }
                if (!jamiaStruct) { alert("Setup nahi mila. Admin se rabta karein."); return; }

                classBooksMap = {};
                if (Array.isArray(jamiaStruct.teachers)) {
                    jamiaStruct.teachers.forEach(t => {
                        if (Array.isArray(t.periods)) {
                            t.periods.forEach(p => {
                                const cName = p.className || p.class || p.darja;
                                const bName = p.bookName || p.book || p.kitab || p.subject;
                                if (cName && bName) {
                                    if (!classBooksMap[cName]) classBooksMap[cName] = new Set();
                                    classBooksMap[cName].add(bName);
                                }
                            });
                        }
                    });
                }

                const tabs = document.getElementById('class-tabs');
                const select = document.getElementById('class-select');
                tabs.innerHTML = '';
                select.innerHTML = '<option value="">-- Select Class --</option>';

                const sortedClasses = Object.keys(classBooksMap).sort();
                sortedClasses.forEach(cls => {
                    const opt = document.createElement('option');
                    opt.value = cls;
                    opt.textContent = cls;
                    select.appendChild(opt);

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = cls;
                    btn.dataset.class = cls;
                    let baseClass = "px-4 py-2 rounded-lg border text-sm font-semibold transition";
                    btn.className = baseClass + " bg-white hover:bg-teal-600 hover:text-white";
                    
                    btn.onclick = () => {
                        document.querySelectorAll('#class-tabs button').forEach(b => {
                            b.classList.remove('bg-teal-600', 'text-white');
                            b.classList.add('bg-white', 'text-gray-800');
                        });
                        btn.classList.remove('bg-white', 'text-gray-800');
                        btn.classList.add('bg-teal-600', 'text-white');
                        select.value = cls;
                        handleClassChange();
                    };
                    tabs.appendChild(btn);
                });

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } catch (error) { console.error("Error loading data:", error); }
        }

        // --- UPDATED UI FOR SUBJECT SELECTION ---
window.handleClassChange = () => {
    const clsName = document.getElementById('class-select').value;
    const container = document.getElementById('checkbox-container');
    const selectionArea = document.getElementById('subject-selection-area');
    const resultArea = document.getElementById('result-area');

    container.innerHTML = '';
    resultArea.classList.add('hidden'); 
    document.getElementById('students-body').innerHTML = ''; 

    if (!clsName) { selectionArea.classList.add('hidden'); return; }

    // Header Instruction Add Karein
    if(!document.getElementById('eng-instruction')) {
        const instr = document.createElement('p');
        instr.id = 'eng-instruction';
        instr.className = "text-sm text-red-600 font-bold mb-3 bg-red-50 p-2 rounded border border-red-200";
        instr.innerHTML = '<i class="fas fa-keyboard"></i> Note: Subject select karein aur Report Card ke liye uska English naam neeche box me likhein.';
        selectionArea.insertBefore(instr, document.getElementById('checkbox-container'));
    }

    const rawSubjectsSet = classBooksMap[clsName];
    if (!rawSubjectsSet) return;
    
    const filteredSubjects = Array.from(rawSubjectsSet).filter(s => {
        const lower = s.toLowerCase();
        return lower !== 'english' && lower !== 'maths';
    });

    filteredSubjects.forEach((sub) => {
        // Container for each subject
        const wrapper = document.createElement('div');
        wrapper.className = "bg-white border rounded shadow-sm p-2 hover:shadow-md transition";

        // Checkbox & Urdu Name
        const label = document.createElement('label');
        label.className = "cursor-pointer flex items-center justify-between mb-2";
        label.innerHTML = `
            <span class="font-bold text-teal-700 urdu-font text-lg">${sub}</span>
            <input type="checkbox" value="${sub}" class="subject-checkbox w-5 h-5 text-teal-600" onchange="toggleSubjectInput(this)">
        `;

        // English Input (Hidden by default)
        const input = document.createElement('input');
        input.type = "text";
        input.id = `eng-inp-${sub.replace(/\s/g, '_')}`; // Unique ID
        input.placeholder = "English Name";
        input.className = "w-full text-xs border border-gray-300 rounded p-1 outline-none focus:border-teal-500 hidden eng-name-input";
        input.dataset.forSub = sub; // Link input to subject
        
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        container.appendChild(wrapper);
    });

    selectionArea.classList.remove('hidden');
    checkExistingForClass(clsName);
};

// Helper function to toggle input visibility
window.toggleSubjectInput = (checkbox) => {
    const wrapper = checkbox.closest('div');
    const input = wrapper.querySelector('input[type="text"]');
    
    if (checkbox.checked) {
        checkLimit(checkbox); // Limit check karo
        if(checkbox.checked) { // Agar limit ke baad bhi checked hai
            input.classList.remove('hidden');
            input.focus();
        }
    } else {
        input.classList.add('hidden');
    }
};

        window.checkLimit = (elem) => {
            const checked = document.querySelectorAll('.subject-checkbox:checked');
            if (checked.length > 3) {
                elem.checked = false;
                alert("Sirf 3 kitabein select kar sakte hain.");
            }
        };

        window.generateSheet = () => {
            const checkedBoxes = document.querySelectorAll('.subject-checkbox:checked');
            if (document.querySelectorAll('.subject-checkbox').length > 0 && checkedBoxes.length !== 3) {
                if (!confirm(`Apne sirf ${checkedBoxes.length} kitabein select ki hain. Kya aap aage badhna chahte hain?`)) return;
            }
            const selected3 = Array.from(checkedBoxes).map(cb => cb.value);
            finalSubjectsList = [...selected3];
            // ðŸ”¥ SAVE ENGLISH NAMES TO MAP ðŸ”¥
    subjectTranslationMap = {}; // Reset
    checkedBoxes.forEach(cb => {
        const sub = cb.value;
        const wrapper = cb.closest('div');
        const input = wrapper.querySelector('.eng-name-input');
        // Agar user ne English naam likha hai to wo lo, warna Urdu wala hi lelo
        const engName = input.value.trim() || sub; 
        subjectTranslationMap[sub] = engName;
    });
            if (document.getElementById('include-english')?.checked) finalSubjectsList.push('English');
            if (document.getElementById('include-maths')?.checked) finalSubjectsList.push('Maths');

            totalMax = 0;
            finalSubjectsList.forEach(sub => {
                if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') totalMax += 25;
                else totalMax += 100;
            });
            renderTableHeaders();
            document.getElementById('result-area').classList.remove('hidden');
        };

        function renderTableHeaders() {
            const head = document.getElementById('table-head');
            let html = `<tr><th class="px-4 py-3 border border-gray-300 w-12">#</th><th class="px-4 py-3 border border-gray-300 text-left w-1/4">Talib-e-Ilm</th>`;
            finalSubjectsList.forEach(sub => {
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                html += `<th class="px-4 py-3 border border-gray-300 text-center">${sub} <br><span class="text-xs font-normal text-gray-200">/${max}</span></th>`;
            });
            html += `<th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Total (${totalMax})</th><th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">%</th><th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Grade</th><th class="px-2 py-3 border border-gray-300 text-center text-red-500 no-print"><i class="fas fa-trash"></i></th></tr>`;
            head.innerHTML = html;
        }

        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";
            let inputs = "";
            finalSubjectsList.forEach(sub => {
                const val = marks[sub] !== undefined ? marks[sub] : "";
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                inputs += `<td class="border border-gray-200 p-1"><input type="text" data-sub="${sub}" data-max="${max}" value="${val}" class="w-full p-2 text-center outline-none mark-input focus:bg-blue-50" oninput="calcRow(this)" placeholder="-"></td>`;
            });
            tr.innerHTML = `<td class="border border-gray-200 p-2 text-center text-gray-500">${index}</td><td class="border border-gray-200 p-1"><input type="text" value="${name}" placeholder="Naam likhein" class="w-full p-2 font-semibold urdu-font outline-none std-name"></td>${inputs}<td class="border border-gray-200 p-2 text-center font-bold text-gray-700 total-val">0</td><td class="border border-gray-200 p-2 text-center font-bold text-blue-600 perc-val">0%</td><td class="border border-gray-200 p-2 text-center font-bold text-xs grade-val">-</td><td class="border border-gray-200 p-2 text-center cursor-pointer text-red-400 hover:text-red-600 no-print" onclick="this.parentElement.remove()">Ã—</td>`;
            tbody.appendChild(tr);
            if(name) calcRow(tr.querySelector('input'));
        };

        // --- TABLE ROW CALCULATION (FIXED STYLING) ---
window.calcRow = (el) => {
    const row = el.closest('tr');
    const inputs = row.querySelectorAll('.mark-input');
    
    let obtained = 0;
    let totalMax = 0;
    
    let failCount = 0;       // Kitne subjects me fail hai
    let subjectCount = 0;    // Total subjects count
    let absentCount = 0;     // Kitne me absent hai

    inputs.forEach(inp => {
        subjectCount++;
        const subName = inp.dataset.sub ? inp.dataset.sub.toLowerCase() : "";
        let val = inp.value.trim().toUpperCase();
        
        // 1. Max Marks Tay Karein
        let max = 100;
        if (subName.includes('english') || subName.includes('math') || subName.includes('hisab')) {
            max = 25;
        }
        totalMax += max;

        // 2. Marks Calculation & Fail Check
        let numVal = 0;
        let isFail = false; // Is specific box ke liye check

        if (val === 'A') {
            // Absent Logic
            absentCount++;
            failCount++; 
            isFail = true;
        } 
        else if (val === '') {
            // Empty Logic - Kuch mat karo (Reset niche hoga)
        }
        else {
            numVal = parseFloat(val);
            
            if (!isNaN(numVal)) {
                if (numVal > max) { 
                    alert(`Maximum marks ${max} hain.`); 
                    inp.value = max; 
                    numVal = max; 
                }

                obtained += numVal;
                
                // ðŸ”¥ FAIL CHECK (Passing Marks = 40%)
                // 100 me se 40, 25 me se 10 pass hain
                const passingMarks = max * 0.40;
                
                // Agar marks passing se kam hain (0 bhi isme aayega)
                if (numVal < passingMarks) {
                    failCount++; 
                    isFail = true;
                }
            }
        }

        // ðŸ”¥ APPLY STYLING USING CSS CLASS (Ye Important Hai)
        if (isFail) {
            // Agar Fail, 0 ya A hai to class add karo
            inp.classList.add('bg-fail-input'); 
            // Inline style bhi laga dete hain safety ke liye
            inp.style.color = '#991b1b'; 
        } else {
            // Agar Pass hai ya Khali hai to class hata do
            inp.classList.remove('bg-fail-input');
            inp.style.color = ''; // Reset to default
        }
    });

    // 3. Percentage Nikalein
    let percentage = 0;
    if (totalMax > 0) percentage = (obtained / totalMax) * 100;

    // 4. Grade Logic
    let grade = "Nakam";
    let badgeClass = "bg-red-600 text-white"; // Default Fail Style

    // Rule A: Agar poori tarah Absent hai
    if (subjectCount > 0 && absentCount === subjectCount) {
        grade = "Absent";
        badgeClass = "bg-gray-500 text-white"; 
    }
    // Rule B: ðŸ”¥ Agar 3 ya ziyada subjects me Fail/Absent hai to NAKAM
    else if (failCount >= 3) {
        grade = "Nakam";
        badgeClass = "bg-red-600 text-white";
    }
    // Rule C: Percentage Base Grading
    else {
        if (percentage >= 80) { 
            grade = "Mumtaz Ma Sharf"; 
            badgeClass = "bg-teal-600 text-white"; 
        }
        else if (percentage >= 70) { 
            grade = "Mumtaz"; 
            badgeClass = "bg-green-600 text-white"; 
        }
        else if (percentage >= 60) { 
            grade = "Jayyid Jiddan"; 
            badgeClass = "bg-blue-600 text-white"; 
        }
        else if (percentage >= 50) { 
            grade = "Jayyid"; 
            badgeClass = "bg-indigo-500 text-white"; 
        }
        else if (percentage >= 40) { 
            grade = "Maqbul"; 
            badgeClass = "bg-yellow-500 text-white"; 
        }
        else { 
            grade = "Nakam"; 
            badgeClass = "bg-red-600 text-white"; 
        }
    }

    // 5. Update UI
    row.querySelector('.total-val').innerText = obtained;
    row.querySelector('.perc-val').innerText = percentage.toFixed(2) + '%';
    
    const gradeCell = row.querySelector('.grade-val');
    gradeCell.innerText = grade;
    
    // Badge Styling apply karein
    gradeCell.className = `grade-val px-2 py-1 text-center font-bold text-xs border rounded shadow-sm ${badgeClass}`;
};

        // --- FINAL SAVE RESULT (FIXED: allClasses Error & Supports Empty Table) ---
window.saveResult = async (isAutoSave = false) => {
    const rows = document.querySelectorAll('#students-body tr');
    
    // AutoSave ke waqt button change na karein taaki user disturb na ho
    const btn = document.querySelector('button[onclick="saveResult()"]');
    let originalText = "Save Result Sheet";
    
    if(btn && !isAutoSave) { 
        originalText = btn.innerText;
        btn.innerText = "Saving..."; 
        btn.disabled = true; 
    }

    const rawClass = document.getElementById('class-select').value;
    if(!rawClass && !isAutoSave) { 
        alert("Class select nahi hai."); 
        if(btn) btn.disabled=false; 
        return; 
    }
    
    const cleanClass = rawClass.split('_')[0]; 
    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`; 
    const selectedClass = rawClass; 
    const students = [];

    // Students ka data jama karein (Agar table me koi hai to)
    if (rows.length > 0) {
        rows.forEach(row => {
            const name = row.querySelector('.std-name').value.trim();
            if(!name) return;
            const marks = {};
            row.querySelectorAll('.mark-input').forEach(inp => {
                const val = inp.value.trim().toUpperCase();
                marks[inp.dataset.sub] = (val === 'A') ? 'A' : (val === '' ? 0 : parseFloat(val));
            });
            const total = parseFloat(row.querySelector('.total-val').textContent);
            const perc = parseFloat(row.querySelector('.perc-val').textContent);
            students.push({ name, marks, total, percentage: perc });
        });
    }

    try {
        // Inside saveResult function...
        await setDoc(doc(db, "monthly_test_sheets", docId), {
            adminUid, jamiaName, month: monthKey, class: selectedClass,
            subjects: finalSubjectsList, 
            subjectMap: subjectTranslationMap, // ðŸ”¥ YE LINE ADD KARNI HAI
            students, 
            updatedAt: serverTimestamp()
        });
        
        // 2. Aggregation Logic (Puri Jamia ka Result Jodna)
        let grandTotalStudents = 0; 
        let grandPassedStudents = 0;
        
        // ðŸ”¥ FIX: Ye line missing thi, ise wapas add kiya gaya hai
        const allClasses = Object.keys(classBooksMap);
        
        for (const cls of allClasses) {
            const clsClean = cls.split('_')[0];
            const sheetId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${clsClean.replace(/\s/g, '_')}`;
            
            // Khud ko dubara fetch karne ki bajaye current data use karein agar same class hai
            let sStudents = [];
            let sSubjects = [];

            if (cls === rawClass) {
                sStudents = students;
                sSubjects = finalSubjectsList;
            } else {
                const sheetSnap = await getDoc(doc(db, "monthly_test_sheets", sheetId));
                if (sheetSnap.exists()) {
                    const sData = sheetSnap.data();
                    sStudents = sData.students || [];
                    sSubjects = sData.subjects || [];
                }
            }
            
            sStudents.forEach(std => {
                // Check Full Absent
                const subKeys = Object.keys(std.marks);
                const isFullAbsent = subKeys.length > 0 && subKeys.every(k => std.marks[k] === 'A');

                if (!isFullAbsent) {
                    grandTotalStudents++; // Sirf hazir bache gino
                    
                    let isFail = false;
                    
                    // 1. Percentage check
                    if (parseFloat(std.percentage) < 40) isFail = true;
                    
                    // 2. Partial absent check
                    if (!isFail) {
                        sSubjects.forEach(sub => { if (std.marks[sub] === 'A') isFail = true; });
                    }
                    
                    // 3. Subject-wise marks check (Agar marks available hain)
                    if (!isFail) {
                        let failCount = 0;
                         sSubjects.forEach(sub => {
                            let max = (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') ? 25 : 100;
                            let pass = max * 0.40;
                            let m = std.marks[sub];
                            if (typeof m === 'number' && m < pass) failCount++;
                        });
                        if(failCount >= 3) isFail = true;
                    }

                    if (!isFail) grandPassedStudents++;
                }
            });
        }

        let jamiaPassPerc = "0%";
        if (grandTotalStudents > 0) {
            jamiaPassPerc = ((grandPassedStudents / grandTotalStudents) * 100).toFixed(1) + '%';
        }

        // 3. Admin Report Update
        const [yStr, mStr] = monthKey.split('-');
        const y = parseInt(yStr);
        const m = parseInt(mStr) - 1;
        const acYear = m >= 3 ? `${y}-${y + 1}` : `${y - 1}-${y}`;
        const reportId = `${adminUid}_${acYear}_${y}_${m}`;
        const reportRef = doc(db, 'monthly_reports', reportId);
        
        // Report update safely
        try {
            const reportSnap = await getDoc(reportRef);
            let testData = reportSnap.exists() ? (reportSnap.data().monthlyTest?.data || []) : [];
            
            // Purani entry hata kar nayi update karein
            testData = testData.filter(t => t.name !== jamiaName);
            testData.push({ 
                name: jamiaName, 
                status: 'Test Hua', 
                month: monthKey, 
                percentage: jamiaPassPerc, 
                wajah: '' 
            });
            
            await setDoc(reportRef, { monthlyTest: { status: 'Done', data: testData } }, { merge: true });
        } catch (repErr) {
            console.warn("Report update failed (Minor error):", repErr);
        }

        if (!isAutoSave) {
            // Agar Admin ne columns update kiye hain aur students 0 hain
            if (students.length === 0) {
                alert("Subjects/Columns update ho gaye hain!");
            } else {
                alert(`Result Save ho gaya!\n\nJamia Total Pass: ${grandPassedStudents} / ${grandTotalStudents} (${jamiaPassPerc})`);
            }
        }

    } catch (error) { 
        console.error("Save Error:", error); 
        if(!isAutoSave) alert("Error: " + error.message); 
    } 
    finally { 
        if(btn && !isAutoSave) { btn.innerText = originalText; btn.disabled = false; }
    }
};

        // --- FIX: LOAD DATA AND SHOW ENGLISH INPUTS ---
window.checkExistingForClass = async (clsName) => {
    const cleanClass = clsName.split('_')[0]; 
    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
    const resultArea = document.getElementById('result-area');
    const studentsBody = document.getElementById('students-body');
    const classSelect = document.getElementById('class-select');
    const selectionArea = document.getElementById('subject-selection-area'); 

    // Reset UI
    finalSubjectsList = [];
    studentsBody.innerHTML = '';
    resultArea.classList.add('hidden'); 
    document.getElementById('table-head').innerHTML = '';
    
    // Checkboxes reset
    const checkboxesList = document.querySelectorAll('.subject-checkbox');
    checkboxesList.forEach(chk => {
        chk.checked = false;
        const wrap = chk.closest('div');
        if(wrap) {
            const inp = wrap.querySelector('.eng-name-input');
            if(inp) { inp.classList.add('hidden'); inp.value = ""; }
        }
    });
    
    classSelect.disabled = false; 

    // Check View Mode
    const params = new URLSearchParams(window.location.search);
    const isViewMode = params.get('mode') === 'view';

    try {
        const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
        
        // --- SCENARIO 1: DATA EXISTS ---
        if (snap.exists()) {
            const data = snap.data(); 
            
            // 1. English Names Load
            subjectTranslationMap = data.subjectMap || {};

            // 2. Checkboxes Check & Input Show
            const savedVariableSubjects = data.subjects.filter(s => s !== 'English' && s !== 'Maths');
            
            checkboxesList.forEach(chk => { 
                if (savedVariableSubjects.includes(chk.value)) {
                    chk.checked = true;
                    const wrapper = chk.closest('div');
                    const input = wrapper.querySelector('.eng-name-input');
                    if(input) {
                        input.classList.remove('hidden');
                        input.value = subjectTranslationMap[chk.value] || "";
                    }
                }
            });
            
            finalSubjectsList = data.subjects;
            
            // Total Setup
            totalMax = 0;
            finalSubjectsList.forEach(sub => {
                if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') totalMax += 25; else totalMax += 100;
            });
            
            renderTableHeaders(); 
            resultArea.classList.remove('hidden'); 
            
            // Teacher mode me selection hide, Admin me dikhega agar Edit dabaya
            if (!isViewMode) {
                 selectionArea.classList.add('hidden'); 
            } else {
                 selectionArea.classList.add('hidden'); 
            }
            
            document.getElementById('students-body').innerHTML = ''; 
            data.students.forEach(s => addStudentRow(s.name, s.marks)); 
        } 
        // --- SCENARIO 2: NO DATA (NEW CLASS) ---
        else {
            if (isViewMode) {
                // Admin ko message dikhayein
                resultArea.classList.remove('hidden');
                document.getElementById('table-head').innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-500 italic">Is class ka data abhi tak save nahi hua hai. Upar "Enable Editing" dabakar subjects add karein.</td></tr>';
            }
        }

        // --- VIEW MODE UI SETUP (BUTTON INJECTION) ---
        if (isViewMode) {
            const headerTitle = document.querySelector('h1');
            
            // 1. Edit Button Lagayein (Agar nahi hai)
            if(headerTitle && !document.getElementById('edit-mode-btn')) {
                const badge = document.getElementById('view-badge');
                if(!badge) headerTitle.innerHTML += ` <span id="view-badge" class="text-xl bg-yellow-200 text-yellow-800 px-2 py-1 rounded ml-2 align-middle">View Only</span>`;
                
                // ðŸ”¥ YE BUTTON MISSING THA ðŸ”¥
                headerTitle.innerHTML += `
                    <button id="edit-mode-btn" onclick="enableEditMode()" class="ml-4 text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow align-middle">
                        <i class="fas fa-edit"></i> Enable Editing
                    </button>`;
            }

            // 2. Teacher Controls Hide
            ['step-heading', 'step-instruction', 'class-select'].forEach(id => { 
                const el = document.getElementById(id); if(el) el.classList.add('hidden'); 
            });
            
            const addBtn = document.querySelector('button[onclick="addStudentRow()"]');
            const saveBtn = document.querySelector('button[onclick="saveResult()"]');
            if(addBtn) { addBtn.style.display = 'none'; addBtn.classList.add('hidden-in-view'); }
            if(saveBtn) { saveBtn.style.display = 'none'; saveBtn.classList.add('hidden-in-view'); }

            // 3. Inputs Disable (Agar table bani hai)
            document.querySelectorAll('#students-body input').forEach(inp => {
                inp.disabled = true;
                inp.classList.add('view-mode-input');
                inp.style.backgroundColor = 'transparent';
                inp.style.border = 'none';
                inp.style.textAlign = 'center';
                inp.style.fontWeight = 'bold';
                inp.style.color = '#1f2937'; 
            });

            document.querySelectorAll('.no-print').forEach(btn => btn.style.display = 'none');
            const headerTrash = document.querySelector('#table-head th:last-child');
            if(headerTrash) headerTrash.style.display = 'none';
        }
        
        // Auto-Enable Logic (Agar class switch ki ho)
        if (typeof isEditingMode !== 'undefined' && isEditingMode) {
            enableEditMode(true); 
        }

    } catch(e) { console.log("New sheet or error loading:", e); }
};

        // --- SUMMARY FEATURE LOGIC ---
        window.toggleSummary = async () => {
            const entryArea = document.getElementById('data-entry-area');
            const summaryArea = document.getElementById('summary-view-area');
            const btnView = document.getElementById('btn-view-summary');
            const btnBack = document.getElementById('btn-back-entry');

            if (summaryArea.classList.contains('hidden')) {
                entryArea.classList.add('hidden');
                summaryArea.classList.remove('hidden');
                btnView.classList.add('hidden');
                btnBack.classList.remove('hidden');
                await loadSummaryData();
            } else {
                summaryArea.classList.add('hidden');
                entryArea.classList.remove('hidden');
                btnBack.classList.add('hidden');
                btnView.classList.remove('hidden');
            }
        };

        async function loadSummaryData() {
            const mainBody = document.getElementById('summary-body-main');
            const asriBody = document.getElementById('summary-body-asri');
            const mainFoot = document.getElementById('summary-foot-main');
            const asriFoot = document.getElementById('summary-foot-asri');

            mainBody.innerHTML = '<tr><td colspan="8" class="p-4 text-gray-500">Loading data...</td></tr>';
            asriBody.innerHTML = '<tr><td colspan="8" class="p-4 text-gray-500">Loading data...</td></tr>';

            try {
                const allClasses = Object.keys(classBooksMap).sort();
                let mainRowsHTML = "";
                let asriRowsHTML = "";
                let gMain = { total: 0, present: 0, pass: 0, fail: 0 };
                let gAsri = { total: 0, present: 0, pass: 0, fail: 0 };
                let sn = 1;

                for (const clsName of allClasses) {
                    const cleanClass = clsName.split('_')[0];
                    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
                    const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
                    if (!snap.exists()) continue;
                    const data = snap.data();
                    const students = data.students || [];
                    if (students.length === 0) continue;

                    let mTotal = students.length; let mPresent = 0; let mPass = 0; let mFail = 0;
                    let aTotal = students.length; let aPresent = 0; let aPass = 0; let aFail = 0;
                    let hasAsriSubjects = false;

                    students.forEach(std => {
                        // --- Main Calculation ---
                        const subjects = Object.keys(std.marks);
                        // Check if ALL subjects are 'A'
                        const isFullAbsent = subjects.length > 0 && subjects.every(sub => std.marks[sub] === 'A');

                        if (!isFullAbsent) {
                            mPresent++;
                            let isFailMain = false;
                            if (parseFloat(std.percentage) < 40) isFailMain = true;
                            // Check Partial Absent
                            subjects.forEach(sub => { if(std.marks[sub] === 'A') isFailMain = true; });
                            
                            if (isFailMain) mFail++; else mPass++;
                        }

                        // --- Asri Calculation ---
                        let engMark = std.marks['English'];
                        let mathMark = std.marks['Maths'];
                        if (engMark !== undefined || mathMark !== undefined) {
                            hasAsriSubjects = true;
                            
                            // Asri Full Absent Check
                            let asriFullAbsent = false;
                            if (engMark !== undefined && mathMark !== undefined) {
                                if (engMark === 'A' && mathMark === 'A') asriFullAbsent = true;
                            } else if (engMark !== undefined && engMark === 'A') {
                                asriFullAbsent = true;
                            } else if (mathMark !== undefined && mathMark === 'A') {
                                asriFullAbsent = true;
                            }

                            if (!asriFullAbsent) {
                                aPresent++;
                                let isFailAsri = false;
                                if (engMark === 'A' || mathMark === 'A') isFailAsri = true;
                                if (engMark !== undefined && typeof engMark === 'number' && engMark < 10) isFailAsri = true;
                                if (mathMark !== undefined && typeof mathMark === 'number' && mathMark < 10) isFailAsri = true;
                                if (isFailAsri) aFail++; else aPass++;
                            }
                        }
                    });

                    let mPerc = mPresent > 0 ? ((mPass / mPresent) * 100).toFixed(1) : "0.0";
                    let mGrade = getSummaryGrade(mPerc);
                    gMain.total += mTotal; gMain.present += mPresent; gMain.pass += mPass; gMain.fail += mFail;

                    mainRowsHTML += `<tr class="odd:bg-white even:bg-gray-50 hover:bg-purple-50"><td class="p-2 border">${sn}</td><td class="p-2 border text-left font-semibold">${clsName}</td><td class="p-2 border">${mTotal}</td><td class="p-2 border">${mPresent}</td><td class="p-2 border text-green-700 font-bold">${mPass}</td><td class="p-2 border text-red-600 font-bold">${mFail}</td><td class="p-2 border font-bold">${mPerc}%</td><td class="p-2 border"><span class="${getGradeColor(mGrade)} px-2 py-1 rounded text-xs text-white">${mGrade}</span></td></tr>`;

                    if (hasAsriSubjects) {
                        let aPerc = aPresent > 0 ? ((aPass / aPresent) * 100).toFixed(1) : "0.0";
                        let aGrade = getSummaryGrade(aPerc);
                        gAsri.total += aTotal; gAsri.present += aPresent; gAsri.pass += aPass; gAsri.fail += aFail;
                        asriRowsHTML += `<tr class="odd:bg-white even:bg-gray-50 hover:bg-purple-50"><td class="p-2 border">${sn}</td><td class="p-2 border text-left font-semibold">${clsName}</td><td class="p-2 border">${aTotal}</td><td class="p-2 border">${aPresent}</td><td class="p-2 border text-green-700 font-bold">${aPass}</td><td class="p-2 border text-red-600 font-bold">${aFail}</td><td class="p-2 border font-bold">${aPerc}%</td><td class="p-2 border"><span class="${getGradeColor(aGrade)} px-2 py-1 rounded text-xs text-white">${aGrade}</span></td></tr>`;
                    } else {
                        asriRowsHTML += `<tr><td class="p-2 border">${sn}</td><td class="p-2 border text-left font-semibold">${clsName}</td><td colspan="6" class="p-2 border text-gray-400">Asri subjects nahi hain</td></tr>`;
                    }
                    sn++;
                }

                mainBody.innerHTML = mainRowsHTML || '<tr><td colspan="8" class="p-4">No data found</td></tr>';
                asriBody.innerHTML = asriRowsHTML || '<tr><td colspan="8" class="p-4">No data found</td></tr>';

                let gMainPerc = gMain.present > 0 ? ((gMain.pass / gMain.present) * 100).toFixed(2) : "0.00";
                mainFoot.innerHTML = `<tr class="bg-green-600"><td colspan="2" class="p-2 border text-right text-lg">Total</td><td class="p-2 border bg-purple-300 text-black">${gMain.total}</td><td class="p-2 border bg-purple-300 text-black">${gMain.present}</td><td class="p-2 border bg-purple-300 text-black">${gMain.pass}</td><td class="p-2 border bg-purple-300 text-black">${gMain.fail}</td><td class="p-2 border bg-purple-300 text-black">${gMainPerc}%</td><td class="p-2 border bg-red-600">${getSummaryGrade(gMainPerc)}</td></tr>`;

                let gAsriPerc = gAsri.present > 0 ? ((gAsri.pass / gAsri.present) * 100).toFixed(2) : "0.00";
                asriFoot.innerHTML = `<tr class="bg-green-600"><td colspan="2" class="p-2 border text-right text-lg">Total</td><td class="p-2 border bg-purple-300 text-black">${gAsri.total}</td><td class="p-2 border bg-purple-300 text-black">${gAsri.present}</td><td class="p-2 border bg-purple-300 text-black">${gAsri.pass}</td><td class="p-2 border bg-purple-300 text-black">${gAsri.fail}</td><td class="p-2 border bg-purple-300 text-black">${gAsriPerc}%</td><td class="p-2 border bg-red-600">${getSummaryGrade(gAsriPerc)}</td></tr>`;
            } catch (e) { console.error("Summary Error:", e); mainBody.innerHTML = '<tr><td colspan="8" class="text-red-500 p-4">Error loading summary.</td></tr>'; }
        }

        function getSummaryGrade(perc) { const p = parseFloat(perc); if (p >= 80) return "Mumtaz"; if (p >= 70) return "Jayyid Jiddan"; if (p >= 60) return "Jayyid"; if (p >= 50) return "Maqbul"; if (p >= 40) return "Pass"; return "Kamzoor"; }
        function getGradeColor(grade) { if (grade === "Mumtaz") return "bg-green-700"; if (grade === "Jayyid Jiddan") return "bg-green-600"; if (grade === "Jayyid") return "bg-yellow-500"; if (grade === "Maqbul") return "bg-orange-500"; return "bg-red-600"; }

        // --- PDF GENERATION (FIXED & COMPLETE) ---
        window.downloadPDF = async () => {
            if (!window.html2canvas) { alert("Error: html2canvas library missing hai."); return; }
            const saveBtn = document.querySelector('button[onclick="downloadPDF()"]');
            if(saveBtn) saveBtn.innerText = "Processing...";
            const jamiaTitle = document.getElementById('pdf-jamia').innerText;
            const currentClass = document.getElementById('class-select').value || "";
            const monthText = monthKey;
            const tableHeadHTML = document.getElementById('table-head').innerHTML;
            const originalTableBody = document.getElementById('students-body');

            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px'; tempContainer.style.top = '0px'; tempContainer.style.width = '1100px'; 
            document.body.appendChild(tempContainer);
            const PAGE_HEIGHT_LIMIT = 760; 
            const COLOR_TEAL_DARK = "#0f766e"; const COLOR_TEAL_LIGHT = "#f0fdfa"; const COLOR_BORDER = "#0f766e";

            function createNewPage() {
                const pageDiv = document.createElement('div');
                pageDiv.style.backgroundColor = "white"; pageDiv.style.padding = "20px"; pageDiv.style.width = "100%"; pageDiv.style.boxSizing = "border-box";
                pageDiv.innerHTML = `<div style="margin-bottom: 10px; border: 2px solid ${COLOR_BORDER}; border-radius: 8px; overflow: hidden;"><table style="width: 100%; border-collapse: collapse;"><tr style="height: 40px;"><td style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold; font-size: 18px; width: 66%; border-right: 1px solid white; text-transform: uppercase;">Monthly Test Result</td><td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-bottom: 1px solid ${COLOR_BORDER}; border-right: 1px solid ${COLOR_BORDER}; width: 17%;">CLASS</td><td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold; font-size: 16px; border-bottom: 1px solid ${COLOR_BORDER}; width: 17%;">${currentClass}</td></tr><tr style="height: 50px;"><td style="background-color: white; color: #115e59; text-align: center; font-family: 'Jameel Noori Nastaleeq', serif; font-size: 24px; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">${jamiaTitle}</td><td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">MONTH</td><td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold;">${monthText}</td></tr></table></div><table class="result-table" style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 13px;"><thead style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold;">${tableHeadHTML}</thead><tbody class="divide-y divide-gray-200" style="text-align: center;"></tbody></table>`;
                const ths = pageDiv.querySelectorAll('.result-table th'); if(ths.length > 0) ths[ths.length - 1].remove(); 
                pageDiv.querySelectorAll('.result-table th').forEach(th => { th.style.backgroundColor = COLOR_TEAL_DARK; th.style.color = "white"; th.style.padding = "8px 4px"; th.style.border = "1px solid #ccc"; });
                tempContainer.appendChild(pageDiv); return pageDiv;
            }

            try {
                const rows = Array.from(originalTableBody.querySelectorAll('tr'));
                let currentPage = createNewPage(); let currentTbody = currentPage.querySelector('.result-table tbody');
                for (let row of rows) {
                    const clonedRow = row.cloneNode(true);
                    const lastTd = clonedRow.querySelector('td:last-child'); if(lastTd) lastTd.remove();
                    const inputs = clonedRow.querySelectorAll('input');
                    inputs.forEach(input => {
                        const div = document.createElement('div'); div.innerText = input.value || '-';
                        div.style.textAlign = "center"; div.style.fontWeight = "bold"; div.style.width = "100%"; div.style.padding = "5px 0";
                        if(input.classList.contains('bg-fail-input')) { div.style.backgroundColor = "#fee2e2"; div.style.color = "#991b1b"; }
                        if(input.parentNode) input.parentNode.replaceChild(div, input);
                    });
                    clonedRow.querySelectorAll('td').forEach(td => { td.style.padding = "5px 2px"; td.style.textAlign = "center"; td.style.border = "1px solid #e5e7eb"; td.classList.remove('text-right', 'pr-2'); });
                    currentTbody.appendChild(clonedRow);
                    if (currentPage.offsetHeight > PAGE_HEIGHT_LIMIT) { currentTbody.removeChild(clonedRow); currentPage = createNewPage(); currentTbody = currentPage.querySelector('.result-table tbody'); currentTbody.appendChild(clonedRow); }
                }
                const pages = Array.from(tempContainer.children); const { jsPDF } = window.jspdf; const pdfDoc = new jsPDF('l', 'mm', 'a4'); 
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i]; const canvas = await html2canvas(page, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                    const imgData = canvas.toDataURL('image/png'); const imgWidth = 297; const imgHeight = canvas.height * imgWidth / canvas.width;
                    if (i > 0) pdfDoc.addPage(); pdfDoc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                }
                document.body.removeChild(tempContainer); pdfDoc.save(`Result_${jamiaTitle}_${currentClass}.pdf`);
            } catch (error) { console.error("PDF Logic Error:", error); alert("PDF Generation Failed: " + error.message); } finally { if(saveBtn) saveBtn.innerText = "Download PDF"; }
        };

        // --- UPDATED: DOWNLOAD ALL CLASSES WITH SUMMARY PAGE ---
        window.downloadAllClassesPDF = async () => {
            if (!window.html2canvas) { alert("html2canvas library missing hai."); return; }

            const btn = document.getElementById('download-all-btn');
            const originalText = btn.innerText;
            btn.innerText = "Processing..."; 
            btn.disabled = true;             

            try {
                const { jsPDF } = window.jspdf;
                const pdfDoc = new jsPDF('l', 'mm', 'a4'); 
                
                // Colors Constants (PDF Styling)
                const COLOR_TEAL_DARK = "#0f766e"; 
                const COLOR_TEAL_LIGHT = "#f0fdfa"; 
                const COLOR_BORDER = "#0f766e";

                // 1. Data Fetching & Summary Calculation
                const allClasses = Object.keys(classBooksMap).sort();
                const classDataList = []; // Data cache taaki dobara fetch na karna pade

                // Summary Variables
                let mainRowsHTML = "";
                let asriRowsHTML = "";
                let gMain = { total: 0, present: 0, pass: 0, fail: 0 };
                let gAsri = { total: 0, present: 0, pass: 0, fail: 0 };
                let sn = 1;

                // Loop 1: Fetch All Data & Build Summary
                for (const clsName of allClasses) {
                    btn.innerText = `Reading: ${clsName}...`;
                    const cleanClass = clsName.split('_')[0]; 
                    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
                    const docSnap = await getDoc(doc(db, "monthly_test_sheets", docId));

                    if (!docSnap.exists()) continue;

                    const data = docSnap.data();
                    const students = data.students || [];
                    const subjects = data.subjects || [];
                    if (students.length === 0) continue;

                    // Cache Data for Step 3
                    classDataList.push({ clsName, data, students, subjects });

                    // --- CALCULATION LOGIC (Same as View Summary) ---
                    let mTotal = students.length; let mPresent = 0; let mPass = 0; let mFail = 0;
                    let aTotal = students.length; let aPresent = 0; let aPass = 0; let aFail = 0;
                    let hasAsriSubjects = false;

                    students.forEach(std => {
                        // Main Calculation
                        mPresent++;
                        let isFailMain = false;
                        if (parseFloat(std.percentage) < 40) isFailMain = true;
                        const subKeys = Object.keys(std.marks);
                        subKeys.forEach(sub => { if(std.marks[sub] === 'A') isFailMain = true; });
                        if (isFailMain) mFail++; else mPass++;

                        // Asri Calculation
                        let engMark = std.marks['English'];
                        let mathMark = std.marks['Maths'];
                        if (engMark !== undefined || mathMark !== undefined) {
                            hasAsriSubjects = true;
                            aPresent++;
                            let isFailAsri = false;
                            if (engMark === 'A' || mathMark === 'A') isFailAsri = true;
                            if (engMark !== undefined && typeof engMark === 'number' && engMark < 10) isFailAsri = true;
                            if (mathMark !== undefined && typeof mathMark === 'number' && mathMark < 10) isFailAsri = true;
                            if (isFailAsri) aFail++; else aPass++;
                        }
                    });

                    // Main Row HTML
                    let mPerc = mPresent > 0 ? ((mPass / mPresent) * 100).toFixed(1) : "0.0";
                    let mGrade = getSummaryGrade(mPerc);
                    gMain.total += mTotal; gMain.present += mPresent; gMain.pass += mPass; gMain.fail += mFail;

                    mainRowsHTML += `
                        <tr style="background-color: ${sn % 2 === 0 ? '#f9fafb' : 'white'};">
                            <td style="border:1px solid #ccc; padding:6px;">${sn}</td>
                            <td style="border:1px solid #ccc; padding:6px; text-align:left;">${clsName}</td>
                            <td style="border:1px solid #ccc; padding:6px;">${mTotal}</td>
                            <td style="border:1px solid #ccc; padding:6px;">${mPresent}</td>
                            <td style="border:1px solid #ccc; padding:6px; color:#15803d; font-weight:bold;">${mPass}</td>
                            <td style="border:1px solid #ccc; padding:6px; color:#dc2626; font-weight:bold;">${mFail}</td>
                            <td style="border:1px solid #ccc; padding:6px; font-weight:bold;">${mPerc}%</td>
                            <td style="border:1px solid #ccc; padding:6px;">${mGrade}</td>
                        </tr>`;

                    // Asri Row HTML
                    if (hasAsriSubjects) {
                        let aPerc = aPresent > 0 ? ((aPass / aPresent) * 100).toFixed(1) : "0.0";
                        let aGrade = getSummaryGrade(aPerc);
                        gAsri.total += aTotal; gAsri.present += aPresent; gAsri.pass += aPass; gAsri.fail += aFail;

                        asriRowsHTML += `
                            <tr style="background-color: ${sn % 2 === 0 ? '#f9fafb' : 'white'};">
                                <td style="border:1px solid #ccc; padding:6px;">${sn}</td>
                                <td style="border:1px solid #ccc; padding:6px; text-align:left;">${clsName}</td>
                                <td style="border:1px solid #ccc; padding:6px;">${aTotal}</td>
                                <td style="border:1px solid #ccc; padding:6px;">${aPresent}</td>
                                <td style="border:1px solid #ccc; padding:6px; color:#15803d; font-weight:bold;">${aPass}</td>
                                <td style="border:1px solid #ccc; padding:6px; color:#dc2626; font-weight:bold;">${aFail}</td>
                                <td style="border:1px solid #ccc; padding:6px; font-weight:bold;">${aPerc}%</td>
                                <td style="border:1px solid #ccc; padding:6px;">${aGrade}</td>
                            </tr>`;
                    }
                    sn++;
                }

                if (classDataList.length === 0) {
                    alert("Koi bhi saved data nahi mila.");
                    btn.innerText = originalText; btn.disabled = false;
                    return;
                }

                // Temp Container for PDF Generation
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0px';
                tempContainer.style.width = '1100px'; 
                document.body.appendChild(tempContainer);

                // 2. Generate SUMMARY PAGE
                btn.innerText = "Generating Summary...";
                
                let gMainPerc = gMain.present > 0 ? ((gMain.pass / gMain.present) * 100).toFixed(1) : "0.0";
                let gAsriPerc = gAsri.present > 0 ? ((gAsri.pass / gAsri.present) * 100).toFixed(1) : "0.0";

                const summaryDiv = document.createElement('div');
                summaryDiv.style.backgroundColor = "white"; summaryDiv.style.padding = "20px"; summaryDiv.style.width = "100%"; summaryDiv.style.boxSizing = "border-box";
                
                summaryDiv.innerHTML = `
                    <div style="text-align:center; margin-bottom:20px;">
                        <h1 style="font-family: 'Jameel Noori Nastaleeq', serif; font-size:30px; margin:0;">${jamiaName}</h1>
                        <h2 style="font-size:18px; color:#0f766e; margin:5px 0;">Monthly Test Summary Report - ${monthKey}</h2>
                    </div>

                    <div style="margin-bottom:20px;">
                        <div style="background-color:${COLOR_TEAL_DARK}; color:white; padding:5px; font-weight:bold; text-align:center;">Result Summary (All Subjects)</div>
                        <table style="width:100%; border-collapse:collapse; text-align:center; font-size:12px;">
                            <thead style="background-color:${COLOR_TEAL_LIGHT}; color:#0f766e; font-weight:bold;">
                                <tr>
                                    <th style="border:1px solid #ccc; padding:8px;">#</th>
                                    <th style="border:1px solid #ccc; padding:8px; text-align:left;">Class</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Total</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Present</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Pass</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Fail</th>
                                    <th style="border:1px solid #ccc; padding:8px;">%</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Grade</th>
                                </tr>
                            </thead>
                            <tbody>${mainRowsHTML}</tbody>
                            <tfoot style="background-color:#0f766e; color:white; font-weight:bold;">
                                <tr>
                                    <td colspan="2" style="border:1px solid #ccc; padding:8px; text-align:right;">Grand Total</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gMain.total}</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gMain.present}</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gMain.pass}</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gMain.fail}</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gMainPerc}%</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${getSummaryGrade(gMainPerc)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div>
                        <div style="background-color:${COLOR_TEAL_DARK}; color:white; padding:5px; font-weight:bold; text-align:center;">Asri Subjects Summary (English & Maths)</div>
                        <table style="width:100%; border-collapse:collapse; text-align:center; font-size:12px;">
                            <thead style="background-color:${COLOR_TEAL_LIGHT}; color:#0f766e; font-weight:bold;">
                                <tr>
                                    <th style="border:1px solid #ccc; padding:8px;">#</th>
                                    <th style="border:1px solid #ccc; padding:8px; text-align:left;">Class</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Total</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Present</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Pass</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Fail</th>
                                    <th style="border:1px solid #ccc; padding:8px;">%</th>
                                    <th style="border:1px solid #ccc; padding:8px;">Grade</th>
                                </tr>
                            </thead>
                            <tbody>${asriRowsHTML}</tbody>
                            <tfoot style="background-color:#0f766e; color:white; font-weight:bold;">
                                <tr>
                                    <td colspan="2" style="border:1px solid #ccc; padding:8px; text-align:right;">Grand Total</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gAsri.total}</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gAsri.present}</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gAsri.pass}</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gAsri.fail}</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${gAsriPerc}%</td>
                                    <td style="border:1px solid #ccc; padding:8px;">${getSummaryGrade(gAsriPerc)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;

                tempContainer.appendChild(summaryDiv);

                // Capture Summary
                const sumCanvas = await html2canvas(summaryDiv, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                const sumImg = sumCanvas.toDataURL('image/png');
                const imgWidth = 297; 
                const imgHeight = sumCanvas.height * imgWidth / sumCanvas.width;
                pdfDoc.addImage(sumImg, 'PNG', 0, 0, imgWidth, imgHeight);

                // Remove summary div to save memory
                tempContainer.removeChild(summaryDiv);


                // 3. Generate CLASS PAGES
                for (const item of classDataList) {
                    btn.innerText = `Generating: ${item.clsName}...`;
                    
                    // Create Page Layout (Reusing Logic)
                    const pageDiv = document.createElement('div');
                    pageDiv.style.backgroundColor = "white"; pageDiv.style.padding = "20px"; pageDiv.style.width = "100%"; pageDiv.style.boxSizing = "border-box";
                    
                    // Header HTML
                    let headerCells = "";
                    let totalMax = 0;
                    item.subjects.forEach(sub => {
                        const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths'; 
                        const max = isSmall ? 25 : 100; totalMax += max;
                        headerCells += `<th style="background-color: ${COLOR_TEAL_DARK}; color: white; padding: 8px 4px; border: 1px solid #ccc;">${sub} <br><span style="font-size: 10px; font-weight: normal; color: #ccfbf1;">/${max}</span></th>`;
                    });

                    pageDiv.innerHTML = `
                        <div style="margin-bottom: 10px; border: 2px solid ${COLOR_BORDER}; border-radius: 8px; overflow: hidden;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="height: 40px;">
                                    <td style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold; font-size: 18px; width: 66%; border-right: 1px solid white; text-transform: uppercase;">Monthly Test Result</td>
                                    <td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-bottom: 1px solid ${COLOR_BORDER}; border-right: 1px solid ${COLOR_BORDER}; width: 17%;">CLASS</td>
                                    <td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold; font-size: 16px; border-bottom: 1px solid ${COLOR_BORDER}; width: 17%;">${item.clsName}</td>
                                </tr>
                                <tr style="height: 50px;">
                                    <td style="background-color: white; color: #115e59; text-align: center; font-family: 'Jameel Noori Nastaleeq', serif; font-size: 24px; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">${jamiaName}</td>
                                    <td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">MONTH</td>
                                    <td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold;">${monthKey}</td>
                                </tr>
                            </table>
                        </div>
                        <table class="result-table" style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 13px;">
                            <thead style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold;">
                                <tr>
                                    <th style="background-color: ${COLOR_TEAL_DARK}; color: white; padding: 8px 4px; border: 1px solid #ccc; width: 40px;">#</th>
                                    <th style="background-color: ${COLOR_TEAL_DARK}; color: white; padding: 8px 4px; border: 1px solid #ccc; width: 25%; text-align: center;">Talib-e-Ilm</th>
                                    ${headerCells}
                                    <th style="background-color: #115e59; color: white; padding: 8px 4px; border: 1px solid #ccc;">Total (${totalMax})</th>
                                    <th style="background-color: #115e59; color: white; padding: 8px 4px; border: 1px solid #ccc;">%</th>
                                    <th style="background-color: #115e59; color: white; padding: 8px 4px; border: 1px solid #ccc;">Grade</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200" style="text-align: center;"></tbody>
                        </table>`;
                    
                    tempContainer.appendChild(pageDiv);

                    // Fill Rows
                    const PAGE_HEIGHT_LIMIT = 760; 
                    let currentTbody = pageDiv.querySelector('.result-table tbody');
                    let tempPage = pageDiv; // Reference to current page div

                    // Rows Loop
                    for (let i = 0; i < item.students.length; i++) {
                        const std = item.students[i];
                        const tr = document.createElement('tr');
                        let tds = ""; let hasAbsent = false;

                        item.subjects.forEach(sub => {
                            let val = std.marks[sub]; if (val === undefined) val = "-"; 
                            let cellStyle = "background: transparent;"; let displayVal = val;
                            
                            if (val === 'A') { hasAbsent = true; cellStyle = "background-color: #fee2e2; color: #991b1b;"; } 
                            else if (val !== '-' && typeof val === 'number') { 
                                const max = (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') ? 25 : 100; 
                                const pass = max === 25 ? 10 : 40; 
                                if (val < pass) cellStyle = "background-color: #fee2e2; color: #991b1b;"; 
                            }
                            tds += `<td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: bold; ${cellStyle}">${displayVal}</td>`;
                        });

                        let grade = "Nakam"; let cls = "background-color: #ef4444; color: white;"; 
                        const p = parseFloat(std.percentage);
                        if (p >= 80) { grade = "Mumtaz Ma Sharf"; cls = "background-color: #15803d; color: white;"; }
                        else if (p >= 70) { grade = "Mumtaz"; cls = "background-color: #22c55e; color: white;"; }
                        else if (p >= 50) { grade = "Jayyid"; cls = "background-color: #eab308; color: white;"; }
                        else if (p >= 40) { grade = "Maqbul"; cls = "background-color: #f97316; color: white;"; }
                        
                        if (hasAbsent || p < 40) { grade = "Nakam"; cls = "background-color: #ef4444; color: white;"; }

                        tr.innerHTML = `
                            <td style="border: 1px solid #e5e7eb; padding: 5px 2px; color: #6b7280;">${i + 1}</td>
                            <td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: 600; font-family: 'Jameel Noori Nastaleeq', serif; font-size: 14px; text-align: center;">${std.name}</td>
                            ${tds}
                            <td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: bold;">${std.total}</td>
                            <td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: bold; color: #2563eb;">${std.percentage}%</td>
                            <td style="border: 1px solid #e5e7eb; padding: 5px 2px; font-weight: bold; font-size: 12px; border-radius: 4px; ${cls}">${grade}</td>
                        `;
                        currentTbody.appendChild(tr);

                        // Page Break Check
                        if (tempPage.offsetHeight > PAGE_HEIGHT_LIMIT) {
                            currentTbody.removeChild(tr);
                            
                            // Capture Full Page
                            const canvas = await html2canvas(tempPage, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = 297; const imgHeight = canvas.height * imgWidth / canvas.width;
                            pdfDoc.addPage();
                            pdfDoc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                            // Create New Page for remaining rows
                            tempContainer.removeChild(tempPage); // Clean old
                            
                            // Re-create Header
                            const newPageDiv = pageDiv.cloneNode(true); 
                            newPageDiv.querySelector('tbody').innerHTML = ''; // Clear rows
                            tempPage = newPageDiv;
                            tempContainer.appendChild(tempPage);
                            currentTbody = tempPage.querySelector('tbody');
                            currentTbody.appendChild(tr);
                        }
                    }

                    // Capture Last Page of this class
                    const canvas = await html2canvas(tempPage, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 297; const imgHeight = canvas.height * imgWidth / canvas.width;
                    pdfDoc.addPage();
                    pdfDoc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                    tempContainer.removeChild(tempPage);
                }

                document.body.removeChild(tempContainer);
                pdfDoc.save(`All_Classes_Result_${jamiaName}_${monthKey}.pdf`);

            } catch (error) {
                console.error("PDF Error:", error);
                alert("Error: " + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };
       // --- PROFESSIONAL REPORT CARD GENERATION (FIXED: FETCH ENGLISH NAMES FROM DB) ---
window.downloadReportCards = async () => {
    // 1. Validations
    if (!window.html2canvas) { alert("Library missing."); return; }
    const rows = document.querySelectorAll('#students-body tr');
    if(rows.length === 0) { alert("Koi data nahi hai."); return; }

    if (typeof globalUserData === 'undefined') {
        console.error("Error: globalUserData missing.");
        alert("System Error: Page refresh karein.");
        return;
    }

    const btn = document.querySelector('button[onclick="downloadReportCards()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching Data...';
    btn.disabled = true;

    try {
        // --- 1. FETCH SAVED ENGLISH NAMES FROM DB (NEW LOGIC) ---
        // Ye sabse zaroori step hai. Hum DB se map mangwayenge.
        let dbSubjectMap = {}; 
        try {
            const rawClass = document.getElementById('class-select').value;
            if(rawClass) {
                const cleanClass = rawClass.split('_')[0]; 
                const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
                const docSnap = await getDoc(doc(db, "monthly_test_sheets", docId));
                if (docSnap.exists()) {
                    dbSubjectMap = docSnap.data().subjectMap || {};
                }
            }
        } catch (err) { console.log("Map fetch error:", err); }

        // --- HELPERS ---
        const getCorsFriendlyUrl = (url) => {
            if (!url) return null;
            let directUrl = url;
            if (url.includes("drive.google.com")) {
                let id = null;
                let match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match) id = match[1];
                else { match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/); if (match) id = match[1]; }
                if (id) directUrl = `https://drive.google.com/thumbnail?id=${id}&sz=w500`; 
            }
            return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(directUrl);
        };

        const formatMonthYear = (yyyyMm) => {
            if (!yyyyMm) return "";
            const [year, month] = yyyyMm.split('-');
            const monthNames = ["January", "February", "March", "April", "May", "June", 
                                "July", "August", "September", "October", "November", "December"];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        };

        const getSemester = (yyyyMm) => {
            if (!yyyyMm) return "";
            const month = parseInt(yyyyMm.split('-')[1]);
            if (month >= 4 && month <= 9) return "1st SEMESTER";
            else return "2nd SEMESTER";
        };

        // Name Font Sizer
        const getNameFontSize = (name) => {
            if (!name) return '28px';
            const len = name.length;
            if (len > 30) return '16px';      
            else if (len > 20) return '20px'; 
            else if (len > 15) return '24px'; 
            return '28px';                    
        };

        const displayMonth = formatMonthYear(monthKey);
        const displaySemester = getSemester(monthKey);

        // ðŸ”¥ UPDATED SUBJECT NAME LOGIC ðŸ”¥
        const getSubjectNames = (originalName) => {
            const lower = originalName.toLowerCase().trim();
            const urduTxt = originalName.trim();
            
            // 1. Check Database Map (Priority 1)
            // Agar aapne form me English naam likha tha, to wo yahan se aayega
            if (dbSubjectMap[originalName]) {
                return { en: dbSubjectMap[originalName], ur: originalName };
            }

            // 2. Fallback to Global Map (Priority 2)
            if (typeof subjectTranslationMap !== 'undefined' && subjectTranslationMap[originalName]) {
                return { en: subjectTranslationMap[originalName], ur: originalName };
            }

            // 3. Standard Subjects (English/Maths)
            if (lower.includes('english') || lower.includes('eng')) return { en: "English Language", ur: "Ø§Ù†Ú¯Ø±ÛŒØ²ÛŒ" };
            if (lower.includes('math') || lower.includes('hisab') || urduTxt.includes('Ø­Ø³Ø§Ø¨')) return { en: "Mathematics", ur: "Ø­Ø³Ø§Ø¨" };
            
            // 4. Default: Agar kuch nahi mila to wahi naam wapas karo
            return { en: originalName, ur: originalName };
        };

        const urduClassName = document.getElementById('class-select').value.split('_')[0].trim();
        const classTranslations = {
            "Ø§Ø¨ØªØ¯Ø§Ø¦ÛŒÛ": "Ibtedaiyah(Primary)",
            "Ø³Ø§Ù„ Ø§ÙˆÙ„": "Pre Darse Nizami 1st year", "Ø§ÙˆÙ„": "Pre Darse Nizami 1st year", 
            "Ø³Ø§Ù„ Ø¯ÙˆÙ…": "Pre Darse Nizami 2nd Year", "Ø¯ÙˆÙ…": "Pre Darse Nizami 2nd Year", 
            "Ø§ÙˆÙ„Ù‰": "Ula(1st Year)", "Ø§ÙˆÙ„Ù°Ù‰": "Ula(1st Year)", 
            "Ø«Ø§Ù†ÛŒÛ": "Saniyah(2nd Year)", 
            "Ø«Ø§Ù„Ø«Û": "Salisah(3rd year)",
            "Ø±Ø§Ø¨Ø¹Û": "Rabiah(4th year)", 
            "Ø®Ø§Ù…Ø³Û": "Khamisah(5th year)", 
            "Ø³Ø§Ø¯Ø³Û": "Sadisah(6th year)", 
            "Ø³Ø§Ø¨Ø¹Û": "Sabiah(7th Year)",
            "Ø¯ÙˆØ±Û Ø­Ø¯ÛŒØ«": "Daura-e-Hadith(Final year)", 
            "Ù…Ø¯Ù†ÛŒ": "Madani", "Ø¨Ù†ÛŒÙ†": "Banin"
        };
        
        let englishClassName = classTranslations[urduClassName] || urduClassName;
        for (const [key, val] of Object.entries(classTranslations)) {
            if (urduClassName.includes(key)) { englishClassName = val; break; }
        }

        // --- FETCH SIGNATURES ---
        const taleemiSigRaw = globalUserData.signatureTaleemi || null;
        const taleemiSigUrl = getCorsFriendlyUrl(taleemiSigRaw);
        let principalSigUrl = null;
        try {
            const [yStr, mStr] = monthKey.split('-');
            const y = parseInt(yStr);
            const m = parseInt(mStr) - 1;
            const acYear = m >= 3 ? `${y}-${y + 1}` : `${y - 1}-${y}`;
            const reportId = `${adminUid}_${acYear}_${y}_${m}`;
            const reportSnap = await getDoc(doc(db, 'monthly_reports', reportId));
            if (reportSnap.exists()) {
                const reportData = reportSnap.data();
                const jamiaEntry = reportData.monthlyTest?.data?.find(j => j.name.trim() === jamiaName.trim());
                if (jamiaEntry && jamiaEntry.signature) {
                    principalSigUrl = getCorsFriendlyUrl(jamiaEntry.signature);
                }
            }
        } catch (err) { console.error(err); }

        // --- DATA PREPARATION ---
        let studentsData = [];
        rows.forEach((row, index) => {
            const name = row.querySelector('.std-name').value.trim();
            if(!name) return;
            const marks = {};
            row.querySelectorAll('.mark-input').forEach(inp => {
                marks[inp.dataset.sub] = inp.value.trim().toUpperCase();
            });
            const totalObtained = parseFloat(row.querySelector('.total-val').textContent) || 0;
            const percentage = parseFloat(row.querySelector('.perc-val').textContent) || 0;
            let grade = row.querySelector('.grade-val').textContent;

            studentsData.push({
                index: index + 1, name: name, marks: marks,
                obtained: totalObtained, percentage: percentage, grade: grade
            });
        });

        studentsData.sort((a, b) => b.percentage - a.percentage);
        studentsData.forEach((std, i) => { std.rank = i + 1; });

        // --- PDF GENERATION ---
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
        const pageWidth = 210;
        const pageHeight = 297;

        let container = document.getElementById('report-card-container');
        if(!container) {
            container = document.createElement('div');
            container.id = 'report-card-container';
            document.body.appendChild(container);
        }
        container.style.position = 'absolute'; container.style.left = '0px'; container.style.top = '0px'; container.style.zIndex = '-100';

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';

        for (let i = 0; i < studentsData.length; i++) {
            const std = studentsData[i];
            let grandTotalMax = 0;
            let rowsHTML = "";
            let failedSubjectsCount = 0;

            finalSubjectsList.forEach(sub => {
                const subLower = sub.toLowerCase();
                const isSmall = subLower.includes('english') || subLower.includes('math') || subLower.includes('hisab');
                const max = isSmall ? 25 : 100;
                grandTotalMax += max;
                
                let obtStr = std.marks[sub] || '-';
                let obtVal = 0;
                let isAbsent = false;

                if(obtStr === 'A') {
                    obtStr = 'Abs';
                    isAbsent = true;
                } else {
                    obtVal = parseFloat(obtStr) || 0;
                }

                const passingMarks = max * 0.40;
                let isFail = false;
                if (isAbsent || (!isNaN(obtVal) && obtVal < passingMarks)) {
                    failedSubjectsCount++;
                    isFail = true;
                }

                // ðŸ”¥ Yahan Naya getSubjectNames function use hoga
                const names = getSubjectNames(sub);

                const markCellStyle = isFail 
                    ? 'padding: 10px; text-align: center; font-weight: bold; color: #991b1b; background-color: #fee2e2; border-right: 1px solid #e2e8f0;' 
                    : 'padding: 10px; text-align: center; font-weight: bold; color: #2b6cb0; border-right: 1px solid #e2e8f0;';

                rowsHTML += `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 10px; text-align: left; font-weight: 600; color: #2d3748; border-right: 1px solid #e2e8f0; font-size: 14px;">${names.en}</td>
                        <td style="padding: 10px; text-align: center; color: #4a5568; border-right: 1px solid #e2e8f0;">${max}</td>
                        <td style="${markCellStyle}">${obtStr}</td>
                        <td style="padding: 10px; text-align: right; font-family: 'Jameel Noori Nastaleeq', serif; font-size: 18px; color: #2d3748;">${names.ur}</td> 
                    </tr>
                `;
            });

            // Status Logic
            const subKeys = Object.keys(std.marks);
            const isFullAbsent = subKeys.length > 0 && subKeys.every(k => std.marks[k] === 'A');
            let statusColor = '#38a169'; let statusText = 'PASS'; let finalGrade = std.grade;

            if (isFullAbsent) { statusColor = '#718096'; statusText = 'ABSENT'; finalGrade = 'Absent'; } 
            else if (failedSubjectsCount > 2) { statusColor = '#e53e3e'; statusText = 'FAIL'; finalGrade = 'Nakam'; } 
            else if (std.grade.includes('Nakam') || std.grade === 'Fail') { statusColor = '#e53e3e'; statusText = 'FAIL'; }

            const nameFontSize = getNameFontSize(std.name);

            // HTML Template 
            container.innerHTML = `
                <div id="rc-template-${i}" style="width: 794px; height: 1123px; padding: 30px; background-color: #fff; font-family: 'Poppins', sans-serif; position: relative;">
                    <div style="border: 4px double #0f766e; height: 100%; padding: 5px; box-sizing: border-box; position: relative;">
                        <div style="border: 1px solid #d4af37; height: 100%; padding: 20px; box-sizing: border-box; background: linear-gradient(to bottom, #ffffff, #fafdff);">
                            
                            <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                                <h1 style="color: #2c5282; font-weight: 900; font-size: 42px; margin: 0; letter-spacing: 2px; text-transform: uppercase;">MONTHLY TEST RESULT</h1>
                                <h2 style="color: #0f766e; font-weight: 700; font-size: 28px; margin: 5px 0 10px 0; text-transform: uppercase;">JAMIA TUL MADINA INDIA</h2>
                                <div style="margin-top: 5px;">
                                    <span style="color: #d69e2e; font-weight: 800; font-size: 24px; text-transform: uppercase;">MONTH: </span>
                                    <span style="color: #000000; font-weight: 800; font-size: 24px;">${displayMonth}</span>
                                    <span style="color: #cbd5e0; margin: 0 10px;">|</span>
                                    <span style="color: #0f766e; font-weight: 800; font-size: 24px; text-transform: uppercase;">${displaySemester}</span>
                                </div>
                            </div>

                            <div style="display: flex; justify-content: space-between; margin-bottom: 25px; background-color: #f0fdfa; border: 1px solid #b2f5ea; border-radius: 10px; padding: 15px 20px;">
                                <div style="width: 60%;">
                                    <p style="margin: 0; font-size: 12px; color: #555; text-transform: uppercase;">Student Name</p>
                                    <h2 style="margin: 5px 0; font-family: 'Jameel Noori Nastaleeq', serif; font-size: ${nameFontSize}; color: #2d3748; white-space: nowrap; overflow: visible;">${std.name}</h2>
                                    <div style="margin-top: 10px;">
                                        <span style="font-size: 12px; color: #555; text-transform: uppercase;">Class: </span>
                                        <span style="font-size: 18px; font-weight: 700; color: #2c5282;">${englishClassName}</span>
                                    </div>
                                </div>
                                <div style="width: 35%; text-align: right; border-left: 2px dashed #cbd5e0; padding-left: 20px;">
                                    <div style="margin-bottom: 10px;">
                                        <span style="font-size: 12px; color: #555; text-transform: uppercase;">Roll No: </span>
                                        <span style="font-size: 20px; font-weight: 700;">${std.index}</span>
                                    </div>
                                    <div>
                                        <span style="font-size: 12px; color: #555; text-transform: uppercase;">Branch: </span>
                                        <span style="font-family: 'Jameel Noori Nastaleeq', serif; font-size: 18px; font-weight: 600;">${jamiaName}</span>
                                    </div>
                                </div>
                            </div>

                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                                <thead style="background-color: #0f766e; color: #ffffff;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-right: 1px solid #1ba193; width: 40%;">Subjects</th>
                                        <th style="padding: 12px; text-align: center; border-right: 1px solid #1ba193;">Total</th>
                                        <th style="padding: 12px; text-align: center; border-right: 1px solid #1ba193;">Obtained</th>
                                        <th style="padding: 12px; text-align: right; font-family: 'Jameel Noori Nastaleeq'; font-size: 18px; width: 30%;">Ù…Ø¶Ù…ÙˆÙ†</th>
                                    </tr>
                                </thead>
                                <tbody style="background-color: #fff;">${rowsHTML}</tbody>
                            </table>

                            <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                                <div style="flex: 1; border: 2px solid #d4af37; border-radius: 12px; padding: 15px; background: #fffdf0;">
                                    <table style="width: 100%;">
                                        <tr><td style="color: #555; font-size: 14px;">Total Marks:</td><td style="text-align: right; font-weight: bold; font-size: 16px;">${grandTotalMax}</td></tr>
                                        <tr><td style="color: #555; font-size: 14px;">Obtained:</td><td style="text-align: right; font-weight: bold; color: #2b6cb0; font-size: 16px;">${std.obtained}</td></tr>
                                        <tr><td style="color: #555; font-size: 14px;">Percentage:</td><td style="text-align: right; font-weight: bold; color: #2b6cb0; font-size: 16px;">${std.percentage.toFixed(2)}%</td></tr>
                                    </table>
                                </div>
                                <div style="flex: 1; display: flex; flex-col; align-items: center; justify-content: center; background-color: ${statusColor}; color: white; border-radius: 12px;">
                                    <div style="text-align: center;">
                                        <p style="margin: 0; font-size: 12px; opacity: 0.9; letter-spacing: 2px;">RESULT</p>
                                        <h1 style="margin: 0; font-size: 32px; font-weight: 800; letter-spacing: 1px;">${statusText}</h1>
                                    </div>
                                </div>
                                <div style="flex: 1; border: 2px solid #0f766e; border-radius: 12px; padding: 15px; background: #f0fdfa;">
                                    <table style="width: 100%;">
                                        <tr><td style="color: #0f766e; font-weight: bold; font-size: 14px;">Grade:</td><td style="text-align: right; font-weight: 800; font-size: 18px;">${finalGrade}</td></tr>
                                        <tr><td style="color: #0f766e; font-weight: bold; font-size: 14px;">Class Rank:</td><td style="text-align: right; font-weight: 800; font-size: 24px; color: #d69e2e;">#${std.rank}</td></tr>
                                    </table>
                                </div>
                            </div>

                            <div style="position: absolute; bottom: 80px; width: 100%; padding: 0 80px; box-sizing: border-box; display: flex; justify-content: space-between; left: 0;">
                                <div style="text-align: center; width: 200px; position: relative;">
                                    <div style="height: 80px; display: flex; align-items: end; justify-content: center; margin-bottom: 5px;">
                                        ${ principalSigUrl ? `<img src="${principalSigUrl}" style="max-height: 75px; max-width: 180px; object-fit: contain;" crossorigin="anonymous">` : '' }
                                    </div>
                                    <div style="width: 100%; border-bottom: 2px solid #333; margin-bottom: 5px;"></div>
                                    <p style="margin: 0; font-weight: 600; color: #555; font-size: 16px;">Principal Signature</p>
                                </div>

                                <div style="text-align: center; width: 200px; position: relative;">
                                    <div style="height: 80px; display: flex; align-items: end; justify-content: center; margin-bottom: 5px;">
                                        ${ taleemiSigUrl ? `<img src="${taleemiSigUrl}" style="max-height: 75px; max-width: 180px; object-fit: contain;" crossorigin="anonymous">` : '' }
                                    </div>
                                    <div style="width: 100%; border-bottom: 2px solid #333; margin-bottom: 5px;"></div>
                                    <p style="margin: 0; font-weight: 600; color: #555; font-size: 16px;">Taleemi Zimmedar</p>
                                    <p style="margin: 0; font-size: 12px; color: #555;">(Signature)</p>
                                </div>
                            </div>

                            <div style="position: absolute; bottom: 25px; width: 100%; text-align: center; left: 0;">
                                <p style="margin: 0; font-size: 14px; color: #0f766e; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;">MAJLIS TALIMI UMOOR INDIA</p>
                            </div>

                        </div>
                    </div>
                </div>
            `;
            await new Promise(resolve => setTimeout(resolve, 50));
            const element = document.getElementById(`rc-template-${i}`);
            if (i > 0) pdf.addPage();
            
            const canvas = await html2canvas(element, { scale: 1.5, useCORS: true, allowTaint: true, backgroundColor: "#ffffff" });
            const imgData = canvas.toDataURL('image/jpeg', 0.8);
            pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);
        }

        container.innerHTML = ''; container.style.left = '-9999px';
        pdf.save(`Report_Cards_${jamiaName}_${monthKey}.pdf`);

    } catch (e) {
        console.error(e); alert("Error: " + e.message);
    } finally {
        btn.innerHTML = originalText; btn.disabled = false;
    }
};
        // --- FIX: ENABLE EDIT MODE SHOWS INPUTS ---
window.enableEditMode = (skipAlert = false) => {
    // Flag Set
    if(typeof isEditingMode !== 'undefined') isEditingMode = true;

    // UI Updates
    const badge = document.getElementById('view-badge');
    const btn = document.getElementById('edit-mode-btn');
    if(badge) { badge.textContent = "Editing Mode"; badge.className = "text-xl bg-red-200 text-red-800 px-2 py-1 rounded ml-2 align-middle"; }
    if(btn) btn.style.display = 'none';

    // Selection Area Show
    const selectionArea = document.getElementById('subject-selection-area');
    selectionArea.classList.remove('hidden');

    // Input Visibility Fix
    document.querySelectorAll('.subject-checkbox').forEach(chk => {
        const wrapper = chk.closest('div');
        const input = wrapper.querySelector('.eng-name-input');
        if (chk.checked && input) {
            input.classList.remove('hidden'); 
        }
    });

    // Custom Subject Box Logic
    if (!document.getElementById('custom-sub-box')) {
        const customDiv = document.createElement('div');
        customDiv.id = 'custom-sub-box';
        customDiv.className = "mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg";
        customDiv.innerHTML = `
            <label class="block text-sm font-bold text-indigo-700 mb-2">
                <i class="fas fa-plus-circle"></i> Custom Subject:
            </label>
            <div class="flex gap-2">
                <input type="text" id="custom-sub-input" placeholder="Subject name..." class="border border-indigo-300 p-2 rounded w-full outline-none">
                <button onclick="addCustomSubject()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 whitespace-nowrap">Add</button>
            </div>`;
        const updateBtn = selectionArea.querySelector('button'); 
        if(updateBtn) selectionArea.insertBefore(customDiv, updateBtn);
        else selectionArea.appendChild(customDiv);
    }

    // Button Update
    const generateBtn = Array.from(selectionArea.querySelectorAll('button')).find(b => b.innerText.includes('Result Sheet') || b.getAttribute('onclick') === 'generateSheet()');
    if(generateBtn) {
        generateBtn.innerText = "Update Subjects & Columns";
        generateBtn.onclick = updateSheetColumns; 
        generateBtn.classList.remove('bg-teal-600');
        generateBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
    }

    // Unlock Inputs
    document.querySelectorAll('.view-mode-input').forEach(inp => {
        inp.disabled = false;
        inp.style.backgroundColor = ''; 
        inp.style.border = '';
        inp.classList.remove('view-mode-input');
    });

    // Show Hidden Buttons
    document.querySelectorAll('.hidden-in-view').forEach(b => {
        b.style.display = 'inline-block';
        b.classList.remove('hidden-in-view');
    });
    
    document.querySelectorAll('.no-print').forEach(btn => btn.style.display = '');
    const headerTrash = document.querySelector('#table-head th:last-child');
    if(headerTrash) headerTrash.style.display = '';

    if (!skipAlert) alert("Editing Enabled!");
};

// --- UPDATE COLUMNS & AUTO SAVE ---
window.updateSheetColumns = async () => {
    // Check Limit
    const checkedBoxes = document.querySelectorAll('.subject-checkbox:checked');
    if (document.querySelectorAll('.subject-checkbox').length > 0 && checkedBoxes.length > 3) {
        alert("Maximum 3 subjects select kar sakte hain."); return;
    }
    
    // 1. Screen par jo data hai use save karo (agar koi student pehle se hai)
    const currentRows = document.querySelectorAll('#students-body tr');
    currentSheetData = []; 
    currentRows.forEach(row => {
        const name = row.querySelector('.std-name').value.trim();
        if(!name) return;
        const marks = {};
        row.querySelectorAll('.mark-input').forEach(inp => {
            const val = inp.value.trim().toUpperCase();
            marks[inp.dataset.sub] = val;
        });
        currentSheetData.push({ name, marks });
    });

    // 2. Naye Columns Set Karo
    const selected3 = Array.from(checkedBoxes).map(cb => cb.value);
    finalSubjectsList = [...selected3];
    if (document.getElementById('include-english')?.checked) finalSubjectsList.push('English');
    if (document.getElementById('include-maths')?.checked) finalSubjectsList.push('Maths');

    // 3. Max Marks Update
    totalMax = 0;
    finalSubjectsList.forEach(sub => {
        if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') totalMax += 25; else totalMax += 100;
    });

    // 4. Re-render Table
    renderTableHeaders();
    const tbody = document.getElementById('students-body');
    tbody.innerHTML = '';
    
    // 5. Purana Data Wapas Bharein
    if (currentSheetData.length > 0) {
        currentSheetData.forEach((std, index) => {
            addStudentRow(std.name, std.marks);
        });
    } else {
        // Agar koi student nahi hai, to table khali rahegi bas header ban jayenge
    }

    // ðŸ”¥ AUTO SAVE Trigger (Ye naya hai)
    // Ye bina student ke bhi subjects ko database me save kar dega
    await saveResult(true); 

    alert("Subjects/Columns Update aur Save ho gaye hain!");
};

// --- CUSTOM SUBJECT ADD ---
window.addCustomSubject = () => {
    const input = document.getElementById('custom-sub-input');
    const name = input.value.trim();
    if (!name) { alert("Subject ka naam likhein."); return; }

    // Check Duplicate
    let exists = false;
    document.querySelectorAll('.subject-checkbox').forEach(chk => {
        if (chk.value.toLowerCase() === name.toLowerCase()) {
            exists = true; chk.checked = true;
            alert("Ye subject pehle se list me hai.");
        }
    });
    if (exists) return;

    // Check Limit
    if (document.querySelectorAll('.subject-checkbox:checked').length >= 3) {
        alert("3 subjects limit puri ho gayi. Pehle koi uncheck karein."); return;
    }

    // Add Checkbox
    const container = document.getElementById('checkbox-container');
    const label = document.createElement('label');
    label.className = "cursor-pointer block";
    label.innerHTML = `
        <input type="checkbox" value="${name}" class="subject-checkbox hidden" checked onchange="checkLimit(this)">
        <div class="border p-2 rounded text-center hover:bg-teal-50 transition urdu-font select-none bg-white shadow-sm border-teal-500 text-teal-700 font-bold relative">
            ${name} <span class="absolute top-0 right-1 text-xs text-orange-500">New</span>
        </div>`;
    container.appendChild(label);
    input.value = "";
};
    </script>
</body>
</html>













































