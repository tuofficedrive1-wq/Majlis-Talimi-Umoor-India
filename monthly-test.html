<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Test Sheet (Teacher View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2'); font-display: swap; }
        body { font-family: 'Poppins', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .mark-input { text-align: center; }
        .pass-bg { background-color: #dcfce7; color: #166534; }
        .fail-bg { background-color: #fee2e2; color: #991b1b; }
        /* Checkbox Style */
        .subject-checkbox:checked + div { background-color: #0d9488; color: white; border-color: #0d9488; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg" id="display-month">...</p>
            <p class="text-xs text-teal-300 mt-2">Teacher/Principal Portal</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Step 1: Class & Subjects Select Karein</h3>
                
                <div class="mb-4">
                    <label class="block text-gray-600 font-semibold mb-1">Class:</label>
                    <select id="class-select" onchange="handleClassChange()" class="w-full md:w-1/3 p-3 border rounded-lg urdu-font text-lg shadow-sm focus:ring-2 focus:ring-teal-500 bg-white">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>

                <div id="subject-selection-area" class="hidden">
                    <p class="text-sm text-gray-500 mb-2">Is Class ki kitabon me se koi <strong>3 Kitabein</strong> select karein:</p>
                    
                    <div id="checkbox-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        </div>

                    <div class="bg-blue-50 p-3 rounded border border-blue-200 mb-4 text-sm text-blue-800 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        Note: <strong>English</strong> aur <strong>Maths</strong> automatically shamil rahenge.
                    </div>

                    <button onclick="generateSheet()" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition w-full md:w-auto">
                        Result Sheet Banayein (5 Subjects)
                    </button>
                </div>
            </div>

            <div id="result-area" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 border-b-2 border-teal-500 pb-1">Result Sheet</h2>
                    <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>

                <div class="overflow-x-auto border rounded-lg shadow-sm" id="print-area">
                     <div class="hidden print-header text-center mb-4 pt-4">
                        <h2 class="text-2xl font-bold urdu-font" id="pdf-jamia"></h2>
                        <p id="pdf-month"></p>
                    </div>

                    <table class="w-full text-sm text-left bg-white">
                        <thead class="bg-teal-50 text-teal-900 uppercase font-bold" id="table-head">
                            </thead>
                        <tbody id="students-body" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                    <button onclick="saveResult()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Save Result Sheet
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State Variables
        let adminUid = "";
        let jamiaName = "";
        let monthKey = "";
        let globalStructure = []; // To store full structure
        let finalSubjectsList = []; // Final 5 subjects

        // 1. Initialize
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Invalid Link.");
                return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Month: ${monthKey}`;
            document.getElementById('pdf-jamia').textContent = jamiaName;
            document.getElementById('pdf-month').textContent = monthKey;

            await loadAdminData();
            // Hum existing result abhi load nahi karenge jab tak class select na ho jaye
        };

        // 2. Load Admin Data
        async function loadAdminData() {
            try {
                const userDoc = await getDoc(doc(db, "users", adminUid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    // Store structure globally
                    globalStructure = data.academicStructure || data.structure || [];
                    
                    // Filter for this Jamia
                    const jamiaData = globalStructure.find(j => j.jamiaName === jamiaName);
                    
                    if (jamiaData && jamiaData.classes) {
                        const select = document.getElementById('class-select');
                        let classes = [];
                        if (Array.isArray(jamiaData.classes)) {
                            classes = jamiaData.classes; 
                        } else if (typeof jamiaData.classes === 'object') {
                            classes = Object.keys(jamiaData.classes);
                        }

                        classes.forEach(cls => {
                            const clsName = (typeof cls === 'object') ? cls.className : cls;
                            const opt = document.createElement('option');
                            opt.value = clsName;
                            opt.textContent = clsName;
                            select.appendChild(opt);
                        });
                    }
                }
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } catch (error) {
                console.error("Error:", error);
                alert("Data load error.");
            }
        }

        // 3. Handle Class Selection
        window.handleClassChange = () => {
            const clsName = document.getElementById('class-select').value;
            const container = document.getElementById('checkbox-container');
            const selectionArea = document.getElementById('subject-selection-area');
            const resultArea = document.getElementById('result-area');
            
            container.innerHTML = '';
            resultArea.classList.add('hidden'); // Hide table until generated

            if (!clsName) {
                selectionArea.classList.add('hidden');
                return;
            }

            // Find Subjects for selected class
            const jamiaData = globalStructure.find(j => j.jamiaName === jamiaName);
            let rawSubjects = [];

            if (jamiaData && jamiaData.classes) {
                // Determine structure type (Array vs Object)
                if (Array.isArray(jamiaData.classes)) {
                    const clsObj = jamiaData.classes.find(c => c.className === clsName);
                    if (clsObj && clsObj.kitabs) rawSubjects = clsObj.kitabs;
                } else {
                    // Object structure
                    const clsObj = jamiaData.classes[clsName];
                    if (clsObj && clsObj.kitabs) rawSubjects = clsObj.kitabs;
                }
            }

            // Agar subjects nahi milein
            if (rawSubjects.length === 0) {
                alert("Is class ke liye koi kitabein set nahi hain. Admin se contact karein.");
                return;
            }

            // Filter out 'English' and 'Maths' from raw list (taake duplicate na ho)
            const filteredSubjects = rawSubjects.filter(s => s.toLowerCase() !== 'english' && s.toLowerCase() !== 'maths' && s.toLowerCase() !== 'math');

            // Render Checkboxes
            filteredSubjects.forEach((sub, index) => {
                const label = document.createElement('label');
                label.className = "cursor-pointer block";
                label.innerHTML = `
                    <input type="checkbox" value="${sub}" class="subject-checkbox hidden" onchange="checkLimit(this)">
                    <div class="border p-2 rounded text-center hover:bg-teal-50 transition urdu-font select-none">
                        ${sub}
                    </div>
                `;
                container.appendChild(label);
            });

            selectionArea.classList.remove('hidden');
            
            // Check if result already exists for this class
            checkExistingForClass(clsName);
        };

        // 3.1 Limit Selection to 3
        window.checkLimit = (elem) => {
            const checked = document.querySelectorAll('.subject-checkbox:checked');
            if (checked.length > 3) {
                elem.checked = false;
                alert("Sirf 3 kitabein select kar sakte hain.");
            }
        };

        // 4. Generate Table
        window.generateSheet = () => {
            const checkedBoxes = document.querySelectorAll('.subject-checkbox:checked');
            if (checkedBoxes.length !== 3) {
                alert(`Apne ${checkedBoxes.length} kitabein select ki hain. Barae karam poori 3 select karein.`);
                return;
            }

            // Final List: [Selected 3] + English + Maths
            const selected3 = Array.from(checkedBoxes).map(cb => cb.value);
            finalSubjectsList = [...selected3, "English", "Maths"];

            renderTableHeaders();
            document.getElementById('result-area').classList.remove('hidden');
        };

        function renderTableHeaders() {
            const head = document.getElementById('table-head');
            let html = `<tr>
                <th class="px-4 py-3 border">#</th>
                <th class="px-4 py-3 border w-1/4">Name</th>`;
            
            finalSubjectsList.forEach(sub => {
                html += `<th class="px-4 py-3 border text-center">${sub} <br><span class="text-xs font-normal">/100</span></th>`;
            });

            html += `
                <th class="px-4 py-3 border text-center bg-gray-100">Total</th>
                <th class="px-4 py-3 border text-center bg-gray-100">%</th>
                <th class="px-4 py-3 border text-center bg-gray-100">Grade</th>
                <th class="px-2 py-3 border text-center text-red-500"><i class="fas fa-trash"></i></th>
            </tr>`;
            head.innerHTML = html;
        }

        // 5. Add/Calc Rows (Same as before)
        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";

            let inputs = "";
            finalSubjectsList.forEach(sub => {
                const val = marks[sub] || "";
                inputs += `<td class="border p-1"><input type="number" data-sub="${sub}" value="${val}" class="w-full p-2 text-center outline-none mark-input focus:bg-blue-50" oninput="calcRow(this)"></td>`;
            });

            tr.innerHTML = `
                <td class="border p-2 text-center text-gray-500">${index}</td>
                <td class="border p-1"><input type="text" value="${name}" placeholder="Student Name" class="w-full p-2 font-semibold urdu-font outline-none std-name"></td>
                ${inputs}
                <td class="border p-2 text-center font-bold text-gray-700 total-val">0</td>
                <td class="border p-2 text-center font-bold text-blue-600 perc-val">0%</td>
                <td class="border p-2 text-center font-bold grade-val">-</td>
                <td class="border p-2 text-center cursor-pointer text-red-400 hover:text-red-600" onclick="this.parentElement.remove()">Ã—</td>
            `;
            tbody.appendChild(tr);
            if(name) calcRow(tr.querySelector('input'));
        };

        window.calcRow = (el) => {
            const row = el.closest('tr');
            let obtained = 0;
            const inputs = row.querySelectorAll('.mark-input');
            inputs.forEach(inp => obtained += Number(inp.value));
            
            const totalMax = finalSubjectsList.length * 100; // 500
            const percent = totalMax > 0 ? (obtained / totalMax * 100).toFixed(1) : 0;
            
            row.querySelector('.total-val').textContent = obtained;
            row.querySelector('.perc-val').textContent = percent + '%';
            
            let grade = "-";
            let cls = "";
            if (percent >= 80) { grade = "Mumtaz"; cls = "pass-bg"; }
            else if (percent >= 60) { grade = "Jayyid Jiddan"; cls = "text-green-600"; }
            else if (percent >= 50) { grade = "Jayyid"; cls = "text-yellow-600"; }
            else if (percent >= 40) { grade = "Maqbool"; cls = "text-orange-600"; }
            else { grade = "Rasib"; cls = "fail-bg"; }
            
            row.querySelector('.grade-val').textContent = grade;
            row.querySelector('.grade-val').className = `border p-2 text-center font-bold grade-val ${cls}`;
        };

        // 6. Save Logic (Supports Multiple Classes Logic: One Sheet per Jamia_Month_Class)
        window.saveResult = async () => {
            const rows = document.querySelectorAll('#students-body tr');
            if(rows.length === 0) { alert("Koi student add nahi kiya gaya."); return; }
            
            const selectedClass = document.getElementById('class-select').value;

            const students = [];
            let grandObtained = 0;
            let grandMax = 0;

            rows.forEach(row => {
                const name = row.querySelector('.std-name').value.trim();
                if(!name) return;
                const marks = {};
                row.querySelectorAll('.mark-input').forEach(inp => marks[inp.dataset.sub] = Number(inp.value));
                const total = Number(row.querySelector('.total-val').textContent);
                const perc = parseFloat(row.querySelector('.perc-val').textContent);
                students.push({ name, marks, total, percentage: perc });
                grandObtained += total;
                grandMax += (finalSubjectsList.length * 100);
            });

            // This calculates AVERAGE of this CLASS
            const overallPerc = grandMax > 0 ? ((grandObtained / grandMax) * 100).toFixed(1) + '%' : '0%';
            
            // Unique ID for this specific Class Sheet
            // Format: UID_Jamia_Month_Class (taake har class ka alag save ho)
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${selectedClass.replace(/\s/g, '_')}`;

            try {
                // 1. Save Specific Class Sheet
                await setDoc(doc(db, "monthly_test_sheets", docId), {
                    adminUid,
                    jamiaName,
                    month: monthKey,
                    class: selectedClass,
                    subjects: finalSubjectsList,
                    students,
                    updatedAt: serverTimestamp()
                });

                // 2. Update Admin Dashboard (Overall Jamia Status)
                // Note: Is logic me hum "Last updated" class ka percentage bhej rahe hain.
                // Ideal way: Sab classes ka average. But wo complex hai bina backend ke.
                // Abhi ke liye hum ise "Test Hua" mark kar rahe hain.
                
                const [yStr, mStr] = monthKey.split('-');
                const y = parseInt(yStr);
                const m = parseInt(mStr) - 1;
                const acYear = (m >= 3) ? `${y}-${y + 1}` : `${y - 1}-${y}`;
                const reportId = `${adminUid}_${acYear}_${y}_${m}`;

                const reportRef = doc(db, 'monthly_reports', reportId);
                const reportSnap = await getDoc(reportRef);
                
                let testData = reportSnap.exists() ? (reportSnap.data().monthlyTest?.data || []) : [];
                testData = testData.filter(t => t.name !== jamiaName);
                
                testData.push({
                    name: jamiaName,
                    status: 'Test Hua',
                    month: monthKey,
                    percentage: overallPerc, // Ye sirf is current class ka hoga dashboard par
                    wajah: ''
                });

                await setDoc(reportRef, {
                    monthlyTest: { status: 'Done', data: testData }
                }, { merge: true });

                alert(`Class ${selectedClass} ka Result Save ho gaya!`);
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error: " + error.message);
            }
        };

        // 7. Auto Load if data exists for selected class
        async function checkExistingForClass(clsName) {
             const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${clsName.replace(/\s/g, '_')}`;
             try {
                const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
                if (snap.exists()) {
                    const data = snap.data();
                    // Restore checkboxes
                    const allChecks = document.querySelectorAll('.subject-checkbox');
                    
                    // Identify the 3 variable subjects (exclude Eng/Math)
                    const savedVariableSubjects = data.subjects.filter(s => s !== 'English' && s !== 'Maths');
                    
                    allChecks.forEach(chk => {
                        if (savedVariableSubjects.includes(chk.value)) chk.checked = true;
                    });
                    
                    // Trigger Generate
                    finalSubjectsList = data.subjects;
                    renderTableHeaders();
                    document.getElementById('result-area').classList.remove('hidden');
                    
                    // Load Rows
                    document.getElementById('students-body').innerHTML = '';
                    data.students.forEach(s => addStudentRow(s.name, s.marks));
                    
                    alert(`Class ${clsName} ka purana saved data load kiya gaya hai.`);
                }
             } catch(e) { console.log("New sheet"); }
        }

        // PDF Generator
        window.downloadPDF = async () => {
            const el = document.getElementById('print-area');
            const hiddenHeader = el.querySelector('.print-header');
            const cls = document.getElementById('class-select').value;
            hiddenHeader.classList.remove('hidden');
            hiddenHeader.innerHTML += `<p class="text-sm">Class: ${cls}</p>`;
            
            const canvas = await html2canvas(el, { scale: 2 });
            const img = canvas.toDataURL('image/png');
            
            hiddenHeader.classList.add('hidden');

            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            const props = pdf.getImageProperties(img);
            const w = pdf.internal.pageSize.getWidth();
            const h = (props.height * w) / props.width;
            pdf.addImage(img, 'PNG', 0, 0, w, h);
            pdf.save(`Result_${jamiaName}_${cls}.pdf`);
        };
    </script>
</body>
</html>
