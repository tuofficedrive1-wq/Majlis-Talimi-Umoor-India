<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Test Sheet (Teacher View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="jameel-font.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/sajjadsaeed/UrduFontsWeb@master/fonts/JameelNooriNastaleeq.woff2') format('woff2'); font-display: swap; }
        body { font-family: 'Poppins', 'Jameel Noori Nastaleeq', sans-serif; background-color: #f0fdfa; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', serif; line-height: 1.6; }
        .mark-input { text-align: center; }

        /* ===== PDF FIX CSS (YAHAN ADD KARO) ===== */
    .pdf-mode table {
        width: 100% !important;
        table-layout: fixed !important;
    }

    /* ===== PDF MODE (FONT BALANCE FIX) ===== */
.pdf-mode table {
  width: 100% !important;
  table-layout: fixed !important;
}

.pdf-mode th,
.pdf-mode td {
  word-wrap: break-word;
  white-space: normal !important;

  /* ðŸ”´ font chhota NA ho */
  font-size: 12px !important;

  /* ðŸ”´ padding kam, taake width fit ho */
  padding: 4px 3px !important;
}

.pdf-mode .urdu-font {
  font-size: 13px !important;
}
        
        /* Grades Colors */
        .grade-mumtaz-sharf { background-color: #15803d; color: white; } /* Green Dark */
        .grade-mumtaz { background-color: #22c55e; color: white; } /* Green */
        .grade-jayyid { background-color: #eab308; color: white; } /* Yellow/Gold */
        .grade-maqbul { background-color: #f97316; color: white; } /* Orange */
        .grade-nakam { background-color: #ef4444; color: white; } /* Red */

        /* Input Validation Colors */
        .bg-fail-input { background-color: #fee2e2 !important; color: #991b1b; font-weight: bold; }
        
        .subject-checkbox:checked + div { background-color: #0d9488; color: white; border-color: #0d9488; }
            </style>
</head>
<body class="p-4">

    

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden border border-teal-100">
        
        <div class="bg-teal-800 text-white p-6 text-center relative">
            <h1 class="text-3xl font-bold urdu-font mb-2" id="display-jamia">Loading...</h1>
            <p class="text-teal-200 text-lg" id="display-month">...</p>
            <p class="text-xs text-teal-300 mt-2">Teacher/Principal Portal</p>
        </div>

        <div id="loader" class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i> Loading data...</div>

        <div id="main-content" class="p-6 hidden">
            
            <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h3 id="step-heading" class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Step 1: Class & Subjects Select Karein</h3>
                
                <div class="mb-4">
                    <label class="block text-gray-600 font-semibold mb-1">Class:</label>
                    <div id="class-tabs"
     class="flex flex-wrap gap-2 bg-gray-100 p-3 rounded-lg border">
</div>
                  <select id="class-select" class="hidden">
    <option value="">-- Select Class --</option>
</select>

<div id="class-tabs" class="flex flex-wrap gap-2 mt-4"></div>

<p id="step-instruction" class="text-xs text-gray-500 mt-1">
    Ek class save karne ke baad dusri select karein.
</p>

                <div id="subject-selection-area" class="hidden">
                    <p class="text-sm text-gray-500 mb-2">Is Class ki kitabon me se koi <strong>3 Kitabein</strong> select karein:</p>
                    <div class="flex gap-4 mb-4">
  <label class="flex items-center gap-2 cursor-pointer">
    <input type="checkbox" id="include-english" checked>
    <span class="font-semibold">English</span>
  </label>

  <label class="flex items-center gap-2 cursor-pointer">
    <input type="checkbox" id="include-maths" checked>
    <span class="font-semibold">Maths</span>
  </label>
</div>
                    
                    <div id="checkbox-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        </div>

                    <div class="bg-blue-50 p-3 rounded border border-blue-200 mb-4 text-sm text-blue-800 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        Note: <strong>English (25)</strong> aur <strong>Maths (25)</strong> automatically shamil rahenge. Baqi 100 number ke honge.
                    </div>

                    <button onclick="generateSheet()" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition w-full md:w-auto">
                        Result Sheet Banayein (Total 350)
                    </button>
                </div>
            </div>

            <div id="result-area" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 border-b-2 border-teal-500 pb-1">Result Sheet</h2>
                    <button onclick="addStudentRow()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>

                <div class="overflow-x-auto border rounded-lg shadow-sm" id="print-area">
                     <div class="hidden print-header text-center mb-4 pt-4">
                        <h2 class="text-2xl font-bold urdu-font" id="pdf-jamia"></h2>
                        <p id="pdf-month"></p>
                    </div>

                    <table class="w-full text-sm text-left bg-white border-collapse">
                        <thead class="bg-teal-50 text-teal-900 uppercase font-bold" id="table-head">
                            </thead>
                        <tbody id="students-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-end border-t pt-6">
                    <button onclick="saveResult()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Save Result Sheet
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                    <button id="download-all-btn" onclick="downloadAllClassesPDF()" class="bg-purple-700 hover:bg-purple-800 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2">
    <i class="fas fa-layer-group"></i> Download ALL Classes
</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0",
            authDomain: "data-f15ab.firebaseapp.com",
            projectId: "data-f15ab",
            storageBucket: "data-f15ab.appspot.com",
            messagingSenderId: "449137002393",
            appId: "1:449137002393:web:6a23721d00b1b0daeb3508"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let adminUid = "";
        let jamiaName = "";
        let monthKey = "";
        let finalSubjectsList = []; 
        let totalMax = 350; // default
        let classBooksMap = {}; 
        let selectedClassName = '';
        let activeClass = null;


        // 1. Initialize
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            adminUid = params.get('uid');
            jamiaName = params.get('jamia');
            monthKey = params.get('month');

            if (!adminUid || !jamiaName || !monthKey) {
                alert("Invalid Link."); return;
            }

            document.getElementById('display-jamia').textContent = jamiaName;
            document.getElementById('display-month').textContent = `Month: ${monthKey}`;
            document.getElementById('pdf-jamia').textContent = jamiaName;
            document.getElementById('pdf-month').textContent = monthKey;

            await loadTeachingData();
        };

        function getAcademicYear(key) {
            if (!key) return null;
            const [yStr, mStr] = key.split("-");
            const yearNum  = parseInt(yStr);
            const monthNum = parseInt(mStr) - 1; 
            return monthNum >= 3 ? `${yearNum}-${yearNum+1}` : `${yearNum-1}-${yearNum}`;
        }

        // 2. Load Teaching Data
async function loadTeachingData() {
    try {
        const acYear = getAcademicYear(monthKey);
        const userDoc = await getDoc(doc(db, "users", adminUid));

        if (!userDoc.exists()) {
            alert("User data nahi mila");
            return;
        }

        const userData = userDoc.data();
        const years = userData.academicYears || {};
        const yearData = years[acYear];
        let jamiaStruct = null;

        if (yearData && Array.isArray(yearData.karkardagiStructure)) {
            jamiaStruct = yearData.karkardagiStructure.find(
                j => j.jamiaName === jamiaName
            );
        }

        if (!jamiaStruct && Array.isArray(userData.academicStructure)) {
            jamiaStruct = userData.academicStructure.find(
                j => j.jamiaName === jamiaName
            );
        }

        if (!jamiaStruct) {
            alert("Setup nahi mila. Admin se rabta karein.");
            return;
        }

        // ===============================
        // Class â†’ Books mapping
        // ===============================
        classBooksMap = {};

        if (Array.isArray(jamiaStruct.teachers)) {
            jamiaStruct.teachers.forEach(t => {
                if (Array.isArray(t.periods)) {
                    t.periods.forEach(p => {
                        const cName = p.className || p.class || p.darja;
                        const bName = p.bookName || p.book || p.kitab || p.subject;

                        if (cName && bName) {
                            if (!classBooksMap[cName]) {
                                classBooksMap[cName] = new Set();
                            }
                            classBooksMap[cName].add(bName);
                        }
                    });
                }
            });
        }

        // ===============================
        // âœ… EXCEL STYLE CLASS TABS
        // ===============================
        const tabs = document.getElementById('class-tabs');
        const select = document.getElementById('class-select');

        tabs.innerHTML = '';
        select.innerHTML = '<option value="">-- Select Class --</option>';

        // ðŸ”´ YAHI LINE MISSING THI
        const sortedClasses = Object.keys(classBooksMap).sort();

        sortedClasses.forEach(cls => {
            // hidden select option (JS compatibility)
            const opt = document.createElement('option');
            opt.value = cls;
            opt.textContent = cls;
            select.appendChild(opt);

            // Excel-style tab
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = cls;
            btn.dataset.class = cls;
            let baseClass =
  "px-4 py-2 rounded-lg border text-sm font-semibold transition";

if (cls === selectedClassName) {
  btn.className = baseClass + " bg-teal-600 text-white";
} else {
  btn.className = baseClass + " bg-white hover:bg-teal-600 hover:text-white";
}

           btn.onclick = () => {
    // sirf highlight toggle
    document.querySelectorAll('#class-tabs button').forEach(b => {
        b.classList.remove('bg-teal-600', 'text-white');
        b.classList.add('bg-white', 'text-gray-800');
    });

    btn.classList.remove('bg-white', 'text-gray-800');
    btn.classList.add('bg-teal-600', 'text-white');

    // value sync
    select.value = cls;

    handleClassChange();
};

            tabs.appendChild(btn);
        });

        // UI show
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

    } catch (error) {
        console.error("Error loading teaching data:", error);
    }
}

        // 3. Handle Class Change
        window.handleClassChange = () => {
            const clsName = document.getElementById('class-select').value;
            const container = document.getElementById('checkbox-container');
            const selectionArea = document.getElementById('subject-selection-area');
            const resultArea = document.getElementById('result-area');

            document.getElementById('class-select').disabled = false;
            
            container.innerHTML = '';
            resultArea.classList.add('hidden'); 

            if (!clsName) {
                selectionArea.classList.add('hidden');
                return;
            }

            // Yahan students-body ko bhi clear kar dena chahiye.
            document.getElementById('students-body').innerHTML = '';

            const rawSubjectsSet = classBooksMap[clsName];
            if (!rawSubjectsSet) return;
            
            const filteredSubjects = Array.from(rawSubjectsSet).filter(s => {
                const lower = s.toLowerCase();
                return lower !== 'english' && lower !== 'maths' && lower !== 'math' && lower !== 'mathematics';
            });

            filteredSubjects.forEach((sub) => {
                const label = document.createElement('label');
                label.className = "cursor-pointer block";
                label.innerHTML = `
                    <input type="checkbox" value="${sub}" class="subject-checkbox hidden" onchange="checkLimit(this)">
                    <div class="border p-2 rounded text-center hover:bg-teal-50 transition urdu-font select-none bg-white shadow-sm">
                        ${sub}
                    </div>
                `;
                container.appendChild(label);
            });

            selectionArea.classList.remove('hidden');
            checkExistingForClass(clsName);
        };

        window.checkLimit = (elem) => {
            const checked = document.querySelectorAll('.subject-checkbox:checked');
            if (checked.length > 3) {
                elem.checked = false;
                alert("Sirf 3 kitabein select kar sakte hain.");
            }
        };

        // 4. Generate Table
        window.generateSheet = () => {
    const checkedBoxes = document.querySelectorAll('.subject-checkbox:checked');

    if (
        document.querySelectorAll('.subject-checkbox').length > 0 &&
        checkedBoxes.length !== 3
    ) {
        if (!confirm(`Apne sirf ${checkedBoxes.length} kitabein select ki hain. Kya aap aage badhna chahte hain?`)) {
            return;
        }
    }

    const selected3 = Array.from(checkedBoxes).map(cb => cb.value);
    finalSubjectsList = [...selected3];

    // âœ… English / Maths optional
    if (document.getElementById('include-english')?.checked) {
        finalSubjectsList.push('English');
    }
    if (document.getElementById('include-maths')?.checked) {
        finalSubjectsList.push('Maths');
    }

    // âœ… TOTAL MAX CALCULATION (GLOBAL SET)
    totalMax = 0;
    finalSubjectsList.forEach(sub => {
        if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') {
            totalMax += 25;
        } else {
            totalMax += 100;
        }
    });

    renderTableHeaders();
    document.getElementById('result-area').classList.remove('hidden');
};

        function renderTableHeaders() {
            const head = document.getElementById('table-head');
            let html = `<tr>
                <th class="px-4 py-3 border border-gray-300 w-12">#</th>
                <th class="px-4 py-3 border border-gray-300 text-left w-1/4">Talib-e-Ilm</th>`;
            
            finalSubjectsList.forEach(sub => {
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                html += `<th class="px-4 py-3 border border-gray-300 text-center">${sub} <br><span class="text-xs font-normal text-gray-200">/${max}</span></th>`;
            });

            html += `
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Total (${totalMax})</th>
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">%</th>
                <th class="px-4 py-3 border border-gray-300 text-center bg-gray-100">Grade</th>
                <th class="px-2 py-3 border border-gray-300 text-center text-red-500 no-print"><i class="fas fa-trash"></i></th>
            </tr>`;
            head.innerHTML = html;
        }

        // 5. Add Student Row (Updated for 'A')
        window.addStudentRow = (name = "", marks = {}) => {
            const tbody = document.getElementById('students-body');
            const index = tbody.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50";

            let inputs = "";
            finalSubjectsList.forEach(sub => {
                const val = marks[sub] !== undefined ? marks[sub] : "";
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                
                // Input Type Text kar diya taake 'A' likh sakein
                inputs += `<td class="border border-gray-200 p-1">
                    <input type="text" data-sub="${sub}" data-max="${max}" value="${val}" 
                           class="w-full p-2 text-center outline-none mark-input focus:bg-blue-50" 
                           oninput="calcRow(this)" placeholder="-">
                </td>`;
            });

            tr.innerHTML = `
                <td class="border border-gray-200 p-2 text-center text-gray-500">${index}</td>
                <td class="border border-gray-200 p-1"><input type="text" value="${name}" placeholder="Naam likhein" class="w-full p-2 font-semibold urdu-font outline-none std-name"></td>
                ${inputs}
                <td class="border border-gray-200 p-2 text-center font-bold text-gray-700 total-val">0</td>
                <td class="border border-gray-200 p-2 text-center font-bold text-blue-600 perc-val">0%</td>
                <td class="border border-gray-200 p-2 text-center font-bold text-xs grade-val">-</td>
                <td class="border border-gray-200 p-2 text-center cursor-pointer text-red-400 hover:text-red-600 no-print" onclick="this.parentElement.remove()">Ã—</td>
            `;
            tbody.appendChild(tr);
            if(name) calcRow(tr.querySelector('input'));
        };

        // 6. Calculation Logic (Updated: Absent = Direct Fail)
window.calcRow = (el) => {
    const row = el.closest('tr');
    let obtained = 0;
    let hasAbsent = false; // ðŸ”´ Flag: Check karne ke liye ki student absent hai ya nahi
    
    const inputs = row.querySelectorAll('.mark-input');
    
    inputs.forEach(inp => {
        const max = parseInt(inp.dataset.max); 
        let rawVal = inp.value.trim().toUpperCase();
        
        // 1. Validation (Numbers or A)
        if (rawVal !== 'A' && rawVal !== '') {
            if (isNaN(parseFloat(rawVal)) || !isFinite(rawVal)) {
                inp.value = '';
                rawVal = '';
            }
        }

        // 2. Marks Calculation
        let numVal = 0;
        
        if (rawVal === 'A') {
            hasAbsent = true; // ðŸ”´ Agar 'A' mila, to flag ko TRUE kar do
            numVal = 0;
            inp.style.color = 'red';
            inp.classList.add('bg-fail-input');
        } else if (rawVal === '') {
            numVal = 0;
            inp.classList.remove('bg-fail-input');
            inp.style.color = '';
        } else {
            numVal = parseFloat(rawVal);
            
            if (numVal > max) {
                alert(`Maximum marks ${max} hain.`);
                inp.value = max;
                numVal = max;
            }

            // Passing Marks Logic (Fail Color check)
            const pass = max === 25 ? 10 : 40; 
            if (numVal < pass) {
                inp.classList.add('bg-fail-input');
            } else {
                inp.classList.remove('bg-fail-input');
                inp.style.color = '';
            }
        }
        
        obtained += numVal;
    });
    
    // Total Max Calculation
    let totalMax = 0;
    finalSubjectsList.forEach(sub => {
        if (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') {
            totalMax += 25;
        } else {
            totalMax += 100;
        }
    });

    const percent = totalMax > 0 ? (obtained / totalMax * 100).toFixed(1) : 0;
    
    row.querySelector('.total-val').textContent = obtained;
    row.querySelector('.perc-val').textContent = percent + '%';
    
    // Grade Logic
    let grade = "Nakam";
    let cls = "grade-nakam";
    const p = parseFloat(percent);

    if (p >= 80) { grade = "Mumtaz Ma Sharf"; cls = "grade-mumtaz-sharf"; }
    else if (p >= 70) { grade = "Mumtaz"; cls = "grade-mumtaz"; }
    else if (p >= 50) { grade = "Jayyid"; cls = "grade-jayyid"; }
    else if (p >= 40) { grade = "Maqbul"; cls = "grade-maqbul"; }
    else { grade = "Nakam"; cls = "grade-nakam"; }
    
    // ðŸ”´ FINAL CHECK: Agar ek subject me bhi 'A' hai, to result 'Nakam' kar do
    if (hasAbsent) {
        grade = "Nakam";
        cls = "grade-nakam";
    }
    
    const gVal = row.querySelector('.grade-val');
    gVal.textContent = grade;
    gVal.className = `border border-gray-200 p-2 text-center font-bold text-xs grade-val ${cls} rounded`;
};

        // 7. Save Logic
        window.saveResult = async () => {
            const rows = document.querySelectorAll('#students-body tr');
            if(rows.length === 0) { alert("Koi student add nahi kiya gaya."); return; }
            
            // FIX 1: Doc ID ko sirf ek baar define karein (Syntax Error theek kiya)
            const rawClass = document.getElementById('class-select').value;
            const cleanClass = rawClass.split('_')[0]; 
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`; 
            console.log("ðŸ’¾ Doc ID used for SAVE:", docId); // Debug Log
            
            const selectedClass = rawClass; // Poora class name Firestore mein save hoga

            const students = [];
            let grandObtained = 0;
            let grandMax = 0;

            rows.forEach(row => {
                const name = row.querySelector('.std-name').value.trim();
                if(!name) return;
                
                const marks = {};
                row.querySelectorAll('.mark-input').forEach(inp => {
                    // Save as String if 'A', else Number
                    const val = inp.value.trim().toUpperCase();
                    marks[inp.dataset.sub] = (val === 'A') ? 'A' : (val === '' ? 0 : parseFloat(val));
                });
                
                const total = parseFloat(row.querySelector('.total-val').textContent);
                const perc = parseFloat(row.querySelector('.perc-val').textContent);
                students.push({ name, marks, total, percentage: perc });
                
                grandObtained += total;
                grandMax += 350;
            });

            const overallPerc = grandMax > 0 ? ((grandObtained / grandMax) * 100).toFixed(1) + '%' : '0%';
            
            try {
                // âœ… Save to monthly_test_sheets
                await setDoc(doc(db, "monthly_test_sheets", docId), {
                    adminUid, jamiaName, month: monthKey, class: selectedClass,
                    subjects: finalSubjectsList, students, updatedAt: serverTimestamp()
                }); 
                
                console.log("âœ… Data successfully saved to monthly_test_sheets with ID:", docId); // Confirmation Log

                // Update Admin Dashboard
                const [yStr, mStr] = monthKey.split('-');
                const y = parseInt(yStr);
                const m = parseInt(mStr) - 1;
                const acYear = m >= 3 ? `${y}-${y + 1}` : `${y - 1}-${y}`;
                const reportId = `${adminUid}_${acYear}_${y}_${m}`;

                const reportRef = doc(db, 'monthly_reports', reportId);
                const reportSnap = await getDoc(reportRef);
                let testData = reportSnap.exists() ? (reportSnap.data().monthlyTest?.data || []) : [];
                
                // Update specific entry
                testData = testData.filter(t => t.name !== jamiaName);
                testData.push({
                    name: jamiaName, status: 'Test Hua', month: monthKey,
                    percentage: overallPerc, wajah: ''
                });

                await setDoc(reportRef, { monthlyTest: { status: 'Done', data: testData } }, { merge: true });

                alert(`Class ${selectedClass} ka Result Save ho gaya!`);
            } catch (error) {
                console.error("Save Error:", error);
                alert("Error: " + error.message);
            }
            };

       // 8. Load Existing Data & Check View Mode
window.checkExistingForClass = async (clsName) => {
    
    const cleanClass = clsName.split('_')[0]; 
    const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
    
    console.log("ðŸ”Ž Doc ID used for LOAD:", docId);
    
    const resultArea = document.getElementById('result-area');
    const studentsBody = document.getElementById('students-body');
    const classSelect = document.getElementById('class-select');
    const selectionArea = document.getElementById('subject-selection-area'); 

    // Reset UI
    finalSubjectsList = [];
    studentsBody.innerHTML = '';
    resultArea.classList.add('hidden'); 
    document.getElementById('table-head').innerHTML = '';
    document.querySelectorAll('.subject-checkbox').forEach(chk => chk.checked = false);
    
    // Default Enable (Important for Tabs to work)
    classSelect.disabled = false; 

    try {
        const snap = await getDoc(doc(db, "monthly_test_sheets", docId));
        
        if (snap.exists()) {
            const data = snap.data(); 
            console.log("âœ… Data Found:", data);
            
            // 1. Subjects Load
            const allChecks = document.querySelectorAll('.subject-checkbox');
            const savedVariableSubjects = data.subjects.filter(s => s !== 'English' && s !== 'Maths');
            allChecks.forEach(chk => {
                if (savedVariableSubjects.includes(chk.value)) chk.checked = true;
            });
            
            // 2. Final Subjects Set
            finalSubjectsList = data.subjects;
            
            // 3. Render Headers & Show Area
            renderTableHeaders(); 
            resultArea.classList.remove('hidden'); 
            
            // 4. Lock Selection
            // Note: classSelect ko disable nahi karenge taaki value read ki ja sake
            selectionArea.classList.add('hidden'); 
            
            // 5. Load Students
            document.getElementById('students-body').innerHTML = ''; 
            data.students.forEach(s => addStudentRow(s.name, s.marks)); 

            // ========================================================
            // ðŸ”¥ VIEW MODE LOGIC (Updated)
            // ========================================================
            const params = new URLSearchParams(window.location.search);
            
            if (params.get('mode') === 'view') {
                console.log("ðŸ‘€ View Mode Active: Editing Disabled");

                // A. Heading Update
                const headerTitle = document.querySelector('h1');
                if(headerTitle && !headerTitle.innerText.includes("View Only")) {
                    headerTitle.innerHTML += ` <span class="text-xl bg-yellow-200 text-yellow-800 px-2 py-1 rounded ml-2 align-middle">View Only</span>`;
                }

                // B. Hide Unwanted Text (Step 1 & Instruction)
                const stepHeading = document.getElementById('step-heading');
                const stepInstruction = document.getElementById('step-instruction');
                if(stepHeading) stepHeading.style.display = 'none';
                if(stepInstruction) stepInstruction.style.display = 'none';

                // C. Hide Specific Elements 
                // âŒ 'class-tabs' ko yahan se HATA DIYA hai taaki tabs dikhein
                const elementsToHide = ['subject-selection-area', 'class-select']; 
                elementsToHide.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('hidden');
                });
                
                // D. Hide Action Buttons
                const addStudentBtn = document.querySelector('button[onclick="addStudentRow()"]');
                const saveResultBtn = document.querySelector('button[onclick="saveResult()"]');
                if(addStudentBtn) addStudentBtn.style.display = 'none';
                if(saveResultBtn) saveResultBtn.style.display = 'none';

                // E. Lock Inputs (Read-Only)
                const allInputs = document.querySelectorAll('#students-body input');
                allInputs.forEach(inp => {
                    inp.disabled = true;
                    inp.style.backgroundColor = 'transparent';
                    inp.style.border = 'none';
                    inp.style.textAlign = 'center';
                    inp.style.fontWeight = 'bold';
                    inp.style.color = '#1f2937'; 
                    inp.placeholder = "";
                });

                // F. Hide Delete Buttons & Columns
                const deleteBtns = document.querySelectorAll('.no-print');
                deleteBtns.forEach(btn => btn.style.display = 'none');
                
                const headerTrash = document.querySelector('#table-head th:last-child');
                if(headerTrash) headerTrash.style.display = 'none';

                // G. Center Download Buttons
                const actionContainer = document.querySelector('.mt-8.flex.flex-col');
                if (actionContainer) {
                    actionContainer.classList.remove('justify-end');
                    actionContainer.classList.add('justify-center');
                }

            } else {
                // Normal Mode Alert
                alert(`Class ${clsName} ka purana data load kiya gaya.`);
            }
            // ========================================================

        } else {
             console.log("âŒ Document does not exist for this class."); 
             // View mode mein agar data nahi hai to result area hide kar dein
             const params = new URLSearchParams(window.location.search);
             if (params.get('mode') === 'view') {
                 resultArea.classList.add('hidden');
                 // Tabs dikhate rahein, lekin Step text chhupa dein
                 const stepHeading = document.getElementById('step-heading');
                 if(stepHeading) stepHeading.style.display = 'none';
             }
        }
    } catch(e) { 
        console.log("New sheet or error loading:", e);
    }
};
    
       window.downloadPDF = async () => {
    // 1. Library Check
    if (!window.html2canvas) { alert("Error: html2canvas library missing hai."); return; }

    const saveBtn = document.querySelector('button[onclick="downloadPDF()"]');
    if(saveBtn) saveBtn.innerText = "Processing...";

    // 2. Data Gather
    const jamiaTitle = document.getElementById('pdf-jamia').innerText;
    const currentClass = document.getElementById('class-select').value || "";
    const monthText = monthKey;
    const tableHeadHTML = document.getElementById('table-head').innerHTML;
    const originalTableBody = document.getElementById('students-body');

    // 3. Temp Container
    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0px';
    tempContainer.style.width = '1100px'; 
    document.body.appendChild(tempContainer);

    const PAGE_HEIGHT_LIMIT = 760; 

    // Colors (Hardcoded taaki formatting gayab na ho)
    const COLOR_TEAL_DARK = "#0f766e"; // teal-700
    const COLOR_TEAL_LIGHT = "#f0fdfa"; // teal-50
    const COLOR_WHITE = "#ffffff";
    const COLOR_BORDER = "#0f766e";

    function createNewPage() {
        const pageDiv = document.createElement('div');
        // Inline styles for background
        pageDiv.style.backgroundColor = "white";
        pageDiv.style.padding = "20px";
        pageDiv.style.width = "100%";
        pageDiv.style.boxSizing = "border-box";

        pageDiv.innerHTML = `
            <div style="margin-bottom: 10px; border: 2px solid ${COLOR_BORDER}; border-radius: 8px; overflow: hidden;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="height: 40px;">
                        <td style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold; font-size: 18px; width: 66%; border-right: 1px solid white; text-transform: uppercase;">
                            Monthly Test Result
                        </td>
                        <td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-bottom: 1px solid ${COLOR_BORDER}; border-right: 1px solid ${COLOR_BORDER}; width: 17%;">
                            CLASS
                        </td>
                        <td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold; font-size: 16px; border-bottom: 1px solid ${COLOR_BORDER}; width: 17%;">
                            ${currentClass}
                        </td>
                    </tr>
                    <tr style="height: 50px;">
                        <td style="background-color: white; color: #115e59; text-align: center; font-family: 'Jameel Noori Nastaleeq', serif; font-size: 24px; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">
                            ${jamiaTitle}
                        </td>
                        <td style="background-color: ${COLOR_TEAL_LIGHT}; color: #134e4a; text-align: center; font-weight: bold; border-right: 1px solid ${COLOR_BORDER};">
                            MONTH
                        </td>
                        <td style="background-color: white; color: #1f2937; text-align: center; font-weight: bold;">
                            ${monthText}
                        </td>
                    </tr>
                </table>
            </div>

            <table class="result-table" style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 13px;">
                <thead style="background-color: ${COLOR_TEAL_DARK}; color: white; text-align: center; font-weight: bold;">
                    ${tableHeadHTML}
                </thead>
                <tbody class="divide-y divide-gray-200" style="text-align: center;">
                </tbody>
            </table>
        `;
        
        // Remove 'Delete' column header
        const ths = pageDiv.querySelectorAll('.result-table th');
        if(ths.length > 0) ths[ths.length - 1].remove(); 

        // Apply Header Styles Manually (Taaki rang pakka rahe)
        pageDiv.querySelectorAll('.result-table th').forEach(th => {
            th.style.backgroundColor = COLOR_TEAL_DARK;
            th.style.color = "white";
            th.style.padding = "8px 4px";
            th.style.border = "1px solid #ccc";
        });

        tempContainer.appendChild(pageDiv);
        return pageDiv;
    }

    try {
        const rows = Array.from(originalTableBody.querySelectorAll('tr'));
        let currentPage = createNewPage();
        let currentTbody = currentPage.querySelector('.result-table tbody');

        for (let row of rows) {
            const clonedRow = row.cloneNode(true);
            
            // Delete 'Trash' Icon
            const lastTd = clonedRow.querySelector('td:last-child');
            if(lastTd) lastTd.remove();

            // Inputs to Text & Styling
            const inputs = clonedRow.querySelectorAll('input');
            inputs.forEach(input => {
                const div = document.createElement('div');
                div.innerText = input.value || '-';
                
                // Style the Value
                div.style.textAlign = "center";
                div.style.fontWeight = "bold";
                div.style.width = "100%";
                div.style.padding = "5px 0";

                if(input.classList.contains('bg-fail-input')) {
                    div.style.backgroundColor = "#fee2e2"; 
                    div.style.color = "#991b1b";
                }
                if(input.parentNode) input.parentNode.replaceChild(div, input);
            });
            
            // Apply Row & Cell Styling (Force Borders & Center)
            clonedRow.querySelectorAll('td').forEach(td => {
                td.style.padding = "5px 2px";
                td.style.textAlign = "center"; 
                td.style.border = "1px solid #e5e7eb"; // Light gray border
                td.classList.remove('text-right', 'pr-2'); 
            });

            currentTbody.appendChild(clonedRow);
            
            if (currentPage.offsetHeight > PAGE_HEIGHT_LIMIT) {
                currentTbody.removeChild(clonedRow);
                currentPage = createNewPage();
                currentTbody = currentPage.querySelector('.result-table tbody');
                currentTbody.appendChild(clonedRow);
            }
        }

        // Generate PDF
        const pages = tempContainer.querySelectorAll('div');
        const { jsPDF } = window.jspdf;
        const pdfDoc = new jsPDF('l', 'mm', 'a4'); 

        // Sirf main pages ko capture karein (filtering nested divs)
        // Hum tempContainer ke direct children ko hi lenge
        const directPages = Array.from(tempContainer.children);

        for (let i = 0; i < directPages.length; i++) {
            const page = directPages[i];
            const canvas = await html2canvas(page, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: "#ffffff" // Ensure white background
            });
            
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 297; 
            const imgHeight = canvas.height * imgWidth / canvas.width;

            if (i > 0) pdfDoc.addPage();
            pdfDoc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        }

        document.body.removeChild(tempContainer);
        pdfDoc.save(`Result_${jamiaTitle}_${currentClass}.pdf`);

    } catch (error) {
        console.error("PDF Logic Error:", error);
        alert("PDF Generation Failed: " + error.message);
    } finally {
        if(saveBtn) saveBtn.innerText = "Download PDF";
    }
};

window.downloadAllClassesPDF = async () => {
    if (!window.html2canvas) { alert("html2canvas library missing hai."); return; }

    const btn = document.getElementById('download-all-btn');
    const originalText = btn.innerText;
    btn.innerText = "Processing..."; 
    btn.disabled = true;             

    try {
        const { jsPDF } = window.jspdf;
        const pdfDoc = new jsPDF('l', 'mm', 'a4'); 
        let pageCount = 0;

        const allClasses = Object.keys(classBooksMap).sort();

        for (const clsName of allClasses) {
            btn.innerText = `Generating: ${clsName}...`;

            const cleanClass = clsName.split('_')[0]; 
            const docId = `${adminUid}_${jamiaName.replace(/\s/g, '_')}_${monthKey}_${cleanClass.replace(/\s/g, '_')}`;
            const docSnap = await getDoc(doc(db, "monthly_test_sheets", docId));

            if (!docSnap.exists()) continue;

            const data = docSnap.data();
            const students = data.students || [];
            const subjects = data.subjects || [];
            if (students.length === 0) continue;

            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.width = '1100px'; 
            document.body.appendChild(tempContainer);

            // Dynamic Header Cells
            let totalMax = 0;
            let headerCells = "";
            subjects.forEach(sub => {
                const isSmall = sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths';
                const max = isSmall ? 25 : 100;
                totalMax += max;
                headerCells += `<th class="px-2 py-1 border border-gray-300 text-center text-white">${sub} <br><span class="text-xs font-normal text-teal-200">/${max}</span></th>`;
            });

            const PAGE_HEIGHT_LIMIT = 760; 

            function createNewPage() {
                const pageDiv = document.createElement('div');
                pageDiv.className = "bg-white p-4"; 
                pageDiv.style.width = "100%";
                pageDiv.style.backgroundColor = "white";

                pageDiv.innerHTML = `
                    <div class="mb-2 border-2 border-teal-700 rounded overflow-hidden">
                        <table class="w-full border-collapse">
                            <tr class="h-10"> <td class="bg-teal-700 text-white text-center font-bold text-xl py-2 w-2/3 border-r border-white uppercase tracking-wider align-middle">
                                    Monthly Test Result
                                </td>
                                <td class="bg-teal-50 text-teal-900 font-bold text-center border-b border-teal-700 border-r border-teal-700 w-1/6 align-middle">
                                    CLASS
                                </td>
                                <td class="bg-white text-gray-800 font-bold text-center border-b border-teal-700 w-1/6 text-lg align-middle">
                                    ${clsName}
                                </td>
                            </tr>
                            <tr class="h-12"> <td class="bg-white text-teal-800 text-center urdu-font text-2xl font-bold py-1 border-r border-teal-700 align-middle" style="font-family: 'Jameel Noori Nastaleeq', serif;">
                                    ${jamiaName}
                                </td>
                                <td class="bg-teal-50 text-teal-900 font-bold text-center border-r border-teal-700 align-middle">
                                    MONTH
                                </td>
                                <td class="bg-white text-gray-800 font-bold text-center align-middle">
                                    ${monthKey}
                                </td>
                            </tr>
                        </table>
                    </div>

                    <table class="result-table w-full text-sm text-left border-collapse" style="width: 100%; table-layout: fixed;">
                        <thead class="bg-teal-700 text-white uppercase font-bold text-center">
                            <tr>
                                <th class="px-2 py-1 border border-gray-300 w-12 text-white">#</th>
                                <th class="px-2 py-1 border border-gray-300 w-1/4 text-white text-center">Talib-e-Ilm</th> ${headerCells}
                                <th class="px-2 py-1 border border-gray-300 text-center bg-teal-800 text-white">Total (${totalMax})</th>
                                <th class="px-2 py-1 border border-gray-300 text-center bg-teal-800 text-white">%</th>
                                <th class="px-2 py-1 border border-gray-300 text-center bg-teal-800 text-white">Grade</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 text-center"></tbody>
                    </table>
                `;
                tempContainer.appendChild(pageDiv);
                return pageDiv;
            }

            let currentPage = createNewPage();
            let currentTbody = currentPage.querySelector('.result-table tbody');

            for (let i = 0; i < students.length; i++) {
                const std = students[i];
                const tr = document.createElement('tr');
                
                let tds = "";
                let hasAbsent = false;

                subjects.forEach(sub => {
                    let val = std.marks[sub];
                    if (val === undefined) val = "-";
                    let cellStyle = "background: transparent;";
                    let displayVal = val;

                    if (val === 'A') {
                        hasAbsent = true;
                        cellStyle = "background-color: #fee2e2; color: #991b1b;"; 
                    } else if (val !== '-' && typeof val === 'number') {
                         const max = (sub.toLowerCase() === 'english' || sub.toLowerCase() === 'maths') ? 25 : 100;
                         const pass = max === 25 ? 10 : 40;
                         if (val < pass) cellStyle = "background-color: #fee2e2; color: #991b1b;";
                    }
                    tds += `<td class="border border-gray-300 p-1 font-bold" style="${cellStyle} padding: 4px 2px;">${displayVal}</td>`;
                });

                let grade = "Nakam";
                let cls = "background-color: #ef4444; color: white;"; 
                const p = parseFloat(std.percentage);

                if (p >= 80) { grade = "Mumtaz Ma Sharf"; cls = "background-color: #15803d; color: white;"; }
                else if (p >= 70) { grade = "Mumtaz"; cls = "background-color: #22c55e; color: white;"; }
                else if (p >= 50) { grade = "Jayyid"; cls = "background-color: #eab308; color: white;"; }
                else if (p >= 40) { grade = "Maqbul"; cls = "background-color: #f97316; color: white;"; }
                
                if (hasAbsent || grade === "Nakam") {
                    grade = "Nakam";
                    cls = "background-color: #ef4444; color: white;";
                }

                // ðŸ”¥ Fix: 'text-right' ko 'text-center' kar diya aur 'pr-2' hata diya
                tr.innerHTML = `
                    <td class="border border-gray-300 p-1 text-gray-500">${i + 1}</td>
                    <td class="border border-gray-300 p-1 font-semibold urdu-font text-center" style="font-size: 14px;">${std.name}</td>
                    ${tds}
                    <td class="border border-gray-300 p-1 font-bold">${std.total}</td>
                    <td class="border border-gray-300 p-1 font-bold text-blue-600">${std.percentage}%</td>
                    <td class="border border-gray-300 p-1 font-bold text-xs rounded" style="${cls}">${grade}</td>
                `;

                currentTbody.appendChild(tr);

                if (currentPage.offsetHeight > PAGE_HEIGHT_LIMIT) {
                    currentTbody.removeChild(tr); 
                    currentPage = createNewPage(); 
                    currentTbody = currentPage.querySelector('.result-table tbody');
                    currentTbody.appendChild(tr); 
                }
            }

            const pages = tempContainer.querySelectorAll('div.bg-white');
            for (let j = 0; j < pages.length; j++) {
                const page = pages[j];
                const canvas = await html2canvas(page, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 297; 
                const imgHeight = canvas.height * imgWidth / canvas.width;

                if (pageCount > 0) pdfDoc.addPage();
                pdfDoc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pageCount++;
            }
            document.body.removeChild(tempContainer);
        }

        if (pageCount === 0) {
            alert("Koi bhi saved data nahi mila.");
        } else {
            pdfDoc.save(`All_Classes_Result_${jamiaName}_${monthKey}.pdf`);
        }

    } catch (error) {
        console.error("PDF Error:", error);
        alert("Error: " + error.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};
        // Step 1: ID nikalna (Smart Check)
const urlParams = new URLSearchParams(window.location.search);

// Hum 'id' check karenge, agar wo nahi mila to 'uid' check karenge
let reportId = urlParams.get('id') || urlParams.get('uid');

console.log("ðŸ” Checking URL Params:", window.location.search); // Debugging ke liye

if (!reportId) {
    // Agar ID abhi bhi nahi mili, to user ko alert karo
    console.error("âŒ Report ID Missing! URL sahi nahi hai.");
    alert("Error: Link me ID nahi hai. Kripya sahi link use karein.");
} else {
    console.log("âœ… Report ID Found:", reportId);
}

// Step 2: Save Function (DHYAN DEN: Yahin do baar save ho raha tha)
window.saveResult_Admin = async function() { // Function ka naam badal diya
    
    if (!reportId) {
        alert("Cannot Save: Report ID is missing.");
        return;
    }

    const saveBtn = document.getElementById('save-btn'); 
    if(saveBtn) saveBtn.innerText = "Saving...";

    try {
        const collectionName = "monthly_reports"; 
        const reportRef = doc(db, collectionName, reportId);

        console.log(`ðŸ“¤ Saving to: ${collectionName}/${reportId}`);

        // Yeh code monthly_reports update karta hai (Jo pehle se exist karta hai)
        const dataToSave = typeof testData !== 'undefined' ? testData : { check: "Testing" };

        await setDoc(reportRef, { 
            monthlyTest: { 
                status: 'Done', 
                lastUpdated: new Date(),
                data: dataToSave 
            } 
        }, { merge: true });

        console.log("âœ… Save Success (Admin Dashboard)!");
        if(saveBtn) saveBtn.innerText = "Saved";

    } catch (error) {
        console.error("ðŸ”¥ Firestore Error (Admin):", error);
        if(saveBtn) saveBtn.innerText = "Try Again";
    }
};
    </script>
</body>
</html>






















































