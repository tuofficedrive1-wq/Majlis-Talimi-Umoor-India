<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Admin Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2'); }
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        .big-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #0f766e; }
        .bg-fail { background-color: #ef4444 !important; color: white !important; }
        .bg-pass { background-color: #ecfccb !important; color: #1e293b !important; }
        .student-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
        .page-btn { padding: 5px 12px; border: 1px solid #ccc; background: white; margin: 0 2px; border-radius: 4px; cursor: pointer; }
        .page-btn.active { background: #0f766e; color: white; border-color: #0f766e; }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60]"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="border-4 border-t-teal-600 rounded-full w-12 h-12 animate-spin"></div></div>

    <header class="bg-teal-800 text-white p-4 shadow-md sticky top-0 z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Tadrisi Admin System (Pro)</h1>
            <div class="flex gap-2">
                <button onclick="fixGroupCounts()" class="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-1.5 rounded text-xs font-bold"><i class="fas fa-wrench"></i> Fix Counts</button>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded text-xs font-semibold">Logout</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[98%]">
        
        <div class="flex flex-wrap gap-2 mb-6 border-b pb-2 no-print">
            <button onclick="switchTab('students')" class="tab-btn active px-4 py-2 rounded-t-lg font-medium border" id="tab-students">1. Students List</button>
            <button onclick="switchTab('groups')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border" id="tab-groups">2. Groups</button>
            <button onclick="switchTab('results')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border" id="tab-results">3. Result</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border" id="tab-mufattish">4. Mufattish Status</button>
        </div>

        <div id="view-students" class="tab-content">
            <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-teal-600 flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 w-full">
                    <label class="text-xs text-gray-500">Jamia Name (Pre-fill Link)</label>
                    <input type="text" id="link-jamia-name" class="w-full p-2 border rounded urdu-font text-sm" placeholder="Jamia ka naam..." oninput="generateLink()">
                </div>
                <div class="flex-[2] w-full flex">
                    <input type="text" id="shareable-link" class="w-full p-2 border rounded-l bg-gray-50 text-sm text-gray-600" readonly>
                    <button onclick="copyLink()" class="bg-teal-600 text-white px-4 py-2 rounded-r font-bold text-sm">Copy Link</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow border-t-4 border-orange-500">
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <div class="w-full md:w-auto flex gap-2">
                        <button onclick="fetchAllStudents()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-sync-alt"></i> Refresh List</button>
                        <button onclick="exportStudentList()" class="bg-green-600 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-file-excel"></i> Excel</button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-2 w-full md:w-2/3">
                        <div class="flex-1">
                            <label class="text-xs text-gray-500 font-bold">Filter Group</label>
                            <select id="student-filter-group" onchange="filterStudents()" class="w-full p-2 border rounded text-sm bg-gray-50">
                                <option value="">All Groups</option>
                                <option value="unassigned" class="text-red-600 font-bold">Unassigned</option>
                            </select>
                        </div>
                        <div class="flex-[2] relative">
                            <input type="text" id="search-input" oninput="filterStudents()" class="w-full p-2 pl-8 border rounded bg-gray-50" placeholder="Search...">
                            <i class="fas fa-search absolute left-2 top-3 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div id="bulk-action-bar" class="hidden bg-orange-50 p-2 rounded border border-orange-200 mb-2 flex flex-col md:flex-row justify-between items-center gap-2">
                    <span class="font-bold text-orange-800 text-sm"><span id="selected-count">0</span> Selected</span>
                    <div class="flex gap-2">
                        <select id="bulk-group-select" class="p-1 border rounded text-sm w-48"><option value="">-- Move to Group --</option></select>
                        <button onclick="bulkAssignGroup()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">Move</button>
                        <button onclick="bulkDeleteStudents()" class="bg-red-600 text-white px-3 py-1 rounded text-sm font-bold">Delete</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto min-h-[300px]">
                    <table class="w-full text-left border-collapse min-w-[1000px]">
                        <thead class="bg-orange-50 text-orange-900 text-sm">
                            <tr>
                                <th class="p-2 border-b w-8 text-center"><input type="checkbox" onchange="toggleSelectAll(this)" class="big-checkbox"></th>
                                <th class="p-2 border-b w-10">#</th>
                                <th class="p-2 border-b w-12 text-center">Img</th>
                                <th class="p-2 border-b">Roll No</th>
                                <th class="p-2 border-b">Name</th>
                                <th class="p-2 border-b">Jamia / City</th>
                                <th class="p-2 border-b">Mobile</th>
                                <th class="p-2 border-b">Group</th>
                                <th class="p-2 border-b w-24">Action</th>
                            </tr>
                        </thead>
                        <tbody id="students-master-tbody"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-4 pt-2 border-t">
                    <span class="text-xs text-gray-500" id="showing-text">Showing 0-0 of 0</span>
                    <div id="pagination-controls" class="flex"></div>
                </div>
            </div>
        </div>

        <div id="view-groups" class="tab-content hidden">
            <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-teal-600">
                <h3 class="text-lg font-bold mb-2">Add New Group</h3>
                <div class="flex flex-col gap-3">
                    <input type="text" id="new-group-name" placeholder="Group Name" class="w-full p-2 border rounded urdu-font">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <select id="mufattish-r1" class="p-2 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r2" class="p-2 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r3" class="p-2 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r4" class="p-2 border rounded text-xs bg-gray-50"></select>
                    </div>
                    <button onclick="createGroup()" class="bg-teal-600 text-white px-4 py-2 rounded font-bold w-full md:w-auto">Create Group</button>
                </div>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-results" class="tab-content hidden">
            <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-purple-600 no-print">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold">Result Sheet</h3>
                    <button onclick="exportResultToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-sm font-bold shadow"><i class="fas fa-file-excel"></i> Download</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <select id="result-group-select" onchange="loadGroupResults()" class="w-full p-2 border rounded urdu-font bg-gray-50"><option value="">-- Select Group --</option></select>
                    <input type="month" id="result-month-selector" class="w-full p-2 border rounded bg-gray-50" onchange="updateHeaderDate()">
                    <select id="filter-jamia" onchange="filterResults()" class="w-full p-2 border rounded urdu-font bg-gray-50"><option value="all">All Jamiaat</option></select>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden border p-2 min-h-[500px]">
                <div class="text-center mb-4 pt-2">
                    <h2 class="text-2xl font-bold urdu-font">ÿ™ÿØÿ±€åÿ≥€å Ÿπ€åÿ≥Ÿπ ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å ŸÅÿßÿ±ŸÖ</h2>
                    <p class="text-gray-600 text-sm" id="result-header-date">Month: -- | Year: --</p>
                    <h3 class="text-lg text-teal-700 font-bold" id="result-group-name"></h3>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-center border-collapse border border-gray-400 min-w-[1200px]" dir="rtl" id="result-table"><thead class="bg-orange-100 text-gray-900 font-bold text-sm urdu-font"><tr><th class="p-1 border w-8">#</th><th class="p-1 border w-40 text-right pr-2">ŸÜÿßŸÖ</th><th class="p-1 border w-24">ÿ¨ÿßŸÖÿπ€Å</th><th class="p-1 border w-12 bg-header">ÿπÿ®ÿßÿ±ÿ™</th><th class="p-1 border w-12 bg-header">ÿ™ÿ±ÿ¨ŸÖ€Å</th><th class="p-1 border w-12 bg-header">ÿµÿ±ŸÅ</th><th class="p-1 border w-12 bg-header">ŸÜÿ≠Ÿà</th><th class="p-1 border w-12 bg-header">ÿßŸÜÿØÿßÿ≤</th><th class="p-1 border w-16 bg-blue-50">⁄©ŸÑ</th><th class="p-1 border w-16 bg-blue-50">ŸÅ€åÿµÿØ</th><th class="p-1 border w-20 bg-orange-200">⁄©€åŸÅ€åÿ™</th></tr></thead><tbody id="results-tbody" class="text-base urdu-font text-gray-800"><tr><td colspan="11" class="p-4 text-gray-400">Select Group</td></tr></tbody></table></div>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-gray-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Mufattish Status (Group Progress)</h3>
                    <button onclick="renderMufattishStatus()" class="text-blue-600 hover:underline text-sm"><i class="fas fa-sync"></i> Refresh Status</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead class="bg-gray-100 text-gray-800">
                            <tr>
                                <th class="p-3 border-b">Mufattish Name</th>
                                <th class="p-3 border-b">Region</th>
                                <th class="p-3 border-b">Assigned Groups & Progress (Filled/Total)</th>
                            </tr>
                        </thead>
                        <tbody id="mufattish-status-tbody">
                            <tr><td colspan="3" class="p-4 text-gray-400 text-center">Loading status...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96 max-w-full">
            <h3 class="text-lg font-bold mb-4 text-teal-800 border-b pb-2">Edit Student</h3>
            <input type="hidden" id="edit-student-id">
            <div class="space-y-2 text-sm">
                <input type="text" id="edit-reg" class="w-full p-2 border rounded font-mono" placeholder="Roll No">
                <input type="text" id="edit-name" class="w-full p-2 border rounded urdu-font" placeholder="Name">
                <input type="text" id="edit-father" class="w-full p-2 border rounded urdu-font" placeholder="Father Name">
                <input type="text" id="edit-jamia" class="w-full p-2 border rounded urdu-font" placeholder="Jamia">
                <input type="text" id="edit-city" class="w-full p-2 border rounded urdu-font" placeholder="City">
                <input type="text" id="edit-mobile" class="w-full p-2 border rounded font-mono" placeholder="Mobile">
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-3 py-1 bg-gray-300 rounded">Cancel</button>
                <button onclick="saveEditedStudent()" class="px-4 py-1 bg-teal-600 text-white rounded">Update</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h3 class="text-lg font-bold mb-4">Transfer Student</h3>
            <p id="transfer-student-name" class="mb-4 text-sm text-gray-600"></p>
            <input type="hidden" id="transfer-student-id"><input type="hidden" id="transfer-old-group-id">
            <label class="block text-sm mb-1">New Group</label>
            <select id="transfer-group-select" class="w-full p-2 border rounded mb-4"></select>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('transfer-modal').classList.add('hidden')" class="px-3 py-1 bg-gray-300 rounded">Cancel</button>
                <button onclick="confirmTransfer()" class="px-4 py-1 bg-blue-600 text-white rounded">Transfer</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish = [], allGroups = [], allStudents = [];
        let filteredList = [];
        let currentPage = 1;
        const rowsPerPage = 50;

        const showLoader = (show) => document.getElementById('loader').classList.toggle('hidden', !show);
        const showToast = (msg, type='success') => { const el = document.getElementById('notification'); el.textContent = msg; el.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] ${type==='error'?'bg-red-500':'bg-emerald-600'}`; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3000); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const d = await getDoc(doc(db, 'users', user.uid));
                if(d.exists() && ['admin','tadrisi_course_management','tadrisi_course_admin'].includes(d.data().role)) await initData();
                else window.location.href = 'index.html';
            } else window.location.href = 'index.html';
            showLoader(false);
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        window.switchTab = (tab) => { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`view-${tab}`).classList.remove('hidden'); 
            document.getElementById(`tab-${tab}`).classList.add('active'); 
        };

        async function initData() { 
            await fetchMufattishList(); 
            await fetchGroupsList();
            await fetchAllStudents();
            generateLink();
        }

        async function fetchMufattishList() {
            const q = query(collection(db, 'users'), where('role', '==', 'tadrisi_course_mufattish'));
            const snap = await getDocs(q); 
            allMufattish = snap.docs.map(d => ({id:d.id, ...d.data()}));
            const opts = '<option value="">-- Select --</option>' + allMufattish.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            ['mufattish-r1', 'mufattish-r2', 'mufattish-r3', 'mufattish-r4'].forEach(id => document.getElementById(id).innerHTML = opts);
        }

        async function fetchGroupsList() {
            const q = query(collection(db, 'tadrisi_groups')); 
            const snap = await getDocs(q);
            allGroups = snap.docs.map(d => ({id:d.id, ...d.data()}));
            allGroups.sort((a, b) => a.groupName.localeCompare(b.groupName, undefined, {numeric: true, sensitivity: 'base'}));
            document.getElementById('groups-list-container').innerHTML = allGroups.map(g => `<div class="bg-white p-4 shadow border rounded relative"><h4 class="font-bold text-teal-800">${g.groupName}</h4><span class="text-xs bg-gray-100 px-2 py-1 rounded">Students: ${g.totalStudents||0}</span><button onclick="deleteGroup('${g.id}')" class="absolute top-2 right-2 text-red-400"><i class="fas fa-trash"></i></button></div>`).join('');
            populateGroupDropdowns();
        }

        window.fetchAllStudents = async () => {
            showLoader(true);
            try {
                const q = query(collection(db, 'tadrisi_students'));
                const snap = await getDocs(q);
                allStudents = snap.docs.map(d => ({id:d.id, ...d.data()}));
                allStudents.sort((a, b) => (!a.groupId && b.groupId) ? -1 : 0);
                filteredList = allStudents; 
                filterStudents(); 
                renderMufattishStatus(); // Update status with new data
                showToast('Updated', 'success');
            } catch (e) { console.error(e); } 
            finally { showLoader(false); }
        }

        function populateGroupDropdowns() {
            const opts = '<option value="">-- Select Group --</option>' + allGroups.map(g => `<option value="${g.id}">${g.groupName} (${g.totalStudents})</option>`).join('');
            const filterOpts = '<option value="">All Groups</option><option value="unassigned" class="text-red-600 font-bold">Unassigned</option>' + allGroups.map(g => `<option value="${g.id}">${g.groupName}</option>`).join('');
            document.getElementById('student-filter-group').innerHTML = filterOpts;
            document.getElementById('result-group-select').innerHTML = opts;
            document.getElementById('bulk-group-select').innerHTML = opts;
            document.getElementById('transfer-group-select').innerHTML = opts;
        }

        window.filterStudents = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const grpFilter = document.getElementById('student-filter-group').value;
            filteredList = allStudents.filter(s => {
                let matchesGrp = true;
                if(grpFilter === 'unassigned') matchesGrp = !s.groupId;
                else if(grpFilter) matchesGrp = s.groupId === grpFilter;
                const matchesSearch = (s.name && s.name.toLowerCase().includes(term)) || (s.regNo && s.regNo.toLowerCase().includes(term)) || (s.jamia && s.jamia.toLowerCase().includes(term)) || (s.city && s.city.toLowerCase().includes(term));
                return matchesGrp && matchesSearch;
            });
            currentPage = 1; renderPagination();
        };

        function renderPagination() {
            const tbody = document.getElementById('students-master-tbody'); tbody.innerHTML = '';
            const total = filteredList.length;
            if(total === 0) { tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-400">No students found.</td></tr>'; document.getElementById('pagination-controls').innerHTML=''; return; }
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            filteredList.slice(start, end).forEach((s, idx) => {
                const photoSrc = s.photoBase64 || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Img';
                const grp = allGroups.find(g => g.id === s.groupId);
                const grpName = grp ? grp.groupName : '<span class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded text-xs">Unassigned</span>';
                tbody.innerHTML += `<tr class="border-b text-sm hover:bg-gray-50 align-middle"><td class="p-2 text-center"><input type="checkbox" class="student-checkbox big-checkbox" value="${s.id}" onchange="updateBulkActionUI()"></td><td class="p-2 text-gray-500 text-xs">${start+idx+1}</td><td class="p-2 text-center"><img src="${photoSrc}" class="student-thumb mx-auto"></td><td class="p-2 font-mono font-bold">${s.regNo||'-'}</td><td class="p-2 font-bold urdu-font text-base">${s.name}<br><span class="text-xs font-normal text-gray-500">${s.fatherName}</span></td><td class="p-2 urdu-font text-xs">${s.jamia||'-'}<br><span class="text-teal-600">${s.city||'-'}</span></td><td class="p-2 font-mono text-xs">${s.mobile||'-'}</td><td class="p-2 text-xs">${grpName}</td><td class="p-2 flex gap-1"><button onclick="openEditModal('${s.id}')" class="text-teal-600 p-1"><i class="fas fa-edit"></i></button><button onclick="openTransferModal('${s.id}', '${s.name}', '${s.groupId||''}')" class="text-blue-600 p-1"><i class="fas fa-exchange-alt"></i></button><button onclick="deleteStudent('${s.id}')" class="text-red-500 p-1"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            document.getElementById('showing-text').innerText = `Showing ${start+1}-${Math.min(end, total)} of ${total}`;
            const totalPages = Math.ceil(total/rowsPerPage);
            let btns=''; if(totalPages>1){ btns+=`<button onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''} class="page-btn"><</button>`; for(let i=1;i<=totalPages;i++){ if(i===1||i===totalPages||(i>=currentPage-1 && i<=currentPage+1)){ btns+=`<button onclick="changePage(${i})" class="page-btn ${i===currentPage?'active':''}">${i}</button>`; } else if(i===currentPage-2||i===currentPage+2) btns+=`<span>..</span>`; } btns+=`<button onclick="changePage(${currentPage+1})" ${currentPage===totalPages?'disabled':''} class="page-btn">></button>`; }
            document.getElementById('pagination-controls').innerHTML = btns;
        }
        window.changePage = (pg) => { const t = Math.ceil(filteredList.length/rowsPerPage); if(pg<1||pg>t) return; currentPage=pg; renderPagination(); };

        window.fixGroupCounts = async () => {
            if(!confirm("Scan & Fix all counts?")) return; showLoader(true);
            try {
                const counts = {}; allGroups.forEach(g=>counts[g.id]=0);
                const q = query(collection(db, 'tadrisi_students')); const snap = await getDocs(q);
                snap.forEach(d=>{ const gid=d.data().groupId; if(gid && counts[gid]!==undefined) counts[gid]++; });
                const batch = writeBatch(db);
                allGroups.forEach(g => { batch.update(doc(db,'tadrisi_groups',g.id), {totalStudents:counts[g.id]||0}); });
                await batch.commit(); await fetchGroupsList(); showToast('Fixed!', 'success');
            } catch(e) { console.error(e); } finally { showLoader(false); }
        };

        // --- Core Functions (kept same logic, just linked to manual refresh) ---
        window.createGroup = async () => { const n=document.getElementById('new-group-name').value; if(!n)return; await addDoc(collection(db,'tadrisi_groups'), {groupName:n, totalStudents:0, round_1_uid:document.getElementById('mufattish-r1').value, round_2_uid:document.getElementById('mufattish-r2').value, round_3_uid:document.getElementById('mufattish-r3').value, round_4_uid:document.getElementById('mufattish-r4').value}); document.getElementById('new-group-name').value=''; await fetchGroupsList(); };
        window.deleteStudent = async (id) => { if(confirm('Delete?')) { await deleteDoc(doc(db,'tadrisi_students',id)); await fetchAllStudents(); } };
        window.confirmTransfer = async () => { const sid=document.getElementById('transfer-student-id').value; const newGid=document.getElementById('transfer-group-select').value; if(!newGid) return; await updateDoc(doc(db,'tadrisi_students',sid),{groupId:newGid}); document.getElementById('transfer-modal').classList.add('hidden'); showToast('Transferred'); await fetchAllStudents(); };
        window.toggleSelectAll = (src) => { document.querySelectorAll('.student-checkbox').forEach(cb=>cb.checked=src.checked); updateBulkActionUI(); };
        window.updateBulkActionUI = () => { const c=document.querySelectorAll('.student-checkbox:checked').length; document.getElementById('selected-count').textContent=c; document.getElementById('bulk-action-bar').classList.toggle('hidden', c===0); };
        window.bulkAssignGroup = async () => { const gid=document.getElementById('bulk-group-select').value; const ids=Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb=>cb.value); if(!gid || ids.length===0) return; if(!confirm(`Move ${ids.length}?`)) return; showLoader(true); const batch=writeBatch(db); ids.forEach(sid=>batch.update(doc(db,'tadrisi_students',sid),{groupId:gid})); await batch.commit(); showToast('Moved'); document.getElementById('bulk-action-bar').classList.add('hidden'); await fetchAllStudents(); };
        window.bulkDeleteStudents = async () => { const ids=Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb=>cb.value); if(!confirm(`Delete ${ids.length}?`)) return; showLoader(true); const batch=writeBatch(db); ids.forEach(sid=>batch.delete(doc(db,'tadrisi_students',sid))); await batch.commit(); showToast('Deleted'); await fetchAllStudents(); };
        window.openEditModal = (id) => { const s=allStudents.find(st=>st.id===id); if(!s)return; document.getElementById('edit-student-id').value=s.id; document.getElementById('edit-reg').value=s.regNo||''; document.getElementById('edit-name').value=s.name||''; document.getElementById('edit-father').value=s.fatherName||''; document.getElementById('edit-jamia').value=s.jamia||''; document.getElementById('edit-city').value=s.city||''; document.getElementById('edit-mobile').value=s.mobile||''; document.getElementById('edit-modal').classList.remove('hidden'); };
        window.saveEditedStudent = async () => { const id=document.getElementById('edit-student-id').value; await updateDoc(doc(db,'tadrisi_students',id), { regNo:document.getElementById('edit-reg').value, name:document.getElementById('edit-name').value, fatherName:document.getElementById('edit-father').value, jamia:document.getElementById('edit-jamia').value, city:document.getElementById('edit-city').value, mobile:document.getElementById('edit-mobile').value }); document.getElementById('edit-modal').classList.add('hidden'); showToast('Saved'); await fetchAllStudents(); };
        window.generateLink = () => { const j=document.getElementById('link-jamia-name').value.trim(); const b=window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/tadrisi_student_form.html'; document.getElementById('shareable-link').value=j ? `${b}?jamia=${encodeURIComponent(j)}` : b; };
        window.copyLink = () => { document.getElementById('shareable-link').select(); document.execCommand('copy'); showToast('Copied'); };
        window.exportStudentList = () => { if(allStudents.length===0)return; const d=allStudents.map((s,i)=>({"#":i+1,"Roll":s.regNo,"Name":s.name,"Father":s.fatherName,"Jamia":s.jamia,"City":s.city,"Mobile":s.mobile,"Group":allGroups.find(g=>g.id===s.groupId)?.groupName||'Unassigned'})); const ws=XLSX.utils.json_to_sheet(d); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Students"); XLSX.writeFile(wb, "Students_List.xlsx"); };
        window.deleteGroup = async (id) => { if(confirm('Delete Group?')) await deleteDoc(doc(db,'tadrisi_groups',id)); await fetchGroupsList(); };
        window.openTransferModal = (sid, name, oldGid) => { document.getElementById('transfer-student-name').textContent=`Transferring: ${name}`; document.getElementById('transfer-student-id').value=sid; document.getElementById('transfer-old-group-id').value=oldGid; document.getElementById('transfer-modal').classList.remove('hidden'); };

        // Results
        window.updateHeaderDate = () => { document.getElementById('result-header-date').textContent = document.getElementById('result-month-selector').value || 'Month: -- | Year: --'; };
        window.loadGroupResults = async () => { const gid=document.getElementById('result-group-select').value; if(!gid)return; const studentsInGroup=allStudents.filter(s=>s.groupId===gid); renderResultTable(studentsInGroup); document.getElementById('result-group-name').textContent = allGroups.find(g=>g.id===gid)?.groupName || ''; };
        window.filterResults = () => { const gid=document.getElementById('result-group-select').value; const jamia=document.getElementById('filter-jamia').value; let list=allStudents.filter(s=>s.groupId===gid); if(jamia!=='all') list=list.filter(s=>s.jamia===jamia); renderResultTable(list); };
        function renderResultTable(list) {
            const tbody=document.getElementById('results-tbody'); tbody.innerHTML=''; const filled=list.filter(s=>s.marks_r1||s.marks_r2||s.marks_r3||s.marks_r4);
            if(filled.length===0){ tbody.innerHTML='<tr><td colspan="11" class="p-8 text-gray-400">No results found.</td></tr>'; return; }
            let count=1; filled.forEach(s => {
                const getMark=(r,k)=>(r&&r[k])?Number(r[k]):0;
                const r1=s.marks_r1,r2=s.marks_r2,r3=s.marks_r3,r4=s.marks_r4;
                const tIbarat=getMark(r1,'m1')+getMark(r2,'m1')+getMark(r3,'m1')+getMark(r4,'m1');
                const tTarjama=getMark(r1,'m2')+getMark(r2,'m2')+getMark(r3,'m2')+getMark(r4,'m2');
                const tSarf=getMark(r1,'m3')+getMark(r2,'m3')+getMark(r3,'m3')+getMark(r4,'m3');
                const tNahw=getMark(r1,'m4')+getMark(r2,'m4')+getMark(r3,'m4')+getMark(r4,'m4');
                const tAndaz=getMark(r1,'m5')+getMark(r2,'m5')+getMark(r3,'m5')+getMark(r4,'m5');
                const grandTotal=tIbarat+tTarjama+tSarf+tNahw+tAndaz;
                const percent=(grandTotal/400)*100;
                const isFail=(tIbarat<56||tTarjama<56||tSarf<56||tNahw<56||tAndaz<56);
                let txt="ŸÜÿß⁄©ÿßŸÖ", cls="bg-fail";
                if(!isFail) { if(percent>=90){txt="ŸÖŸÖÿ™ÿßÿ≤";cls="bg-pass";} else if(percent>=80){txt="ÿ®€Åÿ™ÿ±";cls="bg-pass";} else if(percent>=70){txt="ŸÖŸÜÿßÿ≥ÿ®";cls="bg-pass";} }
                const cc=(v)=>v<56?'text-red-600 font-bold bg-red-50':'';
                tbody.innerHTML+=`<tr class="border-b"><td class="p-1">${count++}</td><td class="p-1 text-right font-bold">${s.name}</td><td class="p-1 text-xs">${s.jamia}</td><td class="p-1 font-mono ${cc(tIbarat)}">${tIbarat}</td><td class="p-1 font-mono ${cc(tTarjama)}">${tTarjama}</td><td class="p-1 font-mono ${cc(tSarf)}">${tSarf}</td><td class="p-1 font-mono ${cc(tNahw)}">${tNahw}</td><td class="p-1 font-mono ${cc(tAndaz)}">${tAndaz}</td><td class="p-1 font-bold bg-blue-50">${grandTotal}</td><td class="p-1 bg-blue-50">${percent.toFixed(1)}%</td><td class="p-1 font-bold ${cls}">${txt}</td></tr>`;
            });
        }
        window.exportResultToExcel = () => { const t=document.getElementById('result-table'); if(!t)return; const wb=XLSX.utils.table_to_book(t, {sheet:"Result"}); XLSX.writeFile(wb, "Result_Sheet.xlsx"); };

        // üî• UPDATED MUFATTISH TRACKING üî•
        window.renderMufattishStatus = () => {
            const tbody = document.getElementById('mufattish-status-tbody'); tbody.innerHTML = '';
            if (allMufattish.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">No Mufattish data.</td></tr>'; return; }
            
            allMufattish.forEach(m => {
                let groupsHtml = '';
                allGroups.forEach(g => {
                    [1, 2, 3, 4].forEach(round => {
                        if (g[`round_${round}_uid`] === m.id) {
                            const studentsInGroup = allStudents.filter(s => s.groupId === g.id);
                            const totalStu = studentsInGroup.length;
                            const filledCount = studentsInGroup.filter(s => {
                                const marks = s[`marks_r${round}`];
                                return marks && (marks.m1 || marks.m2 || marks.m3 || marks.m4 || marks.m5);
                            }).length;

                            let statusColor = 'bg-gray-100 text-gray-600 border-gray-200';
                            if (totalStu > 0 && filledCount === totalStu) statusColor = 'bg-green-100 text-green-700 border-green-200';
                            else if (filledCount > 0) statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-200';

                            groupsHtml += `<div class="mb-2 p-2 rounded border ${statusColor} text-sm flex justify-between items-center"><div><span class="font-bold">${g.groupName}</span> <span class="text-xs ml-1">(Sabaq ${round})</span></div><div class="font-mono font-bold">${filledCount} / ${totalStu}</div></div>`;
                        }
                    });
                });
                if (!groupsHtml) groupsHtml = '<span class="text-gray-400 italic text-xs">No active assignments</span>';
                tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 align-top"><td class="p-3 font-bold text-teal-800">${m.name}</td><td class="p-3 text-sm text-gray-600">${m.region || '-'}</td><td class="p-3">${groupsHtml}</td></tr>`;
            });
        };
    </script>
</body>
</html>
