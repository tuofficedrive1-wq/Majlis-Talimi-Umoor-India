<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Course Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
        }
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        .big-checkbox { width: 18px; height: 18px; cursor: pointer; }

        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-header { display: block !important; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60]"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="border-4 border-t-teal-600 rounded-full w-12 h-12 animate-spin"></div></div>

    <header class="bg-teal-800 text-white p-4 shadow-md sticky top-0 z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Tadrisi Admin (Batch System)</h1>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 px-4 py-1.5 rounded text-sm font-semibold">Logout</button>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[98%]">
        
        <div class="flex flex-wrap gap-2 mb-6 border-b pb-2 no-print">
            <button onclick="switchTab('students')" class="tab-btn active px-6 py-2 rounded-t-lg font-medium border" id="tab-students">1. Add & Assign Students</button>
            <button onclick="switchTab('groups')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-groups">2. Manage Groups</button>
            <button onclick="switchTab('results')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-results">3. View Results</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-mufattish">4. Mufattish List</button>
        </div>

        <div id="view-students" class="tab-content">
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-blue-600">
                <h3 class="text-lg font-bold mb-2 text-blue-800"><i class="fas fa-paste"></i> Step 1: Add New Students (Copy-Paste)</h3>
                <p class="text-xs text-gray-500 mb-2">Excel se copy karein aur yahan paste karein. <br>Format: <b>RegNo [TAB] Name [TAB] FatherName [TAB] Jamia [TAB] Mobile</b></p>
                
                <textarea id="paste-area" rows="5" class="w-full p-3 border rounded bg-gray-50 font-mono text-sm focus:ring-2 focus:ring-blue-500 whitespace-pre" placeholder="Example:&#10;101	Ali Khan	Ahmed	Jamia Ashrafia	9876543210&#10;102	Zaid	Bakr	Darul Uloom	9123456789"></textarea>
                
                <div class="flex gap-2 mt-3">
                    <button onclick="previewData()" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">Preview Data</button>
                    <button onclick="savePastedData()" id="save-btn" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 hidden">Save to Master List</button>
                </div>

                <div id="preview-container" class="hidden mt-4 border rounded overflow-hidden overflow-x-auto">
                    <table class="w-full text-left text-sm min-w-[800px]">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="p-2">Reg No</th>
                                <th class="p-2">Name</th>
                                <th class="p-2">Father Name</th>
                                <th class="p-2">Jamia</th>
                                <th class="p-2">Mobile</th>
                            </tr>
                        </thead>
                        <tbody id="preview-body" class="bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-orange-500">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-orange-800"><i class="fas fa-user-plus"></i> Step 2: Assign Students to Group</h3>
                    <div class="flex gap-2 mt-2 md:mt-0">
                        <select id="assign-group-select" class="p-2 border rounded urdu-font w-64">
                            <option value="">-- Select Group --</option>
                        </select>
                        <button onclick="assignSelectedStudents()" class="bg-orange-600 text-white px-4 py-2 rounded font-bold hover:bg-orange-700">Assign Selected</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[900px]">
                        <thead class="bg-orange-50 text-orange-900 text-sm">
                            <tr>
                                <th class="p-3 border-b w-10"><input type="checkbox" onchange="toggleAll(this)" class="big-checkbox"></th>
                                <th class="p-3 border-b w-16 text-center">Photo</th>
                                <th class="p-3 border-b">Reg No</th>
                                <th class="p-3 border-b">Name</th>
                                <th class="p-3 border-b">Father Name</th>
                                <th class="p-3 border-b">Jamia</th>
                                <th class="p-3 border-b">Mobile</th>
                                <th class="p-3 border-b text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="unassigned-tbody">
                            <tr><td colspan="8" class="p-4 text-center text-gray-400">Loading unassigned students...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-groups" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-teal-600">
                <h3 class="text-lg font-bold mb-4">Create New Group (Set 4 Rounds)</h3>
                <div class="flex flex-col gap-4">
                    <input type="text" id="new-group-name" placeholder="Group Name (e.g. Halqa 1)" class="w-full p-2 border rounded urdu-font">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <select id="mufattish-r1" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r2" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r3" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r4" class="p-2 border rounded text-sm bg-gray-50"></select>
                    </div>
                    <button onclick="createGroup()" class="bg-teal-600 text-white px-6 py-2 rounded font-bold w-full md:w-auto self-start">Create Group</button>
                </div>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-results" class="tab-content hidden">
            <div id="print-section">
                <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-purple-600 no-print">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Class Result Sheet</h3>
                        <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1 rounded text-sm"><i class="fas fa-print"></i> Print</button>
                    </div>
                    <select id="result-group-select" onchange="loadGroupResults()" class="w-full p-2 border rounded urdu-font bg-gray-50"></select>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden border p-4 min-h-[500px]">
                    <h2 class="text-2xl font-bold text-center mb-4 urdu-font hidden print-header" id="print-title">Result Sheet</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse text-sm min-w-[1000px]">
                            <thead class="bg-gray-100 text-gray-700 text-center border-b-2 border-gray-300">
                                <tr>
                                    <th class="p-2 border w-10">#</th>
                                    <th class="p-2 border w-12">Photo</th>
                                    <th class="p-2 border text-left">Details</th> <th class="p-2 border bg-blue-50 w-24">Round 1</th>
                                    <th class="p-2 border bg-green-50 w-24">Round 2</th>
                                    <th class="p-2 border bg-yellow-50 w-24">Round 3</th>
                                    <th class="p-2 border bg-purple-50 w-24">Round 4</th>
                                    <th class="p-2 border no-print w-16">Action</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-gray-600">
                <h3 class="text-lg font-bold mb-4">Registered Mufattish</h3>
                <table class="w-full text-left border-collapse"><tbody id="mufattish-table-body"></tbody></table>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish = [];
        let parsedStudents = [];

        const showLoader = (show) => document.getElementById('loader').classList.toggle('hidden', !show);
        const showToast = (msg, type='success') => { const el = document.getElementById('notification'); el.textContent = msg; el.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] ${type==='error'?'bg-red-500':'bg-emerald-600'}`; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3000); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const d = await getDoc(doc(db, 'users', user.uid));
                if(d.exists() && ['admin','tadrisi_course_management','tadrisi_course_admin'].includes(d.data().role)) {
                    await initData();
                } else window.location.href = 'index.html';
            } else window.location.href = 'index.html';
            showLoader(false);
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        window.switchTab = (tab) => { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`view-${tab}`).classList.remove('hidden'); 
            document.getElementById(`tab-${tab}`).classList.add('active'); 
        };

        async function initData() { 
            await fetchMufattishList(); 
            await fetchGroupsList();
            await fetchUnassignedStudents(); 
        }

        // --- 1. COPY PASTE LOGIC (UPDATED WITH 5 COLUMNS) ---
        window.previewData = () => {
            const text = document.getElementById('paste-area').value.trim();
            if(!text) return showToast('Please paste data first', 'error');

            const rows = text.split('\n');
            parsedStudents = [];
            let html = '';

            rows.forEach(row => {
                let cols = row.split('\t'); // Split by Tab
                let reg = cols[0] ? cols[0].trim() : '';
                let name = cols[1] ? cols[1].trim() : '';
                let father = cols[2] ? cols[2].trim() : '';
                let jamia = cols[3] ? cols[3].trim() : ''; // New
                let mobile = cols[4] ? cols[4].trim() : ''; // New

                if(name) { 
                    parsedStudents.push({ reg, name, father, jamia, mobile });
                    html += `
                        <tr class="border-b">
                            <td class="p-2">${reg}</td>
                            <td class="p-2 font-bold">${name}</td>
                            <td class="p-2">${father}</td>
                            <td class="p-2 text-xs text-gray-600">${jamia}</td>
                            <td class="p-2 text-xs text-gray-600">${mobile}</td>
                        </tr>`;
                }
            });

            document.getElementById('preview-body').innerHTML = html;
            document.getElementById('preview-container').classList.remove('hidden');
            if(parsedStudents.length > 0) {
                document.getElementById('save-btn').classList.remove('hidden');
                document.getElementById('save-btn').textContent = `Save ${parsedStudents.length} Students`;
            }
        };

        window.savePastedData = async () => {
            if(parsedStudents.length === 0) return;
            showLoader(true);
            try {
                const batch = writeBatch(db);
                parsedStudents.forEach(stu => {
                    const ref = doc(collection(db, 'tadrisi_students'));
                    batch.set(ref, {
                        regNo: stu.reg,
                        name: stu.name,
                        fatherName: stu.father,
                        jamia: stu.jamia,   // New
                        mobile: stu.mobile, // New
                        photoUrl: null,     // Placeholder for Photo
                        groupId: null, 
                        createdAt: new Date()
                    });
                });
                await batch.commit();
                showToast(`${parsedStudents.length} Students Added!`);
                document.getElementById('paste-area').value = '';
                document.getElementById('preview-container').classList.add('hidden');
                document.getElementById('save-btn').classList.add('hidden');
                await fetchUnassignedStudents(); 
            } catch(e) { console.error(e); showToast('Error saving data', 'error'); }
            finally { showLoader(false); }
        };

        // --- 2. ASSIGNMENT LOGIC ---
        async function fetchUnassignedStudents() {
            const tbody = document.getElementById('unassigned-tbody');
            const q = query(collection(db, 'tadrisi_students'), where('groupId', '==', null));
            const snap = await getDocs(q);

            tbody.innerHTML = '';
            if(snap.empty) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500">No unassigned students found. Paste new data above.</td></tr>';
                return;
            }

            snap.forEach(d => {
                const s = d.data();
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-orange-50 text-sm">
                        <td class="p-3"><input type="checkbox" class="student-checkbox big-checkbox" value="${d.id}"></td>
                        <td class="p-3 text-center"><i class="fas fa-user-circle text-2xl text-gray-300"></i></td>
                        <td class="p-3 text-gray-600">${s.regNo || '-'}</td>
                        <td class="p-3 font-bold urdu-font text-base">${s.name}</td>
                        <td class="p-3 urdu-font">${s.fatherName || '-'}</td>
                        <td class="p-3 urdu-font text-gray-600">${s.jamia || '-'}</td>
                        <td class="p-3 font-mono text-gray-600">${s.mobile || '-'}</td>
                        <td class="p-3 text-center"><span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">Unassigned</span></td>
                    </tr>`;
            });
        }

        window.toggleAll = (source) => document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = source.checked);

        window.assignSelectedStudents = async () => {
            const gid = document.getElementById('assign-group-select').value;
            if(!gid) return showToast('Please select a group first', 'error');
            const selected = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
            if(selected.length === 0) return showToast('No students selected', 'error');
            if(!confirm(`Assign ${selected.length} students to this group?`)) return;

            showLoader(true);
            try {
                const batch = writeBatch(db);
                selected.forEach(sid => {
                    const ref = doc(db, 'tadrisi_students', sid);
                    batch.update(ref, { groupId: gid });
                });
                const groupRef = doc(db, 'tadrisi_groups', gid);
                batch.update(groupRef, { totalStudents: increment(selected.length) });
                await batch.commit();
                showToast('Assigned Successfully!');
                await fetchUnassignedStudents(); await fetchGroupsList(); 
            } catch(e) { console.error(e); } finally { showLoader(false); }
        };

        // --- 3. COMMON LOGIC ---
        async function fetchMufattishList() {
            const q = query(collection(db, 'users'), where('role', '==', 'tadrisi_course_mufattish'));
            const snap = await getDocs(q);
            allMufattish = snap.docs.map(d => ({id:d.id, ...d.data()}));
            const options = '<option value="">-- Assign --</option>' + allMufattish.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            ['mufattish-r1', 'mufattish-r2', 'mufattish-r3', 'mufattish-r4'].forEach(id => document.getElementById(id).innerHTML = options);
            document.getElementById('mufattish-table-body').innerHTML = allMufattish.map(m => `<tr class="border-b"><td class="p-2">${m.name}</td><td class="p-2">${m.email}</td><td class="p-2">${m.region||'-'}</td></tr>`).join('');
        }

        async function fetchGroupsList() {
            const q = query(collection(db, 'tadrisi_groups'));
            const snap = await getDocs(q);
            const groups = snap.docs.map(d => ({id:d.id, ...d.data()}));
            const options = '<option value="">-- Select Group --</option>' + groups.map(g => `<option value="${g.id}">${g.groupName} (${g.totalStudents||0})</option>`).join('');
            document.getElementById('assign-group-select').innerHTML = options;
            document.getElementById('result-group-select').innerHTML = options;

            const c = document.getElementById('groups-list-container'); c.innerHTML='';
            const getName = (uid) => { const m = allMufattish.find(x => x.id === uid); return m ? m.name : 'Pending'; };
            groups.forEach(g => {
                c.innerHTML += `
                    <div class="bg-white p-4 shadow border rounded relative">
                        <h4 class="font-bold text-lg text-teal-800">${g.groupName}</h4>
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">Students: ${g.totalStudents||0}</span>
                        <div class="mt-2 text-xs text-gray-500 grid grid-cols-2 gap-1">
                            <div>R1: ${getName(g.round_1_uid)}</div><div>R2: ${getName(g.round_2_uid)}</div>
                            <div>R3: ${getName(g.round_3_uid)}</div><div>R4: ${getName(g.round_4_uid)}</div>
                        </div>
                        <button onclick="deleteGroup('${g.id}')" class="absolute top-2 right-2 text-red-400"><i class="fas fa-trash"></i></button>
                    </div>`;
            });
        }

        window.createGroup = async () => {
            const n = document.getElementById('new-group-name').value;
            const r1 = document.getElementById('mufattish-r1').value;
            const r2 = document.getElementById('mufattish-r2').value;
            const r3 = document.getElementById('mufattish-r3').value;
            const r4 = document.getElementById('mufattish-r4').value;
            if(!n || !r1) return showToast('Name and R1 required', 'error');
            await addDoc(collection(db, 'tadrisi_groups'), { groupName:n, totalStudents:0, round_1_uid:r1, round_2_uid:r2, round_3_uid:r3, round_4_uid:r4 });
            document.getElementById('new-group-name').value=''; await fetchGroupsList();
        };
        window.deleteGroup = async (id) => { if(confirm('Delete?')) { await deleteDoc(doc(db,'tadrisi_groups',id)); await fetchGroupsList(); }};

        // --- 4. RESULTS ---
        window.loadGroupResults = async () => {
            const gid = document.getElementById('result-group-select').value;
            if(!gid) return;
            const gText = document.getElementById('result-group-select').options[document.getElementById('result-group-select').selectedIndex].text;
            document.getElementById('print-title').textContent = gText + " - Result Sheet";

            const q = query(collection(db, 'tadrisi_students'), where('groupId', '==', gid));
            const snap = await getDocs(q);
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            let count = 1;
            snap.forEach(d => {
                const s = d.data();
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2 border text-center text-gray-500">${count++}</td>
                        <td class="p-2 border text-center"><i class="fas fa-user-circle text-2xl text-gray-300"></i></td>
                        <td class="p-2 border">
                            <div class="font-bold urdu-font text-base">${s.name}</div>
                            <div class="text-xs text-gray-500 urdu-font">${s.fatherName||''}</div>
                            <div class="text-xs text-gray-400 mt-1">${s.jamia || ''} <br> ${s.mobile || ''}</div>
                        </td>
                        <td class="p-2 border text-center bg-blue-50">${s.total_r1 || '-'}</td>
                        <td class="p-2 border text-center bg-green-50">${s.total_r2 || '-'}</td>
                        <td class="p-2 border text-center bg-yellow-50">${s.total_r3 || '-'}</td>
                        <td class="p-2 border text-center bg-purple-50">${s.total_r4 || '-'}</td>
                        <td class="p-2 border text-center no-print"><button onclick="deleteStudent('${d.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });
        };

        window.deleteStudent = async (id) => { if(confirm('Delete Student?')) { await deleteDoc(doc(db,'tadrisi_students',id)); await fetchUnassignedStudents(); await loadGroupResults(); }};
    </script>
</body>
</html>
