<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Admin (Fast Profile)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2'); }
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        .bg-fail { background-color: #fee2e2 !important; color: #b91c1c !important; }
        .bg-pass { background-color: #dcfce7 !important; color: #15803d !important; }
        
        /* Profile Modal Table */
        .profile-table th { background-color: #f0fdfa; color: #115e59; padding: 6px; font-size: 0.8rem; border: 1px solid #e5e7eb; }
        .profile-table td { padding: 6px; border: 1px solid #e5e7eb; text-align: center; font-size: 0.9rem; }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60]"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="text-center"><div class="border-4 border-t-teal-600 rounded-full w-10 h-10 animate-spin mx-auto mb-2"></div><p class="text-xs font-bold text-teal-800">Processing...</p></div></div>

    <header class="bg-white text-gray-800 p-3 shadow-sm sticky top-0 z-40 border-b border-gray-200 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold text-teal-800 flex items-center gap-2"><i class="fas fa-user-graduate"></i> Tadrisi Admin</h1>
            <button id="logout-btn" class="bg-red-50 text-red-600 px-3 py-1 rounded text-xs font-bold border border-red-200">Logout</button>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[98%]">
        
        <div class="flex flex-wrap gap-2 mb-4 border-b pb-2 no-print">
            <button onclick="switchTab('students')" class="tab-btn active px-4 py-2 rounded-t-lg font-medium border text-sm" id="tab-students">1. Students List</button>
            <button onclick="switchTab('groups')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border text-sm" id="tab-groups">2. Groups</button>
            <button onclick="switchTab('results')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border text-sm" id="tab-results">3. Final Result</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border text-sm" id="tab-mufattish">4. Mufattish</button>
        </div>

        <div id="view-students" class="tab-content">
            <div class="bg-white p-3 rounded shadow mb-4 border-l-4 border-teal-600 flex flex-col md:flex-row gap-2 items-end">
                <div class="flex-1 w-full">
                    <label class="text-xs text-gray-500">Jamia Name</label>
                    <input type="text" id="link-jamia-name" class="w-full p-1 border rounded urdu-font text-sm" placeholder="Pre-fill Jamia..." oninput="generateLink()">
                </div>
                <div class="flex-[2] w-full flex">
                    <input type="text" id="shareable-link" class="w-full p-1 border rounded-l bg-gray-50 text-xs text-gray-600" readonly>
                    <button onclick="copyLink()" class="bg-teal-600 text-white px-3 py-1 rounded-r font-bold text-xs">Copy Link</button>
                </div>
            </div>

            <div class="bg-white p-3 rounded shadow border-t-4 border-orange-500">
                <div class="flex flex-col md:flex-row justify-between items-end mb-2 gap-2">
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="student-filter-jamia" onchange="filterStudentsTable()" class="p-1 border rounded text-sm w-40 urdu-font"><option value="all">All Jamiaat</option></select>
                        <select id="student-filter-group" onchange="filterStudentsTable()" class="p-1 border rounded text-sm w-40"><option value="all">All Groups</option></select>
                        <button onclick="fetchAllStudents()" class="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-1 rounded text-xs font-bold"><i class="fas fa-sync"></i> Reload</button>
                    </div>
                    <div class="relative w-full md:w-auto">
                        <input type="text" id="search-input" oninput="filterStudentsTable()" class="p-1 pl-6 border rounded text-sm w-full" placeholder="Search...">
                        <i class="fas fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
                    </div>
                </div>

                <div class="overflow-x-auto min-h-[300px]">
                    <table class="w-full text-left border-collapse min-w-[900px]">
                        <thead class="bg-gray-100 text-gray-700 text-xs uppercase">
                            <tr>
                                <th class="p-2 border-b w-8 text-center">#</th>
                                <th class="p-2 border-b w-24 text-center">Profile</th>
                                <th class="p-2 border-b">Roll No</th>
                                <th class="p-2 border-b">Name / Father</th>
                                <th class="p-2 border-b">Jamia</th>
                                <th class="p-2 border-b">City</th>
                                <th class="p-2 border-b">Mobile</th>
                                <th class="p-2 border-b">Group</th>
                                <th class="p-2 border-b w-16">Del</th>
                            </tr>
                        </thead>
                        <tbody id="students-master-tbody" class="text-sm"><tr><td colspan="9" class="text-center p-4 text-gray-400">Loading...</td></tr></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-2 pt-2 border-t text-xs text-gray-500">
                    <span id="showing-text">0 students</span>
                    <div id="pagination-controls" class="flex gap-1"></div>
                </div>
            </div>
        </div>

        <div id="view-groups" class="tab-content hidden">
            <div class="bg-white p-4 rounded shadow mb-4 border-l-4 border-teal-600">
                <h3 class="font-bold mb-2 text-sm">Add Group</h3>
                <div class="flex flex-col gap-2">
                    <input type="text" id="new-group-name" placeholder="Group Name" class="w-full p-2 border rounded urdu-font text-sm">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <select id="mufattish-r1" class="p-1 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r2" class="p-1 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r3" class="p-1 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r4" class="p-1 border rounded text-xs bg-gray-50"></select>
                    </div>
                    <button onclick="createGroup()" class="bg-teal-600 text-white px-4 py-1 rounded font-bold text-sm w-max">Create</button>
                </div>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <div id="view-results" class="tab-content hidden">
            <div class="bg-white p-3 rounded shadow mb-4 border-l-4 border-purple-600 no-print">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-end">
                    <select id="result-group-select" onchange="loadGroupResults()" class="w-full p-1 border rounded text-sm bg-gray-50"><option value="">-- Select Group --</option></select>
                    <select id="filter-jamia" onchange="filterResults()" class="w-full p-1 border rounded urdu-font text-sm bg-gray-50"><option value="all">All Jamiaat</option></select>
                    <div class="flex gap-1">
                        <select id="history-select" class="p-1 border rounded text-xs bg-yellow-50 border-yellow-300 w-full" onchange="loadHistoryRecord()"><option value="">-- History --</option></select>
                        <input type="month" id="result-month-selector" class="w-24 p-1 border rounded text-xs">
                    </div>
                    <div class="flex gap-1">
                        <button onclick="saveResultToHistory()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold shadow">Save</button>
                        <button onclick="exportResultToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold shadow">Excel</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded shadow overflow-hidden border p-2 min-h-[400px]">
                <div class="text-center mb-2">
                    <h2 class="text-xl font-bold urdu-font">ÿ™ÿØÿ±€åÿ≥€å Ÿπ€åÿ≥Ÿπ ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å ŸÅÿßÿ±ŸÖ</h2>
                    <h3 class="text-md text-teal-700 font-bold" id="result-group-name">All Groups</h3>
                </div>
                <div class="overflow-x-auto pt-1">
                    <table class="w-full text-center border-collapse border border-gray-300 min-w-[1000px]" dir="rtl" id="result-table">
                        <thead class="bg-orange-50 text-gray-800 font-bold text-xs urdu-font">
                            <tr>
                                <th class="p-2 border w-8">#</th>
                                <th class="p-2 border w-16 text-center">Profile</th>
                                <th class="p-2 border w-40 text-right pr-2">Name</th>
                                <th class="p-2 border w-24">Jamia</th>
                                <th class="p-2 border bg-blue-50">Sabaq 1</th>
                                <th class="p-2 border bg-blue-50">Sabaq 2</th>
                                <th class="p-2 border bg-blue-50">Sabaq 3</th>
                                <th class="p-2 border bg-blue-50">Sabaq 4</th>
                                <th class="p-2 border bg-yellow-100">Total</th>
                                <th class="p-2 border bg-yellow-100">%</th>
                                <th class="p-2 border bg-orange-200">Result</th>
                                <th class="p-2 border w-24">Rem</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="text-sm urdu-font text-gray-700"><tr><td colspan="12" class="p-4 text-center text-gray-400">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-4 rounded shadow border-t-4 border-gray-600">
                <button onclick="renderMufattishStatus()" class="text-blue-600 hover:underline text-sm mb-2"><i class="fas fa-sync"></i> Refresh Status</button>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead class="bg-gray-100 text-gray-800 text-sm">
                            <tr><th class="p-2 border-b w-48">Mufattish</th><th class="p-2 border-b">Assigned Groups & Progress</th></tr>
                        </thead>
                        <tbody id="mufattish-status-tbody" class="text-sm"><tr><td colspan="2" class="p-4 text-center">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[70] p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl w-[700px] max-w-full relative overflow-hidden">
            <button onclick="closeProfileModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 bg-white rounded-full p-1 shadow"><i class="fas fa-times text-xl"></i></button>
            <input type="hidden" id="pm-student-id">
            
            <div class="flex flex-col md:flex-row bg-teal-50 p-4 border-b border-teal-100">
                <div class="w-full md:w-1/4 flex justify-center mb-2 md:mb-0">
                    <img id="pm-image" src="" class="w-24 h-24 rounded-full border-4 border-white shadow-md object-cover bg-gray-200">
                </div>
                <div class="w-full md:w-3/4 text-center md:text-left md:pl-4">
                    <h2 id="pm-name" class="text-xl font-bold text-teal-800 urdu-font">Student Name</h2>
                    <p id="pm-father" class="text-sm text-gray-600 urdu-font">Father Name</p>
                    <div class="grid grid-cols-2 gap-1 text-xs mt-2 text-gray-700">
                        <p><i class="fas fa-id-card text-teal-500"></i> <span id="pm-roll"></span></p>
                        <p><i class="fas fa-phone text-teal-500"></i> <span id="pm-mobile"></span></p>
                        <p class="col-span-2"><i class="fas fa-mosque text-teal-500"></i> <span id="pm-jamia" class="urdu-font"></span></p>
                    </div>
                    <button onclick="openEditModalFromProfile()" class="mt-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"><i class="fas fa-edit"></i> Edit Details</button>
                </div>
            </div>

            <div class="p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-md text-gray-800">Result Detail</h3>
                    <span id="pm-result-status" class="px-2 py-0.5 rounded text-xs font-bold"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center border-collapse profile-table" dir="rtl">
                        <thead>
                            <tr>
                                <th>ÿ≥ÿ®ŸÇ</th>
                                <th>ÿπÿ®ÿßÿ±ÿ™</th><th>ÿ™ÿ±ÿ¨ŸÖ€Å</th><th>ÿµÿ±ŸÅ</th><th>ŸÜÿ≠Ÿà</th><th>ÿßŸÜÿØÿßÿ≤</th>
                                <th class="bg-yellow-50">⁄©ŸÑ</th>
                            </tr>
                        </thead>
                        <tbody id="pm-marks-body" class="urdu-font"></tbody>
                    </table>
                </div>
                
                <div class="mt-4 bg-yellow-50 p-3 rounded border border-yellow-200">
                    <h4 class="font-bold text-xs mb-2 text-yellow-800">Final Adjustments (Grace Marks)</h4>
                    <div class="grid grid-cols-5 gap-1 mb-2">
                        <input type="number" id="grace-m1" class="border p-1 text-center text-xs rounded" placeholder="+Ib">
                        <input type="number" id="grace-m2" class="border p-1 text-center text-xs rounded" placeholder="+Tr">
                        <input type="number" id="grace-m3" class="border p-1 text-center text-xs rounded" placeholder="+Sr">
                        <input type="number" id="grace-m4" class="border p-1 text-center text-xs rounded" placeholder="+Nh">
                        <input type="number" id="grace-m5" class="border p-1 text-center text-xs rounded" placeholder="+An">
                    </div>
                    <textarea id="pm-final-remarks" rows="1" class="w-full p-2 border rounded text-xs urdu-font mb-2" placeholder="Final Remarks..."></textarea>
                    <button onclick="saveProfileChanges()" class="w-full bg-teal-600 text-white py-1 rounded text-sm font-bold hover:bg-teal-700">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80]">
        <div class="bg-white p-5 rounded w-80">
            <h3 class="font-bold mb-3">Edit Info</h3>
            <input type="hidden" id="edit-id">
            <input id="edit-reg" class="w-full border p-1 mb-2 text-sm" placeholder="Roll No">
            <input id="edit-name" class="w-full border p-1 mb-2 text-sm" placeholder="Name">
            <input id="edit-father" class="w-full border p-1 mb-2 text-sm" placeholder="Father">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-3 py-1 bg-gray-200 rounded text-sm">Cancel</button>
                <button onclick="saveEditedStudent()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Update</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish=[], allGroups=[], allStudents=[], filteredList=[], currentPage=1, rowsPerPage=50;

        const showLoader=(s)=>document.getElementById('loader').classList.toggle('hidden',!s);
        const showToast=(m,t='success')=>{const e=document.getElementById('notification');e.textContent=m;e.className=`fixed top-5 right-5 text-white py-2 px-4 rounded shadow-lg z-[60] text-sm ${t==='error'?'bg-red-500':'bg-teal-600'}`;e.classList.remove('hidden');setTimeout(()=>e.classList.add('hidden'),2500);};

        onAuthStateChanged(auth, async (u)=>{ if(u){ const d=await getDoc(doc(db,'users',u.uid)); if(d.exists()&&['admin','tadrisi_course_management','tadrisi_course_admin'].includes(d.data().role))await initData(); else location.href='index.html'; }else location.href='index.html'; showLoader(false); });
        document.getElementById('logout-btn').addEventListener('click',()=>signOut(auth));
        window.switchTab=(t)=>{ document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${t}`).classList.remove('hidden'); document.getElementById(`tab-${t}`).classList.add('active'); };

        async function initData() { await fetchMufattishList(); await fetchGroupsList(); await fetchAllStudents(); await fetchHistoryList(); generateLink(); }
        
        async function fetchMufattishList() { 
            const s=await getDocs(query(collection(db,'users'),where('role','==','tadrisi_course_mufattish'))); 
            allMufattish=s.docs.map(d=>({id:d.id,...d.data()})); 
            const o='<option value="">-- Select --</option>'+allMufattish.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); 
            ['mufattish-r1','mufattish-r2','mufattish-r3','mufattish-r4'].forEach(i=>{ const el=document.getElementById(i); if(el) el.innerHTML=o; }); 
        }
        
        async function fetchGroupsList() { 
            const s=await getDocs(query(collection(db,'tadrisi_groups'))); 
            allGroups=s.docs.map(d=>({id:d.id,...d.data()})); allGroups.sort((a,b)=>a.groupName.localeCompare(b.groupName,undefined,{numeric:true})); 
            document.getElementById('groups-list-container').innerHTML=allGroups.map(g=>`<div class="bg-white p-3 shadow border rounded"><h4 class="font-bold text-teal-800 text-sm">${g.groupName}</h4><span class="text-xs bg-gray-100 px-1 rounded">Students: ${g.totalStudents||0}</span><button onclick="deleteGroup('${g.id}')" class="float-right text-red-400 text-xs"><i class="fas fa-trash"></i></button></div>`).join(''); 
            populateGroupDropdowns(); 
        }
        
        async function fetchHistoryList() { 
            try{ const s=await getDocs(query(collection(db,'tadrisi_history'))); 
            const o='<option value="">-- History --</option>'+s.docs.map(d=>`<option value="${d.id}">${d.id.replace('_',' - ')}</option>`).join(''); 
            document.getElementById('history-select').innerHTML=o; }catch(e){} 
        }

        window.fetchAllStudents = async () => { 
            showLoader(true); 
            try{ const s=await getDocs(query(collection(db,'tadrisi_students'))); 
            allStudents=s.docs.map(d=>({id:d.id,...d.data()})); allStudents.sort((a,b)=>(!a.groupId&&b.groupId)?-1:0); 
            filteredList=allStudents; filterStudentsTable(); populateJamiaFilter(); showToast('Data Loaded'); }catch(e){console.error(e);}finally{showLoader(false);}
        };

        window.filterStudentsTable = () => { 
            const j=document.getElementById('student-filter-jamia').value; 
            const g=document.getElementById('student-filter-group').value; 
            const t=document.getElementById('search-input').value.toLowerCase();
            
            filteredList = allStudents.filter(s => {
                const mj = j==='all' || s.jamia===j;
                const mg = g==='all' || (g==='unassigned'?!s.groupId:s.groupId===g) || (!g);
                const mt = !t || (s.name && s.name.toLowerCase().includes(t)) || (s.regNo && s.regNo.includes(t));
                return mj && mg && mt;
            });
            currentPage=1; renderStudentsTable(); 
        };

        function renderStudentsTable() {
            const tb=document.getElementById('students-master-tbody'); tb.innerHTML='';
            if(filteredList.length===0){ tb.innerHTML='<tr><td colspan="9" class="p-4 text-center text-gray-400">No data.</td></tr>'; return; }
            const st=(currentPage-1)*rowsPerPage, en=st+rowsPerPage;
            filteredList.slice(st,en).forEach((s,i)=>{
                const grp=allGroups.find(x=>x.id===s.groupId);
                const gName=grp?grp.groupName:'<span class="text-red-500">Unassigned</span>';
                tb.innerHTML+=`<tr class="border-b text-sm hover:bg-gray-50 align-middle"><td class="p-2 text-center text-gray-400 text-xs">${st+i+1}</td><td class="p-2 text-center"><button class="bg-teal-100 text-teal-700 px-2 py-1 rounded text-xs font-bold hover:bg-teal-200" onclick="openProfileModal('${s.id}')"><i class="fas fa-id-card"></i> View</button></td><td class="p-2 font-mono font-bold">${s.regNo||'-'}</td><td class="p-2 font-bold urdu-font">${s.name}<br><span class="text-xs text-gray-500 font-normal">${s.fatherName}</span></td><td class="p-2 urdu-font text-xs">${s.jamia||'-'}</td><td class="p-2 urdu-font text-xs">${s.city||'-'}</td><td class="p-2 font-mono text-xs">${s.mobile||'-'}</td><td class="p-2 text-xs">${gName}</td><td class="p-2"><button onclick="deleteStudent('${s.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            document.getElementById('showing-text').innerText=`${filteredList.length} Students`;
            const tp=Math.ceil(filteredList.length/rowsPerPage);
            let b=''; if(tp>1){ b+=`<button onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''} class="px-2 border mx-1 text-xs"><</button> ${currentPage}/${tp} <button onclick="changePage(${currentPage+1})" ${currentPage===tp?'disabled':''} class="px-2 border mx-1 text-xs">></button>`; }
            document.getElementById('pagination-controls').innerHTML=b;
        }
        window.changePage=(p)=>{ const t=Math.ceil(filteredList.length/rowsPerPage); if(p<1||p>t)return; currentPage=p; renderStudentsTable(); };

        // Result Table (Only Logic for Displaying Rows efficiently)
        window.loadGroupResults = () => { filterResults(); }; 
        window.filterResults = () => {
            const gid=document.getElementById('result-group-select').value;
            const j=document.getElementById('filter-jamia').value;
            let list = allStudents;
            if(gid && gid!=='all') list = list.filter(s => s.groupId === gid);
            if(j && j!=='all') list = list.filter(s => s.jamia === j);
            renderResultTable(list);
        };

        function renderResultTable(list) {
            const tb=document.getElementById('results-tbody'); tb.innerHTML='';
            if(list.length===0){ tb.innerHTML='<tr><td colspan="12" class="p-4 text-center text-gray-400">No results.</td></tr>'; return; }
            let count=1;
            list.forEach(s=>{
                const gm=(r,k)=>(r&&r[k])?Number(r[k]):0;
                const gr=s.grace_marks||{}; const g1=Number(gr.m1)||0,g2=Number(gr.m2)||0,g3=Number(gr.m3)||0,g4=Number(gr.m4)||0,g5=Number(gr.m5)||0;
                const m1=gm(s.marks_r1,'m1')+gm(s.marks_r2,'m1')+gm(s.marks_r3,'m1')+gm(s.marks_r4,'m1')+g1;
                const m2=gm(s.marks_r1,'m2')+gm(s.marks_r2,'m2')+gm(s.marks_r3,'m2')+gm(s.marks_r4,'m2')+g2;
                const m3=gm(s.marks_r1,'m3')+gm(s.marks_r2,'m3')+gm(s.marks_r3,'m3')+gm(s.marks_r4,'m3')+g3;
                const m4=gm(s.marks_r1,'m4')+gm(s.marks_r2,'m4')+gm(s.marks_r3,'m4')+gm(s.marks_r4,'m4')+g4;
                const m5=gm(s.marks_r1,'m5')+gm(s.marks_r2,'m5')+gm(s.marks_r3,'m5')+gm(s.marks_r4,'m5')+g5;
                const gt=m1+m2+m3+m4+m5; const pct=(gt/400)*100; const fail=(m1<56||m2<56||m3<56||m4<56||m5<56);
                let txt="Fail",cls="bg-fail"; if(!fail&&gt>0){ if(pct>=90){txt="Mumtaz";cls="bg-pass";}else if(pct>=80){txt="Behtar";cls="bg-pass";}else if(pct>=70){txt="Munasib";cls="bg-pass";} } if(gt===0){txt="-";cls="";}
                
                tb.innerHTML+=`<tr class="border-b hover:bg-gray-50 text-xs"><td class="p-1 border">${count++}</td><td class="p-1 border text-center"><button class="bg-teal-50 text-teal-700 px-2 rounded border border-teal-200 font-bold" onclick="openProfileModal('${s.id}')">View</button></td><td class="p-1 border text-right font-bold">${s.name}</td><td class="p-1 border text-[10px]">${s.jamia}</td><td class="p-1 border text-center">${m1}</td><td class="p-1 border text-center">${m2}</td><td class="p-1 border text-center">${m3}</td><td class="p-1 border text-center">${m4}</td><td class="p-1 border text-center">${m5}</td><td class="p-1 border font-bold bg-yellow-50">${gt}</td><td class="p-1 border bg-yellow-50">${pct.toFixed(1)}%</td><td class="p-1 border font-bold ${cls}">${txt}</td><td class="p-1 border text-[10px]">${s.final_remarks||'-'}</td></tr>`;
            });
        }

        // üî• PROFILE MODAL (MAIN FEATURE) üî•
        window.openProfileModal=(sid)=>{
            const s=allStudents.find(x=>x.id===sid); if(!s)return;
            document.getElementById('pm-student-id').value=sid;
            document.getElementById('pm-image').src=s.photoBase64||'https://placehold.co/150x150/e2e8f0/94a3b8?text=No+Img';
            document.getElementById('pm-name').textContent=s.name; document.getElementById('pm-father').textContent=s.fatherName;
            document.getElementById('pm-roll').textContent=s.regNo||'-'; document.getElementById('pm-mobile').textContent=s.mobile||'-';
            document.getElementById('pm-jamia').textContent=s.jamia||'-'; document.getElementById('pm-final-remarks').value=s.final_remarks||'';
            
            const gr=s.grace_marks||{}; [1,2,3,4,5].forEach(i=>document.getElementById(`grace-m${i}`).value=gr[`m${i}`]||'');
            
            const tb=document.getElementById('pm-marks-body'); tb.innerHTML='';
            const gm=(r,k)=>(r&&r[k])?Number(r[k]):0; let gt=0;
            
            [1,2,3,4].forEach(i=>{
                const r=s[`marks_r${i}`]||{}; const t=gm(r,'m1')+gm(r,'m2')+gm(r,'m3')+gm(r,'m4')+gm(r,'m5'); gt+=t;
                tb.innerHTML+=`<tr class="bg-white"><td>Sabaq ${i}</td><td>${gm(r,'m1')}</td><td>${gm(r,'m2')}</td><td>${gm(r,'m3')}</td><td>${gm(r,'m4')}</td><td>${gm(r,'m5')}</td><td class="font-bold bg-yellow-50">${t}</td></tr>`;
            });
            const grT = (Number(gr.m1)||0)+(Number(gr.m2)||0)+(Number(gr.m3)||0)+(Number(gr.m4)||0)+(Number(gr.m5)||0);
            if(grT>0) tb.innerHTML+=`<tr class="bg-green-50 font-bold text-green-700"><td>Grace</td><td>+${gr.m1||0}</td><td>+${gr.m2||0}</td><td>+${gr.m3||0}</td><td>+${gr.m4||0}</td><td>+${gr.m5||0}</td><td>+${grT}</td></tr>`;
            
            gt+=grT; const p=(gt/400)*100;
            const b=document.getElementById('pm-result-status');
            if(gt===0){ b.textContent="Pending"; b.className="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded"; }
            else if(p>=70){ b.textContent=`PASS (${p.toFixed(1)}%)`; b.className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded border border-green-200 font-bold"; }
            else { b.textContent=`FAIL (${p.toFixed(1)}%)`; b.className="px-2 py-1 bg-red-100 text-red-800 text-xs rounded border border-red-200 font-bold"; }
            
            document.getElementById('profile-modal').classList.remove('hidden');
        };
        window.closeProfileModal=()=>document.getElementById('profile-modal').classList.add('hidden');

        window.saveProfileChanges=async()=>{
            const sid=document.getElementById('pm-student-id').value;
            const gr={}; [1,2,3,4,5].forEach(i=>gr[`m${i}`]=Number(document.getElementById(`grace-m${i}`).value)||0);
            const rm=document.getElementById('pm-final-remarks').value;
            try{ await updateDoc(doc(db,'tadrisi_students',sid),{grace_marks:gr,final_remarks:rm});
                 const idx=allStudents.findIndex(x=>x.id===sid); if(idx>-1){ allStudents[idx].grace_marks=gr; allStudents[idx].final_remarks=rm; }
                 showToast('Saved'); openProfileModal(sid); filterResults();
            }catch(e){ showToast('Error','error'); }
        };

        window.openEditModalFromProfile=()=>{ 
            const sid=document.getElementById('pm-student-id').value; const s=allStudents.find(x=>x.id===sid);
            document.getElementById('edit-id').value=sid; document.getElementById('edit-reg').value=s.regNo; 
            document.getElementById('edit-name').value=s.name; document.getElementById('edit-father').value=s.fatherName;
            document.getElementById('edit-modal').classList.remove('hidden');
        };
        window.saveEditedStudent=async()=>{
            const sid=document.getElementById('edit-id').value;
            const u={regNo:document.getElementById('edit-reg').value, name:document.getElementById('edit-name').value, fatherName:document.getElementById('edit-father').value};
            await updateDoc(doc(db,'tadrisi_students',sid),u);
            const idx=allStudents.findIndex(x=>x.id===sid); if(idx>-1){ Object.assign(allStudents[idx],u); }
            document.getElementById('edit-modal').classList.add('hidden'); openProfileModal(sid); filterStudentsTable(); showToast('Updated');
        };

        // Utility
        window.populateJamiaFilter=()=>{ const s=new Set(allStudents.map(x=>x.jamia).filter(j=>j)); const f=document.getElementById('student-filter-jamia'); const f2=document.getElementById('filter-jamia'); f.innerHTML='<option value="all">All Jamiaat</option>'; f2.innerHTML=f.innerHTML; s.forEach(j=>{ const o=`<option value="${j}">${j}</option>`; f.innerHTML+=o; f2.innerHTML+=o; }); };
        window.populateGroupDropdowns=()=>{ const o='<option value="all">All Groups</option>'+allGroups.map(g=>`<option value="${g.id}">${g.groupName}</option>`).join(''); document.getElementById('student-filter-group').innerHTML=o; document.getElementById('result-group-select').innerHTML=o; };
        window.generateLink=()=>{const j=document.getElementById('link-jamia-name').value.trim();document.getElementById('shareable-link').value=j?`${location.href.substring(0,location.href.lastIndexOf('/'))}/tadrisi_student_form.html?jamia=${encodeURIComponent(j)}`:location.href;};
        window.copyLink=()=>{document.getElementById('shareable-link').select();document.execCommand('copy');showToast('Copied');};
        window.exportResultToExcel=()=>{const t=document.getElementById('result-table');if(!t)return;const wb=XLSX.utils.table_to_book(t,{sheet:"Result"});XLSX.writeFile(wb,"Result.xlsx");};
        window.deleteStudent=async(id)=>{if(confirm('Delete?')){await deleteDoc(doc(db,'tadrisi_students',id)); allStudents=allStudents.filter(x=>x.id!==id); filterStudentsTable();}};
        window.createGroup=async()=>{const n=document.getElementById('new-group-name').value;if(!n)return;await addDoc(collection(db,'tadrisi_groups'),{groupName:n,totalStudents:0}); document.getElementById('new-group-name').value=''; fetchGroupsList();};
        window.renderMufattishStatus = () => { const tbody = document.getElementById('mufattish-status-tbody'); tbody.innerHTML = ''; allMufattish.forEach(m => { let html = ''; allGroups.forEach(g => { [1, 2, 3, 4].forEach(r => { if (g[`round_${r}_uid`] === m.id) { const stInG = allStudents.filter(s => s.groupId === g.id); const filled = stInG.filter(s => s[`marks_r${r}`] && s[`marks_r${r}`].m1).length; const total = stInG.length; let cls = 'text-red-500'; if(total>0 && filled===total) cls='text-green-600 font-bold'; else if(filled>0) cls='text-yellow-600 font-bold'; html += `<span class="mr-2 mb-1 inline-block border rounded px-1 bg-gray-50 text-xs">${g.groupName}-S${r}: <b class="${cls}">${filled}/${total}</b></span>`; } }); }); tbody.innerHTML += `<tr class="border-b"><td class="p-3 font-bold text-sm">${m.name}</td><td class="p-3 text-xs">${html||'-'}</td></tr>`; }); };
    </script>
</body>
</html>
