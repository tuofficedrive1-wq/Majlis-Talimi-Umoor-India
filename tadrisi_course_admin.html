<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
        }
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        .big-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: #0f766e; }

        .status-complete { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status-pending { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .status-ongoing { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .bg-fail { background-color: #ef4444 !important; color: white !important; }
        .bg-pass { background-color: #ecfccb !important; color: #1e293b !important; }
        .bg-header { background-color: #fef3c7 !important; }

        .student-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60]"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="border-4 border-t-teal-600 rounded-full w-12 h-12 animate-spin"></div></div>

    <header class="bg-teal-800 text-white p-4 shadow-md sticky top-0 z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Tadrisi Admin System</h1>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 px-4 py-1.5 rounded text-sm font-semibold">Logout</button>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[98%]">
        
        <div class="flex flex-wrap gap-2 mb-6 border-b pb-2 no-print">
            <button onclick="switchTab('students')" class="tab-btn active px-6 py-2 rounded-t-lg font-medium border" id="tab-students">1. Students & Link</button>
            <button onclick="switchTab('groups')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-groups">2. Manage Groups</button>
            <button onclick="switchTab('results')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-results">3. Final Result</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-mufattish">4. Mufattish Status</button>
        </div>

        <div id="view-students" class="tab-content">
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-teal-600">
                <h3 class="text-lg font-bold text-teal-800 mb-2"><i class="fas fa-link mr-2"></i> Share Data Entry Link</h3>
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="text-xs text-gray-500">Jamia Name (Pre-fill)</label>
                        <input type="text" id="link-jamia-name" class="w-full p-2 border rounded urdu-font" placeholder="Jamia ka naam..." oninput="generateLink()">
                    </div>
                    <div class="flex-[2] w-full relative">
                        <div class="flex">
                            <input type="text" id="shareable-link" class="w-full p-2 border rounded-l bg-gray-50 text-sm text-gray-600" readonly>
                            <button onclick="copyLink()" class="bg-teal-600 text-white px-4 py-2 rounded-r hover:bg-teal-700 font-bold whitespace-nowrap">Copy Link</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-orange-500">
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <div class="w-full md:w-auto">
                        <h3 class="text-lg font-bold text-orange-800 flex items-center gap-2 mb-2">
                            <i class="fas fa-users"></i> All Students List 
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="fetchAllStudents()" class="bg-teal-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-teal-700 shadow flex items-center gap-2">
                                <i class="fas fa-sync-alt"></i> Refresh List
                            </button>
                            <button onclick="exportStudentList()" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-green-700 shadow flex items-center gap-2">
                                <i class="fas fa-file-excel"></i> Download Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-2 w-full md:w-2/3">
                        <div class="flex-1">
                            <label class="text-xs text-gray-500 font-bold">Filter by Jamia</label>
                            <select id="student-filter-jamia" onchange="filterStudents()" class="w-full p-2 border rounded urdu-font bg-gray-50 focus:ring-2 focus:ring-orange-300">
                                <option value="">All Jamiaat</option>
                            </select>
                        </div>
                        <div class="flex-[2] relative">
                            <label class="text-xs text-gray-500 font-bold">Search Student</label>
                            <input type="text" id="search-input" oninput="filterStudents()" class="w-full p-2 pl-10 border rounded bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-300 transition" placeholder="Search Name, Roll No, City...">
                            <i class="fas fa-search absolute left-3 top-8 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div id="bulk-action-bar" class="hidden bg-orange-50 p-3 rounded border border-orange-200 mb-4 flex flex-col md:flex-row justify-between items-center gap-2">
                    <span class="font-bold text-orange-800"><span id="selected-count">0</span> Selected</span>
                    <div class="flex gap-2">
                        <select id="bulk-group-select" class="p-2 border rounded text-sm flex-1 md:w-64"><option value="">-- Assign Group --</option></select>
                        <button onclick="bulkAssignGroup()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700">Assign</button>
                        <button onclick="bulkDeleteStudents()" class="bg-red-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-red-700"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto max-h-[600px] overflow-y-auto border rounded">
                    <table class="w-full text-left border-collapse min-w-[1100px]" id="students-table">
                        <thead class="bg-orange-50 text-orange-900 text-sm sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-3 border-b w-10 text-center"><input type="checkbox" onchange="toggleSelectAll(this)" class="big-checkbox"></th>
                                <th class="p-3 border-b w-10">#</th>
                                <th class="p-3 border-b w-16 text-center">Photo</th>
                                <th class="p-3 border-b">Roll No</th>
                                <th class="p-3 border-b">Name</th>
                                <th class="p-3 border-b">Father Name</th>
                                <th class="p-3 border-b">Jamia</th>
                                <th class="p-3 border-b">City</th>
                                <th class="p-3 border-b text-teal-700">Mobile</th>
                                <th class="p-3 border-b">Group</th>
                                <th class="p-3 border-b">Action</th>
                            </tr>
                        </thead>
                        <tbody id="students-master-tbody">
                            <tr><td colspan="11" class="p-4 text-center text-gray-400">Loading... Click Refresh if not loaded.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-groups" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-teal-600">
                <h3 class="text-lg font-bold mb-4">Create New Group</h3>
                <div class="flex flex-col gap-4">
                    <input type="text" id="new-group-name" placeholder="Group Name" class="w-full p-2 border rounded urdu-font">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <select id="mufattish-r1" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r2" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r3" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r4" class="p-2 border rounded text-sm bg-gray-50"></select>
                    </div>
                    <button onclick="createGroup()" class="bg-teal-600 text-white px-6 py-2 rounded font-bold w-full md:w-auto self-start">Create Group</button>
                </div>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-results" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-purple-600 no-print">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Result Filters</h3>
                    <button onclick="exportResultToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold shadow flex items-center"><i class="fas fa-file-excel mr-2"></i> Download Result Excel</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="result-group-select" onchange="loadGroupResults()" class="w-full p-2 border rounded urdu-font bg-gray-50"><option value="">-- Select Group --</option></select>
                    <input type="month" id="result-month-selector" class="w-full p-2 border rounded bg-gray-50" onchange="updateHeaderDate()">
                    <select id="filter-jamia" onchange="filterResults()" class="w-full p-2 border rounded urdu-font bg-gray-50"><option value="all">All Jamiaat</option></select>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden border p-2 min-h-[500px]">
                <div class="text-center mb-6 pt-4">
                    <h2 class="text-3xl font-bold urdu-font">ÿ™ÿØÿ±€åÿ≥€å Ÿπ€åÿ≥Ÿπ ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å ŸÅÿßÿ±ŸÖ</h2>
                    <p class="text-gray-600 mt-1" id="result-header-date">Month: -- | Year: --</p>
                    <h3 class="text-xl text-teal-700 font-bold mt-2" id="result-group-name"></h3>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-center border-collapse border border-gray-400 min-w-[1200px]" dir="rtl" id="result-table"><thead class="bg-orange-100 text-gray-900 font-bold text-base urdu-font"><tr><th class="p-2 border border-gray-400 w-10">ŸÜŸÖÿ®ÿ±<br>ÿ¥ŸÖÿßÿ±</th><th class="p-2 border border-gray-400 w-48 text-right pr-4">ŸÜÿßŸÖ ŸÖÿπ ŸàŸÑÿØ€åÿ™</th><th class="p-2 border border-gray-400 w-32">ÿ¨ÿßŸÖÿπ€Å</th><th class="p-2 border border-gray-400 w-16 bg-header">ÿπÿ®ÿßÿ±ÿ™<br><span class="text-xs font-normal font-sans">(80)</span></th><th class="p-2 border border-gray-400 w-16 bg-header">ÿ™ÿ±ÿ¨ŸÖ€Å<br><span class="text-xs font-normal font-sans">(80)</span></th><th class="p-2 border border-gray-400 w-16 bg-header">ÿµÿ±ŸÅ<br><span class="text-xs font-normal font-sans">(80)</span></th><th class="p-2 border border-gray-400 w-16 bg-header">ŸÜÿ≠Ÿà<br><span class="text-xs font-normal font-sans">(80)</span></th><th class="p-2 border border-gray-400 w-16 bg-header">ÿßŸÜÿØÿßÿ≤ ÿ™ŸÅ€Å€åŸÖ<br><span class="text-xs font-normal font-sans">(80)</span></th><th class="p-2 border border-gray-400 w-20 bg-blue-50">ÿ≠ÿßÿµŸÑ ⁄©ÿ±ÿØ€Å<br>⁄©ŸÑ ŸÜŸÖÿ®ÿ±</th><th class="p-2 border border-gray-400 w-16 bg-blue-50">ŸÅ€åÿµÿØ</th><th class="p-2 border border-gray-400 w-24 bg-orange-200">⁄©€åŸÅ€åÿ™</th></tr></thead><tbody id="results-tbody" class="text-lg urdu-font text-gray-800"><tr><td colspan="11" class="p-8 text-gray-400">Select Group</td></tr></tbody></table></div>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-gray-600">
                <h3 class="text-lg font-bold mb-4">Mufattish Status (Live Tracking)</h3>
                <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-800"><tr><th class="p-3 border-b">Mufattish Name</th><th class="p-3 border-b">Region</th><th class="p-3 border-b">Assigned Groups & Status</th></tr></thead><tbody id="mufattish-status-tbody"></tbody></table></div>
            </div>
        </div>

    </main>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96 max-w-full">
            <h3 class="text-lg font-bold mb-4 text-teal-800 border-b pb-2">Edit Student</h3>
            <input type="hidden" id="edit-student-id">
            <div class="space-y-3">
                <div><label class="text-xs font-bold text-gray-600">Roll No</label><input type="text" id="edit-reg" class="w-full p-2 border rounded font-mono"></div>
                <div><label class="text-xs font-bold text-gray-600">Name</label><input type="text" id="edit-name" class="w-full p-2 border rounded urdu-font"></div>
                <div><label class="text-xs font-bold text-gray-600">Father Name</label><input type="text" id="edit-father" class="w-full p-2 border rounded urdu-font"></div>
                <div><label class="text-xs font-bold text-gray-600">Jamia</label><input type="text" id="edit-jamia" class="w-full p-2 border rounded urdu-font"></div>
                <div><label class="text-xs font-bold text-gray-600">City</label><input type="text" id="edit-city" class="w-full p-2 border rounded urdu-font"></div>
                <div><label class="text-xs font-bold text-gray-600">Mobile</label><input type="text" id="edit-mobile" class="w-full p-2 border rounded font-mono"></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded text-sm">Cancel</button>
                <button onclick="saveEditedStudent()" class="px-6 py-2 bg-teal-600 text-white rounded text-sm font-bold hover:bg-teal-700">Update</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h3 class="text-lg font-bold mb-4">Transfer Student</h3>
            <p id="transfer-student-name" class="mb-4 text-sm text-gray-600"></p>
            <input type="hidden" id="transfer-student-id"><input type="hidden" id="transfer-old-group-id">
            <label class="block text-sm mb-1">New Group</label>
            <select id="transfer-group-select" class="w-full p-2 border rounded mb-4"></select>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('transfer-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                <button onclick="confirmTransfer()" class="px-4 py-2 bg-blue-600 text-white rounded">Transfer</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish = [], allGroups = [], allStudents = [];

        const showLoader = (show) => document.getElementById('loader').classList.toggle('hidden', !show);
        const showToast = (msg, type='success') => { const el = document.getElementById('notification'); el.textContent = msg; el.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] ${type==='error'?'bg-red-500':'bg-emerald-600'}`; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3000); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const d = await getDoc(doc(db, 'users', user.uid));
                if(d.exists() && ['admin','tadrisi_course_management','tadrisi_course_admin'].includes(d.data().role)) await initData();
                else window.location.href = 'index.html';
            } else window.location.href = 'index.html';
            showLoader(false);
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        window.switchTab = (tab) => { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`view-${tab}`).classList.remove('hidden'); 
            document.getElementById(`tab-${tab}`).classList.add('active'); 
        };

        async function initData() { 
            await fetchMufattishList(); 
            await fetchGroupsList();
            await fetchAllStudents(); // üî• Manual Fetch üî•
            populateGroupDropdowns();
            renderMufattishStatus();
            generateLink();
        }

        async function fetchMufattishList() {
            const q = query(collection(db, 'users'), where('role', '==', 'tadrisi_course_mufattish'));
            const snap = await getDocs(q); 
            allMufattish = snap.docs.map(d => ({id:d.id, ...d.data()}));
            const opts = '<option value="">-- Select --</option>' + allMufattish.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            ['mufattish-r1', 'mufattish-r2', 'mufattish-r3', 'mufattish-r4'].forEach(id => document.getElementById(id).innerHTML = opts);
        }

        async function fetchGroupsList() {
            const q = query(collection(db, 'tadrisi_groups')); 
            const snap = await getDocs(q);
            allGroups = snap.docs.map(d => ({id:d.id, ...d.data()}));
            allGroups.sort((a, b) => a.groupName.localeCompare(b.groupName, undefined, {numeric: true, sensitivity: 'base'}));
            document.getElementById('groups-list-container').innerHTML = allGroups.map(g => `<div class="bg-white p-4 shadow border rounded relative"><h4 class="font-bold text-teal-800">${g.groupName}</h4><span class="text-xs bg-gray-100 px-2 py-1 rounded">Students: ${g.totalStudents||0}</span><button onclick="deleteGroup('${g.id}')" class="absolute top-2 right-2 text-red-400"><i class="fas fa-trash"></i></button></div>`).join('');
        }

        // üî• REPLACED LISTENER WITH MANUAL FETCH üî•
        window.fetchAllStudents = async () => {
            showLoader(true);
            try {
                const q = query(collection(db, 'tadrisi_students'));
                const snap = await getDocs(q);
                allStudents = snap.docs.map(d => ({id:d.id, ...d.data()}));
                allStudents.sort((a, b) => (!a.groupId && b.groupId) ? -1 : (a.groupId && !b.groupId) ? 1 : 0);
                
                populateJamiaFilter();
                filterStudents();
                showToast('List Updated', 'success');
            } catch (e) { console.error(e); } 
            finally { showLoader(false); }
        }

        function populateGroupDropdowns() {
            const opts = '<option value="">-- Select Group --</option>' + allGroups.map(g => `<option value="${g.id}">${g.groupName}</option>`).join('');
            document.getElementById('result-group-select').innerHTML = opts;
            document.getElementById('bulk-group-select').innerHTML = opts;
            document.getElementById('transfer-group-select').innerHTML = opts;
        }

        function populateJamiaFilter() {
            const jamias = [...new Set(allStudents.map(s => s.jamia).filter(j => j))].sort();
            const filterEl = document.getElementById('student-filter-jamia');
            const currentVal = filterEl.value; 
            let html = '<option value="">All Jamiaat</option>';
            jamias.forEach(j => html += `<option value="${j}">${j}</option>`);
            filterEl.innerHTML = html;
            filterEl.value = currentVal;
        }

        window.generateLink = () => {
            const jamia = document.getElementById('link-jamia-name').value.trim();
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/tadrisi_student_form.html';
            document.getElementById('shareable-link').value = jamia ? `${baseUrl}?jamia=${encodeURIComponent(jamia)}` : baseUrl;
        };
        window.copyLink = () => { document.getElementById('shareable-link').select(); document.execCommand('copy'); showToast('Link Copied!'); };

        window.filterStudents = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const selectedJamia = document.getElementById('student-filter-jamia').value;

            const filtered = allStudents.filter(s => {
                const matchesSearch = 
                    (s.name && s.name.toLowerCase().includes(term)) ||
                    (s.regNo && s.regNo.toLowerCase().includes(term)) ||
                    (s.jamia && s.jamia.toLowerCase().includes(term)) ||
                    (s.mobile && s.mobile.includes(term)) ||
                    (s.city && s.city.toLowerCase().includes(term));
                
                const matchesJamia = selectedJamia ? (s.jamia === selectedJamia) : true;
                return matchesSearch && matchesJamia;
            });
            renderStudentsMasterList(filtered);
        };

        function renderStudentsMasterList(listToRender) {
            const tbody = document.getElementById('students-master-tbody');
            tbody.innerHTML = '';
            if(listToRender.length === 0) { tbody.innerHTML = '<tr><td colspan="11" class="p-4 text-center text-gray-400">No students found.</td></tr>'; return; }

            listToRender.forEach((s, idx) => {
                const photoSrc = s.photoBase64 || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Img';
                const grp = allGroups.find(g => g.id === s.groupId);
                const grpName = grp ? grp.groupName : '<span class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded text-xs">Unassigned</span>';

                tbody.innerHTML += `
                    <tr class="border-b text-sm hover:bg-gray-50 align-middle">
                        <td class="p-3 text-center"><input type="checkbox" class="student-checkbox big-checkbox" value="${s.id}" onchange="updateBulkActionUI()"></td>
                        <td class="p-3 text-gray-500">${idx+1}</td>
                        <td class="p-3 text-center"><img src="${photoSrc}" class="student-thumb mx-auto" alt="img"></td>
                        <td class="p-3 font-mono">${s.regNo||'-'}</td>
                        <td class="p-3 font-bold urdu-font text-base">${s.name}</td>
                        <td class="p-3 urdu-font">${s.fatherName||'-'}</td>
                        <td class="p-3 urdu-font">${s.jamia||'-'}</td>
                        <td class="p-3 urdu-font text-teal-700">${s.city||'-'}</td>
                        <td class="p-3 font-mono font-bold text-gray-700">${s.mobile||'-'}</td>
                        <td class="p-3 text-xs">${grpName}</td>
                        <td class="p-3 flex gap-2">
                            <button onclick="openEditModal('${s.id}')" class="text-teal-600 hover:bg-teal-50 p-2 rounded" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteStudent('${s.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        window.exportStudentList = () => {
            if (allStudents.length === 0) return showToast('No data to export', 'error');
            const dataToExport = allStudents.map((s, idx) => ({
                "S.No": idx + 1, "Roll No": s.regNo, "Name": s.name, "Father Name": s.fatherName,
                "Jamia": s.jamia, "City": s.city, "Mobile": s.mobile,
                "Group": allGroups.find(g => g.id === s.groupId)?.groupName || 'Unassigned'
            }));
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Students");
            XLSX.writeFile(wb, "Tadrisi_Students_List.xlsx");
        };

        window.openEditModal = (id) => {
            const s = allStudents.find(st => st.id === id);
            if(!s) return;
            document.getElementById('edit-student-id').value = s.id;
            document.getElementById('edit-reg').value = s.regNo || '';
            document.getElementById('edit-name').value = s.name || '';
            document.getElementById('edit-father').value = s.fatherName || '';
            document.getElementById('edit-jamia').value = s.jamia || '';
            document.getElementById('edit-city').value = s.city || '';
            document.getElementById('edit-mobile').value = s.mobile || '';
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveEditedStudent = async () => {
            const id = document.getElementById('edit-student-id').value;
            showLoader(true);
            try {
                await updateDoc(doc(db, 'tadrisi_students', id), {
                    regNo: document.getElementById('edit-reg').value.trim(),
                    name: document.getElementById('edit-name').value.trim(),
                    fatherName: document.getElementById('edit-father').value.trim(),
                    jamia: document.getElementById('edit-jamia').value.trim(),
                    city: document.getElementById('edit-city').value.trim(),
                    mobile: document.getElementById('edit-mobile').value.trim(),
                });
                showToast('Updated!');
                document.getElementById('edit-modal').classList.add('hidden');
                await fetchAllStudents(); // üî• Refresh List üî•
            } catch(e) { console.error(e); showToast('Error', 'error'); } finally { showLoader(false); }
        };

        // --- Bulk Actions ---
        window.toggleSelectAll = (src) => { document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = src.checked); updateBulkActionUI(); };
        window.updateBulkActionUI = () => {
            const cnt = document.querySelectorAll('.student-checkbox:checked').length;
            document.getElementById('selected-count').textContent = cnt;
            document.getElementById('bulk-action-bar').classList.toggle('hidden', cnt === 0);
        };
        window.bulkAssignGroup = async () => {
            const gid = document.getElementById('bulk-group-select').value;
            if(!gid) return showToast('Select Group', 'error');
            const ids = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
            if(!confirm(`Assign ${ids.length} students?`)) return;
            showLoader(true);
            const batch = writeBatch(db);
            ids.forEach(sid => batch.update(doc(db,'tadrisi_students',sid), {groupId:gid}));
            batch.update(doc(db,'tadrisi_groups',gid), {totalStudents: increment(ids.length)});
            await batch.commit(); showToast('Assigned!'); document.getElementById('bulk-action-bar').classList.add('hidden'); await fetchAllStudents(); // üî• Refresh üî•
        };
        window.bulkDeleteStudents = async () => {
            const ids = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
            if(!confirm(`DELETE ${ids.length} students?`)) return;
            showLoader(true);
            const batch = writeBatch(db);
            ids.forEach(sid => batch.delete(doc(db,'tadrisi_students',sid)));
            await batch.commit(); showToast('Deleted!'); document.getElementById('bulk-action-bar').classList.add('hidden'); await fetchAllStudents(); // üî• Refresh üî•
        };

        window.createGroup = async () => {
            const n = document.getElementById('new-group-name').value;
            if(!n) return;
            await addDoc(collection(db,'tadrisi_groups'), { 
                groupName:n, totalStudents:0, 
                round_1_uid: document.getElementById('mufattish-r1').value,
                round_2_uid: document.getElementById('mufattish-r2').value,
                round_3_uid: document.getElementById('mufattish-r3').value,
                round_4_uid: document.getElementById('mufattish-r4').value
            });
            document.getElementById('new-group-name').value=''; await fetchGroupsList();
        };
        window.deleteGroup = async (id) => { if(confirm('Delete Group?')) await deleteDoc(doc(db,'tadrisi_groups',id)); await fetchGroupsList(); };
        window.deleteStudent = async (id) => { if(confirm('Delete?')) await deleteDoc(doc(db,'tadrisi_students',id)); await fetchAllStudents(); };

        // --- Other functions (Result, Transfer etc. - kept as they were) ---
        window.openTransferModal = (sid, name, oldGid) => {
            document.getElementById('transfer-student-name').textContent = `Transferring: ${name}`;
            document.getElementById('transfer-student-id').value = sid;
            document.getElementById('transfer-old-group-id').value = oldGid;
            document.getElementById('transfer-modal').classList.remove('hidden');
        };
        window.confirmTransfer = async () => { 
            const sid = document.getElementById('transfer-student-id').value;
            const oldGid = document.getElementById('transfer-old-group-id').value;
            const newGid = document.getElementById('transfer-group-select').value;
            if(!newGid || newGid === oldGid) return showToast('Select group', 'error');
            showLoader(true);
            try {
                const batch = writeBatch(db);
                batch.update(doc(db,'tadrisi_students',sid), {groupId:newGid});
                if(oldGid&&oldGid!=='unassigned') batch.update(doc(db,'tadrisi_groups',oldGid), {totalStudents:increment(-1)});
                batch.update(doc(db,'tadrisi_groups',newGid), {totalStudents:increment(1)});
                await batch.commit(); showToast('Transferred'); document.getElementById('transfer-modal').classList.add('hidden'); await fetchAllStudents();
            } catch(e){console.error(e);} finally{showLoader(false);}
        };

        window.updateHeaderDate = () => { document.getElementById('result-header-date').textContent = document.getElementById('result-month-selector').value || 'Month: -- | Year: --'; };
        window.loadGroupResults = async () => {
            const gid = document.getElementById('result-group-select').value;
            if(!gid) return;
            const group = allGroups.find(g => g.id === gid);
            document.getElementById('result-group-name').textContent = group ? group.groupName : '';
            const studentsInGroup = allStudents.filter(s => s.groupId === gid);
            
            const jamiaSet = new Set(studentsInGroup.map(s => s.jamia).filter(j => j));
            const jamiaFilter = document.getElementById('filter-jamia');
            jamiaFilter.innerHTML = '<option value="all">All Jamiaat</option>';
            jamiaSet.forEach(j => jamiaFilter.innerHTML += `<option value="${j}">${j}</option>`);
            renderResultTable(studentsInGroup);
        };
        window.filterResults = () => {
            const gid = document.getElementById('result-group-select').value;
            const jamia = document.getElementById('filter-jamia').value;
            let list = allStudents.filter(s => s.groupId === gid);
            if(jamia !== 'all') list = list.filter(s => s.jamia === jamia);
            renderResultTable(list);
        };
        function renderResultTable(list) {
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            const filledList = list.filter(s => s.marks_r1 || s.marks_r2 || s.marks_r3 || s.marks_r4);
            if(filledList.length === 0) { tbody.innerHTML = '<tr><td colspan="11" class="p-8 text-gray-400">No results found.</td></tr>'; return; }
            let count = 1;
            filledList.forEach(s => {
                const getMark = (r, k) => (r && r[k]) ? Number(r[k]) : 0;
                const r1=s.marks_r1, r2=s.marks_r2, r3=s.marks_r3, r4=s.marks_r4;
                const tIbarat = getMark(r1,'m1')+getMark(r2,'m1')+getMark(r3,'m1')+getMark(r4,'m1');
                const tTarjama = getMark(r1,'m2')+getMark(r2,'m2')+getMark(r3,'m2')+getMark(r4,'m2');
                const tSarf = getMark(r1,'m3')+getMark(r2,'m3')+getMark(r3,'m3')+getMark(r4,'m3');
                const tNahw = getMark(r1,'m4')+getMark(r2,'m4')+getMark(r3,'m4')+getMark(r4,'m4');
                const tAndaz = getMark(r1,'m5')+getMark(r2,'m5')+getMark(r3,'m5')+getMark(r4,'m5');
                const grandTotal = tIbarat + tTarjama + tSarf + tNahw + tAndaz;
                const percentage = (grandTotal / 400) * 100;
                const isFail = (tIbarat < 56 || tTarjama < 56 || tSarf < 56 || tNahw < 56 || tAndaz < 56);
                let resultText = "ŸÜÿß⁄©ÿßŸÖ", resultClass = "bg-fail";
                if (!isFail) {
                    if (percentage >= 90) { resultText = "ŸÖŸÖÿ™ÿßÿ≤"; resultClass = "bg-pass"; }
                    else if (percentage >= 80) { resultText = "ÿ®€Åÿ™ÿ±"; resultClass = "bg-pass"; }
                    else if (percentage >= 70) { resultText = "ŸÖŸÜÿßÿ≥ÿ®"; resultClass = "bg-pass"; }
                }
                const cc = (v) => v < 56 ? 'text-red-600 font-bold bg-red-50' : '';
                tbody.innerHTML += `<tr class="border-b border-gray-300"><td class="p-2 text-sm">${count++}</td><td class="p-2 text-right"><div class="font-bold">${s.name}</div><div class="text-sm text-gray-500">${s.fatherName}</div></td><td class="p-2 text-sm">${s.jamia}</td><td class="p-2 font-sans ${cc(tIbarat)}">${tIbarat}</td><td class="p-2 font-sans ${cc(tTarjama)}">${tTarjama}</td><td class="p-2 font-sans ${cc(tSarf)}">${tSarf}</td><td class="p-2 font-sans ${cc(tNahw)}">${tNahw}</td><td class="p-2 font-sans ${cc(tAndaz)}">${tAndaz}</td><td class="p-2 font-bold bg-blue-50 font-sans">${grandTotal}</td><td class="p-2 font-sans bg-blue-50">${percentage.toFixed(2)}%</td><td class="p-2 font-bold ${resultClass}">${resultText}</td></tr>`;
            });
        }
        window.exportResultToExcel = () => {
            const table = document.getElementById('result-table');
            if(!table) return;
            const wb = XLSX.utils.table_to_book(table, {sheet: "Result"});
            const dateStr = document.getElementById('result-month-selector').value || 'Result';
            XLSX.writeFile(wb, `Tadrisi_Result_${dateStr}.xlsx`);
        };
        function renderMufattishStatus() {
            const tbody = document.getElementById('mufattish-status-tbody'); tbody.innerHTML = '';
            allMufattish.forEach(m => {
                let html = '';
                allGroups.forEach(g => {
                    [1,2,3,4].forEach(r => {
                        if(g[`round_${r}_uid`] === m.id) {
                             const filled = allStudents.filter(s => s.groupId === g.id && s[`marks_r${r}`]).length;
                             const total = allStudents.filter(s => s.groupId === g.id).length;
                             let cls = 'status-pending', txt = 'Pending';
                             if(total>0 && filled===total) { cls='status-complete'; txt='Completed'; }
                             else if(filled>0) { cls='status-ongoing'; txt=`Ongoing (${filled}/${total})`; }
                             html += `<div class="mb-2 text-sm flex justify-between bg-white p-2 border rounded"><span>${g.groupName} (Sabaq ${r})</span><span class="${cls} px-2 rounded font-bold text-xs">${txt}</span></div>`;
                        }
                    });
                });
                tbody.innerHTML += `<tr class="border-b bg-white"><td class="p-3 font-bold text-lg">${m.name}</td><td class="p-3 text-sm">${m.region}</td><td class="p-3 bg-gray-50">${html||'<span class="text-gray-400 text-xs">No assignments</span>'}</td></tr>`;
            });
        }
    </script>
</body>
</html>
