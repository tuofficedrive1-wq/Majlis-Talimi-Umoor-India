<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Course Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
        }
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        @media print {
            body * { visibility: hidden; }
            #view-students, #view-students * { visibility: visible; }
            #view-students { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-header { display: block !important; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60]"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="border-4 border-t-teal-600 rounded-full w-12 h-12 animate-spin"></div></div>

    <header class="bg-teal-800 text-white p-4 shadow-md sticky top-0 z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Tadrisi Admin (4 Rounds System)</h1>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 px-4 py-1.5 rounded text-sm font-semibold">Logout</button>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[95%]">
        <div class="flex flex-wrap gap-2 mb-6 border-b pb-2 no-print">
            <button onclick="switchTab('groups')" class="tab-btn active px-6 py-2 rounded-t-lg font-medium border" id="tab-groups">Manage Groups</button>
            <button onclick="switchTab('students')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-students">Students & Excel</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-mufattish">Mufattish List</button>
        </div>

        <div id="view-groups" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-teal-600">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">Create New Group (Assign 4 Rounds)</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Group Name</label>
                    <input type="text" id="new-group-name" placeholder="e.g. Halqa 1" class="w-full p-2 border rounded urdu-font">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Round 1 Mufattish</label>
                        <select id="mufattish-r1" class="mufattish-select w-full p-2 border rounded bg-gray-50"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Round 2 Mufattish</label>
                        <select id="mufattish-r2" class="mufattish-select w-full p-2 border rounded bg-gray-50"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Round 3 Mufattish</label>
                        <select id="mufattish-r3" class="mufattish-select w-full p-2 border rounded bg-gray-50"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Round 4 Mufattish</label>
                        <select id="mufattish-r4" class="mufattish-select w-full p-2 border rounded bg-gray-50"></select>
                    </div>
                </div>

                <button onclick="createGroup()" class="bg-teal-600 text-white px-8 py-2 rounded font-bold hover:bg-teal-700">Create Group</button>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-students" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-blue-600 no-print">
                <h3 class="text-lg font-bold mb-4">Manage Students</h3>
                <div class="mb-4">
                    <select id="student-group-select" onchange="loadStudentsForGroup()" class="w-full p-2 border rounded urdu-font bg-gray-50 focus:ring-2 focus:ring-blue-500"><option value="">-- Select Group --</option></select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-blue-50 rounded border border-blue-100 mb-6">
                    <input type="text" id="new-std-name" placeholder="Student Name" class="p-2 border rounded urdu-font">
                    <input type="text" id="new-std-father" placeholder="Father Name" class="p-2 border rounded urdu-font">
                    <button onclick="addStudent()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Add Single</button>
                </div>

                <div class="p-4 bg-green-50 rounded-lg border-2 border-dashed border-green-300">
                    <h4 class="font-bold text-green-800 mb-2"><i class="fas fa-file-excel"></i> Upload Excel File</h4>
                    <p class="text-xs text-gray-600 mb-2">Columns: <b>RegNo, StudentName, FatherName, DOB, Gender</b></p>
                    <div class="flex gap-2">
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="flex-1 p-1 bg-white border rounded">
                        <button onclick="processExcelUpload()" id="upload-btn" class="bg-green-600 text-white px-4 py-1 rounded font-bold">Upload</button>
                    </div>
                    <div id="upload-status" class="hidden mt-2 text-sm text-green-700 font-bold">Uploading...</div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden border">
                <table class="w-full text-left border-collapse min-w-[800px]">
                    <thead class="bg-gray-100 text-gray-700 text-xs text-center border-b-2 border-gray-300">
                        <tr>
                            <th class="p-2 w-10">#</th>
                            <th class="p-2 text-left">Name</th>
                            <th class="p-2">Round 1</th>
                            <th class="p-2">Round 2</th>
                            <th class="p-2">Round 3</th>
                            <th class="p-2">Round 4</th>
                            <th class="p-2 no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-purple-600">
                <h3 class="text-lg font-bold mb-4">Mufattish List</h3>
                <table class="w-full text-left border-collapse"><tbody id="mufattish-table-body"></tbody></table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish = [], allGroups = [], currentSelectedGroupId = null;
        const showLoader = (show) => document.getElementById('loader').classList.toggle('hidden', !show);
        const showToast = (msg, type='success') => { const el = document.getElementById('notification'); el.textContent = msg; el.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] ${type==='error'?'bg-red-500':'bg-emerald-600'}`; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3000); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if(userDoc.exists()) {
                    const r = userDoc.data().role;
                    if(r === 'admin' || r === 'tadrisi_course_management' || r === 'tadrisi_course_admin') await initData();
                    else window.location.href = 'index.html';
                }
            } else window.location.href = 'index.html';
            showLoader(false);
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        window.switchTab = (tab) => { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${tab}`).classList.remove('hidden'); document.getElementById(`tab-${tab}`).classList.add('active'); };

        async function initData() { await fetchMufattishList(); await fetchGroupsList(); }

        async function fetchMufattishList() {
            const q = query(collection(db, 'users'), where('role', '==', 'tadrisi_course_mufattish'));
            const snap = await getDocs(q);
            allMufattish = snap.docs.map(d => ({id:d.id, ...d.data()}));
            
            // Populate all 4 dropdowns
            const options = '<option value="">-- Select --</option>' + allMufattish.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            ['mufattish-r1', 'mufattish-r2', 'mufattish-r3', 'mufattish-r4'].forEach(id => {
                document.getElementById(id).innerHTML = options;
            });

            const tbody = document.getElementById('mufattish-table-body'); tbody.innerHTML='';
            allMufattish.forEach(m => tbody.innerHTML += `<tr class="border-b"><td class="p-2">${m.name}</td><td class="p-2">${m.email}</td><td class="p-2">${m.region||'-'}</td></tr>`);
        }

        async function fetchGroupsList() {
            const q = query(collection(db, 'tadrisi_groups'));
            const snap = await getDocs(q);
            allGroups = snap.docs.map(d => ({id:d.id, ...d.data()}));
            const c = document.getElementById('groups-list-container'); c.innerHTML='';
            
            allGroups.forEach(g => {
                const getMName = (uid) => { const m = allMufattish.find(x => x.id === uid); return m ? m.name : 'Pending'; };
                
                c.innerHTML += `
                    <div class="bg-white p-4 shadow border rounded relative">
                        <h4 class="font-bold text-lg text-teal-800 mb-2">${g.groupName}</h4>
                        <div class="text-xs text-gray-600 space-y-1">
                            <p>R1: ${getMName(g.round_1_uid)}</p>
                            <p>R2: ${getMName(g.round_2_uid)}</p>
                            <p>R3: ${getMName(g.round_3_uid)}</p>
                            <p>R4: ${getMName(g.round_4_uid)}</p>
                        </div>
                        <button onclick="deleteGroup('${g.id}')" class="absolute top-2 right-2 text-red-400"><i class="fas fa-trash"></i></button>
                    </div>`;
            });

            const sel = document.getElementById('student-group-select'); sel.innerHTML = '<option value="">-- Select Group --</option>';
            allGroups.forEach(g => sel.innerHTML += `<option value="${g.id}">${g.groupName}</option>`);
        }

        window.createGroup = async () => {
            const n = document.getElementById('new-group-name').value; 
            const r1 = document.getElementById('mufattish-r1').value;
            const r2 = document.getElementById('mufattish-r2').value;
            const r3 = document.getElementById('mufattish-r3').value;
            const r4 = document.getElementById('mufattish-r4').value;

            if(!n || !r1) return showToast('Name and at least Round 1 is required', 'error');
            
            showLoader(true);
            try {
                await addDoc(collection(db, 'tadrisi_groups'), { 
                    groupName: n, 
                    totalStudents: 0, 
                    round_1_uid: r1, round_2_uid: r2, round_3_uid: r3, round_4_uid: r4,
                    createdAt: new Date() 
                });
                showToast('Group Created with Rounds!');
                document.getElementById('new-group-name').value=''; 
                await fetchGroupsList();
            } catch(e) { console.error(e); } finally { showLoader(false); }
        };
        window.deleteGroup = async (id) => { if(confirm('Delete?')) { await deleteDoc(doc(db, 'tadrisi_groups', id)); await fetchGroupsList(); } };

        window.loadStudentsForGroup = async () => {
            const gid = document.getElementById('student-group-select').value;
            currentSelectedGroupId = gid;
            const tbody = document.getElementById('students-table-body');
            if(!gid) return tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">Select group</td></tr>';
            
            const q = query(collection(db, 'tadrisi_students'), where('groupId', '==', gid));
            const snap = await getDocs(q);
            tbody.innerHTML = '';
            let count = 1;
            snap.forEach(d => {
                const s = d.data();
                // Check if result exists for each round
                const hasR1 = s.marks_r1?.total ? s.marks_r1.total : '-';
                const hasR2 = s.marks_r2?.total ? s.marks_r2.total : '-';
                const hasR3 = s.marks_r3?.total ? s.marks_r3.total : '-';
                const hasR4 = s.marks_r4?.total ? s.marks_r4.total : '-';

                const row = `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-2 text-center text-gray-500">${count++}</td>
                        <td class="p-2 font-bold urdu-font">${s.name}<br><span class="text-xs font-normal text-gray-500">${s.fatherName||''}</span></td>
                        <td class="p-2 text-center bg-blue-50">${hasR1}</td>
                        <td class="p-2 text-center bg-green-50">${hasR2}</td>
                        <td class="p-2 text-center bg-yellow-50">${hasR3}</td>
                        <td class="p-2 text-center bg-purple-50">${hasR4}</td>
                        <td class="p-2 text-center no-print"><button onclick="deleteStudent('${d.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        };

        window.addStudent = async () => {
            if(!currentSelectedGroupId) return showToast('Select Group', 'error');
            const n = document.getElementById('new-std-name').value; const f = document.getElementById('new-std-father').value;
            if(!n) return;
            await addDoc(collection(db, 'tadrisi_students'), { name:n, fatherName:f, groupId:currentSelectedGroupId });
            await updateDoc(doc(db,'tadrisi_groups',currentSelectedGroupId), { totalStudents: increment(1) });
            document.getElementById('new-std-name').value=''; await loadStudentsForGroup();
        };

        window.deleteStudent = async (id) => {
            if(confirm('Delete?')) {
                await deleteDoc(doc(db,'tadrisi_students', id));
                await updateDoc(doc(db,'tadrisi_groups',currentSelectedGroupId), { totalStudents: increment(-1) });
                await loadStudentsForGroup();
            }
        };

        // EXCEL UPLOAD LOGIC
        window.processExcelUpload = async () => {
            const fileIn = document.getElementById('excel-file-input');
            const gid = document.getElementById('student-group-select').value;
            if(!gid) return showToast('Select a Group first!', 'error');
            if(!fileIn.files.length) return showToast('Select Excel file', 'error');

            document.getElementById('upload-status').classList.remove('hidden');
            document.getElementById('upload-btn').disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);

                if(json.length > 0) {
                    const batch = writeBatch(db);
                    json.forEach(row => {
                        const ref = doc(collection(db, 'tadrisi_students'));
                        batch.set(ref, {
                            name: row['StudentName'] || 'Unknown',
                            fatherName: row['FatherName'] || '',
                            regNo: row['RegNo'] || '',
                            groupId: gid,
                            createdAt: new Date()
                        });
                    });
                    await batch.commit();
                    await updateDoc(doc(db,'tadrisi_groups',gid), { totalStudents: increment(json.length) });
                    showToast(`Uploaded ${json.length} Students!`);
                    await loadStudentsForGroup();
                }
                document.getElementById('upload-status').classList.add('hidden');
                document.getElementById('upload-btn').disabled = false;
                fileIn.value = '';
            };
            reader.readAsArrayBuffer(fileIn.files[0]);
        };
    </script>
</body>
</html>
