<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
        }
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        .big-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: #0f766e; }

        /* Status Colors */
        .status-complete { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status-pending { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .status-ongoing { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .bg-fail { background-color: #ef4444 !important; color: white !important; }
        .bg-pass { background-color: #ecfccb !important; color: #1e293b !important; }
        .bg-header { background-color: #fef3c7 !important; }

        .student-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60]"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="border-4 border-t-teal-600 rounded-full w-12 h-12 animate-spin"></div></div>

    <header class="bg-teal-800 text-white p-4 shadow-md sticky top-0 z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Tadrisi Admin System</h1>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 px-4 py-1.5 rounded text-sm font-semibold">Logout</button>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[98%]">
        
        <div class="flex flex-wrap gap-2 mb-6 border-b pb-2 no-print">
            <button onclick="switchTab('students')" class="tab-btn active px-6 py-2 rounded-t-lg font-medium border" id="tab-students">1. Students & Link</button>
            <button onclick="switchTab('groups')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-groups">2. Manage Groups</button>
            <button onclick="switchTab('results')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-results">3. Final Result</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-mufattish">4. Mufattish Status</button>
        </div>

        <div id="view-students" class="tab-content">
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-teal-600">
                <h3 class="text-lg font-bold text-teal-800 mb-2"><i class="fas fa-link mr-2"></i> Share Data Entry Link</h3>
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="text-xs text-gray-500">Jamia Name (Pre-fill)</label>
                        <input type="text" id="link-jamia-name" class="w-full p-2 border rounded urdu-font" placeholder="Jamia ka naam..." oninput="generateLink()">
                    </div>
                    <div class="flex-[2] w-full relative">
                        <div class="flex">
                            <input type="text" id="shareable-link" class="w-full p-2 border rounded-l bg-gray-50 text-sm text-gray-600" readonly>
                            <button onclick="copyLink()" class="bg-teal-600 text-white px-4 py-2 rounded-r hover:bg-teal-700 font-bold whitespace-nowrap">Copy Link</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-orange-500">
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h3 class="text-lg font-bold text-orange-800"><i class="fas fa-users"></i> All Students List</h3>
                    
                    <div class="relative w-full md:w-1/3">
                        <input type="text" id="search-input" oninput="filterStudents()" class="w-full p-2 pl-10 border rounded-full bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-300 transition" placeholder="Search by Name, Roll No or Jamia...">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div id="bulk-action-bar" class="hidden bg-orange-50 p-3 rounded border border-orange-200 mb-4 flex flex-col md:flex-row justify-between items-center gap-2">
                    <span class="font-bold text-orange-800"><span id="selected-count">0</span> Students Selected</span>
                    
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="bulk-group-select" class="p-2 border rounded text-sm flex-1 md:w-64">
                            <option value="">-- Assign to Group --</option>
                        </select>
                        <button onclick="bulkAssignGroup()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700">Assign</button>
                        <button onclick="bulkDeleteStudents()" class="bg-red-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-red-700"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                    <table class="w-full text-left border-collapse min-w-[1000px]">
                        <thead class="bg-orange-50 text-orange-900 text-sm sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-3 border-b w-10 text-center">
                                    <input type="checkbox" onchange="toggleSelectAll(this)" class="big-checkbox">
                                </th>
                                <th class="p-3 border-b w-10">#</th>
                                <th class="p-3 border-b w-16 text-center">Photo</th>
                                <th class="p-3 border-b">Roll No</th>
                                <th class="p-3 border-b">Name</th>
                                <th class="p-3 border-b">Father Name</th>
                                <th class="p-3 border-b">Jamia</th>
                                <th class="p-3 border-b">City</th>
                                <th class="p-3 border-b">Group</th>
                                <th class="p-3 border-b">Action</th>
                            </tr>
                        </thead>
                        <tbody id="students-master-tbody">
                            <tr><td colspan="10" class="p-4 text-center text-gray-400">Loading students...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-groups" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-teal-600">
                <h3 class="text-lg font-bold mb-4">Create New Group</h3>
                <div class="flex flex-col gap-4">
                    <input type="text" id="new-group-name" placeholder="Group Name (e.g. Group 1)" class="w-full p-2 border rounded urdu-font">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <select id="mufattish-r1" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r2" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r3" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r4" class="p-2 border rounded text-sm bg-gray-50"></select>
                    </div>
                    <button onclick="createGroup()" class="bg-teal-600 text-white px-6 py-2 rounded font-bold w-full md:w-auto self-start">Create Group</button>
                </div>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-results" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-purple-600 no-print">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Result Filters</h3>
                    <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold shadow flex items-center">
                        <i class="fas fa-file-excel mr-2"></i> Download Excel
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs text-gray-500">Group Select</label>
                        <select id="result-group-select" onchange="loadGroupResults()" class="w-full p-2 border rounded urdu-font bg-gray-50">
                            <option value="">-- Select Group --</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Month & Year</label>
                        <input type="month" id="result-month-selector" class="w-full p-2 border rounded bg-gray-50" onchange="updateHeaderDate()">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Filter by Jamia</label>
                        <select id="filter-jamia" onchange="filterResults()" class="w-full p-2 border rounded urdu-font bg-gray-50">
                            <option value="all">All Jamiaat</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden border p-2 min-h-[500px]">
                <div class="text-center mb-6 pt-4">
                    <h2 class="text-3xl font-bold urdu-font">ÿ™ÿØÿ±€åÿ≥€å Ÿπ€åÿ≥Ÿπ ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å ŸÅÿßÿ±ŸÖ</h2>
                    <p class="text-gray-600 mt-1" id="result-header-date">Month: -- | Year: --</p>
                    <h3 class="text-xl text-teal-700 font-bold mt-2" id="result-group-name"></h3>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-center border-collapse border border-gray-400 min-w-[1200px]" dir="rtl" id="result-table">
                        <thead class="bg-orange-100 text-gray-900 font-bold text-base urdu-font">
                            <tr>
                                <th class="p-2 border border-gray-400 w-10">ŸÜŸÖÿ®ÿ±<br>ÿ¥ŸÖÿßÿ±</th>
                                <th class="p-2 border border-gray-400 w-48 text-right pr-4">ŸÜÿßŸÖ ŸÖÿπ ŸàŸÑÿØ€åÿ™</th>
                                <th class="p-2 border border-gray-400 w-32">ÿ¨ÿßŸÖÿπ€Å</th>
                                <th class="p-2 border border-gray-400 w-16 bg-header">ÿπÿ®ÿßÿ±ÿ™<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                <th class="p-2 border border-gray-400 w-16 bg-header">ÿ™ÿ±ÿ¨ŸÖ€Å<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                <th class="p-2 border border-gray-400 w-16 bg-header">ÿµÿ±ŸÅ<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                <th class="p-2 border border-gray-400 w-16 bg-header">ŸÜÿ≠Ÿà<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                <th class="p-2 border border-gray-400 w-16 bg-header">ÿßŸÜÿØÿßÿ≤ ÿ™ŸÅ€Å€åŸÖ<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                <th class="p-2 border border-gray-400 w-20 bg-blue-50">ÿ≠ÿßÿµŸÑ ⁄©ÿ±ÿØ€Å<br>⁄©ŸÑ ŸÜŸÖÿ®ÿ±</th>
                                <th class="p-2 border border-gray-400 w-16 bg-blue-50">ŸÅ€åÿµÿØ</th>
                                <th class="p-2 border border-gray-400 w-24 bg-orange-200">⁄©€åŸÅ€åÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="text-lg urdu-font text-gray-800">
                            <tr><td colspan="11" class="p-8 text-gray-400">Please select a Group to view results.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-gray-600">
                <h3 class="text-lg font-bold mb-4">Mufattish Status (Live Tracking)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-800">
                            <tr>
                                <th class="p-3 border-b">Mufattish Name</th>
                                <th class="p-3 border-b">Region</th>
                                <th class="p-3 border-b">Assigned Groups & Status</th>
                            </tr>
                        </thead>
                        <tbody id="mufattish-status-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish = [], allGroups = [], allStudents = [];

        const showLoader = (show) => document.getElementById('loader').classList.toggle('hidden', !show);
        const showToast = (msg, type='success') => { const el = document.getElementById('notification'); el.textContent = msg; el.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] ${type==='error'?'bg-red-500':'bg-emerald-600'}`; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3000); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const d = await getDoc(doc(db, 'users', user.uid));
                if(d.exists() && ['admin','tadrisi_course_management','tadrisi_course_admin'].includes(d.data().role)) {
                    await initData();
                } else window.location.href = 'index.html';
            } else window.location.href = 'index.html';
            showLoader(false);
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        window.switchTab = (tab) => { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`view-${tab}`).classList.remove('hidden'); 
            document.getElementById(`tab-${tab}`).classList.add('active'); 
        };

        async function initData() { 
            await fetchMufattishList(); 
            await fetchGroupsList();
            await fetchAllStudents();
            populateGroupDropdowns();
            renderMufattishStatus();
            generateLink();
        }

        async function fetchMufattishList() {
            const q = query(collection(db, 'users'), where('role', '==', 'tadrisi_course_mufattish'));
            const snap = await getDocs(q); 
            allMufattish = snap.docs.map(d => ({id:d.id, ...d.data()}));
            const opts = '<option value="">-- Select --</option>' + allMufattish.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            ['mufattish-r1', 'mufattish-r2', 'mufattish-r3', 'mufattish-r4'].forEach(id => document.getElementById(id).innerHTML = opts);
        }

        async function fetchGroupsList() {
            const q = query(collection(db, 'tadrisi_groups')); 
            const snap = await getDocs(q);
            allGroups = snap.docs.map(d => ({id:d.id, ...d.data()}));
            allGroups.sort((a, b) => a.groupName.localeCompare(b.groupName, undefined, {numeric: true, sensitivity: 'base'}));
            document.getElementById('groups-list-container').innerHTML = allGroups.map(g => `<div class="bg-white p-4 shadow border rounded relative"><h4 class="font-bold text-teal-800">${g.groupName}</h4><span class="text-xs bg-gray-100 px-2 py-1 rounded">Students: ${g.totalStudents||0}</span><button onclick="deleteGroup('${g.id}')" class="absolute top-2 right-2 text-red-400"><i class="fas fa-trash"></i></button></div>`).join('');
        }

        async function fetchAllStudents() {
            const q = query(collection(db, 'tadrisi_students'));
            const snap = await getDocs(q);
            allStudents = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderStudentsMasterList(allStudents); // Initially Show All
        }

        function populateGroupDropdowns() {
            const opts = '<option value="">-- Select Group --</option>' + allGroups.map(g => `<option value="${g.id}">${g.groupName}</option>`).join('');
            document.getElementById('result-group-select').innerHTML = opts;
            document.getElementById('bulk-group-select').innerHTML = opts;
        }

        window.generateLink = () => {
            const jamia = document.getElementById('link-jamia-name').value.trim();
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/tadrisi_student_form.html';
            let finalUrl = baseUrl;
            if(jamia) finalUrl += `?jamia=${encodeURIComponent(jamia)}`;
            document.getElementById('shareable-link').value = finalUrl;
        };

        window.copyLink = () => {
            const link = document.getElementById('shareable-link');
            link.select();
            document.execCommand('copy');
            showToast('Link Copied!');
        };

        // üî• SEARCH FUNCTIONALITY üî•
        window.filterStudents = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = allStudents.filter(s => {
                return (s.name && s.name.toLowerCase().includes(term)) ||
                       (s.regNo && s.regNo.toLowerCase().includes(term)) ||
                       (s.jamia && s.jamia.toLowerCase().includes(term));
            });
            renderStudentsMasterList(filtered);
        };

        // üî• RENDER STUDENTS & BULK SELECTION üî•
        function renderStudentsMasterList(listToRender) {
            const tbody = document.getElementById('students-master-tbody');
            tbody.innerHTML = '';
            
            if(listToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-400">No students found.</td></tr>';
                return;
            }

            listToRender.forEach((s, idx) => {
                const photoSrc = s.photoBase64 || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Img';
                // Get Group Name
                const grp = allGroups.find(g => g.id === s.groupId);
                const grpName = grp ? grp.groupName : '<span class="text-red-500 font-bold">Unassigned</span>';

                tbody.innerHTML += `
                    <tr class="border-b text-sm hover:bg-gray-50 align-middle">
                        <td class="p-3 text-center"><input type="checkbox" class="student-checkbox big-checkbox" value="${s.id}" onchange="updateBulkActionUI()"></td>
                        <td class="p-3 text-gray-500">${idx+1}</td>
                        <td class="p-3 text-center"><img src="${photoSrc}" class="student-thumb mx-auto" alt="img"></td>
                        <td class="p-3 font-mono">${s.regNo||'-'}</td>
                        <td class="p-3 font-bold urdu-font">${s.name}</td>
                        <td class="p-3 urdu-font">${s.fatherName||'-'}</td>
                        <td class="p-3 urdu-font">${s.jamia||'-'}</td>
                        <td class="p-3 urdu-font text-teal-700">${s.city||'-'}</td>
                        <td class="p-3 text-xs">${grpName}</td>
                        <td class="p-3">
                            <button onclick="deleteStudent('${s.id}')" class="text-red-500 hover:text-red-700 text-lg" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // --- BULK ACTIONS LOGIC ---
        window.toggleSelectAll = (source) => {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateBulkActionUI();
        };

        window.updateBulkActionUI = () => {
            const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
            const actionBar = document.getElementById('bulk-action-bar');
            document.getElementById('selected-count').textContent = checkedCount;
            if (checkedCount > 0) actionBar.classList.remove('hidden');
            else actionBar.classList.add('hidden');
        };

        window.bulkAssignGroup = async () => {
            const gid = document.getElementById('bulk-group-select').value;
            if(!gid) return showToast('Select a group first', 'error');
            const selectedIds = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
            
            if(!confirm(`Assign ${selectedIds.length} students to this group?`)) return;

            showLoader(true);
            try {
                const batch = writeBatch(db);
                selectedIds.forEach(sid => {
                    const ref = doc(db, 'tadrisi_students', sid);
                    batch.update(ref, { groupId: gid });
                });
                
                const groupRef = doc(db, 'tadrisi_groups', gid);
                batch.update(groupRef, { totalStudents: increment(selectedIds.length) });

                await batch.commit();
                showToast('Bulk Assigned Successfully!');
                document.getElementById('bulk-action-bar').classList.add('hidden');
                await fetchAllStudents();
            } catch(e) { console.error(e); } finally { showLoader(false); }
        };

        window.bulkDeleteStudents = async () => {
            const selectedIds = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
            if(!confirm(`Are you sure you want to PERMANENTLY DELETE ${selectedIds.length} students?`)) return;

            showLoader(true);
            try {
                const batch = writeBatch(db);
                selectedIds.forEach(sid => {
                    const ref = doc(db, 'tadrisi_students', sid);
                    batch.delete(ref);
                });
                await batch.commit();
                showToast('Deleted Successfully!');
                document.getElementById('bulk-action-bar').classList.add('hidden');
                await fetchAllStudents();
            } catch(e) { console.error(e); } finally { showLoader(false); }
        };

        // --- Other Global Functions ---
        window.createGroup = async () => { 
            const n = document.getElementById('new-group-name').value;
            const r1=document.getElementById('mufattish-r1').value, r2=document.getElementById('mufattish-r2').value, r3=document.getElementById('mufattish-r3').value, r4=document.getElementById('mufattish-r4').value;
            if(!n) return;
            await addDoc(collection(db,'tadrisi_groups'), { groupName:n, totalStudents:0, round_1_uid:r1, round_2_uid:r2, round_3_uid:r3, round_4_uid:r4 });
            document.getElementById('new-group-name').value=''; await initData();
        };
        window.deleteGroup = async (id) => { if(confirm('Delete Group?')) { await deleteDoc(doc(db,'tadrisi_groups',id)); await initData(); }};
        window.deleteStudent = async (id) => { if(confirm('Delete Student?')) { await deleteDoc(doc(db,'tadrisi_students',id)); await initData(); }};

        // --- Result Logic ---
        window.updateHeaderDate = () => { document.getElementById('result-header-date').textContent = document.getElementById('result-month-selector').value || 'Month: -- | Year: --'; };
        window.loadGroupResults = async () => {
            const gid = document.getElementById('result-group-select').value;
            if(!gid) return;
            const group = allGroups.find(g => g.id === gid);
            document.getElementById('result-group-name').textContent = group ? group.groupName : '';
            const studentsInGroup = allStudents.filter(s => s.groupId === gid);
            
            const jamiaSet = new Set(studentsInGroup.map(s => s.jamia).filter(j => j));
            const jamiaFilter = document.getElementById('filter-jamia');
            jamiaFilter.innerHTML = '<option value="all">All Jamiaat</option>';
            jamiaSet.forEach(j => jamiaFilter.innerHTML += `<option value="${j}">${j}</option>`);

            renderResultTable(studentsInGroup);
        };
        window.filterResults = () => {
            const gid = document.getElementById('result-group-select').value;
            const jamia = document.getElementById('filter-jamia').value;
            let list = allStudents.filter(s => s.groupId === gid);
            if(jamia !== 'all') list = list.filter(s => s.jamia === jamia);
            renderResultTable(list);
        };

        function renderResultTable(list) {
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            const filledList = list.filter(s => s.marks_r1 || s.marks_r2 || s.marks_r3 || s.marks_r4);
            if(filledList.length === 0) { tbody.innerHTML = '<tr><td colspan="11" class="p-8 text-gray-400">No results found.</td></tr>'; return; }
            let count = 1;
            filledList.forEach(s => {
                const getMark = (r, k) => (r && r[k]) ? Number(r[k]) : 0;
                const r1=s.marks_r1, r2=s.marks_r2, r3=s.marks_r3, r4=s.marks_r4;
                const tIbarat  = getMark(r1,'m1') + getMark(r2,'m1') + getMark(r3,'m1') + getMark(r4,'m1');
                const tTarjama = getMark(r1,'m2') + getMark(r2,'m2') + getMark(r3,'m2') + getMark(r4,'m2');
                const tSarf    = getMark(r1,'m3') + getMark(r2,'m3') + getMark(r3,'m3') + getMark(r4,'m3');
                const tNahw    = getMark(r1,'m4') + getMark(r2,'m4') + getMark(r3,'m4') + getMark(r4,'m4');
                const tAndaz   = getMark(r1,'m5') + getMark(r2,'m5') + getMark(r3,'m5') + getMark(r4,'m5');
                const grandTotal = tIbarat + tTarjama + tSarf + tNahw + tAndaz;
                const percentage = (grandTotal / 400) * 100;
                const isFail = (tIbarat < 56 || tTarjama < 56 || tSarf < 56 || tNahw < 56 || tAndaz < 56);
                let resultText = "ŸÜÿß⁄©ÿßŸÖ", resultClass = "bg-fail";
                if (!isFail) {
                    if (percentage >= 90) { resultText = "ŸÖŸÖÿ™ÿßÿ≤"; resultClass = "bg-pass"; }
                    else if (percentage >= 80) { resultText = "ÿ®€Åÿ™ÿ±"; resultClass = "bg-pass"; }
                    else if (percentage >= 70) { resultText = "ŸÖŸÜÿßÿ≥ÿ®"; resultClass = "bg-pass"; }
                }
                const cc = (v) => v < 56 ? 'text-red-600 font-bold bg-red-50' : '';
                tbody.innerHTML += `
                    <tr class="border-b border-gray-300">
                        <td class="p-2 border border-gray-300 text-sm">${count++}</td>
                        <td class="p-2 border border-gray-300 text-right pr-4"><div class="font-bold text-lg">${s.name}</div><div class="text-sm text-gray-600">${s.fatherName||''}</div></td>
                        <td class="p-2 border border-gray-300 text-sm">${s.jamia||'-'}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cc(tIbarat)}">${tIbarat}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cc(tTarjama)}">${tTarjama}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cc(tSarf)}">${tSarf}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cc(tNahw)}">${tNahw}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cc(tAndaz)}">${tAndaz}</td>
                        <td class="p-2 border border-gray-300 font-bold bg-blue-50 font-sans text-xl">${grandTotal}</td>
                        <td class="p-2 border border-gray-300 font-sans bg-blue-50">${percentage.toFixed(2)}%</td>
                        <td class="p-2 border border-gray-300 font-bold ${resultClass} text-lg">${resultText}</td>
                    </tr>`;
            });
        }
        window.exportToExcel = () => {
            const table = document.getElementById('result-table');
            if(!table) return;
            const wb = XLSX.utils.table_to_book(table, {sheet: "Result"});
            const dateStr = document.getElementById('result-month-selector').value || 'Result';
            XLSX.writeFile(wb, `Tadrisi_Result_${dateStr}.xlsx`);
        };
        
        // Mufattish Status (Same logic)
        function renderMufattishStatus() {
            const tbody = document.getElementById('mufattish-status-tbody');
            tbody.innerHTML = '';
            allMufattish.forEach(m => {
                let assignmentsHTML = '';
                allGroups.forEach(g => {
                    [1,2,3,4].forEach(r => {
                        if(g[`round_${r}_uid`] === m.id) {
                             const stInG = allStudents.filter(s => s.groupId === g.id);
                             const filled = stInG.filter(s => s[`marks_r${r}`]).length;
                             const total = stInG.length;
                             let cls = 'status-pending', txt = 'Pending';
                             if(total>0 && filled===total) { cls='status-complete'; txt='Completed'; }
                             else if(filled>0) { cls='status-ongoing'; txt=`Ongoing (${filled}/${total})`; }
                             assignmentsHTML += `<div class="mb-2 text-sm flex justify-between bg-white p-2 border rounded"><span>${g.groupName} (Sabaq ${r})</span><span class="${cls} px-2 rounded font-bold text-xs">${txt}</span></div>`;
                        }
                    });
                });
                if(!assignmentsHTML) assignmentsHTML = '<span class="text-gray-400 text-xs">No active assignments</span>';
                tbody.innerHTML += `<tr class="border-b bg-white"><td class="p-3 font-bold text-lg">${m.name}</td><td class="p-3 text-sm">${m.region}</td><td class="p-3 bg-gray-50">${assignmentsHTML}</td></tr>`;
            });
        }
    </script>
</body>
</html>
