<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Course Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2');
        }
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        .big-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* Print Settings */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-header { display: block !important; }
            /* Force background colors in print */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* Result Cell Colors */
        .bg-fail { background-color: #ef4444 !important; color: white !important; } /* Red for Fail */
        .bg-pass { background-color: #ecfccb !important; color: #1e293b !important; } /* Greenish for Pass */
        .bg-header { background-color: #fef3c7 !important; } /* Header Color */
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60]"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="border-4 border-t-teal-600 rounded-full w-12 h-12 animate-spin"></div></div>

    <header class="bg-teal-800 text-white p-4 shadow-md sticky top-0 z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Tadrisi Admin (Final Results)</h1>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 px-4 py-1.5 rounded text-sm font-semibold">Logout</button>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[98%]">
        
        <div class="flex flex-wrap gap-2 mb-6 border-b pb-2 no-print">
            <button onclick="switchTab('students')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-students">1. Add & Assign</button>
            <button onclick="switchTab('groups')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-groups">2. Manage Groups</button>
            <button onclick="switchTab('results')" class="tab-btn active px-6 py-2 rounded-t-lg font-medium border" id="tab-results">3. Final Result Sheet</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-6 py-2 rounded-t-lg font-medium border" id="tab-mufattish">4. Mufattish List</button>
        </div>

        <div id="view-students" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-blue-600">
                <h3 class="text-lg font-bold mb-2 text-blue-800"><i class="fas fa-paste"></i> Step 1: Add New Students</h3>
                <textarea id="paste-area" rows="5" class="w-full p-3 border rounded bg-gray-50 font-mono text-sm" placeholder="Paste Excel Data: RegNo | Name | Father | Jamia | Mobile"></textarea>
                <div class="flex gap-2 mt-3">
                    <button onclick="previewData()" class="bg-gray-700 text-white px-4 py-2 rounded">Preview</button>
                    <button onclick="savePastedData()" id="save-btn" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hidden">Save</button>
                </div>
                <div id="preview-container" class="hidden mt-4 border rounded overflow-hidden overflow-x-auto">
                    <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-blue-50"><tr><th class="p-2">Reg</th><th class="p-2">Name</th><th class="p-2">Father</th><th class="p-2">Jamia</th><th class="p-2">Mobile</th></tr></thead><tbody id="preview-body" class="bg-white"></tbody></table>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-orange-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-orange-800">Step 2: Assign Group</h3>
                    <div class="flex gap-2">
                        <select id="assign-group-select" class="p-2 border rounded w-64"><option value="">Select Group</option></select>
                        <button onclick="assignSelectedStudents()" class="bg-orange-600 text-white px-4 py-2 rounded font-bold">Assign</button>
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><tbody id="unassigned-tbody"></tbody></table></div>
            </div>
        </div>

        <div id="view-groups" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-teal-600">
                <h3 class="text-lg font-bold mb-4">Create Group</h3>
                <div class="flex flex-col gap-4">
                    <input type="text" id="new-group-name" placeholder="Group Name" class="w-full p-2 border rounded">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <select id="mufattish-r1" class="p-2 border rounded text-sm"></select>
                        <select id="mufattish-r2" class="p-2 border rounded text-sm"></select>
                        <select id="mufattish-r3" class="p-2 border rounded text-sm"></select>
                        <select id="mufattish-r4" class="p-2 border rounded text-sm"></select>
                    </div>
                    <button onclick="createGroup()" class="bg-teal-600 text-white px-6 py-2 rounded font-bold self-start">Create</button>
                </div>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-results" class="tab-content">
            <div id="print-section">
                <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-t-4 border-purple-600 no-print">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Final Result Sheet</h3>
                        <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1 rounded text-sm"><i class="fas fa-print"></i> Print</button>
                    </div>
                    <select id="result-group-select" onchange="loadGroupResults()" class="w-full p-2 border rounded urdu-font bg-gray-50 text-right text-lg"></select>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden border p-2 min-h-[500px]">
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-bold urdu-font" id="print-title">ÿ™ÿØÿ±€åÿ≥€å Ÿπ€åÿ≥Ÿπ ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å ŸÅÿßÿ±ŸÖ</h2>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-center border-collapse border border-gray-400 min-w-[1200px]" dir="rtl">
                            <thead class="bg-orange-100 text-gray-900 font-bold text-base urdu-font">
                                <tr>
                                    <th class="p-2 border border-gray-400 w-10">ŸÜŸÖÿ®ÿ±<br>ÿ¥ŸÖÿßÿ±</th>
                                    <th class="p-2 border border-gray-400 w-48 text-right pr-4">ŸÜÿßŸÖ ŸÖÿπ ŸàŸÑÿØ€åÿ™</th>
                                    <th class="p-2 border border-gray-400 w-32">ÿ¨ÿßŸÖÿπ€Å</th>
                                    
                                    <th class="p-2 border border-gray-400 w-16 bg-header">ÿπÿ®ÿßÿ±ÿ™<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                    <th class="p-2 border border-gray-400 w-16 bg-header">ÿ™ÿ±ÿ¨ŸÖ€Å<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                    <th class="p-2 border border-gray-400 w-16 bg-header">ÿµÿ±ŸÅ<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                    <th class="p-2 border border-gray-400 w-16 bg-header">ŸÜÿ≠Ÿà<br><span class="text-xs font-normal font-sans">(80)</span></th>
                                    <th class="p-2 border border-gray-400 w-16 bg-header">ÿßŸÜÿØÿßÿ≤ ÿ™ŸÅ€Å€åŸÖ<br><span class="text-xs font-normal font-sans">(80)</span></th>

                                    <th class="p-2 border border-gray-400 w-20 bg-blue-50">ÿ≠ÿßÿµŸÑ ⁄©ÿ±ÿØ€Å<br>⁄©ŸÑ ŸÜŸÖÿ®ÿ±</th>
                                    <th class="p-2 border border-gray-400 w-16 bg-blue-50">ŸÅ€åÿµÿØ</th>
                                    <th class="p-2 border border-gray-400 w-24 bg-orange-200">⁄©€åŸÅ€åÿ™ (ÿ±ÿ≤ŸÑŸπ)</th>
                                    <th class="p-2 border border-gray-400 no-print w-10">ÿß€å⁄©ÿ¥ŸÜ</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody" class="text-lg urdu-font text-gray-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-gray-600">
                <h3 class="text-lg font-bold mb-4">Registered Mufattish</h3>
                <table class="w-full text-left border-collapse"><tbody id="mufattish-table-body"></tbody></table>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish = [];
        let parsedStudents = [];

        const showLoader = (show) => document.getElementById('loader').classList.toggle('hidden', !show);
        const showToast = (msg, type='success') => { const el = document.getElementById('notification'); el.textContent = msg; el.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] ${type==='error'?'bg-red-500':'bg-emerald-600'}`; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3000); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const d = await getDoc(doc(db, 'users', user.uid));
                if(d.exists() && ['admin','tadrisi_course_management','tadrisi_course_admin'].includes(d.data().role)) {
                    await initData();
                } else window.location.href = 'index.html';
            } else window.location.href = 'index.html';
            showLoader(false);
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        window.switchTab = (tab) => { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`view-${tab}`).classList.remove('hidden'); 
            document.getElementById(`tab-${tab}`).classList.add('active'); 
        };

        async function initData() { 
            await fetchMufattishList(); 
            await fetchGroupsList();
            await fetchUnassignedStudents(); 
        }

        // --- 1. COPY PASTE LOGIC ---
        window.previewData = () => {
            const text = document.getElementById('paste-area').value.trim();
            if(!text) return showToast('Please paste data', 'error');
            const rows = text.split('\n'); parsedStudents = []; let html = '';
            rows.forEach(row => {
                let cols = row.split('\t');
                let reg = cols[0]?.trim()||'', name = cols[1]?.trim()||'', father = cols[2]?.trim()||'', jamia = cols[3]?.trim()||'', mobile = cols[4]?.trim()||'';
                if(name) { 
                    parsedStudents.push({ reg, name, father, jamia, mobile });
                    html += `<tr class="border-b"><td class="p-2">${reg}</td><td class="p-2 font-bold">${name}</td><td class="p-2">${father}</td><td class="p-2 text-xs">${jamia}</td><td class="p-2 text-xs">${mobile}</td></tr>`;
                }
            });
            document.getElementById('preview-body').innerHTML = html;
            document.getElementById('preview-container').classList.remove('hidden');
            if(parsedStudents.length>0) { document.getElementById('save-btn').classList.remove('hidden'); document.getElementById('save-btn').textContent=`Save ${parsedStudents.length}`; }
        };

        window.savePastedData = async () => {
            if(parsedStudents.length===0) return; showLoader(true);
            try {
                const batch = writeBatch(db);
                parsedStudents.forEach(s => {
                    const ref = doc(collection(db, 'tadrisi_students'));
                    batch.set(ref, { regNo:s.reg, name:s.name, fatherName:s.father, jamia:s.jamia, mobile:s.mobile, groupId:null, createdAt:new Date() });
                });
                await batch.commit(); showToast('Saved!');
                document.getElementById('paste-area').value=''; document.getElementById('preview-container').classList.add('hidden'); document.getElementById('save-btn').classList.add('hidden');
                await fetchUnassignedStudents(); 
            } catch(e) { console.error(e); } finally { showLoader(false); }
        };

        // --- 2. ASSIGNMENT LOGIC ---
        async function fetchUnassignedStudents() {
            const tbody = document.getElementById('unassigned-tbody');
            const q = query(collection(db, 'tadrisi_students'), where('groupId', '==', null));
            const snap = await getDocs(q);
            tbody.innerHTML = '';
            if(snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No unassigned students.</td></tr>'; return; }
            snap.forEach(d => {
                const s = d.data();
                tbody.innerHTML += `<tr class="border-b text-sm"><td class="p-3 w-10"><input type="checkbox" class="student-checkbox big-checkbox" value="${d.id}"></td><td class="p-3">${s.regNo}</td><td class="p-3 font-bold urdu-font">${s.name}</td><td class="p-3 urdu-font">${s.fatherName}</td><td class="p-3 urdu-font">${s.jamia||'-'}</td></tr>`;
            });
        }

        window.assignSelectedStudents = async () => {
            const gid = document.getElementById('assign-group-select').value;
            const selected = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
            if(!gid || selected.length===0) return showToast('Select group and students', 'error');
            showLoader(true);
            try {
                const batch = writeBatch(db);
                selected.forEach(sid => { const ref = doc(db, 'tadrisi_students', sid); batch.update(ref, { groupId: gid }); });
                const gRef = doc(db, 'tadrisi_groups', gid); batch.update(gRef, { totalStudents: increment(selected.length) });
                await batch.commit(); showToast('Assigned!'); await fetchUnassignedStudents(); await fetchGroupsList();
            } catch(e) { console.error(e); } finally { showLoader(false); }
        };

        // --- 3. COMMON LOGIC ---
        async function fetchMufattishList() {
            const q = query(collection(db, 'users'), where('role', '==', 'tadrisi_course_mufattish'));
            const snap = await getDocs(q); allMufattish = snap.docs.map(d => ({id:d.id, ...d.data()}));
            const opts = '<option value="">-- Assign --</option>' + allMufattish.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            ['mufattish-r1', 'mufattish-r2', 'mufattish-r3', 'mufattish-r4'].forEach(id => document.getElementById(id).innerHTML = opts);
            document.getElementById('mufattish-table-body').innerHTML = allMufattish.map(m => `<tr class="border-b"><td class="p-2">${m.name}</td><td class="p-2 text-sm">${m.email}</td><td class="p-2 urdu-font">${m.region||'-'}</td></tr>`).join('');
        }

        async function fetchGroupsList() {
            const q = query(collection(db, 'tadrisi_groups')); const snap = await getDocs(q);
            const groups = snap.docs.map(d => ({id:d.id, ...d.data()}));
            const opts = '<option value="">-- Select Group --</option>' + groups.map(g => `<option value="${g.id}">${g.groupName} (${g.totalStudents||0})</option>`).join('');
            document.getElementById('assign-group-select').innerHTML = opts;
            document.getElementById('result-group-select').innerHTML = opts;
            document.getElementById('groups-list-container').innerHTML = groups.map(g => `<div class="bg-white p-4 shadow border rounded relative"><h4 class="font-bold text-teal-800">${g.groupName}</h4><p class="text-xs">Students: ${g.totalStudents}</p><button onclick="deleteGroup('${g.id}')" class="absolute top-2 right-2 text-red-400"><i class="fas fa-trash"></i></button></div>`).join('');
        }

        window.createGroup = async () => {
            const n = document.getElementById('new-group-name').value;
            const r1 = document.getElementById('mufattish-r1').value, r2 = document.getElementById('mufattish-r2').value, r3 = document.getElementById('mufattish-r3').value, r4 = document.getElementById('mufattish-r4').value;
            if(!n) return;
            await addDoc(collection(db, 'tadrisi_groups'), { groupName:n, totalStudents:0, round_1_uid:r1, round_2_uid:r2, round_3_uid:r3, round_4_uid:r4 });
            document.getElementById('new-group-name').value=''; await fetchGroupsList();
        };
        window.deleteGroup = async (id) => { if(confirm('Delete?')) { await deleteDoc(doc(db,'tadrisi_groups',id)); await fetchGroupsList(); }};

        // ===============================================
        // üî•üî• FINAL RESULT LOGIC (AGGREGATION) üî•üî•
        // ===============================================
        window.loadGroupResults = async () => {
            const gid = document.getElementById('result-group-select').value;
            if(!gid) return;
            const gText = document.getElementById('result-group-select').options[document.getElementById('result-group-select').selectedIndex].text;
            document.getElementById('print-title').textContent = gText.split('(')[0] + " - ÿ™ÿØÿ±€åÿ≥€å Ÿπ€åÿ≥Ÿπ ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å";

            const q = query(collection(db, 'tadrisi_students'), where('groupId', '==', gid));
            const snap = await getDocs(q);
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            let count = 1;

            snap.forEach(d => {
                const s = d.data();
                
                // --- 1. AGGREGATE MARKS FROM 4 ROUNDS ---
                // Har round se subject ke marks nikalein (Agar null hai to 0)
                // Subjects: m1=Ibarat, m2=Tarjama, m3=Sarf, m4=Nahw, m5=Andaz
                
                const getMark = (roundObj, key) => (roundObj && roundObj[key] !== undefined && roundObj[key] !== null) ? Number(roundObj[key]) : 0;

                const r1 = s.marks_r1 || {}, r2 = s.marks_r2 || {}, r3 = s.marks_r3 || {}, r4 = s.marks_r4 || {};

                const totalIbarat  = getMark(r1,'m1') + getMark(r2,'m1') + getMark(r3,'m1') + getMark(r4,'m1');
                const totalTarjama = getMark(r1,'m2') + getMark(r2,'m2') + getMark(r3,'m2') + getMark(r4,'m2');
                const totalSarf    = getMark(r1,'m3') + getMark(r2,'m3') + getMark(r3,'m3') + getMark(r4,'m3');
                const totalNahw    = getMark(r1,'m4') + getMark(r2,'m4') + getMark(r3,'m4') + getMark(r4,'m4');
                const totalAndaz   = getMark(r1,'m5') + getMark(r2,'m5') + getMark(r3,'m5') + getMark(r4,'m5');

                const grandTotal = totalIbarat + totalTarjama + totalSarf + totalNahw + totalAndaz;
                const percentage = (grandTotal / 400) * 100;

                // --- 2. LOGIC FOR RESULT (KAIFIYAT) ---
                // Pass criteria: Each subject must be >= 56
                const isFailSubject = (totalIbarat < 56 || totalTarjama < 56 || totalSarf < 56 || totalNahw < 56 || totalAndaz < 56);
                
                let resultText = "";
                let resultClass = "";

                if (isFailSubject) {
                    resultText = "ŸÜÿß⁄©ÿßŸÖ";
                    resultClass = "bg-fail"; // Red
                } else {
                    // Grading Logic
                    if (percentage >= 90) { resultText = "ŸÖŸÖÿ™ÿßÿ≤"; resultClass = "bg-pass"; }
                    else if (percentage >= 80) { resultText = "ÿ®€Åÿ™ÿ±"; resultClass = "bg-pass"; }
                    else if (percentage >= 70) { resultText = "ŸÖŸÜÿßÿ≥ÿ®"; resultClass = "bg-pass"; }
                    else { resultText = "ŸÜÿß⁄©ÿßŸÖ"; resultClass = "bg-fail"; }
                }

                // Helper for individual cell coloring
                const cellClass = (val) => val < 56 ? 'text-red-600 font-bold bg-red-50' : '';

                tbody.innerHTML += `
                    <tr class="border-b border-gray-300">
                        <td class="p-2 border border-gray-300 font-sans text-sm">${count++}</td>
                        <td class="p-2 border border-gray-300 text-right pr-4">
                            <div class="font-bold text-lg">${s.name}</div>
                            <div class="text-sm text-gray-600">${s.fatherName||''}</div>
                        </td>
                        <td class="p-2 border border-gray-300 text-sm">${s.jamia || '-'}</td>
                        
                        <td class="p-2 border border-gray-300 font-sans ${cellClass(totalIbarat)}">${totalIbarat}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cellClass(totalTarjama)}">${totalTarjama}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cellClass(totalSarf)}">${totalSarf}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cellClass(totalNahw)}">${totalNahw}</td>
                        <td class="p-2 border border-gray-300 font-sans ${cellClass(totalAndaz)}">${totalAndaz}</td>

                        <td class="p-2 border border-gray-300 font-sans font-bold bg-blue-50 text-xl">${grandTotal}</td>
                        <td class="p-2 border border-gray-300 font-sans bg-blue-50">${percentage.toFixed(2)}%</td>
                        
                        <td class="p-2 border border-gray-300 font-bold ${resultClass} text-lg">${resultText}</td>
                        
                        <td class="p-2 border border-gray-300 no-print">
                            <button onclick="deleteStudent('${d.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        };

        window.deleteStudent = async (id) => { if(confirm('Delete Student?')) { await deleteDoc(doc(db,'tadrisi_students',id)); await fetchUnassignedStudents(); await loadGroupResults(); }};
    </script>
</body>
</html>
