<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Admin Pro (Final Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2'); }
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; font-size: 16px; } 
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; font-size: 1.1rem; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        .result-tab-btn { background-color: #e2e8f0; color: #334155; padding: 10px 20px; font-size: 16px; font-weight: 600; border-radius: 8px 8px 0 0; border: 1px solid #cbd5e1; border-bottom: none; }
        .result-tab-btn.active { background-color: #fff; color: #0f766e; border-top: 4px solid #0f766e; }
        
        .bg-fail { background-color: #fee2e2 !important; color: #b91c1c !important; }
        .bg-pass { background-color: #dcfce7 !important; color: #15803d !important; }
        .bg-header { background-color: #fef3c7 !important; font-size: 1.1rem !important; color: #0f172a; }
        
        /* Modal & Image Styles */
        .student-thumb { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; cursor: pointer; }
        .view-photo-btn { cursor: pointer; color: #0f766e; background: #ccfbf1; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; border: 1px solid #99f6e4; }
        
        /* Calculation Text Style */
        .calc-text { font-size: 0.8rem; color: #64748b; display: block; white-space: nowrap; letter-spacing: 0.5px; }
        .total-text { font-size: 1.2rem; font-weight: bold; color: #0f172a; }
        
        /* Larger Table Padding */
        th, td { padding: 12px 8px !important; }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg z-[60] text-lg font-bold"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="text-center"><div class="border-4 border-t-teal-600 rounded-full w-12 h-12 animate-spin mx-auto mb-2"></div><p class="text-sm font-bold text-teal-800">Loading...</p></div></div>

    <header class="bg-white text-gray-800 p-4 shadow-sm sticky top-0 z-40 border-b border-gray-200 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-teal-800 flex items-center gap-2"><i class="fas fa-user-graduate"></i> Tadrisi Admin</h1>
            <div class="flex gap-2">
                <button onclick="fixGroupCounts()" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-4 py-2 rounded font-bold border border-yellow-300">Fix Counts</button>
                <button id="logout-btn" class="bg-red-100 hover:bg-red-200 text-red-800 px-4 py-2 rounded font-bold border border-red-300">Logout</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[98%]">
        
        <div class="flex flex-wrap gap-2 mb-4 border-b pb-2 no-print">
            <button onclick="switchTab('students')" class="tab-btn active px-6 py-2 rounded-t-lg font-bold border text-base" id="tab-students">1. Students List</button>
            <button onclick="switchTab('groups')" class="tab-btn px-6 py-2 rounded-t-lg font-bold border text-base" id="tab-groups">2. Groups</button>
            <button onclick="switchTab('results')" class="tab-btn px-6 py-2 rounded-t-lg font-bold border text-base" id="tab-results">3. Final Result</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-6 py-2 rounded-t-lg font-bold border text-base" id="tab-mufattish">4. Mufattish</button>
        </div>

        <div id="view-students" class="tab-content">
            <div class="bg-white p-4 rounded shadow mb-4 border-l-4 border-teal-600 flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 w-full">
                    <label class="text-sm font-bold text-gray-500">Jamia Name</label>
                    <input type="text" id="link-jamia-name" class="w-full p-2 border rounded urdu-font text-lg" placeholder="Pre-fill Jamia..." oninput="generateLink()">
                </div>
                <div class="flex-[2] w-full flex">
                    <input type="text" id="shareable-link" class="w-full p-2 border rounded-l bg-gray-50 text-sm text-gray-600" readonly>
                    <button onclick="copyLink()" class="bg-teal-600 text-white px-4 py-2 rounded-r font-bold text-sm">Copy Link</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded shadow border-t-4 border-orange-500">
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="student-filter-jamia" onchange="filterStudentsTable()" class="p-2 border rounded text-base w-48 urdu-font"><option value="all">All Jamiaat</option></select>
                        <select id="student-filter-group" onchange="loadStudentsByGroup()" class="p-2 border rounded text-base w-48"><option value="">Select Group</option><option value="all">All Groups</option></select>
                        <button onclick="fetchAllStudents()" class="bg-blue-50 text-blue-700 border border-blue-200 px-4 py-2 rounded font-bold"><i class="fas fa-sync"></i> Reload</button>
                    </div>
                    <div class="relative w-full md:w-auto">
                        <input type="text" id="search-input" oninput="searchStudents()" class="p-2 pl-8 border rounded text-base w-full" placeholder="Search...">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="overflow-x-auto min-h-[400px]">
                    <table class="w-full text-left border-collapse min-w-[1000px]">
                        <thead class="bg-gray-100 text-gray-800 text-sm font-bold uppercase">
                            <tr>
                                <th class="p-3 border-b w-10 text-center">#</th>
                                <th class="p-3 border-b w-16 text-center">Profile</th>
                                <th class="p-3 border-b">Roll No</th>
                                <th class="p-3 border-b">Name / Father</th>
                                <th class="p-3 border-b">Jamia</th>
                                <th class="p-3 border-b">City</th>
                                <th class="p-3 border-b">Mobile</th>
                                <th class="p-3 border-b">Group</th>
                                <th class="p-3 border-b w-32">Action</th>
                            </tr>
                        </thead>
                        <tbody id="students-master-tbody" class="text-base"><tr><td colspan="9" class="text-center p-6 text-gray-500 text-lg">Select a group or search to load data.</td></tr></tbody>
                    </table>
                    <div class="flex justify-between items-center mt-4 bg-gray-50 p-3 rounded border no-print">
    <div id="showing-text" class="font-bold text-teal-800"></div>
    <div id="pagination-controls" class="flex gap-1"></div>
</div>
                </div>
            </div>
        </div>

        <div id="view-groups" class="tab-content hidden">
            <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-teal-600">
                <h3 class="font-bold mb-4 text-lg">Add Group</h3>
                <div class="flex flex-col gap-4">
                    <input type="text" id="new-group-name" placeholder="Group Name" class="w-full p-3 border rounded urdu-font text-lg">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <select id="mufattish-r1" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r2" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r3" class="p-2 border rounded text-sm bg-gray-50"></select>
                        <select id="mufattish-r4" class="p-2 border rounded text-sm bg-gray-50"></select>
                    </div>
                    <button onclick="createGroup()" class="bg-teal-600 text-white px-6 py-2 rounded font-bold text-lg w-max">Create Group</button>
                </div>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-results" class="tab-content hidden">
            <div class="bg-white p-4 rounded shadow mb-4 border-l-4 border-purple-600 no-print">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <select id="result-group-select" onchange="loadGroupResults()" class="w-full p-2 border rounded text-base bg-gray-50"><option value="">-- Select Group --</option></select>
                    <select id="filter-jamia" onchange="filterResults()" class="w-full p-2 border rounded urdu-font text-base bg-gray-50"><option value="all">All Jamiaat</option></select>
                    <div class="flex gap-2">
                        <select id="history-select" class="p-2 border rounded text-sm bg-yellow-50 border-yellow-300 w-full" onchange="loadHistoryRecord()"><option value="">-- History --</option></select>
                        <input type="month" id="result-month-selector" class="w-32 p-2 border rounded text-sm">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveResultToHistory()" class="bg-purple-600 text-white px-4 py-2 rounded font-bold shadow">Save</button>
                        <button onclick="exportResultToExcel()" class="bg-green-600 text-white px-4 py-2 rounded font-bold shadow">Excel</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded shadow overflow-hidden border p-4 min-h-[500px]">
                <div class="text-center mb-4">
                    <h2 class="text-3xl font-bold urdu-font text-teal-800">ÿ™ÿØÿ±€åÿ≥€å Ÿπ€åÿ≥Ÿπ ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å ŸÅÿßÿ±ŸÖ</h2>
                    <h3 class="text-xl text-gray-700 font-bold mt-2" id="result-group-name">All Groups</h3>
                </div>

                <div class="flex gap-1 border-b mb-0 px-2 overflow-x-auto no-print">
                    <button onclick="switchResultTab('1')" class="result-tab-btn" id="rtab-1">Sabaq 1</button>
                    <button onclick="switchResultTab('2')" class="result-tab-btn" id="rtab-2">Sabaq 2</button>
                    <button onclick="switchResultTab('3')" class="result-tab-btn" id="rtab-3">Sabaq 3</button>
                    <button onclick="switchResultTab('4')" class="result-tab-btn" id="rtab-4">Sabaq 4</button>
                    <button onclick="switchResultTab('final')" class="result-tab-btn active" id="rtab-final">Final Result</button>
                </div>

                <div class="overflow-x-auto pt-2">
                    <table class="w-full text-center border-collapse border border-gray-400 min-w-[1400px]" dir="rtl" id="result-table">
                        <thead class="bg-orange-100 text-gray-900 font-bold text-base urdu-font border-b-2 border-gray-400" id="result-thead">
                            </thead>
                        <tbody id="results-tbody" class="text-lg urdu-font text-gray-800"><tr><td colspan="14" class="p-8 text-center text-gray-400 text-xl">Select Group to View Result</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-6 rounded shadow border-t-4 border-gray-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Mufattish Status (Sabaq Wise)</h3>
                    <button onclick="renderMufattishStatus()" class="text-blue-600 hover:underline text-sm font-bold"><i class="fas fa-sync"></i> Refresh Status</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center border-collapse min-w-[1000px]">
                        <thead class="bg-gray-800 text-white text-sm uppercase">
                            <tr>
                                <th class="p-3 border text-left w-48">Mufattish Name</th>
                                <th class="p-3 border w-1/5">Sabaq 1</th>
                                <th class="p-3 border w-1/5">Sabaq 2</th>
                                <th class="p-3 border w-1/5">Sabaq 3</th>
                                <th class="p-3 border w-1/5">Sabaq 4</th>
                            </tr>
                        </thead>
                        <tbody id="mufattish-status-tbody" class="text-sm bg-white">
                            <tr><td colspan="5" class="p-6 text-center text-gray-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[70] p-4 overflow-y-auto pt-10 pb-10">
        <div class="bg-white rounded-xl shadow-2xl w-[800px] max-w-full max-h-[90vh] relative overflow-y-auto transform transition-all scale-100">
            <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 bg-white rounded-full p-2 shadow-lg z-10"><i class="fas fa-times text-2xl"></i></button>
            <input type="hidden" id="pm-student-id">
            
            <div class="flex flex-col md:flex-row bg-teal-50 p-8 border-b border-teal-200">
                <div class="w-full md:w-1/3 flex justify-center mb-4 md:mb-0">
                    <img id="pm-image" src="" class="w-48 h-48 rounded-full border-8 border-white shadow-xl object-cover bg-gray-200" onclick="openImageModal(this.src)">
                </div>
                <div class="w-full md:w-2/3 text-center md:text-left md:pl-8 flex flex-col justify-center">
                    <h2 id="pm-name" class="text-3xl font-bold text-teal-900 urdu-font mb-2">Student Name</h2>
                    <p id="pm-father" class="text-xl text-gray-700 urdu-font mb-4">Father Name</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm mt-2 text-gray-800">
                        <p class="bg-white px-3 py-2 rounded shadow-sm"><i class="fas fa-id-card text-teal-600 mr-2"></i> <span id="pm-roll" class="font-bold"></span></p>
                        <p class="bg-white px-3 py-2 rounded shadow-sm"><i class="fas fa-phone text-teal-600 mr-2"></i> <span id="pm-mobile" class="font-bold"></span></p>
                        <p class="col-span-1 md:col-span-2 bg-white px-3 py-2 rounded shadow-sm"><i class="fas fa-mosque text-teal-600 mr-2"></i> <span id="pm-jamia" class="urdu-font font-bold text-lg"></span></p>
                    </div>
                    <button onclick="openEditModalFromProfile()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-max self-center md:self-start"><i class="fas fa-edit"></i> Edit Details</button>
                </div>
            </div>

            <div class="p-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-2xl text-gray-800 border-b-2 border-teal-500 pb-1">Result Detail</h3>
                    <span id="pm-result-status" class="px-4 py-2 rounded text-lg font-bold shadow-sm"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center border-collapse profile-table shadow-sm" dir="rtl">
                        <thead class="bg-gray-100 text-gray-800 text-lg">
                            <tr>
                                <th class="p-3 border">ÿ≥ÿ®ŸÇ / ŸÖŸÖÿ™ÿ≠ŸÜ</th>
                                <th class="p-3 border">ÿπÿ®ÿßÿ±ÿ™</th><th class="p-3 border">ÿ™ÿ±ÿ¨ŸÖ€Å</th><th class="p-3 border">ÿµÿ±ŸÅ</th><th class="p-3 border">ŸÜÿ≠Ÿà</th><th class="p-3 border">ÿßŸÜÿØÿßÿ≤</th>
                                <th class="p-3 border bg-yellow-100">⁄©ŸÑ</th>
                            </tr>
                        </thead>
                        <tbody id="pm-marks-body" class="urdu-font text-xl"></tbody>
                    </table>
                </div>
                
                <div class="mt-6 bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                    <h4 class="font-bold text-lg mb-3 text-yellow-800 flex items-center gap-2"><i class="fas fa-plus-circle"></i> Final Adjustments (Grace Marks)</h4>
                    <div class="grid grid-cols-5 gap-3 mb-4">
                        <input type="number" id="grace-m1" class="border-2 border-yellow-300 p-2 text-center text-lg rounded font-bold focus:ring-2 focus:ring-yellow-500" placeholder="+Ib">
                        <input type="number" id="grace-m2" class="border-2 border-yellow-300 p-2 text-center text-lg rounded font-bold focus:ring-2 focus:ring-yellow-500" placeholder="+Tr">
                        <input type="number" id="grace-m3" class="border-2 border-yellow-300 p-2 text-center text-lg rounded font-bold focus:ring-2 focus:ring-yellow-500" placeholder="+Sr">
                        <input type="number" id="grace-m4" class="border-2 border-yellow-300 p-2 text-center text-lg rounded font-bold focus:ring-2 focus:ring-yellow-500" placeholder="+Nh">
                        <input type="number" id="grace-m5" class="border-2 border-yellow-300 p-2 text-center text-lg rounded font-bold focus:ring-2 focus:ring-yellow-500" placeholder="+An">
                    </div>
                    <textarea id="pm-final-remarks" rows="2" class="w-full p-3 border-2 border-gray-300 rounded text-lg urdu-font mb-4 focus:ring-2 focus:ring-teal-500" placeholder="Final Remarks..."></textarea>
                    <button onclick="saveProfileChanges()" class="w-full bg-teal-700 text-white py-3 rounded text-lg font-bold hover:bg-teal-800 shadow-lg transform active:scale-95 transition">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result-edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-[80]">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-[600px] max-w-full">
            <h3 class="text-xl font-bold mb-4 text-teal-800 border-b pb-2">Edit Marks (Grace)</h3>
            <input type="hidden" id="edit-result-id">
            <div class="bg-yellow-50 p-4 rounded mb-4 border border-yellow-200">
                <h4 class="font-bold text-sm mb-2">Add Grace Marks (+)</h4>
                <div class="grid grid-cols-5 gap-2 text-center">
                    <div><label class="text-xs font-bold">Ibarat</label><input type="number" id="grace-m1-quick" class="w-full border p-2 rounded text-center font-bold text-lg"></div>
                    <div><label class="text-xs font-bold">Tarjama</label><input type="number" id="grace-m2-quick" class="w-full border p-2 rounded text-center font-bold text-lg"></div>
                    <div><label class="text-xs font-bold">Sarf</label><input type="number" id="grace-m3-quick" class="w-full border p-2 rounded text-center font-bold text-lg"></div>
                    <div><label class="text-xs font-bold">Nahw</label><input type="number" id="grace-m4-quick" class="w-full border p-2 rounded text-center font-bold text-lg"></div>
                    <div><label class="text-xs font-bold">Andaz</label><input type="number" id="grace-m5-quick" class="w-full border p-2 rounded text-center font-bold text-lg"></div>
                </div>
            </div>
            <div><label class="block text-sm font-bold mb-2">Final Remarks</label><textarea id="edit-final-remarks-quick" rows="3" class="w-full p-3 border rounded urdu-font text-lg"></textarea></div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('result-edit-modal').classList.add('hidden')" class="px-6 py-2 bg-gray-300 rounded font-bold">Cancel</button>
                <button onclick="saveResultChangesQuick()" class="px-6 py-2 bg-teal-600 text-white rounded font-bold">Save</button>
            </div>
        </div>
    </div>

    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-[90]" onclick="this.classList.add('hidden')">
        <span class="absolute top-5 right-5 text-white text-5xl cursor-pointer">&times;</span>
        <img id="full-image" class="max-w-[95%] max-h-[95vh] rounded shadow-2xl border-4 border-white">
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96 max-w-full">
            <h3 class="text-xl font-bold mb-4 text-teal-800 border-b pb-2">Edit Student Info</h3>
            <input type="hidden" id="edit-student-id">
            <div class="space-y-3 text-base">
                <input type="text" id="edit-reg" class="w-full p-2 border rounded font-mono" placeholder="Roll No">
                <input type="text" id="edit-name" class="w-full p-2 border rounded urdu-font" placeholder="Name">
                <input type="text" id="edit-father" class="w-full p-2 border rounded urdu-font" placeholder="Father Name">
                <input type="text" id="edit-jamia" class="w-full p-2 border rounded urdu-font" placeholder="Jamia">
                <input type="text" id="edit-city" class="w-full p-2 border rounded urdu-font" placeholder="City">
                <input type="text" id="edit-mobile" class="w-full p-2 border rounded font-mono" placeholder="Mobile">
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded font-bold">Cancel</button>
                <button onclick="saveEditedStudent()" class="px-4 py-2 bg-teal-600 text-white rounded font-bold">Update</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96 max-w-full">
            <h3 class="text-xl font-bold mb-4 text-blue-800 border-b pb-2">Transfer Student</h3>
            <p id="transfer-student-name" class="mb-4 text-gray-600 urdu-font text-lg"></p>
            <input type="hidden" id="transfer-student-id"><input type="hidden" id="transfer-old-group-id">
            <label class="block font-bold mb-2">New Group:</label>
            <select id="transfer-group-select" class="w-full p-3 border rounded mb-6 text-lg"></select>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('transfer-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded font-bold">Cancel</button>
                <button onclick="confirmTransfer()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">Transfer</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish=[], allGroups=[], allStudents=[], filteredList=[], currentPage=1, rowsPerPage=50;
        let currentResultData=[], activeResultTab='final';

        const showLoader=(s)=>document.getElementById('loader').classList.toggle('hidden',!s);
        const showToast=(m,t='success')=>{const e=document.getElementById('notification');e.textContent=m;e.className=`fixed top-5 right-5 text-white py-3 px-6 rounded shadow-lg z-[60] text-lg font-bold ${t==='error'?'bg-red-500':'bg-teal-600'}`;e.classList.remove('hidden');setTimeout(()=>e.classList.add('hidden'),2500);};

        onAuthStateChanged(auth, async (u)=>{ if(u){ const d=await getDoc(doc(db,'users',u.uid)); if(d.exists()&&['admin','tadrisi_course_management','tadrisi_course_admin'].includes(d.data().role))await initData(); else location.href='index.html'; }else location.href='index.html'; showLoader(false); });
        document.getElementById('logout-btn').addEventListener('click',()=>signOut(auth));
        window.switchTab=(t)=>{ document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${t}`).classList.remove('hidden'); document.getElementById(`tab-${t}`).classList.add('active'); };

        async function initData() { await fetchMufattishList(); await fetchGroupsList(); await fetchAllStudents(); await fetchHistoryList(); generateLink(); }
        async function fetchMufattishList() { const s=await getDocs(query(collection(db,'users'),where('role','==','tadrisi_course_mufattish'))); allMufattish=s.docs.map(d=>({id:d.id,...d.data()})); const o='<option value="">-- Select --</option>'+allMufattish.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); ['mufattish-r1','mufattish-r2','mufattish-r3','mufattish-r4'].forEach(i=>{const e=document.getElementById(i);if(e)e.innerHTML=o;}); }
        async function fetchGroupsList() { const s=await getDocs(query(collection(db,'tadrisi_groups'))); allGroups=s.docs.map(d=>({id:d.id,...d.data()})); allGroups.sort((a,b)=>a.groupName.localeCompare(b.groupName,undefined,{numeric:true})); document.getElementById('groups-list-container').innerHTML=allGroups.map(g=>`<div class="bg-white p-4 shadow border rounded"><h4 class="font-bold text-teal-800 text-lg">${g.groupName}</h4><span class="text-sm bg-gray-100 px-2 rounded">Students: ${g.totalStudents||0}</span><button onclick="deleteGroup('${g.id}')" class="float-right text-red-400 text-sm"><i class="fas fa-trash"></i></button></div>`).join(''); populateGroupDropdowns(); }
        async function fetchHistoryList() { try{ const s=await getDocs(query(collection(db,'tadrisi_history'))); const o='<option value="">-- History --</option>'+s.docs.map(d=>`<option value="${d.id}">${d.id.replace('_',' - ')}</option>`).join(''); document.getElementById('history-select').innerHTML=o; }catch(e){} }

        window.fetchAllStudents = async () => { showLoader(true); try{ const s=await getDocs(query(collection(db,'tadrisi_students'))); allStudents=s.docs.map(d=>({id:d.id,...d.data()})); allStudents.sort((a,b)=>(!a.groupId&&b.groupId)?-1:0); filteredList=allStudents; filterStudentsTable(); populateJamiaFilter(); showToast('Data Loaded'); }catch(e){console.error(e);}finally{showLoader(false);}};
        
        window.loadStudentsByGroup = async () => { const gid = document.getElementById('student-filter-group').value; if(!gid) return; showLoader(true); try { let q; if(gid === 'all') q = query(collection(db, 'tadrisi_students')); else if(gid === 'unassigned') q = query(collection(db, 'tadrisi_students'), where('groupId', '==', null)); else q = query(collection(db, 'tadrisi_students'), where('groupId', '==', gid)); const snap = await getDocs(q); allStudents = snap.docs.map(d => ({id:d.id, ...d.data()})); filteredList = allStudents; filterStudentsTable(); populateJamiaFilter(); } catch(e) { console.error(e); } finally { showLoader(false); } };
        window.searchStudents = async () => { const term = document.getElementById('search-input').value.trim(); if(!term) return; showLoader(true); try { let q = query(collection(db, 'tadrisi_students')); const snap = await getDocs(q); allStudents = snap.docs.map(d => ({id:d.id, ...d.data()})); filteredList = allStudents.filter(s => s.name.includes(term) || s.regNo.includes(term)); renderStudentsTable(); } catch(e){ console.error(e); } finally { showLoader(false); } };
        window.filterStudentsTable = () => { const j = document.getElementById('student-filter-jamia').value; const g = document.getElementById('student-filter-group').value; const t = document.getElementById('search-input').value.toLowerCase(); filteredList = allStudents.filter(s => { const mj = j==='all' || s.jamia===j; const mg = g==='all' || (g==='unassigned'?!s.groupId:s.groupId===g) || (!g); const mt = !t || (s.name && s.name.toLowerCase().includes(t)) || (s.regNo && s.regNo.includes(t)); return mj && mg && mt; }); currentPage=1; renderStudentsTable(); };
        function populateJamiaFilter() { const jSet = new Set(allStudents.map(s => s.jamia).filter(j=>j)); const f = document.getElementById('student-filter-jamia'); f.innerHTML='<option value="all">All Jamiaat</option>'; jSet.forEach(j => f.innerHTML += `<option value="${j}">${j}</option>`); }

        function renderStudentsTable() {
    const tb = document.getElementById('students-master-tbody'); 
    tb.innerHTML = '';
    
    if (filteredList.length === 0) { 
        tb.innerHTML = '<tr><td colspan="9" class="p-6 text-center text-gray-400 text-lg">No data.</td></tr>'; 
        return; 
    }

    const st = (currentPage - 1) * rowsPerPage;
    const en = st + rowsPerPage;
    
    filteredList.slice(st, en).forEach((s, i) => {
        const grp = allGroups.find(x => x.id === s.groupId);
        const gName = grp ? grp.groupName : '<span class="text-red-500 font-bold">Unassigned</span>';
        tb.innerHTML += `<tr class="border-b hover:bg-gray-50 align-middle">
            <td class="p-3 text-center text-gray-400">${st + i + 1}</td>
            <td class="p-3 text-center"><button class="bg-teal-100 text-teal-700 px-3 py-1 rounded text-sm font-bold hover:bg-teal-200" onclick="openProfileModal('${s.id}')"><i class="fas fa-id-card"></i> View</button></td>
            <td class="p-3 font-mono font-bold">${s.regNo || '-'}</td>
            <td class="p-3 font-bold urdu-font text-lg">${s.name}<br><span class="text-sm text-gray-500 font-normal">${s.fatherName}</span></td>
            <td class="p-3 urdu-font text-lg">${s.jamia || '-'}</td>
            <td class="p-3 urdu-font text-lg">${s.city || '-'}</td>
            <td class="p-3 font-mono">${s.mobile || '-'}</td>
            <td class="p-3 text-sm">${gName}</td>
            <td class="p-3 flex gap-2">
                <button onclick="openEditModal('${s.id}')" class="text-teal-600 text-lg"><i class="fas fa-edit"></i></button>
                <button onclick="openTransferModal('${s.id}','${s.name}','${s.groupId || ''}')" class="text-blue-600 text-lg"><i class="fas fa-exchange-alt"></i></button>
                <button onclick="deleteStudent('${s.id}')" class="text-red-500 text-lg"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });

    // üî• Ye dono lines ab sahi jagah par data fill karengi
    const stext = document.getElementById('showing-text');
    const pctrl = document.getElementById('pagination-controls');
    
    if(stext) stext.innerText = `${filteredList.length} Students`;
    
    const tp = Math.ceil(filteredList.length / rowsPerPage);
    if(pctrl) {
        let b = ''; 
        if (tp > 1) { 
            b += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50"><i class="fas fa-chevron-left"></i></button> 
                  <span class="px-4 py-1 font-bold">${currentPage} / ${tp}</span> 
                  <button onclick="changePage(${currentPage + 1})" ${currentPage === tp ? 'disabled' : ''} class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50"><i class="fas fa-chevron-right"></i></button>`; 
        }
        pctrl.innerHTML = b;
    }
}
        window.changePage=(p)=>{ const t=Math.ceil(filteredList.length/rowsPerPage); if(p<1||p>t)return; currentPage=p; renderStudentsTable(); };

        // Result Logic
        window.switchResultTab=(t)=>{ document.querySelectorAll('.result-tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`rtab-${t}`).classList.add('active'); activeResultTab=t; renderResultTable(currentResultData); };
        window.loadGroupResults = async () => { const gid = document.getElementById('result-group-select').value; if(!gid) return; showLoader(true); try { if(gid==='all') { const q=query(collection(db,'tadrisi_students')); const snap=await getDocs(q); currentResultData=snap.docs.map(d=>({id:d.id, ...d.data()})); document.getElementById('result-group-name').textContent='All Groups'; } else { const q=query(collection(db,'tadrisi_students'), where('groupId','==',gid)); const snap=await getDocs(q); currentResultData=snap.docs.map(d=>({id:d.id, ...d.data()})); const grp=allGroups.find(x=>x.id===gid); document.getElementById('result-group-name').textContent=grp?grp.groupName:''; } const jSet=new Set(currentResultData.map(s=>s.jamia).filter(j=>j)); const jF=document.getElementById('filter-jamia'); jF.innerHTML='<option value="all">All</option>'; jSet.forEach(j=>jF.innerHTML+=`<option value="${j}">${j}</option>`); renderResultTable(currentResultData); } catch(e){console.error(e);} finally{showLoader(false);} };
        window.filterResults=()=>{ const j=document.getElementById('filter-jamia').value; let l=currentResultData; if(j!=='all') l=l.filter(s=>s.jamia===j); renderResultTable(l); };

        function renderResultTable(list) {
            const thead=document.getElementById('result-thead'); const tbody=document.getElementById('results-tbody'); tbody.innerHTML='';
            
            // üî• HEADER LOGIC FIXED üî•
            let hHtml=`<tr><th class="p-3 border w-10">#</th><th class="p-3 border w-12 text-center">Profile</th><th class="p-3 border w-48 text-right pr-4">ŸÜÿßŸÖ ŸÖÿπ ŸàŸÑÿØ€åÿ™</th><th class="p-3 border w-32">ÿ¨ÿßŸÖÿπ€Å</th>`;
            if(activeResultTab==='final') hHtml+=`<th class="p-3 border bg-blue-50">ÿπÿ®ÿßÿ±ÿ™ (80)</th><th class="p-3 border bg-blue-50">ÿ™ÿ±ÿ¨ŸÖ€Å (80)</th><th class="p-3 border bg-blue-50">ÿµÿ±ŸÅ (80)</th><th class="p-3 border bg-blue-50">ŸÜÿ≠Ÿà (80)</th><th class="p-3 border bg-blue-50">ÿßŸÜÿØÿßÿ≤ (80)</th><th class="p-3 border bg-yellow-100">⁄©ŸÑ ŸÜŸÖÿ®ÿ± (400)</th><th class="p-3 border bg-yellow-100">ŸÅ€åÿµÿØ</th><th class="p-3 border bg-orange-200">⁄©€åŸÅ€åÿ™</th><th class="p-3 border w-32">ÿ™ÿßÿ´ÿ±ÿßÿ™</th><th class="p-3 border no-print w-10">Edit</th></tr>`;
            else hHtml+=`<th class="p-3 border bg-header">ÿπÿ®ÿßÿ±ÿ™ (20)</th><th class="p-3 border bg-header">ÿ™ÿ±ÿ¨ŸÖ€Å (20)</th><th class="p-3 border bg-header">ÿµÿ±ŸÅ (20)</th><th class="p-3 border bg-header">ŸÜÿ≠Ÿà (20)</th><th class="p-3 border bg-header">ÿßŸÜÿØÿßÿ≤ (20)</th><th class="p-3 border bg-yellow-100">⁄©ŸÑ ŸÜŸÖÿ®ÿ± (100)</th><th class="p-3 border bg-orange-200">ÿ™ÿßÿ´ÿ±ÿßÿ™</th></tr>`;
            thead.innerHTML=hHtml;

            if(list.length===0){ tbody.innerHTML='<tr><td colspan="14" class="p-8 text-center text-gray-400 text-xl">No results found.</td></tr>'; return; }
            let count = 1;
            list.forEach(s => {
                const gm=(r,k)=>(r&&r[k])?Number(r[k]):0;
                let row=`<tr class="border-b hover:bg-gray-50 text-base"><td class="p-2 border text-gray-500">${count++}</td><td class="p-2 border text-center"><button class="bg-teal-100 text-teal-800 px-2 py-1 rounded font-bold text-xs hover:bg-teal-200" onclick="openProfileModal('${s.id}')">View</button></td><td class="p-2 border text-right font-bold text-lg">${s.name}<br><span class="text-sm text-gray-500 font-normal">${s.fatherName}</span></td><td class="p-2 border urdu-font text-lg">${s.jamia}</td>`;
                
                if(activeResultTab==='final'){
                    const gr=s.grace_marks||{}; const g1=Number(gr.m1)||0,g2=Number(gr.m2)||0,g3=Number(gr.m3)||0,g4=Number(gr.m4)||0,g5=Number(gr.m5)||0;
                    
                    const m1R1=gm(s.marks_r1,'m1'), m1R2=gm(s.marks_r2,'m1'), m1R3=gm(s.marks_r3,'m1'), m1R4=gm(s.marks_r4,'m1');
                    const m1=m1R1+m1R2+m1R3+m1R4+g1;
                    
                    const m2R1=gm(s.marks_r1,'m2'), m2R2=gm(s.marks_r2,'m2'), m2R3=gm(s.marks_r3,'m2'), m2R4=gm(s.marks_r4,'m2');
                    const m2=m2R1+m2R2+m2R3+m2R4+g2;

                    const m3R1=gm(s.marks_r1,'m3'), m3R2=gm(s.marks_r2,'m3'), m3R3=gm(s.marks_r3,'m3'), m3R4=gm(s.marks_r4,'m3');
                    const m3=m3R1+m3R2+m3R3+m3R4+g3;

                    const m4R1=gm(s.marks_r1,'m4'), m4R2=gm(s.marks_r2,'m4'), m4R3=gm(s.marks_r3,'m4'), m4R4=gm(s.marks_r4,'m4');
                    const m4=m4R1+m4R2+m4R3+m4R4+g4;

                    const m5R1=gm(s.marks_r1,'m5'), m5R2=gm(s.marks_r2,'m5'), m5R3=gm(s.marks_r3,'m5'), m5R4=gm(s.marks_r4,'m5');
                    const m5=m5R1+m5R2+m5R3+m5R4+g5;

                    const gt=m1+m2+m3+m4+m5; const pct=(gt/400)*100; const fail=(m1<56||m2<56||m3<56||m4<56||m5<56);
                    let txt="ŸÜÿß⁄©ÿßŸÖ",cls="bg-fail"; if(!fail&&gt>0){ if(pct>=90){txt="ŸÖŸÖÿ™ÿßÿ≤";cls="bg-pass";}else if(pct>=80){txt="ÿ®€Åÿ™ÿ±";cls="bg-pass";}else if(pct>=70){txt="ŸÖŸÜÿßÿ≥ÿ®";cls="bg-pass";} } if(gt===0){txt="-";cls="";}
                    
                    const sc=(v1,v2,v3,v4,g,tot)=>{
                        let str = `${v1}+${v2}+${v3}+${v4}`;
                        if(g>0) str += `+(${g})`;
                        return `<span class="calc-text">${str} = </span><span class="total-text ${tot<56?'text-red-600':''}">${tot}</span>`;
                    };

                    row += `<td class="p-2 border text-center">${sc(m1R1,m1R2,m1R3,m1R4,g1,m1)}</td><td class="p-2 border text-center">${sc(m2R1,m2R2,m2R3,m2R4,g2,m2)}</td><td class="p-2 border text-center">${sc(m3R1,m3R2,m3R3,m3R4,g3,m3)}</td><td class="p-2 border text-center">${sc(m4R1,m4R2,m4R3,m4R4,g4,m4)}</td><td class="p-2 border text-center">${sc(m5R1,m5R2,m5R3,m5R4,g5,m5)}</td><td class="p-2 border font-bold bg-yellow-50 text-xl">${gt}</td><td class="p-2 border bg-yellow-50">${pct.toFixed(1)}%</td><td class="p-2 border font-bold ${cls} text-lg">${txt}</td><td class="p-2 border text-xs urdu-font text-teal-800">${s.final_remarks||'-'}</td><td class="p-2 border no-print"><button onclick="openResultEditModal('${s.id}')" class="text-blue-600 hover:text-blue-800 text-lg"><i class="fas fa-edit"></i></button></td>`;
                } else {
                    const r=s[`marks_r${activeResultTab}`]||{}; const kf=s[`kaifiyat_r${activeResultTab}`]||'-'; const m1=gm(r,'m1'),m2=gm(r,'m2'),m3=gm(r,'m3'),m4=gm(r,'m4'),m5=gm(r,'m5'); const t=m1+m2+m3+m4+m5;
                    row+=`<td class="p-2 border text-center">${m1}</td><td class="p-2 border text-center">${m2}</td><td class="p-2 border text-center">${m3}</td><td class="p-2 border text-center">${m4}</td><td class="p-2 border text-center">${m5}</td><td class="p-2 border font-bold bg-yellow-50 text-xl">${t}</td><td class="p-2 border text-sm text-right">${kf}</td>`;
                }
                tbody.innerHTML += row + '</tr>';
            });
        }

        window.openProfileModal = (sid) => {
    let s = currentResultData.find(x => x.id === sid);
    if(!s) s = filteredList.find(x => x.id === sid);
    if(!s) s = allStudents.find(x => x.id === sid);
    if(!s) return;

    document.getElementById('pm-student-id').value = sid;
    document.getElementById('pm-image').src = s.photoBase64 || 'https://placehold.co/150x150/e2e8f0/94a3b8?text=No+Img';
    document.getElementById('pm-name').textContent = s.name;
    document.getElementById('pm-father').textContent = s.fatherName;
    document.getElementById('pm-roll').textContent = s.regNo || '-';
    document.getElementById('pm-mobile').textContent = s.mobile || '-';
    document.getElementById('pm-jamia').textContent = s.jamia || '-';
    
    const gr = s.grace_marks || {}; 
    [1,2,3,4,5].forEach(i => document.getElementById(`grace-m${i}`).value = gr[`m${i}`] || '');
    document.getElementById('pm-final-remarks').value = s.final_remarks || '';

    const tbody = document.getElementById('pm-marks-body'); 
    tbody.innerHTML = '';
    const gm = (r, k) => (r && r[k]) ? Number(r[k]) : 0;
    const getName = (uid) => allMufattish.find(m => m.id === uid)?.name || 'Pending';

    // üî¥ Logic 1: Agar kisi sabaq me marks 14 se kam hon to highlight
    const getScoreClass = (score) => (score > 0 && score < 14) ? 'bg-red-100 text-red-700 font-bold' : '';

    let m1T=0, m2T=0, m3T=0, m4T=0, m5T=0, gTotal=0;

    for(let i=1; i<=4; i++) {
        const r = s[`marks_r${i}`] || {};
        const checker = s[`checkedBy_r${i}`];
        const v1=gm(r,'m1'), v2=gm(r,'m2'), v3=gm(r,'m3'), v4=gm(r,'m4'), v5=gm(r,'m5');
        
        m1T+=v1; m2T+=v2; m3T+=v3; m4T+=v4; m5T+=v5;
        const t = v1+v2+v3+v4+v5;
        gTotal += t;

        tbody.innerHTML += `
            <tr class="bg-white border-b">
                <td class="text-left p-2 border-r">
                    <span class="font-bold text-teal-700">ÿ≥ÿ®ŸÇ ${i}</span><br>
                    <span class="text-[10px] text-gray-500">${getName(checker)}</span>
                </td>
                <td class="p-2 border-r ${getScoreClass(v1)}">${v1}</td>
                <td class="p-2 border-r ${getScoreClass(v2)}">${v2}</td>
                <td class="p-2 border-r ${getScoreClass(v3)}">${v3}</td>
                <td class="p-2 border-r ${getScoreClass(v4)}">${v4}</td>
                <td class="p-2 border-r ${getScoreClass(v5)}">${v5}</td>
                <td class="font-bold bg-yellow-50 text-xl p-2">${t}</td>
            </tr>`;
    }
    
    const g1=Number(gr.m1)||0, g2=Number(gr.m2)||0, g3=Number(gr.m3)||0, g4=Number(gr.m4)||0, g5=Number(gr.m5)||0;
    gTotal += (g1+g2+g3+g4+g5);

    const f1=m1T+g1, f2=m2T+g2, f3=m3T+g3, f4=m4T+g4, f5=m5T+g5;

    // üî• Nayi Total Row (80 me se kul marks aur Failure highlight)
    tbody.innerHTML += `
        <tr class="bg-teal-900 text-white font-bold">
            <td class="p-3 text-left">Total (80)</td>
            <td class="p-2 border-r ${f1 < 56 && f1 > 0 ? 'bg-red-500' : ''}">${f1}</td>
            <td class="p-2 border-r ${f2 < 56 && f2 > 0 ? 'bg-red-500' : ''}">${f2}</td>
            <td class="p-2 border-r ${f3 < 56 && f3 > 0 ? 'bg-red-500' : ''}">${f3}</td>
            <td class="p-2 border-r ${f4 < 56 && f4 > 0 ? 'bg-red-500' : ''}">${f4}</td>
            <td class="p-2 border-r ${f5 < 56 && f5 > 0 ? 'bg-red-500' : ''}">${f5}</td>
            <td class="bg-yellow-400 text-teal-900 text-2xl p-2">${gTotal}</td>
        </tr>`;

    const pct = (gTotal/400)*100;
    const isFail = (f1 < 56 || f2 < 56 || f3 < 56 || f4 < 56 || f5 < 56);
    const badge = document.getElementById('pm-result-status');

    if(gTotal === 0) {
        badge.textContent = "Pending";
        badge.className = "px-4 py-2 bg-gray-200 text-gray-700 rounded shadow-sm border border-gray-300 font-bold";
    } else if (isFail || pct < 70) {
        badge.textContent = `FAIL (${pct.toFixed(1)}%)`;
        badge.className = "px-4 py-2 bg-red-100 text-red-800 rounded border border-red-300 shadow-sm font-bold";
    } else {
        if (pct >= 90) { badge.textContent = `MUMTAZ (${pct.toFixed(1)}%)`; badge.className = "px-4 py-2 bg-yellow-100 text-yellow-800 border border-yellow-400 rounded font-bold"; }
        else if (pct >= 80) { badge.textContent = `BEHTAR (${pct.toFixed(1)}%)`; badge.className = "px-4 py-2 bg-green-100 text-green-800 border border-green-300 rounded font-bold"; }
        else { badge.textContent = `MUNASIB (${pct.toFixed(1)}%)`; badge.className = "px-4 py-2 bg-blue-100 text-blue-800 border border-blue-300 rounded font-bold"; }
    }

    document.getElementById('profile-modal').classList.remove('hidden');
};
        window.closeProfileModal=()=>document.getElementById('profile-modal').classList.add('hidden');

        // Other Functions (Standard)
        window.openResultEditModal=(sid)=>{ const s=currentResultData.find(x=>x.id===sid); if(!s)return; document.getElementById('edit-result-id').value=sid; const gr=s.grace_marks||{}; [1,2,3,4,5].forEach(i=>document.getElementById(`grace-m${i}-quick`).value=gr[`m${i}`]||0); document.getElementById('edit-final-remarks-quick').value=s.final_remarks||''; document.getElementById('result-edit-modal').classList.remove('hidden'); };
        window.saveResultChangesQuick=async()=>{ const sid=document.getElementById('edit-result-id').value; const gr={}; [1,2,3,4,5].forEach(i=>gr[`m${i}`]=Number(document.getElementById(`grace-m${i}-quick`).value)||0); const rm=document.getElementById('edit-final-remarks-quick').value.trim(); try{ await updateDoc(doc(db,'tadrisi_students',sid),{grace_marks:gr,final_remarks:rm}); showToast('Updated'); document.getElementById('result-edit-modal').classList.add('hidden'); loadGroupResults(); }catch(e){} };
        window.saveProfileChanges=async()=>{ const sid=document.getElementById('pm-student-id').value; const gr={}; [1,2,3,4,5].forEach(i=>gr[`m${i}`]=Number(document.getElementById(`grace-m${i}`).value)||0); const rm=document.getElementById('pm-final-remarks').value; try{ await updateDoc(doc(db,'tadrisi_students',sid),{grace_marks:gr,final_remarks:rm}); showToast('Saved'); openProfileModal(sid); if(currentResultData.length>0) loadGroupResults(); }catch(e){ showToast('Error','error'); } };
        window.openEditModalFromProfile=()=>{const sid=document.getElementById('pm-student-id').value; closeProfileModal(); openEditModal(sid);};
        window.openEditModal=(id)=>{const s=filteredList.find(x=>x.id===id)||allStudents.find(x=>x.id===id); if(!s)return; document.getElementById('edit-student-id').value=s.id; document.getElementById('edit-reg').value=s.regNo||''; document.getElementById('edit-name').value=s.name||''; document.getElementById('edit-father').value=s.fatherName||''; document.getElementById('edit-jamia').value=s.jamia||''; document.getElementById('edit-city').value=s.city||''; document.getElementById('edit-mobile').value=s.mobile||''; document.getElementById('edit-modal').classList.remove('hidden');};
        window.saveEditedStudent=async()=>{const id=document.getElementById('edit-student-id').value; await updateDoc(doc(db,'tadrisi_students',id),{regNo:document.getElementById('edit-reg').value,name:document.getElementById('edit-name').value,fatherName:document.getElementById('edit-father').value,jamia:document.getElementById('edit-jamia').value,city:document.getElementById('edit-city').value,mobile:document.getElementById('edit-mobile').value}); document.getElementById('edit-modal').classList.add('hidden'); showToast('Saved'); loadStudentsByGroup();};
        window.deleteStudent=async(id)=>{if(confirm('Delete?')){await deleteDoc(doc(db,'tadrisi_students',id)); showToast('Deleted'); loadStudentsByGroup();}};
        window.openTransferModal=(sid,n,old)=>{document.getElementById('transfer-student-name').textContent=`Transfer: ${n}`;document.getElementById('transfer-student-id').value=sid;document.getElementById('transfer-old-group-id').value=old;document.getElementById('transfer-modal').classList.remove('hidden');};
        window.confirmTransfer=async()=>{const sid=document.getElementById('transfer-student-id').value;const nid=document.getElementById('transfer-group-select').value;if(!nid)return;await updateDoc(doc(db,'tadrisi_students',sid),{groupId:nid});document.getElementById('transfer-modal').classList.add('hidden');showToast('Transferred');loadStudentsByGroup();};
        
        function populateGroupDropdowns() { const o='<option value="">-- Select --</option><option value="all">All Groups</option>'+allGroups.map(g=>`<option value="${g.id}">${g.groupName}</option>`).join(''); 
            const f1=document.getElementById('student-filter-group'); if(f1) f1.innerHTML='<option value="">Select Group</option><option value="all">All</option>'+allGroups.map(g=>`<option value="${g.id}">${g.groupName}</option>`).join(''); 
            const f2=document.getElementById('result-group-select'); if(f2) f2.innerHTML=o; 
            const f3=document.getElementById('bulk-group-select'); if(f3) f3.innerHTML=o; 
            const f4=document.getElementById('transfer-group-select'); if(f4) f4.innerHTML=o; 
        }
        
        window.generateLink=()=>{const j=document.getElementById('link-jamia-name').value.trim();document.getElementById('shareable-link').value=j?`${location.href.substring(0,location.href.lastIndexOf('/'))}/tadrisi_student_form.html?jamia=${encodeURIComponent(j)}`:location.href;};
        window.copyLink=()=>{document.getElementById('shareable-link').select();document.execCommand('copy');showToast('Copied');};
        window.exportStudentList=async()=>{if(allStudents.length===0)await window.fetchAllStudents(); const d=allStudents.map(s=>({"Roll":s.regNo,"Name":s.name,"Jamia":s.jamia})); const ws=XLSX.utils.json_to_sheet(d); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Students"); XLSX.writeFile(wb,"List.xlsx");};
        window.exportResultToExcel=()=>{const t=document.getElementById('result-table');if(!t)return;const wb=XLSX.utils.table_to_book(t,{sheet:"Result"});XLSX.writeFile(wb,"Result.xlsx");};
        // üî• MUFATTISH STATUS (BIG FONTS UPDATE) üî•
        window.renderMufattishStatus = () => {
            const tbody = document.getElementById('mufattish-status-tbody'); 
            tbody.innerHTML = ''; 
            
            if (allMufattish.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">No Mufattish Found</td></tr>'; 
                return; 
            }

            allMufattish.forEach(m => {
                // 4 Columns for Sabaq
                let cells = { 1: '', 2: '', 3: '', 4: '' };

                allGroups.forEach(g => {
                    const groupStudents = allStudents.filter(s => s.groupId === g.id);
                    const total = groupStudents.length;

                    [1, 2, 3, 4].forEach(r => {
                        if (g[`round_${r}_uid`] === m.id) {
                            // Check Progress
                            const filled = groupStudents.filter(s => s[`marks_r${r}`] && s[`marks_r${r}`].m1 !== undefined).length;
                            
                            let statusClass = '';
                            let icon = '';
                            let countColor = '';

                            if (total > 0 && filled === total) {
                                // COMPLETE (Green)
                                statusClass = 'bg-green-100 border-green-300';
                                countColor = 'text-green-700';
                                icon = '<i class="fas fa-check-circle text-green-600 text-lg"></i>';
                            } else if (filled > 0) {
                                // IN PROGRESS (Yellow)
                                statusClass = 'bg-yellow-50 border-yellow-300';
                                countColor = 'text-yellow-700';
                                icon = '<i class="fas fa-clock text-yellow-600"></i>';
                            } else {
                                // PENDING (Red/Gray)
                                statusClass = 'bg-gray-50 border-gray-200';
                                countColor = 'text-gray-400';
                                icon = '';
                            }

                            // üî• CHANGE: Added 'text-xl' and 'font-black' for bigger numbers
                            cells[r] += `
                                <div class="mb-2 p-2 rounded border ${statusClass} flex justify-between items-center shadow-sm">
                                    <div class="flex flex-col">
                                        <span class="font-bold text-xs text-gray-700 truncate w-20" title="${g.groupName}">${g.groupName}</span>
                                        <span class="text-[10px] text-gray-500">Total: ${total}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-lg ${countColor}">${filled}/${total}</span>
                                        ${icon}
                                    </div>
                                </div>`;
                        }
                    });
                });

                // Empty state dash
                [1,2,3,4].forEach(i => { if(cells[i] === '') cells[i] = '<span class="text-gray-200 text-2xl">-</span>'; });

                // Render Row
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50 align-top">
                        <td class="p-4 text-left border-r bg-white">
                            <div class="font-bold text-teal-800 text-lg">${m.name}</div>
                            <div class="text-sm text-gray-500">${m.region || ''}</div>
                        </td>
                        <td class="p-2 border-r bg-gray-50/20 align-top">${cells[1]}</td>
                        <td class="p-2 border-r bg-white align-top">${cells[2]}</td>
                        <td class="p-2 border-r bg-gray-50/20 align-top">${cells[3]}</td>
                        <td class="p-2 bg-white align-top">${cells[4]}</td>
                    </tr>`;
            });
        };
        window.openImageModal=(s)=>{if(!s||s.includes('No+Img'))return; document.getElementById('full-image').src=s;document.getElementById('image-modal').classList.remove('hidden');}; window.createGroup=async()=>{const n=document.getElementById('new-group-name').value;if(!n)return;await addDoc(collection(db,'tadrisi_groups'),{groupName:n,totalStudents:0,round_1_uid:document.getElementById('mufattish-r1').value,round_2_uid:document.getElementById('mufattish-r2').value,round_3_uid:document.getElementById('mufattish-r3').value,round_4_uid:document.getElementById('mufattish-r4').value});document.getElementById('new-group-name').value='';await fetchGroupsList();}; window.fixGroupCounts=async()=>{if(!confirm("Scan?"))return;showLoader(true);try{const c={};allGroups.forEach(g=>c[g.id]=0);const q=query(collection(db,'tadrisi_students'));const s=await getDocs(q);s.forEach(d=>{const i=d.data().groupId;if(i&&c[i]!==undefined)c[i]++});const b=writeBatch(db);allGroups.forEach(g=>b.update(doc(db,'tadrisi_groups',g.id),{totalStudents:c[g.id]||0}));await b.commit();await fetchGroupsList();showToast('Fixed');}catch(e){}finally{showLoader(false);}};
        window.saveResultToHistory=async()=>{const g=document.getElementById('result-group-select').value;const d=document.getElementById('result-month-selector').value;if(!g||!d)return showToast('Select Group & Date','error');if(!confirm('Save?'))return;showLoader(true);try{const n=g==='all'?'All Groups':allGroups.find(x=>x.id===g).groupName;await setDoc(doc(db,'tadrisi_history',`${n}_${d}`),{groupId:g,groupName:n,date:d,students:currentResultData});showToast('Saved');await fetchHistoryList();}catch(e){}finally{showLoader(false);}};
        window.loadHistoryRecord=async()=>{const i=document.getElementById('history-select').value;if(!i){loadGroupResults();return;}showLoader(true);try{const s=await getDoc(doc(db,'tadrisi_history',i));if(s.exists()){const d=s.data();document.getElementById('result-group-name').textContent=`${d.groupName} (Archived)`;document.getElementById('result-header-date').textContent=d.date;currentResultData=d.students;renderResultTable(d.students);showToast('Loaded');}}catch(e){}finally{showLoader(false);}};
    </script>
</body>
</html>







