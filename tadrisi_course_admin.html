<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tadrisi Admin Pro (Super Fast)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @font-face { font-family: 'Jameel Noori Nastaleeq'; src: url('https://cdn.jsdelivr.net/gh/font-to-width/jameel-noori-nastaleeq-regular@1.1/jameel-noori-nastaleeq-regular.woff2') format('woff2'); }
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .urdu-font { font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif; line-height: 1.8; }
        .tab-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }
        .result-tab-btn { background-color: #e2e8f0; color: #334155; padding: 8px 16px; font-size: 14px; font-weight: 600; border-radius: 8px 8px 0 0; border: 1px solid #cbd5e1; border-bottom: none; }
        .result-tab-btn.active { background-color: #fff; color: #0f766e; border-top: 3px solid #0f766e; }
        .big-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #0f766e; }
        
        .bg-fail { background-color: #fee2e2 !important; color: #b91c1c !important; }
        .bg-pass { background-color: #dcfce7 !important; color: #15803d !important; }
        .bg-header { background-color: #fef3c7 !important; }
        .student-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; cursor: pointer; transition: transform 0.2s; }
        .student-thumb:hover { transform: scale(1.1); border-color: #0f766e; }
        .calc-text { font-size: 0.7rem; color: #64748b; display: block; white-space: nowrap; }
        .total-text { font-size: 1rem; font-weight: bold; }
    </style>
</head>
<body class="text-gray-800">

    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60]"></div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-90 flex justify-center items-center z-50"><div class="border-4 border-t-teal-600 rounded-full w-12 h-12 animate-spin"></div></div>

    <header class="bg-teal-800 text-white p-4 shadow-md sticky top-0 z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Tadrisi Admin (Fast)</h1>
            <div class="flex gap-2">
                <button onclick="fixGroupCounts()" class="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-1.5 rounded text-xs font-bold"><i class="fas fa-wrench"></i> Fix Counts</button>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded text-xs font-semibold">Logout</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-[98%]">
        
        <div class="flex flex-wrap gap-2 mb-6 border-b pb-2 no-print">
            <button onclick="switchTab('students')" class="tab-btn active px-4 py-2 rounded-t-lg font-medium border" id="tab-students">1. Students List</button>
            <button onclick="switchTab('groups')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border" id="tab-groups">2. Groups</button>
            <button onclick="switchTab('results')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border" id="tab-results">3. Result & Edit</button>
            <button onclick="switchTab('mufattish')" class="tab-btn px-4 py-2 rounded-t-lg font-medium border" id="tab-mufattish">4. Mufattish Status</button>
        </div>

        <div id="view-students" class="tab-content">
            <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-teal-600 flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 w-full">
                    <label class="text-xs text-gray-500">Jamia Name</label>
                    <input type="text" id="link-jamia-name" class="w-full p-2 border rounded urdu-font text-sm" placeholder="Jamia ka naam..." oninput="generateLink()">
                </div>
                <div class="flex-[2] w-full flex">
                    <input type="text" id="shareable-link" class="w-full p-2 border rounded-l bg-gray-50 text-sm text-gray-600" readonly>
                    <button onclick="copyLink()" class="bg-teal-600 text-white px-4 py-2 rounded-r font-bold text-sm">Copy Link</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow border-t-4 border-orange-500">
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <div class="flex gap-2 w-full">
                        <div class="w-64">
                            <label class="text-xs text-gray-500 font-bold">Load by Group</label>
                            <select id="student-filter-group" onchange="loadStudentsByGroup()" class="w-full p-2 border rounded text-sm bg-gray-50">
                                <option value="">-- Select Group --</option>
                                <option value="unassigned" class="text-red-600 font-bold">Unassigned</option>
                                <option value="all" class="text-blue-600 font-bold">Load ALL (Slow)</option>
                            </select>
                        </div>
                        <div class="flex-1 relative">
                            <label class="text-xs text-gray-500 font-bold">Search (Server Side)</label>
                            <div class="flex">
                                <input type="text" id="search-input" class="w-full p-2 pl-8 border rounded-l bg-gray-50" placeholder="Enter Roll No or Name...">
                                <button onclick="searchStudents()" class="bg-blue-600 text-white px-4 rounded-r"><i class="fas fa-search"></i></button>
                            </div>
                            <i class="fas fa-search absolute left-2 top-8 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div id="bulk-action-bar" class="hidden bg-orange-50 p-2 rounded border border-orange-200 mb-2 flex justify-between items-center gap-2">
                    <span class="font-bold text-orange-800 text-sm"><span id="selected-count">0</span> Selected</span>
                    <div class="flex gap-2">
                        <select id="bulk-group-select" class="p-1 border rounded text-sm w-48"><option value="">-- Move to Group --</option></select>
                        <button onclick="bulkAssignGroup()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">Move</button>
                        <button onclick="bulkDeleteStudents()" class="bg-red-600 text-white px-3 py-1 rounded text-sm font-bold">Delete</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto min-h-[300px]">
                    <table class="w-full text-left border-collapse min-w-[1000px]">
                        <thead class="bg-orange-50 text-orange-900 text-sm">
                            <tr>
                                <th class="p-2 border-b w-8 text-center"><input type="checkbox" onchange="toggleSelectAll(this)" class="big-checkbox"></th>
                                <th class="p-2 border-b w-10">#</th>
                                <th class="p-2 border-b w-12 text-center">Img</th>
                                <th class="p-2 border-b">Roll No</th>
                                <th class="p-2 border-b">Name</th>
                                <th class="p-2 border-b">Jamia / City</th>
                                <th class="p-2 border-b">Mobile</th>
                                <th class="p-2 border-b">Group</th>
                                <th class="p-2 border-b w-24">Action</th>
                            </tr>
                        </thead>
                        <tbody id="students-master-tbody">
                            <tr><td colspan="9" class="p-8 text-center text-gray-500">Select a group or search to load students.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-groups" class="tab-content hidden">
            <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-teal-600">
                <h3 class="text-lg font-bold mb-2">Add New Group</h3>
                <div class="flex flex-col gap-3">
                    <input type="text" id="new-group-name" placeholder="Group Name" class="w-full p-2 border rounded urdu-font">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <select id="mufattish-r1" class="p-2 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r2" class="p-2 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r3" class="p-2 border rounded text-xs bg-gray-50"></select>
                        <select id="mufattish-r4" class="p-2 border rounded text-xs bg-gray-50"></select>
                    </div>
                    <button onclick="createGroup()" class="bg-teal-600 text-white px-4 py-2 rounded font-bold w-full md:w-auto">Create Group</button>
                </div>
            </div>
            <div id="groups-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-results" class="tab-content hidden">
            <div class="bg-white p-4 rounded-lg shadow mb-4 border-l-4 border-purple-600 no-print">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-lg font-bold text-purple-800">Result Management</h3>
                    <div class="flex gap-2">
                        <select id="history-select" class="p-1 border rounded text-xs bg-yellow-50 border-yellow-300" onchange="loadHistoryRecord()">
                            <option value="">-- History --</option>
                        </select>
                        <button onclick="saveResultToHistory()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-purple-700"><i class="fas fa-save"></i> Save</button>
                        <button onclick="exportResultToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-green-700"><i class="fas fa-file-excel"></i> Excel</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <select id="result-group-select" onchange="loadGroupResults()" class="w-full p-2 border rounded urdu-font bg-gray-50"><option value="">-- Select Group --</option></select>
                    <input type="month" id="result-month-selector" class="w-full p-2 border rounded bg-gray-50" onchange="updateHeaderDate()">
                    <select id="filter-jamia" onchange="filterResults()" class="w-full p-2 border rounded urdu-font bg-gray-50"><option value="all">All Jamiaat</option></select>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden border p-2 min-h-[500px]">
                <div class="text-center mb-2 pt-2">
                    <h2 class="text-2xl font-bold urdu-font">ÿ™ÿØÿ±€åÿ≥€å Ÿπ€åÿ≥Ÿπ ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å ŸÅÿßÿ±ŸÖ</h2>
                    <p class="text-gray-600 text-sm font-bold" id="result-header-date">Month: -- | Year: --</p>
                    <h3 class="text-lg text-teal-700 font-bold" id="result-group-name"></h3>
                </div>

                <div class="flex gap-1 border-b mb-0 px-2 overflow-x-auto no-print">
                    <button onclick="switchResultTab('1')" class="result-tab-btn" id="rtab-1">Sabaq 1</button>
                    <button onclick="switchResultTab('2')" class="result-tab-btn" id="rtab-2">Sabaq 2</button>
                    <button onclick="switchResultTab('3')" class="result-tab-btn" id="rtab-3">Sabaq 3</button>
                    <button onclick="switchResultTab('4')" class="result-tab-btn" id="rtab-4">Sabaq 4</button>
                    <button onclick="switchResultTab('final')" class="result-tab-btn active" id="rtab-final">Final Result</button>
                </div>

                <div class="overflow-x-auto pt-2">
                    <table class="w-full text-center border-collapse border border-gray-400 min-w-[1400px]" dir="rtl" id="result-table">
                        <thead class="bg-orange-100 text-gray-900 font-bold text-sm urdu-font" id="result-thead"></thead>
                        <tbody id="results-tbody" class="text-base urdu-font text-gray-800">
                            <tr><td colspan="12" class="p-4 text-gray-400">Select Group</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-mufattish" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-gray-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Mufattish Status</h3>
                    <button onclick="renderMufattishStatus()" class="text-blue-600 hover:underline text-sm"><i class="fas fa-sync"></i> Refresh Status</button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left border-collapse min-w-[800px]"><thead class="bg-gray-100 text-gray-800"><tr><th class="p-3 border-b">Mufattish Name</th><th class="p-3 border-b">Region</th><th class="p-3 border-b">Assigned Groups & Progress</th></tr></thead><tbody id="mufattish-status-tbody"><tr><td colspan="3" class="p-4 text-gray-400 text-center">Loading...</td></tr></tbody></table></div>
            </div>
        </div>

    </main>

    <div id="result-edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-[70] no-print">
        <div class="bg-white p-6 rounded-lg shadow-lg w-[600px] max-w-full relative">
            <button onclick="closeResultEditModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-4 text-teal-800 border-b pb-2">Edit Marks / Tasurat</h3>
            <p id="edit-result-student-name" class="text-sm font-bold text-gray-700 mb-4"></p>
            <input type="hidden" id="edit-result-id">
            <div class="bg-yellow-50 p-3 rounded mb-4 border border-yellow-200">
                <h4 class="font-bold text-sm mb-2">Grace Marks (Izaafi Number)</h4>
                <div class="grid grid-cols-5 gap-2 text-center">
                    <div><label class="text-xs">Ibarat</label><input type="number" id="grace-m1" class="w-full border p-1 rounded text-center font-bold"></div>
                    <div><label class="text-xs">Tarjama</label><input type="number" id="grace-m2" class="w-full border p-1 rounded text-center font-bold"></div>
                    <div><label class="text-xs">Sarf</label><input type="number" id="grace-m3" class="w-full border p-1 rounded text-center font-bold"></div>
                    <div><label class="text-xs">Nahw</label><input type="number" id="grace-m4" class="w-full border p-1 rounded text-center font-bold"></div>
                    <div><label class="text-xs">Andaz</label><input type="number" id="grace-m5" class="w-full border p-1 rounded text-center font-bold"></div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold mb-1">Final Remarks (Tasurat)</label>
                <textarea id="edit-final-remarks" rows="3" class="w-full p-2 border rounded urdu-font" placeholder="Tasurat yahan likhein..."></textarea>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeResultEditModal()" class="px-4 py-2 bg-gray-300 rounded text-sm font-bold">Cancel</button>
                <button onclick="saveResultChanges()" class="px-6 py-2 bg-teal-600 text-white rounded text-sm font-bold hover:bg-teal-700">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[80]" onclick="closeImageModal()">
        <span class="absolute top-5 right-5 text-white text-4xl cursor-pointer">&times;</span>
        <img id="full-image" class="max-w-[90%] max-h-[90vh] border-4 border-white rounded">
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96 max-w-full">
            <h3 class="text-lg font-bold mb-4 text-teal-800 border-b pb-2">Edit Student Info</h3>
            <input type="hidden" id="edit-student-id">
            <div class="space-y-2 text-sm">
                <input type="text" id="edit-reg" class="w-full p-2 border rounded font-mono" placeholder="Roll No">
                <input type="text" id="edit-name" class="w-full p-2 border rounded urdu-font" placeholder="Name">
                <input type="text" id="edit-father" class="w-full p-2 border rounded urdu-font" placeholder="Father Name">
                <input type="text" id="edit-jamia" class="w-full p-2 border rounded urdu-font" placeholder="Jamia">
                <input type="text" id="edit-city" class="w-full p-2 border rounded urdu-font" placeholder="City">
                <input type="text" id="edit-mobile" class="w-full p-2 border rounded font-mono" placeholder="Mobile">
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-3 py-1 bg-gray-300 rounded">Cancel</button>
                <button onclick="saveEditedStudent()" class="px-4 py-1 bg-teal-600 text-white rounded">Update</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h3 class="text-lg font-bold mb-4">Transfer Student</h3>
            <p id="transfer-student-name" class="mb-4 text-sm text-gray-600"></p>
            <input type="hidden" id="transfer-student-id"><input type="hidden" id="transfer-old-group-id">
            <select id="transfer-group-select" class="w-full p-2 border rounded mb-4"></select>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('transfer-modal').classList.add('hidden')" class="px-3 py-1 bg-gray-300 rounded">Cancel</button>
                <button onclick="confirmTransfer()" class="px-4 py-1 bg-blue-600 text-white rounded">Transfer</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, increment, writeBatch, setDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";   

        const firebaseConfig = { apiKey: "AIzaSyDhPuyX0y1gb3uXoIRcdcQPkd5Q4KJFgl0", authDomain: "data-f15ab.firebaseapp.com", projectId: "data-f15ab", storageBucket: "data-f15ab.appspot.com", messagingSenderId: "449137002393", appId: "1:449137002393:web:6a23721d00b1b0daeb3508", measurementId: "G-1PHNJQWNPZ" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMufattish=[], allGroups=[], currentTableData=[], activeResultTab='final', currentResultData=[];

        const showLoader=(s)=>document.getElementById('loader').classList.toggle('hidden',!s);
        const showToast=(m,t='success')=>{const e=document.getElementById('notification');e.textContent=m;e.className=`fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[60] ${t==='error'?'bg-red-500':'bg-emerald-600'}`;e.classList.remove('hidden');setTimeout(()=>e.classList.add('hidden'),3000);};

        onAuthStateChanged(auth, async (u)=>{ if(u){ const d=await getDoc(doc(db,'users',u.uid)); if(d.exists()&&['admin','tadrisi_course_management','tadrisi_course_admin'].includes(d.data().role))await initData(); else location.href='index.html'; }else location.href='index.html'; showLoader(false); });
        document.getElementById('logout-btn').addEventListener('click',()=>signOut(auth));
        window.switchTab=(t)=>{ document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${t}`).classList.remove('hidden'); document.getElementById(`tab-${t}`).classList.add('active'); };

        async function initData() { 
            await fetchMufattishList(); 
            await fetchGroupsList();
            await fetchHistoryList();
            generateLink();
        }

        async function fetchMufattishList() { const q=query(collection(db,'users'),where('role','==','tadrisi_course_mufattish')); const s=await getDocs(q); allMufattish=s.docs.map(d=>({id:d.id,...d.data()})); const o='<option value="">-- Select --</option>'+allMufattish.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); ['mufattish-r1','mufattish-r2','mufattish-r3','mufattish-r4'].forEach(i=>document.getElementById(i).innerHTML=o); }
        async function fetchGroupsList() { const q=query(collection(db,'tadrisi_groups')); const s=await getDocs(q); allGroups=s.docs.map(d=>({id:d.id,...d.data()})); allGroups.sort((a,b)=>a.groupName.localeCompare(b.groupName,undefined,{numeric:true})); document.getElementById('groups-list-container').innerHTML=allGroups.map(g=>`<div class="bg-white p-4 shadow border rounded relative"><h4 class="font-bold text-teal-800">${g.groupName}</h4><span class="text-xs bg-gray-100 px-2 py-1 rounded">Students: ${g.totalStudents||0}</span><button onclick="deleteGroup('${g.id}')" class="absolute top-2 right-2 text-red-400"><i class="fas fa-trash"></i></button></div>`).join(''); populateGroupDropdowns(); }
        async function fetchHistoryList() { try{ const q=query(collection(db,'tadrisi_history')); const s=await getDocs(q); const o='<option value="">-- Load Saved Record --</option>'+s.docs.map(d=>`<option value="${d.id}">${d.id.replace('_',' - ')}</option>`).join(''); document.getElementById('history-select').innerHTML=o; }catch(e){} }

        // üî• OPTIMIZED FETCHING (Only requested data) üî•
        window.loadStudentsByGroup = async () => {
            const gid = document.getElementById('student-filter-group').value;
            if(!gid) return;
            showLoader(true);
            try {
                let q;
                if(gid === 'all') q = query(collection(db, 'tadrisi_students')); // Careful!
                else if(gid === 'unassigned') q = query(collection(db, 'tadrisi_students'), where('groupId', '==', null));
                else q = query(collection(db, 'tadrisi_students'), where('groupId', '==', gid));
                
                const snap = await getDocs(q);
                currentTableData = snap.docs.map(d => ({id:d.id, ...d.data()}));
                renderStudentsTable(currentTableData);
            } catch(e) { console.error(e); } finally { showLoader(false); }
        };

        window.searchStudents = async () => {
            const term = document.getElementById('search-input').value.trim();
            if(!term) return;
            showLoader(true);
            try {
                // Search by exact match first (Roll No)
                let q = query(collection(db, 'tadrisi_students'), where('regNo', '==', term));
                let snap = await getDocs(q);
                if(snap.empty) {
                    // Fallback: If not found, we can't do LIKE %...% in Firestore efficiently without Algolia.
                    // For now, load unassigned + limiting search or just tell user to load group first.
                    // Or fetch ALL and filter (only if needed)
                    q = query(collection(db, 'tadrisi_students'));
                    snap = await getDocs(q); // Fetch all for search (Warning: Slow)
                    currentTableData = snap.docs.map(d => ({id:d.id, ...d.data()})).filter(s => s.name.includes(term) || s.regNo.includes(term));
                } else {
                    currentTableData = snap.docs.map(d => ({id:d.id, ...d.data()}));
                }
                renderStudentsTable(currentTableData);
            } catch(e){ console.error(e); } finally { showLoader(false); }
        };

        function renderStudentsTable(list) {
    const tbody = document.getElementById('students-master-tbody');
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">No students found.</td></tr>';
        return;
    }

    let rows = ''; // Ek sath string banayein
    list.forEach((s, idx) => {
        const photoSrc = s.photoBase64 || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Img';
        const grp = allGroups.find(g => g.id === s.groupId);
        const grpName = grp ? grp.groupName : '<span class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded text-xs">Unassigned</span>';
        
        rows += `<tr class="border-b text-sm hover:bg-gray-50 align-middle">
            <td class="p-2 text-center"><input type="checkbox" class="student-checkbox big-checkbox" value="${s.id}" onchange="updateBulkActionUI()"></td>
            <td class="p-2 text-xs">${idx + 1}</td>
            <td class="p-2 text-center"><img src="${photoSrc}" class="student-thumb mx-auto" onclick="openImageModal('${photoSrc}')"></td>
            <td class="p-2 font-mono font-bold">${s.regNo || '-'}</td>
            <td class="p-2 font-bold urdu-font text-base">${s.name}<br><span class="text-xs text-gray-500 font-normal">${s.fatherName}</span></td>
            <td class="p-2 urdu-font text-xs">${s.jamia || '-'}<br><span class="text-teal-600">${s.city || '-'}</span></td>
            <td class="p-2 font-mono text-xs">${s.mobile || '-'}</td>
            <td class="p-2 text-xs">${grpName}</td>
            <td class="p-2 flex gap-1">
                <button onclick="openEditModal('${s.id}')" class="text-teal-600 p-1"><i class="fas fa-edit"></i></button>
                <button onclick="openTransferModal('${s.id}','${s.name}','${s.groupId || ''}')" class="text-blue-600 p-1"><i class="fas fa-exchange-alt"></i></button>
                <button onclick="deleteStudent('${s.id}')" class="text-red-500 p-1"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
    tbody.innerHTML = rows; // Sirf ek baar update
}

        // --- Result Logic (Optimized) ---
        window.switchResultTab=(t)=>{ document.querySelectorAll('.result-tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`rtab-${t}`).classList.add('active'); activeResultTab=t; renderResultTable(currentResultData); };
        window.loadGroupResults = async () => {
            const gid = document.getElementById('result-group-select').value;
            if(!gid) return;
            showLoader(true);
            try {
                if(gid === 'all') {
                    const q = query(collection(db, 'tadrisi_students'));
                    const snap = await getDocs(q);
                    currentResultData = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    document.getElementById('result-group-name').textContent = 'All Groups';
                } else {
                    const q = query(collection(db, 'tadrisi_students'), where('groupId', '==', gid));
                    const snap = await getDocs(q);
                    currentResultData = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    const grp = allGroups.find(x=>x.id===gid);
                    document.getElementById('result-group-name').textContent = grp ? grp.groupName : '';
                }
                // Populate Filter
                const jF = document.getElementById('filter-jamia'); jF.innerHTML = '<option value="all">All Jamiaat</option>';
                const jSet = new Set(currentResultData.map(s => s.jamia).filter(j=>j)); jSet.forEach(j => jF.innerHTML += `<option value="${j}">${j}</option>`);
                
                renderResultTable(currentResultData);
            } catch(e){console.error(e);} finally{showLoader(false);}
        };

        window.filterResults=()=>{ const j=document.getElementById('filter-jamia').value; let l=currentResultData; if(j!=='all') l=l.filter(s=>s.jamia===j); renderResultTable(l); };

        function renderResultTable(list) {
            const thead=document.getElementById('result-thead'); const tbody=document.getElementById('results-tbody'); tbody.innerHTML='';
            let hHtml=`<tr><th class="p-2 border w-10">#</th><th class="p-2 border w-12 text-center">Img</th><th class="p-2 border w-48 text-right pr-4">ŸÜÿßŸÖ ŸÖÿπ ŸàŸÑÿØ€åÿ™</th><th class="p-2 border w-32">ÿ¨ÿßŸÖÿπ€Å</th>`;
            if(activeResultTab==='final') hHtml+=`<th class="p-2 border bg-header">ÿπÿ®ÿßÿ±ÿ™ (80)</th><th class="p-2 border bg-header">ÿ™ÿ±ÿ¨ŸÖ€Å (80)</th><th class="p-2 border bg-header">ÿµÿ±ŸÅ (80)</th><th class="p-2 border bg-header">ŸÜÿ≠Ÿà (80)</th><th class="p-2 border bg-header">ÿßŸÜÿØÿßÿ≤ (80)</th><th class="p-2 border bg-yellow-100">Total (400)</th><th class="p-2 border bg-yellow-100">%</th><th class="p-2 border bg-orange-200">Result</th><th class="p-2 border w-32">Tasurat</th><th class="p-2 border no-print w-10">Edit</th></tr>`;
            else hHtml+=`<th class="p-2 border bg-header">ÿπÿ®ÿßÿ±ÿ™ (20)</th><th class="p-2 border bg-header">ÿ™ÿ±ÿ¨ŸÖ€Å (20)</th><th class="p-2 border bg-header">ÿµÿ±ŸÅ (20)</th><th class="p-2 border bg-header">ŸÜÿ≠Ÿà (20)</th><th class="p-2 border bg-header">ÿßŸÜÿØÿßÿ≤ (20)</th><th class="p-2 border bg-yellow-100">Total (100)</th><th class="p-2 border bg-orange-200">Remarks</th></tr>`;
            thead.innerHTML=hHtml; if(list.length===0){ tbody.innerHTML='<tr><td colspan="14" class="p-8 text-gray-400">No results found.</td></tr>'; return; }
            let count=1; list.forEach(s=>{
                const gm=(r,k)=>(r&&r[k])?Number(r[k]):0; const pSrc=s.photoBase64||'https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Img';
                let row=`<tr class="border-b border-gray-300"><td class="p-1">${count++}</td><td class="p-1 text-center"><img src="${pSrc}" class="student-thumb mx-auto" onclick="openImageModal('${pSrc}')"></td><td class="p-1 text-right font-bold text-sm">${s.name}<br><span class="text-xs text-gray-500 font-normal">${s.fatherName}</span></td><td class="p-1 text-xs">${s.jamia}</td>`;
                if(activeResultTab==='final'){
                    const gr=s.grace_marks||{}; const g1=Number(gr.m1)||0,g2=Number(gr.m2)||0,g3=Number(gr.m3)||0,g4=Number(gr.m4)||0,g5=Number(gr.m5)||0;
                    const m1T=gm(s.marks_r1,'m1')+gm(s.marks_r2,'m1')+gm(s.marks_r3,'m1')+gm(s.marks_r4,'m1');
                    const m2T=gm(s.marks_r1,'m2')+gm(s.marks_r2,'m2')+gm(s.marks_r3,'m2')+gm(s.marks_r4,'m2');
                    const m3T=gm(s.marks_r1,'m3')+gm(s.marks_r2,'m3')+gm(s.marks_r3,'m3')+gm(s.marks_r4,'m3');
                    const m4T=gm(s.marks_r1,'m4')+gm(s.marks_r2,'m4')+gm(s.marks_r3,'m4')+gm(s.marks_r4,'m4');
                    const m5T=gm(s.marks_r1,'m5')+gm(s.marks_r2,'m5')+gm(s.marks_r3,'m5')+gm(s.marks_r4,'m5');
                    const f1=m1T+g1, f2=m2T+g2, f3=m3T+g3, f4=m4T+g4, f5=m5T+g5;
                    const gt=f1+f2+f3+f4+f5; const pct=(gt/400)*100; const fail=(f1<56||f2<56||f3<56||f4<56||f5<56);
                    let txt="ŸÜÿß⁄©ÿßŸÖ",cls="bg-fail"; if(!fail&&gt>0){ if(pct>=90){txt="ŸÖŸÖÿ™ÿßÿ≤";cls="bg-pass";}else if(pct>=80){txt="ÿ®€Åÿ™ÿ±";cls="bg-pass";}else if(pct>=70){txt="ŸÖŸÜÿßÿ≥ÿ®";cls="bg-pass";} } if(gt===0){txt="-";cls="";}
                    const sc=(r1,r2,r3,r4,g,tot)=>{let h=`<span class="calc-text">${r1}+${r2}+${r3}+${r4}${g>0?'+('+g+')':''}</span><span class="total-text ${tot<56?'text-red-600':''}">${tot}</span>`; return h;};
                    row+=`<td class="p-1 border text-center">${sc(gm(s.marks_r1,'m1'),gm(s.marks_r2,'m1'),gm(s.marks_r3,'m1'),gm(s.marks_r4,'m1'),g1,f1)}</td>
                          <td class="p-1 border text-center">${sc(gm(s.marks_r1,'m2'),gm(s.marks_r2,'m2'),gm(s.marks_r3,'m2'),gm(s.marks_r4,'m2'),g2,f2)}</td>
                          <td class="p-1 border text-center">${sc(gm(s.marks_r1,'m3'),gm(s.marks_r2,'m3'),gm(s.marks_r3,'m3'),gm(s.marks_r4,'m3'),g3,f3)}</td>
                          <td class="p-1 border text-center">${sc(gm(s.marks_r1,'m4'),gm(s.marks_r2,'m4'),gm(s.marks_r3,'m4'),gm(s.marks_r4,'m4'),g4,f4)}</td>
                          <td class="p-1 border text-center">${sc(gm(s.marks_r1,'m5'),gm(s.marks_r2,'m5'),gm(s.marks_r3,'m5'),gm(s.marks_r4,'m5'),g5,f5)}</td>
                          <td class="p-1 font-bold bg-yellow-50 border">${gt}</td><td class="p-1 bg-yellow-50 border">${pct.toFixed(1)}%</td><td class="p-1 font-bold ${cls} border">${txt}</td><td class="p-1 text-xs urdu-font text-teal-800 border">${s.final_remarks||'-'}</td><td class="p-1 no-print border"><button onclick="openResultEditModal('${s.id}')" class="text-blue-600"><i class="fas fa-edit"></i></button></td>`;
                } else {
                    const r=s[`marks_r${activeResultTab}`]||{}; const kf=s[`kaifiyat_r${activeResultTab}`]||'-'; const m1=gm(r,'m1'),m2=gm(r,'m2'),m3=gm(r,'m3'),m4=gm(r,'m4'),m5=gm(r,'m5'); const t=m1+m2+m3+m4+m5; const cc=(v)=>v<14?'text-red-600 font-bold':'';
                    row+=`<td class="p-1 ${cc(m1)}">${m1}</td><td class="p-1 ${cc(m2)}">${m2}</td><td class="p-1 ${cc(m3)}">${m3}</td><td class="p-1 ${cc(m4)}">${m4}</td><td class="p-1 ${cc(m5)}">${m5}</td><td class="p-1 font-bold bg-yellow-50">${t}</td><td class="p-1 text-xs text-right">${kf}</td>`;
                }
                tbody.innerHTML+=row+'</tr>';
            });
        }

        // --- Mufattish Status (Optimized) ---
        window.renderMufattishStatus = async () => {
    const tbody = document.getElementById('mufattish-status-tbody');
    tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center"><i class="fas fa-spinner animate-spin"></i> Loading Status...</td></tr>';
    
    try {
        // Optimization 1: Sirf zaroori fields fetch karein (ID aur Marks)
        // Note: Firestore pure document fetch karta hai, lekin hum 'groupId' filter laga kar data kam kar sakte hain
        const q = query(collection(db, 'tadrisi_students'), where('groupId', '!=', null));
        const snap = await getDocs(q);
        const students = snap.docs.map(d => ({
            groupId: d.data().groupId,
            marks_r1: d.data().marks_r1,
            marks_r2: d.data().marks_r2,
            marks_r3: d.data().marks_r3,
            marks_r4: d.data().marks_r4
        }));

        let finalRowsHtml = ''; // Optimization 2: String builder use karein

        allMufattish.forEach(m => {
            let gridHtml = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">';
            
            [1, 2, 3, 4].forEach(r => {
                // Is Mufattish ko is round mein jo groups mile hain
                const assignedGroups = allGroups.filter(g => g[`round_${r}_uid`] === m.id);
                let list = '';
                
                assignedGroups.forEach(g => {
                    const stuInGrp = students.filter(s => s.groupId === g.id);
                    const total = stuInGrp.length;
                    const filled = stuInGrp.filter(s => s[`marks_r${r}`] && s[`marks_r${r}`].m1 !== undefined).length;
                    
                    let cls = 'text-red-600', txt = 'Pending';
                    if (total > 0 && filled === total) { 
                        cls = 'text-green-600 font-bold'; 
                        txt = '<i class="fas fa-check-circle"></i> Done'; 
                    } else if (filled > 0) { 
                        cls = 'text-yellow-600 font-bold'; 
                        txt = `${filled}/${total}`; 
                    } else if (total === 0) {
                        txt = 'No Students';
                        cls = 'text-gray-400';
                    }
                    
                    list += `
                        <div class="flex justify-between text-[10px] bg-white p-1 border border-gray-100 mb-1 rounded">
                            <span class="font-bold truncate w-20" title="${g.groupName}">${g.groupName}</span>
                            <span class="${cls}">${txt}</span>
                        </div>`;
                });

                gridHtml += `
                    <div class="bg-gray-50 p-1 rounded border border-gray-200">
                        <div class="font-bold text-[11px] mb-1 text-center bg-teal-100 text-teal-800 rounded">Sabaq ${r}</div>
                        ${list || '<div class="text-[10px] text-gray-300 italic text-center">None</div>'}
                    </div>`;
            });
            
            gridHtml += '</div>';
            
            finalRowsHtml += `
                <tr class="border-b bg-white hover:bg-gray-50 align-top">
                    <td class="p-3 w-48 border-r">
                        <div class="font-bold text-teal-800">${m.name}</div>
                        <div class="text-xs text-gray-500"><i class="fas fa-map-marker-alt"></i> ${m.region || 'No Region'}</div>
                    </td>
                    <td class="p-2">${gridHtml}</td>
                </tr>`;
        });

        tbody.innerHTML = finalRowsHtml || '<tr><td colspan="3" class="p-4 text-center">No Mufattish found.</td></tr>';
        
    } catch (e) {
        console.error("Status Error:", e);
        tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-red-500 text-center">Data load karne mein masla hua.</td></tr>';
    }
};

        // --- Standard Actions ---
        window.openResultEditModal=(sid)=>{ const s=currentResultData.find(x=>x.id===sid); if(!s)return; document.getElementById('edit-result-student-name').textContent=`${s.name} (${s.regNo})`; document.getElementById('edit-result-id').value=sid; const gr=s.grace_marks||{}; [1,2,3,4,5].forEach(i=>document.getElementById(`grace-m${i}`).value=gr[`m${i}`]||0); document.getElementById('edit-final-remarks').value=s.final_remarks||''; document.getElementById('result-edit-modal').classList.remove('hidden'); };
        window.saveResultChanges=async()=>{ const sid=document.getElementById('edit-result-id').value; const gr={}; [1,2,3,4,5].forEach(i=>gr[`m${i}`]=Number(document.getElementById(`grace-m${i}`).value)||0); const rm=document.getElementById('edit-final-remarks').value.trim(); try{ await updateDoc(doc(db,'tadrisi_students',sid),{grace_marks:gr,final_remarks:rm}); showToast('Updated'); document.getElementById('result-edit-modal').classList.add('hidden'); loadGroupResults(); }catch(e){console.error(e);} };
        window.closeResultEditModal=()=>document.getElementById('result-edit-modal').classList.add('hidden');
        window.openImageModal=(s)=>{document.getElementById('full-image').src=s;document.getElementById('image-modal').classList.remove('hidden');}; window.closeImageModal=()=>{document.getElementById('image-modal').classList.add('hidden');};
        
        function populateGroupDropdowns() { const o='<option value="">-- Select Group --</option><option value="all" class="font-bold text-blue-600">All Groups</option>'+allGroups.map(g=>`<option value="${g.id}">${g.groupName} (${g.totalStudents})</option>`).join(''); document.getElementById('student-filter-group').innerHTML='<option value="">All Groups</option><option value="unassigned">Unassigned</option>'+allGroups.map(g=>`<option value="${g.id}">${g.groupName}</option>`).join(''); document.getElementById('result-group-select').innerHTML=o; document.getElementById('bulk-group-select').innerHTML=o; document.getElementById('transfer-group-select').innerHTML=o; }
        window.fixGroupCounts=async()=>{if(!confirm("Scan?"))return;showLoader(true);try{const c={};allGroups.forEach(g=>c[g.id]=0);const q=query(collection(db,'tadrisi_students'));const s=await getDocs(q);s.forEach(d=>{const i=d.data().groupId;if(i&&c[i]!==undefined)c[i]++});const b=writeBatch(db);allGroups.forEach(g=>b.update(doc(db,'tadrisi_groups',g.id),{totalStudents:c[g.id]||0}));await b.commit();await fetchGroupsList();showToast('Fixed');}catch(e){}finally{showLoader(false);}};
        window.createGroup=async()=>{const n=document.getElementById('new-group-name').value;if(!n)return;await addDoc(collection(db,'tadrisi_groups'),{groupName:n,totalStudents:0,round_1_uid:document.getElementById('mufattish-r1').value,round_2_uid:document.getElementById('mufattish-r2').value,round_3_uid:document.getElementById('mufattish-r3').value,round_4_uid:document.getElementById('mufattish-r4').value});document.getElementById('new-group-name').value='';await fetchGroupsList();};
        window.deleteStudent=async(id)=>{if(confirm('Delete?')){await deleteDoc(doc(db,'tadrisi_students',id)); showToast('Deleted'); loadStudentsByGroup(); }};
        window.confirmTransfer=async()=>{const sid=document.getElementById('transfer-student-id').value;const nid=document.getElementById('transfer-group-select').value;if(!nid)return;await updateDoc(doc(db,'tadrisi_students',sid),{groupId:nid});document.getElementById('transfer-modal').classList.add('hidden');showToast('Transferred');loadStudentsByGroup();};
        window.toggleSelectAll=(s)=>{document.querySelectorAll('.student-checkbox').forEach(c=>c.checked=s.checked);updateBulkActionUI();};
        window.updateBulkActionUI=()=>{const c=document.querySelectorAll('.student-checkbox:checked').length;document.getElementById('selected-count').textContent=c;document.getElementById('bulk-action-bar').classList.toggle('hidden',c===0);};
        window.bulkAssignGroup=async()=>{const gid=document.getElementById('bulk-group-select').value;const ids=Array.from(document.querySelectorAll('.student-checkbox:checked')).map(c=>c.value);if(!gid||ids.length===0)return;if(!confirm('Move?'))return;showLoader(true);const b=writeBatch(db);ids.forEach(i=>b.update(doc(db,'tadrisi_students',i),{groupId:gid}));await b.commit();showToast('Moved');document.getElementById('bulk-action-bar').classList.add('hidden');loadStudentsByGroup();showLoader(false);};
        window.bulkDeleteStudents=async()=>{const ids=Array.from(document.querySelectorAll('.student-checkbox:checked')).map(c=>c.value);if(!confirm('Delete?'))return;showLoader(true);const b=writeBatch(db);ids.forEach(i=>b.delete(doc(db,'tadrisi_students',i)));await b.commit();showToast('Deleted');loadStudentsByGroup();showLoader(false);};
        window.openEditModal=(id)=>{const s=currentTableData.find(x=>x.id===id);if(!s)return;document.getElementById('edit-student-id').value=s.id;document.getElementById('edit-reg').value=s.regNo||'';document.getElementById('edit-name').value=s.name||'';document.getElementById('edit-father').value=s.fatherName||'';document.getElementById('edit-jamia').value=s.jamia||'';document.getElementById('edit-city').value=s.city||'';document.getElementById('edit-mobile').value=s.mobile||'';document.getElementById('edit-modal').classList.remove('hidden');};
        window.saveEditedStudent=async()=>{const id=document.getElementById('edit-student-id').value;await updateDoc(doc(db,'tadrisi_students',id),{regNo:document.getElementById('edit-reg').value,name:document.getElementById('edit-name').value,fatherName:document.getElementById('edit-father').value,jamia:document.getElementById('edit-jamia').value,city:document.getElementById('edit-city').value,mobile:document.getElementById('edit-mobile').value});document.getElementById('edit-modal').classList.add('hidden');showToast('Saved');loadStudentsByGroup();};
        window.generateLink=()=>{const j=document.getElementById('link-jamia-name').value.trim();const b=location.href.substring(0,location.href.lastIndexOf('/'))+'/tadrisi_student_form.html';document.getElementById('shareable-link').value=j?`${b}?jamia=${encodeURIComponent(j)}`:b;};
        window.copyLink=()=>{document.getElementById('shareable-link').select();document.execCommand('copy');showToast('Copied');};
        window.exportStudentList=async()=>{const q=query(collection(db,'tadrisi_students'));const s=await getDocs(q);const d=s.docs.map((d,i)=>{const s=d.data();return {"#":i+1,"Roll":s.regNo,"Name":s.name,"Father":s.fatherName,"Jamia":s.jamia,"City":s.city,"Mobile":s.mobile,"Group":allGroups.find(g=>g.id===s.groupId)?.groupName||'Unassigned'};});const ws=XLSX.utils.json_to_sheet(d);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Students");XLSX.writeFile(wb,"Students_List.xlsx");};
        window.deleteGroup=async(id)=>{if(confirm('Delete Group?'))await deleteDoc(doc(db,'tadrisi_groups',id));await fetchGroupsList();};
        window.openTransferModal=(sid,n,old)=>{document.getElementById('transfer-student-name').textContent=`Transfer: ${n}`;document.getElementById('transfer-student-id').value=sid;document.getElementById('transfer-old-group-id').value=old;document.getElementById('transfer-modal').classList.remove('hidden');};
        window.updateHeaderDate=()=>{document.getElementById('result-header-date').textContent=document.getElementById('result-month-selector').value||'Month: -- | Year: --';};
        window.exportResultToExcel=()=>{const t=document.getElementById('result-table');if(!t)return;const wb=XLSX.utils.table_to_book(t,{sheet:"Result"});XLSX.writeFile(wb,"Result_Sheet.xlsx");};
        window.saveResultToHistory=async()=>{const g=document.getElementById('result-group-select').value;const d=document.getElementById('result-month-selector').value;if(!g||!d)return showToast('Select Group & Date','error');if(!confirm('Save?'))return;showLoader(true);try{const n=g==='all'?'All Groups':allGroups.find(x=>x.id===g).groupName;await setDoc(doc(db,'tadrisi_history',`${n}_${d}`),{groupId:g,groupName:n,date:d,students:currentResultData});showToast('Saved');await fetchHistoryList();}catch(e){}finally{showLoader(false);}};
        window.loadHistoryRecord=async()=>{const i=document.getElementById('history-select').value;if(!i){loadGroupResults();return;}showLoader(true);try{const s=await getDoc(doc(db,'tadrisi_history',i));if(s.exists()){const d=s.data();document.getElementById('result-group-name').textContent=`${d.groupName} (Archived)`;document.getElementById('result-header-date').textContent=d.date;currentResultData=d.students;renderResultTable(d.students);showToast('Loaded');}}catch(e){}finally{showLoader(false);}};
    </script>
</body>
</html>

